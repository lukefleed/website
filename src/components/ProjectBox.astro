---
import type { Frontmatter } from "src/types";

export interface Props {
  post: Frontmatter;
  href?: string;
  githubUrl?: string;
  cratesDownloads?: number;
  starCount?: number;
  forkCount?: number;
  technologies?: string[];
  isLibrary?: boolean;
}

const { post, href, githubUrl, cratesDownloads, starCount, forkCount, technologies, isLibrary = false } = Astro.props;

// Technology icons mapping (only your technologies)
const getTechIcon = (tech: string) => {
  const icons: Record<string, string> = {
    "Rust": `<svg viewBox="0 0 128 128" width="12" height="12">
      <path fill="#ce422b" d="M62.96.242c-.232.135-1.203 1.528-2.16 3.097-2.4 3.94-2.426 3.942-5.65.55-2.098-2.208-2.605-2.612-3.28-2.607-.44.002-.995.152-1.235.332-.24.18-.916 1.612-1.504 3.183-1.346 3.6-1.41 3.715-2.156 3.86-.46.086-1.343-.407-3.463-1.929-1.565-1.125-3.1-2.045-3.411-2.045-1.291 0-1.655.706-2.27 4.4-.78 4.697-.754 4.681-4.988 2.758-1.71-.776-3.33-1.41-3.603-1.41-.274 0-.792.293-1.15.652-.652.652-.653.655-.475 4.246l.178 3.595-.68.364c-.602.322-1.017.283-3.684-.348-3.48-.822-4.216-.8-4.92.15l-.516.693.692 2.964c.38 1.63.745 3.2.814 3.487.067.287-.05.746-.26 1.02-.348.448-.717.49-3.94.44-5.452-.086-5.761.382-3.51 5.3.718 1.56 1.305 2.98 1.305 3.15 0 .898-.717 1.224-3.794 1.727-1.722.28-3.218.51-3.326.51-.107 0-.43.235-.717.522-.937.936-.671 1.816 1.453 4.814 2.646 3.735 2.642 3.75-1.73 5.421-4.971 1.902-5.072 2.37-1.287 5.96 3.525 3.344 3.53 3.295-.461 5.804C.208 62.8.162 62.846.085 63.876c-.093 1.253-.071 1.275 3.538 3.48 3.57 2.18 3.57 2.246.067 5.56C-.078 76.48.038 77 5.013 78.877c4.347 1.64 4.353 1.66 1.702 5.394-1.502 2.117-1.981 3-1.981 3.653 0 1.223.637 1.535 4.44 2.174 3.206.54 3.92.857 3.92 1.741 0 .182-.588 1.612-1.307 3.177-2.236 4.87-1.981 5.275 3.31 5.275 4.93 0 4.799-.15 3.737 4.294-.8 3.35-.813 3.992-.088 4.715.554.556 1.6.494 4.87-.289 2.499-.596 2.937-.637 3.516-.328l.66.354-.177 3.594c-.178 3.593-.177 3.595.475 4.248.358.36.884.652 1.165.652.282 0 1.903-.63 3.604-1.404 4.22-1.916 4.194-1.932 4.973 2.75.617 3.711.977 4.4 2.294 4.4.327 0 1.83-.88 3.34-1.958 2.654-1.893 3.342-2.19 4.049-1.74.182.115.89 1.67 1.572 3.455 1.003 2.625 1.37 3.31 1.929 3.576 1.062.51 1.72.1 4.218-2.62 3.016-3.286 3.14-3.27 5.602.72 2.72 4.406 3.424 4.396 6.212-.089 2.402-3.864 2.374-3.862 5.621-.47 2.157 2.25 2.616 2.61 3.343 2.61.464 0 1.019-.175 1.23-.388.214-.213.92-1.786 1.568-3.496.649-1.71 1.321-3.2 1.495-3.31.687-.436 1.398-.13 4.048 1.752 1.56 1.108 3.028 1.96 3.377 1.96 1.296 0 1.764-.92 2.302-4.535.46-3.082.554-3.378 1.16-3.685.596-.302.954-.2 3.75 1.07 1.701.77 3.323 1.402 3.604 1.402.282 0 .816-.302 1.184-.672l.672-.67-.184-3.448c-.177-3.29-.16-3.468.364-3.943.54-.488.596-.486 3.615.204 3.656.835 4.338.857 5.025.17.671-.67.664-.818-.254-4.69-1.03-4.346-1.168-4.19 3.78-4.19 3.374 0 3.75-.049 4.18-.523.718-.793.547-1.702-.896-4.779-.729-1.55-1.32-2.96-1.315-3.135.024-.914.743-1.227 4.065-1.767 2.033-.329 3.553-.71 3.829-.96.923-.833.584-1.918-1.523-4.873-2.642-3.703-2.63-3.738 1.599-5.297 5.064-1.866 5.209-2.488 1.419-6.09-3.51-3.335-3.512-3.317.333-5.677 4.648-2.853 4.655-3.496.082-6.335-3.933-2.44-3.93-2.406-.405-5.753 3.78-3.593 3.678-4.063-1.295-5.965-4.388-1.679-4.402-1.72-1.735-5.38 1.588-2.18 1.982-2.903 1.982-3.65 0-1.306-.586-1.598-4.436-2.22-3.216-.52-3.924-.835-3.924-1.75 0-.174.588-1.574 1.307-3.113 1.406-3.013 1.604-4.22.808-4.94-.428-.387-1-.443-4.067-.392-3.208.054-3.618.008-4.063-.439-.486-.488-.48-.557.278-3.725.931-3.88.935-3.975.17-4.694-.777-.73-1.262-.718-4.826.121-2.597.612-3.027.653-3.617.337l-.67-.36.185-3.582.186-3.58-.67-.67c-.369-.37-.891-.67-1.163-.67-.27 0-1.884.64-3.583 1.421-2.838 1.306-3.143 1.393-3.757 1.072-.612-.32-.714-.637-1.237-3.829-.603-3.693-.977-4.412-2.288-4.412-.311 0-1.853.925-3.426 2.055-2.584 1.856-2.93 2.032-3.574 1.807-.533-.186-.843-.59-1.221-1.599-.28-.742-.817-2.172-1.194-3.177-.762-2.028-1.187-2.482-2.328-2.482-.637 0-1.213.458-3.28 2.604-3.25 3.375-3.261 3.374-5.65-.545C66.073 1.78 65.075.382 64.81.24c-.597-.32-1.3-.32-1.85.002z"/>
    </svg>`,
    "Rust": `<img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/rust/rust-plain.svg" width="12" height="12" alt="Rust" />`,
    "Python": `<svg viewBox="0 0 128 128" width="12" height="12">
      <linearGradient id="python-a" gradientUnits="userSpaceOnUse" x1="70.252" y1="1237.476" x2="170.659" y2="1151.089" gradientTransform="matrix(.563 0 0 -.568 -29.215 707.817)">
        <stop stop-color="#5A9FD4" offset="0"/>
        <stop stop-color="#306998" offset="1"/>
      </linearGradient>
      <linearGradient id="python-b" gradientUnits="userSpaceOnUse" x1="209.474" y1="1098.811" x2="173.62" y2="1149.537" gradientTransform="matrix(.563 0 0 -.568 -29.215 707.817)">
        <stop stop-color="#FFD43B" offset="0"/>
        <stop stop-color="#FFE873" offset="1"/>
      </linearGradient>
      <path fill="url(#python-a)" d="M63.391 1.988c-4.222.02-8.252.379-11.8 1.007-10.45 1.846-12.346 5.71-12.346 12.837v9.411h24.693v3.137H29.977c-7.176 0-13.46 4.313-15.426 12.521-2.268 9.405-2.368 15.275 0 25.096 1.755 7.311 5.947 12.519 13.124 12.519h8.491V67.234c0-8.151 7.051-15.34 15.426-15.34h24.665c6.866 0 12.346-5.654 12.346-12.548V15.833c0-6.693-5.646-11.72-12.346-12.837-4.244-.706-8.645-1.027-12.866-1.008zM50.037 9.557c2.55 0 4.634 2.117 4.634 4.721 0 2.593-2.083 4.69-4.634 4.69-2.56 0-4.633-2.097-4.633-4.69-.001-2.604 2.073-4.721 4.633-4.721z" transform="translate(0 10.26)"/>
      <path fill="url(#python-b)" d="M91.682 28.38v10.966c0 8.5-7.208 15.655-15.426 15.655H51.591c-6.756 0-12.346 5.783-12.346 12.549v23.515c0 6.691 5.818 10.628 12.346 12.547 7.816 2.297 15.312 2.713 24.665 0 6.216-1.801 12.346-5.423 12.346-12.547v-9.412H63.938v-3.138h37.012c7.176 0 9.852-5.005 12.348-12.519 2.578-7.735 2.467-15.174 0-25.096-1.774-7.145-5.161-12.521-12.348-12.521H91.682zm-13.632 64.181c2.561 0 4.634 2.097 4.634 4.692 0 2.602-2.074 4.719-4.634 4.719-2.55 0-4.633-2.117-4.633-4.719 0-2.595 2.083-4.692 4.633-4.692z" transform="translate(0 10.26)"/>
    </svg>`,
    "C++": `<svg viewBox="0 0 128 128" width="12" height="12">
      <path fill="#9C033A" d="M117.5 33.5l.3-.2c-.6-1.1-1.5-2.1-2.4-2.6L67.1 2.9c-.8-.5-1.9-.7-3.1-.7-1.2 0-2.3.3-3.1.7l-48 27.9c-1.7 1-2.9 3.5-2.9 5.4v55.7c0 1.1.2 2.4 1 3.5l.1.2c.5.8 1.2 1.5 1.9 1.9l48.2 27.9c.8.5 1.9.7 3.1.7 1.2 0 2.3-.3 3.1-.7l48-27.9c1.7-1 2.9-3.5 2.9-5.4V36.1c.2-1.1.1-2.5-.3-2.6z"/>
      <path fill="#fff" d="M64 33.6c-9.4 0-17.1 7.7-17.1 17.1 0 6.8 4.1 12.9 10.4 15.6l2.8-4.7c-4.5-1.9-7.6-6.3-7.6-11.3 0-6.9 5.6-12.5 12.5-12.5s12.5 5.6 12.5 12.5c0 5-3.1 9.4-7.6 11.3l2.8 4.7c6.3-2.7 10.4-8.8 10.4-15.6.1-9.4-7.6-17.1-17.1-17.1z"/>
      <path fill="#fff" d="M81.7 45.7h-5.1v-5.1h-2.5v5.1h-5.1v2.5h5.1v5.1h2.5v-5.1h5.1v-2.5zm14.4 0h-5.1v-5.1h-2.5v5.1h-5.1v2.5h5.1v5.1h2.5v-5.1h5.1v-2.5z"/>
    </svg>`,
    "JavaScript": `<svg viewBox="0 0 128 128" width="12" height="12">
      <path fill="#F0DB4F" d="M1.408 1.408h125.184v125.185H1.408z"/>
      <path fill="#323330" d="M116.347 96.736c-.917-5.711-4.641-10.508-15.672-14.981-3.832-1.761-8.104-3.022-9.377-5.926-.452-1.69-.512-2.642-.226-3.665.821-3.32 4.784-4.355 7.925-3.403 2.023.678 3.938 2.237 5.093 4.724 5.402-3.498 5.391-3.475 9.163-5.879-1.381-2.141-2.118-3.129-3.022-4.045-3.249-3.629-7.676-5.498-14.756-5.355l-3.688.477c-3.534.893-6.902 2.748-8.877 5.235-5.926 6.724-4.236 18.492 2.975 23.335 7.104 5.332 17.54 6.545 18.873 11.531 1.297 6.104-4.486 8.08-10.234 7.378-4.236-.881-6.592-3.034-9.139-6.949-4.688 2.713-4.688 2.713-9.508 5.485 1.143 2.499 2.344 3.63 4.26 5.795 9.068 9.198 31.76 8.746 35.83-5.176.165-.478 1.261-3.666.38-8.581zM69.462 58.943H57.753l-.048 30.272c0 6.438.333 12.34-.714 14.149-1.713 3.558-6.152 3.117-8.175 2.427-2.059-1.012-3.106-2.451-4.319-4.485-.333-.584-.583-1.036-.667-1.071l-9.52 5.83c1.583 3.249 3.915 6.069 6.902 7.901 4.462 2.678 10.459 3.499 16.731 2.059 4.082-1.189 7.604-3.652 9.448-7.401 2.666-4.915 2.094-10.864 2.07-17.444.06-10.735.001-21.468.001-32.237z"/>
    </svg>`,
    "TypeScript": `<svg viewBox="0 0 128 128" width="12" height="12">
      <path fill="#fff" d="M22.67 47h99.67v73.67H22.67z"/>
      <path data-name="original" fill="#007acc" d="M1.5 63.91v62.5h125v-125H1.5zm100.73-5a15.56 15.56 0 017.82 4.5 20.58 20.58 0 013 4c0 .16-5.4 3.81-8.69 5.85-.12.08-.6-.44-1.13-1.23a7.09 7.09 0 00-5.87-3.53c-3.79-.26-6.23 1.73-6.21 5a4.58 4.58 0 00.54 2.17c.83 1.73 2.38 2.76 7.24 4.86 8.95 3.85 12.78 6.39 15.16 10 2.66 4 3.25 10.46 1.45 15.24-2 5.2-6.9 8.73-13.83 9.9a38.32 38.32 0 01-9.52-.1 23 23 0 01-12.72-6.63c-1.15-1.27-3.39-4.58-3.25-4.82a9.34 9.34 0 011.15-.73L82 101l3.59-2.08.75 1.11a16.78 16.78 0 004.74 4.54c4 2.1 9.46 1.81 12.16-.62a5.43 5.43 0 00.69-6.92c-1-1.39-3-2.56-8.59-5-6.45-2.78-9.23-4.5-11.77-7.24a16.48 16.48 0 01-3.43-6.25 25 25 0 01-.22-8c1.33-6.23 6-10.58 12.82-11.87a31.66 31.66 0 019.49.26zm-29.34 5.24v5.12H56.66v46.23H45.15V69.26H28.88v-5a49.19 49.19 0 01.12-5.17C29.08 59 39 59 51 59h21.83z"/>
    </svg>`
  };
  
  return icons[tech] || null;
};
---

<div class="project-box">
  <div class="project-main">
    <div class="project-title-row">
      <h3 class="project-title">
        <a href={githubUrl || href || "#"} target="_blank" rel="noopener noreferrer">
          {post.title}
        </a>
      </h3>
      <div class="project-links">
      {isLibrary && (
        <div class="library-badges flex items-center space-x-2">
          <a href="https://crates.io/crates/compressed-intvec" target="_blank" rel="noopener noreferrer">
            <img src="https://img.shields.io/crates/v/compressed-intvec.svg" alt="crates.io version" />
          </a>
          <a href="https://github.com/lukefleed/compressed-intvec/actions/workflows/rust.yml" target="_blank" rel="noopener noreferrer">
            <img src="https://github.com/lukefleed/compressed-intvec/actions/workflows/rust.yml/badge.svg" alt="CI status" />
          </a>
          <a href="https://docs.rs/compressed-intvec" target="_blank" rel="noopener noreferrer">
            <img src="https://docs.rs/compressed-intvec/badge.svg" alt="docs.rs" />
          </a>
          <a href="https://crates.io/crates/compressed-intvec" target="_blank" rel="noopener noreferrer">
            <img src="https://img.shields.io/crates/d/compressed-intvec" alt="downloads" />
          </a>
          <img src="https://img.shields.io/crates/l/compressed-intvec.svg" alt="license" />
        </div>
      )}
        {post.tags.map((tag) => (
          <a href={`/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="project-tag">
            #{tag}
          </a>
        ))}
      </div>
    )}
  </div>
  
    <div class="project-stats-right">
      {technologies && technologies.length > 0 && (
        <div class="tech-languages">
          {(() => {
            // Pick first recognized language or fallback to first tag
            const lang = technologies.find(t => ["Rust","Python","C++","JavaScript","TypeScript"].includes(t)) || technologies[0];
            const icon = getTechIcon(lang);
            return (
              <span class="tech-item" title={lang}>
                {icon && <span class="tech-icon" set:html={icon} />}
                <span class="tech-name">{lang}</span>
              </span>
            );
          })()}
        </div>
      )}
          )}
          
          {cratesDownloads > 0 && (
            <span class="stat-item">
              📥 {cratesDownloads.toLocaleString()}
            </span>
          )}
        </>
      )}
      
      {!isLibrary && (
        <>
          {typeof starCount === 'number' && starCount >= 1 && (
            <span class="stat-item">
              ⭐ {starCount.toLocaleString()}
            </span>
          )}
          
          {typeof forkCount === 'number' && forkCount >= 1 && (
            <span class="stat-item">
              🍴 {forkCount.toLocaleString()}
            </span>
          )}
        </>
      )}
    </div>
    
    <div class="project-stats-right">
      {technologies && technologies.length > 0 && (
        <div class="tech-languages">
          {
            // Choose first recognized language or fallback to first tag
            (() => {
              const lang = technologies.find(t => ["Rust","Python","C++","JavaScript","TypeScript"].includes(t)) || technologies[0];
              const icon = getTechIcon(lang);
              return (
                <span class="tech-item" title={lang}>
                  {icon && <span class="tech-icon" set:html={icon} />}
                  <span class="tech-name">{lang}</span>
                </span>
              );
            })()
          }
        </div>
      )}
      
      {post.datetime && (
        <time class="project-date" datetime={post.datetime}>
          {new Date(post.datetime).toLocaleDateString('en-US', {
            month: 'short',
            year: 'numeric'
          })}
        </time>
      )}
    </div>
  </div>
</div>

<style>
  .project-box {
    @apply p-4 bg-skin-fill border border-skin-line rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 mb-4;
  }
  
  .project-main {
    @apply mb-3;
  }
  
  .project-title-row {
    @apply flex items-center justify-between mb-2;
  }
  
  .project-title {
    @apply font-medium text-base leading-tight;
  }
  
  .project-title a {
    @apply text-skin-accent hover:underline;
  }
  
  .project-links {
    @apply flex items-center gap-1;
  }
  
  .repo-link {
    @apply p-1 text-skin-base opacity-60 hover:opacity-100 transition-opacity;
  }
  
  .project-description {
    @apply text-sm text-skin-base opacity-80 leading-relaxed mb-3;
  }
  
  .project-tags {
    @apply flex flex-wrap gap-2 mb-2;
  }
  
  .project-tag {
    @apply text-xs text-skin-accent opacity-70 hover:opacity-100 hover:underline transition-opacity no-underline;
  }
  
  .project-stats-row {
    @apply flex items-center justify-between text-xs text-skin-base opacity-70;
  }
  
  .project-stats-left {
    @apply flex items-center gap-3;
  }
  
  .project-stats-right {
    @apply flex items-center gap-3;
  }
  
  .stat-item {
    @apply flex items-center gap-1;
  }
  
  .tech-languages {
    @apply flex items-center gap-2;
  }
  
  .tech-item {
    @apply flex items-center gap-1;
  }
  
  .tech-icon {
    @apply flex items-center;
  }
  
  .tech-name {
    @apply text-xs;
  }
  
  .project-date {
    @apply text-xs opacity-60;
  }
</style>
