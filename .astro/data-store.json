[["Map",1,2,9,10,191,192],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.12.0","content-config-digest","fff55245e6a284ed","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://lukefleed.xyz\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"layout\":\"constrained\",\"responsiveStyles\":true},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{\"light\":\"min-light\",\"dark\":\"night-owl\"},\"defaultColor\":false,\"wrap\":false,\"transformers\":[{},{\"name\":\"@shikijs/transformers:notation-highlight\"},{\"name\":\"@shikijs/transformers:notation-highlight-word\"},{\"name\":\"@shikijs/transformers:notation-diff\"}]},\"remarkPlugins\":[null,null,[null,{\"test\":\"Table of contents\"}]],\"rehypePlugins\":[null],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true},\"env\":{\"schema\":{\"PUBLIC_GOOGLE_SITE_VERIFICATION\":{\"access\":\"public\",\"context\":\"client\",\"optional\":true,\"type\":\"string\"}},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":true,\"liveContentCollections\":false,\"csp\":false,\"rawEnvValues\":false},\"legacy\":{\"collections\":false}}","university",["Map",11,12,41,42,63,64,85,86,112,113,157,158],"diverse-lcs",{"id":11,"data":13,"body":22,"filePath":23,"assetImports":24,"digest":26,"rendered":27},{"author":14,"pubDatetime":15,"title":16,"featured":17,"draft":17,"tags":18,"ogImage":20,"description":21},"Luca Lombardo",["Date","2024-12-14T00:00:00.000Z"],"Finding Diverse Strings and Longest Common Sequences in a Graph",false,[19],"Algorithms and Data Structures","__ASTRO_IMAGE_","Slides for a seminar in bioinformatics.","Github repository: [link](https://github.com/lukefleed/rank-on-dags)\n\n## Slides for the seminar \"Finding Diverse Strings and Longest Common Sequences in a Graph\"\n\n\u003C!--\n@misc{shida2024findingdiversestringslongest,\n      title={Finding Diverse Strings and Longest Common Subsequences in a Graph},\n      author={Yuto Shida and Giulia Punzi and Yasuaki Kobayashi and Takeaki Uno and Hiroki Arimura},\n      year={2024},\n      eprint={2405.00131},\n      archivePrefix={arXiv},\n      primaryClass={cs.DS},\n      url={https://arxiv.org/abs/2405.00131},\n} -->\n\nPresentation over the paper \"Finding Diverse Strings and Longest Common Sequences in a Graph\" by Yuto Shida, Giulia Punzi, Yasuaki Kobayashi, Takeaki Uno, and Hiroki Arimura. The paper is available on [arXiv](https://arxiv.org/abs/2405.00131).\n\n---\n\nThe presentation was given for the course \"Bioinformatics\" at the University of Pisa in the academic year 2024/2025.\n\n---\n\nYou can find the slides here: [view](https://github.com/lukefleed/diverse-LCS-slides/blob/main/tex/main.pdf) / [download](https://github.com/lukefleed/diverse-LCS-slides/raw/main/tex/main.pdf)\n\n---","src/data/university/diverse-lcs.md",[25],"","0b52744614ca4021",{"html":28,"metadata":29},"\u003Cp>Github repository: \u003Ca href=\"https://github.com/lukefleed/rank-on-dags\">link\u003C/a>\u003C/p>\n\u003Ch2 id=\"slides-for-the-seminar-finding-diverse-strings-and-longest-common-sequences-in-a-graph\">Slides for the seminar â€œFinding Diverse Strings and Longest Common Sequences in a Graphâ€\u003C/h2>\n\u003C!--\n@misc{shida2024findingdiversestringslongest,\n      title={Finding Diverse Strings and Longest Common Subsequences in a Graph},\n      author={Yuto Shida and Giulia Punzi and Yasuaki Kobayashi and Takeaki Uno and Hiroki Arimura},\n      year={2024},\n      eprint={2405.00131},\n      archivePrefix={arXiv},\n      primaryClass={cs.DS},\n      url={https://arxiv.org/abs/2405.00131},\n} -->\n\u003Cp>Presentation over the paper â€œFinding Diverse Strings and Longest Common Sequences in a Graphâ€ by Yuto Shida, Giulia Punzi, Yasuaki Kobayashi, Takeaki Uno, and Hiroki Arimura. The paper is available on \u003Ca href=\"https://arxiv.org/abs/2405.00131\">arXiv\u003C/a>.\u003C/p>\n\u003Chr>\n\u003Cp>The presentation was given for the course â€œBioinformaticsâ€ at the University of Pisa in the academic year 2024/2025.\u003C/p>\n\u003Chr>\n\u003Cp>You can find the slides here: \u003Ca href=\"https://github.com/lukefleed/diverse-LCS-slides/blob/main/tex/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/diverse-LCS-slides/raw/main/tex/main.pdf\">download\u003C/a>\u003C/p>\n\u003Chr>",{"headings":30,"localImagePaths":35,"remoteImagePaths":36,"frontmatter":37,"imagePaths":40},[31],{"depth":32,"slug":33,"text":34},2,"slides-for-the-seminar-finding-diverse-strings-and-longest-common-sequences-in-a-graph","Slides for the seminar â€œFinding Diverse Strings and Longest Common Sequences in a Graphâ€",[],[],{"author":14,"pubDatetime":38,"title":16,"slug":11,"featured":17,"draft":17,"tags":39,"ogImage":25,"description":21},["Date","2024-12-14T00:00:00.000Z"],[19],[],"g2-cheat-sheet",{"id":41,"data":43,"body":49,"filePath":50,"assetImports":51,"digest":52,"rendered":53},{"author":14,"pubDatetime":44,"title":45,"featured":17,"draft":17,"tags":46,"ogImage":20,"description":48},["Date","2024-01-24T00:00:00.000Z"],"G2 cheat sheet",[47],"Math","ðŸ‡®ðŸ‡¹ Versione compatta senza dimostrazioni delle dispense di Geometria 2 di Francesco Sorce.","- Github repository: [link](https://github.com/lukefleed/G2-cheat-sheet)\n\nVersione in due colonne e senza dimostrazioni delle dispense di [Francesco Sorce](https://poisson.phc.dm.unipi.it/~fsorce/) per il corso di Geometria 2, A.A. 2022/2023.\n\nPDF delle dispense: [Clicca Qui](https://github.com/lukefleed/G2-cheat-sheet/raw/build/G2_cheat_sheet.pdf)\n\n---\n\n**Dispense originali:** [overleaf](https://www.overleaf.com/read/vsdktbwrgpth)\n\n---","src/data/university/g2-cheat-sheet.md",[25],"d58dd9307a00556d",{"html":54,"metadata":55},"\u003Cul>\n\u003Cli>Github repository: \u003Ca href=\"https://github.com/lukefleed/G2-cheat-sheet\">link\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>Versione in due colonne e senza dimostrazioni delle dispense di \u003Ca href=\"https://poisson.phc.dm.unipi.it/~fsorce/\">Francesco Sorce\u003C/a> per il corso di Geometria 2, A.A. 2022/2023.\u003C/p>\n\u003Cp>PDF delle dispense: \u003Ca href=\"https://github.com/lukefleed/G2-cheat-sheet/raw/build/G2_cheat_sheet.pdf\">Clicca Qui\u003C/a>\u003C/p>\n\u003Chr>\n\u003Cp>\u003Cstrong>Dispense originali:\u003C/strong> \u003Ca href=\"https://www.overleaf.com/read/vsdktbwrgpth\">overleaf\u003C/a>\u003C/p>\n\u003Chr>",{"headings":56,"localImagePaths":57,"remoteImagePaths":58,"frontmatter":59,"imagePaths":62},[],[],[],{"author":14,"pubDatetime":60,"title":45,"slug":41,"featured":17,"draft":17,"tags":61,"ogImage":25,"description":48},["Date","2024-01-24T00:00:00.000Z"],[47],[],"nummarkov",{"id":63,"data":65,"body":71,"filePath":72,"assetImports":73,"digest":74,"rendered":75},{"author":14,"pubDatetime":66,"title":67,"featured":17,"draft":17,"tags":68,"ogImage":20,"description":70},["Date","2023-04-04T00:00:00.000Z"],"Queueing System with Potential for Recruiting Secondary Servers",[69],"Scientific Computing","Slides for a seminar on the topic of numerical methods for Markov Chains","Github repository: [link](https://github.com/lukefleed/numerical-markov-slides)\n\n---\n\nðŸ‡¬ðŸ‡§ _Since I wrote the slides for the seminar in Italian, this post will be in Italian as well._\n\nðŸ‡®ðŸ‡¹ Seminario basato sul [paper](https://www.mdpi.com/2227-7390/11/3/624) [1]\n\n> [1]. Srinivas R. Chakravarthy, Alexander N. Dudin, Sergey A. Dudin and Olga S. Dudina. Queueing System with Potential for Recruiting Secondary Servers. Mathematics 2023, 11(3), 624;\n\nPer scaricare il pdf delle slides, cliccare qui: [view](https://github.com/lukefleed/numerical-markov-slides/blob/main/slides/main.pdf) / [download](https://github.com/lukefleed/numerical-markov-slides/raw/main/slides/main.pdf)\n\n---\n\nSeminario per il corso di _Metodi Numerici per Catene di Markov_  tenuto presso il Dipartimento di Matematica dell'UniversitÃ  di Pisa, nell'anno accademico 2022/2023.\n\n---","src/data/university/nummarkov.md",[25],"94ca462ef1b8a7b4",{"html":76,"metadata":77},"\u003Cp>Github repository: \u003Ca href=\"https://github.com/lukefleed/numerical-markov-slides\">link\u003C/a>\u003C/p>\n\u003Chr>\n\u003Cp>ðŸ‡¬ðŸ‡§ \u003Cem>Since I wrote the slides for the seminar in Italian, this post will be in Italian as well.\u003C/em>\u003C/p>\n\u003Cp>ðŸ‡®ðŸ‡¹ Seminario basato sul \u003Ca href=\"https://www.mdpi.com/2227-7390/11/3/624\">paper\u003C/a> [1]\u003C/p>\n\u003Cblockquote>\n\u003Cp>[1]. Srinivas R. Chakravarthy, Alexander N. Dudin, Sergey A. Dudin and Olga S. Dudina. Queueing System with Potential for Recruiting Secondary Servers. Mathematics 2023, 11(3), 624;\u003C/p>\n\u003C/blockquote>\n\u003Cp>Per scaricare il pdf delle slides, cliccare qui: \u003Ca href=\"https://github.com/lukefleed/numerical-markov-slides/blob/main/slides/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/numerical-markov-slides/raw/main/slides/main.pdf\">download\u003C/a>\u003C/p>\n\u003Chr>\n\u003Cp>Seminario per il corso di \u003Cem>Metodi Numerici per Catene di Markov\u003C/em>  tenuto presso il Dipartimento di Matematica dellâ€™UniversitÃ  di Pisa, nellâ€™anno accademico 2022/2023.\u003C/p>\n\u003Chr>",{"headings":78,"localImagePaths":79,"remoteImagePaths":80,"frontmatter":81,"imagePaths":84},[],[],[],{"author":14,"pubDatetime":82,"title":67,"slug":63,"featured":17,"draft":17,"tags":83,"ogImage":25,"description":70},["Date","2023-04-04T00:00:00.000Z"],[69],[],"shifted-pow-gmres",{"id":85,"data":87,"body":92,"filePath":93,"assetImports":94,"digest":95,"rendered":96},{"author":14,"pubDatetime":88,"title":89,"featured":17,"draft":17,"tags":90,"ogImage":20,"description":91},["Date","2022-12-27T00:00:00.000Z"],"Methods for solving PageRank with multiple damping factors",[69],"Implementation of the shifted power method and the shifted GMRES method","- Report of the project: [view](https://github.com/lukefleed/ShfitedPowGMRES/blob/main/tex/main.pdf) / [download](https://github.com/lukefleed/ShfitedPowGMRES/raw/main/tex/main.pdf)\n- GitHub repository: [view](https://github.com/lukefleed/ShfitedPowGMRES)\n\nThis repository contains the code of my attempt to replicate the results obtained in `[1]`. The scripts are all written in python and are heavily build around the libraries SciPy and NumPy. To install all the required packages with `pip` run the following command in terminal\n\n```bash\npip install -r requirements.txt\n```\n\nAt the moment, the standard and shifted power method to compute the PageRank with multiple damping factors are fully implemented (as described in `[1]`). To run the program we need to execute the `main.py` file. It takes as input two arguments:\n\n- `--dataset`: the options are `BerkStan` and `Stanford`. This commands selects the web-graph to run the algorithms on.\n- `--algo`: the options are `power`, `shifted`, `both`. If you choose the last option, it will first run the standard power method and then the shifted one.\n\nHere an example of what's described above.\n\n```bash\n./main.py --dataset Stanford --algo both\n```\n\n## Under development\n\nIn the `testing/` folder there are two python notebook that contains the attempt on replicating the results obtained in `[1]` for the shifted GMRES method. The implementation of the Arnoldi process is fully working. On the other hand, there are several problems on the shifted GMRES algorithm that I can't figure out.\n\n## References\n\n`[1]` _Zhao-Li Shen, Meng Su, Bruno Carpentieri, and Chun Wen. Shifted power-gmres method accelerated by extrapolation for solving pagerank with multiple damping factors. Applied Mathematics and Computation, 420:126799, 2022_","src/data/university/shifted-pow-gmres.md",[25],"97ecb6f88e8649ae",{"html":97,"metadata":98},"\u003Cul>\n\u003Cli>Report of the project: \u003Ca href=\"https://github.com/lukefleed/ShfitedPowGMRES/blob/main/tex/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/ShfitedPowGMRES/raw/main/tex/main.pdf\">download\u003C/a>\u003C/li>\n\u003Cli>GitHub repository: \u003Ca href=\"https://github.com/lukefleed/ShfitedPowGMRES\">view\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>This repository contains the code of my attempt to replicate the results obtained in \u003Ccode>[1]\u003C/code>. The scripts are all written in python and are heavily build around the libraries SciPy and NumPy. To install all the required packages with \u003Ccode>pip\u003C/code> run the following command in terminal\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">pip\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> install\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> -r\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> requirements.txt\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>At the moment, the standard and shifted power method to compute the PageRank with multiple damping factors are fully implemented (as described in \u003Ccode>[1]\u003C/code>). To run the program we need to execute the \u003Ccode>main.py\u003C/code> file. It takes as input two arguments:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>--dataset\u003C/code>: the options are \u003Ccode>BerkStan\u003C/code> and \u003Ccode>Stanford\u003C/code>. This commands selects the web-graph to run the algorithms on.\u003C/li>\n\u003Cli>\u003Ccode>--algo\u003C/code>: the options are \u003Ccode>power\u003C/code>, \u003Ccode>shifted\u003C/code>, \u003Ccode>both\u003C/code>. If you choose the last option, it will first run the standard power method and then the shifted one.\u003C/li>\n\u003C/ul>\n\u003Cp>Here an example of whatâ€™s described above.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./main.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --dataset\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> Stanford\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --algo\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> both\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"under-development\">Under development\u003C/h2>\n\u003Cp>In the \u003Ccode>testing/\u003C/code> folder there are two python notebook that contains the attempt on replicating the results obtained in \u003Ccode>[1]\u003C/code> for the shifted GMRES method. The implementation of the Arnoldi process is fully working. On the other hand, there are several problems on the shifted GMRES algorithm that I canâ€™t figure out.\u003C/p>\n\u003Ch2 id=\"references\">References\u003C/h2>\n\u003Cp>\u003Ccode>[1]\u003C/code> \u003Cem>Zhao-Li Shen, Meng Su, Bruno Carpentieri, and Chun Wen. Shifted power-gmres method accelerated by extrapolation for solving pagerank with multiple damping factors. Applied Mathematics and Computation, 420:126799, 2022\u003C/em>\u003C/p>",{"headings":99,"localImagePaths":106,"remoteImagePaths":107,"frontmatter":108,"imagePaths":111},[100,103],{"depth":32,"slug":101,"text":102},"under-development","Under development",{"depth":32,"slug":104,"text":105},"references","References",[],[],{"author":14,"pubDatetime":109,"title":89,"slug":85,"featured":17,"draft":17,"tags":110,"ogImage":25,"description":91},["Date","2022-12-27T00:00:00.000Z"],[69],[],"small-worlds",{"id":112,"data":114,"body":119,"filePath":120,"assetImports":121,"digest":122,"rendered":123},{"author":14,"pubDatetime":115,"title":116,"featured":17,"draft":17,"tags":117,"ogImage":20,"description":118},["Date","2023-02-24T00:00:00.000Z"],"Identifying small worlds networks",[19],"Spatial Networks and small words, an experimental study on real-world datasets. Developed in Python with parallel processing support for the computation of the heaviest functions.","- Github repository: [link](https://github.com/lukefleed/small-worlds)\n\nThe present repository showcases the implementation of an experimental examination of the Small-World Networks (SWN) theory. The examination is based on real-world datasets, and the outcomes are presented through a Jupyter Notebook. As there is no corresponding written paper, the notebook serves as the sole source of information regarding the study. It encompasses all relevant theoretical background, details of the experimental design, presentation of results, and derivation of conclusions.\n\n---\n\nTime spent one the project since the beginning of 2023 (add ~20 hours for a real estimate)\n\n[![wakatime](https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce.svg)](https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce)\n\n---\n\n## Documentation\n\n### Notebook structure\n\nThe core component of the project is a Jupyter Notebook named `main.ipynb`. The notebook provides ample information to comprehend the study and its results.\n\n- The notebook starts with a theoretical background of the study, delving into the theory of random networks. The ErdÅ‘s-RÃ©nyi and Watts-Strogatz models receive particular attention, as their properties form the basis of the study.\n\n- Next, the experimental setup is presented. There is a detailed description of the datasets, along with the methodology adopted for data extraction, transformation, and loading. In this section, the graphs are constructed from the raw data obtained from the datasets.\n\n- The properties of the constructed graphs are then calculated, including the average degree, average clustering coefficient, average shortest path length, and average betweenness centrality.\n\n- The results of the study are then presented, followed by a comprehensive analysis and discussion of the outcomes.\n\n- Finally, we attempt to understand whether the networks are small-world or not by employing different approaches and evaluating the consistency of the results.\n\n### Algorithms and functions implemented\n\nIn order to maintain a clean and organized notebook, I have integrated all algorithms and functions into the `utils.py` file. This module serves as a centralized repository of functions and is imported into the notebook for use in the study.\n\nA thorough technical examination of the project requires a close examination of this file, as it holds nearly all the code utilized. Each function is accompanied by detailed documentation to ensure clear understanding and ease of use.\n\n### External scripts\n\nThe computation of the omega coefficient, a crucial measure of the small-worldness of a network, is one of the most vital functions in this project. However, its application proves to be extremely slow, rendering its usage in the notebook inadvisable. To address this issue, I have developed a separate script, named `omega_sampled_server.py`. The script is intended for execution on a server machine, capable of handling the extensive processing demands for extended periods of time, to compute the omega coefficient for a specified graph.\n\nTo run the script, execute the following command:\n\n```bash\n./omega_sampled_server.py graph --k --niter --nrand\n```\n\nWhere:\n\n- `graph` is the name of the graph\n- `k` Percentage of nodes to be remove\n- `niter` Number of rewiring operations per edge\n- `nrand` Number of random graphs to be generated\n\nFor further details run `./omega_sampled_server.py --help`\n\n#### Parallel version\n\nHowever, the computation of the omega coefficient was still very slow. To speed up the process, I developed a parallel version of the script above, called `omega_parallel_server.py`. Its development required substantial effort as the parallelization of a function utilizing a random number generator is a complex task.\n\nTo run the script, execute the following command:\n\n```bash\n./omega_sampled_parallel.py graph --k --niter --nrand --n_processes --seed\n```\n\nWhere:\n\n- `graph` is the name of the graph\n- `k` Percentage of nodes to be remove\n- `niter` Number of rewiring operations per edge\n- `nrand` Number of random graphs to be generated\n- `n_processes` is an argument that specifies the number of processes to be used\n- `seed` is the seed for the random number generator\n\nFor further details run `./omega_sampled_parallel.py --help`\n\n## Requirements\n\nThe project has been developed in Python 3.10.9, to install the required libraries run the following command:\n\n```bash\npip install -r requirements.txt\n```\n\n**NOTE**: I have no access to Windows or MacOS machines, so I cannot guarantee whether the project will function optimally on these platforms. However, I have made a concerted effort to ensure broad compatibility by implementing the project in a manner that should allow for its seamless operation on any platform. All the functions have been test on a Arch Linux machine, with an AMD Ryzen 5 2600 processor and 16GB of RAM.\n\n### Experimental\n\nThere is a directory named `experimental` in the repo that contains a number of scripts written in `C++` with the purpose of speeding up the computation of the omega coefficient. The scripts are not used in the project, but they are included for completeness. This scripts _are not documented, not tested, and not guaranteed to work_. I suggest to ignore them unless you are a C++ enthusiast that has time to waste.\n\n## References\n\nHere I report a list of the references utilized for the implementation of the project. This information is also available in the notebook.\n\n> _In no particular order_\n\n`[1]` On the evolution of random graphs, P. ErdÅ‘s, A. RÃ©nyi, _Publ. Math. Inst. Hungar. Acad. Sci._, 5, 17-61 (1960).\n\n`[2]` Complex Networks: Structure, Robustness, and Function, R. Cohen, S. Havlin, D. ben-Avraham, H. E. Stanley, _Cambridge University Press, 2009_.\n\n`[3]` Collective dynamics of 'small-world' networks, D. J. Watts and S. H. Strogatz, _Nature_, 393, 440-442, 1998.\n\n`[4]` On random graphs I, P. ErdÅ‘s and A. RÃ©nyi, _Publ. Math. Inst. Hungar. Acad. Sci._, 5, 290-297, 1960.\n\n`[5]` Generalizations of the clustering coefficient to weighted complex networks, M. E. J. Newman, _Physical Review E_, 74, 036104, 2006.\n\n`[6]` The ubiquity of small-world networks. Telesford QK, Joyce KE, Hayasaka S, Burdette JH, Laurienti PJ. _Brain Connect_. 2011;1(5):367-75\n\n`[8]` Humphries and Gurney (2008). â€œNetwork â€˜Small-World-Nessâ€™: A Quantitative Method for Determining Canonical Network Equivalenceâ€. PLoS One. 3 (4)\n\n`[9]` The brainstem reticular formation is a small-world, not scale-free, network M. D. Humphries, K. Gurney and T. J. Prescott, Proc. Roy. Soc. B 2006 273, 503-511,\n\n`[10]` Sporns, Olaf, and Jonathan D. Zwi. â€œThe small world of the cerebral cortex.â€ Neuroinformatics 2.2 (2004): 145-162.\n\n`[11]` Maslov, Sergei, and Kim Sneppen. â€œSpecificity and stability in topology of protein networks.â€ Science 296.5569 (2002): 910-913.\n\n`[13]` B. Bollob Ìas, Random Graphs, 1985. London: Academic Press\n\n`[14]` R. Cohen, K. Erez, D. ben-Avraham, and S. Havlin, Resilience of the Internet to\nrandom breakdown, Physical Review Letters 85 (2000), 4626â€“4628\n\n`[15]` Dingqi Yang, Bingqing Qu, Jie Yang, Philippe Cudre-Mauroux, Revisiting User Mobility and Social Relationships in LBSNs: A Hypergraph Embedding Approach, In Proc. of The Web Conference (WWW'19). May. 2019, San Francisco, USA.\n\n`[16]` Ulrik Brandes, A Faster Algorithm for Betweenness Centrality, Journal of Mathematical Sociology, 25(2):163-177, 2001.\\_\n\n`[17]` Error and attack tolerance of complex networks, R. Albert, Nature volume 406, pages378â€“382 (2000)","src/data/university/small-worlds.md",[25],"08aeecd32288e460",{"html":124,"metadata":125},"\u003Cul>\n\u003Cli>Github repository: \u003Ca href=\"https://github.com/lukefleed/small-worlds\">link\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>The present repository showcases the implementation of an experimental examination of the Small-World Networks (SWN) theory. The examination is based on real-world datasets, and the outcomes are presented through a Jupyter Notebook. As there is no corresponding written paper, the notebook serves as the sole source of information regarding the study. It encompasses all relevant theoretical background, details of the experimental design, presentation of results, and derivation of conclusions.\u003C/p>\n\u003Chr>\n\u003Cp>Time spent one the project since the beginning of 2023 (add ~20 hours for a real estimate)\u003C/p>\n\u003Cp>\u003Ca href=\"https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce\">\u003Cimg src=\"https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce.svg\" alt=\"wakatime\">\u003C/a>\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"documentation\">Documentation\u003C/h2>\n\u003Ch3 id=\"notebook-structure\">Notebook structure\u003C/h3>\n\u003Cp>The core component of the project is a Jupyter Notebook named \u003Ccode>main.ipynb\u003C/code>. The notebook provides ample information to comprehend the study and its results.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>The notebook starts with a theoretical background of the study, delving into the theory of random networks. The ErdÅ‘s-RÃ©nyi and Watts-Strogatz models receive particular attention, as their properties form the basis of the study.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>Next, the experimental setup is presented. There is a detailed description of the datasets, along with the methodology adopted for data extraction, transformation, and loading. In this section, the graphs are constructed from the raw data obtained from the datasets.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The properties of the constructed graphs are then calculated, including the average degree, average clustering coefficient, average shortest path length, and average betweenness centrality.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The results of the study are then presented, followed by a comprehensive analysis and discussion of the outcomes.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>Finally, we attempt to understand whether the networks are small-world or not by employing different approaches and evaluating the consistency of the results.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"algorithms-and-functions-implemented\">Algorithms and functions implemented\u003C/h3>\n\u003Cp>In order to maintain a clean and organized notebook, I have integrated all algorithms and functions into the \u003Ccode>utils.py\u003C/code> file. This module serves as a centralized repository of functions and is imported into the notebook for use in the study.\u003C/p>\n\u003Cp>A thorough technical examination of the project requires a close examination of this file, as it holds nearly all the code utilized. Each function is accompanied by detailed documentation to ensure clear understanding and ease of use.\u003C/p>\n\u003Ch3 id=\"external-scripts\">External scripts\u003C/h3>\n\u003Cp>The computation of the omega coefficient, a crucial measure of the small-worldness of a network, is one of the most vital functions in this project. However, its application proves to be extremely slow, rendering its usage in the notebook inadvisable. To address this issue, I have developed a separate script, named \u003Ccode>omega_sampled_server.py\u003C/code>. The script is intended for execution on a server machine, capable of handling the extensive processing demands for extended periods of time, to compute the omega coefficient for a specified graph.\u003C/p>\n\u003Cp>To run the script, execute the following command:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./omega_sampled_server.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --k\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --niter\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --nrand\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>graph\u003C/code> is the name of the graph\u003C/li>\n\u003Cli>\u003Ccode>k\u003C/code> Percentage of nodes to be remove\u003C/li>\n\u003Cli>\u003Ccode>niter\u003C/code> Number of rewiring operations per edge\u003C/li>\n\u003Cli>\u003Ccode>nrand\u003C/code> Number of random graphs to be generated\u003C/li>\n\u003C/ul>\n\u003Cp>For further details run \u003Ccode>./omega_sampled_server.py --help\u003C/code>\u003C/p>\n\u003Ch4 id=\"parallel-version\">Parallel version\u003C/h4>\n\u003Cp>However, the computation of the omega coefficient was still very slow. To speed up the process, I developed a parallel version of the script above, called \u003Ccode>omega_parallel_server.py\u003C/code>. Its development required substantial effort as the parallelization of a function utilizing a random number generator is a complex task.\u003C/p>\n\u003Cp>To run the script, execute the following command:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./omega_sampled_parallel.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --k\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --niter\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --nrand\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --n_processes\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --seed\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>graph\u003C/code> is the name of the graph\u003C/li>\n\u003Cli>\u003Ccode>k\u003C/code> Percentage of nodes to be remove\u003C/li>\n\u003Cli>\u003Ccode>niter\u003C/code> Number of rewiring operations per edge\u003C/li>\n\u003Cli>\u003Ccode>nrand\u003C/code> Number of random graphs to be generated\u003C/li>\n\u003Cli>\u003Ccode>n_processes\u003C/code> is an argument that specifies the number of processes to be used\u003C/li>\n\u003Cli>\u003Ccode>seed\u003C/code> is the seed for the random number generator\u003C/li>\n\u003C/ul>\n\u003Cp>For further details run \u003Ccode>./omega_sampled_parallel.py --help\u003C/code>\u003C/p>\n\u003Ch2 id=\"requirements\">Requirements\u003C/h2>\n\u003Cp>The project has been developed in Python 3.10.9, to install the required libraries run the following command:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">pip\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> install\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> -r\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> requirements.txt\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>NOTE\u003C/strong>: I have no access to Windows or MacOS machines, so I cannot guarantee whether the project will function optimally on these platforms. However, I have made a concerted effort to ensure broad compatibility by implementing the project in a manner that should allow for its seamless operation on any platform. All the functions have been test on a Arch Linux machine, with an AMD Ryzen 5 2600 processor and 16GB of RAM.\u003C/p>\n\u003Ch3 id=\"experimental\">Experimental\u003C/h3>\n\u003Cp>There is a directory named \u003Ccode>experimental\u003C/code> in the repo that contains a number of scripts written in \u003Ccode>C++\u003C/code> with the purpose of speeding up the computation of the omega coefficient. The scripts are not used in the project, but they are included for completeness. This scripts \u003Cem>are not documented, not tested, and not guaranteed to work\u003C/em>. I suggest to ignore them unless you are a C++ enthusiast that has time to waste.\u003C/p>\n\u003Ch2 id=\"references\">References\u003C/h2>\n\u003Cp>Here I report a list of the references utilized for the implementation of the project. This information is also available in the notebook.\u003C/p>\n\u003Cblockquote>\n\u003Cp>\u003Cem>In no particular order\u003C/em>\u003C/p>\n\u003C/blockquote>\n\u003Cp>\u003Ccode>[1]\u003C/code> On the evolution of random graphs, P. ErdÅ‘s, A. RÃ©nyi, \u003Cem>Publ. Math. Inst. Hungar. Acad. Sci.\u003C/em>, 5, 17-61 (1960).\u003C/p>\n\u003Cp>\u003Ccode>[2]\u003C/code> Complex Networks: Structure, Robustness, and Function, R. Cohen, S. Havlin, D. ben-Avraham, H. E. Stanley, \u003Cem>Cambridge University Press, 2009\u003C/em>.\u003C/p>\n\u003Cp>\u003Ccode>[3]\u003C/code> Collective dynamics of â€˜small-worldâ€™ networks, D. J. Watts and S. H. Strogatz, \u003Cem>Nature\u003C/em>, 393, 440-442, 1998.\u003C/p>\n\u003Cp>\u003Ccode>[4]\u003C/code> On random graphs I, P. ErdÅ‘s and A. RÃ©nyi, \u003Cem>Publ. Math. Inst. Hungar. Acad. Sci.\u003C/em>, 5, 290-297, 1960.\u003C/p>\n\u003Cp>\u003Ccode>[5]\u003C/code> Generalizations of the clustering coefficient to weighted complex networks, M. E. J. Newman, \u003Cem>Physical Review E\u003C/em>, 74, 036104, 2006.\u003C/p>\n\u003Cp>\u003Ccode>[6]\u003C/code> The ubiquity of small-world networks. Telesford QK, Joyce KE, Hayasaka S, Burdette JH, Laurienti PJ. \u003Cem>Brain Connect\u003C/em>. 2011;1(5):367-75\u003C/p>\n\u003Cp>\u003Ccode>[8]\u003C/code> Humphries and Gurney (2008). â€œNetwork â€˜Small-World-Nessâ€™: A Quantitative Method for Determining Canonical Network Equivalenceâ€. PLoS One. 3 (4)\u003C/p>\n\u003Cp>\u003Ccode>[9]\u003C/code> The brainstem reticular formation is a small-world, not scale-free, network M. D. Humphries, K. Gurney and T. J. Prescott, Proc. Roy. Soc. B 2006 273, 503-511,\u003C/p>\n\u003Cp>\u003Ccode>[10]\u003C/code> Sporns, Olaf, and Jonathan D. Zwi. â€œThe small world of the cerebral cortex.â€ Neuroinformatics 2.2 (2004): 145-162.\u003C/p>\n\u003Cp>\u003Ccode>[11]\u003C/code> Maslov, Sergei, and Kim Sneppen. â€œSpecificity and stability in topology of protein networks.â€ Science 296.5569 (2002): 910-913.\u003C/p>\n\u003Cp>\u003Ccode>[13]\u003C/code> B. Bollob Ìas, Random Graphs, 1985. London: Academic Press\u003C/p>\n\u003Cp>\u003Ccode>[14]\u003C/code> R. Cohen, K. Erez, D. ben-Avraham, and S. Havlin, Resilience of the Internet to\nrandom breakdown, Physical Review Letters 85 (2000), 4626â€“4628\u003C/p>\n\u003Cp>\u003Ccode>[15]\u003C/code> Dingqi Yang, Bingqing Qu, Jie Yang, Philippe Cudre-Mauroux, Revisiting User Mobility and Social Relationships in LBSNs: A Hypergraph Embedding Approach, In Proc. of The Web Conference (WWWâ€™19). May. 2019, San Francisco, USA.\u003C/p>\n\u003Cp>\u003Ccode>[16]\u003C/code> Ulrik Brandes, A Faster Algorithm for Betweenness Centrality, Journal of Mathematical Sociology, 25(2):163-177, 2001._\u003C/p>\n\u003Cp>\u003Ccode>[17]\u003C/code> Error and attack tolerance of complex networks, R. Albert, Nature volume 406, pages378â€“382 (2000)\u003C/p>",{"headings":126,"localImagePaths":151,"remoteImagePaths":152,"frontmatter":153,"imagePaths":156},[127,130,134,137,140,144,147,150],{"depth":32,"slug":128,"text":129},"documentation","Documentation",{"depth":131,"slug":132,"text":133},3,"notebook-structure","Notebook structure",{"depth":131,"slug":135,"text":136},"algorithms-and-functions-implemented","Algorithms and functions implemented",{"depth":131,"slug":138,"text":139},"external-scripts","External scripts",{"depth":141,"slug":142,"text":143},4,"parallel-version","Parallel version",{"depth":32,"slug":145,"text":146},"requirements","Requirements",{"depth":131,"slug":148,"text":149},"experimental","Experimental",{"depth":32,"slug":104,"text":105},[],[],{"author":14,"pubDatetime":154,"title":116,"slug":112,"featured":17,"draft":17,"tags":155,"ogImage":25,"description":118},["Date","2023-02-24T00:00:00.000Z"],[19],[],"imdb-graph",{"id":157,"data":159,"body":164,"filePath":165,"assetImports":166,"digest":167,"rendered":168},{"author":14,"pubDatetime":160,"title":161,"featured":17,"draft":17,"tags":162,"ogImage":20,"description":163},["Date","2022-04-26T00:00:00.000Z"],"An exact and fast algorithm for computing top-k closeness centrality",[19],"An exact and fast algorithm for computing top-k closeness centrality, tested on the IMDb dataset","The explanation of this algorithm and all its analysis can be found in the project report: [view](https://github.com/lukefleed/imdb-graph/blob/main/tex/src/main.pdf) / [download](https://github.com/lukefleed/imdb-graph/raw/main/tex/src/main.pdf)\n\n- Github repository: [imdb-graph](https://github.com/lukefleed/imdb-graph)\n\n## Documentation\n\nFirst thing first, we need to clone the repository\n\n```bash\ngit clone https://github.com/lukefleed/imdb-graph\n```\n\nOnce done, move in it\n\n```bash\ncd imdb-graph\n```\n\n### Downloading and filtering the data\n\nAll the necessary file are inside the folder `filters`\n\n```bash\ncd filters\n```\n\nWe have two options. If we want to build the graph where the actors are the node, we have to run\n\n```bash\n./actors_graph_filter.py --min-movies 42\n```\n\n`min-movies` has to ben an integer, `42` is just an example. It represents the minimum number of movies that an actor/actress needs to have done to be considered in our graph.\n\nIf we want to build the graph where the movies are the nodes, we have to run\n\n```bash\n./movie_graph_filter.py --votes 500\n```\n\n`votes` has to ben an integer, `500` is just an example. It represents the minimum number of votes that a movie needs to have on the IMDb database to be considered in our graph.\n\nAll the data filtered will be saved in a new folder called `data`\n\n### Running the program\n\nLet's move into the folder `scripts`. If we want to run the program on the actors graph, use\n\n```bash\n./actors_graph top_actors_42\n```\n\n> IMPORTANT: The algorithm is multi-threaded. It's set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\n> where `top_actors_42` is the output file name. Anything can be used.\n\n---\n\nIf we want to run the program on the movies graph, use\n\n```bash\n./movie_graph top_movies_42\n```\n\n> IMPORTANT: The algorithm is multi-threaded. It's set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\n> where `top_movies_42` is the output file name. Anything can be used\n\n---\n\nThose scripts will generate two files .txt (one for the harmonic and one for the closeness centrality). Those files will have the top-100 elements for the relative centrality. If we want a different value, just change the variable `k` in the .cpp files\n\n### Automatic script for different variables of filtering\n\nWe are in the folder `scripts`. Inside both the folders `actor-graph` and `movie-graph` there is a file called `bench_me.sh`. This file will run everything automatically in loop for different values of the filtering variables. To modify this file we need to edit the file. To run it\n\n```bash\n./bench_me.sh\n```\n\nThis will also save the logs in a folder called `time`. It can be usefull to analyze the performance of the program.\n\n---\n\nInside the folders `closeness centrality` (for both graph), there is a python script `analysis.py`. Put all the generated `_c.txt` files in the folder and run it. It will return a matrix showing the discrepancy of the results while varying the variable\n\n### Generating the interactive graphs\n\nFirst, let's move into the folder `visualization`\n\n```bash\ncd visualization\n```\n\nAs before, we will find two folders, one for each type of graph. Choose the one that we want to with and move into that folder. Inside it we need to create a folder called `data`\n\n```bash\nmkdir data\n```\n\nAnd copy inside it the files\n\n- `Attori.txt`\n- `FilmFiltrati.txt`\n- `Relazioni.txt`\n\nAttention! If we are visualizing the actors graph, it's important to copy the file generated for it. Ideal values of `min-actors` and `votes` during the filtering are respectively `70` and `100000`. Since it has to be rendered in a web page, this values will generate graphs with about 1000 nodes. I won't suggest to try with bigger graphs","src/data/university/imdb-graph.md",[25],"bf072ecaab6c34e8",{"html":169,"metadata":170},"\u003Cp>The explanation of this algorithm and all its analysis can be found in the project report: \u003Ca href=\"https://github.com/lukefleed/imdb-graph/blob/main/tex/src/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/imdb-graph/raw/main/tex/src/main.pdf\">download\u003C/a>\u003C/p>\n\u003Cul>\n\u003Cli>Github repository: \u003Ca href=\"https://github.com/lukefleed/imdb-graph\">imdb-graph\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"documentation\">Documentation\u003C/h2>\n\u003Cp>First thing first, we need to clone the repository\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">git\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> clone\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> https://github.com/lukefleed/imdb-graph\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Once done, move in it\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic\">cd\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> imdb-graph\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"downloading-and-filtering-the-data\">Downloading and filtering the data\u003C/h3>\n\u003Cp>All the necessary file are inside the folder \u003Ccode>filters\u003C/code>\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic\">cd\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> filters\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We have two options. If we want to build the graph where the actors are the node, we have to run\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./actors_graph_filter.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --min-movies\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>min-movies\u003C/code> has to ben an integer, \u003Ccode>42\u003C/code> is just an example. It represents the minimum number of movies that an actor/actress needs to have done to be considered in our graph.\u003C/p>\n\u003Cp>If we want to build the graph where the movies are the nodes, we have to run\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./movie_graph_filter.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --votes\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 500\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>votes\u003C/code> has to ben an integer, \u003Ccode>500\u003C/code> is just an example. It represents the minimum number of votes that a movie needs to have on the IMDb database to be considered in our graph.\u003C/p>\n\u003Cp>All the data filtered will be saved in a new folder called \u003Ccode>data\u003C/code>\u003C/p>\n\u003Ch3 id=\"running-the-program\">Running the program\u003C/h3>\n\u003Cp>Letâ€™s move into the folder \u003Ccode>scripts\u003C/code>. If we want to run the program on the actors graph, use\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./actors_graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> top_actors_42\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>IMPORTANT: The algorithm is multi-threaded. Itâ€™s set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\nwhere \u003Ccode>top_actors_42\u003C/code> is the output file name. Anything can be used.\u003C/p>\n\u003C/blockquote>\n\u003Chr>\n\u003Cp>If we want to run the program on the movies graph, use\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./movie_graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> top_movies_42\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>IMPORTANT: The algorithm is multi-threaded. Itâ€™s set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\nwhere \u003Ccode>top_movies_42\u003C/code> is the output file name. Anything can be used\u003C/p>\n\u003C/blockquote>\n\u003Chr>\n\u003Cp>Those scripts will generate two files .txt (one for the harmonic and one for the closeness centrality). Those files will have the top-100 elements for the relative centrality. If we want a different value, just change the variable \u003Ccode>k\u003C/code> in the .cpp files\u003C/p>\n\u003Ch3 id=\"automatic-script-for-different-variables-of-filtering\">Automatic script for different variables of filtering\u003C/h3>\n\u003Cp>We are in the folder \u003Ccode>scripts\u003C/code>. Inside both the folders \u003Ccode>actor-graph\u003C/code> and \u003Ccode>movie-graph\u003C/code> there is a file called \u003Ccode>bench_me.sh\u003C/code>. This file will run everything automatically in loop for different values of the filtering variables. To modify this file we need to edit the file. To run it\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./bench_me.sh\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This will also save the logs in a folder called \u003Ccode>time\u003C/code>. It can be usefull to analyze the performance of the program.\u003C/p>\n\u003Chr>\n\u003Cp>Inside the folders \u003Ccode>closeness centrality\u003C/code> (for both graph), there is a python script \u003Ccode>analysis.py\u003C/code>. Put all the generated \u003Ccode>_c.txt\u003C/code> files in the folder and run it. It will return a matrix showing the discrepancy of the results while varying the variable\u003C/p>\n\u003Ch3 id=\"generating-the-interactive-graphs\">Generating the interactive graphs\u003C/h3>\n\u003Cp>First, letâ€™s move into the folder \u003Ccode>visualization\u003C/code>\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic\">cd\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> visualization\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>As before, we will find two folders, one for each type of graph. Choose the one that we want to with and move into that folder. Inside it we need to create a folder called \u003Ccode>data\u003C/code>\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mkdir\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> data\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>And copy inside it the files\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>Attori.txt\u003C/code>\u003C/li>\n\u003Cli>\u003Ccode>FilmFiltrati.txt\u003C/code>\u003C/li>\n\u003Cli>\u003Ccode>Relazioni.txt\u003C/code>\u003C/li>\n\u003C/ul>\n\u003Cp>Attention! If we are visualizing the actors graph, itâ€™s important to copy the file generated for it. Ideal values of \u003Ccode>min-actors\u003C/code> and \u003Ccode>votes\u003C/code> during the filtering are respectively \u003Ccode>70\u003C/code> and \u003Ccode>100000\u003C/code>. Since it has to be rendered in a web page, this values will generate graphs with about 1000 nodes. I wonâ€™t suggest to try with bigger graphs\u003C/p>",{"headings":171,"localImagePaths":185,"remoteImagePaths":186,"frontmatter":187,"imagePaths":190},[172,173,176,179,182],{"depth":32,"slug":128,"text":129},{"depth":131,"slug":174,"text":175},"downloading-and-filtering-the-data","Downloading and filtering the data",{"depth":131,"slug":177,"text":178},"running-the-program","Running the program",{"depth":131,"slug":180,"text":181},"automatic-script-for-different-variables-of-filtering","Automatic script for different variables of filtering",{"depth":131,"slug":183,"text":184},"generating-the-interactive-graphs","Generating the interactive graphs",[],[],{"author":14,"pubDatetime":188,"title":161,"slug":157,"featured":17,"draft":17,"tags":189,"ogImage":25,"description":163},["Date","2022-04-26T00:00:00.000Z"],[19],[],"blog",["Map",193,194,294,295,337,338,540,541,628,629],"cache-friendly-low-memory-lanczos",{"id":193,"data":195,"body":202,"filePath":203,"digest":204,"rendered":205},{"author":14,"pubDatetime":196,"title":197,"featured":198,"draft":17,"tags":199,"description":201},["Date","2025-11-11T00:00:00.000Z"],"Cache-Friendly, Low-Memory Lanczos Algorithm in Rust",true,[200,69],"Rust","How a bit of algorithm engineering and low-level details can alter what seems like a straightforward trade-off on a blackboard.","The standard Lanczos method for computing matrix functions has a brutal memory requirement: storing an $n \\times k$ basis matrix that grows with every iteration. For a $500.000$-variable problem needing $1000$ iterations, that's roughly 4 GB just for the basis.\n\nIn this post, we will explore one of the most straightforward solutions to this problem: a two-pass variant of the Lanczos algorithm that only requires $O(n)$ memory at the cost of doubling the number of matrix-vector products. The surprising part is that when implemented carefully, the two-pass version isn't just memory-efficientâ€”it can be faster for certain problems. We will dig into why.\n\n- All code is available on GitHub: [two-pass-lanczos](https://github.com/lukefleed/two-pass-lanczos)\n- A more complete report, with references and more experiments: [report.pdf](https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf)\n\nYou can discuss this post on [Hacker News](https://news.ycombinator.com/item?id=45889891), [Lobsters](https://lobste.rs/s/sag4i3/cache_friendly_low_memory_lanczos) and [Reddit](https://www.reddit.com/r/rust/comments/1ouf5hp/cachefriendly_lowmemory_lanczos_algorithm_in_rust/).\n\n\n---\n\n## Table of Contents\n\n\n# Computing Matrix Functions\n\nLet's consider the problem of computing the action of matrix functions on a vector:\n\n$$\n\\mathbf{x} = f(\\mathbf{A})\\mathbf{b}\n$$\n\nwhere $\\mathbf{A}$ is a large sparse Hermitian matrix and $f$ is a matrix function defined on the spectrum of $\\mathbf{A}$. This is a problem that appears pretty often in scientific computing: solving linear systems corresponds to $f(z) = z^{-1}$, exponential integrators for PDEs use $f(z) = \\exp(tz)$, and many other problems require functions like $f(z) = z^{-1/2}$ or $f(z) = \\text{sign}(z)$.\n\nIndeed, there are a lot problems with computing $f(\\mathbf{A})$ directly. First of all, even if $\\mathbf{A}$ is sparse, $f(\\mathbf{A})$ is generally dense. Storing it explicitly is out of the question for large problems. Even if we could store it, computing it directly would require algorithms like the Schur-Parlett method that scale as $O(n^3)$, which is impractical for large $n$.\n\nHowever we know that given any matrix function $f$ defined on the spectrum of $\\mathbf{A}$, we can express $f(\\mathbf{A})$ as a polynomial in $\\mathbf{A}$ of degree at most $n$ (the size of the matrix) such that $f(\\mathbf{A}) = p_{n}(\\mathbf{A})$ (this is a consequence of the Cayley-Hamilton theorem). This polynomial interpolates $f$ and its derivatives in the Hermitian sense at the eigenvalues of $\\mathbf{A}$.\n\nThis gives us a good and a bad news: the good news is that, well, we can express $f(\\mathbf{A})$ as a polynomial in $\\mathbf{A}$. The bad news is that the degree of this polynomial can be as high as $n$, which is huge for large problems. The idea is then to find a low-degree polynomial approximation to $f$ that is _good enough_ for our purposes. If we can find a polynomial $p_k$ of degree $k \\ll n$ such that $p_k(\\mathbf{A}) \\approx f(\\mathbf{A})$, then we can approximate the solution as:\n\n$$\nf(\\mathbf{A})\\mathbf{b} \\approx p_k(\\mathbf{A})\\mathbf{b} = \\sum_{i=0}^k c_i \\mathbf{A}^i \\mathbf{b}\n$$\n\nThis polynomial only involves vectors within a specific subspace.\n\n## Krylov Projection\n\nWe can notice that $p_k(\\mathbf{A})\\mathbf{b}$ only depends on vectors in the Krylov subspace of order $k$\n\n$$\n\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b}) = \\text{span}\\{\\mathbf{b}, \\mathbf{Ab}, \\mathbf{A}^2\\mathbf{b}, \\ldots, \\mathbf{A}^{k-1}\\mathbf{b}\\}\n$$\n\nThis is fortunate: we can compute an approximate solution by staying within this space, which only requires repeated matrix-vector products with $\\mathbf{A}$. For large sparse matrices, that's the only operation we can do efficiently anyway.\n\n> We don't need to construct $\\mathbf{A}^j$ explicitly. We compute iteratively: $\\mathbf{A}(\\mathbf{A}^{j-1}\\mathbf{b})$.\n\nBut there's a problem: the raw vectors $\\{\\mathbf{A}^j\\mathbf{b}\\}$ form a terrible basis. They quickly become nearly parallel, making any computation numerically unstable. We need an orthonormal basis.\n\n### Building an Orthonormal Basis\n\nThe standard method is the Arnoldi process, which is Gram-Schmidt applied to Krylov subspaces. We start by normalizing $\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2$. Then, iteratively:\n\n1. Compute a new candidate: $\\mathbf{w}_j = \\mathbf{A}\\mathbf{v}_j$\n2. Orthogonalize against all existing basis vectors:\n\n$$\n\\tilde{\\mathbf{v}}_j = \\mathbf{w}_j - \\sum_{i=1}^j (\\mathbf{v}_i^H \\mathbf{w}_j) \\mathbf{v}_i\n$$\n\n3. Normalize: $\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_j / \\|\\tilde{\\mathbf{v}}_j\\|_2$\n\nThe coefficients $h_{ij} = \\mathbf{v}_i^H \\mathbf{w}_j$ become entries of a projected matrix. After $k$ iterations, we have:\n\n- $\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]$: an orthonormal basis for $\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b})$\n- $\\mathbf{H}_k$: an upper Hessenberg matrix representing the projection of $\\mathbf{A}$ onto this subspace\n\nWe can express this relationship with the Arnoldi decomposition:\n\n$$\n\\mathbf{A}\\mathbf{V}_k = \\mathbf{V}_k \\mathbf{H}_k + h_{k+1,k} \\mathbf{v}_{k+1} \\mathbf{e}_k^T\n$$\n\n### Solving in the Reduced Space\n\nNow we approximate our original problem by solving it in the small $k$-dimensional space. Using the Full Orthogonal Method (FOM), we enforce that the residual is orthogonal to\nthe Krylov subspace. This gives:\n\n$$\n\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\n$$\n\nwhere $\\mathbf{y}_k$ is computed as:\n\n$$\n\\mathbf{y}_k = f(\\mathbf{H}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\n$$\n\nThe heavy lifting is now on computing $f(\\mathbf{H}_k)$, a small $k \\times k$ matrix.\nSince $k \\ll n$, we can afford direct methods like Schur-Parlett ($O(k^3)$).\n\n> For $f(z) = z^{-1}$ (linear systems), this reduces to solving $\\mathbf{H}_k \\mathbf{y}_k = \\mathbf{e}_1 \\|\\mathbf{b}\\|_2$ with LU decomposition.\n\n\n# The Lanczos Algorithm\n\nWhen $\\mathbf{A}$ is Hermitian (or symmetric in the real case), the general Arnoldi\nprocess simplifies dramatically. We can prove that $\\mathbf{H}_k = \\mathbf{V}_k^H \\mathbf{A} \\mathbf{V}_k$ must also be Hermitian. A matrix that is both upper Hessenberg *and* Hermitian must be real, symmetric, and tridiagonal. This is a _huge_ simplification.\n\nIn the literature, this projected matrix is denoted $\\mathbf{T}_k$ to highlight its\ntridiagonal structure:\n\n$$\n\\mathbf{T}_k = \\begin{pmatrix}\n\\alpha_1 & \\beta_1 & & \\\\\n\\beta_1 & \\alpha_2 & \\beta_2 & \\\\\n& \\beta_2 & \\ddots & \\ddots \\\\\n& & \\ddots & \\alpha_k\n\\end{pmatrix}\n$$\n\nwhere $\\alpha_j \\in \\mathbb{R}$ are the diagonal elements and $\\beta_j \\in \\mathbb{R}$ are the off-diagonals (subdiagonals from the orthogonalization).\n\n## Three-Term Recurrence\n\nThis tridiagonal structure leads to a beautiful simplification. To build the next basis\nvector $\\mathbf{v}_{j+1}$, we don't need the entire history of vectors. We only need\nthe two previous ones. Since $\\mathbf{A}$ is Hermitian, this guarantees that\nany new vector is _automatically_ orthogonal to all earlier vectors (beyond the previous two). So we can skip the full orthogonalization and use a simple three-term recurrence:\n\n$$\n\\mathbf{A}\\mathbf{v}_j = \\beta_{j-1}\\mathbf{v}_{j-1} + \\alpha_j \\mathbf{v}_j + \\beta_j \\mathbf{v}_{j+1}\n$$\n\nRearranging gives us an algorithm to compute $\\mathbf{v}_{j+1}$ directly:\n\n1. Compute the candidate: $w_{j+1} = \\mathbf{A}\\mathbf{v}_j$\n2. Extract the diagonal coefficient: $\\alpha_j = \\mathbf{v}_j^H w_{j+1}$\n3. Orthogonalize against the two previous vectors:\n\n$$\n\\tilde{\\mathbf{v}}_{j+1} = w_{j+1} - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\n$$\n\n4. Normalize: $\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2$ and $\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j$\n\nThis is known as the Lanczos algorithm. It's more efficient than Arnoldi because each iteration only orthogonalizes against two previous vectors instead of all prior ones.\n\n## Reconstructing the Solution\n\nAfter $k$ iterations, we end up with the tridiagonal matrix $\\mathbf{T}_k$ and all $k$ basis vectors $\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]$. We can then reconstruct the approximate solution as:\n\n$$\n\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\n$$\n\nwhere $\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2$ is solved from the small tridiagonal matrix.\n\nThere is a timing problem however: we cannot compute the coefficients $\\mathbf{y}_k$\nuntil all $k$ iterations are complete. The full matrix $\\mathbf{T}_k$ is only available\nat the end, so we must store every basis vector $\\mathbf{v}_j$ along the way, leading to a memory cost of $O(nk)$.\n\nSo we're left with a choice: whether we store all the basis vectors and solve the problem in $k$ passes, or find a way to avoid storing them. There is a middle ground.\n\n> There are also techniques to compress the basis vectors, have a look [here](https://arxiv.org/abs/2403.04390)\n\n\n# Two-Pass Algorithm\n\nHere's where we break the timing deadlock. The insight that we don't actually need to store the basis vectors if we can afford to compute them twice\n\nThink about what we have after the first pass. We've computed all the $\\alpha_j$ and $\\beta_j$ coefficients that compose the entire tridiagonal matrix $\\mathbf{T}_k$. These numbers are small compared to the full basis. What if we kept only these scalars, discarded all the vectors, and then replayed the Lanczos recurrence a second time? We'd regenerate the same basis, and this time we'd use it to build the solution.\n\nThis comes at a cost. We run Lanczos twice, so we pay for $2k$ matrix-vector products instead of $k$. But we only ever store a constant number of vectors in memory, no $O(nk)$ basis matrix. The memory complexity drops to $O(n)$.\n\nIt sounds like a bad trade at first. But as we'll see later, the cache behavior of this\ntwo-pass approach can actually make it as fast (or even faster) on real hardware if well optimized.\n\n## First Pass: Compute the Projected Problem\n\nWe initialize $\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2$ and set $\\beta_0 = 0$, $\\mathbf{v}_0 = \\mathbf{0}$.Then we run the standard Lanczos recurrence:\n\n$$\nw_j = \\mathbf{A}\\mathbf{v}_j\n$$\n\n$$\n\\alpha_j = \\mathbf{v}_j^H w_j\n$$\n\n$$\n\\tilde{\\mathbf{v}}_{j+1} = w_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\n$$\n\n$$\n\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2, \\quad \\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j\n$$\n\nAt each step, we record $\\alpha_j$ and $\\beta_j$. But we *do not* store $\\mathbf{v}_j$.\nInstead, we discard it immediately after computing $\\mathbf{v}_{j+1}$. In this way we only keep in memory at most just three vectors at any time ($\\mathbf{v}_{j-1}$, $\\mathbf{v}_j$, and the working vector $w_j$).\n\nAfter $k$ iterations, we have the full set $\\{\\alpha_1, \\beta_1, \\ldots, \\alpha_k, \\beta_k\\}$. These $O(k)$ scalars define the tridiagonal matrix $\\mathbf{T}_k$. We can now solve:\n\n$$\n\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\n$$\n\nThis is the solution in the reduced space. Now that we have the coefficients we need to build $\\mathbf{x}_k$.\n\n## Second Pass: Reconstruct and Accumulate\n\nWith $\\mathbf{y}_k$ in memory, we replay the Lanczos recurrence _exactly as before_. We start with the same initialization ($\\mathbf{v}_1$, $\\beta_0$, $\\mathbf{v}_0$) and apply the same sequence of operations, using the stored scalars $\\alpha_j$ and $\\beta_j$ to reconstruct each basis vector on demand. We can write some rust-like _pseudocode_ for this second pass to get a feel for it:\n\n```rust\nlet mut x_k = vec![0.0; n];\nlet mut v_prev = vec![0.0; n];\nlet mut v_curr = b.clone() / b_norm;\n\nfor j in 1..=k {\n    let w = A @ v_curr;  // Matrix-vector product\n\n    // We don't recompute alpha/beta; we already have them from pass 1\n    let alpha_j = alphas[j - 1];\n    let beta_prev = j > 1 ? betas[j - 2] : 0.0;\n\n    // Accumulate the solution\n    x_k += y_k[j - 1] * v_curr;\n\n    // Regenerate the next basis vector for the *next* iteration\n    let v_next = (w - alpha_j * v_curr - beta_prev * v_prev) / betas[j - 1];\n\n    // Slide the window forward\n    v_prev = v_curr;\n    v_curr = v_next;\n}\n```\n\nThis loop regenerates each $\\mathbf{v}_j$ on demand and immediately uses it to update the solution.\nOnce we've accumulated $(\\mathbf{y}_k)_j \\mathbf{v}_j$ into $\\mathbf{x}_k$, we discard the vector. We never store the full basis.\n\n### A Subtle Numerical Point\n\nThere is one detail worth noting: floating-point arithmetic is deterministic. When we replay the Lanczos recurrence in the second pass with the exact same inputs and the exact same order of operations, we get bitwise-identical vectors. The $\\mathbf{v}_j$ regenerated in pass 2 are identical to the ones computed in pass 1.\n\nHowever, the order in which we accumulate the solution differs. In a standard Lanczos,\n$\\mathbf{x}_k$ is built as a single matrix-vector product: $\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k$ (a `gemv` call in BLAS). In the two-pass method, it's built as a loop of scaled vector additions (a series of `axpy` calls). These operations accumulate rounding error differently, so the final solution differs slightly, typically by machine epsilon. This rarely matters in practice, and convergence is unaffected.\n\n# Implementation\n\nBuilding this in Rust forces us to think concretely about where data lives and how it flows through the cache hierarchy. We need to control memory layout, decide when allocations happen, and choose abstractions that cost us nothing at runtime.\n\nFor linear algebra, we reach for [`faer`](https://github.com/sarah-ek/faer-rs). Three design choices in this library matter for what we're building:\n\n- **Stack allocation via `MemStack`:** Pre-allocated scratch space that lives for the entire computation. The hot path becomes allocation-free.\n- **Matrix-free operators:** The `LinOp` trait defines an operator by its action (`apply`) without materializing a matrix. For large sparse problems, this is the only viable approach.\n- **SIMD-friendly loops:** The `zip!` macro generates code that compiles to packed instructions.\n\n## Recurrence Step\n\nOur starting point is the Lanczos three-term recurrence that we derived earlier:\n\n$$\n\\beta_j \\mathbf{v}_{j+1} = \\mathbf{A}\\mathbf{v}_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\n$$\n\nWe can translate this into a recurrence step function. The signature looks like this:\n\n```rust\nfn lanczos_recurrence_step\u003CT: ComplexField, O: LinOp\u003CT>>(\n    operator: &O,\n    mut w: MatMut\u003C'_, T>,\n    v_curr: MatRef\u003C'_, T>,\n    v_prev: MatRef\u003C'_, T>,\n    beta_prev: T::Real,\n    stack: &mut MemStack,\n) -> (T::Real, Option\u003CT::Real>)\n```\n\nThe function is generic over the field type `T` (`f64`, `c64`, etc.) and the operator type `O`. It operates on matrix views (`MatMut` and `MatRef`) to avoid unnecessary data copies. The return type gives us the diagonal element $\\alpha_j$ and, _if no breakdown occurs_, the off-diagonal $\\beta_j$.\n\nNow we can implement the body by following the math. The first step is the most expensive:\n\n```rust\n// 1. Apply operator: w = A * v_curr\noperator.apply(w.rb_mut(), v_curr, Par::Seq, stack);\n```\n\nThe matrix-vector product dominates the computational cost. Everything else is secondary.\n\nNext, we orthogonalize against $\\mathbf{v}_{j-1}$. This is where we benefit from `faer`'s design. The `zip!` macro fuses this operation into a single loop that the compiler vectorizes into SIMD instructions.\n\n```rust\n// 2. Orthogonalize against v_{j-1}: w -= Î²_{j-1} * v_{j-1}\nlet beta_prev_scaled = T::from_real_impl(&beta_prev);\nzip!(w.rb_mut(), v_prev).for_each(|unzip!(w_i, v_prev_i)| {\n    *w_i = sub(w_i, &mul(&beta_prev_scaled, v_prev_i));\n});\n```\n\nWith `w` partially orthogonalized, we can compute the diagonal coefficient via an inner product. Since $\\mathbf{A}$ is Hermitian, $\\alpha_j$ is guaranteed real.\n\n```rust\n// 3. Compute Î±_j = v_j^H * w\nlet alpha = T::real_part_impl(&(v_curr.adjoint() * w.rb())[(0, 0)]);\n```\n\nWe complete the orthogonalization against $\\mathbf{v}_j$ with another `zip!` loop.\n\n```rust\n// 4. Orthogonalize against v_j: w -= Î±_j * v_j\nlet alpha_scaled = T::from_real_impl(&alpha);\nzip!(w.rb_mut(), v_curr).for_each(|unzip!(w_i, v_curr_i)| {\n    *w_i = sub(w_i, &mul(&alpha_scaled, v_curr_i));\n});\n```\n\nNow `w` holds the unnormalized next basis vector. We compute its norm to get $\\beta_j$. If this norm is numerically zero, the Krylov subspace is invariant, the iteration has reached its natural stopping point. This is called breakdown.\n\n```rust\n// 5. Compute Î²_j = ||w||_2 and check for breakdown\nlet beta = w.rb().norm_l2();\nlet tolerance = breakdown_tolerance::\u003CT::Real>();\n\nif beta \u003C= tolerance {\n    (alpha, None)\n} else {\n    (alpha, Some(beta))\n}\n```\n\nThe function returns `None` for $\\beta_j$ when breakdown occurs, signaling to the caller that no further iterations should proceed.\n\n## An Iterator for State Management\n\nThe recurrence step is a pure function, but calling it in a loop is both inefficient and awkward. We'd need to manually pass vectors in and out of each iteration. More critically, we'd create copies when we should be reusing memory.\n\nThe iterator pattern solves this. We create a struct that encapsulates the state:\n\n```rust\nstruct LanczosIteration\u003C'a, T: ComplexField, O: LinOp\u003CT>> {\n    operator: &'a O,\n    v_prev: Mat\u003CT>,       // v_{j-1}\n    v_curr: Mat\u003CT>,       // v_j\n    work: Mat\u003CT>,         // Workspace for the next vector\n    beta_prev: T::Real,   // Î²_{j-1}\n    // ... iteration counters\n}\n```\n\nThe main design choice here is that vectors are **owned** (`Mat\u003CT>`), not borrowed. This enables an optimization in the `next_step` method. After computing the next vector and normalizing it into `work`, we cycle the state without allocating or copying:\n\n```rust\n// Inside next_step, after normalization...\ncore::mem::swap(&mut self.v_prev, &mut self.v_curr);\ncore::mem::swap(&mut self.v_curr, &mut self.work);\n```\n\nOn x86-64, swapping two `Mat\u003CT>` structures (fat pointers) compiles to three `mov` instructions. The pointers change, but no vector data moves. After the swap, `v_prev` points to what `v_curr` held, `v_curr` points to `work`'s allocation, and `work` points to the old `v_prev` data. In the next iteration, `work` gets reused.\n\nWe keep exactly three n-dimensional vectors live in memory. The same allocations cycle through the computation, staying hot in L1 cache. This is the core reason the two-pass method can be faster than expected, the working set never leaves cache.\n\n## First Pass: Computing the Decomposition\n\nThe first pass runs the Lanczos iteration and collects the coefficients $\\{\\alpha_j, \\beta_j\\}$. Basis vectors are discarded after each step.\n\n```rust\npub fn lanczos_pass_one\u003CT: ComplexField>(\n    operator: &impl LinOp\u003CT>,\n    b: MatRef\u003C'_, T>,\n    k: usize,\n    stack: &mut MemStack,\n) -> Result\u003CLanczosDecomposition\u003CT::Real>, LanczosError> {\n    // ...\n}\n```\n\nWe allocate vectors for the coefficients with a capacity hint to avoid reallocations:\n\n```rust\nlet mut alphas = Vec::with_capacity(k);\nlet mut betas = Vec::with_capacity(k - 1);\n```\n\nThen we construct the iterator. This allocates the three work vectors once. After this point, the hot path is allocation-free:\n\n```rust\nlet mut lanczos_iter = LanczosIteration::new(operator, b, k, b_norm)?;\n\nfor i in 0..k {\n    if let Some(step) = lanczos_iter.next_step(stack) {\n        alphas.push(step.alpha);\n        steps_taken += 1;\n\n        let tolerance = breakdown_tolerance::\u003CT::Real>();\n        if step.beta \u003C= tolerance {\n            break;\n        }\n\n        if i \u003C k - 1 {\n            betas.push(step.beta);\n        }\n    } else {\n        break;\n    }\n}\n```\n\nThe check for breakdown stops the iteration when the residual becomes numerically zero. This means we've found an invariant subspace and there's no value in continuing.\n\nAt the end, we collect the scalars into a `LanczosDecomposition` struct. The memory footprint throughout this pass is constant: three n-dimensional vectors plus two small arrays that grow to at most $k$ elements.\n\n## Second Pass: Reconstructing the Solution\n\nNow we face a different problem. We have the $\\{\\alpha_j, \\beta_j\\}$ coefficients from the first pass and the coefficient vector $\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2$ from solving the projected problem. We need to reconstruct the solution:\n\n$$\n\\mathbf{x}_k = \\sum_{j=1}^k (\\mathbf{y}_k)_j \\mathbf{v}_j\n$$\n\nwithout storing the full basis matrix $\\mathbf{V}_k$.\n\nThe recurrence step in this pass is structurally similar to the first pass, but with a key difference: we no longer compute inner products or norms. We already know the coefficients, so the step becomes pure reconstruction.\n\n```rust\nfn lanczos_reconstruction_step\u003CT: ComplexField, O: LinOp\u003CT>>(\n    operator: &O,\n    mut w: MatMut\u003C'_, T>,\n    v_curr: MatRef\u003C'_, T>,\n    v_prev: MatRef\u003C'_, T>,\n    alpha_j: T::Real,\n    beta_prev: T::Real,\n    stack: &mut MemStack,\n) {\n    // Apply operator\n    operator.apply(w.rb_mut(), v_curr, Par::Seq, stack);\n\n    // Orthogonalize using stored Î±_j and Î²_{j-1}\n    let beta_prev_scaled = T::from_real_impl(&beta_prev);\n    zip!(w.rb_mut(), v_prev).for_each(|unzip!(w_i, v_prev_i)| {\n        *w_i = sub(w_i, &mul(&beta_prev_scaled, v_prev_i));\n    });\n\n    let alpha_scaled = T::from_real_impl(&alpha_j);\n    zip!(w.rb_mut(), v_curr).for_each(|unzip!(w_i, v_curr_i)| {\n        *w_i = sub(w_i, &mul(&alpha_scaled, v_curr_i));\n    });\n}\n```\n\nThis is cheaper than the first-pass recurrence. We've eliminated the inner products that computed $\\alpha_j$ and the norm calculation for $\\beta_j$. What remains is pure orthogonalization and the operator application.\n\n`lanczos_pass_two` implements this reconstruction. We initialize the three work vectors and the solution accumulator:\n\n```rust\npub fn lanczos_pass_two\u003CT: ComplexField>(\n    operator: &impl LinOp\u003CT>,\n    b: MatRef\u003C'_, T>,\n    decomposition: &LanczosDecomposition\u003CT::Real>,\n    y_k: MatRef\u003C'_, T>,\n    stack: &mut MemStack,\n) -> Result\u003CMat\u003CT>, LanczosError> {\n    let mut v_prev = Mat::\u003CT>::zeros(b.nrows(), 1);\n    let inv_norm = T::from_real_impl(&T::Real::recip_impl(&decomposition.b_norm));\n    let mut v_curr = b * Scale(inv_norm);  // v_1\n\n    let mut work = Mat::\u003CT>::zeros(b.nrows(), 1);\n\n    // Initialize solution with first component\n    let mut x_k = &v_curr * Scale(T::copy_impl(&y_k[(0, 0)]));\n```\n\nWe build the solution incrementally by starting with the first basis vector scaled by its coefficient. The main loop then regenerates each subsequent vector: we regenerate each subsequent basis vector, normalize it using the stored $\\beta_j$, and immediately accumulate its contribution:\n\n```rust\nfor j in 0..decomposition.steps_taken - 1 {\n    let alpha_j = T::Real::copy_impl(&decomposition.alphas[j]);\n    let beta_j = T::Real::copy_impl(&decomposition.betas[j]);\n    let beta_prev = if j == 0 {\n        T::Real::zero_impl()\n    } else {\n        T::Real::copy_impl(&decomposition.betas[j - 1])\n    };\n\n    // 1. Regenerate the unnormalized next vector\n    lanczos_reconstruction_step(\n        operator,\n        work.as_mut(),\n        v_curr.as_ref(),\n        v_prev.as_ref(),\n        alpha_j,\n        beta_prev,\n        stack,\n    );\n\n    // 2. Normalize using stored Î²_j\n    let inv_beta = T::from_real_impl(&T::Real::recip_impl(&beta_j));\n    zip!(work.as_mut()).for_each(|unzip!(w_i)| {\n        *w_i = mul(w_i, &inv_beta);\n    });\n\n    // 3. Accumulate: x_k += y_{j+1} * v_{j+1}\n    let coeff = T::copy_impl(&y_k[(j + 1, 0)]);\n    zip!(x_k.as_mut(), work.as_ref()).for_each(|unzip!(x_i, v_i)| {\n        *x_i = add(x_i, &mul(&coeff, v_i));\n    });\n\n    // 4. Cycle vectors for the next iteration\n    core::mem::swap(&mut v_prev, &mut v_curr);\n    core::mem::swap(&mut v_curr, &mut work);\n}\n```\n\nThe accumulation `x_k += y_{j+1} * v_{j+1}` is implemented as a fused multiply-add in the `zip!` loop. On hardware with FMA support, this becomes a single instruction per element, not three separate operations.\n\nNote that we accumulate the solution incrementally. After each iteration, `x_k` contains a partial result. We cycle through the same three vectors (`v_prev`, `v_curr`, `work`), keeping the working set small and resident in L1 cache.\n\nCompare this to the standard method's final reconstruction step: $\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k$. This is a dense matrix-vector product where $\\mathbf{V}_k$ is $n \\times k$. When $n$ and $k$ are both large, this matrix no longer fits in cache. The CPU must stream it from main memory, paying the cost of memory latency. Each element requires a load, multiply, and accumulate, but the load operations dominateâ€”the CPU stalls waiting for data.\n\nIn our two-pass reconstruction, the operator `$\\mathbf{A}$` is applied $k$ times, but against vectors that stay in cache. The memory bandwidth is spent on reading the sparse structure of $\\mathbf{A}$ and the vector elements, not on scanning a dense $n \\times k$ matrix.\n\nThis is the reason the two-pass method can be faster on real hardware despite performing twice as many matrix-vector products. The cache behavior of the reconstruction phase overwhelms the savings of storing the basis.\n\n## The Public API\n\nWe can wrap the two passes into a single entry point:\n\n```rust\npub fn lanczos_two_pass\u003CT, O, F>(\n    operator: &O,\n    b: MatRef\u003C'_, T>,\n    k: usize,\n    stack: &mut MemStack,\n    mut f_tk_solver: F,\n) -> Result\u003CMat\u003CT>, LanczosError>\nwhere\n    T: ComplexField,\n    O: LinOp\u003CT>,\n    F: FnMut(&[T::Real], &[T::Real]) -> Result\u003CMat\u003CT>, anyhow::Error>,\n{\n    // First pass: compute T_k coefficients\n    let decomposition = lanczos_pass_one(operator, b, k, stack)?;\n\n    if decomposition.steps_taken == 0 {\n        return Ok(Mat::zeros(b.nrows(), 1));\n    }\n\n    // Solve projected problem: y_k' = f(T_k) * e_1\n    let y_k_prime = f_tk_solver(&decomposition.alphas, &decomposition.betas)?;\n\n    // Scale by ||b||\n    let y_k = &y_k_prime * Scale(T::from_real_impl(&decomposition.b_norm));\n\n    // Second pass: reconstruct solution\n    lanczos_pass_two(operator, b, &decomposition, y_k.as_ref(), stack)\n}\n```\n\nThe design separates concerns. The `f_tk_solver` closure is where we inject the specific matrix function. We compute the Lanczos decomposition, then pass the coefficients to the user-provided solver, which computes $\\mathbf{y}_k' = f(\\mathbf{T}_k) \\mathbf{e}_1$ for whatever function $f$ is needed. This decoupling means we handle linear solves, matrix exponentials, or any other function without modifying the core algorithm.\n\nThe caller provides `f_tk_solver` as a closure. It receives the raw $\\{\\alpha_j, \\beta_j\\}$ arrays and must return the coefficient vector $\\mathbf{y}_k'$. We then scale it by $\\|\\mathbf{b}\\|_2$ and pass everything to the second pass.\n\n### Example: Solving a Linear System\n\nTo see this in practice, consider solving $\\mathbf{Ax} = \\mathbf{b}$. We compute $f(z) = z^{-1}$, which means the `f_tk_solver` must solve the small tridiagonal system $\\mathbf{T}_k \\mathbf{y}' = \\mathbf{e}_1$.\n\nSince $\\mathbf{T}_k$ is tridiagonal, we can exploit its structure. A sparse LU factorization solves it in $O(k)$ time instead of the $O(k^3)$ cost of a dense method.\n\n```rust\nlet f_tk_solver = |alphas: &[f64], betas: &[f64]| -> Result\u003CMat\u003Cf64>, anyhow::Error> {\n    let steps = alphas.len();\n    if steps == 0 {\n        return Ok(Mat::zeros(0, 1));\n    }\n\n    // 1. Assemble T_k from coefficients using triplet format\n    let mut triplets = Vec::with_capacity(3 * steps - 2);\n    for (i, &alpha) in alphas.iter().enumerate() {\n        triplets.push(Triplet { row: i, col: i, val: alpha });\n    }\n    for (i, &beta) in betas.iter().enumerate() {\n        triplets.push(Triplet { row: i, col: i + 1, val: beta });\n        triplets.push(Triplet { row: i + 1, col: i, val: beta });\n    }\n    let t_k_sparse = SparseColMat::try_new_from_triplets(steps, steps, &triplets)?;\n\n    // 2. Construct e_1\n    let mut e1 = Mat::zeros(steps, 1);\n    e1.as_mut()[(0, 0)] = 1.0;\n\n    // 3. Solve T_k * y' = e_1 via sparse LU\n    Ok(t_k_sparse.as_ref().sp_lu()?.solve(e1.as_ref()))\n};\n```\n\nThe closure takes the coefficient arrays, constructs the sparse tridiagonal matrix, and solves the system. The triplet format lets us build the matrix efficiently without knowing its structure in advance. The sparse LU solver leverages the tridiagonal structure to avoid dense factorization.\n\n\n# Some interesting results\n\nNow that we have a working implementation we can run some tests. The core idea of what we have done is simple: trade flops for better memory access. But does this trade actually pay off on real hardware? To find out, we need a reliable way to benchmark it.\n\nFor the data, we know that the performance of any Krylov method is tied to the operator's spectral properties. We need a way to generate a family of test problems where we can precisely control the size, sparsity, and numerical difficulty. A great way to do this is with Karush-Kuhn-Tucker (KKT) systems, which are sparse, symmetric, and have a specific block structure.\n\n$$\nA =\n\\begin{pmatrix}\n    D & E^T \\\\\n    E & 0\n\\end{pmatrix}\n$$\n\nThis structure gives us two critical knobs to turn. First, with the [netgen](https://commalab.di.unipi.it/files/Data/MCF/netgen.tgz) utility, we can control the $E$ matrix, which lets us dial in the problem dimension, $n$. Second, we build the diagonal block D with random entries from a range $[1, C_D]$. This parameter, $C_D$, gives us direct control over the numerical difficulty of the problem.\n\nFor a symmetric matrix like $D$, the 2-norm condition number, $\\kappa_2(D)$, is the ratio of its largest to its smallest eigenvalue: $\\kappa_2(D) = \\lambda_{\\max}(D) / \\lambda_{\\min}(D)$. Since $D$ is diagonal, its eigenvalues are simply its diagonal entries. We are drawing these entries from a uniform distribution $U[1, C_D]$, so we have $\\lambda_{\\max}(D) \\approx C_D$ and $\\lambda_{\\min}(D) \\approx 1$. This means we get direct control, as $\\kappa_2(D) \\approx C_D$.The spectral properties of this block heavily influence the spectrum of the entire matrix $A$. A large condition number in $D$ leads to a more ill-conditioned system for $A$. The convergence rate of Krylov methods like Lanczos is fundamentally governed by the distribution of the operator's eigenvalues. An ill-conditioned matrix, with a wide spread of eigenvalues, will require more iterations, $k$, to reach the desired accuracy. By simply adjusting the $C_D$ parameter, we can generate everything from well-conditioned problems that converge quickly to ill-conditioned ones that force us to run a large number of iterations. This is exactly what we need to rigorously test our implementation.\n\n## Memory and Computation Trade-off\n\nWe measure the algorithm against two hypotheses on a large sparse problem with $n=500,000$, varying the number of iterations $k$.\n\n**Hypothesis 1 (Memory):** The one-pass method stores the full basis $\\mathbf{V}_k$ with complexity $O(nk)$. We expect its memory to grow linearly with $k$. The two-pass method operates with $O(n)$ memory, so it should have a flat profile.\n\n**Hypothesis 2 (Runtime):** The two-pass method performs $2k$ matrix-vector products instead of $k$. If all else were equal, we'd expect it to run twice as slow.\n\n### Memory Usage\n\n![Memory vs Iterations](/assets/lanczos/tradeoff_arcs500k_rho3_memory.png)\n\nThe memory data confirms Hypothesis 1 exactly. The one-pass method's footprint scales as a straight lineâ€”each additional iteration adds one vector to the basis. The two-pass method remains flat. No allocation growth happens after initialization.\n\n### Runtime: Where Theory Breaks\n\n![Runtime vs Iterations](/assets/lanczos/tradeoff_arcs500k_rho3_time.png)\n\nThe runtime data contradicts Hypothesis 2. The two-pass method is slower, but never by a factor of two. For small $k$, the gap is minimal. As $k$ grows, the two-pass runtime diverges slowly from the one-pass method, not by doubling, but by a much smaller margin.\n\nThis difference comes from memory access patterns. Both methods perform matrix-vector products, but they differ in how they reconstruct the solution.\n\nThe one-pass method computes $\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k$ in a single dense matrix-vector product. When $n$ and $k$ are large, the $n \\times k$ basis matrix exceeds all cache levels. The CPU cannot keep the data resident; instead, it streams $\\mathbf{V}_k$ from main memory. This is a memory-bandwidth-bound operation. The processor stalls, waiting for each load to complete. Instruction-level parallelism collapses.\n\nThe two-pass method reconstructs the solution incrementally. At each iteration, it operates on exactly three n-dimensional vectors: $\\mathbf{v}_{\\text{prev}}$, $\\mathbf{v}_{\\text{curr}}$, and $\\mathbf{x}_k$. This working set fits in L1 cache. The processor performs $2k$ matrix-vector products (each one reading the sparse operator, then applying it to a cached vector), but the solution accumulation happens entirely within cache. The additional matrix-vector products are cheaper than the memory latency of the standard method.\n\nThe cost of re-computing basis vectors is less than the latency cost of scanning an $n \\times k$ dense matrix from main memory.\n\n### Medium-Scale Behavior\n\n![Medium Scale Runtime vs Iterations](/assets/lanczos/tradeoff_arcs50k_rho3_time.png)\n![Medium Scale Memory Usage vs Iterations](/assets/lanczos/tradeoff_arcs50k_rho3_memory.png)\n\nAt $n=50,000$ we can observe an equilibrium. The two methods have nearly identical runtime. The standard method's $\\mathbf{V}_k$ matrix is smaller; it fits partially in cache. The cache-miss penalty here becomes manageable. The two-pass method still has the advantage of cache-local accumulation, but the difference is marginal.\n\n### What About Dense Matrices?\n\nTo be sure of our hypothesis, we can test it directly using a dense matrix of size $n=10,000$. For dense problems, the matrix-vector product is $O(n^2)$, it dominates all other costs. Memory latency will become negligible relative to the compute work and the cache efficiency advantage should disappear.\n\n![Dense Matrix Runtime vs Iterations](/assets/lanczos/dense-tradeoff.png)\n\nWe can see that the two-pass method runs almost exactly twice as slow as the one-pass method. The slope ratio is _exactly_ 2:1. In a compute-bound regime, the extra matrix-vector products cannot be hidden by cache effects. Here, the theoretical trade-off holds perfectly.\n\n## Scalability\n\nNow, let's fix the iteration count at $k=500$ and vary $n$ from $50,000$ to $500,000$ to measure scalability. Based on what we have seen before, we would expect the two-pass memory to scale linearly with $n$ but with a small constant factor (three vectors, plus scalars). The one-pass method should also scale linearly, but with a $k$-dependent slope.\n\n![Scalability Memory Usage](/assets/lanczos/scalability_k500_rho3_memory.png)\n\nHere we have to use a logarithmic y-axis to show both curves; the two-pass line is so flat relative to the one-pass line that it's otherwise invisible.\n\n\n![Scalability Runtime](/assets/lanczos/scalability_k500_rho3_time.png)\n\nRuntime scales linearly with $n$ for both methods, as expected. Below $n=150,000$, the two methods have similar performance. This is the regime where both basis and working set fit in cache, or where the problem is small enough that memory latency is not the bottleneck.\n\nAs $n$ increases beyond $150,000$, the matrix-vector product time dominates. The sparse structure of $\\mathbf{A}$ ensures that each matvec requires multiple memory accesses per element. For the one-pass method, the final reconstruction of $\\mathbf{V}_k \\mathbf{y}_k$ begins to cost more as the matrix grows. For the two-pass method, performing $2k$ matrix-vector products means the matvec cost accumulates more rapidly. The divergence is gradual, not sharp, because the advantage of cache locality in accumulation persistsâ€”but it cannot overcome the fundamental cost of doubling the number of expensive operations.\n\n---\n\nWell, that's it. If you want to have a better look at the code or use it, it's all open source:\n\n* [Github Repository](https://github.com/lukefleed/two-pass-lanczos)\n* [LaTeX Report](https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf)\n\nThis was more of an exploration than a production-ready library, so expect rough edges. But I hope it gives an interesting perspective on how algorithm engineering and low-level implementation details can alter what seems like a straightforward trade-off on a blackboard.","src/data/blog/two-pass-lanczos.md","ba80377584aa09f3",{"html":206,"metadata":207},"\u003Cp>The standard Lanczos method for computing matrix functions has a brutal memory requirement: storing an \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis matrix that grows with every iteration. For a \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>500.000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">500.000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">500.000\u003C/span>\u003C/span>\u003C/span>\u003C/span>-variable problem needing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>1000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">1000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1000\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, thatâ€™s roughly 4 GB just for the basis.\u003C/p>\n\u003Cp>In this post, we will explore one of the most straightforward solutions to this problem: a two-pass variant of the Lanczos algorithm that only requires \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> memory at the cost of doubling the number of matrix-vector products. The surprising part is that when implemented carefully, the two-pass version isnâ€™t just memory-efficientâ€”it can be faster for certain problems. We will dig into why.\u003C/p>\n\u003Cul>\n\u003Cli>All code is available on GitHub: \u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos\">two-pass-lanczos\u003C/a>\u003C/li>\n\u003Cli>A more complete report, with references and more experiments: \u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf\">report.pdf\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>You can discuss this post on \u003Ca href=\"https://news.ycombinator.com/item?id=45889891\">Hacker News\u003C/a>, \u003Ca href=\"https://lobste.rs/s/sag4i3/cache_friendly_low_memory_lanczos\">Lobsters\u003C/a> and \u003Ca href=\"https://www.reddit.com/r/rust/comments/1ouf5hp/cachefriendly_lowmemory_lanczos_algorithm_in_rust/\">Reddit\u003C/a>.\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"table-of-contents\">Table of Contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of Contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#computing-matrix-functions\">Computing Matrix Functions\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#krylov-projection\">Krylov Projection\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#building-an-orthonormal-basis\">Building an Orthonormal Basis\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#solving-in-the-reduced-space\">Solving in the Reduced Space\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#the-lanczos-algorithm\">The Lanczos Algorithm\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#three-term-recurrence\">Three-Term Recurrence\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#reconstructing-the-solution\">Reconstructing the Solution\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#two-pass-algorithm\">Two-Pass Algorithm\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#first-pass-compute-the-projected-problem\">First Pass: Compute the Projected Problem\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#second-pass-reconstruct-and-accumulate\">Second Pass: Reconstruct and Accumulate\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#a-subtle-numerical-point\">A Subtle Numerical Point\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#implementation\">Implementation\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#recurrence-step\">Recurrence Step\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#an-iterator-for-state-management\">An Iterator for State Management\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#first-pass-computing-the-decomposition\">First Pass: Computing the Decomposition\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#second-pass-reconstructing-the-solution\">Second Pass: Reconstructing the Solution\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-public-api\">The Public API\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#example-solving-a-linear-system\">Example: Solving a Linear System\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#some-interesting-results\">Some interesting results\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-and-computation-trade-off\">Memory and Computation Trade-off\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-usage\">Memory Usage\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#runtime-where-theory-breaks\">Runtime: Where Theory Breaks\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#medium-scale-behavior\">Medium-Scale Behavior\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#what-about-dense-matrices\">What About Dense Matrices?\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#scalability\">Scalability\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch1 id=\"computing-matrix-functions\">Computing Matrix Functions\u003C/h1>\n\u003Cp>Letâ€™s consider the problem of computing the action of matrix functions on a vector:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x} = f(\\mathbf{A})\\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4444em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is a large sparse Hermitian matrix and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> is a matrix function defined on the spectrum of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This is a problem that appears pretty often in scientific computing: solving linear systems corresponds to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, exponential integrators for PDEs use \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmi>exp\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>t\u003C/mi>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = \\exp(tz)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mop\">exp\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">t\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and many other problems require functions like \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1/2}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.888em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> or \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmtext>sign\u003C/mtext>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = \\text{sign}(z)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord text\">\u003Cspan class=\"mord\">sign\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>Indeed, there are a lot problems with computing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> directly. First of all, even if \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is sparse, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> is generally dense. Storing it explicitly is out of the question for large problems. Even if we could store it, computing it directly would require algorithms like the Schur-Parlett method that scale as \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>n\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, which is impractical for large \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>However we know that given any matrix function \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> defined on the spectrum of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we can express \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> as a polynomial in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> of degree at most \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> (the size of the matrix) such that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>n\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A}) = p_{n}(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> (this is a consequence of the Cayley-Hamilton theorem). This polynomial interpolates \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> and its derivatives in the Hermitian sense at the eigenvalues of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>This gives us a good and a bad news: the good news is that, well, we can express \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> as a polynomial in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. The bad news is that the degree of this polynomial can be as high as \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>, which is huge for large problems. The idea is then to find a low-degree polynomial approximation to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> that is \u003Cem>good enough\u003C/em> for our purposes. If we can find a polynomial \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">p_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> of degree \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>â‰ª\u003C/mo>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k \\ll n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ª\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> such that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">p_k(\\mathbf{A}) \\approx f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, then we can approximate the solution as:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmunderover>\u003Cmo>âˆ‘\u003C/mo>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>0\u003C/mn>\u003C/mrow>\u003Cmi>k\u003C/mi>\u003C/munderover>\u003Cmsub>\u003Cmi>c\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msub>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\\mathbf{b} \\approx p_k(\\mathbf{A})\\mathbf{b} = \\sum_{i=0}^k c_i \\mathbf{A}^i \\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:3.1138em;vertical-align:-1.2777em;\">\u003C/span>\u003Cspan class=\"mop op-limits\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.8361em;\">\u003Cspan style=\"top:-1.8723em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003Cspan class=\"mrel mtight\">=\u003C/span>\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.05em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan>\u003Cspan class=\"mop op-symbol large-op\">âˆ‘\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-4.3em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.2777em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">c\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8747em;\">\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This polynomial only involves vectors within a specific subspace.\u003C/p>\n\u003Ch2 id=\"krylov-projection\">Krylov Projection\u003C/h2>\n\u003Cp>We can notice that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">p_k(\\mathbf{A})\\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span> only depends on vectors in the Krylov subspace of order \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"script\">K\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmtext>span\u003C/mtext>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b}) = \\text{span}\\{\\mathbf{b}, \\mathbf{Ab}, \\mathbf{A}^2\\mathbf{b}, \\ldots, \\mathbf{A}^{k-1}\\mathbf{b}\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathcal\" style=\"margin-right:0.01445em;\">K\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0144em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1491em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord text\">\u003Cspan class=\"mord\">span\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">Ab\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8641em;\">\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8991em;\">\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This is fortunate: we can compute an approximate solution by staying within this space, which only requires repeated matrix-vector products with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For large sparse matrices, thatâ€™s the only operation we can do efficiently anyway.\u003C/p>\n\u003Cblockquote>\n\u003Cp>We donâ€™t need to construct \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}^j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8247em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> explicitly. We compute iteratively: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}(\\mathbf{A}^{j-1}\\mathbf{b})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0747em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003C/blockquote>\n\u003Cp>But thereâ€™s a problem: the raw vectors \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\mathbf{A}^j\\mathbf{b}\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0747em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span> form a terrible basis. They quickly become nearly parallel, making any computation numerically unstable. We need an orthonormal basis.\u003C/p>\n\u003Ch3 id=\"building-an-orthonormal-basis\">Building an Orthonormal Basis\u003C/h3>\n\u003Cp>The standard method is the Arnoldi process, which is Gram-Schmidt applied to Krylov subspaces. We start by normalizing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">/âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Then, iteratively:\u003C/p>\n\u003Col>\n\u003Cli>Compute a new candidate: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{w}_j = \\mathbf{A}\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>Orthogonalize against all existing basis vectors:\u003C/li>\n\u003C/ol>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmunderover>\u003Cmo>âˆ‘\u003C/mo>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cmi>j\u003C/mi>\u003C/munderover>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>i\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\tilde{\\mathbf{v}}_j = \\mathbf{w}_j - \\sum_{i=1}^j (\\mathbf{v}_i^H \\mathbf{w}_j) \\mathbf{v}_i\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9674em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:3.1364em;vertical-align:-1.2777em;\">\u003C/span>\u003Cspan class=\"mop op-limits\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.8588em;\">\u003Cspan style=\"top:-1.8723em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003Cspan class=\"mrel mtight\">=\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.05em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan>\u003Cspan class=\"mop op-symbol large-op\">âˆ‘\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-4.3471em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.2777em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8913em;\">\u003Cspan style=\"top:-2.453em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.247em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Col start=\"3\">\n\u003Cli>Normalize: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_j / \\|\\tilde{\\mathbf{v}}_j\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">/âˆ¥\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003C/ol>\n\u003Cp>The coefficients \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>h\u003C/mi>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>i\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">h_{ij} = \\mathbf{v}_i^H \\mathbf{w}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">h\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">ij\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1274em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-2.4413em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2587em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> become entries of a projected matrix. After \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, we have:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>: an orthonormal basis for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"script\">K\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathcal\" style=\"margin-right:0.01445em;\">K\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0144em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{H}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>: an upper Hessenberg matrix representing the projection of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> onto this subspace\u003C/li>\n\u003C/ul>\n\u003Cp>We can express this relationship with the Arnoldi decomposition:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>+\u003C/mo>\u003Cmsub>\u003Cmi>h\u003C/mi>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmi>T\u003C/mi>\u003C/msubsup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\\mathbf{V}_k = \\mathbf{V}_k \\mathbf{H}_k + h_{k+1,k} \\mathbf{v}_{k+1} \\mathbf{e}_k^T\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1774em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">h\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003Cspan class=\"mpunct mtight\">,\u003C/span>\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2083em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8913em;\">\u003Cspan style=\"top:-2.453em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.247em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Ch3 id=\"solving-in-the-reduced-space\">Solving in the Reduced Space\u003C/h3>\n\u003Cp>Now we approximate our original problem by solving it in the small \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>-dimensional space. Using the Full Orthogonal Method (FOM), we enforce that the residual is orthogonal to\nthe Krylov subspace. This gives:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is computed as:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{H}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>The heavy lifting is now on computing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{H}_k)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, a small \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix.\nSince \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>â‰ª\u003C/mo>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k \\ll n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ª\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we can afford direct methods like Schur-Parlett (\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>).\u003C/p>\n\u003Cblockquote>\n\u003Cp>For \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> (linear systems), this reduces to solving \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{H}_k \\mathbf{y}_k = \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> with LU decomposition.\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"the-lanczos-algorithm\">The Lanczos Algorithm\u003C/h1>\n\u003Cp>When \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is Hermitian (or symmetric in the real case), the general Arnoldi\nprocess simplifies dramatically. We can prove that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{H}_k = \\mathbf{V}_k^H \\mathbf{A} \\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1244em;vertical-align:-0.2831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-2.4169em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> must also be Hermitian. A matrix that is both upper Hessenberg \u003Cem>and\u003C/em> Hermitian must be real, symmetric, and tridiagonal. This is a \u003Cem>huge\u003C/em> simplification.\u003C/p>\n\u003Cp>In the literature, this projected matrix is denoted \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> to highlight its\ntridiagonal structure:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmrow>\u003Cmo fence=\"true\">(\u003C/mo>\u003Cmtable rowspacing=\"0.16em\" columnalign=\"center center center center\" columnspacing=\"1em\">\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmo lspace=\"0em\" rspace=\"0em\">â‹±\u003C/mo>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmo lspace=\"0em\" rspace=\"0em\">â‹±\u003C/mo>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmo lspace=\"0em\" rspace=\"0em\">â‹±\u003C/mo>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003C/mtable>\u003Cmo fence=\"true\">)\u003C/mo>\u003C/mrow>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k = \\begin{pmatrix}\n\\alpha_1 &#x26; \\beta_1 &#x26; &#x26; \\\\\n\\beta_1 &#x26; \\alpha_2 &#x26; \\beta_2 &#x26; \\\\\n&#x26; \\beta_2 &#x26; \\ddots &#x26; \\ddots \\\\\n&#x26; &#x26; \\ddots &#x26; \\alpha_k\n\\end{pmatrix}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:4.8em;vertical-align:-2.15em;\">\u003C/span>\u003Cspan class=\"minner\">\u003Cspan class=\"mopen\">\u003Cspan class=\"delimsizing mult\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.65em;\">\u003Cspan class=\"pstrut\" style=\"height:6.8em;\">\u003C/span>\u003Cspan style=\"width:0.875em;height:4.800em;\">\u003Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.875em\" height=\"4.800em\" viewBox=\"0 0 875 4800\">\u003Cpath d=\"M863,9c0,-2,-2,-5,-6,-9c0,0,-17,0,-17,0c-12.7,0,-19.3,0.3,-20,1\nc-5.3,5.3,-10.3,11,-15,17c-242.7,294.7,-395.3,682,-458,1162c-21.3,163.3,-33.3,349,\n-36,557 l0,1284c0.2,6,0,26,0,60c2,159.3,10,310.7,24,454c53.3,528,210,\n949.7,470,1265c4.7,6,9.7,11.7,15,17c0.7,0.7,7,1,19,1c0,0,18,0,18,0c4,-4,6,-7,6,-9\nc0,-2.7,-3.3,-8.7,-10,-18c-135.3,-192.7,-235.5,-414.3,-300.5,-665c-65,-250.7,-102.5,\n-544.7,-112.5,-882c-2,-104,-3,-167,-3,-189\nl0,-1292c0,-162.7,5.7,-314,17,-454c20.7,-272,63.7,-513,129,-723c65.3,\n-210,155.3,-396.3,270,-559c6.7,-9.3,10,-15.3,10,-18z\">\u003C/path>\u003C/svg>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mtable\">\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"minner\">â‹±\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"minner\">â‹±\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"minner\">â‹±\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">\u003Cspan class=\"delimsizing mult\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.65em;\">\u003Cspan class=\"pstrut\" style=\"height:6.8em;\">\u003C/span>\u003Cspan style=\"width:0.875em;height:4.800em;\">\u003Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.875em\" height=\"4.800em\" viewBox=\"0 0 875 4800\">\u003Cpath d=\"M76,0c-16.7,0,-25,3,-25,9c0,2,2,6.3,6,13c21.3,28.7,42.3,60.3,\n63,95c96.7,156.7,172.8,332.5,228.5,527.5c55.7,195,92.8,416.5,111.5,664.5\nc11.3,139.3,17,290.7,17,454c0,28,1.7,43,3.3,45l0,1209\nc-3,4,-3.3,16.7,-3.3,38c0,162,-5.7,313.7,-17,455c-18.7,248,-55.8,469.3,-111.5,664\nc-55.7,194.7,-131.8,370.3,-228.5,527c-20.7,34.7,-41.7,66.3,-63,95c-2,3.3,-4,7,-6,11\nc0,7.3,5.7,11,17,11c0,0,11,0,11,0c9.3,0,14.3,-0.3,15,-1c5.3,-5.3,10.3,-11,15,-17\nc242.7,-294.7,395.3,-681.7,458,-1161c21.3,-164.7,33.3,-350.7,36,-558\nl0,-1344c-2,-159.3,-10,-310.7,-24,-454c-53.3,-528,-210,-949.7,\n-470,-1265c-4.7,-6,-9.7,-11.7,-15,-17c-0.7,-0.7,-6.7,-1,-18,-1z\">\u003C/path>\u003C/svg>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆˆ\u003C/mo>\u003Cmi mathvariant=\"double-struck\">R\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j \\in \\mathbb{R}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8252em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">âˆˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6889em;\">\u003C/span>\u003Cspan class=\"mord mathbb\">R\u003C/span>\u003C/span>\u003C/span>\u003C/span> are the diagonal elements and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆˆ\u003C/mo>\u003Cmi mathvariant=\"double-struck\">R\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j \\in \\mathbb{R}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">âˆˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6889em;\">\u003C/span>\u003Cspan class=\"mord mathbb\">R\u003C/span>\u003C/span>\u003C/span>\u003C/span> are the off-diagonals (subdiagonals from the orthogonalization).\u003C/p>\n\u003Ch2 id=\"three-term-recurrence\">Three-Term Recurrence\u003C/h2>\n\u003Cp>This tridiagonal structure leads to a beautiful simplification. To build the next basis\nvector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we donâ€™t need the entire history of vectors. We only need\nthe two previous ones. Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is Hermitian, this guarantees that\nany new vector is \u003Cem>automatically\u003C/em> orthogonal to all earlier vectors (beyond the previous two). So we can skip the full orthogonalization and use a simple three-term recurrence:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>+\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>+\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\\mathbf{v}_j = \\beta_{j-1}\\mathbf{v}_{j-1} + \\alpha_j \\mathbf{v}_j + \\beta_j \\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>Rearranging gives us an algorithm to compute \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> directly:\u003C/p>\n\u003Col>\n\u003Cli>Compute the candidate: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">w_{j+1} = \\mathbf{A}\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>Extract the diagonal coefficient: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j = \\mathbf{v}_j^H w_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.2361em;vertical-align:-0.3948em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-2.4413em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3948em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>Orthogonalize against the two previous vectors:\u003C/li>\n\u003C/ol>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\tilde{\\mathbf{v}}_{j+1} = w_{j+1} - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9674em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Col start=\"4\">\n\u003Cli>Normalize: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">/\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003C/ol>\n\u003Cp>This is known as the Lanczos algorithm. Itâ€™s more efficient than Arnoldi because each iteration only orthogonalizes against two previous vectors instead of all prior ones.\u003C/p>\n\u003Ch2 id=\"reconstructing-the-solution\">Reconstructing the Solution\u003C/h2>\n\u003Cp>After \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, we end up with the tridiagonal matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and all \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis vectors \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We can then reconstruct the approximate solution as:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is solved from the small tridiagonal matrix.\u003C/p>\n\u003Cp>There is a timing problem however: we cannot compute the coefficients \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\nuntil all \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations are complete. The full matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is only available\nat the end, so we must store every basis vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> along the way, leading to a memory cost of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nk)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>So weâ€™re left with a choice: whether we store all the basis vectors and solve the problem in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> passes, or find a way to avoid storing them. There is a middle ground.\u003C/p>\n\u003Cblockquote>\n\u003Cp>There are also techniques to compress the basis vectors, have a look \u003Ca href=\"https://arxiv.org/abs/2403.04390\">here\u003C/a>\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"two-pass-algorithm\">Two-Pass Algorithm\u003C/h1>\n\u003Cp>Hereâ€™s where we break the timing deadlock. The insight that we donâ€™t actually need to store the basis vectors if we can afford to compute them twice\u003C/p>\n\u003Cp>Think about what we have after the first pass. Weâ€™ve computed all the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> coefficients that compose the entire tridiagonal matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. These numbers are small compared to the full basis. What if we kept only these scalars, discarded all the vectors, and then replayed the Lanczos recurrence a second time? Weâ€™d regenerate the same basis, and this time weâ€™d use it to build the solution.\u003C/p>\n\u003Cp>This comes at a cost. We run Lanczos twice, so we pay for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products instead of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. But we only ever store a constant number of vectors in memory, no \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nk)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis matrix. The memory complexity drops to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>It sounds like a bad trade at first. But as weâ€™ll see later, the cache behavior of this\ntwo-pass approach can actually make it as fast (or even faster) on real hardware if well optimized.\u003C/p>\n\u003Ch2 id=\"first-pass-compute-the-projected-problem\">First Pass: Compute the Projected Problem\u003C/h2>\n\u003Cp>We initialize \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">/âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and set \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmn>0\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_0 = 0\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmn mathvariant=\"bold\">0\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_0 = \\mathbf{0}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>.Then we run the standard Lanczos recurrence:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">w_j = \\mathbf{A}\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j = \\mathbf{v}_j^H w_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.2744em;vertical-align:-0.3831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8913em;\">\u003Cspan style=\"top:-2.453em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\tilde{\\mathbf{v}}_{j+1} = w_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9674em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmspace width=\"1em\">\u003C/mspace>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2, \\quad \\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:1em;\">\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">/\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>At each step, we record \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. But we \u003Cem>do not\u003C/em> store \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\nInstead, we discard it immediately after computing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. In this way we only keep in memory at most just three vectors at any time (\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and the working vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">w_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>).\u003C/p>\n\u003Cp>After \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, we have the full set \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_1, \\beta_1, \\ldots, \\alpha_k, \\beta_k\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span>. These \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> scalars define the tridiagonal matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We can now solve:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This is the solution in the reduced space. Now that we have the coefficients we need to build \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Ch2 id=\"second-pass-reconstruct-and-accumulate\">Second Pass: Reconstruct and Accumulate\u003C/h2>\n\u003Cp>With \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> in memory, we replay the Lanczos recurrence \u003Cem>exactly as before\u003C/em>. We start with the same initialization (\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_0\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_0\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>) and apply the same sequence of operations, using the stored scalars \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> to reconstruct each basis vector on demand. We can write some rust-like \u003Cem>pseudocode\u003C/em> for this second pass to get a feel for it:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">/\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b_norm\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> A\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> @\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Matrix-vector product\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // We don't recompute alpha/beta; we already have them from pass 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> ?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Accumulate the solution\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y_k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Regenerate the next basis vector for the *next* iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_next\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">/\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Slide the window forward\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_next\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This loop regenerates each \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> on demand and immediately uses it to update the solution.\nOnce weâ€™ve accumulated \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">(\\mathbf{y}_k)_j \\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> into \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we discard the vector. We never store the full basis.\u003C/p>\n\u003Ch3 id=\"a-subtle-numerical-point\">A Subtle Numerical Point\u003C/h3>\n\u003Cp>There is one detail worth noting: floating-point arithmetic is deterministic. When we replay the Lanczos recurrence in the second pass with the exact same inputs and the exact same order of operations, we get bitwise-identical vectors. The \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> regenerated in pass 2 are identical to the ones computed in pass 1.\u003C/p>\n\u003Cp>However, the order in which we accumulate the solution differs. In a standard Lanczos,\n\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is built as a single matrix-vector product: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> (a \u003Ccode>gemv\u003C/code> call in BLAS). In the two-pass method, itâ€™s built as a loop of scaled vector additions (a series of \u003Ccode>axpy\u003C/code> calls). These operations accumulate rounding error differently, so the final solution differs slightly, typically by machine epsilon. This rarely matters in practice, and convergence is unaffected.\u003C/p>\n\u003Ch1 id=\"implementation\">Implementation\u003C/h1>\n\u003Cp>Building this in Rust forces us to think concretely about where data lives and how it flows through the cache hierarchy. We need to control memory layout, decide when allocations happen, and choose abstractions that cost us nothing at runtime.\u003C/p>\n\u003Cp>For linear algebra, we reach for \u003Ca href=\"https://github.com/sarah-ek/faer-rs\">\u003Ccode>faer\u003C/code>\u003C/a>. Three design choices in this library matter for what weâ€™re building:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>Stack allocation via \u003Ccode>MemStack\u003C/code>:\u003C/strong> Pre-allocated scratch space that lives for the entire computation. The hot path becomes allocation-free.\u003C/li>\n\u003Cli>\u003Cstrong>Matrix-free operators:\u003C/strong> The \u003Ccode>LinOp\u003C/code> trait defines an operator by its action (\u003Ccode>apply\u003C/code>) without materializing a matrix. For large sparse problems, this is the only viable approach.\u003C/li>\n\u003Cli>\u003Cstrong>SIMD-friendly loops:\u003C/strong> The \u003Ccode>zip!\u003C/code> macro generates code that compiles to packed instructions.\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"recurrence-step\">Recurrence Step\u003C/h2>\n\u003Cp>Our starting point is the Lanczos three-term recurrence that we derived earlier:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j \\mathbf{v}_{j+1} = \\mathbf{A}\\mathbf{v}_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>We can translate this into a recurrence step function. The signature looks like this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_recurrence_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The function is generic over the field type \u003Ccode>T\u003C/code> (\u003Ccode>f64\u003C/code>, \u003Ccode>c64\u003C/code>, etc.) and the operator type \u003Ccode>O\u003C/code>. It operates on matrix views (\u003Ccode>MatMut\u003C/code> and \u003Ccode>MatRef\u003C/code>) to avoid unnecessary data copies. The return type gives us the diagonal element \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and, \u003Cem>if no breakdown occurs\u003C/em>, the off-diagonal \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>Now we can implement the body by following the math. The first step is the most expensive:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 1. Apply operator: w = A * v_curr\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">apply\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Par\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Seq\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The matrix-vector product dominates the computational cost. Everything else is secondary.\u003C/p>\n\u003Cp>Next, we orthogonalize against \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This is where we benefit from \u003Ccode>faer\u003C/code>â€™s design. The \u003Ccode>zip!\u003C/code> macro fuses this operation into a single loop that the compiler vectorizes into SIMD instructions.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 2. Orthogonalize against v_{j-1}: w -= Î²_{j-1} * v_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With \u003Ccode>w\u003C/code> partially orthogonalized, we can compute the diagonal coefficient via an inner product. Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is Hermitian, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is guaranteed real.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 3. Compute Î±_j = v_j^H * w\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">real_part_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">adjoint\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())[(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We complete the orthogonalization against \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> with another \u003Ccode>zip!\u003C/code> loop.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 4. Orthogonalize against v_j: w -= Î±_j * v_j\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now \u003Ccode>w\u003C/code> holds the unnormalized next basis vector. We compute its norm to get \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. If this norm is numerically zero, the Krylov subspace is invariant, the iteration has reached its natural stopping point. This is called breakdown.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 5. Compute Î²_j = ||w||_2 and check for breakdown\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">norm_l2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> breakdown_tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The function returns \u003Ccode>None\u003C/code> for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> when breakdown occurs, signaling to the caller that no further iterations should proceed.\u003C/p>\n\u003Ch2 id=\"an-iterator-for-state-management\">An Iterator for State Management\u003C/h2>\n\u003Cp>The recurrence step is a pure function, but calling it in a loop is both inefficient and awkward. Weâ€™d need to manually pass vectors in and out of each iteration. More critically, weâ€™d create copies when we should be reusing memory.\u003C/p>\n\u003Cp>The iterator pattern solves this. We create a struct that encapsulates the state:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LanczosIteration\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v_j\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,         \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Workspace for the next vector\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Î²_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... iteration counters\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The main design choice here is that vectors are \u003Cstrong>owned\u003C/strong> (\u003Ccode>Mat&#x3C;T>\u003C/code>), not borrowed. This enables an optimization in the \u003Ccode>next_step\u003C/code> method. After computing the next vector and normalizing it into \u003Ccode>work\u003C/code>, we cycle the state without allocating or copying:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Inside next_step, after normalization...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v_prev, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v_curr);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v_curr, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">work);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On x86-64, swapping two \u003Ccode>Mat&#x3C;T>\u003C/code> structures (fat pointers) compiles to three \u003Ccode>mov\u003C/code> instructions. The pointers change, but no vector data moves. After the swap, \u003Ccode>v_prev\u003C/code> points to what \u003Ccode>v_curr\u003C/code> held, \u003Ccode>v_curr\u003C/code> points to \u003Ccode>work\u003C/code>â€™s allocation, and \u003Ccode>work\u003C/code> points to the old \u003Ccode>v_prev\u003C/code> data. In the next iteration, \u003Ccode>work\u003C/code> gets reused.\u003C/p>\n\u003Cp>We keep exactly three n-dimensional vectors live in memory. The same allocations cycle through the computation, staying hot in L1 cache. This is the core reason the two-pass method can be faster than expected, the working set never leaves cache.\u003C/p>\n\u003Ch2 id=\"first-pass-computing-the-decomposition\">First Pass: Computing the Decomposition\u003C/h2>\n\u003Cp>The first pass runs the Lanczos iteration and collects the coefficients \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_j, \\beta_j\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Basis vectors are discarded after each step.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_pass_one\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosDecomposition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosError\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We allocate vectors for the coefficients with a capacity hint to avoid reallocations:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Then we construct the iterator. This allocates the three work vectors once. After this point, the hot path is allocation-free:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lanczos_iter\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LanczosIteration\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b_norm\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> let\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lanczos_iter\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">next_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">step\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">alpha);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        steps_taken\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> breakdown_tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> step\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">beta \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">step\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">beta);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The check for breakdown stops the iteration when the residual becomes numerically zero. This means weâ€™ve found an invariant subspace and thereâ€™s no value in continuing.\u003C/p>\n\u003Cp>At the end, we collect the scalars into a \u003Ccode>LanczosDecomposition\u003C/code> struct. The memory footprint throughout this pass is constant: three n-dimensional vectors plus two small arrays that grow to at most \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> elements.\u003C/p>\n\u003Ch2 id=\"second-pass-reconstructing-the-solution\">Second Pass: Reconstructing the Solution\u003C/h2>\n\u003Cp>Now we face a different problem. We have the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_j, \\beta_j\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span> coefficients from the first pass and the coefficient vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> from solving the projected problem. We need to reconstruct the solution:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmunderover>\u003Cmo>âˆ‘\u003C/mo>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cmi>k\u003C/mi>\u003C/munderover>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\sum_{j=1}^k (\\mathbf{y}_k)_j \\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:3.2499em;vertical-align:-1.4138em;\">\u003C/span>\u003Cspan class=\"mop op-limits\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.8361em;\">\u003Cspan style=\"top:-1.8723em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mrel mtight\">=\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.05em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan>\u003Cspan class=\"mop op-symbol large-op\">âˆ‘\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-4.3em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.4138em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>without storing the full basis matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>The recurrence step in this pass is structurally similar to the first pass, but with a key difference: we no longer compute inner products or norms. We already know the coefficients, so the step becomes pure reconstruction.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_reconstruction_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Apply operator\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">apply\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Par\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Seq\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Orthogonalize using stored Î±_j and Î²_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is cheaper than the first-pass recurrence. Weâ€™ve eliminated the inner products that computed \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and the norm calculation for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. What remains is pure orthogonalization and the operator application.\u003C/p>\n\u003Cp>\u003Ccode>lanczos_pass_two\u003C/code> implements this reconstruction. We initialize the three work vectors and the solution accumulator:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_pass_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosDecomposition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    y_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosError\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">nrows\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> inv_norm\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">recip_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">b_norm));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">inv_norm\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v_1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">nrows\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Initialize solution with first component\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]));\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We build the solution incrementally by starting with the first basis vector scaled by its coefficient. The main loop then regenerates each subsequent vector: we regenerate each subsequent basis vector, normalize it using the stored \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and immediately accumulate its contribution:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">steps_taken \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">alphas[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">betas[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zero_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">betas[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 1. Regenerate the unnormalized next vector\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    lanczos_reconstruction_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 2. Normalize using stored Î²_j\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> inv_beta\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">recip_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">inv_beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 3. Accumulate: x_k += y_{j+1} * v_{j+1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> coeff\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">coeff\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 4. Cycle vectors for the next iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> work\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The accumulation \u003Ccode>x_k += y_{j+1} * v_{j+1}\u003C/code> is implemented as a fused multiply-add in the \u003Ccode>zip!\u003C/code> loop. On hardware with FMA support, this becomes a single instruction per element, not three separate operations.\u003C/p>\n\u003Cp>Note that we accumulate the solution incrementally. After each iteration, \u003Ccode>x_k\u003C/code> contains a partial result. We cycle through the same three vectors (\u003Ccode>v_prev\u003C/code>, \u003Ccode>v_curr\u003C/code>, \u003Ccode>work\u003C/code>), keeping the working set small and resident in L1 cache.\u003C/p>\n\u003Cp>Compare this to the standard methodâ€™s final reconstruction step: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This is a dense matrix-vector product where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. When \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> are both large, this matrix no longer fits in cache. The CPU must stream it from main memory, paying the cost of memory latency. Each element requires a load, multiply, and accumulate, but the load operations dominateâ€”the CPU stalls waiting for data.\u003C/p>\n\u003Cp>In our two-pass reconstruction, the operator \u003Ccode>$\\mathbf{A}$\u003C/code> is applied \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> times, but against vectors that stay in cache. The memory bandwidth is spent on reading the sparse structure of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> and the vector elements, not on scanning a dense \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix.\u003C/p>\n\u003Cp>This is the reason the two-pass method can be faster on real hardware despite performing twice as many matrix-vector products. The cache behavior of the reconstruction phase overwhelms the savings of storing the basis.\u003C/p>\n\u003Ch2 id=\"the-public-api\">The Public API\u003C/h2>\n\u003Cp>We can wrap the two passes into a single entry point:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_two_pass\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> f_tk_solver\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosError\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> FnMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">anyhow\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // First pass: compute T_k coefficients\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_pass_one\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">steps_taken \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">nrows\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Solve projected problem: y_k' = f(T_k) * e_1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y_k_prime\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f_tk_solver\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">alphas, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">betas)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Scale by ||b||\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k_prime\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">b_norm));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Second pass: reconstruct solution\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    lanczos_pass_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The design separates concerns. The \u003Ccode>f_tk_solver\u003C/code> closure is where we inject the specific matrix function. We compute the Lanczos decomposition, then pass the coefficients to the user-provided solver, which computes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">â€²\u003C/mo>\u003C/msubsup>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k' = f(\\mathbf{T}_k) \\mathbf{e}_1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.035em;vertical-align:-0.2831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.7519em;\">\u003Cspan style=\"top:-2.4169em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">â€²\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> for whatever function \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> is needed. This decoupling means we handle linear solves, matrix exponentials, or any other function without modifying the core algorithm.\u003C/p>\n\u003Cp>The caller provides \u003Ccode>f_tk_solver\u003C/code> as a closure. It receives the raw \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_j, \\beta_j\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span> arrays and must return the coefficient vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">â€²\u003C/mo>\u003C/msubsup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k'\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.035em;vertical-align:-0.2831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.7519em;\">\u003Cspan style=\"top:-2.4169em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">â€²\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We then scale it by \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and pass everything to the second pass.\u003C/p>\n\u003Ch3 id=\"example-solving-a-linear-system\">Example: Solving a Linear System\u003C/h3>\n\u003Cp>To see this in practice, consider solving \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003C/mrow>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{Ax} = \\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">Ax\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We compute \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, which means the \u003Ccode>f_tk_solver\u003C/code> must solve the small tridiagonal system \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsup>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">â€²\u003C/mo>\u003C/msup>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k \\mathbf{y}' = \\mathbf{e}_1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9463em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.7519em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">â€²\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is tridiagonal, we can exploit its structure. A sparse LU factorization solves it in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time instead of the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> cost of a dense method.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> f_tk_solver\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> ->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">anyhow\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> steps\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> steps\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 1. Assemble T_k from coefficients using triplet format\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> steps\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">enumerate\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Triplet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">row\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">col\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">enumerate\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Triplet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">row\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">col\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Triplet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">row\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">col\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> t_k_sparse\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SparseColMat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">try_new_from_triplets\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">steps\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">steps\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">triplets\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 2. Construct e_1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> e1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">steps\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    e1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()[(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 3. Solve T_k * y' = e_1 via sparse LU\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">t_k_sparse\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sp_lu\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">solve\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">e1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The closure takes the coefficient arrays, constructs the sparse tridiagonal matrix, and solves the system. The triplet format lets us build the matrix efficiently without knowing its structure in advance. The sparse LU solver leverages the tridiagonal structure to avoid dense factorization.\u003C/p>\n\u003Ch1 id=\"some-interesting-results\">Some interesting results\u003C/h1>\n\u003Cp>Now that we have a working implementation we can run some tests. The core idea of what we have done is simple: trade flops for better memory access. But does this trade actually pay off on real hardware? To find out, we need a reliable way to benchmark it.\u003C/p>\n\u003Cp>For the data, we know that the performance of any Krylov method is tied to the operatorâ€™s spectral properties. We need a way to generate a family of test problems where we can precisely control the size, sparsity, and numerical difficulty. A great way to do this is with Karush-Kuhn-Tucker (KKT) systems, which are sparse, symmetric, and have a specific block structure.\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi>A\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmrow>\u003Cmo fence=\"true\">(\u003C/mo>\u003Cmtable rowspacing=\"0.16em\" columnalign=\"center center\" columnspacing=\"1em\">\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmi>D\u003C/mi>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsup>\u003Cmi>E\u003C/mi>\u003Cmi>T\u003C/mi>\u003C/msup>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmi>E\u003C/mi>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmn>0\u003C/mn>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003C/mtable>\u003Cmo fence=\"true\">)\u003C/mo>\u003C/mrow>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">A =\n\\begin{pmatrix}\n    D &#x26; E^T \\\\\n    E &#x26; 0\n\\end{pmatrix}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">A\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:2.4013em;vertical-align:-0.9507em;\">\u003C/span>\u003Cspan class=\"minner\">\u003Cspan class=\"mopen delimcenter\" style=\"top:0em;\">\u003Cspan class=\"delimsizing size3\">(\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mtable\">\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.4507em;\">\u003Cspan style=\"top:-3.6093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.4093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.9507em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.4507em;\">\u003Cspan style=\"top:-3.6093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.4093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.9507em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose delimcenter\" style=\"top:0em;\">\u003Cspan class=\"delimsizing size3\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This structure gives us two critical knobs to turn. First, with the \u003Ca href=\"https://commalab.di.unipi.it/files/Data/MCF/netgen.tgz\">netgen\u003C/a> utility, we can control the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>E\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">E\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix, which lets us dial in the problem dimension, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Second, we build the diagonal block D with random entries from a range \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">[1, C_D]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This parameter, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, gives us direct control over the numerical difficulty of the problem.\u003C/p>\n\u003Cp>For a symmetric matrix like \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>D\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the 2-norm condition number, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Îº\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\kappa_2(D)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Îº\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, is the ratio of its largest to its smallest eigenvalue: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Îº\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>max\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>min\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\kappa_2(D) = \\lambda_{\\max}(D) / \\lambda_{\\min}(D)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Îº\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">a\u003C/span>\u003Cspan class=\"mtight\">x\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">/\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3175em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">i\u003C/span>\u003Cspan class=\"mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>D\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span> is diagonal, its eigenvalues are simply its diagonal entries. We are drawing these entries from a uniform distribution \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>U\u003C/mi>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">U[1, C_D]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>, so we have \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>max\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\lambda_{\\max}(D) \\approx C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">a\u003C/span>\u003Cspan class=\"mtight\">x\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>min\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\lambda_{\\min}(D) \\approx 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3175em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">i\u003C/span>\u003Cspan class=\"mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This means we get direct control, as \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Îº\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\kappa_2(D) \\approx C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Îº\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.The spectral properties of this block heavily influence the spectrum of the entire matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">A\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. A large condition number in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>D\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span> leads to a more ill-conditioned system for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">A\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. The convergence rate of Krylov methods like Lanczos is fundamentally governed by the distribution of the operatorâ€™s eigenvalues. An ill-conditioned matrix, with a wide spread of eigenvalues, will require more iterations, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>, to reach the desired accuracy. By simply adjusting the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> parameter, we can generate everything from well-conditioned problems that converge quickly to ill-conditioned ones that force us to run a large number of iterations. This is exactly what we need to rigorously test our implementation.\u003C/p>\n\u003Ch2 id=\"memory-and-computation-trade-off\">Memory and Computation Trade-off\u003C/h2>\n\u003Cp>We measure the algorithm against two hypotheses on a large sparse problem with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>500\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=500,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">500\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>, varying the number of iterations \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>\u003Cstrong>Hypothesis 1 (Memory):\u003C/strong> The one-pass method stores the full basis \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> with complexity \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nk)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We expect its memory to grow linearly with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. The two-pass method operates with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> memory, so it should have a flat profile.\u003C/p>\n\u003Cp>\u003Cstrong>Hypothesis 2 (Runtime):\u003C/strong> The two-pass method performs \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products instead of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. If all else were equal, weâ€™d expect it to run twice as slow.\u003C/p>\n\u003Ch3 id=\"memory-usage\">Memory Usage\u003C/h3>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/tradeoff_arcs500k_rho3_memory.png\" alt=\"Memory vs Iterations\">\u003C/p>\n\u003Cp>The memory data confirms Hypothesis 1 exactly. The one-pass methodâ€™s footprint scales as a straight lineâ€”each additional iteration adds one vector to the basis. The two-pass method remains flat. No allocation growth happens after initialization.\u003C/p>\n\u003Ch3 id=\"runtime-where-theory-breaks\">Runtime: Where Theory Breaks\u003C/h3>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/tradeoff_arcs500k_rho3_time.png\" alt=\"Runtime vs Iterations\">\u003C/p>\n\u003Cp>The runtime data contradicts Hypothesis 2. The two-pass method is slower, but never by a factor of two. For small \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the gap is minimal. As \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> grows, the two-pass runtime diverges slowly from the one-pass method, not by doubling, but by a much smaller margin.\u003C/p>\n\u003Cp>This difference comes from memory access patterns. Both methods perform matrix-vector products, but they differ in how they reconstruct the solution.\u003C/p>\n\u003Cp>The one-pass method computes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> in a single dense matrix-vector product. When \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> are large, the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis matrix exceeds all cache levels. The CPU cannot keep the data resident; instead, it streams \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> from main memory. This is a memory-bandwidth-bound operation. The processor stalls, waiting for each load to complete. Instruction-level parallelism collapses.\u003C/p>\n\u003Cp>The two-pass method reconstructs the solution incrementally. At each iteration, it operates on exactly three n-dimensional vectors: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmtext>prev\u003C/mtext>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{\\text{prev}}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord text mtight\">\u003Cspan class=\"mord mtight\">prev\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmtext>curr\u003C/mtext>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{\\text{curr}}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord text mtight\">\u003Cspan class=\"mord mtight\">curr\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This working set fits in L1 cache. The processor performs \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products (each one reading the sparse operator, then applying it to a cached vector), but the solution accumulation happens entirely within cache. The additional matrix-vector products are cheaper than the memory latency of the standard method.\u003C/p>\n\u003Cp>The cost of re-computing basis vectors is less than the latency cost of scanning an \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> dense matrix from main memory.\u003C/p>\n\u003Ch3 id=\"medium-scale-behavior\">Medium-Scale Behavior\u003C/h3>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/tradeoff_arcs50k_rho3_time.png\" alt=\"Medium Scale Runtime vs Iterations\">\n\u003Cimg src=\"/assets/lanczos/tradeoff_arcs50k_rho3_memory.png\" alt=\"Medium Scale Memory Usage vs Iterations\">\u003C/p>\n\u003Cp>At \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>50\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=50,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">50\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span> we can observe an equilibrium. The two methods have nearly identical runtime. The standard methodâ€™s \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix is smaller; it fits partially in cache. The cache-miss penalty here becomes manageable. The two-pass method still has the advantage of cache-local accumulation, but the difference is marginal.\u003C/p>\n\u003Ch3 id=\"what-about-dense-matrices\">What About Dense Matrices?\u003C/h3>\n\u003Cp>To be sure of our hypothesis, we can test it directly using a dense matrix of size \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>10\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=10,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">10\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For dense problems, the matrix-vector product is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>n\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n^2)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, it dominates all other costs. Memory latency will become negligible relative to the compute work and the cache efficiency advantage should disappear.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/dense-tradeoff.png\" alt=\"Dense Matrix Runtime vs Iterations\">\u003C/p>\n\u003Cp>We can see that the two-pass method runs almost exactly twice as slow as the one-pass method. The slope ratio is \u003Cem>exactly\u003C/em> 2:1. In a compute-bound regime, the extra matrix-vector products cannot be hidden by cache effects. Here, the theoretical trade-off holds perfectly.\u003C/p>\n\u003Ch2 id=\"scalability\">Scalability\u003C/h2>\n\u003Cp>Now, letâ€™s fix the iteration count at \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>500\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k=500\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">500\u003C/span>\u003C/span>\u003C/span>\u003C/span> and vary \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> from \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>50\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">50,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">50\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span> to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>500\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">500,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">500\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span> to measure scalability. Based on what we have seen before, we would expect the two-pass memory to scale linearly with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> but with a small constant factor (three vectors, plus scalars). The one-pass method should also scale linearly, but with a \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>-dependent slope.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/scalability_k500_rho3_memory.png\" alt=\"Scalability Memory Usage\">\u003C/p>\n\u003Cp>Here we have to use a logarithmic y-axis to show both curves; the two-pass line is so flat relative to the one-pass line that itâ€™s otherwise invisible.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/scalability_k500_rho3_time.png\" alt=\"Scalability Runtime\">\u003C/p>\n\u003Cp>Runtime scales linearly with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> for both methods, as expected. Below \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>150\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=150,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">150\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the two methods have similar performance. This is the regime where both basis and working set fit in cache, or where the problem is small enough that memory latency is not the bottleneck.\u003C/p>\n\u003Cp>As \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> increases beyond \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>150\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">150,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">150\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the matrix-vector product time dominates. The sparse structure of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> ensures that each matvec requires multiple memory accesses per element. For the one-pass method, the final reconstruction of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> begins to cost more as the matrix grows. For the two-pass method, performing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products means the matvec cost accumulates more rapidly. The divergence is gradual, not sharp, because the advantage of cache locality in accumulation persistsâ€”but it cannot overcome the fundamental cost of doubling the number of expensive operations.\u003C/p>\n\u003Chr>\n\u003Cp>Well, thatâ€™s it. If you want to have a better look at the code or use it, itâ€™s all open source:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos\">Github Repository\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf\">LaTeX Report\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>This was more of an exploration than a production-ready library, so expect rough edges. But I hope it gives an interesting perspective on how algorithm engineering and low-level implementation details can alter what seems like a straightforward trade-off on a blackboard.\u003C/p>",{"headings":208,"localImagePaths":288,"remoteImagePaths":289,"frontmatter":290,"imagePaths":293},[209,212,216,219,222,225,228,231,234,237,240,243,246,249,252,255,258,261,264,267,270,273,276,279,282,285],{"depth":32,"slug":210,"text":211},"table-of-contents","Table of Contents",{"depth":213,"slug":214,"text":215},1,"computing-matrix-functions","Computing Matrix Functions",{"depth":32,"slug":217,"text":218},"krylov-projection","Krylov Projection",{"depth":131,"slug":220,"text":221},"building-an-orthonormal-basis","Building an Orthonormal Basis",{"depth":131,"slug":223,"text":224},"solving-in-the-reduced-space","Solving in the Reduced Space",{"depth":213,"slug":226,"text":227},"the-lanczos-algorithm","The Lanczos Algorithm",{"depth":32,"slug":229,"text":230},"three-term-recurrence","Three-Term Recurrence",{"depth":32,"slug":232,"text":233},"reconstructing-the-solution","Reconstructing the Solution",{"depth":213,"slug":235,"text":236},"two-pass-algorithm","Two-Pass Algorithm",{"depth":32,"slug":238,"text":239},"first-pass-compute-the-projected-problem","First Pass: Compute the Projected Problem",{"depth":32,"slug":241,"text":242},"second-pass-reconstruct-and-accumulate","Second Pass: Reconstruct and Accumulate",{"depth":131,"slug":244,"text":245},"a-subtle-numerical-point","A Subtle Numerical Point",{"depth":213,"slug":247,"text":248},"implementation","Implementation",{"depth":32,"slug":250,"text":251},"recurrence-step","Recurrence Step",{"depth":32,"slug":253,"text":254},"an-iterator-for-state-management","An Iterator for State Management",{"depth":32,"slug":256,"text":257},"first-pass-computing-the-decomposition","First Pass: Computing the Decomposition",{"depth":32,"slug":259,"text":260},"second-pass-reconstructing-the-solution","Second Pass: Reconstructing the Solution",{"depth":32,"slug":262,"text":263},"the-public-api","The Public API",{"depth":131,"slug":265,"text":266},"example-solving-a-linear-system","Example: Solving a Linear System",{"depth":213,"slug":268,"text":269},"some-interesting-results","Some interesting results",{"depth":32,"slug":271,"text":272},"memory-and-computation-trade-off","Memory and Computation Trade-off",{"depth":131,"slug":274,"text":275},"memory-usage","Memory Usage",{"depth":131,"slug":277,"text":278},"runtime-where-theory-breaks","Runtime: Where Theory Breaks",{"depth":131,"slug":280,"text":281},"medium-scale-behavior","Medium-Scale Behavior",{"depth":131,"slug":283,"text":284},"what-about-dense-matrices","What About Dense Matrices?",{"depth":32,"slug":286,"text":287},"scalability","Scalability",[],[],{"author":14,"pubDatetime":291,"title":197,"slug":193,"featured":198,"draft":17,"tags":292,"description":201},["Date","2025-11-11T00:00:00.000Z"],[200,69],[],"thread-safe-fixedvec",{"id":294,"data":296,"body":302,"filePath":303,"digest":304,"rendered":305},{"author":14,"pubDatetime":297,"title":298,"featured":198,"draft":198,"tags":299,"description":301},["Date","2025-09-16T00:00:00.000Z"],"Building a Thread-Safe, Bit-Packed Atomic Vector in Rust",[200,300],"Succinct Data Structures","Engineering a thread-safe, bit-packed integer vector in Rust, using a hybrid model of lock-free and lock-based concurrency to handle operations that span hardware word boundaries.","This is the second post of a series on how to build a memory-efficient vector in Rust. All this work is open source and is currently being used for research projects in succinct data structures.\n\n* All the code can be found on github: [compressed-intvec](https://github.com/lukefleed/compressed-intvec)\n* This is also published as a crate on crates.io: [compressed-intvec](https://crates.io/crates/compressed-intvec)\n\n## Table of Contents\n\nIn the [first post]([link-to-part-1](https://lukefleed.xyz/posts/compressed-fixedvec/)), we built `FixedVec`, a bit-packed integer vector that gives us O(1) random access while using a fraction of the memory of a standard `Vec\u003CT>`. We worked through the core problem of reading bit-packed data, and saw how a single unaligned memory read could let us efficiently handle values that span across 64-bit word boundaries. We ended up with a solid, fast data structure complete with a clean, ergonomic API.\n\nSo, we have a great single-threaded vector. But what happens when we need to share it between threads? The natural next step is to build an `AtomicFixedVec` with an API that feels like Rust's standard atomics: `load`, `store`, `fetch_add`, and so on.\n\nAs soon as we try, we hit a wall. The atomic instructions our CPUs give us work on nicely aligned, word-sized chunks of memory. But our data doesn't live like that. A 10-bit integer in our vector is just a virtual concept, a sequence of bits that might start in the middle of one `u64` and end in another.\n\nThis leads to the fundamental problem: how can we possibly implement an atomic `fetch_add` on a value that's physically split across two different `AtomicU64`s? There's no single hardware instruction that can atomically modify two memory locations at once. A naive attempt would create torn writes and all sorts of nasty data races.\n\nIn this post, we're going to walk through the engineering behind `AtomicFixedVec` and solve this problem. The solution is a hybrid model that combines lock-free, high-performance CAS loops for the common case with a fine-grained locking mechanism to correctly and safely handle the values that span word boundaries.\n\n# Structure\n\nTo make `FixedVec` support concurrency, we have to make some changes in its internal design. The first step is to change the backing storage. A `Vec\u003CT>` is not thread-safe for concurrent writes. We can replace it with a `Vec\u003CAtomicU64>`. This ensures that every individual read and write to a 64-bit word is, at a minimum, atomic.\n\nHowever, as we've established, a logical element can span two of these atomic words. A simple `Vec\u003CAtomicU64>` does not solve the problem of atomically updating a value that crosses a word boundary. To handle this, we can add a second component to our struct: a striped lock pool. This is a vector of `parking_lot::Mutex` instances, where the number of locks is a power of two. Each lock protects a subset of the `AtomicU64` words in our storage. When an operation needs to modify two adjacent words, it will acquire the appropriate locks to ensure exclusive access.\n\nWe can then define the `AtomicFixedVec` struct as follows:\n\n```rust\npub struct AtomicFixedVec\u003CT>\nwhere\n    T: Storable\u003Cu64>,\n{\n    // The backing store is now composed of atomic words.\n    storage: Vec\u003CAtomicU64>,\n    // A pool of fine-grained locks to protect spanning-word operations.\n    locks: Vec\u003CMutex\u003C()>>,\n    bit_width: usize,\n    mask: u64,\n    len: usize,\n}\n```\n\n This lock pool is the mechanism we will use to enforce atomicity for operations that must modify two adjacent words simultaneously.\n\nWith this structure in place, we can now design a hybrid concurrency model. Every operation must first determine if the target element is fully contained within a single `AtomicU64` or if it spans two. Based on this, it will dispatch to one of two paths: a high-performance, lock-free path for in-word elements, or a lock-based path that uses our striped lock pool for spanning elements.\n\n## Lock-Free path for In-Word Elements\n\nThe high-throughput path in our hybrid model is for elements that are fully contained within a single `AtomicU64`. This condition, `bit_offset + bit_width \u003C= 64`, is always met if the `bit_width` is a power of two (e.g., 2, 4, 8, 16, 32), making `BitWidth::PowerOfTwo` an explicit performance choice for write-heavy concurrent workloads. When this condition holds, we can perform a true lock-free atomic update using a **Compare-and-Swap (CAS) loop**.\n\nA CAS operation is an atomic instruction provided by the hardware (e.g., `CMPXCHG` on x86-64) that attempts to write a new value to a memory location only if the current value at that location matches a given expected value. This provides the primitive for building more complex atomic operations without locks.\n\nLet's try to implement an atomic `store` on a sub-word element. We cannot simply write the new value, as that would non-atomically overwrite adjacent elements in the same word. The operation must be a read-modify-write on the entire `AtomicU64`, where the \"modify\" step only alters the bits corresponding to our target element.\n\nWe begin by calculating the `word_index` and `bit_offset`.\n\n```rust\nlet bit_pos = index * self.bit_width;\nlet word_index = bit_pos / u64::BITS as usize;\nlet bit_offset = bit_pos % u64::BITS as usize;\n```\n\nWe then prepare a `store_mask` to isolate the target bit range and a `store_value` with the new value already shifted into position.\n\n```rust\nlet store_mask = self.mask \u003C\u003C bit_offset;\nlet store_value = value \u003C\u003C bit_offset;\n```\n\nThe core of the operation is the loop. We first perform a relaxed load to get the current state of the entire 64-bit word. Inside the loop, we compute `new_word` by using the mask to clear the target bits in our local copy (`old_word`) and then OR in the new value.\n\n```rust\nlet atomic_word_ref = &self.storage[word_index];\nlet mut old_word = atomic_word_ref.load(Ordering::Relaxed);\nloop {\n    let new_word = (old_word & !store_mask) | store_value;\n    match atomic_word_ref.compare_exchange_weak(\n        old_word,\n        new_word,\n        order,\n        Ordering::Relaxed,\n    ) {\n        Ok(_) => break,\n        Err(x) => old_word = x,\n    }\n}\n```\n\nThe critical instruction is `compare_exchange_weak`. It attempts to atomically replace the value at `atomic_word_ref` with `new_word`, but only if its current value is still equal to `old_word`. If another thread has modified the word in the meantime, the operation fails, returns the now-current value, and our loop continues with the updated `old_word`. We use the `weak` variant because it can be more performant on some architectures and is perfectly suitable within a retry loop. Putting everything together, we obtain the following `atomic_store` implementation for the lock-free path:\n\n```rust\nfn atomic_store(&self, index: usize, value: u64, order: Ordering) {\n    let bit_pos = index * self.bit_width;\n    let word_index = bit_pos / u64::BITS as usize;\n    let bit_offset = bit_pos % u64::BITS as usize;\n\n    // Lock-free path for single-word values.\n    let atomic_word_ref = &self.storage[word_index];\n    let store_mask = self.mask \u003C\u003C bit_offset;\n    let store_value = value \u003C\u003C bit_offset;\n    let mut old_word = atomic_word_ref.load(Ordering::Relaxed);\n    loop {\n        let new_word = (old_word & !store_mask) | store_value;\n        match atomic_word_ref.compare_exchange_weak(\n            old_word,\n            new_word,\n            order,\n            Ordering::Relaxed,\n        ) {\n            Ok(_) => break,\n            Err(x) => old_word = x,\n        }\n    }\n```\n\nThis entire path is lock-free. Contention is managed at the hardware level by the CPU's cache coherency protocol, which ensures that only one core can successfully commit a CAS operation to a given cache line at a time.\n\nIn the same way, we can implement other atomic operations like `atomic_rmw` (for `fetch_add`, `fetch_sub`, etc.) and `atomic_load` using similar CAS loops or direct atomic loads.\n\n## Lock-Based Path for Spanning Elements\n\nNow let's move to the more complex case when an element spans two `AtomicU64` words. Here the lock-free CAS loop is no longer enough. An atomic update would require to modify two separate `AtomicU64` words, and no single hardware instruction can do this as one indivisible transaction. To ensure atomicity, we must use a lock.\n\nA single, global `Mutex` would serialize all concurrent writes, becoming an unacceptable performance bottleneck.  We can instead employ **lock striping**, a concurrency pattern that partitions the data structure to reduce the scope of contention. The core idea is to maintain an array of locks, and map different regions of our data to different locks. We can add to our `AtomicFixedVec` a `Vec\u003Cparking_lot::Mutex\u003C()>>`. To perform an operation on a spanning element that touches `word_index` and `word_index + 1`, a thread first acquires a specific lock from this pool. The mapping is done by hashing the word index to a lock index. Since the number of locks is a power of two, we can use a fast bitwise AND for this mapping instead of a slower modulo operation: `let lock_index = word_index & (self.locks.len() - 1)`.\n\nIn this way we are partitioning the vector into a set of independent regions. A locked write to words `(i, i+1)` will not block a simultaneous locked write to words `(j, j+1)` or a lock-free write to word `k`, provided they map to different locks in the stripe. We now need a heuristic to determine, at construction time, how many locks to create. Ideally we would like to balance contention reduction against memory overhead. This could be a valuable option:\n\n```rust\n// Heuristic to determine the number of locks for striping.\nlet num_cores = std::thread::available_parallelism().map_or(MIN_LOCKS, |n| n.get());\nlet target_locks = (num_words / WORDS_PER_LOCK).max(1);\nlet num_locks = (target_locks.max(num_cores) * 2)\n    .next_power_of_two()\n    .min(MAX_LOCKS);\n```\n\nThe logic aims to create enough locks to service the available hardware threads (`num_cores`) and to cover the data with a reasonable density (one lock per 64 words, `WORDS_PER_LOCK`). We take the maximum of these two, multiply by two as a simple overprovisioning factor, and round up to the next power of two to enable fast mapping via bitwise AND. The total number of locks is capped to prevent excessive memory consumption for the lock vector itself.\n\n> **In this the best way?** I don't know, probably not. For instance, a *seqlock* could theoretically offer higher performance for read-heavy workloads. A writer would increment a version counter, perform the non-atomic two-word write, and increment it again. Readers would check for a consistent version number to validate that their read was not interrupted. However, this pattern is fundamentally incompatible with Rust's safety guarantees. A reader in a seqlock might observe a \"torn read\" (a state where one word has been updated but the other has not). This constitutes a data race, which safe Rust's memory model is designed to prevent. A correct seqlock implementation requires a ton of `unsafe` code, volatile reads, and careful memory fencing. Given this constrains (and that I am not an expert in lock-free programming), we can stick to the simpler yet performant implementation bases on `Mutex`. At least, power of two `bit_width` values can avoid the spanning case entirely.\n\nWith the lock striping mechanism cleared, we can now complete the implementation for our `atomic_store` method. The first step is to acquire the correct lock.\n\n```rust\nlet lock_index = word_index & (self.locks.len() - 1);\nlet _guard = self.locks[lock_index].lock();\n```\n\nOnce the lock is acquired, we have exclusive access for this two-word transaction. However, it's critical that we continue to use atomic operations to modify the words themselves. This is because another thread might be concurrently executing a *lock-free* operation on an adjacent, non-spanning element that happens to reside in `word_index` or `word_index + 1`. Using non-atomic writes inside the lock would create a data race with those lock-free operations.\n\nWe therefore use `fetch_update`, another CAS-based atomic, to modify each of the two words. For the lower word, we clear the high bits starting from our `bit_offset` and OR in the low bits of our new value.\n\n```rust\nlet low_word_ref = &self.storage[word_index];\nlet high_word_ref = &self.storage[word_index + 1];\n\n// Modify the lower word.\nlow_word_ref\n    .fetch_update(order, Ordering::Relaxed, |mut w| {\n        w &= !(u64::MAX \u003C\u003C bit_offset);\n        w |= value \u003C\u003C bit_offset;\n        Some(w)\n    })\n    .unwrap(); // This unwrap is safe: with the lock held, there is no contention.\n```\n\nNext, we do the same for the higher word, calculating a `high_mask` to clear the low bits and writing the remaining high bits of our value.\n\n```rust\nlet bits_in_high = (bit_offset + self.bit_width) - u64::BITS as usize;\nlet high_mask = (1u64 \u003C\u003C bits_in_high).wrapping_sub(1);\nhigh_word_ref\n    .fetch_update(order, Ordering::Relaxed, |mut w| {\n        w &= !high_mask;\n        w |= value >> (u64::BITS as usize - bit_offset);\n        Some(w)\n    })\n    .unwrap(); // Also safe.\n```\n\nThe lock provides the mutual exclusion that makes the two-word update appear atomic as a whole. The continued use of atomics with the user-specified `Ordering` ensures that the final result is correctly propagated through the memory system and becomes visible to other threads according to the Rust memory model.\n\nPutting it all together, the final, complete `atomic_store` method handles both the lock-free and locked paths.\n\n```rust\nfn atomic_store(&self, index: usize, value: u64, order: Ordering) {\n    let bit_pos = index * self.bit_width;\n    let word_index = bit_pos / u64::BITS as usize;\n    let bit_offset = bit_pos % u64::BITS as usize;\n\n    if bit_offset + self.bit_width \u003C= u64::BITS as usize {\n        // Lock-free path for single-word values.\n        let atomic_word_ref = &self.storage[word_index];\n        let store_mask = self.mask \u003C\u003C bit_offset;\n        let store_value = value \u003C\u003C bit_offset;\n        let mut old_word = atomic_word_ref.load(Ordering::Relaxed);\n        loop {\n            let new_word = (old_word & !store_mask) | store_value;\n            match atomic_word_ref.compare_exchange_weak(\n                old_word,\n                new_word,\n                order,\n                Ordering::Relaxed,\n            ) {\n                Ok(_) => break,\n                Err(x) => old_word = x,\n            }\n        }\n    } else {\n        // Locked path for values spanning two words.\n        let lock_index = word_index & (self.locks.len() - 1);\n        let _guard = self.locks[lock_index].lock();\n        // The lock guarantees exclusive access to this multi-word operation.\n        // We still use atomic operations inside to prevent races with the\n        // lock-free path, which might be concurrently accessing one of\n        // these words.\n        let low_word_ref = &self.storage[word_index];\n        let high_word_ref = &self.storage[word_index + 1];\n\n        // Modify the lower word.\n        low_word_ref\n            .fetch_update(order, Ordering::Relaxed, |mut w| {\n                w &= !(u64::MAX \u003C\u003C bit_offset);\n                w |= value \u003C\u003C bit_offset;\n                Some(w)\n            })\n            .unwrap(); // Should not fail under lock.\n\n        // Modify the higher word.\n        let bits_in_high = (bit_offset + self.bit_width) - u64::BITS as usize;\n        let high_mask = (1u64 \u003C\u003C bits_in_high).wrapping_sub(1);\n        high_word_ref\n            .fetch_update(order, Ordering::Relaxed, |mut w| {\n                w &= !high_mask;\n                w |= value >> (u64::BITS as usize - bit_offset);\n                Some(w)\n            })\n            .unwrap(); // Should not fail under lock.\n    }\n}\n```\n\nThe branching logic `if bit_offset + self.bit_width \u003C= 64` is a simple, constant-time check that determines which path to take. The condition is highly predictable for the CPU's branch predictor, as the `bit_offset` follows a simple arithmetic progression based on the index. This minimizes pipeline stalls. More importantly, this structure enables significant compiler optimization. When we use `AtomicFixedVec` with a `bit_width` that is a power of two, the branch condition can often be resolved at compile time. With Link-Time Optimization (LTO), the compiler can prove that the `else` branch for the locked path is unreachable. This allows for dead code elimination, producing a specialized function containing *only* the lock-free CAS loop.\n\n# Benchmarking the `store` operation\n\nWe now want to measure the performance of our `atomic_store` implementation under concurred load. We want to know how the throughput of the `store` operation scales as we increase thread count and contention. We can create two benchmark scenarios, one with a bit-width that is a power of two, and one with a non-power-of-two bit-width. Both simulate \"diffuse contention\": a pool of threads performs a high volume of atomic `store` operations to random indices within a shared vector of 10k 64-bit elements. Each thread is assigned 100k operations. This randomness ensures that while direct contention on the same element is rare, there will be frequent collisions on the same `AtomicU64` words, especially as thread count increases.\n\nIn the benchmark, each thread with `thread_id` simply writes its own ID to the vector for each operation:\n\n```rust\nvec[index].store(thread_id, Ordering::SeqCst);\n```\n\nWe compare our `AtomicFixedVec` against two other implementations:\n1.  A `Vec\u003CAtomicU16>`: This serves as our \"ideal\" baseline.\n2.  [`sux::AtomicBitFieldVec`]: A similar implementation of another library. This comparison however is not perfectly equivalent for bit-widths that are not powers of two. As per their documentation, `sux` does not guarantee atomicity for values that span word boundaries, which can lead to \"torn writes.\" Our `AtomicFixedVec` is designed to prevent this class of data race through its lock striping mechanism. The performance cost of this correctness guarantee is precisely what we aim to measure.\n\nThe first benchmark measure the performance of our **lock-free path**. We configure all vectors with a `bit_width` of 16. Because 16 is a power of two and evenly divides the 64-bit word size, every element is guaranteed to be fully contained within a single `u64` word. This is the best-case scenario for bit-packed atomics. It ensures that all `store` operations can be performed with lock-free CAS loops.\n\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_lock_free_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nAs we can see, all three implementations scale well with increasing thread count. The throughput of `AtomicFixedVec` is very close to that of `sux::AtomicBitFieldVec`, which is expected since both are using similar lock-free CAS loops for this scenario. Both bit-packed vectors have a noticeable dip at two threads, likely due to initial cache coherency overhead, but then scale up effectively with the core count.\n\nThe second benchmark tries to stress the **locked path**. We configure the vectors with a `bit_width` of 15. This non-power-of-two width guarantees that a predictable fraction of writes will cross word boundaries. In our case, `(15 + 63) % 64` spanning cases out of 64 offsets, so roughly `14/64` or ~22% will require locking. This forces our `AtomicFixedVec` to use its lock striping mechanism for those spanning writes. In contrast, `sux` will proceed without locking, risking data races but avoiding locking overhead.\n\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_locked_path_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nThis benchmark shows the real cost of correctness. Our `AtomicFixedVec` now shows lower throughput and poorer scaling compared to both the baseline and `sux`. Every write operation that crosses a word boundary (approximately 22% of them in this test) must acquire a lock, execute its two atomic updates, and release the lock. While with lock striping we prevent a single point of serialization, the overhead of the locking protocol itself, especially under contention from multiple threads, is non-trivial. In contrast, `sux` maintains higher throughput by avoiding locks entirely, but at the cost of potentially observing torn writes.\n\n[`sux::AtomicBitFieldVec`]: https://docs.rs/sux/latest/sux/bits/bit_field_vec/struct.AtomicBitFieldVec.html\n\n# Read-Modify-Write Operations\n\nWith the hybrid atomicity model defined, the next step is to build a robust API. Instead of re-implementing the complex hybrid logic for every atomic operation, we can implement it once in a single, powerful primitive: `compare_exchange`. All other Read-Modify-Write (RMW) operations can then be built on top of this primitive.\n\n`compare_exchange` attempts to store a `new` value into a location if and only if the value currently at that location matches an expected `current` value. This operation is the fundamental building block for lock-free algorithms.\n\n## The Lock-Free Path: A CAS Loop on a Sub-Word\n\nFor elements that are fully contained within a single `AtomicU64`, we can implement `compare_exchange` with a CAS loop. However, the logic is more complex than a simple store. We aren't comparing the entire 64-bit word; we are comparing a specific `bit_width` slice within it.\n\nThe process is as follows. First, we load the entire 64-bit word. Then, we extract the specific bits that correspond to our logical element and compare them against the user-provided `current` value.\n\n```rust\n// Inside the lock-free path of atomic_compare_exchange\nlet mut old_word = atomic_word_ref.load(failure);\nloop {\n    let old_val_extracted = (old_word >> bit_offset) & self.mask;\n    if old_val_extracted != current {\n        return Err(old_val_extracted);\n    }\n    // ...\n```\n\nIf this check fails, it means another thread has modified the element since our initial load. We can immediately return an `Err` with the value we just read, satisfying the contract of `compare_exchange`.\n\nIf the check succeeds, we proceed to the atomic write phase. We prepare a `new_word` by masking and ORing in the `new` value, just as we did for `atomic_store`. Then we attempt the hardware-level `compare_exchange_weak`.\n\n```rust\n// ... continuing the loop ...\nlet new_word = (old_word & !store_mask) | new_value_shifted;\nmatch atomic_word_ref.compare_exchange_weak(old_word, new_word, success, failure) {\n    Ok(_) => return Ok(current),\n    Err(x) => old_word = x,\n}\n```\n\nIf the `compare_exchange_weak` succeeds, it means no other thread modified the 64-bit word between our initial `load` and this instruction. Our update is successful. If it fails, another thread (possibly operating on an *adjacent* element in the same word) has modified the word. We update our local `old_word` with the new value from memory and retry the entire loop.\n\n## The Locked Path\n\nFor elements that span two words, we need to use the lock striping mechanism to ensure the operation is transactional. First, we must acquire the appropriate lock, giving us exclusive access to the two-word region.\n\nOnce the lock is held, the logic is straightforward:\n\n1.  **Read:** We perform an atomic read of the spanning value. This is itself a locked operation to ensure we get a consistent view.\n2.  **Compare:** We compare this value against the user-provided `current`. If they don't match, we release the lock and immediately return `Err`.\n3.  **Write:** If they do match, we call our existing `atomic_store` method to write the `new` value. `atomic_store` will re-acquire the same lock to perform its two-word write.\n4.  **Return:** We release the lock and return `Ok`.\n\nBecause the entire read-compare-write sequence is protected by the same mutex, we guarantee that no other thread can interfere. Combining these two paths gives us the complete `atomic_compare_exchange` method, which can then be used to implement all other atomic operations in terms of it.\n\n```rust\nfn atomic_compare_exchange(\n    &self,\n    index: usize,\n    current: u64,\n    new: u64,\n    success: Ordering,\n    failure: Ordering,\n) -> Result\u003Cu64, u64> {\n    let bit_pos = index * self.bit_width;\n    let word_index = bit_pos / u64::BITS as usize;\n    let bit_offset = bit_pos % u64::BITS as usize;\n\n    if bit_offset + self.bit_width \u003C= u64::BITS as usize {\n        // Lock-free path\n        let atomic_word_ref = &self.storage[word_index];\n        let store_mask = self.mask \u003C\u003C bit_offset;\n        let new_value_shifted = new \u003C\u003C bit_offset;\n        let mut old_word = atomic_word_ref.load(failure);\n        loop {\n            let old_val_extracted = (old_word >> bit_offset) & self.mask;\n            if old_val_extracted != current {\n                return Err(old_val_extracted);\n            }\n            let new_word = (old_word & !store_mask) | new_value_shifted;\n            match atomic_word_ref.compare_exchange_weak(old_word, new_word, success, failure) {\n                Ok(_) => return Ok(current),\n                Err(x) => old_word = x,\n            }\n        }\n    } else {\n        // Locked path\n        let lock_index = word_index & (self.locks.len() - 1);\n        let _guard = self.locks[lock_index].lock();\n        let old_val = self.atomic_load(index, failure);\n        if old_val != current {\n            return Err(old_val);\n        }\n        self.atomic_store(index, new, success);\n        Ok(current)\n    }\n}\n```\nWith `atomic_compare_exchange` providing the core atomicity primitive, we can now construct the high-level Read-Modify-Write (RMW) API. All RMW operations, such as `fetch_add` or `fetch_max`, share an identical algorithmic structure: a loop that repeatedly reads a value, computes a new value, and attempts to commit it with `compare_exchange`. Re-implementing this loop for every operation would be redundant.\n\nInstead, we can abstract this pattern into a single generic method, `atomic_rmw`, that is parameterized not just over values, but over the *operation itself*. This is where Rust generics and closures come into play. The signature of `atomic_rmw` can be defined as follows:\n\n```rust\nfn atomic_rmw\u003CF>(&self, index: usize, val: T, order: Ordering, op: F) -> T\nwhere\n    F: Fn(T, T) -> T\n{\n    // ... implementation ...\n}\n```\n*Note: The actual implementation uses `impl Fn(...)` for a more ergonomic syntax, but the principle is the same.*\n\nThe `op` parameter is a generic type `F` constrained by the `Fn(T, T) -> T` trait. This means `op` can be any closure (or function pointer) that takes two values of our logical type `T` and returns a new `T`. This allows us to inject any binary operationâ€”addition, bitwise AND, max, etc. directly into the RMW logic.\n\nTo implement `atomic_rmw`, we begin with a relaxed load to get an initial `current` value. Inside the loop, it invokes the `op` closure with the `current` value and the user-provided `val` to compute the `new` value.\n\n```rust\nlet mut current = self.load(index, Ordering::Relaxed);\nloop {\n    let new = op(current, val);\n    // ...\n```\n\nThe core of the loop is the call to `atomic_compare_exchange`. This attempts to commit the transaction.\n\n```rust\nmatch self.compare_exchange(index, current, new, order, Ordering::Relaxed) {\n    Ok(old) => return old,\n    Err(actual) => current = actual,\n}\n```\n\nIf the operation succeeds, we return the old value, satisfying the RMW contract. If it fails due to contention, `compare_exchange` returns the `actual` value now in memory. We update our local `current` and the loop repeats, re-applying the `op` closure on the newer value. The complete `atomic_rmw` method looks like this:\n\n```rust\nfn atomic_rmw(&self, index: usize, val: T, order: Ordering, op: impl Fn(T, T) -> T) -> T {\n    let mut current = self.load(index, Ordering::Relaxed);\n    loop {\n        let new = op(current, val);\n        match self.compare_exchange(index, current, new, order, Ordering::Relaxed) {\n            Ok(old) => return old,\n            Err(actual) => current = actual,\n        }\n    }\n}\n```\n\nBy parameterizing over the operation, we have completely decoupled the complex, low-level concurrency logic from the simple arithmetic or bitwise logic of each specific RMW operation. This allows the compiler to monomorphize and inline the `op` closure for each call site, resulting in specialized and efficient machine code for each RMW variant, giving us a zero-cost abstraction.\n\nNow implementing specific RMW methods becomes a straightforward exercise in composition. Each specific operation is now a simple non-looping wrapper that calls `atomic_rmw` and provides a closure defining the desired computation. For example, `fetch_add` is implemented by passing a closure that performs a wrapping addition.\n\n```rust\npub fn fetch_add(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.wrapping_add(&b))\n}\n```\n\nThe same pattern applies to all other RMW operations. A bitwise `fetch_and` provides a closure with the `&` operator, and `fetch_max` provides one that calls the `max` method.\n\n```rust\npub fn fetch_sub(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.wrapping_sub(&b))\n}\n\npub fn fetch_and(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a & b)\n}\n\npub fn fetch_or(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a | b)\n}\n\npub fn fetch_xor(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a ^ b)\n}\n\npub fn fetch_max(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.max(b))\n}\n\npub fn fetch_min(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.min(b))\n}\n```","src/data/blog/thread-safe-fixedvec.md","16afc7e2a842b93d",{"html":306,"metadata":307},"\u003Cp>This is the second post of a series on how to build a memory-efficient vector in Rust. All this work is open source and is currently being used for research projects in succinct data structures.\u003C/p>\n\u003Cul>\n\u003Cli>All the code can be found on github: \u003Ca href=\"https://github.com/lukefleed/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003Cli>This is also published as a crate on crates.io: \u003Ca href=\"https://crates.io/crates/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"table-of-contents\">Table of Contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of Contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#structure\">Structure\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#lock-free-path-for-in-word-elements\">Lock-Free path for In-Word Elements\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#lock-based-path-for-spanning-elements\">Lock-Based Path for Spanning Elements\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#benchmarking-the-store-operation\">Benchmarking the \u003Ccode>store\u003C/code> operation\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#read-modify-write-operations\">Read-Modify-Write Operations\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-lock-free-path-a-cas-loop-on-a-sub-word\">The Lock-Free Path: A CAS Loop on a Sub-Word\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-locked-path\">The Locked Path\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch1 id=\"structure\">Structure\u003C/h1>\n\u003Cp>To make \u003Ccode>FixedVec\u003C/code> support concurrency, we have to make some changes in its internal design. The first step is to change the backing storage. A \u003Ccode>Vec&#x3C;T>\u003C/code> is not thread-safe for concurrent writes. We can replace it with a \u003Ccode>Vec&#x3C;AtomicU64>\u003C/code>. This ensures that every individual read and write to a 64-bit word is, at a minimum, atomic.\u003C/p>\n\u003Cp>However, as weâ€™ve established, a logical element can span two of these atomic words. A simple \u003Ccode>Vec&#x3C;AtomicU64>\u003C/code> does not solve the problem of atomically updating a value that crosses a word boundary. To handle this, we can add a second component to our struct: a striped lock pool. This is a vector of \u003Ccode>parking_lot::Mutex\u003C/code> instances, where the number of locks is a power of two. Each lock protects a subset of the \u003Ccode>AtomicU64\u003C/code> words in our storage. When an operation needs to modify two adjacent words, it will acquire the appropriate locks to ensure exclusive access.\u003C/p>\n\u003Cp>We can then define the \u003Ccode>AtomicFixedVec\u003C/code> struct as follows:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AtomicFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The backing store is now composed of atomic words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    storage\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">AtomicU64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // A pool of fine-grained locks to protect spanning-word operations.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mutex\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;()>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This lock pool is the mechanism we will use to enforce atomicity for operations that must modify two adjacent words simultaneously.\u003C/p>\n\u003Cp>With this structure in place, we can now design a hybrid concurrency model. Every operation must first determine if the target element is fully contained within a single \u003Ccode>AtomicU64\u003C/code> or if it spans two. Based on this, it will dispatch to one of two paths: a high-performance, lock-free path for in-word elements, or a lock-based path that uses our striped lock pool for spanning elements.\u003C/p>\n\u003Ch2 id=\"lock-free-path-for-in-word-elements\">Lock-Free path for In-Word Elements\u003C/h2>\n\u003Cp>The high-throughput path in our hybrid model is for elements that are fully contained within a single \u003Ccode>AtomicU64\u003C/code>. This condition, \u003Ccode>bit_offset + bit_width &#x3C;= 64\u003C/code>, is always met if the \u003Ccode>bit_width\u003C/code> is a power of two (e.g., 2, 4, 8, 16, 32), making \u003Ccode>BitWidth::PowerOfTwo\u003C/code> an explicit performance choice for write-heavy concurrent workloads. When this condition holds, we can perform a true lock-free atomic update using a \u003Cstrong>Compare-and-Swap (CAS) loop\u003C/strong>.\u003C/p>\n\u003Cp>A CAS operation is an atomic instruction provided by the hardware (e.g., \u003Ccode>CMPXCHG\u003C/code> on x86-64) that attempts to write a new value to a memory location only if the current value at that location matches a given expected value. This provides the primitive for building more complex atomic operations without locks.\u003C/p>\n\u003Cp>Letâ€™s try to implement an atomic \u003Ccode>store\u003C/code> on a sub-word element. We cannot simply write the new value, as that would non-atomically overwrite adjacent elements in the same word. The operation must be a read-modify-write on the entire \u003Ccode>AtomicU64\u003C/code>, where the â€œmodifyâ€ step only alters the bits corresponding to our target element.\u003C/p>\n\u003Cp>We begin by calculating the \u003Ccode>word_index\u003C/code> and \u003Ccode>bit_offset\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We then prepare a \u003Ccode>store_mask\u003C/code> to isolate the target bit range and a \u003Ccode>store_value\u003C/code> with the new value already shifted into position.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The core of the operation is the loop. We first perform a relaxed load to get the current state of the entire 64-bit word. Inside the loop, we compute \u003Ccode>new_word\u003C/code> by using the mask to clear the target bits in our local copy (\u003Ccode>old_word\u003C/code>) and then OR in the new value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The critical instruction is \u003Ccode>compare_exchange_weak\u003C/code>. It attempts to atomically replace the value at \u003Ccode>atomic_word_ref\u003C/code> with \u003Ccode>new_word\u003C/code>, but only if its current value is still equal to \u003Ccode>old_word\u003C/code>. If another thread has modified the word in the meantime, the operation fails, returns the now-current value, and our loop continues with the updated \u003Ccode>old_word\u003C/code>. We use the \u003Ccode>weak\u003C/code> variant because it can be more performant on some architectures and is perfectly suitable within a retry loop. Putting everything together, we obtain the following \u003Ccode>atomic_store\u003C/code> implementation for the lock-free path:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Lock-free path for single-word values.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This entire path is lock-free. Contention is managed at the hardware level by the CPUâ€™s cache coherency protocol, which ensures that only one core can successfully commit a CAS operation to a given cache line at a time.\u003C/p>\n\u003Cp>In the same way, we can implement other atomic operations like \u003Ccode>atomic_rmw\u003C/code> (for \u003Ccode>fetch_add\u003C/code>, \u003Ccode>fetch_sub\u003C/code>, etc.) and \u003Ccode>atomic_load\u003C/code> using similar CAS loops or direct atomic loads.\u003C/p>\n\u003Ch2 id=\"lock-based-path-for-spanning-elements\">Lock-Based Path for Spanning Elements\u003C/h2>\n\u003Cp>Now letâ€™s move to the more complex case when an element spans two \u003Ccode>AtomicU64\u003C/code> words. Here the lock-free CAS loop is no longer enough. An atomic update would require to modify two separate \u003Ccode>AtomicU64\u003C/code> words, and no single hardware instruction can do this as one indivisible transaction. To ensure atomicity, we must use a lock.\u003C/p>\n\u003Cp>A single, global \u003Ccode>Mutex\u003C/code> would serialize all concurrent writes, becoming an unacceptable performance bottleneck.  We can instead employ \u003Cstrong>lock striping\u003C/strong>, a concurrency pattern that partitions the data structure to reduce the scope of contention. The core idea is to maintain an array of locks, and map different regions of our data to different locks. We can add to our \u003Ccode>AtomicFixedVec\u003C/code> a \u003Ccode>Vec&#x3C;parking_lot::Mutex&#x3C;()>>\u003C/code>. To perform an operation on a spanning element that touches \u003Ccode>word_index\u003C/code> and \u003Ccode>word_index + 1\u003C/code>, a thread first acquires a specific lock from this pool. The mapping is done by hashing the word index to a lock index. Since the number of locks is a power of two, we can use a fast bitwise AND for this mapping instead of a slower modulo operation: \u003Ccode>let lock_index = word_index &#x26; (self.locks.len() - 1)\u003C/code>.\u003C/p>\n\u003Cp>In this way we are partitioning the vector into a set of independent regions. A locked write to words \u003Ccode>(i, i+1)\u003C/code> will not block a simultaneous locked write to words \u003Ccode>(j, j+1)\u003C/code> or a lock-free write to word \u003Ccode>k\u003C/code>, provided they map to different locks in the stripe. We now need a heuristic to determine, at construction time, how many locks to create. Ideally we would like to balance contention reduction against memory overhead. This could be a valuable option:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Heuristic to determine the number of locks for striping.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> num_cores\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">thread\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">available_parallelism\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MIN_LOCKS\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> target_locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">num_words\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> WORDS_PER_LOCK\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> num_locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">target_locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">num_cores\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">next_power_of_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">min\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MAX_LOCKS\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The logic aims to create enough locks to service the available hardware threads (\u003Ccode>num_cores\u003C/code>) and to cover the data with a reasonable density (one lock per 64 words, \u003Ccode>WORDS_PER_LOCK\u003C/code>). We take the maximum of these two, multiply by two as a simple overprovisioning factor, and round up to the next power of two to enable fast mapping via bitwise AND. The total number of locks is capped to prevent excessive memory consumption for the lock vector itself.\u003C/p>\n\u003Cblockquote>\n\u003Cp>\u003Cstrong>In this the best way?\u003C/strong> I donâ€™t know, probably not. For instance, a \u003Cem>seqlock\u003C/em> could theoretically offer higher performance for read-heavy workloads. A writer would increment a version counter, perform the non-atomic two-word write, and increment it again. Readers would check for a consistent version number to validate that their read was not interrupted. However, this pattern is fundamentally incompatible with Rustâ€™s safety guarantees. A reader in a seqlock might observe a â€œtorn readâ€ (a state where one word has been updated but the other has not). This constitutes a data race, which safe Rustâ€™s memory model is designed to prevent. A correct seqlock implementation requires a ton of \u003Ccode>unsafe\u003C/code> code, volatile reads, and careful memory fencing. Given this constrains (and that I am not an expert in lock-free programming), we can stick to the simpler yet performant implementation bases on \u003Ccode>Mutex\u003C/code>. At least, power of two \u003Ccode>bit_width\u003C/code> values can avoid the spanning case entirely.\u003C/p>\n\u003C/blockquote>\n\u003Cp>With the lock striping mechanism cleared, we can now complete the implementation for our \u003Ccode>atomic_store\u003C/code> method. The first step is to acquire the correct lock.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> _guard\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Once the lock is acquired, we have exclusive access for this two-word transaction. However, itâ€™s critical that we continue to use atomic operations to modify the words themselves. This is because another thread might be concurrently executing a \u003Cem>lock-free\u003C/em> operation on an adjacent, non-spanning element that happens to reside in \u003Ccode>word_index\u003C/code> or \u003Ccode>word_index + 1\u003C/code>. Using non-atomic writes inside the lock would create a data race with those lock-free operations.\u003C/p>\n\u003Cp>We therefore use \u003Ccode>fetch_update\u003C/code>, another CAS-based atomic, to modify each of the two words. For the lower word, we clear the high bits starting from our \u003Ccode>bit_offset\u003C/code> and OR in the low bits of our new value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Modify the lower word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MAX\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// This unwrap is safe: with the lock held, there is no contention.\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Next, we do the same for the higher word, calculating a \u003Ccode>high_mask\u003C/code> to clear the low bits and writing the remaining high bits of our value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Also safe.\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The lock provides the mutual exclusion that makes the two-word update appear atomic as a whole. The continued use of atomics with the user-specified \u003Ccode>Ordering\u003C/code> ensures that the final result is correctly propagated through the memory system and becomes visible to other threads according to the Rust memory model.\u003C/p>\n\u003Cp>Putting it all together, the final, complete \u003Ccode>atomic_store\u003C/code> method handles both the lock-free and locked paths.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Lock-free path for single-word values.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Locked path for values spanning two words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> _guard\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // The lock guarantees exclusive access to this multi-word operation.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // We still use atomic operations inside to prevent races with the\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // lock-free path, which might be concurrently accessing one of\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // these words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Modify the lower word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        low_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MAX\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Should not fail under lock.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Modify the higher word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        high_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Should not fail under lock.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The branching logic \u003Ccode>if bit_offset + self.bit_width &#x3C;= 64\u003C/code> is a simple, constant-time check that determines which path to take. The condition is highly predictable for the CPUâ€™s branch predictor, as the \u003Ccode>bit_offset\u003C/code> follows a simple arithmetic progression based on the index. This minimizes pipeline stalls. More importantly, this structure enables significant compiler optimization. When we use \u003Ccode>AtomicFixedVec\u003C/code> with a \u003Ccode>bit_width\u003C/code> that is a power of two, the branch condition can often be resolved at compile time. With Link-Time Optimization (LTO), the compiler can prove that the \u003Ccode>else\u003C/code> branch for the locked path is unreachable. This allows for dead code elimination, producing a specialized function containing \u003Cem>only\u003C/em> the lock-free CAS loop.\u003C/p>\n\u003Ch1 id=\"benchmarking-the-store-operation\">Benchmarking the \u003Ccode>store\u003C/code> operation\u003C/h1>\n\u003Cp>We now want to measure the performance of our \u003Ccode>atomic_store\u003C/code> implementation under concurred load. We want to know how the throughput of the \u003Ccode>store\u003C/code> operation scales as we increase thread count and contention. We can create two benchmark scenarios, one with a bit-width that is a power of two, and one with a non-power-of-two bit-width. Both simulate â€œdiffuse contentionâ€: a pool of threads performs a high volume of atomic \u003Ccode>store\u003C/code> operations to random indices within a shared vector of 10k 64-bit elements. Each thread is assigned 100k operations. This randomness ensures that while direct contention on the same element is rare, there will be frequent collisions on the same \u003Ccode>AtomicU64\u003C/code> words, especially as thread count increases.\u003C/p>\n\u003Cp>In the benchmark, each thread with \u003Ccode>thread_id\u003C/code> simply writes its own ID to the vector for each operation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">thread_id\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">SeqCst\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We compare our \u003Ccode>AtomicFixedVec\u003C/code> against two other implementations:\u003C/p>\n\u003Col>\n\u003Cli>A \u003Ccode>Vec&#x3C;AtomicU16>\u003C/code>: This serves as our â€œidealâ€ baseline.\u003C/li>\n\u003Cli>\u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/struct.AtomicBitFieldVec.html\">\u003Ccode>sux::AtomicBitFieldVec\u003C/code>\u003C/a>: A similar implementation of another library. This comparison however is not perfectly equivalent for bit-widths that are not powers of two. As per their documentation, \u003Ccode>sux\u003C/code> does not guarantee atomicity for values that span word boundaries, which can lead to â€œtorn writes.â€ Our \u003Ccode>AtomicFixedVec\u003C/code> is designed to prevent this class of data race through its lock striping mechanism. The performance cost of this correctness guarantee is precisely what we aim to measure.\u003C/li>\n\u003C/ol>\n\u003Cp>The first benchmark measure the performance of our \u003Cstrong>lock-free path\u003C/strong>. We configure all vectors with a \u003Ccode>bit_width\u003C/code> of 16. Because 16 is a power of two and evenly divides the 64-bit word size, every element is guaranteed to be fully contained within a single \u003Ccode>u64\u003C/code> word. This is the best-case scenario for bit-packed atomics. It ensures that all \u003Ccode>store\u003C/code> operations can be performed with lock-free CAS loops.\u003C/p>\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_lock_free_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>As we can see, all three implementations scale well with increasing thread count. The throughput of \u003Ccode>AtomicFixedVec\u003C/code> is very close to that of \u003Ccode>sux::AtomicBitFieldVec\u003C/code>, which is expected since both are using similar lock-free CAS loops for this scenario. Both bit-packed vectors have a noticeable dip at two threads, likely due to initial cache coherency overhead, but then scale up effectively with the core count.\u003C/p>\n\u003Cp>The second benchmark tries to stress the \u003Cstrong>locked path\u003C/strong>. We configure the vectors with a \u003Ccode>bit_width\u003C/code> of 15. This non-power-of-two width guarantees that a predictable fraction of writes will cross word boundaries. In our case, \u003Ccode>(15 + 63) % 64\u003C/code> spanning cases out of 64 offsets, so roughly \u003Ccode>14/64\u003C/code> or ~22% will require locking. This forces our \u003Ccode>AtomicFixedVec\u003C/code> to use its lock striping mechanism for those spanning writes. In contrast, \u003Ccode>sux\u003C/code> will proceed without locking, risking data races but avoiding locking overhead.\u003C/p>\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_locked_path_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>This benchmark shows the real cost of correctness. Our \u003Ccode>AtomicFixedVec\u003C/code> now shows lower throughput and poorer scaling compared to both the baseline and \u003Ccode>sux\u003C/code>. Every write operation that crosses a word boundary (approximately 22% of them in this test) must acquire a lock, execute its two atomic updates, and release the lock. While with lock striping we prevent a single point of serialization, the overhead of the locking protocol itself, especially under contention from multiple threads, is non-trivial. In contrast, \u003Ccode>sux\u003C/code> maintains higher throughput by avoiding locks entirely, but at the cost of potentially observing torn writes.\u003C/p>\n\u003Ch1 id=\"read-modify-write-operations\">Read-Modify-Write Operations\u003C/h1>\n\u003Cp>With the hybrid atomicity model defined, the next step is to build a robust API. Instead of re-implementing the complex hybrid logic for every atomic operation, we can implement it once in a single, powerful primitive: \u003Ccode>compare_exchange\u003C/code>. All other Read-Modify-Write (RMW) operations can then be built on top of this primitive.\u003C/p>\n\u003Cp>\u003Ccode>compare_exchange\u003C/code> attempts to store a \u003Ccode>new\u003C/code> value into a location if and only if the value currently at that location matches an expected \u003Ccode>current\u003C/code> value. This operation is the fundamental building block for lock-free algorithms.\u003C/p>\n\u003Ch2 id=\"the-lock-free-path-a-cas-loop-on-a-sub-word\">The Lock-Free Path: A CAS Loop on a Sub-Word\u003C/h2>\n\u003Cp>For elements that are fully contained within a single \u003Ccode>AtomicU64\u003C/code>, we can implement \u003Ccode>compare_exchange\u003C/code> with a CAS loop. However, the logic is more complex than a simple store. We arenâ€™t comparing the entire 64-bit word; we are comparing a specific \u003Ccode>bit_width\u003C/code> slice within it.\u003C/p>\n\u003Cp>The process is as follows. First, we load the entire 64-bit word. Then, we extract the specific bits that correspond to our logical element and compare them against the user-provided \u003Ccode>current\u003C/code> value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Inside the lock-free path of atomic_compare_exchange\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If this check fails, it means another thread has modified the element since our initial load. We can immediately return an \u003Ccode>Err\u003C/code> with the value we just read, satisfying the contract of \u003Ccode>compare_exchange\u003C/code>.\u003C/p>\n\u003Cp>If the check succeeds, we proceed to the atomic write phase. We prepare a \u003Ccode>new_word\u003C/code> by masking and ORing in the \u003Ccode>new\u003C/code> value, just as we did for \u003Ccode>atomic_store\u003C/code>. Then we attempt the hardware-level \u003Ccode>compare_exchange_weak\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ... continuing the loop ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_value_shifted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">success\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If the \u003Ccode>compare_exchange_weak\u003C/code> succeeds, it means no other thread modified the 64-bit word between our initial \u003Ccode>load\u003C/code> and this instruction. Our update is successful. If it fails, another thread (possibly operating on an \u003Cem>adjacent\u003C/em> element in the same word) has modified the word. We update our local \u003Ccode>old_word\u003C/code> with the new value from memory and retry the entire loop.\u003C/p>\n\u003Ch2 id=\"the-locked-path\">The Locked Path\u003C/h2>\n\u003Cp>For elements that span two words, we need to use the lock striping mechanism to ensure the operation is transactional. First, we must acquire the appropriate lock, giving us exclusive access to the two-word region.\u003C/p>\n\u003Cp>Once the lock is held, the logic is straightforward:\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Read:\u003C/strong> We perform an atomic read of the spanning value. This is itself a locked operation to ensure we get a consistent view.\u003C/li>\n\u003Cli>\u003Cstrong>Compare:\u003C/strong> We compare this value against the user-provided \u003Ccode>current\u003C/code>. If they donâ€™t match, we release the lock and immediately return \u003Ccode>Err\u003C/code>.\u003C/li>\n\u003Cli>\u003Cstrong>Write:\u003C/strong> If they do match, we call our existing \u003Ccode>atomic_store\u003C/code> method to write the \u003Ccode>new\u003C/code> value. \u003Ccode>atomic_store\u003C/code> will re-acquire the same lock to perform its two-word write.\u003C/li>\n\u003Cli>\u003Cstrong>Return:\u003C/strong> We release the lock and return \u003Ccode>Ok\u003C/code>.\u003C/li>\n\u003C/ol>\n\u003Cp>Because the entire read-compare-write sequence is protected by the same mutex, we guarantee that no other thread can interfere. Combining these two paths gives us the complete \u003Ccode>atomic_compare_exchange\u003C/code> method, which can then be used to implement all other atomic operations in terms of it.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_compare_exchange\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    success\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    failure\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Lock-free path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_value_shifted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">                return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_value_shifted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">success\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Locked path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> _guard\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">success\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With \u003Ccode>atomic_compare_exchange\u003C/code> providing the core atomicity primitive, we can now construct the high-level Read-Modify-Write (RMW) API. All RMW operations, such as \u003Ccode>fetch_add\u003C/code> or \u003Ccode>fetch_max\u003C/code>, share an identical algorithmic structure: a loop that repeatedly reads a value, computes a new value, and attempts to commit it with \u003Ccode>compare_exchange\u003C/code>. Re-implementing this loop for every operation would be redundant.\u003C/p>\n\u003Cp>Instead, we can abstract this pattern into a single generic method, \u003Ccode>atomic_rmw\u003C/code>, that is parameterized not just over values, but over the \u003Cem>operation itself\u003C/em>. This is where Rust generics and closures come into play. The signature of \u003Ccode>atomic_rmw\u003C/code> can be defined as follows:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">op\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... implementation ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cem>Note: The actual implementation uses \u003Ccode>impl Fn(...)\u003C/code> for a more ergonomic syntax, but the principle is the same.\u003C/em>\u003C/p>\n\u003Cp>The \u003Ccode>op\u003C/code> parameter is a generic type \u003Ccode>F\u003C/code> constrained by the \u003Ccode>Fn(T, T) -> T\u003C/code> trait. This means \u003Ccode>op\u003C/code> can be any closure (or function pointer) that takes two values of our logical type \u003Ccode>T\u003C/code> and returns a new \u003Ccode>T\u003C/code>. This allows us to inject any binary operationâ€”addition, bitwise AND, max, etc. directly into the RMW logic.\u003C/p>\n\u003Cp>To implement \u003Ccode>atomic_rmw\u003C/code>, we begin with a relaxed load to get an initial \u003Ccode>current\u003C/code> value. Inside the loop, it invokes the \u003Ccode>op\u003C/code> closure with the \u003Ccode>current\u003C/code> value and the user-provided \u003Ccode>val\u003C/code> to compute the \u003Ccode>new\u003C/code> value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> op\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The core of the loop is the call to \u003Ccode>atomic_compare_exchange\u003C/code>. This attempts to commit the transaction.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If the operation succeeds, we return the old value, satisfying the RMW contract. If it fails due to contention, \u003Ccode>compare_exchange\u003C/code> returns the \u003Ccode>actual\u003C/code> value now in memory. We update our local \u003Ccode>current\u003C/code> and the loop repeats, re-applying the \u003Ccode>op\u003C/code> closure on the newer value. The complete \u003Ccode>atomic_rmw\u003C/code> method looks like this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">op\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> op\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>By parameterizing over the operation, we have completely decoupled the complex, low-level concurrency logic from the simple arithmetic or bitwise logic of each specific RMW operation. This allows the compiler to monomorphize and inline the \u003Ccode>op\u003C/code> closure for each call site, resulting in specialized and efficient machine code for each RMW variant, giving us a zero-cost abstraction.\u003C/p>\n\u003Cp>Now implementing specific RMW methods becomes a straightforward exercise in composition. Each specific operation is now a simple non-looping wrapper that calls \u003Ccode>atomic_rmw\u003C/code> and provides a closure defining the desired computation. For example, \u003Ccode>fetch_add\u003C/code> is implemented by passing a closure that performs a wrapping addition.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The same pattern applies to all other RMW operations. A bitwise \u003Ccode>fetch_and\u003C/code> provides a closure with the \u003Ccode>&#x26;\u003C/code> operator, and \u003Ccode>fetch_max\u003C/code> provides one that calls the \u003Ccode>max\u003C/code> method.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_and\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_xor\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_min\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">min\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":308,"localImagePaths":331,"remoteImagePaths":332,"frontmatter":333,"imagePaths":336},[309,310,313,316,319,322,325,328],{"depth":32,"slug":210,"text":211},{"depth":213,"slug":311,"text":312},"structure","Structure",{"depth":32,"slug":314,"text":315},"lock-free-path-for-in-word-elements","Lock-Free path for In-Word Elements",{"depth":32,"slug":317,"text":318},"lock-based-path-for-spanning-elements","Lock-Based Path for Spanning Elements",{"depth":213,"slug":320,"text":321},"benchmarking-the-store-operation","Benchmarking the store operation",{"depth":213,"slug":323,"text":324},"read-modify-write-operations","Read-Modify-Write Operations",{"depth":32,"slug":326,"text":327},"the-lock-free-path-a-cas-loop-on-a-sub-word","The Lock-Free Path: A CAS Loop on a Sub-Word",{"depth":32,"slug":329,"text":330},"the-locked-path","The Locked Path",[],[],{"author":14,"pubDatetime":334,"title":298,"slug":294,"featured":198,"draft":198,"tags":335,"description":301},["Date","2025-09-16T00:00:00.000Z"],[200,300],[],"competitive-programming-reminders",{"id":337,"data":339,"body":344,"filePath":345,"digest":346,"rendered":347},{"author":14,"pubDatetime":340,"title":341,"featured":17,"draft":198,"tags":342,"description":343},["Date","2022-12-01T00:00:00.000Z"],"Competitive Programming Friendly reminders",[19],"An incomplete summary of the most important algorithms and data structures to remember before a coding interview","## Arrays\n\nArrays are a collection of values. They are ordered and can be accessed by index. Arrays are zero-indexed, meaning the first element is at index 0. Arrays can be of any type, including other arrays.\n\n## HashTable\n\nAn HashTable is a data structure that maps keys to values for highly efficient lookup. It is a structure that can be implemented with arrays, linked lists, binary search trees (in this case we would have $O(n \\log n)$ lookup time. The advantage of this is potentially using less space, since we no longer allocate a large array. We can also iterate through the keys i order, which can be useful sometimes), or hash tables.\n\n```python\nHashTable = dict()\n```\n\nor if we want to use defaultdict\n\n```python\nfrom collections import defaultdict\n\nHashTable = defaultdict(int)\n# a default value of 0 is assigned to all keys\n```\n\n## ArrayList & ResizableArray\n\nWhen you need an array-like data structure that offers dynamic resizing, you would usually use an Arraylist. An Arraylist is an array that resizes itself as needed while still providing $O(1)$ access.\n\n```python\nArray = [None] * 1000\n# array of 1000 elements, all None\n```\n\n# Binary Search\n\nBinary search is a search algorithm that finds the position of a target value within a sorted array. Binary search compares the target value to the middle element of the array. If they are not equal, the half in which the target cannot lie is eliminated and the search continues on the remaining half, again taking the middle element to compare to the target value, and repeating this until the target value is found. If the search ends with the remaining half being empty, the target is not in the array.\n\n```python\ndef binary_search(arr, target):\n    left = 0\n    right = len(arr) - 1\n\n    while left \u003C= right:\n        mid = (left + right) // 2\n        if arr[mid] == target:\n            return mid\n        elif arr[mid] \u003C target:\n            left = mid + 1\n        else:\n            right = mid - 1\n\n    return -1\n```\n\n## Algorithms\n\n### QuickSelect\n\nQuickSelect is a selection algorithm to find the k-th smallest/largest element in an unordered list. It is related to the quick sort sorting algorithm.\n\n```python\ndef quick_select(arr, k):\n    if len(arr) == 1:\n        return arr[0]\n\n    pivot = random.choice(arr)\n    left = [x for x in arr if x \u003C pivot]\n    middle = [x for x in arr if x == pivot]\n    right = [x for x in arr if x > pivot]\n\n    if k \u003C= len(left):\n        return quick_select(left, k)\n    elif k \u003C= len(left) + len(middle):\n        return middle[0]\n    else:\n        return quick_select(right, k - len(left) - len(middle))\n```\n\n# Stack\n\nThe stack data structure is precisely what it sounds like: a stack of data. In certain types of problems, it can be favorable to store data in a stack rather than in an array.\n\nA stack uses LIFO (last-in first-out) ordering. That is, as in a stack of dinner plates, the most recent item added to the stack is the first item to be removed.\n\nIt uses the following operations:\n\n- `push(item)`: adds an item to the top of the stack\n- `pop()`: removes the top item from the stack\n- `peek()`: returns the top of the stack without removing it\n- `isEmpty()`: returns true if and only if the stack is empty\n\nUnlike an array, a stack does not offer constant-time access to the ith item. However, it does allow constant-time adds and removes, as it doesn't require shifting elements around.\n\n```python\nstack = []\n\n# add to the top of the stack\nstack.append(1)\nstack.append(2)\n\n# remove from the top of the stack\nstack.pop()\n```\n\nOne case where stacks are often useful is in certain recursive algorithms. Sometimes you need to push temporary data onto a stack as you recurse, but then remove them as you backtrack (for example, because the recursive check failed). A stack offers an intuitive way to do this.\n\nA stack can also be used to implement a recursive algorithm iteratively.\n\n## Queue\n\nA queue is an ordered collection of items where the addition of new items happens at one end, called the \"rear,\" and the removal of existing items occurs at the other end, commonly called the \"front.\" As an element enters the queue it starts at the rear and makes its way toward the front, waiting until that time when it is the next element to be removed.\n\nIt uses the following operations:\n\n- `add(item)`: adds an item to the rear of the queue\n- `remove()`: removes the front item from the queue\n- `peek()`: returns the front of the queue without removing it\n- `isEmpty()`: returns true if and only if the queue is empty\n\n```python\nfrom collections import deque\n\nqueue = deque() # double-ended queue\n```\n\nA queue can also be implemented with a linked list. In fact, they are essentially the same thing, as long as items are added and removed from opposite sides.\n\nOne place where queues are often used is in breadth-first search or in implementing a cache. In breadth-first search, for example, we used a queue to store a list of the nodes that we need to process. Each time we process a node, we add its adjacent nodes to the back of the queue. This allows us to process nodes in the order in which they are viewed.\n\n# Linked List\n\nA Linked list is a data structure that represents a sequence of nodes. In as singly linked list, each node points to the next node in the linked list. In a doubly linked list, each node points to the next node and the previous node. In a circular linked list, the tail node points to the head node.\n\nUnlike an array, a linked list does not provide costant access time to a particolar index within the list. This means, that if you'd like to find the kth element in a linked list, you'd have to traverse the list from the head node to the kth node. This is because the nodes in a linked list are not stored in contiguous memory locations.\n\n## Singly Linked List\n\n```python\n# Definition for singly-linked list.\nclass ListNode:\n    def __init__(self, x):\n        self.val = x\n        self.next = None\n```\n\nIn this implementation, the head node is the first node in the linked list. The tail node is the last node in the linked list. The tail node's next pointer points to None.\n\n## Techniques\n\n- Slow and Fast Pointer\n\n_This is a technique that is used to solve problems that involve linked list traversal. The slow pointer moves one node at a time, while the fast pointer moves two nodes at a time. This technique is used to find the middle node of a linked list, or to determine if a linked list has a cycle._\n\n- Dummy linked list\n\n```python\ndummy = ListNode()\n```\n\n- Check if has a cycle\n\n```python\ndef hasCycle(self, head: ListNode) -> bool:\n    slow = fast = head\n    while fast and fast.next:\n        slow = slow.next\n        fast = fast.next.next\n        if slow == fast:\n            return True\n    return False\n```\n\n- Reverse a linked list\n\n```python\ndef reverseList(self, head: ListNode) -> ListNode:\n    prev, curr = None, head\n\n    while curr:\n        temp = curr.next\n        curr.next = prev\n        prev = curr\n        curr = temp\n    return prev\n```\n\n- Sometimes it's useful to split a linked list into two parts\n\n# Trees\n\nA nice way to understand a tree is with a recursive explanation. A tree is a data structure composed of nodes.\n\n- Each tree has a root node. (Actually, this isn't strictly necessary in graph theory, but it's usually how we use trees in programming)\n\n- The root node has zero or more child nodes.\n\n- Each child node has zero or more child nodes, and so on.\n\nThe tree cannot contain cycles. The nodes may or may not be in a particular order, they could have any data type as values, and they may or may not have links back to their parent nodes.\n\n```python\nclass TreeNode:\n    def __init__(self, val):\n        self.val = val\n        self.children = []\n```\n\n## Binary Tree\n\nA binary tree is a tree in which each node has up to two children. Not all trees are binary trees. There are occasions when you might have a tree that is not a binary tree. For example, suppose you were using a tree to represent a bunch of phone numbers. In this case, you might use a 10-ary tree, with each node having up to 10 children (one for each digit}.\nA node is called a \"leaf\" node if it has no children.\n\n```python\nclass BinaryTreeNode:\n    def __init__(self, val):\n        self.val = val\n        self.left = None\n        self.right = None\n```\n\n## Binary Search Tree\n\nA binary search tree is a binary tree in which every node fits a specific ordering property: _all left descendents_ $\\leq n \u003C$ _all right descendents_. This must be true for each node $n$. Note that this inequality must be true for all of a node's descendents, not just its immediate children\n\n> The definition of a binary search tree can vary slightly with respect to equality. Under some definitions, the tree cannot have duplicate values. In others, the duplicate values will be on the right or can be on either side. All are valid definitions, but you should clarify this with your interviewer.\n\n### Balanced vs Unbalanced\n\nWhile many trees are balanced, not all are. Note that balancing a tree does not mean the left and right subtrees are exactly the same size (like you see under \"perfect binary trees\")\n\nOne way to think about it is that a \"balanced\" tree really means something more like \"not terribly imbalanced:' It's balanced enough to ensure $O(\\log n)$ times for insert and find, but it's not necessarily as balanced as it could be.\n\n### Complete Binary Tree\n\nA complete binary tree is a binary tree in which every level of the tree is fully filled, except for perhaps the last level. lo the extent that the last level is filled, it is filled left to right.\n\n### Full Binary Tree\n\nA full binary tree is a binary tree in which every node has either zero or two children. That is, no nodes have only one child.\n\n### Perfect Binary Tree\n\nA perfect binary tree is one that is both full and complete. All leaf nodes will be at the same level, and this level has the maximum number of nodes.\n\n## Binary Tree Traversal\n\n### In-order Traversal\n\nIn-order traversal means to \"visit\" (often, print) the left branch, then the current node, and finally, the right branch.\n\n```python\ndef inOrderTraversal(self, root):\n    if root:\n        self.inOrderTraversal(root.left)\n        print(root.val)\n        self.inOrderTraversal(root.right)\n```\n\n### Pre-order Traversal\n\nPre-order traversal visits the current node before its child nodes (hence the name \"pre-order\").\n\n```python\ndef preOrderTraversal(self, root):\n    if root:\n        print(root.val)\n        self.preOrderTraversal(root.left)\n        self.preOrderTraversal(root.right)\n```\n\n### Post-order Traversal\n\nPost-order traversal visits the current node after its child nodes (hence the name \"post-order\").\n\n```python\ndef postOrderTraversal(self, root):\n    if root:\n        self.postOrderTraversal(root.left)\n        self.postOrderTraversal(root.right)\n        print(root.val)\n```\n\n### Level-order Traversal\n\nLevel-order traversal visits the nodes level by level. You'll often see this done with a queue.\n\n```python\ndef levelOrderTraversal(self, root):\n    if not root:\n        return\n    queue = [root]\n    while queue:\n        node = queue.pop(0)\n        print(node.val)\n        if node.left:\n            queue.append(node.left)\n        if node.right:\n            queue.append(node.right)\n```\n\n## Binary Heaps (min-heap and max-heap)\n\nWe'll just discuss min-heaps here. Max-heaps are essentially equivalent, but the elements are in descending order rather than ascending order\n\nA min-heap is a complete binary tree (that is, totally filled other than the rightmost elements on the last level) where each node is smaller than its children. The root, therefore, is the minimum element in the tree.\n\nWe have two key operations on a min-heap: `insert` and `extract_min`.\n\n### Insert\n\nWhen we insert into a min-heap, we always start by inserting the element at the bottom. We insert at the rightmost spot so as to maintain the complete tree property.\n\nThen, we \"fix\" the tree by swapping the new element with its parent, until we find an appropriate spot for the element We essentially bubble up the minimum element.\n\nThis takes $O(\\log n)$ time, where $n$ is the number of elements in the heap.\n\n### Extract Min\n\nFinding the minimum element of a min-heap is easy: it's always at the top. The trickier part is how to remove it. (In fact, this isn't that tricky.)\n\nFirst, we remove the minimum element and swap it with the last element in the heap (the bottommost, rightmost element). Then, we bubble down this element, swapping it with one of its children until the min-heap property is restored.\n\nDo we swap it with the left child or the right child? That depends on their values. There's no inherent ordering between the left and right element, but you'll need to take the smaller one in order to maintain the min-heap ordering.\n\nThis takes $O(\\log n)$ time.\n\n# Tries\n\nA trie (sometimes called a prefix tree} is a funny data structure. It comes up a lot in interview questions, but algorithm textbooks don't spend much time on this data structure.\n\nA trie is a variant of an n-ary tree in which characters are stored at each node. Each path down the tree may represent a word.\n\n```python\nclass TrieNode:\n    def __init__(self):\n        self.children = {}\n        self.is_word = False\n```\n\nThe `* nodes` (sometimes called \"null nodes\") are often used to indicate complete words. For example, the fact that there is a `* node` under `MANY` indicates that `MANY` is a complete word. The existence of the `MA` path\nindicates there are words that start with `MA`.\n\nThe actual implementation of these `* nodes` might be a special type of child (such as a `TerminatingTrieNode`, which inherits from `TrieNode`. Or, we could use just a boolean flag terminates within the \"parent\" node.\n\nA node in a trie could have anywhere from 1 through `ALPHABET_SIZE + 1` children (or, `O` through `ALPHABET_SIZE` if a boolean flag is used instead of a `* node`).\n\nVery commonly, a trie is used to store the entire (English) language for quick prefix lookups. While a hash table can quickly look up whether a string is a valid word, it cannot tell us if a string is a prefix of any valid words. A trie can do this very quickly.\n\n> How quickly? A trie can check if a string is a valid prefix in $O(K)$ time, where K is the length of the string. This is actually the same runtime as a hash table will take. Although we often refer to hash table lookups as being $O(1)$ time, this isn't entirely true. A hash table must read through all the characters in the input which takes $O(K)$ time in the case of a word lookup\n\nMany problems involving lists of valid words leverage a trie as an optimization. In situations when we search through the tree on related prefixes repeatedly\n\n# Backtracking\n\nBacktracking is a general algorithm for finding all (or some) solutions to some computational problems, notably constraint satisfaction problems, that incrementally builds candidates to the solutions, and abandons each partial candidate (\"backtracks\") as soon as it determines that the candidate cannot possibly be completed to a valid solution.\n\n- Sometimes is useful to think of backtracking as an intelligent \"brute force\" approach.\n- Recursive DFS is often a good way to implement backtracking\n- It's usually a good idea to start by writing a recursive backtracking every time you see a subset, combination, permutation, or partition problem.\n\n# Graphs\n\nMany programming problems can be solved by modeling the problem as a graph\nproblem and using an appropriate graph algorithm.\n\nAtree is actually a type of graph, but not all graphs are trees. Simply put, a tree isa connected graph without cycles. A graph is simply a collection d nodes with edges between (some of) them.\n\n- Graphs can be either **directed** or **undirected**. While directed edges are like a one-way street, undirected edges are like a two-way street.\n- The graph might consist of multiple isolated subgraphs. If there is a path between every pair of vertices, it is called a \"**connected graph**\".\n- The graph can also have cycles (or not). An \"**acyclic graph**\" is one without cycles\n\n## Adjacency Lists\n\nThis is the most common way to represent a graph. Every vertex (or node) stores a list of adjacent vertices. In an undirected graph, an edge like `(a, b)` would be stored twice: once in `a`'s adjacent vertices and once in `b`'s adjacent vertices.\n\nA simple class definition for a graph node could look essentially the same as a tree node.\n\n```python\nclass Graph:\n    def __init__(self):\n        self.nodes = {}\n```\n\n```python\nclass Node:\n    def __init__(self, val = 0, neighbors = None):\n        self.val = val\n        self.neighbors = neighbors if neighbors is not None else []\n```\n\nYou don't necessarily need any additional classes to represent a graph. An array (or a hash table) of lists (arrays, arraylists, linked lists, etc.) can store the adjacency list.\n\n## Adjacency Matrix\n\nAn adjacency matrix is an `NxN` boolean matrix (where `N` is the number of nodes), where a true value at `matrix[i][j]` indicates an edge from node `i` to node `j`. (You can also use an integer matrix with Os and 1s.)\n\nNote that in an undirected graph, an adjacency matrix will be symmetric. In a directed graph, it will not (necessarily) be.\n\nThe same graph algorithms that are used on adjacency lists (breadth-first search, etc.) can be performed with adjacency matrices, but they may be somewhat less efficient. In the adjacency list representation, you can easily iterate through the neighbors of a node. In the adjacency matrix representation, you will need to iterate through all the nodes to identify a node's neighbors.\n\n## Graph Search\n\nThe two most common ways to search a graph are **depth-first search** and **breadth-first search**.\n\n- In depth-first search (DFS), we start at the root (or another arbitrarily selected node) and explore each branch completely before moving on to the next branch. That is. we go deep first (hence the name depth-first search) before we go wide.\n\n- In breadth-first search (BFS), we start at the root (or another arbitrarily selected node) and explore each neighbor before going on to any of their children. That is, we go wide (hence breadth-first search) before\n  we go deep.\n\nBreadth-first search and depth-first search tend to be used in different scenarios. DFS is often preferred if we want to visit every node in the graph. Both will work just fine, but depth-first search is a bit simpler. However, if we want to find the shortest path (or just any path) between two nodes, BFS is generally better.\n\n### DFS\n\nIn DFS, we visit a node a and then iterate through each of a's neighbors. When visiting `a` node `b` that is a neighbor of `a`, we visit all of `b`'s neighbors before going on to `a`'s other neighbors. That is, a exhaustively\nsearches `b`'s branch before any of its other neighbors.\n\nNote that pre-order and other forms of tree traversal are a form of DFS. The key difference is that when implementing this algorithm for a graph, we must check if the node has been visited. If we don't, we risk getting stuck in an infinite loop.\n\n```python\ndef dfs(node):\n    if node is None:\n        return\n    visit(node)\n    node.visited = True\n    for next in node.adjacent:\n        if next.visited == False:\n            dfs(next)\n```\n\n### BFS\n\nBFS is a bit less intuitive. The main tripping point is the (false) assumption that BFS is recursive. It's not. Instead, it uses a queue.\n\nIn BFS, node a visits each of a's neighbors before visiting any of their neighbors. You can think of this as searching level by level out from a. An iterative solution involving a queue usually works best.\n\n```python\ndef bfs(graph, start):\n    queue = []\n    queue.append(start)\n    start.visited = True\n    while queue:\n        r = queue.pop(0)\n        visit(r)\n        for n in r.adjacent:\n            if n.visited == False:\n                n.visited = True\n                queue.append(n)\n```\n\nIf you are asked to implement BFS, the key thing to remember is the use of the queue. The rest of the algorithm flows from this fact.\n\n### Bidirectional Search\n\nBidirectional search is used to find the shortest path between a source and destination node. It operates by essentially running two simultaneous breadth-first searches, one from each node. When their searches collide, we have found a path.\n\n![](https://i.imgur.com/AQTtl8H.png)\n\nTo see why this is faster, consider a graph where every node has at most k adjacent nodes and the shortest path from node s to node t has length d.\n\n- In traditional breadth-first search, we would search up to `k` nodes in the first \"level\" of the search. In the second level, we would search up to `k` nodes for each of those first `k` nodes, so $k^2$ nodes total (thus far).\n  We would do this $d$ times, so that's $O(k^d)$ nodes.\n\n- In bidirectional search, we have two searches that collide after approximately $d/2$ levels (the midpoint of the path). The search from `s` visits approximately $2k^{d/2}$, as does the search from `t`. That's approximately $O(k^{d/2})$ nodes total.\n\nSo the the bidirectional search is actually faster by a factor of $k^{d/2}$.\n\n### Topological Sort\n\n## Shortest Path\n\nFinding a shortest path between two nodes of a graph is an important problem\nthat has many practical applications. For example, a natural problem related to a road network is to calculate the shortest possible length of a route between two cities, given the lengths of the roads.\n\nIn an unweighted graph, the length of a path equals the number of its edges,\nand we can simply use breadth-first search to find a shortest path. However, we focus on weighted graphs where more sophisticated algorithms are needed for finding shortest paths\n\n### Bellman-Ford\n\nThe Bellmanâ€“Ford algorithm finds shortest paths from a starting node to all\nnodes of the graph. The algorithm can process all kinds of graphs, provided that the graph does not contain a cycle with negative length. If the graph contains a negative cycle, the algorithm can detect this.\n\nThe algorithm keeps track of distances from the starting node to all nodes\nof the graph. Initially, the distance to the starting node is 0 and the distance to all other nodes in infinite. The algorithm reduces the distances by finding edges that shorten the paths until it is not possible to reduce any distance\n\nThe algorithm is based on the following observation: if we know the shortest path from the starting node to all nodes except one, we can find the shortest path to all nodes by adding one edge to the shortest path. The algorithm iterates through all edges of the graph and relaxes each edge. The relaxation of an edge means that we try to find a shorter path to the destination node of the edge by going through the source node of the edge. The algorithm repeats this process for a number of iterations, which is equal to the number of nodes in the graph. If the algorithm finds a shorter path to a node, it means that the graph contains a negative cycle. The algorithm can detect this by keeping track of the number of iterations. If the number of iterations is equal to the number of nodes in the graph, the graph contains a negative cycle.\n\n```python\ndef bellman_ford(graph, source):\n    distance, predecessor = dict(), dict()\n    for node in graph:\n        distance[node] = float('inf')\n        predecessor[node] = None\n    distance[source] = 0\n    for _ in range(len(graph) - 1):\n        for u, v in graph.edges:\n            if distance[u] + graph.edges[u, v] \u003C distance[v]:\n                distance[v] = distance[u] + graph.edges[u, v]\n                predecessor[v] = u\n    for u, v in graph.edges:\n        assert distance[u] + graph.edges[u, v] >= distance[v]\n    return distance, predecessor\n```\n\nThe time complexity of the algorithm is $O(nm)$, because the algorithm consists of `n âˆ’ 1` rounds and iterates through all `m` edges during a round. If there are no negative cycles in the graph, all distances are final after `n âˆ’ 1` rounds, because each shortest path can contain at most `n âˆ’ 1` edges.\n\nIn practice, the final distances can usually be found faster than in `n âˆ’ 1` rounds. Thus, a possible way to make the algorithm more efficient is to stop the algorithm if no distance can be reduced during a round.\n\n> **Note:** We need to use this algorithm when the graph contains negative edges. If the graph contains only positive edges, we can use Dijkstra's algorithm, which is more efficient.\n\n### Dijkstra's Algorithm\n\nDijkstraâ€™s algorithm finds shortest paths from the starting node to all nodes of the graph, like the Bellmanâ€“Ford algorithm. The benefit of Dijkstra's algorithm is that it is more efficient and can be used for processing large graphs. However, the algorithm requires that there are no negative weight edges in the graph.\n\nLike the Bellmanâ€“Ford algorithm, Dijkstraâ€™s algorithm maintains distances\nto the nodes and reduces them during the search. Dijkstraâ€™s algorithm is efficient, because it only processes each edge in the graph once, using the fact that there are no negative edges.\n\nAn efficient implementation of Dijkstraâ€™s algorithm requires that it is possible to efficiently find the minimum distance node that has not been processed. An appropriate data structure for this is a priority queue that contains the nodes ordered by their distances. Using a priority queue, the next node to be processed can be retrieved in logarithmic time\n\n```python\ndef dijkstra(graph, source):\n    distance, predecessor = dict(), dict()\n    for node in graph:\n        distance[node] = float('inf')\n        predecessor[node] = None\n    distance[source] = 0\n    queue = PriorityQueue()\n    queue.put((0, source))\n    while not queue.empty():\n        _, u = queue.get()\n        for v in graph[u]:\n            alt = distance[u] + graph.edges[u, v]\n            if alt \u003C distance[v]:\n                distance[v] = alt\n                predecessor[v] = u\n                queue.put((alt, v))\n    return distance, predecessor\n```\n\nThe time complexity of the above implementation is $O(n + m \\log m)$, because\nthe algorithm goes through all nodes of the graph and adds for each edge at most one distance to the priority queue.\n\n### Floyd-Warshall\n\nThe Floydâ€“Warshall algorithm provides an alternative way to approach the\nproblem of finding shortest paths. Unlike the other algorithms of this chapter, it finds all shortest paths between the nodes in a single run.\n\nThe algorithm maintains a two-dimensional array that contains distances\nbetween the nodes. First, distances are calculated only using direct edges between the nodes, and after this, the algorithm reduces distances by using intermediate nodes in paths.\n\nThe advantage of the Floydâ€“Warshall algorithm that it is easy to implement. The following code constructs a distance matrix where `distance[a][b]` is the shortest distance between nodes a and b. First, the algorithm initializes distance using the adjacency matrix adj of the graph:\n\n```python\ndef floyd_warshall(graph):\n    distance = {u: {v: float('inf') for v in graph} for u in graph}\n    for u in graph:\n        distance[u][u] = 0\n    for u, v in graph.edges:\n        distance[u][v] = graph.edges[u, v]\n    for k in graph:\n        for i in graph:\n            for j in graph:\n                distance[i][j] = min(distance[i][j], distance[i][k] + distance[k][j])\n    return distance\n```\n\nThe time complexity of the algorithm is $O(n^3)$, because it contains three\nnested loops that go through the nodes of the graph. Since the implementation of the Floydâ€“Warshall algorithm is simple, the algorithm can be a good choice even if it is only needed to find a single shortest path in the graph. However, the algorithm can only be used when the graph is so\nsmall that a cubic time complexity is fast enough.\n\n# Recursion\n\nWhile there are a large number of recursive problems, many follows similar patterns. A good hint that a problem is recursive is that it can be built of sub-problems of the same type.\n\nWhen you hear a problem beginning with the following statements, it's often (though not always) a good candidate for recursion:\n\n- _Design an algorithm to compute the nth ..._\n- _Write code to list the first n ..._\n- _Implement a method to compute all ..,_\n\nRecursive solutions, by definition, are built off of solutions to subproblems. Many times, this will mean simply to compute $f(n)$ by adding something, removing something, or otherwise changing the solution\nfor $f(n-1)$. In other cases, you might solve the problem for the first half of the data set, then the second half, and then merge those results.\nThere are many ways you might divide a problem into subproblems.Three of the most common approaches to develop an algorithm are bottom-up, top-down, and half-and-half.\n\n## Bottom-Up\n\nThe bottom-up approach is often the most intuitive. We start with knowing how to solve the problem for a simple case, like a list with only one element. Then we figure out how to solve the problem for two\nelements, then for three elements, and so on. The key here is to think about how you can build the solution for one case off of the previous case (or multiple previous cases).\n\n## Top-Down\n\nThe top-down approach can be more complex since it's less concrete. But sometimes, it's the best way to think about the problem.\n\nIn these problems, we think about how we can divide the problem for case `N` into subproblems. Be careful of overlap between the cases.\n\n## Half-and-Half\n\nIn addition to top-down and bottom-up approaches, it's often effective to divide the data set in half.\n\nFor example, binary search works with a \"half-and-half\" approach. When we look for an element in a sorted array, we first figure out which half of the array contains the value. Then we recurse and search for it in that half.\n\nMerge sort is also a \"half-and-half\" approach. We sort each half of the array and then merge together the\nsorted halves.\n\n## Recursion vs. Iteration\n\nRecursive algorithms can be very space inefficient. Each recursive call adds a new layer to the stack, which means that if your algorithm recurses to a depth of `n`, it uses at least $O(n)$ memory.\n\nFor this reason, it's often better to implement a recursive algorithm iteratively. All recursive algorithms can be implemented iteratively, although sometimes the code to do so is much more complex. Before diving\ninto recursive code, ask yourself how hard it would be to implement it iteratively,\n\n# Dynamic Programming\n\nDynamic programming is a technique that combines the correctness of complete search and the efficiency of greedy algorithms. Dynamic programming can be applied if the problem can be divided into overlapping subproblems that can be solved independently.\n\nThere are two uses for dynamic programming:\n\n- **Finding an optimal solution**: We want to find a solution that is as large as possible or as small as possible.\n- **Counting the number of solutions:** We want to calculate the total number of possible solutions.\n\n\u003C!-- # Greedy\n\n# Intervals -->\n\n# Bit Manipulation\n\nAll data in computer programs is internally stored as bits, i.e., as numbers 0 and 1. In programming, an n bit integer is internally stored as a binary number that consists of `n` bits. For example, the `C++` type int is a `32-bit` type, which means that every `int` number consists of 32 bits.\n\nThe bits in the representation are indexed from right to left. To convert a bit representation $b_k Â· Â· Â· b_2 b_1 b_0 into a number, we can use the formula\n\n$$ \\sum\\_{i=0}^k b_i 2^i $$\n\nFor example, the number 13 is represented as 1101 in binary. To convert it to a decimal number, we can use the formula:\n\n$$ 1 \\cdot 2^3 + 1 \\cdot 2^2 + 0 \\cdot 2^1 + 1 \\cdot 2^0 = 8 + 4 + 0 + 1 = 13 $$\n\nThe following code converts a binary number to a decimal number:\n\n```python\ndef binary_to_decimal(binary):\n    decimal = 0\n    for digit in binary:\n        decimal = decimal * 2 + int(digit)\n    return decimal\n```\n\nThe time complexity of the above implementation is $O(n)$, where $n$ is the length of the binary number.\n\nThe bit representation of a number is either signed or unsigned. Usually a signed representation is used, which means that both negative and positive numbers can be represented. signed variable of n bits can contain any integer\nbetween $-2^{n-1}$ and $2^{n-1} - 1$. For example, the `C++` type `int` is a signed `32-bit` type, which means that it can contain any integer between $-2^{31}$ and $2^{31} - 1$.\n\nThe first bit in a signed representation is the sign of the number (`0` for nonnegative numbers and `1` for negative numbers), and the remaining `nâˆ’1` bits contain the magnitude of the number. Twoâ€™s complement is used, which means that the opposite number of a number is calculated by first inverting all the bits in the number, and then increasing the number by one.\n\nFor example, the number 13 is represented as 1101 in binary. To convert it to a twoâ€™s complement representation, we first invert all the bits:\n\n$$ \\overline{1101} = 0010 $$\n\nThen we increase the number by one:\n\n$$ 0010 + 1 = 0011 $$\n\nThe result is the twoâ€™s complement representation of the number 13, which is 0011. The number -13 is represented as 1101 in binary. To\n\nIn an unsigned representation, only nonnegative numbers can be used, but the upper bound for the values is larger. An unsigned variable of `n` bits can contain any integer between 0 and $2^n - 1$. For example, the `C++` type `unsigned int` is an unsigned `32-bit` type, which means that it can contain any integer between 0 and $2^{32} - 1$.\n\n## Bitwise Operators\n\n### Bitwise AND\n\nThe bitwise AND operator `&` compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of both numbers are `1`.\n\nFor example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise AND of 13 and 7 is 0101, which is the number 5.\n\n```python\ndef bitwise_and(a, b):\n    return a & b\n```\n\n### Bitwise OR\n\nThe bitwise OR operator `|` compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are `1`.\n\nFor example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise OR of 13 and 7 is 1111, which is the number 15.\n\n```python\ndef bitwise_or(a, b):\n    return a | b\n```\n\n### Bitwise XOR\n\nThe bitwise XOR operator `^` compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are `1`, but not both.\n\nFor example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise XOR of 13 and 7 is 1010, which is the number 10.\n\n```python\ndef bitwise_xor(a, b):\n    return a ^ b\n```\n\n### Bitwise NOT\n\nThe bitwise NOT operator `~` inverts all the bits of its operand.\n\nFor example, the number 13 is represented as 1101 in binary. The bitwise NOT of 13 is 0010, which is the number 2.\n\n```python\ndef bitwise_not(a):\n    return ~a\n```\n\n### Bitwise Shifts\n\nThe bitwise left shift operator `\u003C\u003C` shifts the bits of its first operand the specified number of positions to the left. The bits shifted off the left end are discarded. The bits on the right end are filled with zeros.\n\nFor example, the number 13 is represented as 1101 in binary. The bitwise left shift of 13 by 1 is 1010, which is the number 10.\n\n```python\ndef bitwise_left_shift(a, b):\n    return a \u003C\u003C b\n```\n\nThe bitwise right shift operator `>>` shifts the bits of its first operand the specified number of positions to the right. The bits shifted off the right end are discarded. The bits on the left end are filled with zeros.\n\nFor example, the number 13 is represented as 1101 in binary. The bitwise right shift of 13 by 1 is 0110, which is the number 6.\n\n```python\ndef bitwise_right_shift(a, b):\n    return a >> b\n```\n\n## Bitwise Tricks\n\n### Check if a number is even or odd\n\nA number is even if the last bit is `0` and odd if the last bit is `1`. We can check if a number is even or odd by checking the last bit of the number. If the last bit is `0`, the number is even, otherwise, it is odd.\n\n```python\ndef is_even(a):\n    return a & 1 == 0\n```\n\n### Check if a number is a power of two\n\nA number is a power of two if it has only one bit set to `1`. We can check if a number is a power of two by checking if the number has only one bit set to `1`.\n\n```python\ndef is_power_of_two(a):\n    return a & (a - 1) == 0\n```\n\n### Swap two numbers\n\nWe can swap two numbers by using the bitwise XOR operator `^`. The bitwise XOR of two numbers is `0` if the two numbers are the same, and it is `1` if the two numbers are different. We can use this property to swap two numbers.\n\n```python\ndef swap(a, b):\n    a ^= b\n    b ^= a\n    a ^= b\n    return a, b\n```\n\n### Get the last set bit\n\nWe can get the last set bit of a number by using the bitwise AND operator `&` with the twoâ€™s complement of the number.\n\n```python\ndef get_last_set_bit(a):\n    return a & -a\n```\n\n### Hamming distance\n\nThe Hamming distance between two integers is the number of positions at which the corresponding bits are different.\n\nGiven two integers `x` and `y`, calculate the Hamming distance.\n\n```python\ndef hamming_distance(x, y):\n    return bin(x ^ y).count('1')\n```\n\n### Count the number of set bits\n\nWe can count the number of set bits in a number by repeatedly clearing the last set bit of the number until the number becomes `0`.\n\n```python\ndef count_set_bits(a):\n    count = 0\n    while a:\n        a &= a - 1\n        count += 1\n    return count\n```\n\n### Reverse bits\n\nWe can reverse the bits of a number by repeatedly shifting the number to the right and appending the last bit to the result.\n\n```python\ndef reverse_bits(a):\n    result = 0\n    for _ in range(32):\n        result = (result \u003C\u003C 1) | (a & 1)\n        a >>= 1\n    return result\n```","src/data/blog/howtoasd.md","a314d6ee79f32d79",{"html":348,"metadata":349},"\u003Ch2 id=\"arrays\">Arrays\u003C/h2>\n\u003Cp>Arrays are a collection of values. They are ordered and can be accessed by index. Arrays are zero-indexed, meaning the first element is at index 0. Arrays can be of any type, including other arrays.\u003C/p>\n\u003Ch2 id=\"hashtable\">HashTable\u003C/h2>\n\u003Cp>An HashTable is a data structure that maps keys to values for highly efficient lookup. It is a structure that can be implemented with arrays, linked lists, binary search trees (in this case we would have \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n \\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> lookup time. The advantage of this is potentially using less space, since we no longer allocate a large array. We can also iterate through the keys i order, which can be useful sometimes), or hash tables.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">HashTable \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>or if we want to use defaultdict\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> collections \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">import\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> defaultdict\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">HashTable \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> defaultdict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">int\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># a default value of 0 is assigned to all keys\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"arraylist--resizablearray\">ArrayList &#x26; ResizableArray\u003C/h2>\n\u003Cp>When you need an array-like data structure that offers dynamic resizing, you would usually use an Arraylist. An Arraylist is an array that resizes itself as needed while still providing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> access.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Array \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\">None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1000\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># array of 1000 elements, all None\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch1 id=\"binary-search\">Binary Search\u003C/h1>\n\u003Cp>Binary search is a search algorithm that finds the position of a target value within a sorted array. Binary search compares the target value to the middle element of the array. If they are not equal, the half in which the target cannot lie is eliminated and the search continues on the remaining half, again taking the middle element to compare to the target value, and repeating this until the target value is found. If the search ends with the remaining half being empty, the target is not in the array.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> binary_search\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> target\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        mid \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> right) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">//\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> target\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> mid\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        elif\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> target\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> mid \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        else\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> mid \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"algorithms\">Algorithms\u003C/h2>\n\u003Ch3 id=\"quickselect\">QuickSelect\u003C/h3>\n\u003Cp>QuickSelect is a selection algorithm to find the k-th smallest/largest element in an unordered list. It is related to the quick sort sorting algorithm.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> quick_select\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    pivot \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> random\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">choice\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> pivot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    middle \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> pivot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> pivot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> quick_select\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">,\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> k\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    elif\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">middle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> middle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    else\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> quick_select\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">,\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">middle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch1 id=\"stack\">Stack\u003C/h1>\n\u003Cp>The stack data structure is precisely what it sounds like: a stack of data. In certain types of problems, it can be favorable to store data in a stack rather than in an array.\u003C/p>\n\u003Cp>A stack uses LIFO (last-in first-out) ordering. That is, as in a stack of dinner plates, the most recent item added to the stack is the first item to be removed.\u003C/p>\n\u003Cp>It uses the following operations:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>push(item)\u003C/code>: adds an item to the top of the stack\u003C/li>\n\u003Cli>\u003Ccode>pop()\u003C/code>: removes the top item from the stack\u003C/li>\n\u003Cli>\u003Ccode>peek()\u003C/code>: returns the top of the stack without removing it\u003C/li>\n\u003Cli>\u003Ccode>isEmpty()\u003C/code>: returns true if and only if the stack is empty\u003C/li>\n\u003C/ul>\n\u003Cp>Unlike an array, a stack does not offer constant-time access to the ith item. However, it does allow constant-time adds and removes, as it doesnâ€™t require shifting elements around.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># add to the top of the stack\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># remove from the top of the stack\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">pop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>One case where stacks are often useful is in certain recursive algorithms. Sometimes you need to push temporary data onto a stack as you recurse, but then remove them as you backtrack (for example, because the recursive check failed). A stack offers an intuitive way to do this.\u003C/p>\n\u003Cp>A stack can also be used to implement a recursive algorithm iteratively.\u003C/p>\n\u003Ch2 id=\"queue\">Queue\u003C/h2>\n\u003Cp>A queue is an ordered collection of items where the addition of new items happens at one end, called the â€œrear,â€ and the removal of existing items occurs at the other end, commonly called the â€œfront.â€ As an element enters the queue it starts at the rear and makes its way toward the front, waiting until that time when it is the next element to be removed.\u003C/p>\n\u003Cp>It uses the following operations:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>add(item)\u003C/code>: adds an item to the rear of the queue\u003C/li>\n\u003Cli>\u003Ccode>remove()\u003C/code>: removes the front item from the queue\u003C/li>\n\u003Cli>\u003Ccode>peek()\u003C/code>: returns the front of the queue without removing it\u003C/li>\n\u003Cli>\u003Ccode>isEmpty()\u003C/code>: returns true if and only if the queue is empty\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> collections \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">import\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> deque\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> deque\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> # double-ended queue\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A queue can also be implemented with a linked list. In fact, they are essentially the same thing, as long as items are added and removed from opposite sides.\u003C/p>\n\u003Cp>One place where queues are often used is in breadth-first search or in implementing a cache. In breadth-first search, for example, we used a queue to store a list of the nodes that we need to process. Each time we process a node, we add its adjacent nodes to the back of the queue. This allows us to process nodes in the order in which they are viewed.\u003C/p>\n\u003Ch1 id=\"linked-list\">Linked List\u003C/h1>\n\u003Cp>A Linked list is a data structure that represents a sequence of nodes. In as singly linked list, each node points to the next node in the linked list. In a doubly linked list, each node points to the next node and the previous node. In a circular linked list, the tail node points to the head node.\u003C/p>\n\u003Cp>Unlike an array, a linked list does not provide costant access time to a particolar index within the list. This means, that if youâ€™d like to find the kth element in a linked list, youâ€™d have to traverse the list from the head node to the kth node. This is because the nodes in a linked list are not stored in contiguous memory locations.\u003C/p>\n\u003Ch2 id=\"singly-linked-list\">Singly Linked List\u003C/h2>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># Definition for singly-linked list.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In this implementation, the head node is the first node in the linked list. The tail node is the last node in the linked list. The tail nodeâ€™s next pointer points to None.\u003C/p>\n\u003Ch2 id=\"techniques\">Techniques\u003C/h2>\n\u003Cul>\n\u003Cli>Slow and Fast Pointer\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cem>This is a technique that is used to solve problems that involve linked list traversal. The slow pointer moves one node at a time, while the fast pointer moves two nodes at a time. This technique is used to find the middle node of a linked list, or to determine if a linked list has a cycle.\u003C/em>\u003C/p>\n\u003Cul>\n\u003Cli>Dummy linked list\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">dummy \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>Check if has a cycle\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> hasCycle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> head\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> ->\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    slow \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> head\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">and\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        slow \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> slow\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        fast \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> slow \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>Reverse a linked list\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> reverseList\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> head\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> ->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ListNode:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    prev\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> head\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        temp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        curr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> prev\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        prev \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        curr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> temp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> prev\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>Sometimes itâ€™s useful to split a linked list into two parts\u003C/li>\n\u003C/ul>\n\u003Ch1 id=\"trees\">Trees\u003C/h1>\n\u003Cp>A nice way to understand a tree is with a recursive explanation. A tree is a data structure composed of nodes.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>Each tree has a root node. (Actually, this isnâ€™t strictly necessary in graph theory, but itâ€™s usually how we use trees in programming)\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The root node has zero or more child nodes.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>Each child node has zero or more child nodes, and so on.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>The tree cannot contain cycles. The nodes may or may not be in a particular order, they could have any data type as values, and they may or may not have links back to their parent nodes.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> TreeNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">children \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"binary-tree\">Binary Tree\u003C/h2>\n\u003Cp>A binary tree is a tree in which each node has up to two children. Not all trees are binary trees. There are occasions when you might have a tree that is not a binary tree. For example, suppose you were using a tree to represent a bunch of phone numbers. In this case, you might use a 10-ary tree, with each node having up to 10 children (one for each digit}.\nA node is called a â€œleafâ€ node if it has no children.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> BinaryTreeNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"binary-search-tree\">Binary Search Tree\u003C/h2>\n\u003Cp>A binary search tree is a binary tree in which every node fits a specific ordering property: \u003Cem>all left descendents\u003C/em> \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>â‰¤\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo>&#x3C;\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\leq n &#x3C;\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰¤\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">&#x3C;\u003C/span>\u003C/span>\u003C/span>\u003C/span> \u003Cem>all right descendents\u003C/em>. This must be true for each node \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Note that this inequality must be true for all of a nodeâ€™s descendents, not just its immediate children\u003C/p>\n\u003Cblockquote>\n\u003Cp>The definition of a binary search tree can vary slightly with respect to equality. Under some definitions, the tree cannot have duplicate values. In others, the duplicate values will be on the right or can be on either side. All are valid definitions, but you should clarify this with your interviewer.\u003C/p>\n\u003C/blockquote>\n\u003Ch3 id=\"balanced-vs-unbalanced\">Balanced vs Unbalanced\u003C/h3>\n\u003Cp>While many trees are balanced, not all are. Note that balancing a tree does not mean the left and right subtrees are exactly the same size (like you see under â€œperfect binary treesâ€)\u003C/p>\n\u003Cp>One way to think about it is that a â€œbalancedâ€ tree really means something more like â€œnot terribly imbalanced:â€™ Itâ€™s balanced enough to ensure \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(\\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> times for insert and find, but itâ€™s not necessarily as balanced as it could be.\u003C/p>\n\u003Ch3 id=\"complete-binary-tree\">Complete Binary Tree\u003C/h3>\n\u003Cp>A complete binary tree is a binary tree in which every level of the tree is fully filled, except for perhaps the last level. lo the extent that the last level is filled, it is filled left to right.\u003C/p>\n\u003Ch3 id=\"full-binary-tree\">Full Binary Tree\u003C/h3>\n\u003Cp>A full binary tree is a binary tree in which every node has either zero or two children. That is, no nodes have only one child.\u003C/p>\n\u003Ch3 id=\"perfect-binary-tree\">Perfect Binary Tree\u003C/h3>\n\u003Cp>A perfect binary tree is one that is both full and complete. All leaf nodes will be at the same level, and this level has the maximum number of nodes.\u003C/p>\n\u003Ch2 id=\"binary-tree-traversal\">Binary Tree Traversal\u003C/h2>\n\u003Ch3 id=\"in-order-traversal\">In-order Traversal\u003C/h3>\n\u003Cp>In-order traversal means to â€œvisitâ€ (often, print) the left branch, then the current node, and finally, the right branch.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> inOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">inOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">inOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"pre-order-traversal\">Pre-order Traversal\u003C/h3>\n\u003Cp>Pre-order traversal visits the current node before its child nodes (hence the name â€œpre-orderâ€).\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> preOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">preOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">preOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"post-order-traversal\">Post-order Traversal\u003C/h3>\n\u003Cp>Post-order traversal visits the current node after its child nodes (hence the name â€œpost-orderâ€).\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> postOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">postOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">postOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"level-order-traversal\">Level-order Traversal\u003C/h3>\n\u003Cp>Level-order traversal visits the nodes level by level. Youâ€™ll often see this done with a queue.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> levelOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> not\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">pop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"binary-heaps-min-heap-and-max-heap\">Binary Heaps (min-heap and max-heap)\u003C/h2>\n\u003Cp>Weâ€™ll just discuss min-heaps here. Max-heaps are essentially equivalent, but the elements are in descending order rather than ascending order\u003C/p>\n\u003Cp>A min-heap is a complete binary tree (that is, totally filled other than the rightmost elements on the last level) where each node is smaller than its children. The root, therefore, is the minimum element in the tree.\u003C/p>\n\u003Cp>We have two key operations on a min-heap: \u003Ccode>insert\u003C/code> and \u003Ccode>extract_min\u003C/code>.\u003C/p>\n\u003Ch3 id=\"insert\">Insert\u003C/h3>\n\u003Cp>When we insert into a min-heap, we always start by inserting the element at the bottom. We insert at the rightmost spot so as to maintain the complete tree property.\u003C/p>\n\u003Cp>Then, we â€œfixâ€ the tree by swapping the new element with its parent, until we find an appropriate spot for the element We essentially bubble up the minimum element.\u003C/p>\n\u003Cp>This takes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(\\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time, where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> is the number of elements in the heap.\u003C/p>\n\u003Ch3 id=\"extract-min\">Extract Min\u003C/h3>\n\u003Cp>Finding the minimum element of a min-heap is easy: itâ€™s always at the top. The trickier part is how to remove it. (In fact, this isnâ€™t that tricky.)\u003C/p>\n\u003Cp>First, we remove the minimum element and swap it with the last element in the heap (the bottommost, rightmost element). Then, we bubble down this element, swapping it with one of its children until the min-heap property is restored.\u003C/p>\n\u003Cp>Do we swap it with the left child or the right child? That depends on their values. Thereâ€™s no inherent ordering between the left and right element, but youâ€™ll need to take the smaller one in order to maintain the min-heap ordering.\u003C/p>\n\u003Cp>This takes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(\\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time.\u003C/p>\n\u003Ch1 id=\"tries\">Tries\u003C/h1>\n\u003Cp>A trie (sometimes called a prefix tree} is a funny data structure. It comes up a lot in interview questions, but algorithm textbooks donâ€™t spend much time on this data structure.\u003C/p>\n\u003Cp>A trie is a variant of an n-ary tree in which characters are stored at each node. Each path down the tree may represent a word.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> TrieNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">children \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">is_word \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>* nodes\u003C/code> (sometimes called â€œnull nodesâ€) are often used to indicate complete words. For example, the fact that there is a \u003Ccode>* node\u003C/code> under \u003Ccode>MANY\u003C/code> indicates that \u003Ccode>MANY\u003C/code> is a complete word. The existence of the \u003Ccode>MA\u003C/code> path\nindicates there are words that start with \u003Ccode>MA\u003C/code>.\u003C/p>\n\u003Cp>The actual implementation of these \u003Ccode>* nodes\u003C/code> might be a special type of child (such as a \u003Ccode>TerminatingTrieNode\u003C/code>, which inherits from \u003Ccode>TrieNode\u003C/code>. Or, we could use just a boolean flag terminates within the â€œparentâ€ node.\u003C/p>\n\u003Cp>A node in a trie could have anywhere from 1 through \u003Ccode>ALPHABET_SIZE + 1\u003C/code> children (or, \u003Ccode>O\u003C/code> through \u003Ccode>ALPHABET_SIZE\u003C/code> if a boolean flag is used instead of a \u003Ccode>* node\u003C/code>).\u003C/p>\n\u003Cp>Very commonly, a trie is used to store the entire (English) language for quick prefix lookups. While a hash table can quickly look up whether a string is a valid word, it cannot tell us if a string is a prefix of any valid words. A trie can do this very quickly.\u003C/p>\n\u003Cblockquote>\n\u003Cp>How quickly? A trie can check if a string is a valid prefix in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>K\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(K)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time, where K is the length of the string. This is actually the same runtime as a hash table will take. Although we often refer to hash table lookups as being \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time, this isnâ€™t entirely true. A hash table must read through all the characters in the input which takes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>K\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(K)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time in the case of a word lookup\u003C/p>\n\u003C/blockquote>\n\u003Cp>Many problems involving lists of valid words leverage a trie as an optimization. In situations when we search through the tree on related prefixes repeatedly\u003C/p>\n\u003Ch1 id=\"backtracking\">Backtracking\u003C/h1>\n\u003Cp>Backtracking is a general algorithm for finding all (or some) solutions to some computational problems, notably constraint satisfaction problems, that incrementally builds candidates to the solutions, and abandons each partial candidate (â€œbacktracksâ€) as soon as it determines that the candidate cannot possibly be completed to a valid solution.\u003C/p>\n\u003Cul>\n\u003Cli>Sometimes is useful to think of backtracking as an intelligent â€œbrute forceâ€ approach.\u003C/li>\n\u003Cli>Recursive DFS is often a good way to implement backtracking\u003C/li>\n\u003Cli>Itâ€™s usually a good idea to start by writing a recursive backtracking every time you see a subset, combination, permutation, or partition problem.\u003C/li>\n\u003C/ul>\n\u003Ch1 id=\"graphs\">Graphs\u003C/h1>\n\u003Cp>Many programming problems can be solved by modeling the problem as a graph\nproblem and using an appropriate graph algorithm.\u003C/p>\n\u003Cp>Atree is actually a type of graph, but not all graphs are trees. Simply put, a tree isa connected graph without cycles. A graph is simply a collection d nodes with edges between (some of) them.\u003C/p>\n\u003Cul>\n\u003Cli>Graphs can be either \u003Cstrong>directed\u003C/strong> or \u003Cstrong>undirected\u003C/strong>. While directed edges are like a one-way street, undirected edges are like a two-way street.\u003C/li>\n\u003Cli>The graph might consist of multiple isolated subgraphs. If there is a path between every pair of vertices, it is called a â€œ\u003Cstrong>connected graph\u003C/strong>â€.\u003C/li>\n\u003Cli>The graph can also have cycles (or not). An â€œ\u003Cstrong>acyclic graph\u003C/strong>â€ is one without cycles\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"adjacency-lists\">Adjacency Lists\u003C/h2>\n\u003Cp>This is the most common way to represent a graph. Every vertex (or node) stores a list of adjacent vertices. In an undirected graph, an edge like \u003Ccode>(a, b)\u003C/code> would be stored twice: once in \u003Ccode>a\u003C/code>â€™s adjacent vertices and once in \u003Ccode>b\u003C/code>â€™s adjacent vertices.\u003C/p>\n\u003Cp>A simple class definition for a graph node could look essentially the same as a tree node.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> Graph\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">nodes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> Node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> neighbors\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">neighbors \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> neighbors \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> neighbors \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">is\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> not\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>You donâ€™t necessarily need any additional classes to represent a graph. An array (or a hash table) of lists (arrays, arraylists, linked lists, etc.) can store the adjacency list.\u003C/p>\n\u003Ch2 id=\"adjacency-matrix\">Adjacency Matrix\u003C/h2>\n\u003Cp>An adjacency matrix is an \u003Ccode>NxN\u003C/code> boolean matrix (where \u003Ccode>N\u003C/code> is the number of nodes), where a true value at \u003Ccode>matrix[i][j]\u003C/code> indicates an edge from node \u003Ccode>i\u003C/code> to node \u003Ccode>j\u003C/code>. (You can also use an integer matrix with Os and 1s.)\u003C/p>\n\u003Cp>Note that in an undirected graph, an adjacency matrix will be symmetric. In a directed graph, it will not (necessarily) be.\u003C/p>\n\u003Cp>The same graph algorithms that are used on adjacency lists (breadth-first search, etc.) can be performed with adjacency matrices, but they may be somewhat less efficient. In the adjacency list representation, you can easily iterate through the neighbors of a node. In the adjacency matrix representation, you will need to iterate through all the nodes to identify a nodeâ€™s neighbors.\u003C/p>\n\u003Ch2 id=\"graph-search\">Graph Search\u003C/h2>\n\u003Cp>The two most common ways to search a graph are \u003Cstrong>depth-first search\u003C/strong> and \u003Cstrong>breadth-first search\u003C/strong>.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>In depth-first search (DFS), we start at the root (or another arbitrarily selected node) and explore each branch completely before moving on to the next branch. That is. we go deep first (hence the name depth-first search) before we go wide.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>In breadth-first search (BFS), we start at the root (or another arbitrarily selected node) and explore each neighbor before going on to any of their children. That is, we go wide (hence breadth-first search) before\nwe go deep.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>Breadth-first search and depth-first search tend to be used in different scenarios. DFS is often preferred if we want to visit every node in the graph. Both will work just fine, but depth-first search is a bit simpler. However, if we want to find the shortest path (or just any path) between two nodes, BFS is generally better.\u003C/p>\n\u003Ch3 id=\"dfs\">DFS\u003C/h3>\n\u003Cp>In DFS, we visit a node a and then iterate through each of aâ€™s neighbors. When visiting \u003Ccode>a\u003C/code> node \u003Ccode>b\u003C/code> that is a neighbor of \u003Ccode>a\u003C/code>, we visit all of \u003Ccode>b\u003C/code>â€™s neighbors before going on to \u003Ccode>a\u003C/code>â€™s other neighbors. That is, a exhaustively\nsearches \u003Ccode>b\u003C/code>â€™s branch before any of its other neighbors.\u003C/p>\n\u003Cp>Note that pre-order and other forms of tree traversal are a form of DFS. The key difference is that when implementing this algorithm for a graph, we must check if the node has been visited. If we donâ€™t, we risk getting stuck in an infinite loop.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dfs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">is\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">    visit\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> next\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">adjacent\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">            dfs\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bfs\">BFS\u003C/h3>\n\u003Cp>BFS is a bit less intuitive. The main tripping point is the (false) assumption that BFS is recursive. Itâ€™s not. Instead, it uses a queue.\u003C/p>\n\u003Cp>In BFS, node a visits each of aâ€™s neighbors before visiting any of their neighbors. You can think of this as searching level by level out from a. An iterative solution involving a queue usually works best.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bfs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> start\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">start\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    start\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        r \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">pop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">        visit\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">r\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">adjacent\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If you are asked to implement BFS, the key thing to remember is the use of the queue. The rest of the algorithm flows from this fact.\u003C/p>\n\u003Ch3 id=\"bidirectional-search\">Bidirectional Search\u003C/h3>\n\u003Cp>Bidirectional search is used to find the shortest path between a source and destination node. It operates by essentially running two simultaneous breadth-first searches, one from each node. When their searches collide, we have found a path.\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.imgur.com/AQTtl8H.png\" alt=\"\">\u003C/p>\n\u003Cp>To see why this is faster, consider a graph where every node has at most k adjacent nodes and the shortest path from node s to node t has length d.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>In traditional breadth-first search, we would search up to \u003Ccode>k\u003C/code> nodes in the first â€œlevelâ€ of the search. In the second level, we would search up to \u003Ccode>k\u003C/code> nodes for each of those first \u003Ccode>k\u003C/code> nodes, so \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k^2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> nodes total (thus far).\nWe would do this \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">d\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">d\u003C/span>\u003C/span>\u003C/span>\u003C/span> times, so thatâ€™s \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmi>d\u003C/mi>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^d)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0991em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8491em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> nodes.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>In bidirectional search, we have two searches that collide after approximately \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">d/2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">d\u003C/span>\u003Cspan class=\"mord\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span> levels (the midpoint of the path). The search from \u003Ccode>s\u003C/code> visits approximately \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k^{d/2}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.888em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003Cspan class=\"mord mtight\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, as does the search from \u003Ccode>t\u003C/code>. Thatâ€™s approximately \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^{d/2})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.138em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003Cspan class=\"mord mtight\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> nodes total.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>So the the bidirectional search is actually faster by a factor of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k^{d/2}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.888em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003Cspan class=\"mord mtight\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Ch3 id=\"topological-sort\">Topological Sort\u003C/h3>\n\u003Ch2 id=\"shortest-path\">Shortest Path\u003C/h2>\n\u003Cp>Finding a shortest path between two nodes of a graph is an important problem\nthat has many practical applications. For example, a natural problem related to a road network is to calculate the shortest possible length of a route between two cities, given the lengths of the roads.\u003C/p>\n\u003Cp>In an unweighted graph, the length of a path equals the number of its edges,\nand we can simply use breadth-first search to find a shortest path. However, we focus on weighted graphs where more sophisticated algorithms are needed for finding shortest paths\u003C/p>\n\u003Ch3 id=\"bellman-ford\">Bellman-Ford\u003C/h3>\n\u003Cp>The Bellmanâ€“Ford algorithm finds shortest paths from a starting node to all\nnodes of the graph. The algorithm can process all kinds of graphs, provided that the graph does not contain a cycle with negative length. If the graph contains a negative cycle, the algorithm can detect this.\u003C/p>\n\u003Cp>The algorithm keeps track of distances from the starting node to all nodes\nof the graph. Initially, the distance to the starting node is 0 and the distance to all other nodes in infinite. The algorithm reduces the distances by finding edges that shorten the paths until it is not possible to reduce any distance\u003C/p>\n\u003Cp>The algorithm is based on the following observation: if we know the shortest path from the starting node to all nodes except one, we can find the shortest path to all nodes by adding one edge to the shortest path. The algorithm iterates through all edges of the graph and relaxes each edge. The relaxation of an edge means that we try to find a shorter path to the destination node of the edge by going through the source node of the edge. The algorithm repeats this process for a number of iterations, which is equal to the number of nodes in the graph. If the algorithm finds a shorter path to a node, it means that the graph contains a negative cycle. The algorithm can detect this by keeping track of the number of iterations. If the number of iterations is equal to the number of nodes in the graph, the graph contains a negative cycle.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bellman_ford\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> source\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">inf\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">source\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> _ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> range\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        assert\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the algorithm is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>m\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nm)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">nm\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, because the algorithm consists of \u003Ccode>n âˆ’ 1\u003C/code> rounds and iterates through all \u003Ccode>m\u003C/code> edges during a round. If there are no negative cycles in the graph, all distances are final after \u003Ccode>n âˆ’ 1\u003C/code> rounds, because each shortest path can contain at most \u003Ccode>n âˆ’ 1\u003C/code> edges.\u003C/p>\n\u003Cp>In practice, the final distances can usually be found faster than in \u003Ccode>n âˆ’ 1\u003C/code> rounds. Thus, a possible way to make the algorithm more efficient is to stop the algorithm if no distance can be reduced during a round.\u003C/p>\n\u003Cblockquote>\n\u003Cp>\u003Cstrong>Note:\u003C/strong> We need to use this algorithm when the graph contains negative edges. If the graph contains only positive edges, we can use Dijkstraâ€™s algorithm, which is more efficient.\u003C/p>\n\u003C/blockquote>\n\u003Ch3 id=\"dijkstras-algorithm\">Dijkstraâ€™s Algorithm\u003C/h3>\n\u003Cp>Dijkstraâ€™s algorithm finds shortest paths from the starting node to all nodes of the graph, like the Bellmanâ€“Ford algorithm. The benefit of Dijkstraâ€™s algorithm is that it is more efficient and can be used for processing large graphs. However, the algorithm requires that there are no negative weight edges in the graph.\u003C/p>\n\u003Cp>Like the Bellmanâ€“Ford algorithm, Dijkstraâ€™s algorithm maintains distances\nto the nodes and reduces them during the search. Dijkstraâ€™s algorithm is efficient, because it only processes each edge in the graph once, using the fact that there are no negative edges.\u003C/p>\n\u003Cp>An efficient implementation of Dijkstraâ€™s algorithm requires that it is possible to efficiently find the minimum distance node that has not been processed. An appropriate data structure for this is a priority queue that contains the nodes ordered by their distances. Using a priority queue, the next node to be processed can be retrieved in logarithmic time\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dijkstra\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> source\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">inf\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">source\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> PriorityQueue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">put\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">, source)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> not\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">empty\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        _\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">get\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            alt \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> alt \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> alt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">put\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">(alt, v)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the above implementation is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmi>m\u003C/mi>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>m\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n + m \\log m)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">m\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">m\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, because\nthe algorithm goes through all nodes of the graph and adds for each edge at most one distance to the priority queue.\u003C/p>\n\u003Ch3 id=\"floyd-warshall\">Floyd-Warshall\u003C/h3>\n\u003Cp>The Floydâ€“Warshall algorithm provides an alternative way to approach the\nproblem of finding shortest paths. Unlike the other algorithms of this chapter, it finds all shortest paths between the nodes in a single run.\u003C/p>\n\u003Cp>The algorithm maintains a two-dimensional array that contains distances\nbetween the nodes. First, distances are calculated only using direct edges between the nodes, and after this, the algorithm reduces distances by using intermediate nodes in paths.\u003C/p>\n\u003Cp>The advantage of the Floydâ€“Warshall algorithm that it is easy to implement. The following code constructs a distance matrix where \u003Ccode>distance[a][b]\u003C/code> is the shortest distance between nodes a and b. First, the algorithm initializes distance using the adjacency matrix adj of the graph:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> floyd_warshall\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">inf\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">}\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> j \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">i\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> min\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">i\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">j\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">],\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">i\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">k\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">k\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">j\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the algorithm is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>n\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, because it contains three\nnested loops that go through the nodes of the graph. Since the implementation of the Floydâ€“Warshall algorithm is simple, the algorithm can be a good choice even if it is only needed to find a single shortest path in the graph. However, the algorithm can only be used when the graph is so\nsmall that a cubic time complexity is fast enough.\u003C/p>\n\u003Ch1 id=\"recursion\">Recursion\u003C/h1>\n\u003Cp>While there are a large number of recursive problems, many follows similar patterns. A good hint that a problem is recursive is that it can be built of sub-problems of the same type.\u003C/p>\n\u003Cp>When you hear a problem beginning with the following statements, itâ€™s often (though not always) a good candidate for recursion:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cem>Design an algorithm to compute the nth â€¦\u003C/em>\u003C/li>\n\u003Cli>\u003Cem>Write code to list the first n â€¦\u003C/em>\u003C/li>\n\u003Cli>\u003Cem>Implement a method to compute all ..,\u003C/em>\u003C/li>\n\u003C/ul>\n\u003Cp>Recursive solutions, by definition, are built off of solutions to subproblems. Many times, this will mean simply to compute \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> by adding something, removing something, or otherwise changing the solution\nfor \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(n-1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>. In other cases, you might solve the problem for the first half of the data set, then the second half, and then merge those results.\nThere are many ways you might divide a problem into subproblems.Three of the most common approaches to develop an algorithm are bottom-up, top-down, and half-and-half.\u003C/p>\n\u003Ch2 id=\"bottom-up\">Bottom-Up\u003C/h2>\n\u003Cp>The bottom-up approach is often the most intuitive. We start with knowing how to solve the problem for a simple case, like a list with only one element. Then we figure out how to solve the problem for two\nelements, then for three elements, and so on. The key here is to think about how you can build the solution for one case off of the previous case (or multiple previous cases).\u003C/p>\n\u003Ch2 id=\"top-down\">Top-Down\u003C/h2>\n\u003Cp>The top-down approach can be more complex since itâ€™s less concrete. But sometimes, itâ€™s the best way to think about the problem.\u003C/p>\n\u003Cp>In these problems, we think about how we can divide the problem for case \u003Ccode>N\u003C/code> into subproblems. Be careful of overlap between the cases.\u003C/p>\n\u003Ch2 id=\"half-and-half\">Half-and-Half\u003C/h2>\n\u003Cp>In addition to top-down and bottom-up approaches, itâ€™s often effective to divide the data set in half.\u003C/p>\n\u003Cp>For example, binary search works with a â€œhalf-and-halfâ€ approach. When we look for an element in a sorted array, we first figure out which half of the array contains the value. Then we recurse and search for it in that half.\u003C/p>\n\u003Cp>Merge sort is also a â€œhalf-and-halfâ€ approach. We sort each half of the array and then merge together the\nsorted halves.\u003C/p>\n\u003Ch2 id=\"recursion-vs-iteration\">Recursion vs. Iteration\u003C/h2>\n\u003Cp>Recursive algorithms can be very space inefficient. Each recursive call adds a new layer to the stack, which means that if your algorithm recurses to a depth of \u003Ccode>n\u003C/code>, it uses at least \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> memory.\u003C/p>\n\u003Cp>For this reason, itâ€™s often better to implement a recursive algorithm iteratively. All recursive algorithms can be implemented iteratively, although sometimes the code to do so is much more complex. Before diving\ninto recursive code, ask yourself how hard it would be to implement it iteratively,\u003C/p>\n\u003Ch1 id=\"dynamic-programming\">Dynamic Programming\u003C/h1>\n\u003Cp>Dynamic programming is a technique that combines the correctness of complete search and the efficiency of greedy algorithms. Dynamic programming can be applied if the problem can be divided into overlapping subproblems that can be solved independently.\u003C/p>\n\u003Cp>There are two uses for dynamic programming:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>Finding an optimal solution\u003C/strong>: We want to find a solution that is as large as possible or as small as possible.\u003C/li>\n\u003Cli>\u003Cstrong>Counting the number of solutions:\u003C/strong> We want to calculate the total number of possible solutions.\u003C/li>\n\u003C/ul>\n\u003C!-- # Greedy\n\n# Intervals -->\n\u003Ch1 id=\"bit-manipulation\">Bit Manipulation\u003C/h1>\n\u003Cp>All data in computer programs is internally stored as bits, i.e., as numbers 0 and 1. In programming, an n bit integer is internally stored as a binary number that consists of \u003Ccode>n\u003C/code> bits. For example, the \u003Ccode>C++\u003C/code> type int is a \u003Ccode>32-bit\u003C/code> type, which means that every \u003Ccode>int\u003C/code> number consists of 32 bits.\u003C/p>\n\u003Cp>The bits in the representation are indexed from right to left. To convert a bit representation $b_k Â· Â· Â· b_2 b_1 b_0 into a number, we can use the formula\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>âˆ‘\u003C/mo>\u003Cmi mathvariant=\"normal\">_\u003C/mi>\u003Cmsup>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>0\u003C/mn>\u003C/mrow>\u003Cmi>k\u003C/mi>\u003C/msup>\u003Cmsub>\u003Cmi>b\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msub>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmi>i\u003C/mi>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\sum\\_{i=0}^k b_i 2^i\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.2085em;vertical-align:-0.31em;\">\u003C/span>\u003Cspan class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\" style=\"margin-right:0.02778em;\">_\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">i\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8985em;\">\u003Cspan style=\"top:-3.1124em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">b\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. To convert it to a decimal number, we can use the formula:\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>1\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>2\u003C/mn>\u003C/msup>\u003Cmo>+\u003C/mo>\u003Cmn>0\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>1\u003C/mn>\u003C/msup>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>0\u003C/mn>\u003C/msup>\u003Cmo>=\u003C/mo>\u003Cmn>8\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>4\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>0\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>=\u003C/mo>\u003Cmn>13\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">1 \\cdot 2^3 + 1 \\cdot 2^2 + 0 \\cdot 2^1 + 1 \\cdot 2^0 = 8 + 4 + 0 + 1 = 13\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">8\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">4\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">13\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>The following code converts a binary number to a decimal number:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> binary_to_decimal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">binary\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    decimal \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> digit \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> binary\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        decimal \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> decimal \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">digit\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> decimal\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the above implementation is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> is the length of the binary number.\u003C/p>\n\u003Cp>The bit representation of a number is either signed or unsigned. Usually a signed representation is used, which means that both negative and positive numbers can be represented. signed variable of n bits can contain any integer\nbetween \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">-2^{n-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ’\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{n-1} - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For example, the \u003Ccode>C++\u003C/code> type \u003Ccode>int\u003C/code> is a signed \u003Ccode>32-bit\u003C/code> type, which means that it can contain any integer between \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>31\u003C/mn>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">-2^{31}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ’\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">31\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>31\u003C/mn>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{31} - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">31\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>The first bit in a signed representation is the sign of the number (\u003Ccode>0\u003C/code> for nonnegative numbers and \u003Ccode>1\u003C/code> for negative numbers), and the remaining \u003Ccode>nâˆ’1\u003C/code> bits contain the magnitude of the number. Twoâ€™s complement is used, which means that the opposite number of a number is calculated by first inverting all the bits in the number, and then increasing the number by one.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. To convert it to a twoâ€™s complement representation, we first invert all the bits:\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmover accent=\"true\">\u003Cmn>1101\u003C/mn>\u003Cmo stretchy=\"true\">â€¾\u003C/mo>\u003C/mover>\u003Cmo>=\u003C/mo>\u003Cmn>0010\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\overline{1101} = 0010\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8444em;\">\u003C/span>\u003Cspan class=\"mord overline\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8444em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">1101\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.7644em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"overline-line\" style=\"border-bottom-width:0.04em;\">\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0010\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>Then we increase the number by one:\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>0010\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>=\u003C/mo>\u003Cmn>0011\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">0010 + 1 = 0011\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">0010\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0011\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>The result is the twoâ€™s complement representation of the number 13, which is 0011. The number -13 is represented as 1101 in binary. To\u003C/p>\n\u003Cp>In an unsigned representation, only nonnegative numbers can be used, but the upper bound for the values is larger. An unsigned variable of \u003Ccode>n\u003C/code> bits can contain any integer between 0 and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmi>n\u003C/mi>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^n - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7477em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6644em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For example, the \u003Ccode>C++\u003C/code> type \u003Ccode>unsigned int\u003C/code> is an unsigned \u003Ccode>32-bit\u003C/code> type, which means that it can contain any integer between 0 and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>32\u003C/mn>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{32} - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">32\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Ch2 id=\"bitwise-operators\">Bitwise Operators\u003C/h2>\n\u003Ch3 id=\"bitwise-and\">Bitwise AND\u003C/h3>\n\u003Cp>The bitwise AND operator \u003Ccode>&#x26;\u003C/code> compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of both numbers are \u003Ccode>1\u003C/code>.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise AND of 13 and 7 is 0101, which is the number 5.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_and\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-or\">Bitwise OR\u003C/h3>\n\u003Cp>The bitwise OR operator \u003Ccode>|\u003C/code> compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are \u003Ccode>1\u003C/code>.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise OR of 13 and 7 is 1111, which is the number 15.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-xor\">Bitwise XOR\u003C/h3>\n\u003Cp>The bitwise XOR operator \u003Ccode>^\u003C/code> compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are \u003Ccode>1\u003C/code>, but not both.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise XOR of 13 and 7 is 1010, which is the number 10.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_xor\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-not\">Bitwise NOT\u003C/h3>\n\u003Cp>The bitwise NOT operator \u003Ccode>~\u003C/code> inverts all the bits of its operand.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The bitwise NOT of 13 is 0010, which is the number 2.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_not\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ~\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">a\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-shifts\">Bitwise Shifts\u003C/h3>\n\u003Cp>The bitwise left shift operator \u003Ccode>&#x3C;&#x3C;\u003C/code> shifts the bits of its first operand the specified number of positions to the left. The bits shifted off the left end are discarded. The bits on the right end are filled with zeros.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The bitwise left shift of 13 by 1 is 1010, which is the number 10.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_left_shift\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bitwise right shift operator \u003Ccode>>>\u003C/code> shifts the bits of its first operand the specified number of positions to the right. The bits shifted off the right end are discarded. The bits on the left end are filled with zeros.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The bitwise right shift of 13 by 1 is 0110, which is the number 6.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_right_shift\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"bitwise-tricks\">Bitwise Tricks\u003C/h2>\n\u003Ch3 id=\"check-if-a-number-is-even-or-odd\">Check if a number is even or odd\u003C/h3>\n\u003Cp>A number is even if the last bit is \u003Ccode>0\u003C/code> and odd if the last bit is \u003Ccode>1\u003C/code>. We can check if a number is even or odd by checking the last bit of the number. If the last bit is \u003Ccode>0\u003C/code>, the number is even, otherwise, it is odd.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> is_even\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"check-if-a-number-is-a-power-of-two\">Check if a number is a power of two\u003C/h3>\n\u003Cp>A number is a power of two if it has only one bit set to \u003Ccode>1\u003C/code>. We can check if a number is a power of two by checking if the number has only one bit set to \u003Ccode>1\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> is_power_of_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"swap-two-numbers\">Swap two numbers\u003C/h3>\n\u003Cp>We can swap two numbers by using the bitwise XOR operator \u003Ccode>^\u003C/code>. The bitwise XOR of two numbers is \u003Ccode>0\u003C/code> if the two numbers are the same, and it is \u003Ccode>1\u003C/code> if the two numbers are different. We can use this property to swap two numbers.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    b \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"get-the-last-set-bit\">Get the last set bit\u003C/h3>\n\u003Cp>We can get the last set bit of a number by using the bitwise AND operator \u003Ccode>&#x26;\u003C/code> with the twoâ€™s complement of the number.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_last_set_bit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">a\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"hamming-distance\">Hamming distance\u003C/h3>\n\u003Cp>The Hamming distance between two integers is the number of positions at which the corresponding bits are different.\u003C/p>\n\u003Cp>Given two integers \u003Ccode>x\u003C/code> and \u003Ccode>y\u003C/code>, calculate the Hamming distance.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> hamming_distance\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> bin\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">).\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">count\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">1\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"count-the-number-of-set-bits\">Count the number of set bits\u003C/h3>\n\u003Cp>We can count the number of set bits in a number by repeatedly clearing the last set bit of the number until the number becomes \u003Ccode>0\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> count_set_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    count \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        count \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> count\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"reverse-bits\">Reverse bits\u003C/h3>\n\u003Cp>We can reverse the bits of a number by repeatedly shifting the number to the right and appending the last bit to the result.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> reverse_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    result \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> _ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> range\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        result \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (result \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> result\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":350,"localImagePaths":534,"remoteImagePaths":535,"frontmatter":536,"imagePaths":539},[351,354,357,360,363,366,369,372,375,378,381,384,387,390,393,396,399,402,405,408,411,414,417,420,423,426,429,432,435,438,441,444,447,450,453,456,459,462,465,468,471,474,477,480,483,486,489,492,495,498,501,504,507,510,513,516,519,522,525,528,531],{"depth":32,"slug":352,"text":353},"arrays","Arrays",{"depth":32,"slug":355,"text":356},"hashtable","HashTable",{"depth":32,"slug":358,"text":359},"arraylist--resizablearray","ArrayList & ResizableArray",{"depth":213,"slug":361,"text":362},"binary-search","Binary Search",{"depth":32,"slug":364,"text":365},"algorithms","Algorithms",{"depth":131,"slug":367,"text":368},"quickselect","QuickSelect",{"depth":213,"slug":370,"text":371},"stack","Stack",{"depth":32,"slug":373,"text":374},"queue","Queue",{"depth":213,"slug":376,"text":377},"linked-list","Linked List",{"depth":32,"slug":379,"text":380},"singly-linked-list","Singly Linked List",{"depth":32,"slug":382,"text":383},"techniques","Techniques",{"depth":213,"slug":385,"text":386},"trees","Trees",{"depth":32,"slug":388,"text":389},"binary-tree","Binary Tree",{"depth":32,"slug":391,"text":392},"binary-search-tree","Binary Search Tree",{"depth":131,"slug":394,"text":395},"balanced-vs-unbalanced","Balanced vs Unbalanced",{"depth":131,"slug":397,"text":398},"complete-binary-tree","Complete Binary Tree",{"depth":131,"slug":400,"text":401},"full-binary-tree","Full Binary Tree",{"depth":131,"slug":403,"text":404},"perfect-binary-tree","Perfect Binary Tree",{"depth":32,"slug":406,"text":407},"binary-tree-traversal","Binary Tree Traversal",{"depth":131,"slug":409,"text":410},"in-order-traversal","In-order Traversal",{"depth":131,"slug":412,"text":413},"pre-order-traversal","Pre-order Traversal",{"depth":131,"slug":415,"text":416},"post-order-traversal","Post-order Traversal",{"depth":131,"slug":418,"text":419},"level-order-traversal","Level-order Traversal",{"depth":32,"slug":421,"text":422},"binary-heaps-min-heap-and-max-heap","Binary Heaps (min-heap and max-heap)",{"depth":131,"slug":424,"text":425},"insert","Insert",{"depth":131,"slug":427,"text":428},"extract-min","Extract Min",{"depth":213,"slug":430,"text":431},"tries","Tries",{"depth":213,"slug":433,"text":434},"backtracking","Backtracking",{"depth":213,"slug":436,"text":437},"graphs","Graphs",{"depth":32,"slug":439,"text":440},"adjacency-lists","Adjacency Lists",{"depth":32,"slug":442,"text":443},"adjacency-matrix","Adjacency Matrix",{"depth":32,"slug":445,"text":446},"graph-search","Graph Search",{"depth":131,"slug":448,"text":449},"dfs","DFS",{"depth":131,"slug":451,"text":452},"bfs","BFS",{"depth":131,"slug":454,"text":455},"bidirectional-search","Bidirectional Search",{"depth":131,"slug":457,"text":458},"topological-sort","Topological Sort",{"depth":32,"slug":460,"text":461},"shortest-path","Shortest Path",{"depth":131,"slug":463,"text":464},"bellman-ford","Bellman-Ford",{"depth":131,"slug":466,"text":467},"dijkstras-algorithm","Dijkstraâ€™s Algorithm",{"depth":131,"slug":469,"text":470},"floyd-warshall","Floyd-Warshall",{"depth":213,"slug":472,"text":473},"recursion","Recursion",{"depth":32,"slug":475,"text":476},"bottom-up","Bottom-Up",{"depth":32,"slug":478,"text":479},"top-down","Top-Down",{"depth":32,"slug":481,"text":482},"half-and-half","Half-and-Half",{"depth":32,"slug":484,"text":485},"recursion-vs-iteration","Recursion vs. Iteration",{"depth":213,"slug":487,"text":488},"dynamic-programming","Dynamic Programming",{"depth":213,"slug":490,"text":491},"bit-manipulation","Bit Manipulation",{"depth":32,"slug":493,"text":494},"bitwise-operators","Bitwise Operators",{"depth":131,"slug":496,"text":497},"bitwise-and","Bitwise AND",{"depth":131,"slug":499,"text":500},"bitwise-or","Bitwise OR",{"depth":131,"slug":502,"text":503},"bitwise-xor","Bitwise XOR",{"depth":131,"slug":505,"text":506},"bitwise-not","Bitwise NOT",{"depth":131,"slug":508,"text":509},"bitwise-shifts","Bitwise Shifts",{"depth":32,"slug":511,"text":512},"bitwise-tricks","Bitwise Tricks",{"depth":131,"slug":514,"text":515},"check-if-a-number-is-even-or-odd","Check if a number is even or odd",{"depth":131,"slug":517,"text":518},"check-if-a-number-is-a-power-of-two","Check if a number is a power of two",{"depth":131,"slug":520,"text":521},"swap-two-numbers","Swap two numbers",{"depth":131,"slug":523,"text":524},"get-the-last-set-bit","Get the last set bit",{"depth":131,"slug":526,"text":527},"hamming-distance","Hamming distance",{"depth":131,"slug":529,"text":530},"count-the-number-of-set-bits","Count the number of set bits",{"depth":131,"slug":532,"text":533},"reverse-bits","Reverse bits",[],[],{"author":14,"pubDatetime":537,"title":341,"slug":337,"featured":17,"draft":198,"tags":538,"description":343},["Date","2022-12-01T00:00:00.000Z"],[19],[],"compressed-fixedvec",{"id":540,"data":542,"body":547,"filePath":548,"digest":549,"rendered":550},{"author":14,"pubDatetime":543,"title":544,"featured":198,"draft":17,"tags":545,"description":546},["Date","2025-09-24T00:00:00.000Z"],"Engineering a fixed-width bit-packed Integer Vector in Rust",[200,300],"Design and implementation of a memory-efficient, fixed-width bit-packed integer vector in Rust, with extremely fast random access.","If you've ever worked with massive datasets, you know that memory usage can quickly become a bottleneck. While developing succinct data structures, I found myself needing to store large arrays of integersâ€”values with no monotonicity or other exploitable patterns, that I knew came from a universe much smaller than their type's theoretical capacity.\n\nIn this post, we will explore the engineering challenges involved in implementing an efficient vector-like data structure in Rust that stores integers in a compressed, bit-packed format. We will focus on achieving O(1) random access performance while minimizing memory usage. We will try to mimic the ergonomics of Rust's standard `Vec\u003CT>` as closely as possible, including support for mutable access and zero-copy slicing.\n\n\n* All the code can be found on github: [compressed-intvec](https://github.com/lukefleed/compressed-intvec)\n* This is also published as a crate on crates.io: [compressed-intvec](https://crates.io/crates/compressed-intvec)\n\nYou can discuss this post on [Hacker News](https://news.ycombinator.com/item?id=45361578), [Lobsters](https://lobste.rs/s/u1rffj/engineering_fixed_width_bit_packed) or [Reddit](https://www.reddit.com/r/rust/comments/1npf41d/engineering_a_fixedwidth_bitpacked_integer_vector/).\n\n---\n\n## Table of contents\n\n# Memory Waste in Standard Vectors\n\nIn Rust, the contract of a `Vec\u003CT>` (where `T` is a primitive integer type like `u64` or `i32`) is simple: O(1) random access in exchange for a memory layout that is tied to the static size of `T`. This is a good trade-off, until it isn't. When the dynamic range of the stored values is significantly smaller than the type's capacity, this memory layout leads to substantial waste.\n\nConsider storing the value `5` within a `Vec\u003Cu64>`. Its 8-byte in-memory representation is:\n\n\u003Cdiv align=\"center\">\n\n`00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000101`\n\n\u003C/div>\n\nOnly 3 bits are necessary to represent the value, leaving 61 bits as zero-padding. The same principle applies, albeit less dramatically, when storing `5` in a `u32` or `u16`. At scale, this overhead becomes prohibitive. A vector of one billion `u64` elements consumes `10^9 * std::mem::size_of::\u003Cu64>()`, or approximately 8 GB of memory, even if every element could fit within a single byte.\n\nThe canonical solution is bit packing, which aligns data end-to-end in a contiguous bitvector. However, this optimization has historically come at the cost of random access performance. The O(1) access guarantee of `Vec\u003CT>` is predicated on simple pointer arithmetic: `address = base_address + index * std::mem::size_of::\u003CT>()`. Tightly packing the bits invalidates this direct address calculation, seemingly forcing a trade-off between memory footprint and access latency.\n\nThis raises the central question that with this post we aim to answer: is it possible to design a data structure that decouples its memory layout from the static size of `T`, adapting instead to the data's true dynamic range, without sacrificing the O(1) random access that makes `Vec\u003CT>` so effective?\n\n# Packing and Accessing Bits\n\nIf the dynamic range of our data is known, we can define a fixed `bit_width` for every integer. For instance, if the maximum value in a dataset is `1000`, we know every number can be represented in 10 bits, since `2^10 = 1024`. Instead of allocating 64 bits per element, we can store them back-to-back in a contiguous bitvector, forming the core of what from now on we'll refer as `FixedVec`. We can immagine such data strucutre as a logical array of `N` integers, each `bit_width` bits wide, stored in a backing buffer of `u64` words.\n\n```rust\nstruct FixedVec {\n    limbs: Vec\u003Cu64>, // Backing storage\n    bit_width: usize, // Number of bits per element\n    len: usize, // Number of elements\n    mask: u64, // Precomputed mask for extraction\n}\n```\n\nWhere the role of the `mask` field is to isolate the relevant bits during extraction. For a `bit_width` of 10, the mask would be `0b1111111111`.\n\nThis immediately solves the space problem, but how can we find the `i`-th element in O(1) time if it doesn't align to a byte boundary? The answer lies in simple arithmetic. The starting bit position of any element is a direct function of its index. Given a backing store of `u64` words, we can locate any value by calculating its absolute bit position and then mapping that to a specific word and an offset within that word.\n\n```rust\nlet bit_pos = index * bit_width; // Absolute bit position of the value\nlet word_index = bit_pos / 64; // Which u64 word to read\nlet bit_offset = bit_pos % 64; // Where the value starts in that word\n```\n\nWith these values, the implementation of `get_unchecked` becomes straightforward. It's a two-step process: fetch the correct word from our backing `Vec\u003Cu64>`, then use bitwise operations to isolate the specific bits we need.\n\n```rust\n// A simplified look at the core get_unchecked logic\nunsafe fn get_unchecked(&self, index: usize) -> u64 {\n    let bit_width = self.bit_width();\n    let bit_pos = index * bit_width;\n    let word_index = bit_pos / 64;\n    let bit_offset = bit_pos % 64;\n\n    // 1. Fetch the word from the backing store\n    let word = *self.limbs.get_unchecked(word_index);\n\n    // 2. Shift and mask to extract the value\n    (word >> bit_offset) & self.mask\n}\n```\n\nLet's trace an access with `bit_width = 10` for the element at `index = 7`. The starting bit position is `7 * 10 = 70`. This maps to `word_index = 1` and `bit_offset = 6`. Our 10-bit integer begins at the 6th bit of the *second* `u64` word in our storage.\n\nThe right-shift `>>` operation moves the bits of the entire `u64` word to the right by `bit_offset` positions. This aligns the start of our desired 10-bit value with the least significant bit (LSB) of the word. The final step is to isolate our value. A pre-calculated `mask` (e.g., `0b1111111111` for 10 bits) is applied with a bitwise AND `&`. This zeroes out any high-order bits from the word, leaving just our target integer.\n\n\n## Crossing Word Boundaries\n\nThe single-word access logic is fast, but it only works as long as `bit_offset + bit_width \u003C= 64`. This assumption breaks down as soon as an integer's bit representation needs to cross the boundary from one `u64` word into the next. This is guaranteed to happen for any `bit_width` that is not a power of two. For example, with a 10-bit width, the element at `index = 6` starts at bit position 60. Its 10 bits will occupy bits 60-63 of the first word and bits 0-5 of the second. The simple right-shift-and-mask trick fails here.\n\n![crossing word boundaries](/assets/fixedvec.svg)\n\nTo correctly decode the value, we must read *two* consecutive `u64` words and combine their bits. This splits our `get_unchecked` implementation into two paths. The first is the fast path we've already seen. The second is a new path for spanning values.\n\nTo get the lower bits of the value, we read the first word and shift right, just as before. This leaves the upper bits of the word as garbage.\n\n```rust\nlet low_part = *limbs.get_unchecked(word_index) >> bit_offset;\n```\n\nTo get the upper bits of the value, we read the *next* word. The bits we need are at the beginning of this word, so we shift them left to align them correctly.\n\n```rust\nlet high_part = *limbs.get_unchecked(word_index + 1) \u003C\u003C (64 - bit_offset);\n```\n\nFinally, we combine the two parts with a bitwise OR and apply the mask to discard any remaining high-order bits from the `high_part`.\n\n```rust\n(low_part | high_part) & self.mask\n```\n\nThe line `limbs.get_unchecked(word_index + 1)` introduces a safety concern: if we are reading the last element of the vector, `word_index + 1` could point past the end of our buffer, leading to undefined behavior. To prevent this, our builder must always allocate one extra padding word at the end of the storage.\n\nIntegrating these two paths gives us our final `get_unchecked` implementation:\n\n```rust\npub unsafe fn get_unchecked(&self, index: usize) -> u64 {\n    let bit_width = self.bit_width;\n    let bit_pos = index * bit_width;\n    let word_index = bit_pos / 64;\n    let bit_offset = bit_pos % 64;\n\n    let limbs = self.bits.as_ref();\n\n    if bit_offset + bit_width \u003C= 64 {\n        // Fast path: value is fully within one word\n        (*limbs.get_unchecked(word_index) >> bit_offset) & self.mask\n    } else {\n        // Slow path: value spans two words.\n        let low_part = *limbs.get_unchecked(word_index) >> bit_offset;\n        let high_part = *limbs.get_unchecked(word_index + 1) \u003C\u003C (64 - bit_offset);\n        (low_part | high_part) & self.mask\n    }\n}\n```\n\n## Faster Reads: Unaligned Access\n\nOur `get_unchecked` implementation is correct, but the slow path for spanning values requires two separate, aligned memory reads. The instruction sequence for this method involves at least two load instructions, multiple shifts, and a bitwise OR. These instructions have data dependencies: the shifts cannot execute until the loads complete, and the OR cannot execute until both shifts are done. This dependency chain can limit the CPU's instruction-level parallelism and create pipeline stalls if the memory accesses miss the L1 cache.\n\nLet's have a look at the machine code generated by this method. We can create a minimal binary with an `#[inline(never)]` function that calls `get_unchecked` on a known spanning index, then use [`cargo asm`](https://crates.io/crates/cargo-asm) to inspect the disassembly.\n\n```asm\n; asm_test::aligned::get_aligned (spanning path)\n.LBB14_2:\n        ; let low = *limbs.get_unchecked(word_index) >> bit_offset;\n        mov rsi, qword ptr [r8 + 8*rdx]      ; \u003C\u003C\u003C LOAD #1 (low_part)\n\n        ; let high = *limbs.get_unchecked(word_index + 1) \u003C\u003C (64 - bit_offset);\n        mov rdx, qword ptr [r8 + 8*rdx + 8]  ; \u003C\u003C\u003C LOAD #2 (high_part)\n\n        shr rsi, cl                          ; shift right of low_part\n        shl rdx, cl                          ; shift left of high_part\n        or rdx, rsi                          ; combine results\n```\n\nThe instruction `mov rsi, qword ptr [r8 + 8*rdx]` is our first memory access. It loads a 64-bit value (`qword`) into the `rsi` register. The address is calculated using base-plus-index addressing: `r8` holds the base address of our `limbs` buffer, and `rdx` holds the `word_index`. This corresponds directly to `limbs[word_index]`.\n\nImmediately following is `mov rdx, qword ptr [r8 + 8*rdx + 8]`. This is our second, distinct memory access. It loads the *next* 64-bit word from memory by adding an 8-byte offset to the previous address. This corresponds to `limbs[word_index + 1]`.\n\nOnly after both of these `mov` instructions complete can the CPU proceed. The `shr rsi, cl` instruction (shift right `rsi` by the count in `cl`) cannot execute until the first `mov` has placed a value in `rsi`. Similarly, `shl rdx, cl` depends on the second `mov`. Finally, `or rdx, rsi` depends on both shifts.\n\nThis sequence of operationsâ€”loading two adjacent 64-bit words, shifting each, and combining them is a software implementation of what is, conceptually, a [128-bit barrel shifter](https://en.wikipedia.org/wiki/Barrel_shifter). We are selecting a 64-bit window from a virtual 128-bit integer formed by concatenating the two words from memory.\n\n**Can we do better then this?** Potentially, yes. We can replace this multi-instruction sequence with something more direct by delegating the complexity to the hardware and performing a single unaligned memory read. Modern x86-64 CPUs handle this directly: when an unaligned load instruction is issued, the CPU's memory controller fetches the necessary cache lines and the load/store unit reassembles the bytes into the target register. This entire process is a single, optimized micro-operation.\n\nWe can try to implement a more aggressive access method. The strategy is to calculate the exact *byte* address where our data begins and perform a single, unaligned read of a full `W` word from that position.\n\nThe implementation first translates the absolute bit position into a byte address and a residual bit offset within that byte.\n\n```rust\nlet bit_pos = index * self.bit_width;\nlet byte_pos = bit_pos / 8;\nlet bit_rem = bit_pos % 8;\n```\n\nWith the byte-level address, we get a raw `*const u8` pointer to our storage and perform the unaligned read. The [read_unaligned](https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html) intrinsic in Rust compiles down to a single machine instruction that the hardware can execute efficiently.\n\n```rust\nlet limbs_ptr = self.as_limbs().as_ptr() as *const u8;\n// This read may cross hardware word boundaries, but the CPU handles it.\nlet word: W = (limbs_ptr.add(byte_pos) as *const W).read_unaligned();\n```\n\nOn a Little-Endian system, the loaded `word` now contains our target integer, but it's shifted by `bit_rem` positions. A simple right shift aligns our value to the LSB, and applying the mask isolates it.\n\n```rust\nlet extracted_word = word >> bit_rem;\nlet final_value = extracted_word & self.mask;\n```\n\nThis operation is safe only because, as said before, we are supposing that our builder guarantees a padding word at the end of the storage buffer. Combining all these steps, we get our final implementation:\n\n```rust\npub unsafe fn get_unaligned_unchecked(&self, index: usize) -> u64 {\n    let bit_pos = index * self.bit_width;\n    let byte_pos = bit_pos / 8;\n    let bit_rem = bit_pos % 8;\n\n    let limbs_ptr = self.as_limbs().as_ptr() as *const u8;\n    // SAFETY: The builder guarantees an extra padding word at the end.\n    let word = (limbs_ptr.add(byte_pos) as *const W).read_unaligned();\n    let extracted_word = word >> bit_rem;\n    extracted_word & self.mask\n}\n```\n\nLet's have a look at the generated machine code for this new method when accessing an index that spans words:\n\n```asm\n; asm_test::unaligned::get_unaligned\n.LBB15_1:\n        ; let bit_pos = index * self.bit_width;\n        imul rcx, rax\n        ; let byte_pos = bit_pos / 8;\n        mov rax, rcx\n        shr rax, 3\n        ; self.bits.as_ref()\n        mov rdx, qword ptr [rdi + 8]\n        ; unsafe { crate::intrinsics::copy_nonoverlapping(src, dst, count) }\n        mov rax, qword ptr [rdx + rax]       ; \u003C\u003C\u003C SINGLE UNALIGNED LOAD\n        ; self >> other\n        and cl, 7\n        shr rax, cl\n        ; fn bitand(self, rhs: $t) -> $t { self & rhs }\n        and rax, qword ptr [rdi + 32]\n```\n\nThe initial `imul` and `shr rax, 3` (a fast division by 8) correspond to the calculation of `byte_pos`. The instruction `mov rdx, qword ptr [rdi + 8]` loads the base address of our `limbs` buffer into the `rdx` register.\n\nThe instruction `mov rax, qword ptr [rdx + rax]` is our single unaligned load. The address `[rdx + rax]` is the sum of the buffer's base address and our calculated `byte_pos`. This `mov` instruction reads 8 bytes (a `qword`) directly from this potentially unaligned memory location into the `rax` register. We can see that as we hoped, the [read_unaligned](https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html) intrinsic has been compiled down to a single hardware instruction.\n\nThe next instructions handle the extraction. The `and cl, 7` and `shr rax, cl` sequence corresponds to our `>> bit_rem`. `cl` holds the lower bits of the original `bit_pos` (our `bit_rem`), and the shift aligns our desired value to the LSB of the `rax` register. Finally, `and rax, qword ptr [rdi + 32]` applies the pre-calculated mask, which is stored at an offset from the `self` pointer in `rdi`.\n\n## Random Access Performance\n\nWe can now benchmark the latency of 1 million random access operations on a vector containing 10 million elements. For each `bit_width`, we generate data with a uniform random distribution in the range `[0, 2^bit_width)`. The code for the benchmark is available here: [`bench-intvec`]\n\nOur baseline is the smallest standard `Vec\u003CT>` capable of holding the data (`Vec\u003Cu8>` for `bit_width \u003C= 8`, etc.). We also include results from [`sux`], [`succinct`], and [`simple-sds-sbwt`] for context. I am not aware of any other Rust crates that implement fixed-width bit-packed integer vectors, so if you know of any, please let me know!\n\n\u003Ciframe src=\"/bench-intvec/fixed_random_access_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nWe can see that for `bit_width` values below 32, the `get_unaligned_unchecked` of our `FixedVec` is almost always faster than the corresponding `Vec\u003CT>` baseline. This is a result of improved cache locality. A 64-byte L1 cache line can hold 64 elements from a `Vec\u003Cu8>`. With a `bit_width` of 4, the same cache line holds `(64 * 8) / 4 = 128` elements from our `FixedVec`. This increased density improves the cache hit rate for random access patterns, and the latency reduction from avoiding DRAM access outweighs the instruction cost of the bitwise extraction. For values of `bit_width` above 32, the performance of `FixedVec` are *very slightly* worse than the `Vec\u003CT>` baseline, as the cache locality advantage diminishes. However, the memory savings remain.\n\nThe performance delta between `get_unaligned_unchecked` and `get_unchecked` confirms the unaligned access strategy discussed before: a single `read_unaligned` instruction is more efficient than the two dependent aligned reads required by the logic for spanning words.\n\nWe can see that the implementation of [`sux`] is almost on par with ours. The other two crates, [`succinct`] and [`simple-sds-sbwt`], are significantly slower (note that the Y-axis is logarithmic). Tho, it's worth noting that neither of these last two crates provides unchecked or unaligned access methods, so their implementations are inherently more conservative.\n\n[`sux`]: https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\n[`succinct`]: https://docs.rs/succinct/latest/succinct/trait.IntVec.html\n[`simple-sds-sbwt`]: https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\n[`bench-intvec`]: https://github.com/lukefleed/compressed-intvec/blob/master/benches/fixed/bench_random_access.rs\n\n## Iterating Over Values\n\nThe most common operation on any `Vec`-like structure is, after all, a simple `for` loop. The simplest way to implement `iter()` would be to just wrap `get()` in a loop:\n\n```rust\n// A naive, inefficient iterator\nfor i in 0..vec.len() {\n    let value = vec.get(i);\n    // ... do something with value\n}\n```\n\nThis works, but it's terribly inefficient. Every single call to `get(i)` independently recalculates the `word_index` and `bit_offset` from scratch. We're throwing away valuable state, our current position in the bitstream, on every iteration, forcing the CPU to perform redundant multiplications and divisions.\n\nWe can think then about a *stateful* iterator. It should operate directly on the bitvector, maintaining its own position. Instead of thinking in terms of logical indices, it should think in terms of a \"bit window\", a local `u64` register that holds the current chunk of bits being processed.\n\nThe idea is simple: the iterator loads one `u64` word from the backing store into its window. It then satisfies `next()` calls by decoding values directly from this in-register window. Only when the window runs out of bits does it need to go back to memory for the next `u64` word. This amortizes the cost of memory access over many `next()` calls.\n\nFor forward iteration, the state is minimal:\n\n```rust\nstruct FixedVecIter\u003C'a, ...> {\n    // ...\n    front_window: u64,\n    front_bits_in_window: usize,\n    front_word_index: usize,\n    // ...\n}\n```\n\nThe `next()` method first checks if the current `front_window` has enough bits to satisfy the request. If `self.front_bits_in_window >= bit_width`, it's the fast path: a simple shift and mask on a register, which is incredibly fast.\n\n```rust\n// Inside next(), fast path:\nif self.front_bits_in_window >= bit_width {\n    let value = self.front_window & self.mask;\n    self.front_window >>= bit_width;\n    self.front_bits_in_window -= bit_width;\n    return Some(value);\n}\n```\n\nIf the window is running low on bits, we hit the slower path. The next value spans the boundary between our current window and the next `u64` word in memory. We must read the next word, combine its bits with the remaining bits in our current window, and then extract the value. This is the same logic as the spanning-word `get()`, but it's performed incrementally.\n\n### Double-Ended Iteration\n\nBut I want my iterator to be bidirectional! Well, then we need to ensure it implements [`DoubleEndedIterator`](https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html) and supports [`next_back()`](https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html#tymethod.next_back). This throws a wrench in our simple stateful model. A single window and cursor can only move in one direction.\n\nThe solution is to maintain two independent sets of state: one for the front and one for the back. The `FixedVecIter` needs to track two windows, two bit counters, and two word indices.\n\n```rust\nstruct FixedVecIter\u003C'a, ...> {\n    // ...\n    front_index: usize,\n    back_index: usize,\n\n    // State for forward iteration\n    front_window: u64,\n    front_bits_in_window: usize,\n    front_word_index: usize,\n\n    // State for backward iteration\n    back_window: u64,\n    back_bits_in_window: usize,\n    back_word_index: usize,\n    // ...\n}\n```\n\nInitializing the front is easy: we load `limbs[0]` into `front_window`. The back is more complex. We must calculate the exact word index and the number of valid bits in the *last* word that contains data. This requires a bit of arithmetic to handle cases where the data doesn't perfectly fill the final word.\n\nThe `next()` method consumes from the `front_window`, advancing the front state. The `next_back()` method consumes from the `back_window`, advancing the back state. The iterator is exhausted when `front_index` meets `back_index`.\n\n> The full implementation can be found in the iter module of the [library](https://github.com/lukefleed/compressed-intvec/blob/master/src/fixed/iter.rs)\n\n# Writing bits\n\nWe have solved the read problem, but we may also want to modify values in place. A method like `set(index, value)` seems simple, but it opens up the same can of worms as `get`, just in reverse. We can't just write the new value; we have to do so without clobbering the adjacent, unrelated data packed into the same `u64` word.\n\nJust like with reading, the logic splits into two paths. The \"fast path\" handles values that are fully contained within a single `u64`. Here, we can't just overwrite the word. We first need to clear out the bits for the element we're replacing and then merge in the new value.\n\n## In-Word Write\n\nOur goal here is to update a `bit_width`-sized slice of a `u64` word while leaving the other bits untouched. This operation must be a read-modify-write sequence to avoid corrupting adjacent elements. The most efficient way to implement this is to load the entire word into a register, perform all bitwise modifications locally, and then write the final result back to memory in a single store operation.\n\nFirst, we load the word from our backing `limbs` slice.\n\n```rust\nlet mut word = *limbs.get_unchecked(word_index);\n```\n\nNext, we need to create a \"hole\" in our local copy where the new value will go. We do this by creating a mask that has ones *only* in the bit positions we want to modify, and then inverting it to create a clearing mask.\n\n```rust\n// For a value at bit_offset, the mask must also be shifted.\nlet clear_mask = !(self.mask \u003C\u003C bit_offset);\n// Applying this mask zeroes out the target bits in our register copy.\nword &= clear_mask;\n```\n\nWith the target bits zeroed, we can merge our new value. The value is first shifted left by `bit_offset` to align it correctly within the 64-bit word. Then, a bitwise OR merges it into the \"hole\" we just created.\n\n```rust\n// Shift the new value into position and merge it.\nword |= value_w \u003C\u003C bit_offset;\n```\n\nFinally, with the modifications complete, we write the updated word from the register back to memory in a single operation.\n\n```rust\n*limbs.get_unchecked_mut(word_index) = word;\n```\nThis entire sequence of one read, two bitwise operations in-register, one write is the canonical and most efficient way to perform a sub-word update.\n\n## Spanning Write\n\nNow for the hard part: writing a value that crosses a word boundary. This operation must modify two separate `u64` words in our backing store. It's the inverse of the spanning read. We need to split our `value_w` into a low part and a high part and write each to the correct word, minimizing memory accesses.\n\nTo operate on two distinct memory locations, `limbs[word_index]` and `limbs[word_index + 1]`, we first need mutable access to both. In a safe, hot path like this, we can use `split_at_mut_unchecked` to bypass Rust's borrow checker bounds checks, as we have already guaranteed through our logic that both indices are valid.\n\n```rust\n// SAFETY: We know word_index and word_index + 1 are valid.\nlet (left, right) = limbs.split_at_mut_unchecked(word_index + 1);\n```\n\nOur strategy is to read both words into registers, perform all bitwise logic locally, and then write both modified words back to memory. This minimizes the time we hold mutable references and can improve performance.\n\nFirst, we handle the `low_word`. We need to replace its high bits (from `bit_offset` onwards) with the low bits of our new value. The most direct way is to create a mask for the bits we want to *keep*. The expression `(1 \u003C\u003C bit_offset) - 1` is a bit-twiddling trick to generate a mask with `bit_offset` ones at the least significant end.\n\n```rust\nlet mut low_word_val = *left.get_unchecked(word_index);\n\n// Create a mask to preserve the low `bit_offset` bits of the word.\nlet low_mask = (1u64 \u003C\u003C bit_offset).wrapping_sub(1);\nlow_word_val &= low_mask;\n```\n\nWith the target bits zeroed out, we merge in the low part of our new value. A left shift aligns it correctly, and the high bits of `value_w` are naturally shifted out of the register.\n\n```rust\n// Merge in the low part of our new value.\nlow_word_val |= value_w \u003C\u003C bit_offset;\n*left.get_unchecked_mut(word_index) = low_word_val;\n```\n\nNext, we handle the `high_word` in a symmetrical fashion. We need to write the remaining high bits of `value_w` into the low-order bits of this second word. First, we calculate how many bits of our value actually belong in the first word:\n\n```rust\nlet remaining_bits_in_first_word = 64 - bit_offset;\n```\n\nNow, we read the second word and create a mask to clear the low-order bits where our data will be written. With the operation `self.mask >> remaining_bits_in_first_word` we can determine how many bits of our value spill into the second word, creating a mask for them. Inverting this gives us a mask to *preserve* the existing high-order bits of the `high_word`.\n\n```rust\nlet mut high_word_val = *right.get_unchecked(0);\n\n// Clear the low bits of the second word that will be overwritten.\nhigh_word_val &= !(self.mask >> remaining_bits_in_first_word);\n```\n\nFinally, we isolate the high part of `value_w` by right-shifting it by the number of bits we already wrote, and merge it into the cleared space.\n\n```rust\n// Merge in the high part of our new value.\nhigh_word_val |= value_w >> remaining_bits_in_first_word;\n*right.get_unchecked_mut(0) = high_word_val;\n```\n\n## Random Write Performance\n\nAs with reads, we can benchmark the latency of 1 million random write operations on a vector containing 10 million elements. The code for the benchmark is available here: [`bench-intvec-writes`].\n\n\u003Ciframe src=\"/bench-intvec/random_write_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nHere, the `Vec\u003CT>` baseline is the clear winner across almost all bit-widths. This isn't surprising. A `set` operation in a `Vec\u003CT>` compiles down to a single `MOV` instruction with a simple addressing mode (`[base + index * element_size]`). It's about as fast as the hardware allows.\n\nAs for the reads, the performance of our `FixedVec` is almost identical to that of [`sux`]. The other two crates, [`succinct`] and [`simple-sds-sbwt`], are again slower. It's worth noting that also for the writes, neither of these last two crates provides unchecked methods.\n\n> For the 64-bit width case, I honestly have no idea what is going on with [`sux`] being so much faster than everything else, even then `Vec\u003Cu64>`! Mybe some weird compiler optimization? If you have any insight, please let me know.\n\n# Architecture\n\nWith the access patterns defined, we need to think about the overall architecture of this data structure. A solution hardcoded to `u64` would lack the flexibility to adapt to different use cases. We need a structure that is generic over the its principal components: the logical type, the physical storage type, the bit-level ordering, and ownership. We can define a struct that is generic over these four parameters:\n\n```rust\npub struct FixedVec\u003CT: Storable\u003CW>, W: Word, E: Endianness, B: AsRef\u003C[W]> = Vec\u003CW>> {\n    bits: B,\n    bit_width: usize,\n    mask: W,\n    len: usize,\n}\n```\n\nWhere:\n\n* `T` is the **logical element type**, the type as seen by the user of the API (e.g., `i16`, `u32`). By abstracting `T`, we divide the user-facing type from the internal storage representation.\n\n* `W` is the **physical storage word**, which must implement our `Word` trait. It defines the primitive unsigned integer (`u32`, `u64`, `usize`) of the backing buffer and sets the granularity for all bitwise operations.\n\n* `E` requires the `dsi-bitstream::Endianness` trait, allowing us to specify either Little-Endian (`LE`) or Big-Endian (`BE`) byte order.\n\n* `B`, which must implement `AsRef\u003C[W]>`, represents the **backing storage**. This abstraction over ownership allows `FixedVec` to be either an owned container where `B = Vec\u003CW>`, or a zero-copy, borrowed view where `B = &[W]`. This makes it possible to, for example, construct a `FixedVec` directly over a memory-mapped slice without any heap allocation.\n\nIn this way, the compiler monomorphizes the struct and its methods for each concrete instantiation (e.g., `FixedVec\u003Ci16, u64, LE, Vec\u003Cu64>>`), resulting in specialized code with no runtime overhead from the generic abstractions.\n\n## `Word` Trait: The Physical Storage Layer\n\nThe first step is to abstract the physical storage layer. The `W` parameter must be a primitive unsigned integer type that supports bitwise operations. We can define a `Word` trait that captures these requirements:\n\n```rust\npub trait Word:\n    UnsignedInt + Bounded + ToPrimitive + dsi_bitstream::traits::Word\n    + NumCast + Copy + Send + Sync + Debug + IntoAtomic + 'static\n{\n    const BITS: usize = std::mem::size_of::\u003CSelf>() * 8;\n}\n```\n\nThe numeric traits (`UnsignedInt`, `Bounded`, `NumCast`, `ToPrimitive`) are necessary for the arithmetic of offset and mask calculations. The `dsi_bitstream::traits::Word` bound allows us to integrate with its `BitReader` and `BitWriter` implementations, offloading the bitstream logic. `Send` and `Sync` are non-negotiable requirements for any data structure that might be used in a concurrent context. The `IntoAtomic` bound is particularly forward-looking: it establishes a compile-time link between a storage word like `u64` and its atomic counterpart, `AtomicU64`. We will use it later to build a thread safe, atomic version of `FixedVec`. Finally, the `const BITS` associated constant lets us write architecture-agnostic code that correctly adapts to `u32`, `u64`, or `usize` words without `cfg` flags.\n\n## `Storable` Trait: The Logical Type Layer\n\nWith the physical storage layer defined, we need a formal contract to connect it to the user's logical type `T`. We can do this by creating the `Storable` trait, which defines a bidirectional, lossless conversion.\n\n```rust\npub trait Storable\u003CW: Word>: Sized + Copy {\n    fn into_word(self) -> W;\n    fn from_word(word: W) -> Self;\n}\n```\n\nFor unsigned types, the implementation is a direct cast. For signed types, however, we must map the `iN` domain to the `uN` domain required for bit-packing. A simple two's complement bitcast is unsuitable, as `i64(-1)` would become `u64::MAX`, a value requiring the maximum number of bits. We need a better mapping that preserves small absolute values.\n\nWe can use **ZigZag encoding**, which maps integers with small absolute values to small unsigned integers. This is implemented via the `ToNat` and `ToInt` traits from `dsi-bitstream`. The core encoding logic in `to_nat` is:\n\n```rust\n// From dsi_bitstream::traits::ToNat\nfn to_nat(self) -> Self::UnsignedInt {\n    (self \u003C\u003C 1).to_unsigned() ^ (self >> (Self::BITS - 1)).to_unsigned()\n}\n```\n\nThis operation works as follows: `(self \u003C\u003C 1)` creates a space at the LSB. The term `(self >> (Self::BITS - 1))` is an arithmetic right shift, which generates a sign maskâ€”all zeros for non-negative numbers, all ones for negative numbers. The final XOR uses this mask to interleave positive and negative integers: 0 becomes 0, -1 becomes 1, 1 becomes 2, -2 becomes 3, and so on.\n\nThe decoding reverses this transformation:\n\n```rust\n// From dsi_bitstream::traits::ToInt\nfn to_int(self) -> Self::SignedInt {\n    (self >> 1).to_signed() ^ (-(self & 1).to_signed())\n}\n```\n\nHere, `(self >> 1)` shifts the value back. The term `-(self & 1)` creates a mask from the LSB (the original sign bit). In two's complement, this becomes `0` for even numbers (originally positive) and `-1` (all ones) for odd numbers (originally negative). The final XOR with this mask correctly restores the original two's complement representation.\n\n\nWe might ask ourselves: why not just a direct bitcast for signed types, perhaps via a `uN -> iN` chain. Well, while a direct [transmute](https://doc.rust-lang.org/std/mem/fn.transmute.html) between same-sized integer types is a no-op, the approach fails when the logical `bit_width` is smaller than the physical type size. `FixedVec`'s core logic extracts a `bit_width`-sized unsigned integer from its storage. For example, when reading a 4-bit representation of `-1` (binary `1111`), the `from_word` function receives the value `15u64`. At this point, the context that those four bits represented a negative number is lost. A cast chain like `15u64 as u8 as i8` would simply yield `15i8`, not `-1i8`.\n\nTo correctly reconstruct the signed value, one would need to manually perform sign extension based on the known `bit_width`. This involves checking the most significant bit of the extracted value and, if set, filling the higher-order bits of the word with ones. This logic requires a conditional branch, which can introduce pipeline stalls and degrade performance in tight loops. ZigZag decoding, by contrast, is a purely arithmetic, branch-free transformation. Its reconstruction logic is a simple sequence of bitwise shifts and XORs, making it a faster and more consistent choice for the hot path of data access.\n\nWith this logic within the trait system, the main `FixedVec` implementation remains clean and agnostic to the signedness of the data it stores.\n\n## Builder Pattern\n\nOnce the structure logic is in place, we have to design an ergonomic way to construct it. A simple `new()` function isn't sufficient because the vector's memory layout depends on parameters that must be determined *before* allocation, most critically the `bit_width`. This is a classic scenario for a builder pattern.\n\n\nThe central problem is that the optimal `bit_width` often depends on the data itself. We need a mechanism to specify the *strategy* for determining this width. We can create the `BitWidth` enum:\n\n```rust\npub enum BitWidth {\n    Minimal,\n    PowerOfTwo,\n    Explicit(usize),\n}\n```\n\n\n\nWith this enum, the user can choose between three strategies:\n\n- `Minimal`: The builder scans the input data to find the maximum value, then calculates the minimum number of bits required to represent it. This is the most space-efficient option but requires a full pass over the data.\n- `PowerOfTwo`: Similar to `Minimal`, but rounds the bit width up to the next power of two. This can simplify certain bitwise operations and align better with hardware word sizes, at the cost of some additional space.\n- `Explicit(n)`: The user provides a fixed bit width. This avoids the data scan but requires the user to ensure that all values fit within the specified width.\n\n> **Note:** Yes, I could have also made three different build functions: `new_with_minimal_bit_width()`, `new_with_power_of_two_bit_width()`, and `new_with_explicit_bit_width(n)`. However, this would lead to a combinatorial explosion if we later wanted to add more configuration options. The builder pattern scales better.\n\nWith this, the `FixedVecBuilder` could be designed as a state machine. It holds the chosen `BitWidth` strategy. The final `build()` method takes the input slice and executes the appropriate logic.\n\n```rust\n// A look at the builder's logic flow\npub fn build(self, input: &[T]) -> Result\u003CFixedVec\u003C...>, Error> {\n\n    let final_bit_width = match self.bit_width_strategy {\n        BitWidth::Explicit(n) => n,\n        _ => {\n            // For Minimal or PowerOfTwo, we first find the max value.\n            let max_val = input.iter().map(|v| v.into_word()).max().unwrap_or(0);\n            let min_bits = (64 - max_val.leading_zeros()).max(1) as usize;\n\n            match self.bit_width_strategy {\n                BitWidth::Minimal => min_bits,\n                BitWidth::PowerOfTwo => min_bits.next_power_of_two(),\n                _ => unreachable!(),\n            }\n        }\n    };\n\n    // ... (rest of the logic: allocate buffer, write data) ...\n}\n```\n\nThis design cleanly separates the configuration phase from the execution phase. The user can declaratively state their requirements, and the builder handles the implementation details, whether that involves a full data scan or a direct construction. For example:\n\n```rust\nuse compressed_intvec::prelude::*;\n\nlet data: &[u32] = &[100, 200, 500]; // Max value 500 requires 9 bits\n\n// The builder will scan the data, find max=500, calculate min_bits=9,\n// and then round up to the next power of two.\nlet vec_pow2: UFixedVec\u003Cu32> = FixedVec::builder()\n    .bit_width(BitWidth::PowerOfTwo)\n    .build(data)\n    .unwrap();\n\nassert_eq!(vec_pow2.bit_width(), 16);\n```\n\n> `UFixedVec\u003CT>` is a type alias for `FixedVec\u003CT, u64, LE, Vec\u003Cu64>>`, the most common instantiation.\n\n\n# Doing more than just reading\n\nThe design of `FixedVec` allows for more than just efficient reads. We can extend it to support mutation and even thread-safe (almost atomic) concurrent access.\n\n## Mutability: Proxy Objects\n\nA core feature of `std::vec::Vec` is mutable, index-based access via `&mut T`. This is fundamentally impossible for `FixedVec`. An element, such as a 10-bit integer, is not a discrete, byte-aligned entity in memory. It is a virtual value extracted from a bitstream, potentially spanning the boundary of two different `u64` words. It has no stable memory address, so a direct mutable reference cannot be formed.\n\nTo provide an ergonomic mutable API, we must emulate the behavior of a mutable reference. We achieve this through a proxy object pattern, implemented in a struct named `MutProxy`.\n\n```rust\npub struct MutProxy\u003C'a, T, W, E, B>\nwhere\n    T: Storable\u003CW>,\n    W: Word,\n    E: Endianness,\n    B: AsRef\u003C[W]> + AsMut\u003C[W]>,\n{\n    vec: &'a mut FixedVec\u003CT, W, E, B>,\n    index: usize,\n    value: T, // A temporary, decoded copy of the element's value.\n}\n```\n\nWhen we call a method like `at_mut(index)`, it does not return a reference. Instead, it constructs and returns a `MutProxy` instance. The proxy's lifecycle manages the entire modification process:\n\n1.  **Construction:** The proxy is created. Its first action is to call the parent `FixedVec`'s internal `get` logic to read and decode the value at the specified `index`. This decoded value is stored as a temporary copy inside the proxy object itself.\n2.  **Modification:** The `MutProxy` implements `Deref` and `DerefMut`, allowing the user to interact with the temporary copy as if it were the real value. Any modifications (`*proxy = new_value`, `*proxy += 1`) are applied to this local copy, not to the underlying bitstream.\n3.  **Destruction:** When the `MutProxy` goes out of scope, its `Drop` implementation is executed. This is the critical step where the potentially modified value from the temporary copy is taken, re-encoded, and written back into the correct bit position in the parent `FixedVec`'s storage.\n\nThis is a classic copy-on-read, write-on-drop mechanism. It provides a safe and ergonomic abstraction for mutating non-addressable data, preserving the feel of direct manipulation while correctly handling the bit-level operations under the hood. The overhead is a single read at the start of the proxy's life and a single write at the end.\n\n```rust\nuse compressed_intvec::fixed::{FixedVec, UFixedVec, BitWidth};\n\nlet data: &[u32] = &[10, 20, 30];\nlet mut vec: UFixedVec\u003Cu32> = FixedVec::builder()\n    .bit_width(BitWidth::Explicit(7))\n    .build(data)\n    .unwrap();\n\n// vec.at_mut(1) returns an Option\u003CMutProxy\u003C...>>\nif let Some(mut proxy) = vec.at_mut(1) {\n    // The DerefMut trait allows us to modify the proxy's internal copy.\n    *proxy = 99;\n} // The proxy is dropped here. Its Drop impl writes 99 back to the vec.\n\nassert_eq!(vec.get(1), Some(99));\n```\n\nThe overhead of this approach is a single read on the proxy's construction and a single write on its destruction, which is an acceptable trade-off for an ergonomic and safe mutable API.\n\n### Zero-Copy Views\n\nA `Vec`-like API needs to support slicing. Creating a `FixedVec` that borrows its data (`B = &[W]`) is the first step for this, but we also need a dedicated slice type to represent a sub-region of another `FixedVec` without copying data. For this we can create `FixedVecSlice`.\n\nWe can implement this as a classic \"fat pointer\" struct. It holds a reference to the parent `FixedVec` and a `Range\u003Cusize>` that defines the logical boundaries of the view.\n\n```rust\n// A zero-copy view into a contiguous portion of a FixedVec.\n#[derive(Debug)]\npub struct FixedVecSlice\u003CV> {\n    pub(super) parent: V,\n    pub(super) range: Range\u003Cusize>,\n}\n```\n\nThe generic parameter `V` is a reference to the parent vector. This allows the same `FixedVecSlice` struct to represent both immutable (`V = &FixedVec\u003C...>`) and mutable (`V = &mut FixedVec\u003C...>`) views.\n\nWe can implement all the operations on the slice by translating the slice-relative index into an absolute index in the parent vector. For example, we can easily implement `get_unchecked` with this delegation:\n\n```rust\n// Index translation within the slice's get_unchecked\npub unsafe fn get_unchecked(&self, index: usize) -> T {\n    debug_assert!(index \u003C self.len());\n    // The index is relative to the slice, so we add the slice's start\n    // offset to get the correct index in the parent vector.\n    self.parent.get_unchecked(self.range.start + index)\n}\n```\n\nIn this way there is no code duplication; the slice re-uses the access logic of the parent `FixedVec`.\n\n## Mutable Slices\n\nFor mutable slices (`V = &mut FixedVec\u003C...>` ), we can provide mutable access to the slice's elements. We can easily implement the `at_mut` method on `FixedVecSlice` using the same principle of index translation:\n\n```rust\npub fn at_mut(&mut self, index: usize) -> Option\u003CMutProxy\u003C'_, T, W, E, B>> {\n    if index >= self.len() {\n        return None;\n    }\n    // The index is translated to the parent vector's coordinate space.\n    Some(MutProxy::new(&mut self.parent, self.range.start + index))\n}\n```\n\nA mutable slice borrows the parent `FixedVec` mutably. This means that while the slice exists, the parent vector cannot be accessed directly due to Rust's borrowing rules. Let's consider the following situation: we may need to split a mutable slice into two non-overlapping mutable slices. This is common for example in algorithms that operate on sub-regions of an array. However, implementing such a method requires to use some unsafe code. The method, let's say `split_at_mut`, must produce two `&mut` references from a single one. In order to be safe, we must prove to the compiler that the logical ranges they represent (`0..mid` and `mid..len`) are disjoint.\n\n```rust\npub fn split_at_mut(&mut self, mid: usize) -> (FixedVecSlice\u003C&mut Self>, FixedVecSlice\u003C&mut Self>) {\n    assert!(mid \u003C= self.len, \"mid > len in split_at_mut\");\n    // SAFETY: The two slices are guaranteed not to overlap.\n    unsafe {\n        let ptr = self as *mut Self;\n        let left = FixedVecSlice::new(&mut *ptr, 0..mid);\n        let right = FixedVecSlice::new(&mut *ptr, mid..self.len());\n        (left, right)\n    }\n}\n```\n\nThis combination of a generic slice struct and careful pointer manipulation allows us to build a rich, safe, and zero-copy API for both immutable and mutable views, mirroring Rust's native slice\n\n# Next Steps\n\nOur `FixedVec` works pretty well at the current state, but its strengths are tied to two key assumptions: a single thread of execution and uniformly bounded data. Real-world systems often challenge both. This opens up two distinct paths for us to extend our design: one to handle concurrency, and another to adapt to more complex data distributions.\n\n## Concurrent Access\n\nThe design of `FixedVec` is fundamentally single-threaded. Its mutable access relies on direct writes to the underlying bit buffer, a model that offers no guarantees in a concurrent setting. The core conflict lies between our data layout and the hardware's atomic primitives. CPU instructions like compare-and-swap operate on aligned machine words, typically `u64`. Our elements, however, are packed at arbitrary bit offsets and can span the boundary between two words.\n\nThis means a single logical updateâ€”modifying one elementâ€”might require writing to two separate `u64` words. Performing this as two distinct atomic writes would create a race condition, leaving the data in a corrupt state if another thread reads between them. A single atomic write to one of the underlying `u64` words would be equally disastrous, as it could simultaneously alter parts of two different elements. The problem then is how to build atomic semantics on top of a non-atomic memory layout. In the next post, we will construct a solution that provides thread-safe, atomic operations for our bit-packed vector.\n\n## Variable Length Encoding\n\nLet's consider the following scenario: we have a large collection of integers, all of which are small, say in the range `[0, 255]`, but with a few outliers that are much larger, perhaps up to `u64::MAX`. If we were to use our `FixedVec` with a `bit_width` of 64 to accommodate the outliers, we would waste a significant amount of memory on the small integers. Conversely, if we chose a smaller `bit_width`, we would be unable to represent the outliers at all.\n\nThe fixed-width model rests on that critical assumption of uniformly bounded data. Its performance comes from this predictability, but this rigid structure is also its main weakness.\n\nFor skewed data distributions, we need a different model. Instead of a fixed number of bits per element, we can use variable-length instantaneous codes, where smaller numbers are represented by shorter bit sequences. This gives us excellent compression, but it breaks our O(1) random access guarantee. We can no longer compute the location of the i-th element with a simple multiplication. The solution is to trade a small amount of space for a speedup in access time. We can build a secondary index that stores the bit-offset of every k-th element. This sampling allows us to seek to a nearby checkpoint and decode sequentially from there, restoring amortized O(1) access. In a future article, we'll explore this second vector type, its own set of performance trade-offs, and how we can choose the best encoding for our data.\n\n---\n\nWe will explore this two paths in future articles. In the meantime, if you want to try them out, they are both already implemented in the library. You can find the atomic version in the [atomic](https://docs.rs/compressed-intvec/latest/compressed_intvec/fixed/atomic/index.html) module and the variable-length version in the [variable](https://docs.rs/compressed-intvec/latest/compressed_intvec/variable/struct.IntVec.html) module.","src/data/blog/compressed-fixedvec.md","c97e5e752b9bdb2b",{"html":551,"metadata":552},"\u003Cp>If youâ€™ve ever worked with massive datasets, you know that memory usage can quickly become a bottleneck. While developing succinct data structures, I found myself needing to store large arrays of integersâ€”values with no monotonicity or other exploitable patterns, that I knew came from a universe much smaller than their typeâ€™s theoretical capacity.\u003C/p>\n\u003Cp>In this post, we will explore the engineering challenges involved in implementing an efficient vector-like data structure in Rust that stores integers in a compressed, bit-packed format. We will focus on achieving O(1) random access performance while minimizing memory usage. We will try to mimic the ergonomics of Rustâ€™s standard \u003Ccode>Vec&#x3C;T>\u003C/code> as closely as possible, including support for mutable access and zero-copy slicing.\u003C/p>\n\u003Cul>\n\u003Cli>All the code can be found on github: \u003Ca href=\"https://github.com/lukefleed/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003Cli>This is also published as a crate on crates.io: \u003Ca href=\"https://crates.io/crates/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>You can discuss this post on \u003Ca href=\"https://news.ycombinator.com/item?id=45361578\">Hacker News\u003C/a>, \u003Ca href=\"https://lobste.rs/s/u1rffj/engineering_fixed_width_bit_packed\">Lobsters\u003C/a> or \u003Ca href=\"https://www.reddit.com/r/rust/comments/1npf41d/engineering_a_fixedwidth_bitpacked_integer_vector/\">Reddit\u003C/a>.\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"table-of-contents\">Table of contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-waste-in-standard-vectors\">Memory Waste in Standard Vectors\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#packing-and-accessing-bits\">Packing and Accessing Bits\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#crossing-word-boundaries\">Crossing Word Boundaries\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#faster-reads-unaligned-access\">Faster Reads: Unaligned Access\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#random-access-performance\">Random Access Performance\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#iterating-over-values\">Iterating Over Values\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#double-ended-iteration\">Double-Ended Iteration\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#writing-bits\">Writing bits\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#in-word-write\">In-Word Write\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#spanning-write\">Spanning Write\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#random-write-performance\">Random Write Performance\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#architecture\">Architecture\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#word-trait-the-physical-storage-layer\">\u003Ccode>Word\u003C/code> Trait: The Physical Storage Layer\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#storable-trait-the-logical-type-layer\">\u003Ccode>Storable\u003C/code> Trait: The Logical Type Layer\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#builder-pattern\">Builder Pattern\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#doing-more-than-just-reading\">Doing more than just reading\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#mutability-proxy-objects\">Mutability: Proxy Objects\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#zero-copy-views\">Zero-Copy Views\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#mutable-slices\">Mutable Slices\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#next-steps\">Next Steps\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#concurrent-access\">Concurrent Access\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#variable-length-encoding\">Variable Length Encoding\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch1 id=\"memory-waste-in-standard-vectors\">Memory Waste in Standard Vectors\u003C/h1>\n\u003Cp>In Rust, the contract of a \u003Ccode>Vec&#x3C;T>\u003C/code> (where \u003Ccode>T\u003C/code> is a primitive integer type like \u003Ccode>u64\u003C/code> or \u003Ccode>i32\u003C/code>) is simple: O(1) random access in exchange for a memory layout that is tied to the static size of \u003Ccode>T\u003C/code>. This is a good trade-off, until it isnâ€™t. When the dynamic range of the stored values is significantly smaller than the typeâ€™s capacity, this memory layout leads to substantial waste.\u003C/p>\n\u003Cp>Consider storing the value \u003Ccode>5\u003C/code> within a \u003Ccode>Vec&#x3C;u64>\u003C/code>. Its 8-byte in-memory representation is:\u003C/p>\n\u003Cdiv align=\"center\">\n\u003Cp>\u003Ccode>00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000101\u003C/code>\u003C/p>\n\u003C/div>\n\u003Cp>Only 3 bits are necessary to represent the value, leaving 61 bits as zero-padding. The same principle applies, albeit less dramatically, when storing \u003Ccode>5\u003C/code> in a \u003Ccode>u32\u003C/code> or \u003Ccode>u16\u003C/code>. At scale, this overhead becomes prohibitive. A vector of one billion \u003Ccode>u64\u003C/code> elements consumes \u003Ccode>10^9 * std::mem::size_of::&#x3C;u64>()\u003C/code>, or approximately 8 GB of memory, even if every element could fit within a single byte.\u003C/p>\n\u003Cp>The canonical solution is bit packing, which aligns data end-to-end in a contiguous bitvector. However, this optimization has historically come at the cost of random access performance. The O(1) access guarantee of \u003Ccode>Vec&#x3C;T>\u003C/code> is predicated on simple pointer arithmetic: \u003Ccode>address = base_address + index * std::mem::size_of::&#x3C;T>()\u003C/code>. Tightly packing the bits invalidates this direct address calculation, seemingly forcing a trade-off between memory footprint and access latency.\u003C/p>\n\u003Cp>This raises the central question that with this post we aim to answer: is it possible to design a data structure that decouples its memory layout from the static size of \u003Ccode>T\u003C/code>, adapting instead to the dataâ€™s true dynamic range, without sacrificing the O(1) random access that makes \u003Ccode>Vec&#x3C;T>\u003C/code> so effective?\u003C/p>\n\u003Ch1 id=\"packing-and-accessing-bits\">Packing and Accessing Bits\u003C/h1>\n\u003Cp>If the dynamic range of our data is known, we can define a fixed \u003Ccode>bit_width\u003C/code> for every integer. For instance, if the maximum value in a dataset is \u003Ccode>1000\u003C/code>, we know every number can be represented in 10 bits, since \u003Ccode>2^10 = 1024\u003C/code>. Instead of allocating 64 bits per element, we can store them back-to-back in a contiguous bitvector, forming the core of what from now on weâ€™ll refer as \u003Ccode>FixedVec\u003C/code>. We can immagine such data strucutre as a logical array of \u003Ccode>N\u003C/code> integers, each \u003Ccode>bit_width\u003C/code> bits wide, stored in a backing buffer of \u003Ccode>u64\u003C/code> words.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Backing storage\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Number of bits per element\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Number of elements\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Precomputed mask for extraction\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where the role of the \u003Ccode>mask\u003C/code> field is to isolate the relevant bits during extraction. For a \u003Ccode>bit_width\u003C/code> of 10, the mask would be \u003Ccode>0b1111111111\u003C/code>.\u003C/p>\n\u003Cp>This immediately solves the space problem, but how can we find the \u003Ccode>i\u003C/code>-th element in O(1) time if it doesnâ€™t align to a byte boundary? The answer lies in simple arithmetic. The starting bit position of any element is a direct function of its index. Given a backing store of \u003Ccode>u64\u003C/code> words, we can locate any value by calculating its absolute bit position and then mapping that to a specific word and an offset within that word.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Absolute bit position of the value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Which u64 word to read\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Where the value starts in that word\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With these values, the implementation of \u003Ccode>get_unchecked\u003C/code> becomes straightforward. Itâ€™s a two-step process: fetch the correct word from our backing \u003Ccode>Vec&#x3C;u64>\u003C/code>, then use bitwise operations to isolate the specific bits we need.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A simplified look at the core get_unchecked logic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 1. Fetch the word from the backing store\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 2. Shift and mask to extract the value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Letâ€™s trace an access with \u003Ccode>bit_width = 10\u003C/code> for the element at \u003Ccode>index = 7\u003C/code>. The starting bit position is \u003Ccode>7 * 10 = 70\u003C/code>. This maps to \u003Ccode>word_index = 1\u003C/code> and \u003Ccode>bit_offset = 6\u003C/code>. Our 10-bit integer begins at the 6th bit of the \u003Cem>second\u003C/em> \u003Ccode>u64\u003C/code> word in our storage.\u003C/p>\n\u003Cp>The right-shift \u003Ccode>>>\u003C/code> operation moves the bits of the entire \u003Ccode>u64\u003C/code> word to the right by \u003Ccode>bit_offset\u003C/code> positions. This aligns the start of our desired 10-bit value with the least significant bit (LSB) of the word. The final step is to isolate our value. A pre-calculated \u003Ccode>mask\u003C/code> (e.g., \u003Ccode>0b1111111111\u003C/code> for 10 bits) is applied with a bitwise AND \u003Ccode>&#x26;\u003C/code>. This zeroes out any high-order bits from the word, leaving just our target integer.\u003C/p>\n\u003Ch2 id=\"crossing-word-boundaries\">Crossing Word Boundaries\u003C/h2>\n\u003Cp>The single-word access logic is fast, but it only works as long as \u003Ccode>bit_offset + bit_width &#x3C;= 64\u003C/code>. This assumption breaks down as soon as an integerâ€™s bit representation needs to cross the boundary from one \u003Ccode>u64\u003C/code> word into the next. This is guaranteed to happen for any \u003Ccode>bit_width\u003C/code> that is not a power of two. For example, with a 10-bit width, the element at \u003Ccode>index = 6\u003C/code> starts at bit position 60. Its 10 bits will occupy bits 60-63 of the first word and bits 0-5 of the second. The simple right-shift-and-mask trick fails here.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/fixedvec.svg\" alt=\"crossing word boundaries\">\u003C/p>\n\u003Cp>To correctly decode the value, we must read \u003Cem>two\u003C/em> consecutive \u003Ccode>u64\u003C/code> words and combine their bits. This splits our \u003Ccode>get_unchecked\u003C/code> implementation into two paths. The first is the fast path weâ€™ve already seen. The second is a new path for spanning values.\u003C/p>\n\u003Cp>To get the lower bits of the value, we read the first word and shift right, just as before. This leaves the upper bits of the word as garbage.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>To get the upper bits of the value, we read the \u003Cem>next\u003C/em> word. The bits we need are at the beginning of this word, so we shift them left to align them correctly.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Finally, we combine the two parts with a bitwise OR and apply the mask to discard any remaining high-order bits from the \u003Ccode>high_part\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The line \u003Ccode>limbs.get_unchecked(word_index + 1)\u003C/code> introduces a safety concern: if we are reading the last element of the vector, \u003Ccode>word_index + 1\u003C/code> could point past the end of our buffer, leading to undefined behavior. To prevent this, our builder must always allocate one extra padding word at the end of the storage.\u003C/p>\n\u003Cp>Integrating these two paths gives us our final \u003Ccode>get_unchecked\u003C/code> implementation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Fast path: value is fully within one word\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Slow path: value spans two words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"faster-reads-unaligned-access\">Faster Reads: Unaligned Access\u003C/h2>\n\u003Cp>Our \u003Ccode>get_unchecked\u003C/code> implementation is correct, but the slow path for spanning values requires two separate, aligned memory reads. The instruction sequence for this method involves at least two load instructions, multiple shifts, and a bitwise OR. These instructions have data dependencies: the shifts cannot execute until the loads complete, and the OR cannot execute until both shifts are done. This dependency chain can limit the CPUâ€™s instruction-level parallelism and create pipeline stalls if the memory accesses miss the L1 cache.\u003C/p>\n\u003Cp>Letâ€™s have a look at the machine code generated by this method. We can create a minimal binary with an \u003Ccode>#[inline(never)]\u003C/code> function that calls \u003Ccode>get_unchecked\u003C/code> on a known spanning index, then use \u003Ca href=\"https://crates.io/crates/cargo-asm\">\u003Ccode>cargo asm\u003C/code>\u003C/a> to inspect the disassembly.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; asm_test::aligned::get_aligned (spanning path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">LBB14_2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let low = *limbs.get_unchecked(word_index) >> bit_offset;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">r8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; &#x3C;&#x3C;&#x3C; LOAD #1 (low_part)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let high = *limbs.get_unchecked(word_index + 1) &#x3C;&#x3C; (64 - bit_offset);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">r8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; &#x3C;&#x3C;&#x3C; LOAD #2 (high_part)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shr\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">cl\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          ; shift right of low_part\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shl\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">cl\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          ; shift left of high_part\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        or\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsi\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          ; combine results\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The instruction \u003Ccode>mov rsi, qword ptr [r8 + 8*rdx]\u003C/code> is our first memory access. It loads a 64-bit value (\u003Ccode>qword\u003C/code>) into the \u003Ccode>rsi\u003C/code> register. The address is calculated using base-plus-index addressing: \u003Ccode>r8\u003C/code> holds the base address of our \u003Ccode>limbs\u003C/code> buffer, and \u003Ccode>rdx\u003C/code> holds the \u003Ccode>word_index\u003C/code>. This corresponds directly to \u003Ccode>limbs[word_index]\u003C/code>.\u003C/p>\n\u003Cp>Immediately following is \u003Ccode>mov rdx, qword ptr [r8 + 8*rdx + 8]\u003C/code>. This is our second, distinct memory access. It loads the \u003Cem>next\u003C/em> 64-bit word from memory by adding an 8-byte offset to the previous address. This corresponds to \u003Ccode>limbs[word_index + 1]\u003C/code>.\u003C/p>\n\u003Cp>Only after both of these \u003Ccode>mov\u003C/code> instructions complete can the CPU proceed. The \u003Ccode>shr rsi, cl\u003C/code> instruction (shift right \u003Ccode>rsi\u003C/code> by the count in \u003Ccode>cl\u003C/code>) cannot execute until the first \u003Ccode>mov\u003C/code> has placed a value in \u003Ccode>rsi\u003C/code>. Similarly, \u003Ccode>shl rdx, cl\u003C/code> depends on the second \u003Ccode>mov\u003C/code>. Finally, \u003Ccode>or rdx, rsi\u003C/code> depends on both shifts.\u003C/p>\n\u003Cp>This sequence of operationsâ€”loading two adjacent 64-bit words, shifting each, and combining them is a software implementation of what is, conceptually, a \u003Ca href=\"https://en.wikipedia.org/wiki/Barrel_shifter\">128-bit barrel shifter\u003C/a>. We are selecting a 64-bit window from a virtual 128-bit integer formed by concatenating the two words from memory.\u003C/p>\n\u003Cp>\u003Cstrong>Can we do better then this?\u003C/strong> Potentially, yes. We can replace this multi-instruction sequence with something more direct by delegating the complexity to the hardware and performing a single unaligned memory read. Modern x86-64 CPUs handle this directly: when an unaligned load instruction is issued, the CPUâ€™s memory controller fetches the necessary cache lines and the load/store unit reassembles the bytes into the target register. This entire process is a single, optimized micro-operation.\u003C/p>\n\u003Cp>We can try to implement a more aggressive access method. The strategy is to calculate the exact \u003Cem>byte\u003C/em> address where our data begins and perform a single, unaligned read of a full \u003Ccode>W\u003C/code> word from that position.\u003C/p>\n\u003Cp>The implementation first translates the absolute bit position into a byte address and a residual bit offset within that byte.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With the byte-level address, we get a raw \u003Ccode>*const u8\u003C/code> pointer to our storage and perform the unaligned read. The \u003Ca href=\"https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html\">read_unaligned\u003C/a> intrinsic in Rust compiles down to a single machine instruction that the hardware can execute efficiently.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_limbs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// This read may cross hardware word boundaries, but the CPU handles it.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">read_unaligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On a Little-Endian system, the loaded \u003Ccode>word\u003C/code> now contains our target integer, but itâ€™s shifted by \u003Ccode>bit_rem\u003C/code> positions. A simple right shift aligns our value to the LSB, and applying the mask isolates it.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> final_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This operation is safe only because, as said before, we are supposing that our builder guarantees a padding word at the end of the storage buffer. Combining all these steps, we get our final implementation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unaligned_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_limbs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // SAFETY: The builder guarantees an extra padding word at the end.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">read_unaligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Letâ€™s have a look at the generated machine code for this new method when accessing an index that spans words:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; asm_test::unaligned::get_unaligned\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">LBB15_1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let bit_pos = index * self.bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        imul\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rcx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rax\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let byte_pos = bit_pos / 8;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rcx\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shr\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; self.bits.as_ref()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; unsafe { crate::intrinsics::copy_nonoverlapping(src, dst, count) }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; &#x3C;&#x3C;&#x3C; SINGLE UNALIGNED LOAD\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; self >> other\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        and\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> cl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">7\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shr\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">cl\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; fn bitand(self, rhs: $t) -> $t { self &#x26; rhs }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        and\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The initial \u003Ccode>imul\u003C/code> and \u003Ccode>shr rax, 3\u003C/code> (a fast division by 8) correspond to the calculation of \u003Ccode>byte_pos\u003C/code>. The instruction \u003Ccode>mov rdx, qword ptr [rdi + 8]\u003C/code> loads the base address of our \u003Ccode>limbs\u003C/code> buffer into the \u003Ccode>rdx\u003C/code> register.\u003C/p>\n\u003Cp>The instruction \u003Ccode>mov rax, qword ptr [rdx + rax]\u003C/code> is our single unaligned load. The address \u003Ccode>[rdx + rax]\u003C/code> is the sum of the bufferâ€™s base address and our calculated \u003Ccode>byte_pos\u003C/code>. This \u003Ccode>mov\u003C/code> instruction reads 8 bytes (a \u003Ccode>qword\u003C/code>) directly from this potentially unaligned memory location into the \u003Ccode>rax\u003C/code> register. We can see that as we hoped, the \u003Ca href=\"https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html\">read_unaligned\u003C/a> intrinsic has been compiled down to a single hardware instruction.\u003C/p>\n\u003Cp>The next instructions handle the extraction. The \u003Ccode>and cl, 7\u003C/code> and \u003Ccode>shr rax, cl\u003C/code> sequence corresponds to our \u003Ccode>>> bit_rem\u003C/code>. \u003Ccode>cl\u003C/code> holds the lower bits of the original \u003Ccode>bit_pos\u003C/code> (our \u003Ccode>bit_rem\u003C/code>), and the shift aligns our desired value to the LSB of the \u003Ccode>rax\u003C/code> register. Finally, \u003Ccode>and rax, qword ptr [rdi + 32]\u003C/code> applies the pre-calculated mask, which is stored at an offset from the \u003Ccode>self\u003C/code> pointer in \u003Ccode>rdi\u003C/code>.\u003C/p>\n\u003Ch2 id=\"random-access-performance\">Random Access Performance\u003C/h2>\n\u003Cp>We can now benchmark the latency of 1 million random access operations on a vector containing 10 million elements. For each \u003Ccode>bit_width\u003C/code>, we generate data with a uniform random distribution in the range \u003Ccode>[0, 2^bit_width)\u003C/code>. The code for the benchmark is available here: \u003Ca href=\"https://github.com/lukefleed/compressed-intvec/blob/master/benches/fixed/bench_random_access.rs\">\u003Ccode>bench-intvec\u003C/code>\u003C/a>\u003C/p>\n\u003Cp>Our baseline is the smallest standard \u003Ccode>Vec&#x3C;T>\u003C/code> capable of holding the data (\u003Ccode>Vec&#x3C;u8>\u003C/code> for \u003Ccode>bit_width &#x3C;= 8\u003C/code>, etc.). We also include results from \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a>, \u003Ca href=\"https://docs.rs/succinct/latest/succinct/trait.IntVec.html\">\u003Ccode>succinct\u003C/code>\u003C/a>, and \u003Ca href=\"https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\">\u003Ccode>simple-sds-sbwt\u003C/code>\u003C/a> for context. I am not aware of any other Rust crates that implement fixed-width bit-packed integer vectors, so if you know of any, please let me know!\u003C/p>\n\u003Ciframe src=\"/bench-intvec/fixed_random_access_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>We can see that for \u003Ccode>bit_width\u003C/code> values below 32, the \u003Ccode>get_unaligned_unchecked\u003C/code> of our \u003Ccode>FixedVec\u003C/code> is almost always faster than the corresponding \u003Ccode>Vec&#x3C;T>\u003C/code> baseline. This is a result of improved cache locality. A 64-byte L1 cache line can hold 64 elements from a \u003Ccode>Vec&#x3C;u8>\u003C/code>. With a \u003Ccode>bit_width\u003C/code> of 4, the same cache line holds \u003Ccode>(64 * 8) / 4 = 128\u003C/code> elements from our \u003Ccode>FixedVec\u003C/code>. This increased density improves the cache hit rate for random access patterns, and the latency reduction from avoiding DRAM access outweighs the instruction cost of the bitwise extraction. For values of \u003Ccode>bit_width\u003C/code> above 32, the performance of \u003Ccode>FixedVec\u003C/code> are \u003Cem>very slightly\u003C/em> worse than the \u003Ccode>Vec&#x3C;T>\u003C/code> baseline, as the cache locality advantage diminishes. However, the memory savings remain.\u003C/p>\n\u003Cp>The performance delta between \u003Ccode>get_unaligned_unchecked\u003C/code> and \u003Ccode>get_unchecked\u003C/code> confirms the unaligned access strategy discussed before: a single \u003Ccode>read_unaligned\u003C/code> instruction is more efficient than the two dependent aligned reads required by the logic for spanning words.\u003C/p>\n\u003Cp>We can see that the implementation of \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a> is almost on par with ours. The other two crates, \u003Ca href=\"https://docs.rs/succinct/latest/succinct/trait.IntVec.html\">\u003Ccode>succinct\u003C/code>\u003C/a> and \u003Ca href=\"https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\">\u003Ccode>simple-sds-sbwt\u003C/code>\u003C/a>, are significantly slower (note that the Y-axis is logarithmic). Tho, itâ€™s worth noting that neither of these last two crates provides unchecked or unaligned access methods, so their implementations are inherently more conservative.\u003C/p>\n\u003Ch2 id=\"iterating-over-values\">Iterating Over Values\u003C/h2>\n\u003Cp>The most common operation on any \u003Ccode>Vec\u003C/code>-like structure is, after all, a simple \u003Ccode>for\u003C/code> loop. The simplest way to implement \u003Ccode>iter()\u003C/code> would be to just wrap \u003Ccode>get()\u003C/code> in a loop:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A naive, inefficient iterator\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... do something with value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This works, but itâ€™s terribly inefficient. Every single call to \u003Ccode>get(i)\u003C/code> independently recalculates the \u003Ccode>word_index\u003C/code> and \u003Ccode>bit_offset\u003C/code> from scratch. Weâ€™re throwing away valuable state, our current position in the bitstream, on every iteration, forcing the CPU to perform redundant multiplications and divisions.\u003C/p>\n\u003Cp>We can think then about a \u003Cem>stateful\u003C/em> iterator. It should operate directly on the bitvector, maintaining its own position. Instead of thinking in terms of logical indices, it should think in terms of a â€œbit windowâ€, a local \u003Ccode>u64\u003C/code> register that holds the current chunk of bits being processed.\u003C/p>\n\u003Cp>The idea is simple: the iterator loads one \u003Ccode>u64\u003C/code> word from the backing store into its window. It then satisfies \u003Ccode>next()\u003C/code> calls by decoding values directly from this in-register window. Only when the window runs out of bits does it need to go back to memory for the next \u003Ccode>u64\u003C/code> word. This amortizes the cost of memory access over many \u003Ccode>next()\u003C/code> calls.\u003C/p>\n\u003Cp>For forward iteration, the state is minimal:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecIter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">...\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_bits_in_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>next()\u003C/code> method first checks if the current \u003Ccode>front_window\u003C/code> has enough bits to satisfy the request. If \u003Ccode>self.front_bits_in_window >= bit_width\u003C/code>, itâ€™s the fast path: a simple shift and mask on a register, which is incredibly fast.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Inside next(), fast path:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_bits_in_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_bits_in_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If the window is running low on bits, we hit the slower path. The next value spans the boundary between our current window and the next \u003Ccode>u64\u003C/code> word in memory. We must read the next word, combine its bits with the remaining bits in our current window, and then extract the value. This is the same logic as the spanning-word \u003Ccode>get()\u003C/code>, but itâ€™s performed incrementally.\u003C/p>\n\u003Ch3 id=\"double-ended-iteration\">Double-Ended Iteration\u003C/h3>\n\u003Cp>But I want my iterator to be bidirectional! Well, then we need to ensure it implements \u003Ca href=\"https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html\">\u003Ccode>DoubleEndedIterator\u003C/code>\u003C/a> and supports \u003Ca href=\"https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html#tymethod.next_back\">\u003Ccode>next_back()\u003C/code>\u003C/a>. This throws a wrench in our simple stateful model. A single window and cursor can only move in one direction.\u003C/p>\n\u003Cp>The solution is to maintain two independent sets of state: one for the front and one for the back. The \u003Ccode>FixedVecIter\u003C/code> needs to track two windows, two bit counters, and two word indices.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecIter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">...\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // State for forward iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_bits_in_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // State for backward iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_bits_in_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Initializing the front is easy: we load \u003Ccode>limbs[0]\u003C/code> into \u003Ccode>front_window\u003C/code>. The back is more complex. We must calculate the exact word index and the number of valid bits in the \u003Cem>last\u003C/em> word that contains data. This requires a bit of arithmetic to handle cases where the data doesnâ€™t perfectly fill the final word.\u003C/p>\n\u003Cp>The \u003Ccode>next()\u003C/code> method consumes from the \u003Ccode>front_window\u003C/code>, advancing the front state. The \u003Ccode>next_back()\u003C/code> method consumes from the \u003Ccode>back_window\u003C/code>, advancing the back state. The iterator is exhausted when \u003Ccode>front_index\u003C/code> meets \u003Ccode>back_index\u003C/code>.\u003C/p>\n\u003Cblockquote>\n\u003Cp>The full implementation can be found in the iter module of the \u003Ca href=\"https://github.com/lukefleed/compressed-intvec/blob/master/src/fixed/iter.rs\">library\u003C/a>\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"writing-bits\">Writing bits\u003C/h1>\n\u003Cp>We have solved the read problem, but we may also want to modify values in place. A method like \u003Ccode>set(index, value)\u003C/code> seems simple, but it opens up the same can of worms as \u003Ccode>get\u003C/code>, just in reverse. We canâ€™t just write the new value; we have to do so without clobbering the adjacent, unrelated data packed into the same \u003Ccode>u64\u003C/code> word.\u003C/p>\n\u003Cp>Just like with reading, the logic splits into two paths. The â€œfast pathâ€ handles values that are fully contained within a single \u003Ccode>u64\u003C/code>. Here, we canâ€™t just overwrite the word. We first need to clear out the bits for the element weâ€™re replacing and then merge in the new value.\u003C/p>\n\u003Ch2 id=\"in-word-write\">In-Word Write\u003C/h2>\n\u003Cp>Our goal here is to update a \u003Ccode>bit_width\u003C/code>-sized slice of a \u003Ccode>u64\u003C/code> word while leaving the other bits untouched. This operation must be a read-modify-write sequence to avoid corrupting adjacent elements. The most efficient way to implement this is to load the entire word into a register, perform all bitwise modifications locally, and then write the final result back to memory in a single store operation.\u003C/p>\n\u003Cp>First, we load the word from our backing \u003Ccode>limbs\u003C/code> slice.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Next, we need to create a â€œholeâ€ in our local copy where the new value will go. We do this by creating a mask that has ones \u003Cem>only\u003C/em> in the bit positions we want to modify, and then inverting it to create a clearing mask.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// For a value at bit_offset, the mask must also be shifted.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> clear_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Applying this mask zeroes out the target bits in our register copy.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> clear_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With the target bits zeroed, we can merge our new value. The value is first shifted left by \u003Ccode>bit_offset\u003C/code> to align it correctly within the 64-bit word. Then, a bitwise OR merges it into the â€œholeâ€ we just created.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Shift the new value into position and merge it.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value_w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Finally, with the modifications complete, we write the updated word from the register back to memory in a single operation.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This entire sequence of one read, two bitwise operations in-register, one write is the canonical and most efficient way to perform a sub-word update.\u003C/p>\n\u003Ch2 id=\"spanning-write\">Spanning Write\u003C/h2>\n\u003Cp>Now for the hard part: writing a value that crosses a word boundary. This operation must modify two separate \u003Ccode>u64\u003C/code> words in our backing store. Itâ€™s the inverse of the spanning read. We need to split our \u003Ccode>value_w\u003C/code> into a low part and a high part and write each to the correct word, minimizing memory accesses.\u003C/p>\n\u003Cp>To operate on two distinct memory locations, \u003Ccode>limbs[word_index]\u003C/code> and \u003Ccode>limbs[word_index + 1]\u003C/code>, we first need mutable access to both. In a safe, hot path like this, we can use \u003Ccode>split_at_mut_unchecked\u003C/code> to bypass Rustâ€™s borrow checker bounds checks, as we have already guaranteed through our logic that both indices are valid.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// SAFETY: We know word_index and word_index + 1 are valid.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">split_at_mut_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Our strategy is to read both words into registers, perform all bitwise logic locally, and then write both modified words back to memory. This minimizes the time we hold mutable references and can improve performance.\u003C/p>\n\u003Cp>First, we handle the \u003Ccode>low_word\u003C/code>. We need to replace its high bits (from \u003Ccode>bit_offset\u003C/code> onwards) with the low bits of our new value. The most direct way is to create a mask for the bits we want to \u003Cem>keep\u003C/em>. The expression \u003Ccode>(1 &#x3C;&#x3C; bit_offset) - 1\u003C/code> is a bit-twiddling trick to generate a mask with \u003Ccode>bit_offset\u003C/code> ones at the least significant end.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Create a mask to preserve the low `bit_offset` bits of the word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With the target bits zeroed out, we merge in the low part of our new value. A left shift aligns it correctly, and the high bits of \u003Ccode>value_w\u003C/code> are naturally shifted out of the register.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Merge in the low part of our new value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value_w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Next, we handle the \u003Ccode>high_word\u003C/code> in a symmetrical fashion. We need to write the remaining high bits of \u003Ccode>value_w\u003C/code> into the low-order bits of this second word. First, we calculate how many bits of our value actually belong in the first word:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> remaining_bits_in_first_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now, we read the second word and create a mask to clear the low-order bits where our data will be written. With the operation \u003Ccode>self.mask >> remaining_bits_in_first_word\u003C/code> we can determine how many bits of our value spill into the second word, creating a mask for them. Inverting this gives us a mask to \u003Cem>preserve\u003C/em> the existing high-order bits of the \u003Ccode>high_word\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Clear the low bits of the second word that will be overwritten.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> remaining_bits_in_first_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Finally, we isolate the high part of \u003Ccode>value_w\u003C/code> by right-shifting it by the number of bits we already wrote, and merge it into the cleared space.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Merge in the high part of our new value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value_w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> remaining_bits_in_first_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"random-write-performance\">Random Write Performance\u003C/h2>\n\u003Cp>As with reads, we can benchmark the latency of 1 million random write operations on a vector containing 10 million elements. The code for the benchmark is available here: [\u003Ccode>bench-intvec-writes\u003C/code>].\u003C/p>\n\u003Ciframe src=\"/bench-intvec/random_write_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>Here, the \u003Ccode>Vec&#x3C;T>\u003C/code> baseline is the clear winner across almost all bit-widths. This isnâ€™t surprising. A \u003Ccode>set\u003C/code> operation in a \u003Ccode>Vec&#x3C;T>\u003C/code> compiles down to a single \u003Ccode>MOV\u003C/code> instruction with a simple addressing mode (\u003Ccode>[base + index * element_size]\u003C/code>). Itâ€™s about as fast as the hardware allows.\u003C/p>\n\u003Cp>As for the reads, the performance of our \u003Ccode>FixedVec\u003C/code> is almost identical to that of \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a>. The other two crates, \u003Ca href=\"https://docs.rs/succinct/latest/succinct/trait.IntVec.html\">\u003Ccode>succinct\u003C/code>\u003C/a> and \u003Ca href=\"https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\">\u003Ccode>simple-sds-sbwt\u003C/code>\u003C/a>, are again slower. Itâ€™s worth noting that also for the writes, neither of these last two crates provides unchecked methods.\u003C/p>\n\u003Cblockquote>\n\u003Cp>For the 64-bit width case, I honestly have no idea what is going on with \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a> being so much faster than everything else, even then \u003Ccode>Vec&#x3C;u64>\u003C/code>! Mybe some weird compiler optimization? If you have any insight, please let me know.\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"architecture\">Architecture\u003C/h1>\n\u003Cp>With the access patterns defined, we need to think about the overall architecture of this data structure. A solution hardcoded to \u003Ccode>u64\u003C/code> would lack the flexibility to adapt to different use cases. We need a structure that is generic over the its principal components: the logical type, the physical storage type, the bit-level ordering, and ownership. We can define a struct that is generic over these four parameters:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Endianness\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AsRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where:\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>\u003Ccode>T\u003C/code> is the \u003Cstrong>logical element type\u003C/strong>, the type as seen by the user of the API (e.g., \u003Ccode>i16\u003C/code>, \u003Ccode>u32\u003C/code>). By abstracting \u003Ccode>T\u003C/code>, we divide the user-facing type from the internal storage representation.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Ccode>W\u003C/code> is the \u003Cstrong>physical storage word\u003C/strong>, which must implement our \u003Ccode>Word\u003C/code> trait. It defines the primitive unsigned integer (\u003Ccode>u32\u003C/code>, \u003Ccode>u64\u003C/code>, \u003Ccode>usize\u003C/code>) of the backing buffer and sets the granularity for all bitwise operations.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Ccode>E\u003C/code> requires the \u003Ccode>dsi-bitstream::Endianness\u003C/code> trait, allowing us to specify either Little-Endian (\u003Ccode>LE\u003C/code>) or Big-Endian (\u003Ccode>BE\u003C/code>) byte order.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Ccode>B\u003C/code>, which must implement \u003Ccode>AsRef&#x3C;[W]>\u003C/code>, represents the \u003Cstrong>backing storage\u003C/strong>. This abstraction over ownership allows \u003Ccode>FixedVec\u003C/code> to be either an owned container where \u003Ccode>B = Vec&#x3C;W>\u003C/code>, or a zero-copy, borrowed view where \u003Ccode>B = &#x26;[W]\u003C/code>. This makes it possible to, for example, construct a \u003Ccode>FixedVec\u003C/code> directly over a memory-mapped slice without any heap allocation.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>In this way, the compiler monomorphizes the struct and its methods for each concrete instantiation (e.g., \u003Ccode>FixedVec&#x3C;i16, u64, LE, Vec&#x3C;u64>>\u003C/code>), resulting in specialized code with no runtime overhead from the generic abstractions.\u003C/p>\n\u003Ch2 id=\"word-trait-the-physical-storage-layer\">\u003Ccode>Word\u003C/code> Trait: The Physical Storage Layer\u003C/h2>\n\u003Cp>The first step is to abstract the physical storage layer. The \u003Ccode>W\u003C/code> parameter must be a primitive unsigned integer type that supports bitwise operations. We can define a \u003Ccode>Word\u003C/code> trait that captures these requirements:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    UnsignedInt\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Bounded\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ToPrimitive\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> dsi_bitstream\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">traits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Word\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> NumCast\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Copy\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Send\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Sync\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> IntoAtomic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">static\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The numeric traits (\u003Ccode>UnsignedInt\u003C/code>, \u003Ccode>Bounded\u003C/code>, \u003Ccode>NumCast\u003C/code>, \u003Ccode>ToPrimitive\u003C/code>) are necessary for the arithmetic of offset and mask calculations. The \u003Ccode>dsi_bitstream::traits::Word\u003C/code> bound allows us to integrate with its \u003Ccode>BitReader\u003C/code> and \u003Ccode>BitWriter\u003C/code> implementations, offloading the bitstream logic. \u003Ccode>Send\u003C/code> and \u003Ccode>Sync\u003C/code> are non-negotiable requirements for any data structure that might be used in a concurrent context. The \u003Ccode>IntoAtomic\u003C/code> bound is particularly forward-looking: it establishes a compile-time link between a storage word like \u003Ccode>u64\u003C/code> and its atomic counterpart, \u003Ccode>AtomicU64\u003C/code>. We will use it later to build a thread safe, atomic version of \u003Ccode>FixedVec\u003C/code>. Finally, the \u003Ccode>const BITS\u003C/code> associated constant lets us write architecture-agnostic code that correctly adapts to \u003Ccode>u32\u003C/code>, \u003Ccode>u64\u003C/code>, or \u003Ccode>usize\u003C/code> words without \u003Ccode>cfg\u003C/code> flags.\u003C/p>\n\u003Ch2 id=\"storable-trait-the-logical-type-layer\">\u003Ccode>Storable\u003C/code> Trait: The Logical Type Layer\u003C/h2>\n\u003Cp>With the physical storage layer defined, we need a formal contract to connect it to the userâ€™s logical type \u003Ccode>T\u003C/code>. We can do this by creating the \u003Ccode>Storable\u003C/code> trait, which defines a bidirectional, lossless conversion.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Sized\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Copy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> into_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> from_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For unsigned types, the implementation is a direct cast. For signed types, however, we must map the \u003Ccode>iN\u003C/code> domain to the \u003Ccode>uN\u003C/code> domain required for bit-packing. A simple twoâ€™s complement bitcast is unsuitable, as \u003Ccode>i64(-1)\u003C/code> would become \u003Ccode>u64::MAX\u003C/code>, a value requiring the maximum number of bits. We need a better mapping that preserves small absolute values.\u003C/p>\n\u003Cp>We can use \u003Cstrong>ZigZag encoding\u003C/strong>, which maps integers with small absolute values to small unsigned integers. This is implemented via the \u003Ccode>ToNat\u003C/code> and \u003Ccode>ToInt\u003C/code> traits from \u003Ccode>dsi-bitstream\u003C/code>. The core encoding logic in \u003Ccode>to_nat\u003C/code> is:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// From dsi_bitstream::traits::ToNat\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> to_nat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">UnsignedInt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This operation works as follows: \u003Ccode>(self &#x3C;&#x3C; 1)\u003C/code> creates a space at the LSB. The term \u003Ccode>(self >> (Self::BITS - 1))\u003C/code> is an arithmetic right shift, which generates a sign maskâ€”all zeros for non-negative numbers, all ones for negative numbers. The final XOR uses this mask to interleave positive and negative integers: 0 becomes 0, -1 becomes 1, 1 becomes 2, -2 becomes 3, and so on.\u003C/p>\n\u003Cp>The decoding reverses this transformation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// From dsi_bitstream::traits::ToInt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> to_int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">SignedInt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_signed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_signed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Here, \u003Ccode>(self >> 1)\u003C/code> shifts the value back. The term \u003Ccode>-(self &#x26; 1)\u003C/code> creates a mask from the LSB (the original sign bit). In twoâ€™s complement, this becomes \u003Ccode>0\u003C/code> for even numbers (originally positive) and \u003Ccode>-1\u003C/code> (all ones) for odd numbers (originally negative). The final XOR with this mask correctly restores the original twoâ€™s complement representation.\u003C/p>\n\u003Cp>We might ask ourselves: why not just a direct bitcast for signed types, perhaps via a \u003Ccode>uN -> iN\u003C/code> chain. Well, while a direct \u003Ca href=\"https://doc.rust-lang.org/std/mem/fn.transmute.html\">transmute\u003C/a> between same-sized integer types is a no-op, the approach fails when the logical \u003Ccode>bit_width\u003C/code> is smaller than the physical type size. \u003Ccode>FixedVec\u003C/code>â€™s core logic extracts a \u003Ccode>bit_width\u003C/code>-sized unsigned integer from its storage. For example, when reading a 4-bit representation of \u003Ccode>-1\u003C/code> (binary \u003Ccode>1111\u003C/code>), the \u003Ccode>from_word\u003C/code> function receives the value \u003Ccode>15u64\u003C/code>. At this point, the context that those four bits represented a negative number is lost. A cast chain like \u003Ccode>15u64 as u8 as i8\u003C/code> would simply yield \u003Ccode>15i8\u003C/code>, not \u003Ccode>-1i8\u003C/code>.\u003C/p>\n\u003Cp>To correctly reconstruct the signed value, one would need to manually perform sign extension based on the known \u003Ccode>bit_width\u003C/code>. This involves checking the most significant bit of the extracted value and, if set, filling the higher-order bits of the word with ones. This logic requires a conditional branch, which can introduce pipeline stalls and degrade performance in tight loops. ZigZag decoding, by contrast, is a purely arithmetic, branch-free transformation. Its reconstruction logic is a simple sequence of bitwise shifts and XORs, making it a faster and more consistent choice for the hot path of data access.\u003C/p>\n\u003Cp>With this logic within the trait system, the main \u003Ccode>FixedVec\u003C/code> implementation remains clean and agnostic to the signedness of the data it stores.\u003C/p>\n\u003Ch2 id=\"builder-pattern\">Builder Pattern\u003C/h2>\n\u003Cp>Once the structure logic is in place, we have to design an ergonomic way to construct it. A simple \u003Ccode>new()\u003C/code> function isnâ€™t sufficient because the vectorâ€™s memory layout depends on parameters that must be determined \u003Cem>before\u003C/em> allocation, most critically the \u003Ccode>bit_width\u003C/code>. This is a classic scenario for a builder pattern.\u003C/p>\n\u003Cp>The central problem is that the optimal \u003Ccode>bit_width\u003C/code> often depends on the data itself. We need a mechanism to specify the \u003Cem>strategy\u003C/em> for determining this width. We can create the \u003Ccode>BitWidth\u003C/code> enum:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Minimal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    PowerOfTwo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Explicit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With this enum, the user can choose between three strategies:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>Minimal\u003C/code>: The builder scans the input data to find the maximum value, then calculates the minimum number of bits required to represent it. This is the most space-efficient option but requires a full pass over the data.\u003C/li>\n\u003Cli>\u003Ccode>PowerOfTwo\u003C/code>: Similar to \u003Ccode>Minimal\u003C/code>, but rounds the bit width up to the next power of two. This can simplify certain bitwise operations and align better with hardware word sizes, at the cost of some additional space.\u003C/li>\n\u003Cli>\u003Ccode>Explicit(n)\u003C/code>: The user provides a fixed bit width. This avoids the data scan but requires the user to ensure that all values fit within the specified width.\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>\u003Cstrong>Note:\u003C/strong> Yes, I could have also made three different build functions: \u003Ccode>new_with_minimal_bit_width()\u003C/code>, \u003Ccode>new_with_power_of_two_bit_width()\u003C/code>, and \u003Ccode>new_with_explicit_bit_width(n)\u003C/code>. However, this would lead to a combinatorial explosion if we later wanted to add more configuration options. The builder pattern scales better.\u003C/p>\n\u003C/blockquote>\n\u003Cp>With this, the \u003Ccode>FixedVecBuilder\u003C/code> could be designed as a state machine. It holds the chosen \u003Ccode>BitWidth\u003C/code> strategy. The final \u003Ccode>build()\u003C/code> method takes the input slice and executes the appropriate logic.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A look at the builder's logic flow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> build\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">...\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> final_bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width_strategy {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Explicit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        _\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // For Minimal or PowerOfTwo, we first find the max value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> max_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">into_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> min_bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> max_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">leading_zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width_strategy {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Minimal\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> min_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">PowerOfTwo\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> min_bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">next_power_of_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                _\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> unreachable!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... (rest of the logic: allocate buffer, write data) ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This design cleanly separates the configuration phase from the execution phase. The user can declaratively state their requirements, and the builder handles the implementation details, whether that involves a full data scan or a direct construction. For example:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compressed_intvec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">prelude\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">200\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">500\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Max value 500 requires 9 bits\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The builder will scan the data, find max=500, calculate min_bits=9,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// and then round up to the next power of two.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec_pow2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> UFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">builder\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">PowerOfTwo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">build\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec_pow2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>\u003Ccode>UFixedVec&#x3C;T>\u003C/code> is a type alias for \u003Ccode>FixedVec&#x3C;T, u64, LE, Vec&#x3C;u64>>\u003C/code>, the most common instantiation.\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"doing-more-than-just-reading\">Doing more than just reading\u003C/h1>\n\u003Cp>The design of \u003Ccode>FixedVec\u003C/code> allows for more than just efficient reads. We can extend it to support mutation and even thread-safe (almost atomic) concurrent access.\u003C/p>\n\u003Ch2 id=\"mutability-proxy-objects\">Mutability: Proxy Objects\u003C/h2>\n\u003Cp>A core feature of \u003Ccode>std::vec::Vec\u003C/code> is mutable, index-based access via \u003Ccode>&#x26;mut T\u003C/code>. This is fundamentally impossible for \u003Ccode>FixedVec\u003C/code>. An element, such as a 10-bit integer, is not a discrete, byte-aligned entity in memory. It is a virtual value extracted from a bitstream, potentially spanning the boundary of two different \u003Ccode>u64\u003C/code> words. It has no stable memory address, so a direct mutable reference cannot be formed.\u003C/p>\n\u003Cp>To provide an ergonomic mutable API, we must emulate the behavior of a mutable reference. We achieve this through a proxy object pattern, implemented in a struct named \u003Ccode>MutProxy\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MutProxy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    E\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Endianness\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    B\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AsRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AsMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A temporary, decoded copy of the element's value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When we call a method like \u003Ccode>at_mut(index)\u003C/code>, it does not return a reference. Instead, it constructs and returns a \u003Ccode>MutProxy\u003C/code> instance. The proxyâ€™s lifecycle manages the entire modification process:\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Construction:\u003C/strong> The proxy is created. Its first action is to call the parent \u003Ccode>FixedVec\u003C/code>â€™s internal \u003Ccode>get\u003C/code> logic to read and decode the value at the specified \u003Ccode>index\u003C/code>. This decoded value is stored as a temporary copy inside the proxy object itself.\u003C/li>\n\u003Cli>\u003Cstrong>Modification:\u003C/strong> The \u003Ccode>MutProxy\u003C/code> implements \u003Ccode>Deref\u003C/code> and \u003Ccode>DerefMut\u003C/code>, allowing the user to interact with the temporary copy as if it were the real value. Any modifications (\u003Ccode>*proxy = new_value\u003C/code>, \u003Ccode>*proxy += 1\u003C/code>) are applied to this local copy, not to the underlying bitstream.\u003C/li>\n\u003Cli>\u003Cstrong>Destruction:\u003C/strong> When the \u003Ccode>MutProxy\u003C/code> goes out of scope, its \u003Ccode>Drop\u003C/code> implementation is executed. This is the critical step where the potentially modified value from the temporary copy is taken, re-encoded, and written back into the correct bit position in the parent \u003Ccode>FixedVec\u003C/code>â€™s storage.\u003C/li>\n\u003C/ol>\n\u003Cp>This is a classic copy-on-read, write-on-drop mechanism. It provides a safe and ergonomic abstraction for mutating non-addressable data, preserving the feel of direct manipulation while correctly handling the bit-level operations under the hood. The overhead is a single read at the start of the proxyâ€™s life and a single write at the end.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compressed_intvec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fixed\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">UFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">20\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">30\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> UFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">builder\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Explicit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">7\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">build\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// vec.at_mut(1) returns an Option&#x3C;MutProxy&#x3C;...>>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> let\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> proxy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The DerefMut trait allows us to modify the proxy's internal copy.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">proxy\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 99\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The proxy is dropped here. Its Drop impl writes 99 back to the vec.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">), \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">99\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The overhead of this approach is a single read on the proxyâ€™s construction and a single write on its destruction, which is an acceptable trade-off for an ergonomic and safe mutable API.\u003C/p>\n\u003Ch3 id=\"zero-copy-views\">Zero-Copy Views\u003C/h3>\n\u003Cp>A \u003Ccode>Vec\u003C/code>-like API needs to support slicing. Creating a \u003Ccode>FixedVec\u003C/code> that borrows its data (\u003Ccode>B = &#x26;[W]\u003C/code>) is the first step for this, but we also need a dedicated slice type to represent a sub-region of another \u003Ccode>FixedVec\u003C/code> without copying data. For this we can create \u003Ccode>FixedVecSlice\u003C/code>.\u003C/p>\n\u003Cp>We can implement this as a classic â€œfat pointerâ€ struct. It holds a reference to the parent \u003Ccode>FixedVec\u003C/code> and a \u003Ccode>Range&#x3C;usize>\u003C/code> that defines the logical boundaries of the view.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A zero-copy view into a contiguous portion of a FixedVec.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[derive(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">V\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    pub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">super\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">parent\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> V\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    pub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">super\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">range\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Range\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The generic parameter \u003Ccode>V\u003C/code> is a reference to the parent vector. This allows the same \u003Ccode>FixedVecSlice\u003C/code> struct to represent both immutable (\u003Ccode>V = &#x26;FixedVec&#x3C;...>\u003C/code>) and mutable (\u003Ccode>V = &#x26;mut FixedVec&#x3C;...>\u003C/code>) views.\u003C/p>\n\u003Cp>We can implement all the operations on the slice by translating the slice-relative index into an absolute index in the parent vector. For example, we can easily implement \u003Ccode>get_unchecked\u003C/code> with this delegation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Index translation within the slice's get_unchecked\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    debug_assert!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The index is relative to the slice, so we add the slice's start\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // offset to get the correct index in the parent vector.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">parent\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">range\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">start \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In this way there is no code duplication; the slice re-uses the access logic of the parent \u003Ccode>FixedVec\u003C/code>.\u003C/p>\n\u003Ch2 id=\"mutable-slices\">Mutable Slices\u003C/h2>\n\u003Cp>For mutable slices (\u003Ccode>V = &#x26;mut FixedVec&#x3C;...>\u003C/code> ), we can provide mutable access to the sliceâ€™s elements. We can easily implement the \u003Ccode>at_mut\u003C/code> method on \u003Ccode>FixedVecSlice\u003C/code> using the same principle of index translation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MutProxy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The index is translated to the parent vector's coordinate space.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MutProxy\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">parent, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">range\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">start \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A mutable slice borrows the parent \u003Ccode>FixedVec\u003C/code> mutably. This means that while the slice exists, the parent vector cannot be accessed directly due to Rustâ€™s borrowing rules. Letâ€™s consider the following situation: we may need to split a mutable slice into two non-overlapping mutable slices. This is common for example in algorithms that operate on sub-regions of an array. However, implementing such a method requires to use some unsafe code. The method, letâ€™s say \u003Ccode>split_at_mut\u003C/code>, must produce two \u003Ccode>&#x26;mut\u003C/code> references from a single one. In order to be safe, we must prove to the compiler that the logical ranges they represent (\u003Ccode>0..mid\u003C/code> and \u003Ccode>mid..len\u003C/code>) are disjoint.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> split_at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    assert!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">len, \u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">mid > len in split_at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // SAFETY: The two slices are guaranteed not to overlap.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> left\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> right\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This combination of a generic slice struct and careful pointer manipulation allows us to build a rich, safe, and zero-copy API for both immutable and mutable views, mirroring Rustâ€™s native slice\u003C/p>\n\u003Ch1 id=\"next-steps\">Next Steps\u003C/h1>\n\u003Cp>Our \u003Ccode>FixedVec\u003C/code> works pretty well at the current state, but its strengths are tied to two key assumptions: a single thread of execution and uniformly bounded data. Real-world systems often challenge both. This opens up two distinct paths for us to extend our design: one to handle concurrency, and another to adapt to more complex data distributions.\u003C/p>\n\u003Ch2 id=\"concurrent-access\">Concurrent Access\u003C/h2>\n\u003Cp>The design of \u003Ccode>FixedVec\u003C/code> is fundamentally single-threaded. Its mutable access relies on direct writes to the underlying bit buffer, a model that offers no guarantees in a concurrent setting. The core conflict lies between our data layout and the hardwareâ€™s atomic primitives. CPU instructions like compare-and-swap operate on aligned machine words, typically \u003Ccode>u64\u003C/code>. Our elements, however, are packed at arbitrary bit offsets and can span the boundary between two words.\u003C/p>\n\u003Cp>This means a single logical updateâ€”modifying one elementâ€”might require writing to two separate \u003Ccode>u64\u003C/code> words. Performing this as two distinct atomic writes would create a race condition, leaving the data in a corrupt state if another thread reads between them. A single atomic write to one of the underlying \u003Ccode>u64\u003C/code> words would be equally disastrous, as it could simultaneously alter parts of two different elements. The problem then is how to build atomic semantics on top of a non-atomic memory layout. In the next post, we will construct a solution that provides thread-safe, atomic operations for our bit-packed vector.\u003C/p>\n\u003Ch2 id=\"variable-length-encoding\">Variable Length Encoding\u003C/h2>\n\u003Cp>Letâ€™s consider the following scenario: we have a large collection of integers, all of which are small, say in the range \u003Ccode>[0, 255]\u003C/code>, but with a few outliers that are much larger, perhaps up to \u003Ccode>u64::MAX\u003C/code>. If we were to use our \u003Ccode>FixedVec\u003C/code> with a \u003Ccode>bit_width\u003C/code> of 64 to accommodate the outliers, we would waste a significant amount of memory on the small integers. Conversely, if we chose a smaller \u003Ccode>bit_width\u003C/code>, we would be unable to represent the outliers at all.\u003C/p>\n\u003Cp>The fixed-width model rests on that critical assumption of uniformly bounded data. Its performance comes from this predictability, but this rigid structure is also its main weakness.\u003C/p>\n\u003Cp>For skewed data distributions, we need a different model. Instead of a fixed number of bits per element, we can use variable-length instantaneous codes, where smaller numbers are represented by shorter bit sequences. This gives us excellent compression, but it breaks our O(1) random access guarantee. We can no longer compute the location of the i-th element with a simple multiplication. The solution is to trade a small amount of space for a speedup in access time. We can build a secondary index that stores the bit-offset of every k-th element. This sampling allows us to seek to a nearby checkpoint and decode sequentially from there, restoring amortized O(1) access. In a future article, weâ€™ll explore this second vector type, its own set of performance trade-offs, and how we can choose the best encoding for our data.\u003C/p>\n\u003Chr>\n\u003Cp>We will explore this two paths in future articles. In the meantime, if you want to try them out, they are both already implemented in the library. You can find the atomic version in the \u003Ca href=\"https://docs.rs/compressed-intvec/latest/compressed_intvec/fixed/atomic/index.html\">atomic\u003C/a> module and the variable-length version in the \u003Ca href=\"https://docs.rs/compressed-intvec/latest/compressed_intvec/variable/struct.IntVec.html\">variable\u003C/a> module.\u003C/p>",{"headings":553,"localImagePaths":622,"remoteImagePaths":623,"frontmatter":624,"imagePaths":627},[554,556,559,562,565,568,571,574,577,580,583,586,589,592,595,598,601,604,607,610,613,616,619],{"depth":32,"slug":210,"text":555},"Table of contents",{"depth":213,"slug":557,"text":558},"memory-waste-in-standard-vectors","Memory Waste in Standard Vectors",{"depth":213,"slug":560,"text":561},"packing-and-accessing-bits","Packing and Accessing Bits",{"depth":32,"slug":563,"text":564},"crossing-word-boundaries","Crossing Word Boundaries",{"depth":32,"slug":566,"text":567},"faster-reads-unaligned-access","Faster Reads: Unaligned Access",{"depth":32,"slug":569,"text":570},"random-access-performance","Random Access Performance",{"depth":32,"slug":572,"text":573},"iterating-over-values","Iterating Over Values",{"depth":131,"slug":575,"text":576},"double-ended-iteration","Double-Ended Iteration",{"depth":213,"slug":578,"text":579},"writing-bits","Writing bits",{"depth":32,"slug":581,"text":582},"in-word-write","In-Word Write",{"depth":32,"slug":584,"text":585},"spanning-write","Spanning Write",{"depth":32,"slug":587,"text":588},"random-write-performance","Random Write Performance",{"depth":213,"slug":590,"text":591},"architecture","Architecture",{"depth":32,"slug":593,"text":594},"word-trait-the-physical-storage-layer","Word Trait: The Physical Storage Layer",{"depth":32,"slug":596,"text":597},"storable-trait-the-logical-type-layer","Storable Trait: The Logical Type Layer",{"depth":32,"slug":599,"text":600},"builder-pattern","Builder Pattern",{"depth":213,"slug":602,"text":603},"doing-more-than-just-reading","Doing more than just reading",{"depth":32,"slug":605,"text":606},"mutability-proxy-objects","Mutability: Proxy Objects",{"depth":131,"slug":608,"text":609},"zero-copy-views","Zero-Copy Views",{"depth":32,"slug":611,"text":612},"mutable-slices","Mutable Slices",{"depth":213,"slug":614,"text":615},"next-steps","Next Steps",{"depth":32,"slug":617,"text":618},"concurrent-access","Concurrent Access",{"depth":32,"slug":620,"text":621},"variable-length-encoding","Variable Length Encoding",[],[],{"author":14,"pubDatetime":625,"title":544,"slug":540,"featured":198,"draft":17,"tags":626,"description":546},["Date","2025-09-24T00:00:00.000Z"],[200,300],[],"who-owns-the-memory-pt1",{"id":628,"data":630,"body":636,"filePath":637,"digest":638,"rendered":639},{"author":14,"pubDatetime":631,"title":632,"featured":17,"draft":198,"tags":633,"description":635},["Date","2025-12-20T00:00:00.000Z"],"Who Owns the Memory? Part 1: Objects",[200,634],"Programming","From hardware to aliasing rules: understanding how C, C++, and Rust map types to memory.","This article is the first part of a series exploring how C, C++, and Rust manage memory at a low level. We will start from the hardware perspective: how memory is represented as bytes, and then build up to how each language maps types onto that memory, the rules they impose, and the implications for ownership and safety.\n\n## Table of contents\n\n## Memory Is Just Bytes\n\nA 64-bit processor sees memory as a flat array of $2^{64}$ addressable bytes. It does not know what a `struct` is. It does not know what an `int` is. When we execute `mov rax, [rbx]`, the CPU fetches 8 bytes starting at the address in `rbx`, shoves them into `rax`, and moves on. The semantic meaning of those bytes, whether they represent a pointer, a floating-point number, or part of a UTF-8 stringâ€”exists only in our source code and the instructions we generate.\n\nThis is the foundation everything else builds on. Before we discuss ownership models or type systems, we need to be precise about what actually happens when a program \"allocates memory\" or \"accesses a variable.\"\n\n### Virtual Address Space\n\nModern operating systems do not give processes direct access to physical RAM. Instead, each process operates within its own virtual address space, a fiction maintained by the MMU (Memory Management Unit) that maps virtual addresses to physical frames. The C standard captures this abstraction explicitly: pointers in C reference virtual memory, and the language makes no guarantees about physical layout.\n\nThis abstraction buys us two properties:\n\n1. **Isolation**: A pointer in process A cannot reference memory in process B. Dereferencing an unmapped address triggers a page fault, typically terminating the process.\n2. **Portability**: Code does not need to know the physical memory topology of the machine it runs on.\n\nFrom our perspective as systems programmers, virtual memory means that the addresses we work with are translated by hardware before reaching DRAM. This translation has performance implications. TLB misses are expensive, but the abstraction holds: we operate on a contiguous address space that the OS manages for us.\n\n### Alignment\n\nNot all byte addresses are equal. On x86-64, loading a `uint64_t` from an address that is not divisible by 8 incurs a penalty. On stricter architectures like ARM (without unaligned access support) or older SPARC, it causes a hardware trap.\n\nThe reason is mechanical. DRAM is accessed in aligned chunks. When the CPU requests data at address `0x1003`, but the memory bus fetches 8-byte-aligned blocks, the memory controller must fetch two blocks (`0x1000-0x1007` and `0x1008-0x100F`), extract the relevant bytes, and reassemble them. This costs cycles.\n\nThe C standard formalizes this through the concept of alignment:\n```c\n#include \u003Cstdalign.h>\n#include \u003Cstdio.h>\n\nint main(void) {\n    printf(\"alignof(int) = %zu\\n\", alignof(int));           // typically 4\n    printf(\"alignof(double) = %zu\\n\", alignof(double));     // typically 8\n    printf(\"alignof(max_align_t) = %zu\\n\", alignof(max_align_t)); // typically 16\n}\n```\n\nThe `alignof` operator (C11/C23) returns the required alignment for a type. Accessing an object at an address that violates its alignment is undefined behavior, not because the standard is being pedantic, but because the hardware cannot reliably execute it.\n\nConsider this concrete failure case from [Modern C](https://gustedt.gitlabpages.inria.fr/modern-c/):\n```c\nunion {\n    unsigned char bytes[32];\n    complex double val[2];\n} overlay;\n\n// complex double typically requires 8-byte alignment\ncomplex double *p = (complex double *)&overlay.bytes[4];  // misaligned\n*p = 1.0 + 2.0*I;  // undefined behavior\n```\n\nOn x86-64 with alignment checking enabled, or on ARM, this crashes with a bus error. The pointer arithmetic is legal C, but the resulting address violates the alignment requirement of `complex double`. The hardware refuses.\n\n### Cache Lines and Memory Bandwidth\n\nAlignment interacts with another hardware reality: cache lines. On modern x86-64 processors, the L1 cache operates on 64-byte lines. When we read a single byte, the CPU actually fetches 64 bytes. If our data structures are laid out poorly, we waste bandwidth fetching bytes we never use.\n\nWorse, if a single logical datum spans two cache lines, every access requires two cache fetches. For a `struct` that straddles a 64-byte boundary, this doubles memory traffic.\n\nThis is why compilers insert padding between struct fields. Consider:\n```c\nstruct Bad {\n    char a;     // 1 byte\n    // 7 bytes padding\n    double b;   // 8 bytes\n    char c;     // 1 byte\n    // 7 bytes padding (to align the whole struct)\n};\n\nstruct Good {\n    double b;   // 8 bytes\n    char a;     // 1 byte\n    char c;     // 1 byte\n    // 6 bytes padding\n};\n```\n\n`sizeof(struct Bad)` is 24 bytes. `sizeof(struct Good)` is 16 bytes. The compiler cannot reorder fields in C (the standard guarantees fields appear in declaration order for `repr(C)` compatibility), so the programmer must consider layout.\n\n### The Allocator's View\n\nWhen we call `malloc(n)`, we do not receive exactly `n` bytes of usable memory. The allocator maintains metadata like chunk headers, size fields, and free-list pointers that live adjacent to our allocation. In glibc's ptmalloc2, an allocated chunk looks roughly like this:\n```\n+------------------+\n| prev_size        |  (8 bytes, used only if previous chunk is free)\n+------------------+\n| size       |N|M|P|  (8 bytes, includes flags in low 3 bits)\n+------------------+\n| user data...     |  \u003C- pointer returned by malloc\n|                  |\n+------------------+\n```\n\nThe `size` field stores the chunk size with three flag bits: `P` (previous chunk in use), `M` (chunk obtained via `mmap`), and `N` (non-main arena). The actual usable size is `size & ~0x7`.\n\nThis means:\n\n1. Every allocation has overhead. Small allocations suffer proportionally more: a 16-byte allocation requires at least 32 bytes of actual memory (16 bytes data + 16 bytes metadata, depending on the allocator).\n2. The allocator imposes its own alignment. `malloc` guarantees alignment suitable for any primitive type (`max_align_t`), which is 16 bytes on most 64-bit platforms.\n3. Memory is not _free_. The allocator tracks allocated regions, and `free()` does not necessarily return memory to the OS, it typically returns it to a free list for reuse.\n\nWhen we discuss ownership and resource management in later sections, keep this in mind: _deallocating memory_ at the language level means returning bytes to the allocator. The allocator decides when (if ever) to return pages to the operating system.\n\n### Objects Are Bytes\n\nThe C standard makes this explicit: every object can be viewed as an array of `unsigned char`:\n```c\nint x = 42;\nunsigned char *bytes = (unsigned char *)&x;\nfor (size_t i = 0; i \u003C sizeof(int); i++) {\n    printf(\"%02x \", bytes[i]);\n}\n// Output on little-endian x86-64: 2a 00 00 00\n```\n\nThis is the object representation, the actual bytes in memory. The semantic interpretation (that these bytes represent the integer 42) is layered on top by the type system.\n\nRust and C++ inherit this model. When we say a Rust `i32` occupies 4 bytes with alignment 4, we mean exactly what C means: 4 contiguous bytes at an address divisible by 4. The type systems differ dramatically in what operations they permit on those bytes, but the physical representation is identical.\n\nThis is the starting point. We have bytes in a virtual address space, aligned for hardware access, managed by an allocator. Everything that follows, effective types, ownership, lifetimesâ€”is a layer of abstraction over this physical reality.\n\n## From Bytes to Objects\n\nA region of memory becomes an *object* when we impose a type interpretation on it. The type dictates how many bytes participate, what their alignment must be, and what operations are valid. But the three languages differ fundamentally in when and how this imposition occurs, and what invariants the type carries.\n\n### C: Effective Type Rules\n\nIn C, the relationship between memory and type is established through the concept of *effective type*. The effective type of an object determines how it may be accessed.\n\nFor declared variables, the effective type is simply the declared type:\n\n```c\nint x = 42;  // effective type of x is int\n```\n\nThe variable `x` occupies `sizeof(int)` bytes at some address, and those bytes must be accessed as `int` or as `unsigned char`. Accessing them as `float*` is undefined behavior:\n\n```c\nint x = 42;\nfloat *fp = (float *)&x;\nfloat f = *fp;  // undefined behavior: access through incompatible type\n```\n\nThis is not a runtime check. The compiler does not insert code to verify the access. Instead, the rule exists to enable optimization. When the compiler sees a write through `int*` and a read through `float*`, the strict aliasing rule permits it to assume these pointers reference different objects. The compiler can then reorder loads and stores, keep values in registers across the write, and eliminate redundant accesses.\n\nThe rule has a critical asymmetry. Any object can be viewed as an array of `unsigned char`:\n\n```c\nint x = 42;\nunsigned char *bytes = (unsigned char *)&x;\nfor (size_t i = 0; i \u003C sizeof(int); i++) {\n    printf(\"%02x \", bytes[i]);  // valid: char access is always permitted\n}\n```\n\nBut the reverse is undefined:\n\n```c\nunsigned char buffer[sizeof(int)] = {0};\nint *p = (int *)buffer;\nint val = *p;  // undefined behavior\n```\n\nThe buffer's effective type is `unsigned char[4]`. Accessing it through `int*` violates the effective type rule. The fact that the bytes happen to form a valid `int` representation is irrelevant. The compiler is entitled to assume this access cannot happen, and may generate code that produces garbage or crashes.\n\nFor dynamically allocated memory, the situation is different. Memory returned by `malloc` has no effective type until we write to it:\n\n```c\nvoid *p = malloc(sizeof(double));\ndouble *dp = p;\n*dp = 3.14;  // this write sets the effective type to double\n```\n\nAfter this write, the allocated region has effective type `double`. Subsequent reads through `double*` are valid. Reading through `int*` would again be undefined.\n\nThe effective type machinery exists purely for optimization. The compiler uses it to reason about aliasing. It provides no runtime safety.\n\n### C++: Object Lifetime\n\nC++ inherits C's effective type rules but adds a distinct concept: *object lifetime*. An object's lifetime is the interval during which accessing the object is well-defined.\n\nThe C++ standard (N4950, Â§6.7.3) specifies the boundaries precisely. For an object of type `T`:\n\n> The lifetime of an object of type T begins when:\n> (1.1) storage with the proper alignment and size for type T is obtained, and\n> (1.2) its initialization (if any) is complete\n\n> The lifetime of an object of type T ends when:\n> (1.3) if T is a non-class type, the object is destroyed, or\n> (1.4) if T is a class type, the destructor call starts, or\n> (1.5) the storage which the object occupies is released, or is reused by an object that is not nested within o.\n\nConsider placement new:\n\n```cpp\nstruct Widget {\n    int value;\n    Widget(int v) : value(v) { }\n    ~Widget() { std::cout \u003C\u003C \"destroyed\\n\"; }\n};\n\nalignas(Widget) unsigned char buffer[sizeof(Widget)];\nWidget* w = new (buffer) Widget(42);  // lifetime begins here\nw->~Widget();                          // lifetime ends here\n// buffer still contains bytes, but no Widget object exists\n```\n\nBetween placement new and the destructor call, a `Widget` object exists at that address. Before placement new and after the destructor, the bytes exist but no `Widget` does. Accessing `w->value` after `w->~Widget()` is undefined behavior, even though the bytes are still there and unchanged.\n\nThe destructor call does not free memory. It ends the object's lifetime while the storage remains intact. This is what placement new and explicit destructor calls rely on: the ability to construct an object in pre-existing storage, use it, destroy it, and potentially construct a different object in the same storage.\n\nFor trivial types (those without constructors, destructors, or virtual functions), C++ objects behave essentially like C objects. For class types with nontrivial special member functions, the lifetime boundaries become significant. A `std::string` accessed after destruction will likely read freed memory or corrupted pointers, because the destructor deallocated the internal buffer.\n\nC++20 also introduced *implicit object creation*. Certain operations, such as `std::malloc`, implicitly create objects of *implicit-lifetime types* if doing so would give the program defined behavior:\n\n```cpp\nstruct Point { int x, y; };  // implicit-lifetime type (trivial)\n\nPoint* p = (Point*)std::malloc(sizeof(Point));\np->x = 1;  // in C++20, this is well-defined\np->y = 2;  // malloc implicitly created the Point object\n```\n\nThis was added to retroactively make well-defined the code patterns that had been common but technically undefined.\n\n### Rust: Validity Invariants\n\nRust imposes a stronger requirement. Every type has *validity invariants*, and producing a value that violates its type's invariant is immediate undefined behavior. The compiler's optimizer assumes these invariants hold unconditionally.\n\nThe Rust Reference defines validity per type:\n\n```rust\n// A bool must be 0x00 (false) or 0x01 (true)\nlet b: bool = unsafe { std::mem::transmute(2u8) };  // UB: invalid bool\n\n// A reference must be non-null, aligned, and point to a valid value\nlet r: &i32 = unsafe { std::mem::transmute(0usize) };  // UB: null reference\n\n// A char must be a valid Unicode scalar value (not a surrogate)\nlet c: char = unsafe { std::mem::transmute(0xD800u32) };  // UB: surrogate\n\n// An enum must have a valid discriminant\nenum Status { Active = 0, Inactive = 1 }\nlet s: Status = unsafe { std::mem::transmute(2u8) };  // UB: invalid discriminant\n\n// The never type must never exist\nlet n: ! = unsafe { std::mem::zeroed() };  // UB\n```\n\nThe moment an invalid value is *produced*, undefined behavior has occurred. From the Rust Reference:\n\n> The Rust compiler assumes that all values produced during program execution are valid, and producing an invalid value is hence immediate UB.\n\nIn C, you can have an `int` variable containing any 32-bit pattern, and as long as you do not read it in certain ways, no UB occurs. In Rust, if a `bool` contains the bit pattern `0x02`, UB has already happened at the point of creation, regardless of whether you subsequently read it.\n\nConsider references. In C and C++, a pointer can be null, and dereferencing it is UB. But the pointer itself can exist and be passed around. In Rust:\n\n```rust\nlet ptr: *const i32 = std::ptr::null();  // valid: raw pointer can be null\nlet r: &i32 = unsafe { &*ptr };          // UB occurs HERE, at reference creation\n```\n\nThe UB does not occur when we read through the reference. It occurs when the reference is created. A `&T` carries an invariant: non-null, properly aligned, pointing to a valid `T`. Violating this invariant at any point is UB, regardless of what we do with the reference afterward.\n\nThis strictness enables more aggressive optimization. When the compiler sees a `&T`, it emits `dereferenceable` and `nonnull` annotations to LLVM. A match expression on a `bool` need not generate a default case for values 2-255. These optimizations would be unsound if invalid values could exist.\n\nThe cost is that more operations require `unsafe`. You cannot create a reference to potentially-invalid memory, even temporarily. You must use raw pointers and convert to references only when validity is guaranteed:\n\n```rust\nlet ptr: *const i32 = some_ffi_function();\n\nif !ptr.is_null() && ptr.is_aligned() {\n    let r: &i32 = unsafe { &*ptr };  // sound: we verified validity\n    println!(\"{}\", *r);\n}\n```\n\n### Object Representation vs. Value\n\nAll three languages distinguish between an object's *representation* (its bytes in memory) and its *value* (the semantic interpretation of those bytes). But they draw the line differently.\n\nIn C, you can freely inspect any object as `unsigned char[]`:\n\n```c\ndouble d = 3.14159;\nunsigned char *bytes = (unsigned char *)&d;\n// bytes[0..7] contain the IEEE 754 representation\n```\n\nThe bytes are the object's representation. The value is what those bytes mean according to the IEEE 754 standard. C permits examining bytes without caring about their semantic meaning.\n\nC++ inherits this but adds constraints around object lifetime. You can inspect the bytes of a live object. You cannot meaningfully inspect bytes of a destroyed object (the storage may be reused).\n\nRust permits byte-level inspection through raw pointers and transmutation, but adds validity constraints:\n\n```rust\nlet x: i32 = 42;\nlet bytes: [u8; 4] = unsafe { std::mem::transmute(x) };\n// bytes now contains the representation\n\n// Going the other direction is more dangerous:\nlet bytes: [u8; 1] = [2];\nlet b: bool = unsafe { std::mem::transmute(bytes) };  // UB: 2 is not a valid bool\n```\n\nThe asymmetry here mirrors C's effective type asymmetry. Converting a typed value to bytes is generally safe. Converting bytes to a typed value requires that the bytes actually constitute a valid value of that type.\n\n\n## Storage Duration\n\nEvery object resides somewhere in memory. The *storage duration* of an object determines when that memory is allocated and when it becomes invalid. All three languages recognize the same fundamental categories, though they use different terminology and provide different guarantees about deallocation.\n\n### The Four Categories\n\nC defines four storage durations. C++ inherits the same four. Rust maps onto an equivalent model, though the language specification does not use identical terminology.\n\n**Static storage duration**: The object exists for the entire execution of the program. In C and C++, this includes global variables, variables declared with `static`, and string literals. In Rust, this includes `static` items and string literals (which have type `&'static str`). The memory for these objects is typically placed in the `.data` or `.rodata` segment of the executable and requires no runtime allocation.\n\n**Thread storage duration**: The object exists for the lifetime of a thread. C11 introduced `_Thread_local` (spelled `thread_local` since C23), C++11 introduced `thread_local`, and Rust provides `thread_local!` macro. Each thread gets its own instance of the variable, allocated when the thread starts and deallocated when it terminates.\n\n**Automatic storage duration**: The object exists within a lexical scope, typically a function body or block. When execution enters the scope, space is reserved; when execution leaves, the space is released. In C and C++, local variables without `static` or `thread_local` have automatic storage. In Rust, all local bindings have automatic storage. This is typically implemented via the stack.\n\n**Allocated (dynamic) storage duration**: The object's lifetime is controlled explicitly by the program. In C, this means `malloc`/`free`. In C++, this means `new`/`delete` or allocator-aware containers. In Rust, this means `Box`, `Vec`, `String`, and other heap-allocating types.\n\n### Stack\n\nAutomatic storage is almost universally implemented using a call stack. When a function is called, the compiler reserves space for its local variables by adjusting the stack pointer. On x86-64 following the System V ABI, this looks like:\n\n```asm\nmy_function:\n    push rbp\n    mov rbp, rsp\n    sub rsp, 48          ; reserve 48 bytes for locals\n    ; ... function body ...\n    mov rsp, rbp\n    pop rbp\n    ret\n```\n\nThe `sub rsp, 48` instruction allocates space for all local variables in a single operation. The compiler computes the required size at compile time by summing the sizes of all locals (accounting for alignment). Deallocation is equally cheap: `mov rsp, rbp` releases all that space instantly.\n\nThis has two consequences:\n\n1. Allocation and deallocation of automatic storage is $O(1)$ regardless of how many objects are involved. A function with 100 local variables pays the same cost as one with 2.\n\n2. The space is not initialized. After `sub rsp, 48`, those 48 bytes contain whatever was previously on the stack. In C, reading an uninitialized automatic variable is undefined behavior (the value is *indeterminate*). In C++, the same rule applies. In Rust, the compiler enforces definite initialization: you cannot read a variable before assigning to it.\n\n```rust\nfn example() {\n    let x: i32;\n    println!(\"{}\", x);  // error: borrow of possibly-uninitialized variable\n}\n```\n\nThe Rust compiler tracks initialization state through control flow and rejects programs that might read uninitialized memory. This is a compile-time check with no runtime cost.\n\n### Heap\n\nDynamic allocation is fundamentally different. When we call `malloc(n)`, the allocator must:\n\n1. Find a contiguous region of at least `n` bytes that is not currently in use\n2. Mark that region as allocated\n3. Return a pointer to it\n\nWhen we call `free(p)`, the allocator must:\n\n1. Determine the size of the allocation (stored in metadata adjacent to the user data)\n2. Mark that region as available for future allocations\n3. Possibly coalesce adjacent free regions to reduce fragmentation\n\nThis involves data structure manipulation, potential system calls (if the allocator needs more memory from the OS), and can have variable latency depending on heap state. The cost is not $O(1)$.\n\nIn C, heap allocation is explicit:\n\n```c\nint* p = malloc(sizeof(int) * 100);\nif (p == NULL) {\n    // allocation failed\n}\n// ... use p ...\nfree(p);\n```\n\nThe programmer is responsible for:\n1. Checking for allocation failure\n2. Calling `free` exactly once\n3. Not using the pointer after `free`\n4. Not freeing the same pointer twice\n\nViolating any of these causes undefined behavior or memory leaks. The language provides no assistance.\n\nIn C++, dynamic allocation can be explicit (`new`/`delete`) or managed through RAII:\n\n```cpp\n// Explicit (dangerous)\nint* p = new int[100];\ndelete[] p;\n\n// RAII (safer)\nauto v = std::make_unique\u003Cint[]>(100);\n// v automatically deleted when it goes out of scope\n```\n\n`std::unique_ptr` wraps a raw pointer and calls `delete` in its destructor. When `v` goes out of scope, the destructor runs, the memory is freed. The programmer does not call `delete` manually.\n\nThis is opt-in. You can still use raw `new`/`delete`. You can still have dangling pointers. The compiler does not verify correctness.\n\nIn Rust, heap allocation is handled through owning types:\n\n```rust\nlet v: Vec\u003Ci32> = Vec::with_capacity(100);\n// v automatically deallocated when it goes out of scope\n```\n\n`Vec\u003CT>` owns heap-allocated memory. When `v` goes out of scope, `Vec`'s `Drop` implementation runs, calling the allocator to free the buffer. There is no way to forget to free, no way to double-free, and no way to use after free (the compiler rejects such programs).\n\nThe difference from C++ is that Rust's ownership is not opt-in. Every heap allocation is owned by exactly one binding. Transferring ownership is a move. After a move, the original binding is unusable:\n\n```rust\nlet v1 = vec![1, 2, 3];\nlet v2 = v1;           // v1 moved to v2\nprintln!(\"{:?}\", v1);  // error: borrow of moved value\n```\n\n### Who Calls Free?\n\nThe central difference between C, C++, and Rust in their treatment of dynamic storage is responsibility for deallocation.\n\nIn C, the programmer decides when to call `free`. The language does not track ownership. If you pass a pointer to a function, the function might free it, or it might not. The only way to know is documentation or convention.\n\n```c\nvoid process(int* data) {\n    // Does this function free data? You have to read the docs.\n}\n```\n\nIn C++, RAII shifts responsibility to destructors. If you use `unique_ptr`, the destructor frees. If you use `shared_ptr`, the destructor decrements a reference count and frees when it reaches zero. But you can still use raw pointers, and the compiler cannot tell you which convention a given codebase follows.\n\n```cpp\nvoid process(int* data) {\n    // Raw pointer: who owns this? Still ambiguous.\n}\n\nvoid process(std::unique_ptr\u003Cint[]> data) {\n    // Ownership transferred: this function will free when done.\n}\n```\n\nIn Rust, the type system encodes ownership:\n\n```rust\nfn process(data: Vec\u003Ci32>) {\n    // This function owns data. It will be freed when process returns.\n}\n\nfn process_ref(data: &Vec\u003Ci32>) {\n    // This function borrows data. The caller retains ownership.\n}\n\nfn process_mut(data: &mut Vec\u003Ci32>) {\n    // Mutable borrow. Caller retains ownership. No other access allowed during this call.\n}\n```\n\nThe signature tells you everything. `Vec\u003Ci32>` means ownership transfer. `&Vec\u003Ci32>` means immutable borrow. `&mut Vec\u003Ci32>` means mutable borrow. The compiler enforces these semantics. You cannot pass a `Vec` and then continue using it; the move would be rejected.\n\n### Stack Allocation in Rust\n\nRust provides fine-grained control over whether data lives on the stack or heap. By default, local bindings are stack-allocated:\n\n```rust\nlet x: [i32; 1000] = [0; 1000];  // 4000 bytes on the stack\n```\n\nThis works until the array is too large for the stack (typically 1-8 MB depending on platform). For large allocations, use `Box`:\n\n```rust\nlet x: Box\u003C[i32; 1000000]> = Box::new([0; 1000000]);  // heap\n```\n\n`Box\u003CT>` is a pointer to a heap allocation. It has the same size as a raw pointer (8 bytes on 64-bit), implements `Deref` so you can use it like a reference, and frees the allocation in its `Drop` implementation.\n\nThe memory layout of `Box\u003CT>` is a single pointer:\n\n```rust\nuse std::mem::size_of;\nassert_eq!(size_of::\u003CBox\u003C[i32; 1000]>>(), 8);  // just a pointer\n```\n\nUnlike C++ `unique_ptr`, which may carry a deleter, `Box\u003CT>` always uses the global allocator and has no space overhead. The deallocation function is known statically.\n\n### How Does Vec Work?\n\n`Vec\u003CT>` is Rust's growable array. Its memory layout is three machine words:\n\n```rust\n// Conceptually:\nstruct Vec\u003CT> {\n    ptr: *mut T,      // pointer to heap allocation\n    cap: usize,       // allocated capacity\n    len: usize,       // number of initialized elements\n}\n```\n\nOn 64-bit, `size_of::\u003CVec\u003CT>>()` is 24 bytes regardless of `T`.\n\nWhen you create a `Vec`:\n\n```rust\nlet mut v = Vec::with_capacity(10);\n```\n\nThe allocator provides a buffer for 10 elements. `ptr` points to it, `cap` is 10, `len` is 0.\n\nWhen you push elements:\n\n```rust\nv.push(1);  // len becomes 1\nv.push(2);  // len becomes 2\n```\n\nEach `push` writes to `ptr.add(len)` and increments `len`. No reallocation occurs while `len \u003C cap`.\n\nWhen `len` reaches `cap` and you push again, `Vec` must reallocate:\n\n1. Allocate a new buffer with larger capacity\n2. Copy existing elements to the new buffer\n3. Free the old buffer\n4. Update `ptr` and `cap`\n\nWhen `Vec` is dropped:\n\n1. Call `drop` on each element (for types with destructors)\n2. Free the buffer\n\nAll of this happens automatically. The programmer writes `v.push(x)` and the ownership system ensures the buffer is freed exactly once, when `v` goes out of scope.\n\nThis is the pattern throughout Rust's standard library. `String` owns a UTF-8 buffer. `HashMap` owns its backing storage. `File` owns a file descriptor. When the owner goes out of scope, the resource is released. The type system ensures there is always exactly one owner.","src/data/blog/memory.md","4a2086bd6f85771a",{"html":640,"metadata":641},"\u003Cp>This article is the first part of a series exploring how C, C++, and Rust manage memory at a low level. We will start from the hardware perspective: how memory is represented as bytes, and then build up to how each language maps types onto that memory, the rules they impose, and the implications for ownership and safety.\u003C/p>\n\u003Ch2 id=\"table-of-contents\">Table of contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-is-just-bytes\">Memory Is Just Bytes\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#virtual-address-space\">Virtual Address Space\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#alignment\">Alignment\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#cache-lines-and-memory-bandwidth\">Cache Lines and Memory Bandwidth\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-allocators-view\">The Allocatorâ€™s View\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#objects-are-bytes\">Objects Are Bytes\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#from-bytes-to-objects\">From Bytes to Objects\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#c-effective-type-rules\">C: Effective Type Rules\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-object-lifetime\">C++: Object Lifetime\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-validity-invariants\">Rust: Validity Invariants\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#object-representation-vs-value\">Object Representation vs. Value\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#storage-duration\">Storage Duration\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-four-categories\">The Four Categories\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#stack\">Stack\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#heap\">Heap\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#who-calls-free\">Who Calls Free?\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#stack-allocation-in-rust\">Stack Allocation in Rust\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#how-does-vec-work\">How Does Vec Work?\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch2 id=\"memory-is-just-bytes\">Memory Is Just Bytes\u003C/h2>\n\u003Cp>A 64-bit processor sees memory as a flat array of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>64\u003C/mn>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{64}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">64\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> addressable bytes. It does not know what a \u003Ccode>struct\u003C/code> is. It does not know what an \u003Ccode>int\u003C/code> is. When we execute \u003Ccode>mov rax, [rbx]\u003C/code>, the CPU fetches 8 bytes starting at the address in \u003Ccode>rbx\u003C/code>, shoves them into \u003Ccode>rax\u003C/code>, and moves on. The semantic meaning of those bytes, whether they represent a pointer, a floating-point number, or part of a UTF-8 stringâ€”exists only in our source code and the instructions we generate.\u003C/p>\n\u003Cp>This is the foundation everything else builds on. Before we discuss ownership models or type systems, we need to be precise about what actually happens when a program â€œallocates memoryâ€ or â€œaccesses a variable.â€\u003C/p>\n\u003Ch3 id=\"virtual-address-space\">Virtual Address Space\u003C/h3>\n\u003Cp>Modern operating systems do not give processes direct access to physical RAM. Instead, each process operates within its own virtual address space, a fiction maintained by the MMU (Memory Management Unit) that maps virtual addresses to physical frames. The C standard captures this abstraction explicitly: pointers in C reference virtual memory, and the language makes no guarantees about physical layout.\u003C/p>\n\u003Cp>This abstraction buys us two properties:\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Isolation\u003C/strong>: A pointer in process A cannot reference memory in process B. Dereferencing an unmapped address triggers a page fault, typically terminating the process.\u003C/li>\n\u003Cli>\u003Cstrong>Portability\u003C/strong>: Code does not need to know the physical memory topology of the machine it runs on.\u003C/li>\n\u003C/ol>\n\u003Cp>From our perspective as systems programmers, virtual memory means that the addresses we work with are translated by hardware before reaching DRAM. This translation has performance implications. TLB misses are expensive, but the abstraction holds: we operate on a contiguous address space that the OS manages for us.\u003C/p>\n\u003Ch3 id=\"alignment\">Alignment\u003C/h3>\n\u003Cp>Not all byte addresses are equal. On x86-64, loading a \u003Ccode>uint64_t\u003C/code> from an address that is not divisible by 8 incurs a penalty. On stricter architectures like ARM (without unaligned access support) or older SPARC, it causes a hardware trap.\u003C/p>\n\u003Cp>The reason is mechanical. DRAM is accessed in aligned chunks. When the CPU requests data at address \u003Ccode>0x1003\u003C/code>, but the memory bus fetches 8-byte-aligned blocks, the memory controller must fetch two blocks (\u003Ccode>0x1000-0x1007\u003C/code> and \u003Ccode>0x1008-0x100F\u003C/code>), extract the relevant bytes, and reassemble them. This costs cycles.\u003C/p>\n\u003Cp>The C standard formalizes this through the concept of alignment:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">include\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">stdalign.h\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">include\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">stdio.h\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">alignof(int) = \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%zu\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lignof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           // typically 4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">alignof(double) = \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%zu\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lignof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // typically 8\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">alignof(max_align_t) = \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%zu\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lignof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">max_align_t\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> // typically 16\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>alignof\u003C/code> operator (C11/C23) returns the required alignment for a type. Accessing an object at an address that violates its alignment is undefined behavior, not because the standard is being pedantic, but because the hardware cannot reliably execute it.\u003C/p>\n\u003Cp>Consider this concrete failure case from \u003Ca href=\"https://gustedt.gitlabpages.inria.fr/modern-c/\">Modern C\u003C/a>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">union\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    complex \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} overlay;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// complex double typically requires 8-byte alignment\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">complex \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (complex \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">overlay.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // misaligned\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1.0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2.0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">I;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On x86-64 with alignment checking enabled, or on ARM, this crashes with a bus error. The pointer arithmetic is legal C, but the resulting address violates the alignment requirement of \u003Ccode>complex double\u003C/code>. The hardware refuses.\u003C/p>\n\u003Ch3 id=\"cache-lines-and-memory-bandwidth\">Cache Lines and Memory Bandwidth\u003C/h3>\n\u003Cp>Alignment interacts with another hardware reality: cache lines. On modern x86-64 processors, the L1 cache operates on 64-byte lines. When we read a single byte, the CPU actually fetches 64 bytes. If our data structures are laid out poorly, we waste bandwidth fetching bytes we never use.\u003C/p>\n\u003Cp>Worse, if a single logical datum spans two cache lines, every access requires two cache fetches. For a \u003Ccode>struct\u003C/code> that straddles a 64-byte boundary, this doubles memory traffic.\u003C/p>\n\u003Cp>This is why compilers insert padding between struct fields. Consider:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Bad {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 7 bytes padding\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">   // 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> c;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 7 bytes padding (to align the whole struct)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Good {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">   // 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> c;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 6 bytes padding\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>sizeof(struct Bad)\u003C/code> is 24 bytes. \u003Ccode>sizeof(struct Good)\u003C/code> is 16 bytes. The compiler cannot reorder fields in C (the standard guarantees fields appear in declaration order for \u003Ccode>repr(C)\u003C/code> compatibility), so the programmer must consider layout.\u003C/p>\n\u003Ch3 id=\"the-allocators-view\">The Allocatorâ€™s View\u003C/h3>\n\u003Cp>When we call \u003Ccode>malloc(n)\u003C/code>, we do not receive exactly \u003Ccode>n\u003C/code> bytes of usable memory. The allocator maintains metadata like chunk headers, size fields, and free-list pointers that live adjacent to our allocation. In glibcâ€™s ptmalloc2, an allocated chunk looks roughly like this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>| prev_size        |  (8 bytes, used only if previous chunk is free)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>| size       |N|M|P|  (8 bytes, includes flags in low 3 bits)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>| user data...     |  &#x3C;- pointer returned by malloc\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>|                  |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>size\u003C/code> field stores the chunk size with three flag bits: \u003Ccode>P\u003C/code> (previous chunk in use), \u003Ccode>M\u003C/code> (chunk obtained via \u003Ccode>mmap\u003C/code>), and \u003Ccode>N\u003C/code> (non-main arena). The actual usable size is \u003Ccode>size &#x26; ~0x7\u003C/code>.\u003C/p>\n\u003Cp>This means:\u003C/p>\n\u003Col>\n\u003Cli>Every allocation has overhead. Small allocations suffer proportionally more: a 16-byte allocation requires at least 32 bytes of actual memory (16 bytes data + 16 bytes metadata, depending on the allocator).\u003C/li>\n\u003Cli>The allocator imposes its own alignment. \u003Ccode>malloc\u003C/code> guarantees alignment suitable for any primitive type (\u003Ccode>max_align_t\u003C/code>), which is 16 bytes on most 64-bit platforms.\u003C/li>\n\u003Cli>Memory is not \u003Cem>free\u003C/em>. The allocator tracks allocated regions, and \u003Ccode>free()\u003C/code> does not necessarily return memory to the OS, it typically returns it to a free list for reuse.\u003C/li>\n\u003C/ol>\n\u003Cp>When we discuss ownership and resource management in later sections, keep this in mind: \u003Cem>deallocating memory\u003C/em> at the language level means returning bytes to the allocator. The allocator decides when (if ever) to return pages to the operating system.\u003C/p>\n\u003Ch3 id=\"objects-are-bytes\">Objects Are Bytes\u003C/h3>\n\u003Cp>The C standard makes this explicit: every object can be viewed as an array of \u003Ccode>unsigned char\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bytes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">); i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%02x\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">[i])\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Output on little-endian x86-64: 2a 00 00 00\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is the object representation, the actual bytes in memory. The semantic interpretation (that these bytes represent the integer 42) is layered on top by the type system.\u003C/p>\n\u003Cp>Rust and C++ inherit this model. When we say a Rust \u003Ccode>i32\u003C/code> occupies 4 bytes with alignment 4, we mean exactly what C means: 4 contiguous bytes at an address divisible by 4. The type systems differ dramatically in what operations they permit on those bytes, but the physical representation is identical.\u003C/p>\n\u003Cp>This is the starting point. We have bytes in a virtual address space, aligned for hardware access, managed by an allocator. Everything that follows, effective types, ownership, lifetimesâ€”is a layer of abstraction over this physical reality.\u003C/p>\n\u003Ch2 id=\"from-bytes-to-objects\">From Bytes to Objects\u003C/h2>\n\u003Cp>A region of memory becomes an \u003Cem>object\u003C/em> when we impose a type interpretation on it. The type dictates how many bytes participate, what their alignment must be, and what operations are valid. But the three languages differ fundamentally in when and how this imposition occurs, and what invariants the type carries.\u003C/p>\n\u003Ch3 id=\"c-effective-type-rules\">C: Effective Type Rules\u003C/h3>\n\u003Cp>In C, the relationship between memory and type is established through the concept of \u003Cem>effective type\u003C/em>. The effective type of an object determines how it may be accessed.\u003C/p>\n\u003Cp>For declared variables, the effective type is simply the declared type:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // effective type of x is int\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The variable \u003Ccode>x\u003C/code> occupies \u003Ccode>sizeof(int)\u003C/code> bytes at some address, and those bytes must be accessed as \u003Ccode>int\u003C/code> or as \u003Ccode>unsigned char\u003C/code>. Accessing them as \u003Ccode>float*\u003C/code> is undefined behavior:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> f \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fp;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior: access through incompatible type\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is not a runtime check. The compiler does not insert code to verify the access. Instead, the rule exists to enable optimization. When the compiler sees a write through \u003Ccode>int*\u003C/code> and a read through \u003Ccode>float*\u003C/code>, the strict aliasing rule permits it to assume these pointers reference different objects. The compiler can then reorder loads and stores, keep values in registers across the write, and eliminate redundant accesses.\u003C/p>\n\u003Cp>The rule has a critical asymmetry. Any object can be viewed as an array of \u003Ccode>unsigned char\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bytes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">); i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%02x\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">[i])\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // valid: char access is always permitted\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>But the reverse is undefined:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> buffer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)buffer;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bufferâ€™s effective type is \u003Ccode>unsigned char[4]\u003C/code>. Accessing it through \u003Ccode>int*\u003C/code> violates the effective type rule. The fact that the bytes happen to form a valid \u003Ccode>int\u003C/code> representation is irrelevant. The compiler is entitled to assume this access cannot happen, and may generate code that produces garbage or crashes.\u003C/p>\n\u003Cp>For dynamically allocated memory, the situation is different. Memory returned by \u003Ccode>malloc\u003C/code> has no effective type until we write to it:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> malloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">dp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">dp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3.14\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // this write sets the effective type to double\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After this write, the allocated region has effective type \u003Ccode>double\u003C/code>. Subsequent reads through \u003Ccode>double*\u003C/code> are valid. Reading through \u003Ccode>int*\u003C/code> would again be undefined.\u003C/p>\n\u003Cp>The effective type machinery exists purely for optimization. The compiler uses it to reason about aliasing. It provides no runtime safety.\u003C/p>\n\u003Ch3 id=\"c-object-lifetime\">C++: Object Lifetime\u003C/h3>\n\u003Cp>C++ inherits Câ€™s effective type rules but adds a distinct concept: \u003Cem>object lifetime\u003C/em>. An objectâ€™s lifetime is the interval during which accessing the object is well-defined.\u003C/p>\n\u003Cp>The C++ standard (N4950, Â§6.7.3) specifies the boundaries precisely. For an object of type \u003Ccode>T\u003C/code>:\u003C/p>\n\u003Cblockquote>\n\u003Cp>The lifetime of an object of type T begins when:\n(1.1) storage with the proper alignment and size for type T is obtained, and\n(1.2) its initialization (if any) is complete\u003C/p>\n\u003C/blockquote>\n\u003Cblockquote>\n\u003Cp>The lifetime of an object of type T ends when:\n(1.3) if T is a non-class type, the object is destroyed, or\n(1.4) if T is a class type, the destructor call starts, or\n(1.5) the storage which the object occupies is released, or is reused by an object that is not nested within o.\u003C/p>\n\u003C/blockquote>\n\u003Cp>Consider placement new:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> value;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(v) { }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    ~Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() { std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">destroyed\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">alignas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> buffer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget)];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> w \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (buffer) \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // lifetime begins here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">~Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          // lifetime ends here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// buffer still contains bytes, but no Widget object exists\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Between placement new and the destructor call, a \u003Ccode>Widget\u003C/code> object exists at that address. Before placement new and after the destructor, the bytes exist but no \u003Ccode>Widget\u003C/code> does. Accessing \u003Ccode>w->value\u003C/code> after \u003Ccode>w->~Widget()\u003C/code> is undefined behavior, even though the bytes are still there and unchanged.\u003C/p>\n\u003Cp>The destructor call does not free memory. It ends the objectâ€™s lifetime while the storage remains intact. This is what placement new and explicit destructor calls rely on: the ability to construct an object in pre-existing storage, use it, destroy it, and potentially construct a different object in the same storage.\u003C/p>\n\u003Cp>For trivial types (those without constructors, destructors, or virtual functions), C++ objects behave essentially like C objects. For class types with nontrivial special member functions, the lifetime boundaries become significant. A \u003Ccode>std::string\u003C/code> accessed after destruction will likely read freed memory or corrupted pointers, because the destructor deallocated the internal buffer.\u003C/p>\n\u003Cp>C++20 also introduced \u003Cem>implicit object creation\u003C/em>. Certain operations, such as \u003Ccode>std::malloc\u003C/code>, implicitly create objects of \u003Cem>implicit-lifetime types\u003C/em> if doing so would give the program defined behavior:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> y; };\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // implicit-lifetime type (trivial)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">malloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Point));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // in C++20, this is well-defined\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // malloc implicitly created the Point object\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This was added to retroactively make well-defined the code patterns that had been common but technically undefined.\u003C/p>\n\u003Ch3 id=\"rust-validity-invariants\">Rust: Validity Invariants\u003C/h3>\n\u003Cp>Rust imposes a stronger requirement. Every type has \u003Cem>validity invariants\u003C/em>, and producing a value that violates its typeâ€™s invariant is immediate undefined behavior. The compilerâ€™s optimizer assumes these invariants hold unconditionally.\u003C/p>\n\u003Cp>The Rust Reference defines validity per type:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A bool must be 0x00 (false) or 0x01 (true)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: invalid bool\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A reference must be non-null, aligned, and point to a valid value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: null reference\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A char must be a valid Unicode scalar value (not a surrogate)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0xD800\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: surrogate\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// An enum must have a valid discriminant\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Status\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Active\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Inactive\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Status\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: invalid discriminant\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The never type must never exist\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeroed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The moment an invalid value is \u003Cem>produced\u003C/em>, undefined behavior has occurred. From the Rust Reference:\u003C/p>\n\u003Cblockquote>\n\u003Cp>The Rust compiler assumes that all values produced during program execution are valid, and producing an invalid value is hence immediate UB.\u003C/p>\n\u003C/blockquote>\n\u003Cp>In C, you can have an \u003Ccode>int\u003C/code> variable containing any 32-bit pattern, and as long as you do not read it in certain ways, no UB occurs. In Rust, if a \u003Ccode>bool\u003C/code> contains the bit pattern \u003Ccode>0x02\u003C/code>, UB has already happened at the point of creation, regardless of whether you subsequently read it.\u003C/p>\n\u003Cp>Consider references. In C and C++, a pointer can be null, and dereferencing it is UB. But the pointer itself can exist and be passed around. In Rust:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">null\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// valid: raw pointer can be null\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };          \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB occurs HERE, at reference creation\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The UB does not occur when we read through the reference. It occurs when the reference is created. A \u003Ccode>&#x26;T\u003C/code> carries an invariant: non-null, properly aligned, pointing to a valid \u003Ccode>T\u003C/code>. Violating this invariant at any point is UB, regardless of what we do with the reference afterward.\u003C/p>\n\u003Cp>This strictness enables more aggressive optimization. When the compiler sees a \u003Ccode>&#x26;T\u003C/code>, it emits \u003Ccode>dereferenceable\u003C/code> and \u003Ccode>nonnull\u003C/code> annotations to LLVM. A match expression on a \u003Ccode>bool\u003C/code> need not generate a default case for values 2-255. These optimizations would be unsound if invalid values could exist.\u003C/p>\n\u003Cp>The cost is that more operations require \u003Ccode>unsafe\u003C/code>. You cannot create a reference to potentially-invalid memory, even temporarily. You must use raw pointers and convert to references only when validity is guaranteed:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> some_ffi_function\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">is_null\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">is_aligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// sound: we verified validity\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"object-representation-vs-value\">Object Representation vs. Value\u003C/h3>\n\u003Cp>All three languages distinguish between an objectâ€™s \u003Cem>representation\u003C/em> (its bytes in memory) and its \u003Cem>value\u003C/em> (the semantic interpretation of those bytes). But they draw the line differently.\u003C/p>\n\u003Cp>In C, you can freely inspect any object as \u003Ccode>unsigned char[]\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> d \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3.14159\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bytes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">d;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// bytes[0..7] contain the IEEE 754 representation\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bytes are the objectâ€™s representation. The value is what those bytes mean according to the IEEE 754 standard. C permits examining bytes without caring about their semantic meaning.\u003C/p>\n\u003Cp>C++ inherits this but adds constraints around object lifetime. You can inspect the bytes of a live object. You cannot meaningfully inspect bytes of a destroyed object (the storage may be reused).\u003C/p>\n\u003Cp>Rust permits byte-level inspection through raw pointers and transmutation, but adds validity constraints:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// bytes now contains the representation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Going the other direction is more dangerous:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: 2 is not a valid bool\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The asymmetry here mirrors Câ€™s effective type asymmetry. Converting a typed value to bytes is generally safe. Converting bytes to a typed value requires that the bytes actually constitute a valid value of that type.\u003C/p>\n\u003Ch2 id=\"storage-duration\">Storage Duration\u003C/h2>\n\u003Cp>Every object resides somewhere in memory. The \u003Cem>storage duration\u003C/em> of an object determines when that memory is allocated and when it becomes invalid. All three languages recognize the same fundamental categories, though they use different terminology and provide different guarantees about deallocation.\u003C/p>\n\u003Ch3 id=\"the-four-categories\">The Four Categories\u003C/h3>\n\u003Cp>C defines four storage durations. C++ inherits the same four. Rust maps onto an equivalent model, though the language specification does not use identical terminology.\u003C/p>\n\u003Cp>\u003Cstrong>Static storage duration\u003C/strong>: The object exists for the entire execution of the program. In C and C++, this includes global variables, variables declared with \u003Ccode>static\u003C/code>, and string literals. In Rust, this includes \u003Ccode>static\u003C/code> items and string literals (which have type \u003Ccode>&#x26;'static str\u003C/code>). The memory for these objects is typically placed in the \u003Ccode>.data\u003C/code> or \u003Ccode>.rodata\u003C/code> segment of the executable and requires no runtime allocation.\u003C/p>\n\u003Cp>\u003Cstrong>Thread storage duration\u003C/strong>: The object exists for the lifetime of a thread. C11 introduced \u003Ccode>_Thread_local\u003C/code> (spelled \u003Ccode>thread_local\u003C/code> since C23), C++11 introduced \u003Ccode>thread_local\u003C/code>, and Rust provides \u003Ccode>thread_local!\u003C/code> macro. Each thread gets its own instance of the variable, allocated when the thread starts and deallocated when it terminates.\u003C/p>\n\u003Cp>\u003Cstrong>Automatic storage duration\u003C/strong>: The object exists within a lexical scope, typically a function body or block. When execution enters the scope, space is reserved; when execution leaves, the space is released. In C and C++, local variables without \u003Ccode>static\u003C/code> or \u003Ccode>thread_local\u003C/code> have automatic storage. In Rust, all local bindings have automatic storage. This is typically implemented via the stack.\u003C/p>\n\u003Cp>\u003Cstrong>Allocated (dynamic) storage duration\u003C/strong>: The objectâ€™s lifetime is controlled explicitly by the program. In C, this means \u003Ccode>malloc\u003C/code>/\u003Ccode>free\u003C/code>. In C++, this means \u003Ccode>new\u003C/code>/\u003Ccode>delete\u003C/code> or allocator-aware containers. In Rust, this means \u003Ccode>Box\u003C/code>, \u003Ccode>Vec\u003C/code>, \u003Ccode>String\u003C/code>, and other heap-allocating types.\u003C/p>\n\u003Ch3 id=\"stack\">Stack\u003C/h3>\n\u003Cp>Automatic storage is almost universally implemented using a call stack. When a function is called, the compiler reserves space for its local variables by adjusting the stack pointer. On x86-64 following the System V ABI, this looks like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">my_function\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    push\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rbp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rbp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    sub\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">48\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">          ; reserve 48 bytes for locals\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    ; ... function body ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rbp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    pop\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rbp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    ret\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>sub rsp, 48\u003C/code> instruction allocates space for all local variables in a single operation. The compiler computes the required size at compile time by summing the sizes of all locals (accounting for alignment). Deallocation is equally cheap: \u003Ccode>mov rsp, rbp\u003C/code> releases all that space instantly.\u003C/p>\n\u003Cp>This has two consequences:\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>Allocation and deallocation of automatic storage is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> regardless of how many objects are involved. A function with 100 local variables pays the same cost as one with 2.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The space is not initialized. After \u003Ccode>sub rsp, 48\u003C/code>, those 48 bytes contain whatever was previously on the stack. In C, reading an uninitialized automatic variable is undefined behavior (the value is \u003Cem>indeterminate\u003C/em>). In C++, the same rule applies. In Rust, the compiler enforces definite initialization: you cannot read a variable before assigning to it.\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: borrow of possibly-uninitialized variable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The Rust compiler tracks initialization state through control flow and rejects programs that might read uninitialized memory. This is a compile-time check with no runtime cost.\u003C/p>\n\u003Ch3 id=\"heap\">Heap\u003C/h3>\n\u003Cp>Dynamic allocation is fundamentally different. When we call \u003Ccode>malloc(n)\u003C/code>, the allocator must:\u003C/p>\n\u003Col>\n\u003Cli>Find a contiguous region of at least \u003Ccode>n\u003C/code> bytes that is not currently in use\u003C/li>\n\u003Cli>Mark that region as allocated\u003C/li>\n\u003Cli>Return a pointer to it\u003C/li>\n\u003C/ol>\n\u003Cp>When we call \u003Ccode>free(p)\u003C/code>, the allocator must:\u003C/p>\n\u003Col>\n\u003Cli>Determine the size of the allocation (stored in metadata adjacent to the user data)\u003C/li>\n\u003Cli>Mark that region as available for future allocations\u003C/li>\n\u003Cli>Possibly coalesce adjacent free regions to reduce fragmentation\u003C/li>\n\u003C/ol>\n\u003Cp>This involves data structure manipulation, potential system calls (if the allocator needs more memory from the OS), and can have variable latency depending on heap state. The cost is not \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>In C, heap allocation is explicit:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> malloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> NULL\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // allocation failed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ... use p ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">free\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(p);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The programmer is responsible for:\u003C/p>\n\u003Col>\n\u003Cli>Checking for allocation failure\u003C/li>\n\u003Cli>Calling \u003Ccode>free\u003C/code> exactly once\u003C/li>\n\u003Cli>Not using the pointer after \u003Ccode>free\u003C/code>\u003C/li>\n\u003Cli>Not freeing the same pointer twice\u003C/li>\n\u003C/ol>\n\u003Cp>Violating any of these causes undefined behavior or memory leaks. The language provides no assistance.\u003C/p>\n\u003Cp>In C++, dynamic allocation can be explicit (\u003Ccode>new\u003C/code>/\u003Ccode>delete\u003C/code>) or managed through RAII:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Explicit (dangerous)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">delete[]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// RAII (safer)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_unique\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[]>(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v automatically deleted when it goes out of scope\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>std::unique_ptr\u003C/code> wraps a raw pointer and calls \u003Ccode>delete\u003C/code> in its destructor. When \u003Ccode>v\u003C/code> goes out of scope, the destructor runs, the memory is freed. The programmer does not call \u003Ccode>delete\u003C/code> manually.\u003C/p>\n\u003Cp>This is opt-in. You can still use raw \u003Ccode>new\u003C/code>/\u003Ccode>delete\u003C/code>. You can still have dangling pointers. The compiler does not verify correctness.\u003C/p>\n\u003Cp>In Rust, heap allocation is handled through owning types:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v automatically deallocated when it goes out of scope\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>Vec&#x3C;T>\u003C/code> owns heap-allocated memory. When \u003Ccode>v\u003C/code> goes out of scope, \u003Ccode>Vec\u003C/code>â€™s \u003Ccode>Drop\u003C/code> implementation runs, calling the allocator to free the buffer. There is no way to forget to free, no way to double-free, and no way to use after free (the compiler rejects such programs).\u003C/p>\n\u003Cp>The difference from C++ is that Rustâ€™s ownership is not opt-in. Every heap allocation is owned by exactly one binding. Transferring ownership is a move. After a move, the original binding is unusable:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v1 moved to v2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: borrow of moved value\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"who-calls-free\">Who Calls Free?\u003C/h3>\n\u003Cp>The central difference between C, C++, and Rust in their treatment of dynamic storage is responsibility for deallocation.\u003C/p>\n\u003Cp>In C, the programmer decides when to call \u003Ccode>free\u003C/code>. The language does not track ownership. If you pass a pointer to a function, the function might free it, or it might not. The only way to know is documentation or convention.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Does this function free data? You have to read the docs.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In C++, RAII shifts responsibility to destructors. If you use \u003Ccode>unique_ptr\u003C/code>, the destructor frees. If you use \u003Ccode>shared_ptr\u003C/code>, the destructor decrements a reference count and frees when it reaches zero. But you can still use raw pointers, and the compiler cannot tell you which convention a given codebase follows.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Raw pointer: who owns this? Still ambiguous.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">unique_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[]> \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Ownership transferred: this function will free when done.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In Rust, the type system encodes ownership:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // This function owns data. It will be freed when process returns.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // This function borrows data. The caller retains ownership.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Mutable borrow. Caller retains ownership. No other access allowed during this call.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The signature tells you everything. \u003Ccode>Vec&#x3C;i32>\u003C/code> means ownership transfer. \u003Ccode>&#x26;Vec&#x3C;i32>\u003C/code> means immutable borrow. \u003Ccode>&#x26;mut Vec&#x3C;i32>\u003C/code> means mutable borrow. The compiler enforces these semantics. You cannot pass a \u003Ccode>Vec\u003C/code> and then continue using it; the move would be rejected.\u003C/p>\n\u003Ch3 id=\"stack-allocation-in-rust\">Stack Allocation in Rust\u003C/h3>\n\u003Cp>Rust provides fine-grained control over whether data lives on the stack or heap. By default, local bindings are stack-allocated:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 4000 bytes on the stack\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This works until the array is too large for the stack (typically 1-8 MB depending on platform). For large allocations, use \u003Ccode>Box\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">1000000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">([\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// heap\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>Box&#x3C;T>\u003C/code> is a pointer to a heap allocation. It has the same size as a raw pointer (8 bytes on 64-bit), implements \u003Ccode>Deref\u003C/code> so you can use it like a reference, and frees the allocation in its \u003Ccode>Drop\u003C/code> implementation.\u003C/p>\n\u003Cp>The memory layout of \u003Ccode>Box&#x3C;T>\u003C/code> is a single pointer:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]>>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// just a pointer\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Unlike C++ \u003Ccode>unique_ptr\u003C/code>, which may carry a deleter, \u003Ccode>Box&#x3C;T>\u003C/code> always uses the global allocator and has no space overhead. The deallocation function is known statically.\u003C/p>\n\u003Ch3 id=\"how-does-vec-work\">How Does Vec Work?\u003C/h3>\n\u003Cp>\u003Ccode>Vec&#x3C;T>\u003C/code> is Rustâ€™s growable array. Its memory layout is three machine words:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Conceptually:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// pointer to heap allocation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    cap\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// allocated capacity\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// number of initialized elements\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On 64-bit, \u003Ccode>size_of::&#x3C;Vec&#x3C;T>>()\u003C/code> is 24 bytes regardless of \u003Ccode>T\u003C/code>.\u003C/p>\n\u003Cp>When you create a \u003Ccode>Vec\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The allocator provides a buffer for 10 elements. \u003Ccode>ptr\u003C/code> points to it, \u003Ccode>cap\u003C/code> is 10, \u003Ccode>len\u003C/code> is 0.\u003C/p>\n\u003Cp>When you push elements:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// len becomes 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// len becomes 2\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Each \u003Ccode>push\u003C/code> writes to \u003Ccode>ptr.add(len)\u003C/code> and increments \u003Ccode>len\u003C/code>. No reallocation occurs while \u003Ccode>len &#x3C; cap\u003C/code>.\u003C/p>\n\u003Cp>When \u003Ccode>len\u003C/code> reaches \u003Ccode>cap\u003C/code> and you push again, \u003Ccode>Vec\u003C/code> must reallocate:\u003C/p>\n\u003Col>\n\u003Cli>Allocate a new buffer with larger capacity\u003C/li>\n\u003Cli>Copy existing elements to the new buffer\u003C/li>\n\u003Cli>Free the old buffer\u003C/li>\n\u003Cli>Update \u003Ccode>ptr\u003C/code> and \u003Ccode>cap\u003C/code>\u003C/li>\n\u003C/ol>\n\u003Cp>When \u003Ccode>Vec\u003C/code> is dropped:\u003C/p>\n\u003Col>\n\u003Cli>Call \u003Ccode>drop\u003C/code> on each element (for types with destructors)\u003C/li>\n\u003Cli>Free the buffer\u003C/li>\n\u003C/ol>\n\u003Cp>All of this happens automatically. The programmer writes \u003Ccode>v.push(x)\u003C/code> and the ownership system ensures the buffer is freed exactly once, when \u003Ccode>v\u003C/code> goes out of scope.\u003C/p>\n\u003Cp>This is the pattern throughout Rustâ€™s standard library. \u003Ccode>String\u003C/code> owns a UTF-8 buffer. \u003Ccode>HashMap\u003C/code> owns its backing storage. \u003Ccode>File\u003C/code> owns a file descriptor. When the owner goes out of scope, the resource is released. The type system ensures there is always exactly one owner.\u003C/p>",{"headings":642,"localImagePaths":696,"remoteImagePaths":697,"frontmatter":698,"imagePaths":701},[643,644,647,650,653,656,659,662,665,668,671,674,677,680,683,684,687,690,693],{"depth":32,"slug":210,"text":555},{"depth":32,"slug":645,"text":646},"memory-is-just-bytes","Memory Is Just Bytes",{"depth":131,"slug":648,"text":649},"virtual-address-space","Virtual Address Space",{"depth":131,"slug":651,"text":652},"alignment","Alignment",{"depth":131,"slug":654,"text":655},"cache-lines-and-memory-bandwidth","Cache Lines and Memory Bandwidth",{"depth":131,"slug":657,"text":658},"the-allocators-view","The Allocatorâ€™s View",{"depth":131,"slug":660,"text":661},"objects-are-bytes","Objects Are Bytes",{"depth":32,"slug":663,"text":664},"from-bytes-to-objects","From Bytes to Objects",{"depth":131,"slug":666,"text":667},"c-effective-type-rules","C: Effective Type Rules",{"depth":131,"slug":669,"text":670},"c-object-lifetime","C++: Object Lifetime",{"depth":131,"slug":672,"text":673},"rust-validity-invariants","Rust: Validity Invariants",{"depth":131,"slug":675,"text":676},"object-representation-vs-value","Object Representation vs. Value",{"depth":32,"slug":678,"text":679},"storage-duration","Storage Duration",{"depth":131,"slug":681,"text":682},"the-four-categories","The Four Categories",{"depth":131,"slug":370,"text":371},{"depth":131,"slug":685,"text":686},"heap","Heap",{"depth":131,"slug":688,"text":689},"who-calls-free","Who Calls Free?",{"depth":131,"slug":691,"text":692},"stack-allocation-in-rust","Stack Allocation in Rust",{"depth":131,"slug":694,"text":695},"how-does-vec-work","How Does Vec Work?",[],[],{"author":14,"pubDatetime":699,"title":632,"slug":628,"featured":17,"draft":198,"tags":700,"description":635},["Date","2025-12-20T00:00:00.000Z"],[200,634],[]]