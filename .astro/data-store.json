[["Map",1,2,9,10,191,192],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.15.5","content-config-digest","fff55245e6a284ed","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://lukefleed.xyz\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"layout\":\"constrained\",\"responsiveStyles\":true},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{\"light\":\"min-light\",\"dark\":\"night-owl\"},\"defaultColor\":false,\"wrap\":false,\"transformers\":[{},{\"name\":\"@shikijs/transformers:notation-highlight\"},{\"name\":\"@shikijs/transformers:notation-highlight-word\"},{\"name\":\"@shikijs/transformers:notation-diff\"}]},\"remarkPlugins\":[null,null,[null,{\"test\":\"Table of contents\"}]],\"rehypePlugins\":[null],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true,\"allowedDomains\":[]},\"env\":{\"schema\":{\"PUBLIC_GOOGLE_SITE_VERIFICATION\":{\"access\":\"public\",\"context\":\"client\",\"optional\":true,\"type\":\"string\"}},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":true,\"liveContentCollections\":false,\"csp\":false,\"staticImportMetaEnv\":false,\"chromeDevtoolsWorkspace\":false,\"failOnPrerenderConflict\":false},\"legacy\":{\"collections\":false}}","university",["Map",11,12,41,42,63,64,85,86,112,113,149,150],"diverse-lcs",{"id":11,"data":13,"body":22,"filePath":23,"assetImports":24,"digest":26,"rendered":27},{"author":14,"pubDatetime":15,"title":16,"featured":17,"draft":17,"tags":18,"ogImage":20,"description":21},"Luca Lombardo",["Date","2024-12-14T00:00:00.000Z"],"Finding Diverse Strings and Longest Common Sequences in a Graph",false,[19],"Algorithms and Data Structures","__ASTRO_IMAGE_","Slides for a seminar in bioinformatics.","Github repository: [link](https://github.com/lukefleed/rank-on-dags)\n\n## Slides for the seminar \"Finding Diverse Strings and Longest Common Sequences in a Graph\"\n\n\u003C!--\n@misc{shida2024findingdiversestringslongest,\n      title={Finding Diverse Strings and Longest Common Subsequences in a Graph},\n      author={Yuto Shida and Giulia Punzi and Yasuaki Kobayashi and Takeaki Uno and Hiroki Arimura},\n      year={2024},\n      eprint={2405.00131},\n      archivePrefix={arXiv},\n      primaryClass={cs.DS},\n      url={https://arxiv.org/abs/2405.00131},\n} -->\n\nPresentation over the paper \"Finding Diverse Strings and Longest Common Sequences in a Graph\" by Yuto Shida, Giulia Punzi, Yasuaki Kobayashi, Takeaki Uno, and Hiroki Arimura. The paper is available on [arXiv](https://arxiv.org/abs/2405.00131).\n\n---\n\nThe presentation was given for the course \"Bioinformatics\" at the University of Pisa in the academic year 2024/2025.\n\n---\n\nYou can find the slides here: [view](https://github.com/lukefleed/diverse-LCS-slides/blob/main/tex/main.pdf) / [download](https://github.com/lukefleed/diverse-LCS-slides/raw/main/tex/main.pdf)\n\n---","src/data/university/diverse-lcs.md",[25],"","0b52744614ca4021",{"html":28,"metadata":29},"\u003Cp>Github repository: \u003Ca href=\"https://github.com/lukefleed/rank-on-dags\">link\u003C/a>\u003C/p>\n\u003Ch2 id=\"slides-for-the-seminar-finding-diverse-strings-and-longest-common-sequences-in-a-graph\">Slides for the seminar â€œFinding Diverse Strings and Longest Common Sequences in a Graphâ€\u003C/h2>\n\u003C!--\n@misc{shida2024findingdiversestringslongest,\n      title={Finding Diverse Strings and Longest Common Subsequences in a Graph},\n      author={Yuto Shida and Giulia Punzi and Yasuaki Kobayashi and Takeaki Uno and Hiroki Arimura},\n      year={2024},\n      eprint={2405.00131},\n      archivePrefix={arXiv},\n      primaryClass={cs.DS},\n      url={https://arxiv.org/abs/2405.00131},\n} -->\n\u003Cp>Presentation over the paper â€œFinding Diverse Strings and Longest Common Sequences in a Graphâ€ by Yuto Shida, Giulia Punzi, Yasuaki Kobayashi, Takeaki Uno, and Hiroki Arimura. The paper is available on \u003Ca href=\"https://arxiv.org/abs/2405.00131\">arXiv\u003C/a>.\u003C/p>\n\u003Chr>\n\u003Cp>The presentation was given for the course â€œBioinformaticsâ€ at the University of Pisa in the academic year 2024/2025.\u003C/p>\n\u003Chr>\n\u003Cp>You can find the slides here: \u003Ca href=\"https://github.com/lukefleed/diverse-LCS-slides/blob/main/tex/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/diverse-LCS-slides/raw/main/tex/main.pdf\">download\u003C/a>\u003C/p>\n\u003Chr>",{"headings":30,"localImagePaths":35,"remoteImagePaths":36,"frontmatter":37,"imagePaths":40},[31],{"depth":32,"slug":33,"text":34},2,"slides-for-the-seminar-finding-diverse-strings-and-longest-common-sequences-in-a-graph","Slides for the seminar â€œFinding Diverse Strings and Longest Common Sequences in a Graphâ€",[],[],{"author":14,"pubDatetime":38,"title":16,"slug":11,"featured":17,"draft":17,"tags":39,"ogImage":25,"description":21},["Date","2024-12-14T00:00:00.000Z"],[19],[],"g2-cheat-sheet",{"id":41,"data":43,"body":49,"filePath":50,"assetImports":51,"digest":52,"rendered":53},{"author":14,"pubDatetime":44,"title":45,"featured":17,"draft":17,"tags":46,"ogImage":20,"description":48},["Date","2024-01-24T00:00:00.000Z"],"G2 cheat sheet",[47],"Math","ðŸ‡®ðŸ‡¹ Versione compatta senza dimostrazioni delle dispense di Geometria 2 di Francesco Sorce.","- Github repository: [link](https://github.com/lukefleed/G2-cheat-sheet)\n\nVersione in due colonne e senza dimostrazioni delle dispense di [Francesco Sorce](https://poisson.phc.dm.unipi.it/~fsorce/) per il corso di Geometria 2, A.A. 2022/2023.\n\nPDF delle dispense: [Clicca Qui](https://github.com/lukefleed/G2-cheat-sheet/raw/build/G2_cheat_sheet.pdf)\n\n---\n\n**Dispense originali:** [overleaf](https://www.overleaf.com/read/vsdktbwrgpth)\n\n---","src/data/university/g2-cheat-sheet.md",[25],"d58dd9307a00556d",{"html":54,"metadata":55},"\u003Cul>\n\u003Cli>Github repository: \u003Ca href=\"https://github.com/lukefleed/G2-cheat-sheet\">link\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>Versione in due colonne e senza dimostrazioni delle dispense di \u003Ca href=\"https://poisson.phc.dm.unipi.it/~fsorce/\">Francesco Sorce\u003C/a> per il corso di Geometria 2, A.A. 2022/2023.\u003C/p>\n\u003Cp>PDF delle dispense: \u003Ca href=\"https://github.com/lukefleed/G2-cheat-sheet/raw/build/G2_cheat_sheet.pdf\">Clicca Qui\u003C/a>\u003C/p>\n\u003Chr>\n\u003Cp>\u003Cstrong>Dispense originali:\u003C/strong> \u003Ca href=\"https://www.overleaf.com/read/vsdktbwrgpth\">overleaf\u003C/a>\u003C/p>\n\u003Chr>",{"headings":56,"localImagePaths":57,"remoteImagePaths":58,"frontmatter":59,"imagePaths":62},[],[],[],{"author":14,"pubDatetime":60,"title":45,"slug":41,"featured":17,"draft":17,"tags":61,"ogImage":25,"description":48},["Date","2024-01-24T00:00:00.000Z"],[47],[],"nummarkov",{"id":63,"data":65,"body":71,"filePath":72,"assetImports":73,"digest":74,"rendered":75},{"author":14,"pubDatetime":66,"title":67,"featured":17,"draft":17,"tags":68,"ogImage":20,"description":70},["Date","2023-04-04T00:00:00.000Z"],"Queueing System with Potential for Recruiting Secondary Servers",[69],"Scientific Computing","Slides for a seminar on the topic of numerical methods for Markov Chains","Github repository: [link](https://github.com/lukefleed/numerical-markov-slides)\n\n---\n\nðŸ‡¬ðŸ‡§ _Since I wrote the slides for the seminar in Italian, this post will be in Italian as well._\n\nðŸ‡®ðŸ‡¹ Seminario basato sul [paper](https://www.mdpi.com/2227-7390/11/3/624) [1]\n\n> [1]. Srinivas R. Chakravarthy, Alexander N. Dudin, Sergey A. Dudin and Olga S. Dudina. Queueing System with Potential for Recruiting Secondary Servers. Mathematics 2023, 11(3), 624;\n\nPer scaricare il pdf delle slides, cliccare qui: [view](https://github.com/lukefleed/numerical-markov-slides/blob/main/slides/main.pdf) / [download](https://github.com/lukefleed/numerical-markov-slides/raw/main/slides/main.pdf)\n\n---\n\nSeminario per il corso di _Metodi Numerici per Catene di Markov_  tenuto presso il Dipartimento di Matematica dell'UniversitÃ  di Pisa, nell'anno accademico 2022/2023.\n\n---","src/data/university/nummarkov.md",[25],"94ca462ef1b8a7b4",{"html":76,"metadata":77},"\u003Cp>Github repository: \u003Ca href=\"https://github.com/lukefleed/numerical-markov-slides\">link\u003C/a>\u003C/p>\n\u003Chr>\n\u003Cp>ðŸ‡¬ðŸ‡§ \u003Cem>Since I wrote the slides for the seminar in Italian, this post will be in Italian as well.\u003C/em>\u003C/p>\n\u003Cp>ðŸ‡®ðŸ‡¹ Seminario basato sul \u003Ca href=\"https://www.mdpi.com/2227-7390/11/3/624\">paper\u003C/a> [1]\u003C/p>\n\u003Cblockquote>\n\u003Cp>[1]. Srinivas R. Chakravarthy, Alexander N. Dudin, Sergey A. Dudin and Olga S. Dudina. Queueing System with Potential for Recruiting Secondary Servers. Mathematics 2023, 11(3), 624;\u003C/p>\n\u003C/blockquote>\n\u003Cp>Per scaricare il pdf delle slides, cliccare qui: \u003Ca href=\"https://github.com/lukefleed/numerical-markov-slides/blob/main/slides/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/numerical-markov-slides/raw/main/slides/main.pdf\">download\u003C/a>\u003C/p>\n\u003Chr>\n\u003Cp>Seminario per il corso di \u003Cem>Metodi Numerici per Catene di Markov\u003C/em>  tenuto presso il Dipartimento di Matematica dellâ€™UniversitÃ  di Pisa, nellâ€™anno accademico 2022/2023.\u003C/p>\n\u003Chr>",{"headings":78,"localImagePaths":79,"remoteImagePaths":80,"frontmatter":81,"imagePaths":84},[],[],[],{"author":14,"pubDatetime":82,"title":67,"slug":63,"featured":17,"draft":17,"tags":83,"ogImage":25,"description":70},["Date","2023-04-04T00:00:00.000Z"],[69],[],"shifted-pow-gmres",{"id":85,"data":87,"body":92,"filePath":93,"assetImports":94,"digest":95,"rendered":96},{"author":14,"pubDatetime":88,"title":89,"featured":17,"draft":17,"tags":90,"ogImage":20,"description":91},["Date","2022-12-27T00:00:00.000Z"],"Methods for solving PageRank with multiple damping factors",[69],"Implementation of the shifted power method and the shifted GMRES method","- Report of the project: [view](https://github.com/lukefleed/ShfitedPowGMRES/blob/main/tex/main.pdf) / [download](https://github.com/lukefleed/ShfitedPowGMRES/raw/main/tex/main.pdf)\n- GitHub repository: [view](https://github.com/lukefleed/ShfitedPowGMRES)\n\nThis repository contains the code of my attempt to replicate the results obtained in `[1]`. The scripts are all written in python and are heavily build around the libraries SciPy and NumPy. To install all the required packages with `pip` run the following command in terminal\n\n```bash\npip install -r requirements.txt\n```\n\nAt the moment, the standard and shifted power method to compute the PageRank with multiple damping factors are fully implemented (as described in `[1]`). To run the program we need to execute the `main.py` file. It takes as input two arguments:\n\n- `--dataset`: the options are `BerkStan` and `Stanford`. This commands selects the web-graph to run the algorithms on.\n- `--algo`: the options are `power`, `shifted`, `both`. If you choose the last option, it will first run the standard power method and then the shifted one.\n\nHere an example of what's described above.\n\n```bash\n./main.py --dataset Stanford --algo both\n```\n\n## Under development\n\nIn the `testing/` folder there are two python notebook that contains the attempt on replicating the results obtained in `[1]` for the shifted GMRES method. The implementation of the Arnoldi process is fully working. On the other hand, there are several problems on the shifted GMRES algorithm that I can't figure out.\n\n## References\n\n`[1]` _Zhao-Li Shen, Meng Su, Bruno Carpentieri, and Chun Wen. Shifted power-gmres method accelerated by extrapolation for solving pagerank with multiple damping factors. Applied Mathematics and Computation, 420:126799, 2022_","src/data/university/shifted-pow-gmres.md",[25],"97ecb6f88e8649ae",{"html":97,"metadata":98},"\u003Cul>\n\u003Cli>Report of the project: \u003Ca href=\"https://github.com/lukefleed/ShfitedPowGMRES/blob/main/tex/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/ShfitedPowGMRES/raw/main/tex/main.pdf\">download\u003C/a>\u003C/li>\n\u003Cli>GitHub repository: \u003Ca href=\"https://github.com/lukefleed/ShfitedPowGMRES\">view\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>This repository contains the code of my attempt to replicate the results obtained in \u003Ccode>[1]\u003C/code>. The scripts are all written in python and are heavily build around the libraries SciPy and NumPy. To install all the required packages with \u003Ccode>pip\u003C/code> run the following command in terminal\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">pip\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> install\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> -r\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> requirements.txt\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>At the moment, the standard and shifted power method to compute the PageRank with multiple damping factors are fully implemented (as described in \u003Ccode>[1]\u003C/code>). To run the program we need to execute the \u003Ccode>main.py\u003C/code> file. It takes as input two arguments:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>--dataset\u003C/code>: the options are \u003Ccode>BerkStan\u003C/code> and \u003Ccode>Stanford\u003C/code>. This commands selects the web-graph to run the algorithms on.\u003C/li>\n\u003Cli>\u003Ccode>--algo\u003C/code>: the options are \u003Ccode>power\u003C/code>, \u003Ccode>shifted\u003C/code>, \u003Ccode>both\u003C/code>. If you choose the last option, it will first run the standard power method and then the shifted one.\u003C/li>\n\u003C/ul>\n\u003Cp>Here an example of whatâ€™s described above.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./main.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --dataset\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> Stanford\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --algo\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> both\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"under-development\">Under development\u003C/h2>\n\u003Cp>In the \u003Ccode>testing/\u003C/code> folder there are two python notebook that contains the attempt on replicating the results obtained in \u003Ccode>[1]\u003C/code> for the shifted GMRES method. The implementation of the Arnoldi process is fully working. On the other hand, there are several problems on the shifted GMRES algorithm that I canâ€™t figure out.\u003C/p>\n\u003Ch2 id=\"references\">References\u003C/h2>\n\u003Cp>\u003Ccode>[1]\u003C/code> \u003Cem>Zhao-Li Shen, Meng Su, Bruno Carpentieri, and Chun Wen. Shifted power-gmres method accelerated by extrapolation for solving pagerank with multiple damping factors. Applied Mathematics and Computation, 420:126799, 2022\u003C/em>\u003C/p>",{"headings":99,"localImagePaths":106,"remoteImagePaths":107,"frontmatter":108,"imagePaths":111},[100,103],{"depth":32,"slug":101,"text":102},"under-development","Under development",{"depth":32,"slug":104,"text":105},"references","References",[],[],{"author":14,"pubDatetime":109,"title":89,"slug":85,"featured":17,"draft":17,"tags":110,"ogImage":25,"description":91},["Date","2022-12-27T00:00:00.000Z"],[69],[],"imdb-graph",{"id":112,"data":114,"body":119,"filePath":120,"assetImports":121,"digest":122,"rendered":123},{"author":14,"pubDatetime":115,"title":116,"featured":17,"draft":17,"tags":117,"ogImage":20,"description":118},["Date","2022-04-26T00:00:00.000Z"],"An exact and fast algorithm for computing top-k closeness centrality",[19],"An exact and fast algorithm for computing top-k closeness centrality, tested on the IMDb dataset","The explanation of this algorithm and all its analysis can be found in the project report: [view](https://github.com/lukefleed/imdb-graph/blob/main/tex/src/main.pdf) / [download](https://github.com/lukefleed/imdb-graph/raw/main/tex/src/main.pdf)\n\n- Github repository: [imdb-graph](https://github.com/lukefleed/imdb-graph)\n\n## Documentation\n\nFirst thing first, we need to clone the repository\n\n```bash\ngit clone https://github.com/lukefleed/imdb-graph\n```\n\nOnce done, move in it\n\n```bash\ncd imdb-graph\n```\n\n### Downloading and filtering the data\n\nAll the necessary file are inside the folder `filters`\n\n```bash\ncd filters\n```\n\nWe have two options. If we want to build the graph where the actors are the node, we have to run\n\n```bash\n./actors_graph_filter.py --min-movies 42\n```\n\n`min-movies` has to ben an integer, `42` is just an example. It represents the minimum number of movies that an actor/actress needs to have done to be considered in our graph.\n\nIf we want to build the graph where the movies are the nodes, we have to run\n\n```bash\n./movie_graph_filter.py --votes 500\n```\n\n`votes` has to ben an integer, `500` is just an example. It represents the minimum number of votes that a movie needs to have on the IMDb database to be considered in our graph.\n\nAll the data filtered will be saved in a new folder called `data`\n\n### Running the program\n\nLet's move into the folder `scripts`. If we want to run the program on the actors graph, use\n\n```bash\n./actors_graph top_actors_42\n```\n\n> IMPORTANT: The algorithm is multi-threaded. It's set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\n> where `top_actors_42` is the output file name. Anything can be used.\n\n---\n\nIf we want to run the program on the movies graph, use\n\n```bash\n./movie_graph top_movies_42\n```\n\n> IMPORTANT: The algorithm is multi-threaded. It's set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\n> where `top_movies_42` is the output file name. Anything can be used\n\n---\n\nThose scripts will generate two files .txt (one for the harmonic and one for the closeness centrality). Those files will have the top-100 elements for the relative centrality. If we want a different value, just change the variable `k` in the .cpp files\n\n### Automatic script for different variables of filtering\n\nWe are in the folder `scripts`. Inside both the folders `actor-graph` and `movie-graph` there is a file called `bench_me.sh`. This file will run everything automatically in loop for different values of the filtering variables. To modify this file we need to edit the file. To run it\n\n```bash\n./bench_me.sh\n```\n\nThis will also save the logs in a folder called `time`. It can be usefull to analyze the performance of the program.\n\n---\n\nInside the folders `closeness centrality` (for both graph), there is a python script `analysis.py`. Put all the generated `_c.txt` files in the folder and run it. It will return a matrix showing the discrepancy of the results while varying the variable\n\n### Generating the interactive graphs\n\nFirst, let's move into the folder `visualization`\n\n```bash\ncd visualization\n```\n\nAs before, we will find two folders, one for each type of graph. Choose the one that we want to with and move into that folder. Inside it we need to create a folder called `data`\n\n```bash\nmkdir data\n```\n\nAnd copy inside it the files\n\n- `Attori.txt`\n- `FilmFiltrati.txt`\n- `Relazioni.txt`\n\nAttention! If we are visualizing the actors graph, it's important to copy the file generated for it. Ideal values of `min-actors` and `votes` during the filtering are respectively `70` and `100000`. Since it has to be rendered in a web page, this values will generate graphs with about 1000 nodes. I won't suggest to try with bigger graphs","src/data/university/imdb-graph.md",[25],"bf072ecaab6c34e8",{"html":124,"metadata":125},"\u003Cp>The explanation of this algorithm and all its analysis can be found in the project report: \u003Ca href=\"https://github.com/lukefleed/imdb-graph/blob/main/tex/src/main.pdf\">view\u003C/a> / \u003Ca href=\"https://github.com/lukefleed/imdb-graph/raw/main/tex/src/main.pdf\">download\u003C/a>\u003C/p>\n\u003Cul>\n\u003Cli>Github repository: \u003Ca href=\"https://github.com/lukefleed/imdb-graph\">imdb-graph\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"documentation\">Documentation\u003C/h2>\n\u003Cp>First thing first, we need to clone the repository\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">git\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> clone\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> https://github.com/lukefleed/imdb-graph\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Once done, move in it\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic\">cd\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> imdb-graph\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"downloading-and-filtering-the-data\">Downloading and filtering the data\u003C/h3>\n\u003Cp>All the necessary file are inside the folder \u003Ccode>filters\u003C/code>\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic\">cd\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> filters\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We have two options. If we want to build the graph where the actors are the node, we have to run\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./actors_graph_filter.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --min-movies\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>min-movies\u003C/code> has to ben an integer, \u003Ccode>42\u003C/code> is just an example. It represents the minimum number of movies that an actor/actress needs to have done to be considered in our graph.\u003C/p>\n\u003Cp>If we want to build the graph where the movies are the nodes, we have to run\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./movie_graph_filter.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --votes\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 500\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>votes\u003C/code> has to ben an integer, \u003Ccode>500\u003C/code> is just an example. It represents the minimum number of votes that a movie needs to have on the IMDb database to be considered in our graph.\u003C/p>\n\u003Cp>All the data filtered will be saved in a new folder called \u003Ccode>data\u003C/code>\u003C/p>\n\u003Ch3 id=\"running-the-program\">Running the program\u003C/h3>\n\u003Cp>Letâ€™s move into the folder \u003Ccode>scripts\u003C/code>. If we want to run the program on the actors graph, use\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./actors_graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> top_actors_42\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>IMPORTANT: The algorithm is multi-threaded. Itâ€™s set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\nwhere \u003Ccode>top_actors_42\u003C/code> is the output file name. Anything can be used.\u003C/p>\n\u003C/blockquote>\n\u003Chr>\n\u003Cp>If we want to run the program on the movies graph, use\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./movie_graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> top_movies_42\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>IMPORTANT: The algorithm is multi-threaded. Itâ€™s set with a default number of 12, modify the file .cpp and change this value depending on the CPU.\nwhere \u003Ccode>top_movies_42\u003C/code> is the output file name. Anything can be used\u003C/p>\n\u003C/blockquote>\n\u003Chr>\n\u003Cp>Those scripts will generate two files .txt (one for the harmonic and one for the closeness centrality). Those files will have the top-100 elements for the relative centrality. If we want a different value, just change the variable \u003Ccode>k\u003C/code> in the .cpp files\u003C/p>\n\u003Ch3 id=\"automatic-script-for-different-variables-of-filtering\">Automatic script for different variables of filtering\u003C/h3>\n\u003Cp>We are in the folder \u003Ccode>scripts\u003C/code>. Inside both the folders \u003Ccode>actor-graph\u003C/code> and \u003Ccode>movie-graph\u003C/code> there is a file called \u003Ccode>bench_me.sh\u003C/code>. This file will run everything automatically in loop for different values of the filtering variables. To modify this file we need to edit the file. To run it\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./bench_me.sh\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This will also save the logs in a folder called \u003Ccode>time\u003C/code>. It can be usefull to analyze the performance of the program.\u003C/p>\n\u003Chr>\n\u003Cp>Inside the folders \u003Ccode>closeness centrality\u003C/code> (for both graph), there is a python script \u003Ccode>analysis.py\u003C/code>. Put all the generated \u003Ccode>_c.txt\u003C/code> files in the folder and run it. It will return a matrix showing the discrepancy of the results while varying the variable\u003C/p>\n\u003Ch3 id=\"generating-the-interactive-graphs\">Generating the interactive graphs\u003C/h3>\n\u003Cp>First, letâ€™s move into the folder \u003Ccode>visualization\u003C/code>\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C5E478;--shiki-dark-font-style:italic\">cd\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> visualization\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>As before, we will find two folders, one for each type of graph. Choose the one that we want to with and move into that folder. Inside it we need to create a folder called \u003Ccode>data\u003C/code>\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mkdir\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> data\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>And copy inside it the files\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>Attori.txt\u003C/code>\u003C/li>\n\u003Cli>\u003Ccode>FilmFiltrati.txt\u003C/code>\u003C/li>\n\u003Cli>\u003Ccode>Relazioni.txt\u003C/code>\u003C/li>\n\u003C/ul>\n\u003Cp>Attention! If we are visualizing the actors graph, itâ€™s important to copy the file generated for it. Ideal values of \u003Ccode>min-actors\u003C/code> and \u003Ccode>votes\u003C/code> during the filtering are respectively \u003Ccode>70\u003C/code> and \u003Ccode>100000\u003C/code>. Since it has to be rendered in a web page, this values will generate graphs with about 1000 nodes. I wonâ€™t suggest to try with bigger graphs\u003C/p>",{"headings":126,"localImagePaths":143,"remoteImagePaths":144,"frontmatter":145,"imagePaths":148},[127,130,134,137,140],{"depth":32,"slug":128,"text":129},"documentation","Documentation",{"depth":131,"slug":132,"text":133},3,"downloading-and-filtering-the-data","Downloading and filtering the data",{"depth":131,"slug":135,"text":136},"running-the-program","Running the program",{"depth":131,"slug":138,"text":139},"automatic-script-for-different-variables-of-filtering","Automatic script for different variables of filtering",{"depth":131,"slug":141,"text":142},"generating-the-interactive-graphs","Generating the interactive graphs",[],[],{"author":14,"pubDatetime":146,"title":116,"slug":112,"featured":17,"draft":17,"tags":147,"ogImage":25,"description":118},["Date","2022-04-26T00:00:00.000Z"],[19],[],"small-worlds",{"id":149,"data":151,"body":156,"filePath":157,"assetImports":158,"digest":159,"rendered":160},{"author":14,"pubDatetime":152,"title":153,"featured":17,"draft":17,"tags":154,"ogImage":20,"description":155},["Date","2023-02-24T00:00:00.000Z"],"Identifying small worlds networks",[19],"Spatial Networks and small words, an experimental study on real-world datasets. Developed in Python with parallel processing support for the computation of the heaviest functions.","- Github repository: [link](https://github.com/lukefleed/small-worlds)\n\nThe present repository showcases the implementation of an experimental examination of the Small-World Networks (SWN) theory. The examination is based on real-world datasets, and the outcomes are presented through a Jupyter Notebook. As there is no corresponding written paper, the notebook serves as the sole source of information regarding the study. It encompasses all relevant theoretical background, details of the experimental design, presentation of results, and derivation of conclusions.\n\n---\n\nTime spent one the project since the beginning of 2023 (add ~20 hours for a real estimate)\n\n[![wakatime](https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce.svg)](https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce)\n\n---\n\n## Documentation\n\n### Notebook structure\n\nThe core component of the project is a Jupyter Notebook named `main.ipynb`. The notebook provides ample information to comprehend the study and its results.\n\n- The notebook starts with a theoretical background of the study, delving into the theory of random networks. The ErdÅ‘s-RÃ©nyi and Watts-Strogatz models receive particular attention, as their properties form the basis of the study.\n\n- Next, the experimental setup is presented. There is a detailed description of the datasets, along with the methodology adopted for data extraction, transformation, and loading. In this section, the graphs are constructed from the raw data obtained from the datasets.\n\n- The properties of the constructed graphs are then calculated, including the average degree, average clustering coefficient, average shortest path length, and average betweenness centrality.\n\n- The results of the study are then presented, followed by a comprehensive analysis and discussion of the outcomes.\n\n- Finally, we attempt to understand whether the networks are small-world or not by employing different approaches and evaluating the consistency of the results.\n\n### Algorithms and functions implemented\n\nIn order to maintain a clean and organized notebook, I have integrated all algorithms and functions into the `utils.py` file. This module serves as a centralized repository of functions and is imported into the notebook for use in the study.\n\nA thorough technical examination of the project requires a close examination of this file, as it holds nearly all the code utilized. Each function is accompanied by detailed documentation to ensure clear understanding and ease of use.\n\n### External scripts\n\nThe computation of the omega coefficient, a crucial measure of the small-worldness of a network, is one of the most vital functions in this project. However, its application proves to be extremely slow, rendering its usage in the notebook inadvisable. To address this issue, I have developed a separate script, named `omega_sampled_server.py`. The script is intended for execution on a server machine, capable of handling the extensive processing demands for extended periods of time, to compute the omega coefficient for a specified graph.\n\nTo run the script, execute the following command:\n\n```bash\n./omega_sampled_server.py graph --k --niter --nrand\n```\n\nWhere:\n\n- `graph` is the name of the graph\n- `k` Percentage of nodes to be remove\n- `niter` Number of rewiring operations per edge\n- `nrand` Number of random graphs to be generated\n\nFor further details run `./omega_sampled_server.py --help`\n\n#### Parallel version\n\nHowever, the computation of the omega coefficient was still very slow. To speed up the process, I developed a parallel version of the script above, called `omega_parallel_server.py`. Its development required substantial effort as the parallelization of a function utilizing a random number generator is a complex task.\n\nTo run the script, execute the following command:\n\n```bash\n./omega_sampled_parallel.py graph --k --niter --nrand --n_processes --seed\n```\n\nWhere:\n\n- `graph` is the name of the graph\n- `k` Percentage of nodes to be remove\n- `niter` Number of rewiring operations per edge\n- `nrand` Number of random graphs to be generated\n- `n_processes` is an argument that specifies the number of processes to be used\n- `seed` is the seed for the random number generator\n\nFor further details run `./omega_sampled_parallel.py --help`\n\n## Requirements\n\nThe project has been developed in Python 3.10.9, to install the required libraries run the following command:\n\n```bash\npip install -r requirements.txt\n```\n\n**NOTE**: I have no access to Windows or MacOS machines, so I cannot guarantee whether the project will function optimally on these platforms. However, I have made a concerted effort to ensure broad compatibility by implementing the project in a manner that should allow for its seamless operation on any platform. All the functions have been test on a Arch Linux machine, with an AMD Ryzen 5 2600 processor and 16GB of RAM.\n\n### Experimental\n\nThere is a directory named `experimental` in the repo that contains a number of scripts written in `C++` with the purpose of speeding up the computation of the omega coefficient. The scripts are not used in the project, but they are included for completeness. This scripts _are not documented, not tested, and not guaranteed to work_. I suggest to ignore them unless you are a C++ enthusiast that has time to waste.\n\n## References\n\nHere I report a list of the references utilized for the implementation of the project. This information is also available in the notebook.\n\n> _In no particular order_\n\n`[1]` On the evolution of random graphs, P. ErdÅ‘s, A. RÃ©nyi, _Publ. Math. Inst. Hungar. Acad. Sci._, 5, 17-61 (1960).\n\n`[2]` Complex Networks: Structure, Robustness, and Function, R. Cohen, S. Havlin, D. ben-Avraham, H. E. Stanley, _Cambridge University Press, 2009_.\n\n`[3]` Collective dynamics of 'small-world' networks, D. J. Watts and S. H. Strogatz, _Nature_, 393, 440-442, 1998.\n\n`[4]` On random graphs I, P. ErdÅ‘s and A. RÃ©nyi, _Publ. Math. Inst. Hungar. Acad. Sci._, 5, 290-297, 1960.\n\n`[5]` Generalizations of the clustering coefficient to weighted complex networks, M. E. J. Newman, _Physical Review E_, 74, 036104, 2006.\n\n`[6]` The ubiquity of small-world networks. Telesford QK, Joyce KE, Hayasaka S, Burdette JH, Laurienti PJ. _Brain Connect_. 2011;1(5):367-75\n\n`[8]` Humphries and Gurney (2008). â€œNetwork â€˜Small-World-Nessâ€™: A Quantitative Method for Determining Canonical Network Equivalenceâ€. PLoS One. 3 (4)\n\n`[9]` The brainstem reticular formation is a small-world, not scale-free, network M. D. Humphries, K. Gurney and T. J. Prescott, Proc. Roy. Soc. B 2006 273, 503-511,\n\n`[10]` Sporns, Olaf, and Jonathan D. Zwi. â€œThe small world of the cerebral cortex.â€ Neuroinformatics 2.2 (2004): 145-162.\n\n`[11]` Maslov, Sergei, and Kim Sneppen. â€œSpecificity and stability in topology of protein networks.â€ Science 296.5569 (2002): 910-913.\n\n`[13]` B. Bollob Ìas, Random Graphs, 1985. London: Academic Press\n\n`[14]` R. Cohen, K. Erez, D. ben-Avraham, and S. Havlin, Resilience of the Internet to\nrandom breakdown, Physical Review Letters 85 (2000), 4626â€“4628\n\n`[15]` Dingqi Yang, Bingqing Qu, Jie Yang, Philippe Cudre-Mauroux, Revisiting User Mobility and Social Relationships in LBSNs: A Hypergraph Embedding Approach, In Proc. of The Web Conference (WWW'19). May. 2019, San Francisco, USA.\n\n`[16]` Ulrik Brandes, A Faster Algorithm for Betweenness Centrality, Journal of Mathematical Sociology, 25(2):163-177, 2001.\\_\n\n`[17]` Error and attack tolerance of complex networks, R. Albert, Nature volume 406, pages378â€“382 (2000)","src/data/university/small-worlds.md",[25],"08aeecd32288e460",{"html":161,"metadata":162},"\u003Cul>\n\u003Cli>Github repository: \u003Ca href=\"https://github.com/lukefleed/small-worlds\">link\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>The present repository showcases the implementation of an experimental examination of the Small-World Networks (SWN) theory. The examination is based on real-world datasets, and the outcomes are presented through a Jupyter Notebook. As there is no corresponding written paper, the notebook serves as the sole source of information regarding the study. It encompasses all relevant theoretical background, details of the experimental design, presentation of results, and derivation of conclusions.\u003C/p>\n\u003Chr>\n\u003Cp>Time spent one the project since the beginning of 2023 (add ~20 hours for a real estimate)\u003C/p>\n\u003Cp>\u003Ca href=\"https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce\">\u003Cimg src=\"https://wakatime.com/badge/user/a3116382-7adb-43ba-9490-83130c4b22c5/project/3db09d02-0a29-49b1-9a39-08c74e3df4ce.svg\" alt=\"wakatime\">\u003C/a>\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"documentation\">Documentation\u003C/h2>\n\u003Ch3 id=\"notebook-structure\">Notebook structure\u003C/h3>\n\u003Cp>The core component of the project is a Jupyter Notebook named \u003Ccode>main.ipynb\u003C/code>. The notebook provides ample information to comprehend the study and its results.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>The notebook starts with a theoretical background of the study, delving into the theory of random networks. The ErdÅ‘s-RÃ©nyi and Watts-Strogatz models receive particular attention, as their properties form the basis of the study.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>Next, the experimental setup is presented. There is a detailed description of the datasets, along with the methodology adopted for data extraction, transformation, and loading. In this section, the graphs are constructed from the raw data obtained from the datasets.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The properties of the constructed graphs are then calculated, including the average degree, average clustering coefficient, average shortest path length, and average betweenness centrality.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The results of the study are then presented, followed by a comprehensive analysis and discussion of the outcomes.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>Finally, we attempt to understand whether the networks are small-world or not by employing different approaches and evaluating the consistency of the results.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"algorithms-and-functions-implemented\">Algorithms and functions implemented\u003C/h3>\n\u003Cp>In order to maintain a clean and organized notebook, I have integrated all algorithms and functions into the \u003Ccode>utils.py\u003C/code> file. This module serves as a centralized repository of functions and is imported into the notebook for use in the study.\u003C/p>\n\u003Cp>A thorough technical examination of the project requires a close examination of this file, as it holds nearly all the code utilized. Each function is accompanied by detailed documentation to ensure clear understanding and ease of use.\u003C/p>\n\u003Ch3 id=\"external-scripts\">External scripts\u003C/h3>\n\u003Cp>The computation of the omega coefficient, a crucial measure of the small-worldness of a network, is one of the most vital functions in this project. However, its application proves to be extremely slow, rendering its usage in the notebook inadvisable. To address this issue, I have developed a separate script, named \u003Ccode>omega_sampled_server.py\u003C/code>. The script is intended for execution on a server machine, capable of handling the extensive processing demands for extended periods of time, to compute the omega coefficient for a specified graph.\u003C/p>\n\u003Cp>To run the script, execute the following command:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./omega_sampled_server.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --k\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --niter\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --nrand\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>graph\u003C/code> is the name of the graph\u003C/li>\n\u003Cli>\u003Ccode>k\u003C/code> Percentage of nodes to be remove\u003C/li>\n\u003Cli>\u003Ccode>niter\u003C/code> Number of rewiring operations per edge\u003C/li>\n\u003Cli>\u003Ccode>nrand\u003C/code> Number of random graphs to be generated\u003C/li>\n\u003C/ul>\n\u003Cp>For further details run \u003Ccode>./omega_sampled_server.py --help\u003C/code>\u003C/p>\n\u003Ch4 id=\"parallel-version\">Parallel version\u003C/h4>\n\u003Cp>However, the computation of the omega coefficient was still very slow. To speed up the process, I developed a parallel version of the script above, called \u003Ccode>omega_parallel_server.py\u003C/code>. Its development required substantial effort as the parallelization of a function utilizing a random number generator is a complex task.\u003C/p>\n\u003Cp>To run the script, execute the following command:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">./omega_sampled_parallel.py\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --k\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --niter\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --nrand\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --n_processes\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> --seed\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>graph\u003C/code> is the name of the graph\u003C/li>\n\u003Cli>\u003Ccode>k\u003C/code> Percentage of nodes to be remove\u003C/li>\n\u003Cli>\u003Ccode>niter\u003C/code> Number of rewiring operations per edge\u003C/li>\n\u003Cli>\u003Ccode>nrand\u003C/code> Number of random graphs to be generated\u003C/li>\n\u003Cli>\u003Ccode>n_processes\u003C/code> is an argument that specifies the number of processes to be used\u003C/li>\n\u003Cli>\u003Ccode>seed\u003C/code> is the seed for the random number generator\u003C/li>\n\u003C/ul>\n\u003Cp>For further details run \u003Ccode>./omega_sampled_parallel.py --help\u003C/code>\u003C/p>\n\u003Ch2 id=\"requirements\">Requirements\u003C/h2>\n\u003Cp>The project has been developed in Python 3.10.9, to install the required libraries run the following command:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">pip\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> install\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#82AAFF\"> -r\u003C/span>\u003Cspan style=\"--shiki-light:#2B5581;--shiki-dark:#ECC48D\"> requirements.txt\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>NOTE\u003C/strong>: I have no access to Windows or MacOS machines, so I cannot guarantee whether the project will function optimally on these platforms. However, I have made a concerted effort to ensure broad compatibility by implementing the project in a manner that should allow for its seamless operation on any platform. All the functions have been test on a Arch Linux machine, with an AMD Ryzen 5 2600 processor and 16GB of RAM.\u003C/p>\n\u003Ch3 id=\"experimental\">Experimental\u003C/h3>\n\u003Cp>There is a directory named \u003Ccode>experimental\u003C/code> in the repo that contains a number of scripts written in \u003Ccode>C++\u003C/code> with the purpose of speeding up the computation of the omega coefficient. The scripts are not used in the project, but they are included for completeness. This scripts \u003Cem>are not documented, not tested, and not guaranteed to work\u003C/em>. I suggest to ignore them unless you are a C++ enthusiast that has time to waste.\u003C/p>\n\u003Ch2 id=\"references\">References\u003C/h2>\n\u003Cp>Here I report a list of the references utilized for the implementation of the project. This information is also available in the notebook.\u003C/p>\n\u003Cblockquote>\n\u003Cp>\u003Cem>In no particular order\u003C/em>\u003C/p>\n\u003C/blockquote>\n\u003Cp>\u003Ccode>[1]\u003C/code> On the evolution of random graphs, P. ErdÅ‘s, A. RÃ©nyi, \u003Cem>Publ. Math. Inst. Hungar. Acad. Sci.\u003C/em>, 5, 17-61 (1960).\u003C/p>\n\u003Cp>\u003Ccode>[2]\u003C/code> Complex Networks: Structure, Robustness, and Function, R. Cohen, S. Havlin, D. ben-Avraham, H. E. Stanley, \u003Cem>Cambridge University Press, 2009\u003C/em>.\u003C/p>\n\u003Cp>\u003Ccode>[3]\u003C/code> Collective dynamics of â€˜small-worldâ€™ networks, D. J. Watts and S. H. Strogatz, \u003Cem>Nature\u003C/em>, 393, 440-442, 1998.\u003C/p>\n\u003Cp>\u003Ccode>[4]\u003C/code> On random graphs I, P. ErdÅ‘s and A. RÃ©nyi, \u003Cem>Publ. Math. Inst. Hungar. Acad. Sci.\u003C/em>, 5, 290-297, 1960.\u003C/p>\n\u003Cp>\u003Ccode>[5]\u003C/code> Generalizations of the clustering coefficient to weighted complex networks, M. E. J. Newman, \u003Cem>Physical Review E\u003C/em>, 74, 036104, 2006.\u003C/p>\n\u003Cp>\u003Ccode>[6]\u003C/code> The ubiquity of small-world networks. Telesford QK, Joyce KE, Hayasaka S, Burdette JH, Laurienti PJ. \u003Cem>Brain Connect\u003C/em>. 2011;1(5):367-75\u003C/p>\n\u003Cp>\u003Ccode>[8]\u003C/code> Humphries and Gurney (2008). â€œNetwork â€˜Small-World-Nessâ€™: A Quantitative Method for Determining Canonical Network Equivalenceâ€. PLoS One. 3 (4)\u003C/p>\n\u003Cp>\u003Ccode>[9]\u003C/code> The brainstem reticular formation is a small-world, not scale-free, network M. D. Humphries, K. Gurney and T. J. Prescott, Proc. Roy. Soc. B 2006 273, 503-511,\u003C/p>\n\u003Cp>\u003Ccode>[10]\u003C/code> Sporns, Olaf, and Jonathan D. Zwi. â€œThe small world of the cerebral cortex.â€ Neuroinformatics 2.2 (2004): 145-162.\u003C/p>\n\u003Cp>\u003Ccode>[11]\u003C/code> Maslov, Sergei, and Kim Sneppen. â€œSpecificity and stability in topology of protein networks.â€ Science 296.5569 (2002): 910-913.\u003C/p>\n\u003Cp>\u003Ccode>[13]\u003C/code> B. Bollob Ìas, Random Graphs, 1985. London: Academic Press\u003C/p>\n\u003Cp>\u003Ccode>[14]\u003C/code> R. Cohen, K. Erez, D. ben-Avraham, and S. Havlin, Resilience of the Internet to\nrandom breakdown, Physical Review Letters 85 (2000), 4626â€“4628\u003C/p>\n\u003Cp>\u003Ccode>[15]\u003C/code> Dingqi Yang, Bingqing Qu, Jie Yang, Philippe Cudre-Mauroux, Revisiting User Mobility and Social Relationships in LBSNs: A Hypergraph Embedding Approach, In Proc. of The Web Conference (WWWâ€™19). May. 2019, San Francisco, USA.\u003C/p>\n\u003Cp>\u003Ccode>[16]\u003C/code> Ulrik Brandes, A Faster Algorithm for Betweenness Centrality, Journal of Mathematical Sociology, 25(2):163-177, 2001._\u003C/p>\n\u003Cp>\u003Ccode>[17]\u003C/code> Error and attack tolerance of complex networks, R. Albert, Nature volume 406, pages378â€“382 (2000)\u003C/p>",{"headings":163,"localImagePaths":185,"remoteImagePaths":186,"frontmatter":187,"imagePaths":190},[164,165,168,171,174,178,181,184],{"depth":32,"slug":128,"text":129},{"depth":131,"slug":166,"text":167},"notebook-structure","Notebook structure",{"depth":131,"slug":169,"text":170},"algorithms-and-functions-implemented","Algorithms and functions implemented",{"depth":131,"slug":172,"text":173},"external-scripts","External scripts",{"depth":175,"slug":176,"text":177},4,"parallel-version","Parallel version",{"depth":32,"slug":179,"text":180},"requirements","Requirements",{"depth":131,"slug":182,"text":183},"experimental","Experimental",{"depth":32,"slug":104,"text":105},[],[],{"author":14,"pubDatetime":188,"title":153,"slug":149,"featured":17,"draft":17,"tags":189,"ogImage":25,"description":155},["Date","2023-02-24T00:00:00.000Z"],[19],[],"blog",["Map",193,194,294,295,337,338,540,541,628,629,786,787,915,916],"cache-friendly-low-memory-lanczos",{"id":193,"data":195,"body":202,"filePath":203,"digest":204,"rendered":205},{"author":14,"pubDatetime":196,"title":197,"featured":198,"draft":17,"tags":199,"description":201},["Date","2025-11-11T00:00:00.000Z"],"Cache-Friendly, Low-Memory Lanczos Algorithm in Rust",true,[200,69],"Rust","How a bit of algorithm engineering and low-level details can alter what seems like a straightforward trade-off on a blackboard.","The standard Lanczos method for computing matrix functions has a brutal memory requirement: storing an $n \\times k$ basis matrix that grows with every iteration. For a $500.000$-variable problem needing $1000$ iterations, that's roughly 4 GB just for the basis.\n\nIn this post, we will explore one of the most straightforward solutions to this problem: a two-pass variant of the Lanczos algorithm that only requires $O(n)$ memory at the cost of doubling the number of matrix-vector products. The surprising part is that when implemented carefully, the two-pass version isn't just memory-efficientâ€”it can be faster for certain problems. We will dig into why.\n\n- All code is available on GitHub: [two-pass-lanczos](https://github.com/lukefleed/two-pass-lanczos)\n- A more complete report, with references and more experiments: [report.pdf](https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf)\n\nYou can discuss this post on [Hacker News](https://news.ycombinator.com/item?id=45889891), [Lobsters](https://lobste.rs/s/sag4i3/cache_friendly_low_memory_lanczos) and [Reddit](https://www.reddit.com/r/rust/comments/1ouf5hp/cachefriendly_lowmemory_lanczos_algorithm_in_rust/).\n\n\n---\n\n## Table of Contents\n\n\n# Computing Matrix Functions\n\nLet's consider the problem of computing the action of matrix functions on a vector:\n\n$$\n\\mathbf{x} = f(\\mathbf{A})\\mathbf{b}\n$$\n\nwhere $\\mathbf{A}$ is a large sparse Hermitian matrix and $f$ is a matrix function defined on the spectrum of $\\mathbf{A}$. This is a problem that appears pretty often in scientific computing: solving linear systems corresponds to $f(z) = z^{-1}$, exponential integrators for PDEs use $f(z) = \\exp(tz)$, and many other problems require functions like $f(z) = z^{-1/2}$ or $f(z) = \\text{sign}(z)$.\n\nIndeed, there are a lot problems with computing $f(\\mathbf{A})$ directly. First of all, even if $\\mathbf{A}$ is sparse, $f(\\mathbf{A})$ is generally dense. Storing it explicitly is out of the question for large problems. Even if we could store it, computing it directly would require algorithms like the Schur-Parlett method that scale as $O(n^3)$, which is impractical for large $n$.\n\nHowever we know that given any matrix function $f$ defined on the spectrum of $\\mathbf{A}$, we can express $f(\\mathbf{A})$ as a polynomial in $\\mathbf{A}$ of degree at most $n$ (the size of the matrix) such that $f(\\mathbf{A}) = p_{n}(\\mathbf{A})$ (this is a consequence of the Cayley-Hamilton theorem). This polynomial interpolates $f$ and its derivatives in the Hermitian sense at the eigenvalues of $\\mathbf{A}$.\n\nThis gives us a good and a bad news: the good news is that, well, we can express $f(\\mathbf{A})$ as a polynomial in $\\mathbf{A}$. The bad news is that the degree of this polynomial can be as high as $n$, which is huge for large problems. The idea is then to find a low-degree polynomial approximation to $f$ that is _good enough_ for our purposes. If we can find a polynomial $p_k$ of degree $k \\ll n$ such that $p_k(\\mathbf{A}) \\approx f(\\mathbf{A})$, then we can approximate the solution as:\n\n$$\nf(\\mathbf{A})\\mathbf{b} \\approx p_k(\\mathbf{A})\\mathbf{b} = \\sum_{i=0}^k c_i \\mathbf{A}^i \\mathbf{b}\n$$\n\nThis polynomial only involves vectors within a specific subspace.\n\n## Krylov Projection\n\nWe can notice that $p_k(\\mathbf{A})\\mathbf{b}$ only depends on vectors in the Krylov subspace of order $k$\n\n$$\n\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b}) = \\text{span}\\{\\mathbf{b}, \\mathbf{Ab}, \\mathbf{A}^2\\mathbf{b}, \\ldots, \\mathbf{A}^{k-1}\\mathbf{b}\\}\n$$\n\nThis is fortunate: we can compute an approximate solution by staying within this space, which only requires repeated matrix-vector products with $\\mathbf{A}$. For large sparse matrices, that's the only operation we can do efficiently anyway.\n\n> We don't need to construct $\\mathbf{A}^j$ explicitly. We compute iteratively: $\\mathbf{A}(\\mathbf{A}^{j-1}\\mathbf{b})$.\n\nBut there's a problem: the raw vectors $\\{\\mathbf{A}^j\\mathbf{b}\\}$ form a terrible basis. They quickly become nearly parallel, making any computation numerically unstable. We need an orthonormal basis.\n\n### Building an Orthonormal Basis\n\nThe standard method is the Arnoldi process, which is Gram-Schmidt applied to Krylov subspaces. We start by normalizing $\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2$. Then, iteratively:\n\n1. Compute a new candidate: $\\mathbf{w}_j = \\mathbf{A}\\mathbf{v}_j$\n2. Orthogonalize against all existing basis vectors:\n\n$$\n\\tilde{\\mathbf{v}}_j = \\mathbf{w}_j - \\sum_{i=1}^j (\\mathbf{v}_i^H \\mathbf{w}_j) \\mathbf{v}_i\n$$\n\n3. Normalize: $\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_j / \\|\\tilde{\\mathbf{v}}_j\\|_2$\n\nThe coefficients $h_{ij} = \\mathbf{v}_i^H \\mathbf{w}_j$ become entries of a projected matrix. After $k$ iterations, we have:\n\n- $\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]$: an orthonormal basis for $\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b})$\n- $\\mathbf{H}_k$: an upper Hessenberg matrix representing the projection of $\\mathbf{A}$ onto this subspace\n\nWe can express this relationship with the Arnoldi decomposition:\n\n$$\n\\mathbf{A}\\mathbf{V}_k = \\mathbf{V}_k \\mathbf{H}_k + h_{k+1,k} \\mathbf{v}_{k+1} \\mathbf{e}_k^T\n$$\n\n### Solving in the Reduced Space\n\nNow we approximate our original problem by solving it in the small $k$-dimensional space. Using the Full Orthogonal Method (FOM), we enforce that the residual is orthogonal to\nthe Krylov subspace. This gives:\n\n$$\n\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\n$$\n\nwhere $\\mathbf{y}_k$ is computed as:\n\n$$\n\\mathbf{y}_k = f(\\mathbf{H}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\n$$\n\nThe heavy lifting is now on computing $f(\\mathbf{H}_k)$, a small $k \\times k$ matrix.\nSince $k \\ll n$, we can afford direct methods like Schur-Parlett ($O(k^3)$).\n\n> For $f(z) = z^{-1}$ (linear systems), this reduces to solving $\\mathbf{H}_k \\mathbf{y}_k = \\mathbf{e}_1 \\|\\mathbf{b}\\|_2$ with LU decomposition.\n\n\n# The Lanczos Algorithm\n\nWhen $\\mathbf{A}$ is Hermitian (or symmetric in the real case), the general Arnoldi\nprocess simplifies dramatically. We can prove that $\\mathbf{H}_k = \\mathbf{V}_k^H \\mathbf{A} \\mathbf{V}_k$ must also be Hermitian. A matrix that is both upper Hessenberg *and* Hermitian must be real, symmetric, and tridiagonal. This is a _huge_ simplification.\n\nIn the literature, this projected matrix is denoted $\\mathbf{T}_k$ to highlight its\ntridiagonal structure:\n\n$$\n\\mathbf{T}_k = \\begin{pmatrix}\n\\alpha_1 & \\beta_1 & & \\\\\n\\beta_1 & \\alpha_2 & \\beta_2 & \\\\\n& \\beta_2 & \\ddots & \\ddots \\\\\n& & \\ddots & \\alpha_k\n\\end{pmatrix}\n$$\n\nwhere $\\alpha_j \\in \\mathbb{R}$ are the diagonal elements and $\\beta_j \\in \\mathbb{R}$ are the off-diagonals (subdiagonals from the orthogonalization).\n\n## Three-Term Recurrence\n\nThis tridiagonal structure leads to a beautiful simplification. To build the next basis\nvector $\\mathbf{v}_{j+1}$, we don't need the entire history of vectors. We only need\nthe two previous ones. Since $\\mathbf{A}$ is Hermitian, this guarantees that\nany new vector is _automatically_ orthogonal to all earlier vectors (beyond the previous two). So we can skip the full orthogonalization and use a simple three-term recurrence:\n\n$$\n\\mathbf{A}\\mathbf{v}_j = \\beta_{j-1}\\mathbf{v}_{j-1} + \\alpha_j \\mathbf{v}_j + \\beta_j \\mathbf{v}_{j+1}\n$$\n\nRearranging gives us an algorithm to compute $\\mathbf{v}_{j+1}$ directly:\n\n1. Compute the candidate: $w_{j+1} = \\mathbf{A}\\mathbf{v}_j$\n2. Extract the diagonal coefficient: $\\alpha_j = \\mathbf{v}_j^H w_{j+1}$\n3. Orthogonalize against the two previous vectors:\n\n$$\n\\tilde{\\mathbf{v}}_{j+1} = w_{j+1} - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\n$$\n\n4. Normalize: $\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2$ and $\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j$\n\nThis is known as the Lanczos algorithm. It's more efficient than Arnoldi because each iteration only orthogonalizes against two previous vectors instead of all prior ones.\n\n## Reconstructing the Solution\n\nAfter $k$ iterations, we end up with the tridiagonal matrix $\\mathbf{T}_k$ and all $k$ basis vectors $\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]$. We can then reconstruct the approximate solution as:\n\n$$\n\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\n$$\n\nwhere $\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2$ is solved from the small tridiagonal matrix.\n\nThere is a timing problem however: we cannot compute the coefficients $\\mathbf{y}_k$\nuntil all $k$ iterations are complete. The full matrix $\\mathbf{T}_k$ is only available\nat the end, so we must store every basis vector $\\mathbf{v}_j$ along the way, leading to a memory cost of $O(nk)$.\n\nSo we're left with a choice: whether we store all the basis vectors and solve the problem in $k$ passes, or find a way to avoid storing them. There is a middle ground.\n\n> There are also techniques to compress the basis vectors, have a look [here](https://arxiv.org/abs/2403.04390)\n\n\n# Two-Pass Algorithm\n\nHere's where we break the timing deadlock. The insight that we don't actually need to store the basis vectors if we can afford to compute them twice\n\nThink about what we have after the first pass. We've computed all the $\\alpha_j$ and $\\beta_j$ coefficients that compose the entire tridiagonal matrix $\\mathbf{T}_k$. These numbers are small compared to the full basis. What if we kept only these scalars, discarded all the vectors, and then replayed the Lanczos recurrence a second time? We'd regenerate the same basis, and this time we'd use it to build the solution.\n\nThis comes at a cost. We run Lanczos twice, so we pay for $2k$ matrix-vector products instead of $k$. But we only ever store a constant number of vectors in memory, no $O(nk)$ basis matrix. The memory complexity drops to $O(n)$.\n\nIt sounds like a bad trade at first. But as we'll see later, the cache behavior of this\ntwo-pass approach can actually make it as fast (or even faster) on real hardware if well optimized.\n\n## First Pass: Compute the Projected Problem\n\nWe initialize $\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2$ and set $\\beta_0 = 0$, $\\mathbf{v}_0 = \\mathbf{0}$.Then we run the standard Lanczos recurrence:\n\n$$\nw_j = \\mathbf{A}\\mathbf{v}_j\n$$\n\n$$\n\\alpha_j = \\mathbf{v}_j^H w_j\n$$\n\n$$\n\\tilde{\\mathbf{v}}_{j+1} = w_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\n$$\n\n$$\n\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2, \\quad \\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j\n$$\n\nAt each step, we record $\\alpha_j$ and $\\beta_j$. But we *do not* store $\\mathbf{v}_j$.\nInstead, we discard it immediately after computing $\\mathbf{v}_{j+1}$. In this way we only keep in memory at most just three vectors at any time ($\\mathbf{v}_{j-1}$, $\\mathbf{v}_j$, and the working vector $w_j$).\n\nAfter $k$ iterations, we have the full set $\\{\\alpha_1, \\beta_1, \\ldots, \\alpha_k, \\beta_k\\}$. These $O(k)$ scalars define the tridiagonal matrix $\\mathbf{T}_k$. We can now solve:\n\n$$\n\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\n$$\n\nThis is the solution in the reduced space. Now that we have the coefficients we need to build $\\mathbf{x}_k$.\n\n## Second Pass: Reconstruct and Accumulate\n\nWith $\\mathbf{y}_k$ in memory, we replay the Lanczos recurrence _exactly as before_. We start with the same initialization ($\\mathbf{v}_1$, $\\beta_0$, $\\mathbf{v}_0$) and apply the same sequence of operations, using the stored scalars $\\alpha_j$ and $\\beta_j$ to reconstruct each basis vector on demand. We can write some rust-like _pseudocode_ for this second pass to get a feel for it:\n\n```rust\nlet mut x_k = vec![0.0; n];\nlet mut v_prev = vec![0.0; n];\nlet mut v_curr = b.clone() / b_norm;\n\nfor j in 1..=k {\n    let w = A @ v_curr;  // Matrix-vector product\n\n    // We don't recompute alpha/beta; we already have them from pass 1\n    let alpha_j = alphas[j - 1];\n    let beta_prev = j > 1 ? betas[j - 2] : 0.0;\n\n    // Accumulate the solution\n    x_k += y_k[j - 1] * v_curr;\n\n    // Regenerate the next basis vector for the *next* iteration\n    let v_next = (w - alpha_j * v_curr - beta_prev * v_prev) / betas[j - 1];\n\n    // Slide the window forward\n    v_prev = v_curr;\n    v_curr = v_next;\n}\n```\n\nThis loop regenerates each $\\mathbf{v}_j$ on demand and immediately uses it to update the solution.\nOnce we've accumulated $(\\mathbf{y}_k)_j \\mathbf{v}_j$ into $\\mathbf{x}_k$, we discard the vector. We never store the full basis.\n\n### A Subtle Numerical Point\n\nThere is one detail worth noting: floating-point arithmetic is deterministic. When we replay the Lanczos recurrence in the second pass with the exact same inputs and the exact same order of operations, we get bitwise-identical vectors. The $\\mathbf{v}_j$ regenerated in pass 2 are identical to the ones computed in pass 1.\n\nHowever, the order in which we accumulate the solution differs. In a standard Lanczos,\n$\\mathbf{x}_k$ is built as a single matrix-vector product: $\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k$ (a `gemv` call in BLAS). In the two-pass method, it's built as a loop of scaled vector additions (a series of `axpy` calls). These operations accumulate rounding error differently, so the final solution differs slightly, typically by machine epsilon. This rarely matters in practice, and convergence is unaffected.\n\n# Implementation\n\nBuilding this in Rust forces us to think concretely about where data lives and how it flows through the cache hierarchy. We need to control memory layout, decide when allocations happen, and choose abstractions that cost us nothing at runtime.\n\nFor linear algebra, we reach for [`faer`](https://github.com/sarah-ek/faer-rs). Three design choices in this library matter for what we're building:\n\n- **Stack allocation via `MemStack`:** Pre-allocated scratch space that lives for the entire computation. The hot path becomes allocation-free.\n- **Matrix-free operators:** The `LinOp` trait defines an operator by its action (`apply`) without materializing a matrix. For large sparse problems, this is the only viable approach.\n- **SIMD-friendly loops:** The `zip!` macro generates code that compiles to packed instructions.\n\n## Recurrence Step\n\nOur starting point is the Lanczos three-term recurrence that we derived earlier:\n\n$$\n\\beta_j \\mathbf{v}_{j+1} = \\mathbf{A}\\mathbf{v}_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\n$$\n\nWe can translate this into a recurrence step function. The signature looks like this:\n\n```rust\nfn lanczos_recurrence_step\u003CT: ComplexField, O: LinOp\u003CT>>(\n    operator: &O,\n    mut w: MatMut\u003C'_, T>,\n    v_curr: MatRef\u003C'_, T>,\n    v_prev: MatRef\u003C'_, T>,\n    beta_prev: T::Real,\n    stack: &mut MemStack,\n) -> (T::Real, Option\u003CT::Real>)\n```\n\nThe function is generic over the field type `T` (`f64`, `c64`, etc.) and the operator type `O`. It operates on matrix views (`MatMut` and `MatRef`) to avoid unnecessary data copies. The return type gives us the diagonal element $\\alpha_j$ and, _if no breakdown occurs_, the off-diagonal $\\beta_j$.\n\nNow we can implement the body by following the math. The first step is the most expensive:\n\n```rust\n// 1. Apply operator: w = A * v_curr\noperator.apply(w.rb_mut(), v_curr, Par::Seq, stack);\n```\n\nThe matrix-vector product dominates the computational cost. Everything else is secondary.\n\nNext, we orthogonalize against $\\mathbf{v}_{j-1}$. This is where we benefit from `faer`'s design. The `zip!` macro fuses this operation into a single loop that the compiler vectorizes into SIMD instructions.\n\n```rust\n// 2. Orthogonalize against v_{j-1}: w -= Î²_{j-1} * v_{j-1}\nlet beta_prev_scaled = T::from_real_impl(&beta_prev);\nzip!(w.rb_mut(), v_prev).for_each(|unzip!(w_i, v_prev_i)| {\n    *w_i = sub(w_i, &mul(&beta_prev_scaled, v_prev_i));\n});\n```\n\nWith `w` partially orthogonalized, we can compute the diagonal coefficient via an inner product. Since $\\mathbf{A}$ is Hermitian, $\\alpha_j$ is guaranteed real.\n\n```rust\n// 3. Compute Î±_j = v_j^H * w\nlet alpha = T::real_part_impl(&(v_curr.adjoint() * w.rb())[(0, 0)]);\n```\n\nWe complete the orthogonalization against $\\mathbf{v}_j$ with another `zip!` loop.\n\n```rust\n// 4. Orthogonalize against v_j: w -= Î±_j * v_j\nlet alpha_scaled = T::from_real_impl(&alpha);\nzip!(w.rb_mut(), v_curr).for_each(|unzip!(w_i, v_curr_i)| {\n    *w_i = sub(w_i, &mul(&alpha_scaled, v_curr_i));\n});\n```\n\nNow `w` holds the unnormalized next basis vector. We compute its norm to get $\\beta_j$. If this norm is numerically zero, the Krylov subspace is invariant, the iteration has reached its natural stopping point. This is called breakdown.\n\n```rust\n// 5. Compute Î²_j = ||w||_2 and check for breakdown\nlet beta = w.rb().norm_l2();\nlet tolerance = breakdown_tolerance::\u003CT::Real>();\n\nif beta \u003C= tolerance {\n    (alpha, None)\n} else {\n    (alpha, Some(beta))\n}\n```\n\nThe function returns `None` for $\\beta_j$ when breakdown occurs, signaling to the caller that no further iterations should proceed.\n\n## An Iterator for State Management\n\nThe recurrence step is a pure function, but calling it in a loop is both inefficient and awkward. We'd need to manually pass vectors in and out of each iteration. More critically, we'd create copies when we should be reusing memory.\n\nThe iterator pattern solves this. We create a struct that encapsulates the state:\n\n```rust\nstruct LanczosIteration\u003C'a, T: ComplexField, O: LinOp\u003CT>> {\n    operator: &'a O,\n    v_prev: Mat\u003CT>,       // v_{j-1}\n    v_curr: Mat\u003CT>,       // v_j\n    work: Mat\u003CT>,         // Workspace for the next vector\n    beta_prev: T::Real,   // Î²_{j-1}\n    // ... iteration counters\n}\n```\n\nThe main design choice here is that vectors are **owned** (`Mat\u003CT>`), not borrowed. This enables an optimization in the `next_step` method. After computing the next vector and normalizing it into `work`, we cycle the state without allocating or copying:\n\n```rust\n// Inside next_step, after normalization...\ncore::mem::swap(&mut self.v_prev, &mut self.v_curr);\ncore::mem::swap(&mut self.v_curr, &mut self.work);\n```\n\nOn x86-64, swapping two `Mat\u003CT>` structures (fat pointers) compiles to three `mov` instructions. The pointers change, but no vector data moves. After the swap, `v_prev` points to what `v_curr` held, `v_curr` points to `work`'s allocation, and `work` points to the old `v_prev` data. In the next iteration, `work` gets reused.\n\nWe keep exactly three n-dimensional vectors live in memory. The same allocations cycle through the computation, staying hot in L1 cache. This is the core reason the two-pass method can be faster than expected, the working set never leaves cache.\n\n## First Pass: Computing the Decomposition\n\nThe first pass runs the Lanczos iteration and collects the coefficients $\\{\\alpha_j, \\beta_j\\}$. Basis vectors are discarded after each step.\n\n```rust\npub fn lanczos_pass_one\u003CT: ComplexField>(\n    operator: &impl LinOp\u003CT>,\n    b: MatRef\u003C'_, T>,\n    k: usize,\n    stack: &mut MemStack,\n) -> Result\u003CLanczosDecomposition\u003CT::Real>, LanczosError> {\n    // ...\n}\n```\n\nWe allocate vectors for the coefficients with a capacity hint to avoid reallocations:\n\n```rust\nlet mut alphas = Vec::with_capacity(k);\nlet mut betas = Vec::with_capacity(k - 1);\n```\n\nThen we construct the iterator. This allocates the three work vectors once. After this point, the hot path is allocation-free:\n\n```rust\nlet mut lanczos_iter = LanczosIteration::new(operator, b, k, b_norm)?;\n\nfor i in 0..k {\n    if let Some(step) = lanczos_iter.next_step(stack) {\n        alphas.push(step.alpha);\n        steps_taken += 1;\n\n        let tolerance = breakdown_tolerance::\u003CT::Real>();\n        if step.beta \u003C= tolerance {\n            break;\n        }\n\n        if i \u003C k - 1 {\n            betas.push(step.beta);\n        }\n    } else {\n        break;\n    }\n}\n```\n\nThe check for breakdown stops the iteration when the residual becomes numerically zero. This means we've found an invariant subspace and there's no value in continuing.\n\nAt the end, we collect the scalars into a `LanczosDecomposition` struct. The memory footprint throughout this pass is constant: three n-dimensional vectors plus two small arrays that grow to at most $k$ elements.\n\n## Second Pass: Reconstructing the Solution\n\nNow we face a different problem. We have the $\\{\\alpha_j, \\beta_j\\}$ coefficients from the first pass and the coefficient vector $\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2$ from solving the projected problem. We need to reconstruct the solution:\n\n$$\n\\mathbf{x}_k = \\sum_{j=1}^k (\\mathbf{y}_k)_j \\mathbf{v}_j\n$$\n\nwithout storing the full basis matrix $\\mathbf{V}_k$.\n\nThe recurrence step in this pass is structurally similar to the first pass, but with a key difference: we no longer compute inner products or norms. We already know the coefficients, so the step becomes pure reconstruction.\n\n```rust\nfn lanczos_reconstruction_step\u003CT: ComplexField, O: LinOp\u003CT>>(\n    operator: &O,\n    mut w: MatMut\u003C'_, T>,\n    v_curr: MatRef\u003C'_, T>,\n    v_prev: MatRef\u003C'_, T>,\n    alpha_j: T::Real,\n    beta_prev: T::Real,\n    stack: &mut MemStack,\n) {\n    // Apply operator\n    operator.apply(w.rb_mut(), v_curr, Par::Seq, stack);\n\n    // Orthogonalize using stored Î±_j and Î²_{j-1}\n    let beta_prev_scaled = T::from_real_impl(&beta_prev);\n    zip!(w.rb_mut(), v_prev).for_each(|unzip!(w_i, v_prev_i)| {\n        *w_i = sub(w_i, &mul(&beta_prev_scaled, v_prev_i));\n    });\n\n    let alpha_scaled = T::from_real_impl(&alpha_j);\n    zip!(w.rb_mut(), v_curr).for_each(|unzip!(w_i, v_curr_i)| {\n        *w_i = sub(w_i, &mul(&alpha_scaled, v_curr_i));\n    });\n}\n```\n\nThis is cheaper than the first-pass recurrence. We've eliminated the inner products that computed $\\alpha_j$ and the norm calculation for $\\beta_j$. What remains is pure orthogonalization and the operator application.\n\n`lanczos_pass_two` implements this reconstruction. We initialize the three work vectors and the solution accumulator:\n\n```rust\npub fn lanczos_pass_two\u003CT: ComplexField>(\n    operator: &impl LinOp\u003CT>,\n    b: MatRef\u003C'_, T>,\n    decomposition: &LanczosDecomposition\u003CT::Real>,\n    y_k: MatRef\u003C'_, T>,\n    stack: &mut MemStack,\n) -> Result\u003CMat\u003CT>, LanczosError> {\n    let mut v_prev = Mat::\u003CT>::zeros(b.nrows(), 1);\n    let inv_norm = T::from_real_impl(&T::Real::recip_impl(&decomposition.b_norm));\n    let mut v_curr = b * Scale(inv_norm);  // v_1\n\n    let mut work = Mat::\u003CT>::zeros(b.nrows(), 1);\n\n    // Initialize solution with first component\n    let mut x_k = &v_curr * Scale(T::copy_impl(&y_k[(0, 0)]));\n```\n\nWe build the solution incrementally by starting with the first basis vector scaled by its coefficient. The main loop then regenerates each subsequent vector: we regenerate each subsequent basis vector, normalize it using the stored $\\beta_j$, and immediately accumulate its contribution:\n\n```rust\nfor j in 0..decomposition.steps_taken - 1 {\n    let alpha_j = T::Real::copy_impl(&decomposition.alphas[j]);\n    let beta_j = T::Real::copy_impl(&decomposition.betas[j]);\n    let beta_prev = if j == 0 {\n        T::Real::zero_impl()\n    } else {\n        T::Real::copy_impl(&decomposition.betas[j - 1])\n    };\n\n    // 1. Regenerate the unnormalized next vector\n    lanczos_reconstruction_step(\n        operator,\n        work.as_mut(),\n        v_curr.as_ref(),\n        v_prev.as_ref(),\n        alpha_j,\n        beta_prev,\n        stack,\n    );\n\n    // 2. Normalize using stored Î²_j\n    let inv_beta = T::from_real_impl(&T::Real::recip_impl(&beta_j));\n    zip!(work.as_mut()).for_each(|unzip!(w_i)| {\n        *w_i = mul(w_i, &inv_beta);\n    });\n\n    // 3. Accumulate: x_k += y_{j+1} * v_{j+1}\n    let coeff = T::copy_impl(&y_k[(j + 1, 0)]);\n    zip!(x_k.as_mut(), work.as_ref()).for_each(|unzip!(x_i, v_i)| {\n        *x_i = add(x_i, &mul(&coeff, v_i));\n    });\n\n    // 4. Cycle vectors for the next iteration\n    core::mem::swap(&mut v_prev, &mut v_curr);\n    core::mem::swap(&mut v_curr, &mut work);\n}\n```\n\nThe accumulation `x_k += y_{j+1} * v_{j+1}` is implemented as a fused multiply-add in the `zip!` loop. On hardware with FMA support, this becomes a single instruction per element, not three separate operations.\n\nNote that we accumulate the solution incrementally. After each iteration, `x_k` contains a partial result. We cycle through the same three vectors (`v_prev`, `v_curr`, `work`), keeping the working set small and resident in L1 cache.\n\nCompare this to the standard method's final reconstruction step: $\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k$. This is a dense matrix-vector product where $\\mathbf{V}_k$ is $n \\times k$. When $n$ and $k$ are both large, this matrix no longer fits in cache. The CPU must stream it from main memory, paying the cost of memory latency. Each element requires a load, multiply, and accumulate, but the load operations dominateâ€”the CPU stalls waiting for data.\n\nIn our two-pass reconstruction, the operator `$\\mathbf{A}$` is applied $k$ times, but against vectors that stay in cache. The memory bandwidth is spent on reading the sparse structure of $\\mathbf{A}$ and the vector elements, not on scanning a dense $n \\times k$ matrix.\n\nThis is the reason the two-pass method can be faster on real hardware despite performing twice as many matrix-vector products. The cache behavior of the reconstruction phase overwhelms the savings of storing the basis.\n\n## The Public API\n\nWe can wrap the two passes into a single entry point:\n\n```rust\npub fn lanczos_two_pass\u003CT, O, F>(\n    operator: &O,\n    b: MatRef\u003C'_, T>,\n    k: usize,\n    stack: &mut MemStack,\n    mut f_tk_solver: F,\n) -> Result\u003CMat\u003CT>, LanczosError>\nwhere\n    T: ComplexField,\n    O: LinOp\u003CT>,\n    F: FnMut(&[T::Real], &[T::Real]) -> Result\u003CMat\u003CT>, anyhow::Error>,\n{\n    // First pass: compute T_k coefficients\n    let decomposition = lanczos_pass_one(operator, b, k, stack)?;\n\n    if decomposition.steps_taken == 0 {\n        return Ok(Mat::zeros(b.nrows(), 1));\n    }\n\n    // Solve projected problem: y_k' = f(T_k) * e_1\n    let y_k_prime = f_tk_solver(&decomposition.alphas, &decomposition.betas)?;\n\n    // Scale by ||b||\n    let y_k = &y_k_prime * Scale(T::from_real_impl(&decomposition.b_norm));\n\n    // Second pass: reconstruct solution\n    lanczos_pass_two(operator, b, &decomposition, y_k.as_ref(), stack)\n}\n```\n\nThe design separates concerns. The `f_tk_solver` closure is where we inject the specific matrix function. We compute the Lanczos decomposition, then pass the coefficients to the user-provided solver, which computes $\\mathbf{y}_k' = f(\\mathbf{T}_k) \\mathbf{e}_1$ for whatever function $f$ is needed. This decoupling means we handle linear solves, matrix exponentials, or any other function without modifying the core algorithm.\n\nThe caller provides `f_tk_solver` as a closure. It receives the raw $\\{\\alpha_j, \\beta_j\\}$ arrays and must return the coefficient vector $\\mathbf{y}_k'$. We then scale it by $\\|\\mathbf{b}\\|_2$ and pass everything to the second pass.\n\n### Example: Solving a Linear System\n\nTo see this in practice, consider solving $\\mathbf{Ax} = \\mathbf{b}$. We compute $f(z) = z^{-1}$, which means the `f_tk_solver` must solve the small tridiagonal system $\\mathbf{T}_k \\mathbf{y}' = \\mathbf{e}_1$.\n\nSince $\\mathbf{T}_k$ is tridiagonal, we can exploit its structure. A sparse LU factorization solves it in $O(k)$ time instead of the $O(k^3)$ cost of a dense method.\n\n```rust\nlet f_tk_solver = |alphas: &[f64], betas: &[f64]| -> Result\u003CMat\u003Cf64>, anyhow::Error> {\n    let steps = alphas.len();\n    if steps == 0 {\n        return Ok(Mat::zeros(0, 1));\n    }\n\n    // 1. Assemble T_k from coefficients using triplet format\n    let mut triplets = Vec::with_capacity(3 * steps - 2);\n    for (i, &alpha) in alphas.iter().enumerate() {\n        triplets.push(Triplet { row: i, col: i, val: alpha });\n    }\n    for (i, &beta) in betas.iter().enumerate() {\n        triplets.push(Triplet { row: i, col: i + 1, val: beta });\n        triplets.push(Triplet { row: i + 1, col: i, val: beta });\n    }\n    let t_k_sparse = SparseColMat::try_new_from_triplets(steps, steps, &triplets)?;\n\n    // 2. Construct e_1\n    let mut e1 = Mat::zeros(steps, 1);\n    e1.as_mut()[(0, 0)] = 1.0;\n\n    // 3. Solve T_k * y' = e_1 via sparse LU\n    Ok(t_k_sparse.as_ref().sp_lu()?.solve(e1.as_ref()))\n};\n```\n\nThe closure takes the coefficient arrays, constructs the sparse tridiagonal matrix, and solves the system. The triplet format lets us build the matrix efficiently without knowing its structure in advance. The sparse LU solver leverages the tridiagonal structure to avoid dense factorization.\n\n\n# Some interesting results\n\nNow that we have a working implementation we can run some tests. The core idea of what we have done is simple: trade flops for better memory access. But does this trade actually pay off on real hardware? To find out, we need a reliable way to benchmark it.\n\nFor the data, we know that the performance of any Krylov method is tied to the operator's spectral properties. We need a way to generate a family of test problems where we can precisely control the size, sparsity, and numerical difficulty. A great way to do this is with Karush-Kuhn-Tucker (KKT) systems, which are sparse, symmetric, and have a specific block structure.\n\n$$\nA =\n\\begin{pmatrix}\n    D & E^T \\\\\n    E & 0\n\\end{pmatrix}\n$$\n\nThis structure gives us two critical knobs to turn. First, with the [netgen](https://commalab.di.unipi.it/files/Data/MCF/netgen.tgz) utility, we can control the $E$ matrix, which lets us dial in the problem dimension, $n$. Second, we build the diagonal block D with random entries from a range $[1, C_D]$. This parameter, $C_D$, gives us direct control over the numerical difficulty of the problem.\n\nFor a symmetric matrix like $D$, the 2-norm condition number, $\\kappa_2(D)$, is the ratio of its largest to its smallest eigenvalue: $\\kappa_2(D) = \\lambda_{\\max}(D) / \\lambda_{\\min}(D)$. Since $D$ is diagonal, its eigenvalues are simply its diagonal entries. We are drawing these entries from a uniform distribution $U[1, C_D]$, so we have $\\lambda_{\\max}(D) \\approx C_D$ and $\\lambda_{\\min}(D) \\approx 1$. This means we get direct control, as $\\kappa_2(D) \\approx C_D$.The spectral properties of this block heavily influence the spectrum of the entire matrix $A$. A large condition number in $D$ leads to a more ill-conditioned system for $A$. The convergence rate of Krylov methods like Lanczos is fundamentally governed by the distribution of the operator's eigenvalues. An ill-conditioned matrix, with a wide spread of eigenvalues, will require more iterations, $k$, to reach the desired accuracy. By simply adjusting the $C_D$ parameter, we can generate everything from well-conditioned problems that converge quickly to ill-conditioned ones that force us to run a large number of iterations. This is exactly what we need to rigorously test our implementation.\n\n## Memory and Computation Trade-off\n\nWe measure the algorithm against two hypotheses on a large sparse problem with $n=500,000$, varying the number of iterations $k$.\n\n**Hypothesis 1 (Memory):** The one-pass method stores the full basis $\\mathbf{V}_k$ with complexity $O(nk)$. We expect its memory to grow linearly with $k$. The two-pass method operates with $O(n)$ memory, so it should have a flat profile.\n\n**Hypothesis 2 (Runtime):** The two-pass method performs $2k$ matrix-vector products instead of $k$. If all else were equal, we'd expect it to run twice as slow.\n\n### Memory Usage\n\n![Memory vs Iterations](/assets/lanczos/tradeoff_arcs500k_rho3_memory.png)\n\nThe memory data confirms Hypothesis 1 exactly. The one-pass method's footprint scales as a straight lineâ€”each additional iteration adds one vector to the basis. The two-pass method remains flat. No allocation growth happens after initialization.\n\n### Runtime: Where Theory Breaks\n\n![Runtime vs Iterations](/assets/lanczos/tradeoff_arcs500k_rho3_time.png)\n\nThe runtime data contradicts Hypothesis 2. The two-pass method is slower, but never by a factor of two. For small $k$, the gap is minimal. As $k$ grows, the two-pass runtime diverges slowly from the one-pass method, not by doubling, but by a much smaller margin.\n\nThis difference comes from memory access patterns. Both methods perform matrix-vector products, but they differ in how they reconstruct the solution.\n\nThe one-pass method computes $\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k$ in a single dense matrix-vector product. When $n$ and $k$ are large, the $n \\times k$ basis matrix exceeds all cache levels. The CPU cannot keep the data resident; instead, it streams $\\mathbf{V}_k$ from main memory. This is a memory-bandwidth-bound operation. The processor stalls, waiting for each load to complete. Instruction-level parallelism collapses.\n\nThe two-pass method reconstructs the solution incrementally. At each iteration, it operates on exactly three n-dimensional vectors: $\\mathbf{v}_{\\text{prev}}$, $\\mathbf{v}_{\\text{curr}}$, and $\\mathbf{x}_k$. This working set fits in L1 cache. The processor performs $2k$ matrix-vector products (each one reading the sparse operator, then applying it to a cached vector), but the solution accumulation happens entirely within cache. The additional matrix-vector products are cheaper than the memory latency of the standard method.\n\nThe cost of re-computing basis vectors is less than the latency cost of scanning an $n \\times k$ dense matrix from main memory.\n\n### Medium-Scale Behavior\n\n![Medium Scale Runtime vs Iterations](/assets/lanczos/tradeoff_arcs50k_rho3_time.png)\n![Medium Scale Memory Usage vs Iterations](/assets/lanczos/tradeoff_arcs50k_rho3_memory.png)\n\nAt $n=50,000$ we can observe an equilibrium. The two methods have nearly identical runtime. The standard method's $\\mathbf{V}_k$ matrix is smaller; it fits partially in cache. The cache-miss penalty here becomes manageable. The two-pass method still has the advantage of cache-local accumulation, but the difference is marginal.\n\n### What About Dense Matrices?\n\nTo be sure of our hypothesis, we can test it directly using a dense matrix of size $n=10,000$. For dense problems, the matrix-vector product is $O(n^2)$, it dominates all other costs. Memory latency will become negligible relative to the compute work and the cache efficiency advantage should disappear.\n\n![Dense Matrix Runtime vs Iterations](/assets/lanczos/dense-tradeoff.png)\n\nWe can see that the two-pass method runs almost exactly twice as slow as the one-pass method. The slope ratio is _exactly_ 2:1. In a compute-bound regime, the extra matrix-vector products cannot be hidden by cache effects. Here, the theoretical trade-off holds perfectly.\n\n## Scalability\n\nNow, let's fix the iteration count at $k=500$ and vary $n$ from $50,000$ to $500,000$ to measure scalability. Based on what we have seen before, we would expect the two-pass memory to scale linearly with $n$ but with a small constant factor (three vectors, plus scalars). The one-pass method should also scale linearly, but with a $k$-dependent slope.\n\n![Scalability Memory Usage](/assets/lanczos/scalability_k500_rho3_memory.png)\n\nHere we have to use a logarithmic y-axis to show both curves; the two-pass line is so flat relative to the one-pass line that it's otherwise invisible.\n\n\n![Scalability Runtime](/assets/lanczos/scalability_k500_rho3_time.png)\n\nRuntime scales linearly with $n$ for both methods, as expected. Below $n=150,000$, the two methods have similar performance. This is the regime where both basis and working set fit in cache, or where the problem is small enough that memory latency is not the bottleneck.\n\nAs $n$ increases beyond $150,000$, the matrix-vector product time dominates. The sparse structure of $\\mathbf{A}$ ensures that each matvec requires multiple memory accesses per element. For the one-pass method, the final reconstruction of $\\mathbf{V}_k \\mathbf{y}_k$ begins to cost more as the matrix grows. For the two-pass method, performing $2k$ matrix-vector products means the matvec cost accumulates more rapidly. The divergence is gradual, not sharp, because the advantage of cache locality in accumulation persistsâ€”but it cannot overcome the fundamental cost of doubling the number of expensive operations.\n\n---\n\nWell, that's it. If you want to have a better look at the code or use it, it's all open source:\n\n* [Github Repository](https://github.com/lukefleed/two-pass-lanczos)\n* [LaTeX Report](https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf)\n\nThis was more of an exploration than a production-ready library, so expect rough edges. But I hope it gives an interesting perspective on how algorithm engineering and low-level implementation details can alter what seems like a straightforward trade-off on a blackboard.","src/data/blog/two-pass-lanczos.md","ba80377584aa09f3",{"html":206,"metadata":207},"\u003Cp>The standard Lanczos method for computing matrix functions has a brutal memory requirement: storing an \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis matrix that grows with every iteration. For a \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>500.000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">500.000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">500.000\u003C/span>\u003C/span>\u003C/span>\u003C/span>-variable problem needing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>1000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">1000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1000\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, thatâ€™s roughly 4 GB just for the basis.\u003C/p>\n\u003Cp>In this post, we will explore one of the most straightforward solutions to this problem: a two-pass variant of the Lanczos algorithm that only requires \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> memory at the cost of doubling the number of matrix-vector products. The surprising part is that when implemented carefully, the two-pass version isnâ€™t just memory-efficientâ€”it can be faster for certain problems. We will dig into why.\u003C/p>\n\u003Cul>\n\u003Cli>All code is available on GitHub: \u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos\">two-pass-lanczos\u003C/a>\u003C/li>\n\u003Cli>A more complete report, with references and more experiments: \u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf\">report.pdf\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>You can discuss this post on \u003Ca href=\"https://news.ycombinator.com/item?id=45889891\">Hacker News\u003C/a>, \u003Ca href=\"https://lobste.rs/s/sag4i3/cache_friendly_low_memory_lanczos\">Lobsters\u003C/a> and \u003Ca href=\"https://www.reddit.com/r/rust/comments/1ouf5hp/cachefriendly_lowmemory_lanczos_algorithm_in_rust/\">Reddit\u003C/a>.\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"table-of-contents\">Table of Contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of Contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#computing-matrix-functions\">Computing Matrix Functions\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#krylov-projection\">Krylov Projection\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#building-an-orthonormal-basis\">Building an Orthonormal Basis\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#solving-in-the-reduced-space\">Solving in the Reduced Space\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#the-lanczos-algorithm\">The Lanczos Algorithm\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#three-term-recurrence\">Three-Term Recurrence\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#reconstructing-the-solution\">Reconstructing the Solution\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#two-pass-algorithm\">Two-Pass Algorithm\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#first-pass-compute-the-projected-problem\">First Pass: Compute the Projected Problem\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#second-pass-reconstruct-and-accumulate\">Second Pass: Reconstruct and Accumulate\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#a-subtle-numerical-point\">A Subtle Numerical Point\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#implementation\">Implementation\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#recurrence-step\">Recurrence Step\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#an-iterator-for-state-management\">An Iterator for State Management\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#first-pass-computing-the-decomposition\">First Pass: Computing the Decomposition\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#second-pass-reconstructing-the-solution\">Second Pass: Reconstructing the Solution\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-public-api\">The Public API\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#example-solving-a-linear-system\">Example: Solving a Linear System\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#some-interesting-results\">Some interesting results\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-and-computation-trade-off\">Memory and Computation Trade-off\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-usage\">Memory Usage\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#runtime-where-theory-breaks\">Runtime: Where Theory Breaks\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#medium-scale-behavior\">Medium-Scale Behavior\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#what-about-dense-matrices\">What About Dense Matrices?\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#scalability\">Scalability\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch1 id=\"computing-matrix-functions\">Computing Matrix Functions\u003C/h1>\n\u003Cp>Letâ€™s consider the problem of computing the action of matrix functions on a vector:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x} = f(\\mathbf{A})\\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4444em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is a large sparse Hermitian matrix and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> is a matrix function defined on the spectrum of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This is a problem that appears pretty often in scientific computing: solving linear systems corresponds to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, exponential integrators for PDEs use \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmi>exp\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>t\u003C/mi>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = \\exp(tz)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mop\">exp\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">t\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and many other problems require functions like \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1/2}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.888em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> or \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmtext>sign\u003C/mtext>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = \\text{sign}(z)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord text\">\u003Cspan class=\"mord\">sign\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>Indeed, there are a lot problems with computing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> directly. First of all, even if \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is sparse, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> is generally dense. Storing it explicitly is out of the question for large problems. Even if we could store it, computing it directly would require algorithms like the Schur-Parlett method that scale as \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>n\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, which is impractical for large \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>However we know that given any matrix function \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> defined on the spectrum of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we can express \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> as a polynomial in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> of degree at most \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> (the size of the matrix) such that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>n\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A}) = p_{n}(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> (this is a consequence of the Cayley-Hamilton theorem). This polynomial interpolates \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> and its derivatives in the Hermitian sense at the eigenvalues of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>This gives us a good and a bad news: the good news is that, well, we can express \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> as a polynomial in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. The bad news is that the degree of this polynomial can be as high as \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>, which is huge for large problems. The idea is then to find a low-degree polynomial approximation to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> that is \u003Cem>good enough\u003C/em> for our purposes. If we can find a polynomial \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">p_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> of degree \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>â‰ª\u003C/mo>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k \\ll n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ª\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> such that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">p_k(\\mathbf{A}) \\approx f(\\mathbf{A})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, then we can approximate the solution as:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmunderover>\u003Cmo>âˆ‘\u003C/mo>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>0\u003C/mn>\u003C/mrow>\u003Cmi>k\u003C/mi>\u003C/munderover>\u003Cmsub>\u003Cmi>c\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msub>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{A})\\mathbf{b} \\approx p_k(\\mathbf{A})\\mathbf{b} = \\sum_{i=0}^k c_i \\mathbf{A}^i \\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:3.1138em;vertical-align:-1.2777em;\">\u003C/span>\u003Cspan class=\"mop op-limits\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.8361em;\">\u003Cspan style=\"top:-1.8723em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003Cspan class=\"mrel mtight\">=\u003C/span>\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.05em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan>\u003Cspan class=\"mop op-symbol large-op\">âˆ‘\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-4.3em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.2777em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">c\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8747em;\">\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This polynomial only involves vectors within a specific subspace.\u003C/p>\n\u003Ch2 id=\"krylov-projection\">Krylov Projection\u003C/h2>\n\u003Cp>We can notice that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>p\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">p_k(\\mathbf{A})\\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">p\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span> only depends on vectors in the Krylov subspace of order \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"script\">K\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmtext>span\u003C/mtext>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b}) = \\text{span}\\{\\mathbf{b}, \\mathbf{Ab}, \\mathbf{A}^2\\mathbf{b}, \\ldots, \\mathbf{A}^{k-1}\\mathbf{b}\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathcal\" style=\"margin-right:0.01445em;\">K\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0144em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1491em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord text\">\u003Cspan class=\"mord\">span\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">Ab\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8641em;\">\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8991em;\">\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This is fortunate: we can compute an approximate solution by staying within this space, which only requires repeated matrix-vector products with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For large sparse matrices, thatâ€™s the only operation we can do efficiently anyway.\u003C/p>\n\u003Cblockquote>\n\u003Cp>We donâ€™t need to construct \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}^j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8247em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> explicitly. We compute iteratively: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}(\\mathbf{A}^{j-1}\\mathbf{b})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0747em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003C/blockquote>\n\u003Cp>But thereâ€™s a problem: the raw vectors \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msup>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\mathbf{A}^j\\mathbf{b}\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0747em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span> form a terrible basis. They quickly become nearly parallel, making any computation numerically unstable. We need an orthonormal basis.\u003C/p>\n\u003Ch3 id=\"building-an-orthonormal-basis\">Building an Orthonormal Basis\u003C/h3>\n\u003Cp>The standard method is the Arnoldi process, which is Gram-Schmidt applied to Krylov subspaces. We start by normalizing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">/âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Then, iteratively:\u003C/p>\n\u003Col>\n\u003Cli>Compute a new candidate: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{w}_j = \\mathbf{A}\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>Orthogonalize against all existing basis vectors:\u003C/li>\n\u003C/ol>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmunderover>\u003Cmo>âˆ‘\u003C/mo>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cmi>j\u003C/mi>\u003C/munderover>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>i\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\tilde{\\mathbf{v}}_j = \\mathbf{w}_j - \\sum_{i=1}^j (\\mathbf{v}_i^H \\mathbf{w}_j) \\mathbf{v}_i\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9674em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:3.1364em;vertical-align:-1.2777em;\">\u003C/span>\u003Cspan class=\"mop op-limits\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.8588em;\">\u003Cspan style=\"top:-1.8723em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003Cspan class=\"mrel mtight\">=\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.05em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan>\u003Cspan class=\"mop op-symbol large-op\">âˆ‘\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-4.3471em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.2777em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8913em;\">\u003Cspan style=\"top:-2.453em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.247em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Col start=\"3\">\n\u003Cli>Normalize: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_j / \\|\\tilde{\\mathbf{v}}_j\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">/âˆ¥\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003C/ol>\n\u003Cp>The coefficients \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>h\u003C/mi>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>i\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi mathvariant=\"bold\">w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">h_{ij} = \\mathbf{v}_i^H \\mathbf{w}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">h\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">ij\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1274em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-2.4413em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2587em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> become entries of a projected matrix. After \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, we have:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>: an orthonormal basis for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"script\">K\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathcal{K}_k(\\mathbf{A}, \\mathbf{b})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathcal\" style=\"margin-right:0.01445em;\">K\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0144em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{H}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>: an upper Hessenberg matrix representing the projection of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> onto this subspace\u003C/li>\n\u003C/ul>\n\u003Cp>We can express this relationship with the Arnoldi decomposition:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>+\u003C/mo>\u003Cmsub>\u003Cmi>h\u003C/mi>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmi>T\u003C/mi>\u003C/msubsup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\\mathbf{V}_k = \\mathbf{V}_k \\mathbf{H}_k + h_{k+1,k} \\mathbf{v}_{k+1} \\mathbf{e}_k^T\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1774em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">h\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003Cspan class=\"mpunct mtight\">,\u003C/span>\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2083em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8913em;\">\u003Cspan style=\"top:-2.453em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.247em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Ch3 id=\"solving-in-the-reduced-space\">Solving in the Reduced Space\u003C/h3>\n\u003Cp>Now we approximate our original problem by solving it in the small \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>-dimensional space. Using the Full Orthogonal Method (FOM), we enforce that the residual is orthogonal to\nthe Krylov subspace. This gives:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is computed as:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{H}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>The heavy lifting is now on computing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(\\mathbf{H}_k)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, a small \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix.\nSince \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>â‰ª\u003C/mo>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k \\ll n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ª\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we can afford direct methods like Schur-Parlett (\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>).\u003C/p>\n\u003Cblockquote>\n\u003Cp>For \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> (linear systems), this reduces to solving \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{H}_k \\mathbf{y}_k = \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> with LU decomposition.\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"the-lanczos-algorithm\">The Lanczos Algorithm\u003C/h1>\n\u003Cp>When \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is Hermitian (or symmetric in the real case), the general Arnoldi\nprocess simplifies dramatically. We can prove that \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">H\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{H}_k = \\mathbf{V}_k^H \\mathbf{A} \\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">H\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.1244em;vertical-align:-0.2831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-2.4169em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> must also be Hermitian. A matrix that is both upper Hessenberg \u003Cem>and\u003C/em> Hermitian must be real, symmetric, and tridiagonal. This is a \u003Cem>huge\u003C/em> simplification.\u003C/p>\n\u003Cp>In the literature, this projected matrix is denoted \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> to highlight its\ntridiagonal structure:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmrow>\u003Cmo fence=\"true\">(\u003C/mo>\u003Cmtable rowspacing=\"0.16em\" columnalign=\"center center center center\" columnspacing=\"1em\">\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmo lspace=\"0em\" rspace=\"0em\">â‹±\u003C/mo>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmo lspace=\"0em\" rspace=\"0em\">â‹±\u003C/mo>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmrow>\u003C/mrow>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmo lspace=\"0em\" rspace=\"0em\">â‹±\u003C/mo>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003C/mtable>\u003Cmo fence=\"true\">)\u003C/mo>\u003C/mrow>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k = \\begin{pmatrix}\n\\alpha_1 &#x26; \\beta_1 &#x26; &#x26; \\\\\n\\beta_1 &#x26; \\alpha_2 &#x26; \\beta_2 &#x26; \\\\\n&#x26; \\beta_2 &#x26; \\ddots &#x26; \\ddots \\\\\n&#x26; &#x26; \\ddots &#x26; \\alpha_k\n\\end{pmatrix}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:4.8em;vertical-align:-2.15em;\">\u003C/span>\u003Cspan class=\"minner\">\u003Cspan class=\"mopen\">\u003Cspan class=\"delimsizing mult\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.65em;\">\u003Cspan class=\"pstrut\" style=\"height:6.8em;\">\u003C/span>\u003Cspan style=\"width:0.875em;height:4.800em;\">\u003Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.875em\" height=\"4.800em\" viewBox=\"0 0 875 4800\">\u003Cpath d=\"M863,9c0,-2,-2,-5,-6,-9c0,0,-17,0,-17,0c-12.7,0,-19.3,0.3,-20,1\nc-5.3,5.3,-10.3,11,-15,17c-242.7,294.7,-395.3,682,-458,1162c-21.3,163.3,-33.3,349,\n-36,557 l0,1284c0.2,6,0,26,0,60c2,159.3,10,310.7,24,454c53.3,528,210,\n949.7,470,1265c4.7,6,9.7,11.7,15,17c0.7,0.7,7,1,19,1c0,0,18,0,18,0c4,-4,6,-7,6,-9\nc0,-2.7,-3.3,-8.7,-10,-18c-135.3,-192.7,-235.5,-414.3,-300.5,-665c-65,-250.7,-102.5,\n-544.7,-112.5,-882c-2,-104,-3,-167,-3,-189\nl0,-1292c0,-162.7,5.7,-314,17,-454c20.7,-272,63.7,-513,129,-723c65.3,\n-210,155.3,-396.3,270,-559c6.7,-9.3,10,-15.3,10,-18z\">\u003C/path>\u003C/svg>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mtable\">\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"minner\">â‹±\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"minner\">â‹±\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.81em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.61em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.41em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"minner\">â‹±\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-1.21em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">\u003Cspan class=\"delimsizing mult\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.65em;\">\u003Cspan style=\"top:-4.65em;\">\u003Cspan class=\"pstrut\" style=\"height:6.8em;\">\u003C/span>\u003Cspan style=\"width:0.875em;height:4.800em;\">\u003Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"0.875em\" height=\"4.800em\" viewBox=\"0 0 875 4800\">\u003Cpath d=\"M76,0c-16.7,0,-25,3,-25,9c0,2,2,6.3,6,13c21.3,28.7,42.3,60.3,\n63,95c96.7,156.7,172.8,332.5,228.5,527.5c55.7,195,92.8,416.5,111.5,664.5\nc11.3,139.3,17,290.7,17,454c0,28,1.7,43,3.3,45l0,1209\nc-3,4,-3.3,16.7,-3.3,38c0,162,-5.7,313.7,-17,455c-18.7,248,-55.8,469.3,-111.5,664\nc-55.7,194.7,-131.8,370.3,-228.5,527c-20.7,34.7,-41.7,66.3,-63,95c-2,3.3,-4,7,-6,11\nc0,7.3,5.7,11,17,11c0,0,11,0,11,0c9.3,0,14.3,-0.3,15,-1c5.3,-5.3,10.3,-11,15,-17\nc242.7,-294.7,395.3,-681.7,458,-1161c21.3,-164.7,33.3,-350.7,36,-558\nl0,-1344c-2,-159.3,-10,-310.7,-24,-454c-53.3,-528,-210,-949.7,\n-470,-1265c-4.7,-6,-9.7,-11.7,-15,-17c-0.7,-0.7,-6.7,-1,-18,-1z\">\u003C/path>\u003C/svg>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:2.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆˆ\u003C/mo>\u003Cmi mathvariant=\"double-struck\">R\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j \\in \\mathbb{R}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8252em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">âˆˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6889em;\">\u003C/span>\u003Cspan class=\"mord mathbb\">R\u003C/span>\u003C/span>\u003C/span>\u003C/span> are the diagonal elements and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆˆ\u003C/mo>\u003Cmi mathvariant=\"double-struck\">R\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j \\in \\mathbb{R}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">âˆˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6889em;\">\u003C/span>\u003Cspan class=\"mord mathbb\">R\u003C/span>\u003C/span>\u003C/span>\u003C/span> are the off-diagonals (subdiagonals from the orthogonalization).\u003C/p>\n\u003Ch2 id=\"three-term-recurrence\">Three-Term Recurrence\u003C/h2>\n\u003Cp>This tridiagonal structure leads to a beautiful simplification. To build the next basis\nvector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we donâ€™t need the entire history of vectors. We only need\nthe two previous ones. Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is Hermitian, this guarantees that\nany new vector is \u003Cem>automatically\u003C/em> orthogonal to all earlier vectors (beyond the previous two). So we can skip the full orthogonalization and use a simple three-term recurrence:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>+\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>+\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\\mathbf{v}_j = \\beta_{j-1}\\mathbf{v}_{j-1} + \\alpha_j \\mathbf{v}_j + \\beta_j \\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>Rearranging gives us an algorithm to compute \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> directly:\u003C/p>\n\u003Col>\n\u003Cli>Compute the candidate: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">w_{j+1} = \\mathbf{A}\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>Extract the diagonal coefficient: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j = \\mathbf{v}_j^H w_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.2361em;vertical-align:-0.3948em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-2.4413em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3948em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003Cli>Orthogonalize against the two previous vectors:\u003C/li>\n\u003C/ol>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\tilde{\\mathbf{v}}_{j+1} = w_{j+1} - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9674em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Col start=\"4\">\n\u003Cli>Normalize: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">/\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/li>\n\u003C/ol>\n\u003Cp>This is known as the Lanczos algorithm. Itâ€™s more efficient than Arnoldi because each iteration only orthogonalizes against two previous vectors instead of all prior ones.\u003C/p>\n\u003Ch2 id=\"reconstructing-the-solution\">Reconstructing the Solution\u003C/h2>\n\u003Cp>After \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, we end up with the tridiagonal matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and all \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis vectors \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k = [\\mathbf{v}_1, \\ldots, \\mathbf{v}_k]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We can then reconstruct the approximate solution as:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is solved from the small tridiagonal matrix.\u003C/p>\n\u003Cp>There is a timing problem however: we cannot compute the coefficients \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\nuntil all \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations are complete. The full matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is only available\nat the end, so we must store every basis vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> along the way, leading to a memory cost of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nk)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>So weâ€™re left with a choice: whether we store all the basis vectors and solve the problem in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> passes, or find a way to avoid storing them. There is a middle ground.\u003C/p>\n\u003Cblockquote>\n\u003Cp>There are also techniques to compress the basis vectors, have a look \u003Ca href=\"https://arxiv.org/abs/2403.04390\">here\u003C/a>\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"two-pass-algorithm\">Two-Pass Algorithm\u003C/h1>\n\u003Cp>Hereâ€™s where we break the timing deadlock. The insight that we donâ€™t actually need to store the basis vectors if we can afford to compute them twice\u003C/p>\n\u003Cp>Think about what we have after the first pass. Weâ€™ve computed all the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> coefficients that compose the entire tridiagonal matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. These numbers are small compared to the full basis. What if we kept only these scalars, discarded all the vectors, and then replayed the Lanczos recurrence a second time? Weâ€™d regenerate the same basis, and this time weâ€™d use it to build the solution.\u003C/p>\n\u003Cp>This comes at a cost. We run Lanczos twice, so we pay for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products instead of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. But we only ever store a constant number of vectors in memory, no \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nk)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis matrix. The memory complexity drops to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>It sounds like a bad trade at first. But as weâ€™ll see later, the cache behavior of this\ntwo-pass approach can actually make it as fast (or even faster) on real hardware if well optimized.\u003C/p>\n\u003Ch2 id=\"first-pass-compute-the-projected-problem\">First Pass: Compute the Projected Problem\u003C/h2>\n\u003Cp>We initialize \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_1 = \\mathbf{b} / \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">/âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and set \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmn>0\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_0 = 0\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmn mathvariant=\"bold\">0\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_0 = \\mathbf{0}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>.Then we run the standard Lanczos recurrence:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">w_j = \\mathbf{A}\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003Cmi>H\u003C/mi>\u003C/msubsup>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j = \\mathbf{v}_j^H w_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.2744em;vertical-align:-0.3831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8913em;\">\u003Cspan style=\"top:-2.453em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.113em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\tilde{\\mathbf{v}}_{j+1} = w_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9674em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmspace width=\"1em\">\u003C/mspace>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmover accent=\"true\">\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmo>~\u003C/mo>\u003C/mover>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j = \\|\\tilde{\\mathbf{v}}_{j+1}\\|_2, \\quad \\mathbf{v}_{j+1} = \\tilde{\\mathbf{v}}_{j+1} / \\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:1em;\">\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord accent\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6813em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.3634em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"accent-body\" style=\"left:-0.2222em;\">\u003Cspan class=\"mord\">~\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">/\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>At each step, we record \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. But we \u003Cem>do not\u003C/em> store \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\nInstead, we discard it immediately after computing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j+1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. In this way we only keep in memory at most just three vectors at any time (\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and the working vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>w\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">w_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>).\u003C/p>\n\u003Cp>After \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> iterations, we have the full set \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmo>â€¦\u003C/mo>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_1, \\beta_1, \\ldots, \\alpha_k, \\beta_k\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"minner\">â€¦\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span>. These \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> scalars define the tridiagonal matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We can now solve:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This is the solution in the reduced space. Now that we have the coefficients we need to build \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Ch2 id=\"second-pass-reconstruct-and-accumulate\">Second Pass: Reconstruct and Accumulate\u003C/h2>\n\u003Cp>With \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> in memory, we replay the Lanczos recurrence \u003Cem>exactly as before\u003C/em>. We start with the same initialization (\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_0\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmn>0\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_0\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>) and apply the same sequence of operations, using the stored scalars \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> to reconstruct each basis vector on demand. We can write some rust-like \u003Cem>pseudocode\u003C/em> for this second pass to get a feel for it:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">/\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b_norm\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> A\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> @\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Matrix-vector product\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // We don't recompute alpha/beta; we already have them from pass 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> ?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Accumulate the solution\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y_k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Regenerate the next basis vector for the *next* iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_next\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">/\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Slide the window forward\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_next\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This loop regenerates each \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> on demand and immediately uses it to update the solution.\nOnce weâ€™ve accumulated \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">(\\mathbf{y}_k)_j \\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> into \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, we discard the vector. We never store the full basis.\u003C/p>\n\u003Ch3 id=\"a-subtle-numerical-point\">A Subtle Numerical Point\u003C/h3>\n\u003Cp>There is one detail worth noting: floating-point arithmetic is deterministic. When we replay the Lanczos recurrence in the second pass with the exact same inputs and the exact same order of operations, we get bitwise-identical vectors. The \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> regenerated in pass 2 are identical to the ones computed in pass 1.\u003C/p>\n\u003Cp>However, the order in which we accumulate the solution differs. In a standard Lanczos,\n\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is built as a single matrix-vector product: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> (a \u003Ccode>gemv\u003C/code> call in BLAS). In the two-pass method, itâ€™s built as a loop of scaled vector additions (a series of \u003Ccode>axpy\u003C/code> calls). These operations accumulate rounding error differently, so the final solution differs slightly, typically by machine epsilon. This rarely matters in practice, and convergence is unaffected.\u003C/p>\n\u003Ch1 id=\"implementation\">Implementation\u003C/h1>\n\u003Cp>Building this in Rust forces us to think concretely about where data lives and how it flows through the cache hierarchy. We need to control memory layout, decide when allocations happen, and choose abstractions that cost us nothing at runtime.\u003C/p>\n\u003Cp>For linear algebra, we reach for \u003Ca href=\"https://github.com/sarah-ek/faer-rs\">\u003Ccode>faer\u003C/code>\u003C/a>. Three design choices in this library matter for what weâ€™re building:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>Stack allocation via \u003Ccode>MemStack\u003C/code>:\u003C/strong> Pre-allocated scratch space that lives for the entire computation. The hot path becomes allocation-free.\u003C/li>\n\u003Cli>\u003Cstrong>Matrix-free operators:\u003C/strong> The \u003Ccode>LinOp\u003C/code> trait defines an operator by its action (\u003Ccode>apply\u003C/code>) without materializing a matrix. For large sparse problems, this is the only viable approach.\u003C/li>\n\u003Cli>\u003Cstrong>SIMD-friendly loops:\u003C/strong> The \u003Ccode>zip!\u003C/code> macro generates code that compiles to packed instructions.\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"recurrence-step\">Recurrence Step\u003C/h2>\n\u003Cp>Our starting point is the Lanczos three-term recurrence that we derived earlier:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo>âˆ’\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j \\mathbf{v}_{j+1} = \\mathbf{A}\\mathbf{v}_j - \\alpha_j \\mathbf{v}_j - \\beta_{j-1}\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">+\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9722em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8694em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>We can translate this into a recurrence step function. The signature looks like this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_recurrence_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The function is generic over the field type \u003Ccode>T\u003C/code> (\u003Ccode>f64\u003C/code>, \u003Ccode>c64\u003C/code>, etc.) and the operator type \u003Ccode>O\u003C/code>. It operates on matrix views (\u003Ccode>MatMut\u003C/code> and \u003Ccode>MatRef\u003C/code>) to avoid unnecessary data copies. The return type gives us the diagonal element \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and, \u003Cem>if no breakdown occurs\u003C/em>, the off-diagonal \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>Now we can implement the body by following the math. The first step is the most expensive:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 1. Apply operator: w = A * v_curr\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">apply\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Par\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Seq\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The matrix-vector product dominates the computational cost. Everything else is secondary.\u003C/p>\n\u003Cp>Next, we orthogonalize against \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{j-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This is where we benefit from \u003Ccode>faer\u003C/code>â€™s design. The \u003Ccode>zip!\u003C/code> macro fuses this operation into a single loop that the compiler vectorizes into SIMD instructions.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 2. Orthogonalize against v_{j-1}: w -= Î²_{j-1} * v_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With \u003Ccode>w\u003C/code> partially orthogonalized, we can compute the diagonal coefficient via an inner product. Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> is Hermitian, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is guaranteed real.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 3. Compute Î±_j = v_j^H * w\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">real_part_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">adjoint\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())[(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We complete the orthogonalization against \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> with another \u003Ccode>zip!\u003C/code> loop.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 4. Orthogonalize against v_j: w -= Î±_j * v_j\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now \u003Ccode>w\u003C/code> holds the unnormalized next basis vector. We compute its norm to get \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. If this norm is numerically zero, the Krylov subspace is invariant, the iteration has reached its natural stopping point. This is called breakdown.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 5. Compute Î²_j = ||w||_2 and check for breakdown\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">norm_l2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> breakdown_tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The function returns \u003Ccode>None\u003C/code> for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> when breakdown occurs, signaling to the caller that no further iterations should proceed.\u003C/p>\n\u003Ch2 id=\"an-iterator-for-state-management\">An Iterator for State Management\u003C/h2>\n\u003Cp>The recurrence step is a pure function, but calling it in a loop is both inefficient and awkward. Weâ€™d need to manually pass vectors in and out of each iteration. More critically, weâ€™d create copies when we should be reusing memory.\u003C/p>\n\u003Cp>The iterator pattern solves this. We create a struct that encapsulates the state:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LanczosIteration\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v_j\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,         \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Workspace for the next vector\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Î²_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... iteration counters\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The main design choice here is that vectors are \u003Cstrong>owned\u003C/strong> (\u003Ccode>Mat&#x3C;T>\u003C/code>), not borrowed. This enables an optimization in the \u003Ccode>next_step\u003C/code> method. After computing the next vector and normalizing it into \u003Ccode>work\u003C/code>, we cycle the state without allocating or copying:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Inside next_step, after normalization...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v_prev, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v_curr);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v_curr, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">work);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On x86-64, swapping two \u003Ccode>Mat&#x3C;T>\u003C/code> structures (fat pointers) compiles to three \u003Ccode>mov\u003C/code> instructions. The pointers change, but no vector data moves. After the swap, \u003Ccode>v_prev\u003C/code> points to what \u003Ccode>v_curr\u003C/code> held, \u003Ccode>v_curr\u003C/code> points to \u003Ccode>work\u003C/code>â€™s allocation, and \u003Ccode>work\u003C/code> points to the old \u003Ccode>v_prev\u003C/code> data. In the next iteration, \u003Ccode>work\u003C/code> gets reused.\u003C/p>\n\u003Cp>We keep exactly three n-dimensional vectors live in memory. The same allocations cycle through the computation, staying hot in L1 cache. This is the core reason the two-pass method can be faster than expected, the working set never leaves cache.\u003C/p>\n\u003Ch2 id=\"first-pass-computing-the-decomposition\">First Pass: Computing the Decomposition\u003C/h2>\n\u003Cp>The first pass runs the Lanczos iteration and collects the coefficients \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_j, \\beta_j\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Basis vectors are discarded after each step.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_pass_one\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosDecomposition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosError\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We allocate vectors for the coefficients with a capacity hint to avoid reallocations:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Then we construct the iterator. This allocates the three work vectors once. After this point, the hot path is allocation-free:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lanczos_iter\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LanczosIteration\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b_norm\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> let\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lanczos_iter\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">next_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">step\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">alpha);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        steps_taken\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> breakdown_tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> step\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">beta \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> tolerance\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">step\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">beta);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The check for breakdown stops the iteration when the residual becomes numerically zero. This means weâ€™ve found an invariant subspace and thereâ€™s no value in continuing.\u003C/p>\n\u003Cp>At the end, we collect the scalars into a \u003Ccode>LanczosDecomposition\u003C/code> struct. The memory footprint throughout this pass is constant: three n-dimensional vectors plus two small arrays that grow to at most \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> elements.\u003C/p>\n\u003Ch2 id=\"second-pass-reconstructing-the-solution\">Second Pass: Reconstructing the Solution\u003C/h2>\n\u003Cp>Now we face a different problem. We have the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_j, \\beta_j\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span> coefficients from the first pass and the coefficient vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k = f(\\mathbf{T}_k) \\mathbf{e}_1 \\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> from solving the projected problem. We need to reconstruct the solution:\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmunderover>\u003Cmo>âˆ‘\u003C/mo>\u003Cmrow>\u003Cmi>j\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cmi>k\u003C/mi>\u003C/munderover>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\sum_{j=1}^k (\\mathbf{y}_k)_j \\mathbf{v}_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:3.2499em;vertical-align:-1.4138em;\">\u003C/span>\u003Cspan class=\"mop op-limits\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.8361em;\">\u003Cspan style=\"top:-1.8723em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003Cspan class=\"mrel mtight\">=\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.05em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan>\u003Cspan class=\"mop op-symbol large-op\">âˆ‘\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-4.3em;margin-left:0em;\">\u003Cspan class=\"pstrut\" style=\"height:3.05em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.4138em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>without storing the full basis matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>The recurrence step in this pass is structurally similar to the first pass, but with a key difference: we no longer compute inner products or norms. We already know the coefficients, so the step becomes pure reconstruction.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_reconstruction_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Apply operator\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">apply\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Par\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Seq\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Orthogonalize using stored Î±_j and Î²_{j-1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_prev_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_prev_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rb_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha_scaled\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is cheaper than the first-pass recurrence. Weâ€™ve eliminated the inner products that computed \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\alpha_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and the norm calculation for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. What remains is pure orthogonalization and the operator application.\u003C/p>\n\u003Cp>\u003Ccode>lanczos_pass_two\u003C/code> implements this reconstruction. We initialize the three work vectors and the solution accumulator:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_pass_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosDecomposition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    y_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosError\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">nrows\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> inv_norm\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">recip_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">b_norm));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">inv_norm\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v_1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">nrows\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Initialize solution with first component\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]));\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We build the solution incrementally by starting with the first basis vector scaled by its coefficient. The main loop then regenerates each subsequent vector: we regenerate each subsequent basis vector, normalize it using the stored \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\beta_j\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and immediately accumulate its contribution:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">steps_taken \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">alphas[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">betas[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zero_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">betas[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 1. Regenerate the unnormalized next vector\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    lanczos_reconstruction_step\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        alpha_j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        beta_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 2. Normalize using stored Î²_j\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> inv_beta\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">recip_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta_j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">inv_beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 3. Accumulate: x_k += y_{j+1} * v_{j+1}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> coeff\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">j\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    zip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">work\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">for_each\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unzip!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">mul\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">coeff\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v_i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 4. Cycle vectors for the next iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_prev\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    core\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v_curr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> work\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The accumulation \u003Ccode>x_k += y_{j+1} * v_{j+1}\u003C/code> is implemented as a fused multiply-add in the \u003Ccode>zip!\u003C/code> loop. On hardware with FMA support, this becomes a single instruction per element, not three separate operations.\u003C/p>\n\u003Cp>Note that we accumulate the solution incrementally. After each iteration, \u003Ccode>x_k\u003C/code> contains a partial result. We cycle through the same three vectors (\u003Ccode>v_prev\u003C/code>, \u003Ccode>v_curr\u003C/code>, \u003Ccode>work\u003C/code>), keeping the working set small and resident in L1 cache.\u003C/p>\n\u003Cp>Compare this to the standard methodâ€™s final reconstruction step: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This is a dense matrix-vector product where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. When \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> are both large, this matrix no longer fits in cache. The CPU must stream it from main memory, paying the cost of memory latency. Each element requires a load, multiply, and accumulate, but the load operations dominateâ€”the CPU stalls waiting for data.\u003C/p>\n\u003Cp>In our two-pass reconstruction, the operator \u003Ccode>$\\mathbf{A}$\u003C/code> is applied \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> times, but against vectors that stay in cache. The memory bandwidth is spent on reading the sparse structure of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> and the vector elements, not on scanning a dense \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix.\u003C/p>\n\u003Cp>This is the reason the two-pass method can be faster on real hardware despite performing twice as many matrix-vector products. The cache behavior of the reconstruction phase overwhelms the savings of storing the basis.\u003C/p>\n\u003Ch2 id=\"the-public-api\">The Public API\u003C/h2>\n\u003Cp>We can wrap the two passes into a single entry point:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_two_pass\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    operator\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">O\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MatRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    stack\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemStack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> f_tk_solver\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">LanczosError\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ComplexField\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    O\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> LinOp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> FnMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Real\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">anyhow\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // First pass: compute T_k coefficients\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> lanczos_pass_one\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">steps_taken \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">nrows\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Solve projected problem: y_k' = f(T_k) * e_1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y_k_prime\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f_tk_solver\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">alphas, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">betas)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Scale by ||b||\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k_prime\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_real_impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">b_norm));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Second pass: reconstruct solution\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    lanczos_pass_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">decomposition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y_k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The design separates concerns. The \u003Ccode>f_tk_solver\u003C/code> closure is where we inject the specific matrix function. We compute the Lanczos decomposition, then pass the coefficients to the user-provided solver, which computes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">â€²\u003C/mo>\u003C/msubsup>\u003Cmo>=\u003C/mo>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k' = f(\\mathbf{T}_k) \\mathbf{e}_1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.035em;vertical-align:-0.2831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.7519em;\">\u003Cspan style=\"top:-2.4169em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">â€²\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> for whatever function \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003C/span>\u003C/span>\u003C/span> is needed. This decoupling means we handle linear solves, matrix exponentials, or any other function without modifying the core algorithm.\u003C/p>\n\u003Cp>The caller provides \u003Ccode>f_tk_solver\u003C/code> as a closure. It receives the raw \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">{\u003C/mo>\u003Cmsub>\u003Cmi>Î±\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>Î²\u003C/mi>\u003Cmi>j\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">}\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\{\\alpha_j, \\beta_j\\}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mopen\">{\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">Î±\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">Î²\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">}\u003C/span>\u003C/span>\u003C/span>\u003C/span> arrays and must return the coefficient vector \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsubsup>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">â€²\u003C/mo>\u003C/msubsup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{y}_k'\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.035em;vertical-align:-0.2831em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.7519em;\">\u003Cspan style=\"top:-2.4169em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">â€²\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2831em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We then scale it by \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003Cmsub>\u003Cmi mathvariant=\"normal\">âˆ¥\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\|\\mathbf{b}\\|_2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">âˆ¥\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and pass everything to the second pass.\u003C/p>\n\u003Ch3 id=\"example-solving-a-linear-system\">Example: Solving a Linear System\u003C/h3>\n\u003Cp>To see this in practice, consider solving \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003C/mrow>\u003Cmo>=\u003C/mo>\u003Cmi mathvariant=\"bold\">b\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{Ax} = \\mathbf{b}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">Ax\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">b\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We compute \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>z\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsup>\u003Cmi>z\u003C/mi>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(z) = z^{-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, which means the \u003Ccode>f_tk_solver\u003C/code> must solve the small tridiagonal system \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsup>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">â€²\u003C/mo>\u003C/msup>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">e\u003C/mi>\u003Cmn>1\u003C/mn>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k \\mathbf{y}' = \\mathbf{e}_1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.9463em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.7519em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">â€²\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">e\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">T\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{T}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">T\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> is tridiagonal, we can exploit its structure. A sparse LU factorization solves it in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time instead of the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> cost of a dense method.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> f_tk_solver\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> ->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">anyhow\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> steps\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> steps\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 1. Assemble T_k from coefficients using triplet format\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> steps\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alphas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">enumerate\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Triplet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">row\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">col\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> alpha\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> betas\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">enumerate\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Triplet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">row\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">col\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        triplets\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Triplet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">row\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">col\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> beta\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> });\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> t_k_sparse\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SparseColMat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">try_new_from_triplets\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">steps\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">steps\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">triplets\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 2. Construct e_1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> e1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Mat\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">steps\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    e1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()[(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 3. Solve T_k * y' = e_1 via sparse LU\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">t_k_sparse\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sp_lu\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">solve\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">e1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The closure takes the coefficient arrays, constructs the sparse tridiagonal matrix, and solves the system. The triplet format lets us build the matrix efficiently without knowing its structure in advance. The sparse LU solver leverages the tridiagonal structure to avoid dense factorization.\u003C/p>\n\u003Ch1 id=\"some-interesting-results\">Some interesting results\u003C/h1>\n\u003Cp>Now that we have a working implementation we can run some tests. The core idea of what we have done is simple: trade flops for better memory access. But does this trade actually pay off on real hardware? To find out, we need a reliable way to benchmark it.\u003C/p>\n\u003Cp>For the data, we know that the performance of any Krylov method is tied to the operatorâ€™s spectral properties. We need a way to generate a family of test problems where we can precisely control the size, sparsity, and numerical difficulty. A great way to do this is with Karush-Kuhn-Tucker (KKT) systems, which are sparse, symmetric, and have a specific block structure.\u003C/p>\n\u003Cspan class=\"katex-display\">\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\">\u003Csemantics>\u003Cmrow>\u003Cmi>A\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmrow>\u003Cmo fence=\"true\">(\u003C/mo>\u003Cmtable rowspacing=\"0.16em\" columnalign=\"center center\" columnspacing=\"1em\">\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmi>D\u003C/mi>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmsup>\u003Cmi>E\u003C/mi>\u003Cmi>T\u003C/mi>\u003C/msup>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003Cmtr>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmi>E\u003C/mi>\u003C/mstyle>\u003C/mtd>\u003Cmtd>\u003Cmstyle scriptlevel=\"0\" displaystyle=\"false\">\u003Cmn>0\u003C/mn>\u003C/mstyle>\u003C/mtd>\u003C/mtr>\u003C/mtable>\u003Cmo fence=\"true\">)\u003C/mo>\u003C/mrow>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">A =\n\\begin{pmatrix}\n    D &#x26; E^T \\\\\n    E &#x26; 0\n\\end{pmatrix}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">A\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:2.4013em;vertical-align:-0.9507em;\">\u003C/span>\u003Cspan class=\"minner\">\u003Cspan class=\"mopen delimcenter\" style=\"top:0em;\">\u003Cspan class=\"delimsizing size3\">(\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mtable\">\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.4507em;\">\u003Cspan style=\"top:-3.6093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.4093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.9507em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"arraycolsep\" style=\"width:0.5em;\">\u003C/span>\u003Cspan class=\"col-align-c\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:1.4507em;\">\u003Cspan style=\"top:-3.6093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8413em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-2.4093em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.9507em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose delimcenter\" style=\"top:0em;\">\u003Cspan class=\"delimsizing size3\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\n\u003Cp>This structure gives us two critical knobs to turn. First, with the \u003Ca href=\"https://commalab.di.unipi.it/files/Data/MCF/netgen.tgz\">netgen\u003C/a> utility, we can control the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>E\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">E\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix, which lets us dial in the problem dimension, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Second, we build the diagonal block D with random entries from a range \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">[1, C_D]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This parameter, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, gives us direct control over the numerical difficulty of the problem.\u003C/p>\n\u003Cp>For a symmetric matrix like \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>D\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the 2-norm condition number, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Îº\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\kappa_2(D)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Îº\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, is the ratio of its largest to its smallest eigenvalue: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Îº\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>max\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>min\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\kappa_2(D) = \\lambda_{\\max}(D) / \\lambda_{\\min}(D)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Îº\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">a\u003C/span>\u003Cspan class=\"mtight\">x\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mord\">/\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3175em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">i\u003C/span>\u003Cspan class=\"mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Since \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>D\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span> is diagonal, its eigenvalues are simply its diagonal entries. We are drawing these entries from a uniform distribution \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>U\u003C/mi>\u003Cmo stretchy=\"false\">[\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003Cmo stretchy=\"false\">]\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">U[1, C_D]\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U\u003C/span>\u003Cspan class=\"mopen\">[\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">]\u003C/span>\u003C/span>\u003C/span>\u003C/span>, so we have \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>max\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\lambda_{\\max}(D) \\approx C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">a\u003C/span>\u003Cspan class=\"mtight\">x\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Î»\u003C/mi>\u003Cmi>min\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\lambda_{\\min}(D) \\approx 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Î»\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3175em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mop mtight\">\u003Cspan class=\"mtight\">m\u003C/span>\u003Cspan class=\"mtight\">i\u003C/span>\u003Cspan class=\"mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This means we get direct control, as \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>Îº\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msub>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>D\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003Cmo>â‰ˆ\u003C/mo>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\kappa_2(D) \\approx C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">Îº\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3011em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰ˆ\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.The spectral properties of this block heavily influence the spectrum of the entire matrix \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">A\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. A large condition number in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>D\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span> leads to a more ill-conditioned system for \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">A\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span>. The convergence rate of Krylov methods like Lanczos is fundamentally governed by the distribution of the operatorâ€™s eigenvalues. An ill-conditioned matrix, with a wide spread of eigenvalues, will require more iterations, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>, to reach the desired accuracy. By simply adjusting the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi>C\u003C/mi>\u003Cmi>D\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">C_D\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3283em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> parameter, we can generate everything from well-conditioned problems that converge quickly to ill-conditioned ones that force us to run a large number of iterations. This is exactly what we need to rigorously test our implementation.\u003C/p>\n\u003Ch2 id=\"memory-and-computation-trade-off\">Memory and Computation Trade-off\u003C/h2>\n\u003Cp>We measure the algorithm against two hypotheses on a large sparse problem with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>500\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=500,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">500\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>, varying the number of iterations \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>\u003Cstrong>Hypothesis 1 (Memory):\u003C/strong> The one-pass method stores the full basis \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> with complexity \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>k\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nk)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>. We expect its memory to grow linearly with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. The two-pass method operates with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> memory, so it should have a flat profile.\u003C/p>\n\u003Cp>\u003Cstrong>Hypothesis 2 (Runtime):\u003C/strong> The two-pass method performs \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products instead of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>. If all else were equal, weâ€™d expect it to run twice as slow.\u003C/p>\n\u003Ch3 id=\"memory-usage\">Memory Usage\u003C/h3>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/tradeoff_arcs500k_rho3_memory.png\" alt=\"Memory vs Iterations\">\u003C/p>\n\u003Cp>The memory data confirms Hypothesis 1 exactly. The one-pass methodâ€™s footprint scales as a straight lineâ€”each additional iteration adds one vector to the basis. The two-pass method remains flat. No allocation growth happens after initialization.\u003C/p>\n\u003Ch3 id=\"runtime-where-theory-breaks\">Runtime: Where Theory Breaks\u003C/h3>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/tradeoff_arcs500k_rho3_time.png\" alt=\"Runtime vs Iterations\">\u003C/p>\n\u003Cp>The runtime data contradicts Hypothesis 2. The two-pass method is slower, but never by a factor of two. For small \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the gap is minimal. As \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> grows, the two-pass runtime diverges slowly from the one-pass method, not by doubling, but by a much smaller margin.\u003C/p>\n\u003Cp>This difference comes from memory access patterns. Both methods perform matrix-vector products, but they differ in how they reconstruct the solution.\u003C/p>\n\u003Cp>The one-pass method computes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmo>=\u003C/mo>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k = \\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> in a single dense matrix-vector product. When \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> are large, the \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> basis matrix exceeds all cache levels. The CPU cannot keep the data resident; instead, it streams \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> from main memory. This is a memory-bandwidth-bound operation. The processor stalls, waiting for each load to complete. Instruction-level parallelism collapses.\u003C/p>\n\u003Cp>The two-pass method reconstructs the solution incrementally. At each iteration, it operates on exactly three n-dimensional vectors: \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmtext>prev\u003C/mtext>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{\\text{prev}}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7305em;vertical-align:-0.2861em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord text mtight\">\u003Cspan class=\"mord mtight\">prev\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.2861em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">v\u003C/mi>\u003Cmtext>curr\u003C/mtext>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{v}_{\\text{curr}}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">v\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.1514em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord text mtight\">\u003Cspan class=\"mord mtight\">curr\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">x\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{x}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5944em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\">x\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>. This working set fits in L1 cache. The processor performs \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products (each one reading the sparse operator, then applying it to a cached vector), but the solution accumulation happens entirely within cache. The additional matrix-vector products are cheaper than the memory latency of the standard method.\u003C/p>\n\u003Cp>The cost of re-computing basis vectors is less than the latency cost of scanning an \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>Ã—\u003C/mo>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n \\times k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">Ã—\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> dense matrix from main memory.\u003C/p>\n\u003Ch3 id=\"medium-scale-behavior\">Medium-Scale Behavior\u003C/h3>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/tradeoff_arcs50k_rho3_time.png\" alt=\"Medium Scale Runtime vs Iterations\">\n\u003Cimg src=\"/assets/lanczos/tradeoff_arcs50k_rho3_memory.png\" alt=\"Medium Scale Memory Usage vs Iterations\">\u003C/p>\n\u003Cp>At \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>50\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=50,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">50\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span> we can observe an equilibrium. The two methods have nearly identical runtime. The standard methodâ€™s \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8361em;vertical-align:-0.15em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix is smaller; it fits partially in cache. The cache-miss penalty here becomes manageable. The two-pass method still has the advantage of cache-local accumulation, but the difference is marginal.\u003C/p>\n\u003Ch3 id=\"what-about-dense-matrices\">What About Dense Matrices?\u003C/h3>\n\u003Cp>To be sure of our hypothesis, we can test it directly using a dense matrix of size \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>10\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=10,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">10\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For dense problems, the matrix-vector product is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>n\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n^2)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, it dominates all other costs. Memory latency will become negligible relative to the compute work and the cache efficiency advantage should disappear.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/dense-tradeoff.png\" alt=\"Dense Matrix Runtime vs Iterations\">\u003C/p>\n\u003Cp>We can see that the two-pass method runs almost exactly twice as slow as the one-pass method. The slope ratio is \u003Cem>exactly\u003C/em> 2:1. In a compute-bound regime, the extra matrix-vector products cannot be hidden by cache effects. Here, the theoretical trade-off holds perfectly.\u003C/p>\n\u003Ch2 id=\"scalability\">Scalability\u003C/h2>\n\u003Cp>Now, letâ€™s fix the iteration count at \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>500\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k=500\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">500\u003C/span>\u003C/span>\u003C/span>\u003C/span> and vary \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> from \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>50\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">50,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">50\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span> to \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>500\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">500,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">500\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span> to measure scalability. Based on what we have seen before, we would expect the two-pass memory to scale linearly with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> but with a small constant factor (three vectors, plus scalars). The one-pass method should also scale linearly, but with a \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>-dependent slope.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/scalability_k500_rho3_memory.png\" alt=\"Scalability Memory Usage\">\u003C/p>\n\u003Cp>Here we have to use a logarithmic y-axis to show both curves; the two-pass line is so flat relative to the one-pass line that itâ€™s otherwise invisible.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/lanczos/scalability_k500_rho3_time.png\" alt=\"Scalability Runtime\">\u003C/p>\n\u003Cp>Runtime scales linearly with \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> for both methods, as expected. Below \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>150\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n=150,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">150\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the two methods have similar performance. This is the regime where both basis and working set fit in cache, or where the problem is small enough that memory latency is not the bottleneck.\u003C/p>\n\u003Cp>As \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> increases beyond \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>150\u003C/mn>\u003Cmo separator=\"true\">,\u003C/mo>\u003Cmn>000\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">150,000\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">150\u003C/span>\u003Cspan class=\"mpunct\">,\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\">000\u003C/span>\u003C/span>\u003C/span>\u003C/span>, the matrix-vector product time dominates. The sparse structure of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi mathvariant=\"bold\">A\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{A}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6861em;\">\u003C/span>\u003Cspan class=\"mord mathbf\">A\u003C/span>\u003C/span>\u003C/span>\u003C/span> ensures that each matvec requires multiple memory accesses per element. For the one-pass method, the final reconstruction of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsub>\u003Cmi mathvariant=\"bold\">V\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003Cmsub>\u003Cmi mathvariant=\"bold\">y\u003C/mi>\u003Cmi>k\u003C/mi>\u003C/msub>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\mathbf{V}_k \\mathbf{y}_k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8805em;vertical-align:-0.1944em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">V\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathbf\" style=\"margin-right:0.01597em;\">y\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3361em;\">\u003Cspan style=\"top:-2.55em;margin-left:-0.016em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> begins to cost more as the matrix grows. For the two-pass method, performing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmi>k\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span> matrix-vector products means the matvec cost accumulates more rapidly. The divergence is gradual, not sharp, because the advantage of cache locality in accumulation persistsâ€”but it cannot overcome the fundamental cost of doubling the number of expensive operations.\u003C/p>\n\u003Chr>\n\u003Cp>Well, thatâ€™s it. If you want to have a better look at the code or use it, itâ€™s all open source:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos\">Github Repository\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://github.com/lukefleed/two-pass-lanczos/raw/master/tex/report.pdf\">LaTeX Report\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>This was more of an exploration than a production-ready library, so expect rough edges. But I hope it gives an interesting perspective on how algorithm engineering and low-level implementation details can alter what seems like a straightforward trade-off on a blackboard.\u003C/p>",{"headings":208,"localImagePaths":288,"remoteImagePaths":289,"frontmatter":290,"imagePaths":293},[209,212,216,219,222,225,228,231,234,237,240,243,246,249,252,255,258,261,264,267,270,273,276,279,282,285],{"depth":32,"slug":210,"text":211},"table-of-contents","Table of Contents",{"depth":213,"slug":214,"text":215},1,"computing-matrix-functions","Computing Matrix Functions",{"depth":32,"slug":217,"text":218},"krylov-projection","Krylov Projection",{"depth":131,"slug":220,"text":221},"building-an-orthonormal-basis","Building an Orthonormal Basis",{"depth":131,"slug":223,"text":224},"solving-in-the-reduced-space","Solving in the Reduced Space",{"depth":213,"slug":226,"text":227},"the-lanczos-algorithm","The Lanczos Algorithm",{"depth":32,"slug":229,"text":230},"three-term-recurrence","Three-Term Recurrence",{"depth":32,"slug":232,"text":233},"reconstructing-the-solution","Reconstructing the Solution",{"depth":213,"slug":235,"text":236},"two-pass-algorithm","Two-Pass Algorithm",{"depth":32,"slug":238,"text":239},"first-pass-compute-the-projected-problem","First Pass: Compute the Projected Problem",{"depth":32,"slug":241,"text":242},"second-pass-reconstruct-and-accumulate","Second Pass: Reconstruct and Accumulate",{"depth":131,"slug":244,"text":245},"a-subtle-numerical-point","A Subtle Numerical Point",{"depth":213,"slug":247,"text":248},"implementation","Implementation",{"depth":32,"slug":250,"text":251},"recurrence-step","Recurrence Step",{"depth":32,"slug":253,"text":254},"an-iterator-for-state-management","An Iterator for State Management",{"depth":32,"slug":256,"text":257},"first-pass-computing-the-decomposition","First Pass: Computing the Decomposition",{"depth":32,"slug":259,"text":260},"second-pass-reconstructing-the-solution","Second Pass: Reconstructing the Solution",{"depth":32,"slug":262,"text":263},"the-public-api","The Public API",{"depth":131,"slug":265,"text":266},"example-solving-a-linear-system","Example: Solving a Linear System",{"depth":213,"slug":268,"text":269},"some-interesting-results","Some interesting results",{"depth":32,"slug":271,"text":272},"memory-and-computation-trade-off","Memory and Computation Trade-off",{"depth":131,"slug":274,"text":275},"memory-usage","Memory Usage",{"depth":131,"slug":277,"text":278},"runtime-where-theory-breaks","Runtime: Where Theory Breaks",{"depth":131,"slug":280,"text":281},"medium-scale-behavior","Medium-Scale Behavior",{"depth":131,"slug":283,"text":284},"what-about-dense-matrices","What About Dense Matrices?",{"depth":32,"slug":286,"text":287},"scalability","Scalability",[],[],{"author":14,"pubDatetime":291,"title":197,"slug":193,"featured":198,"draft":17,"tags":292,"description":201},["Date","2025-11-11T00:00:00.000Z"],[200,69],[],"thread-safe-fixedvec",{"id":294,"data":296,"body":302,"filePath":303,"digest":304,"rendered":305},{"author":14,"pubDatetime":297,"title":298,"featured":198,"draft":198,"tags":299,"description":301},["Date","2025-09-16T00:00:00.000Z"],"Building a Thread-Safe, Bit-Packed Atomic Vector in Rust",[200,300],"Succinct Data Structures","Engineering a thread-safe, bit-packed integer vector in Rust, using a hybrid model of lock-free and lock-based concurrency to handle operations that span hardware word boundaries.","This is the second post of a series on how to build a memory-efficient vector in Rust. All this work is open source and is currently being used for research projects in succinct data structures.\n\n* All the code can be found on github: [compressed-intvec](https://github.com/lukefleed/compressed-intvec)\n* This is also published as a crate on crates.io: [compressed-intvec](https://crates.io/crates/compressed-intvec)\n\n## Table of Contents\n\nIn the [first post]([link-to-part-1](https://lukefleed.xyz/posts/compressed-fixedvec/)), we built `FixedVec`, a bit-packed integer vector that gives us O(1) random access while using a fraction of the memory of a standard `Vec\u003CT>`. We worked through the core problem of reading bit-packed data, and saw how a single unaligned memory read could let us efficiently handle values that span across 64-bit word boundaries. We ended up with a solid, fast data structure complete with a clean, ergonomic API.\n\nSo, we have a great single-threaded vector. But what happens when we need to share it between threads? The natural next step is to build an `AtomicFixedVec` with an API that feels like Rust's standard atomics: `load`, `store`, `fetch_add`, and so on.\n\nAs soon as we try, we hit a wall. The atomic instructions our CPUs give us work on nicely aligned, word-sized chunks of memory. But our data doesn't live like that. A 10-bit integer in our vector is just a virtual concept, a sequence of bits that might start in the middle of one `u64` and end in another.\n\nThis leads to the fundamental problem: how can we possibly implement an atomic `fetch_add` on a value that's physically split across two different `AtomicU64`s? There's no single hardware instruction that can atomically modify two memory locations at once. A naive attempt would create torn writes and all sorts of nasty data races.\n\nIn this post, we're going to walk through the engineering behind `AtomicFixedVec` and solve this problem. The solution is a hybrid model that combines lock-free, high-performance CAS loops for the common case with a fine-grained locking mechanism to correctly and safely handle the values that span word boundaries.\n\n# Structure\n\nTo make `FixedVec` support concurrency, we have to make some changes in its internal design. The first step is to change the backing storage. A `Vec\u003CT>` is not thread-safe for concurrent writes. We can replace it with a `Vec\u003CAtomicU64>`. This ensures that every individual read and write to a 64-bit word is, at a minimum, atomic.\n\nHowever, as we've established, a logical element can span two of these atomic words. A simple `Vec\u003CAtomicU64>` does not solve the problem of atomically updating a value that crosses a word boundary. To handle this, we can add a second component to our struct: a striped lock pool. This is a vector of `parking_lot::Mutex` instances, where the number of locks is a power of two. Each lock protects a subset of the `AtomicU64` words in our storage. When an operation needs to modify two adjacent words, it will acquire the appropriate locks to ensure exclusive access.\n\nWe can then define the `AtomicFixedVec` struct as follows:\n\n```rust\npub struct AtomicFixedVec\u003CT>\nwhere\n    T: Storable\u003Cu64>,\n{\n    // The backing store is now composed of atomic words.\n    storage: Vec\u003CAtomicU64>,\n    // A pool of fine-grained locks to protect spanning-word operations.\n    locks: Vec\u003CMutex\u003C()>>,\n    bit_width: usize,\n    mask: u64,\n    len: usize,\n}\n```\n\n This lock pool is the mechanism we will use to enforce atomicity for operations that must modify two adjacent words simultaneously.\n\nWith this structure in place, we can now design a hybrid concurrency model. Every operation must first determine if the target element is fully contained within a single `AtomicU64` or if it spans two. Based on this, it will dispatch to one of two paths: a high-performance, lock-free path for in-word elements, or a lock-based path that uses our striped lock pool for spanning elements.\n\n## Lock-Free path for In-Word Elements\n\nThe high-throughput path in our hybrid model is for elements that are fully contained within a single `AtomicU64`. This condition, `bit_offset + bit_width \u003C= 64`, is always met if the `bit_width` is a power of two (e.g., 2, 4, 8, 16, 32), making `BitWidth::PowerOfTwo` an explicit performance choice for write-heavy concurrent workloads. When this condition holds, we can perform a true lock-free atomic update using a **Compare-and-Swap (CAS) loop**.\n\nA CAS operation is an atomic instruction provided by the hardware (e.g., `CMPXCHG` on x86-64) that attempts to write a new value to a memory location only if the current value at that location matches a given expected value. This provides the primitive for building more complex atomic operations without locks.\n\nLet's try to implement an atomic `store` on a sub-word element. We cannot simply write the new value, as that would non-atomically overwrite adjacent elements in the same word. The operation must be a read-modify-write on the entire `AtomicU64`, where the \"modify\" step only alters the bits corresponding to our target element.\n\nWe begin by calculating the `word_index` and `bit_offset`.\n\n```rust\nlet bit_pos = index * self.bit_width;\nlet word_index = bit_pos / u64::BITS as usize;\nlet bit_offset = bit_pos % u64::BITS as usize;\n```\n\nWe then prepare a `store_mask` to isolate the target bit range and a `store_value` with the new value already shifted into position.\n\n```rust\nlet store_mask = self.mask \u003C\u003C bit_offset;\nlet store_value = value \u003C\u003C bit_offset;\n```\n\nThe core of the operation is the loop. We first perform a relaxed load to get the current state of the entire 64-bit word. Inside the loop, we compute `new_word` by using the mask to clear the target bits in our local copy (`old_word`) and then OR in the new value.\n\n```rust\nlet atomic_word_ref = &self.storage[word_index];\nlet mut old_word = atomic_word_ref.load(Ordering::Relaxed);\nloop {\n    let new_word = (old_word & !store_mask) | store_value;\n    match atomic_word_ref.compare_exchange_weak(\n        old_word,\n        new_word,\n        order,\n        Ordering::Relaxed,\n    ) {\n        Ok(_) => break,\n        Err(x) => old_word = x,\n    }\n}\n```\n\nThe critical instruction is `compare_exchange_weak`. It attempts to atomically replace the value at `atomic_word_ref` with `new_word`, but only if its current value is still equal to `old_word`. If another thread has modified the word in the meantime, the operation fails, returns the now-current value, and our loop continues with the updated `old_word`. We use the `weak` variant because it can be more performant on some architectures and is perfectly suitable within a retry loop. Putting everything together, we obtain the following `atomic_store` implementation for the lock-free path:\n\n```rust\nfn atomic_store(&self, index: usize, value: u64, order: Ordering) {\n    let bit_pos = index * self.bit_width;\n    let word_index = bit_pos / u64::BITS as usize;\n    let bit_offset = bit_pos % u64::BITS as usize;\n\n    // Lock-free path for single-word values.\n    let atomic_word_ref = &self.storage[word_index];\n    let store_mask = self.mask \u003C\u003C bit_offset;\n    let store_value = value \u003C\u003C bit_offset;\n    let mut old_word = atomic_word_ref.load(Ordering::Relaxed);\n    loop {\n        let new_word = (old_word & !store_mask) | store_value;\n        match atomic_word_ref.compare_exchange_weak(\n            old_word,\n            new_word,\n            order,\n            Ordering::Relaxed,\n        ) {\n            Ok(_) => break,\n            Err(x) => old_word = x,\n        }\n    }\n```\n\nThis entire path is lock-free. Contention is managed at the hardware level by the CPU's cache coherency protocol, which ensures that only one core can successfully commit a CAS operation to a given cache line at a time.\n\nIn the same way, we can implement other atomic operations like `atomic_rmw` (for `fetch_add`, `fetch_sub`, etc.) and `atomic_load` using similar CAS loops or direct atomic loads.\n\n## Lock-Based Path for Spanning Elements\n\nNow let's move to the more complex case when an element spans two `AtomicU64` words. Here the lock-free CAS loop is no longer enough. An atomic update would require to modify two separate `AtomicU64` words, and no single hardware instruction can do this as one indivisible transaction. To ensure atomicity, we must use a lock.\n\nA single, global `Mutex` would serialize all concurrent writes, becoming an unacceptable performance bottleneck.  We can instead employ **lock striping**, a concurrency pattern that partitions the data structure to reduce the scope of contention. The core idea is to maintain an array of locks, and map different regions of our data to different locks. We can add to our `AtomicFixedVec` a `Vec\u003Cparking_lot::Mutex\u003C()>>`. To perform an operation on a spanning element that touches `word_index` and `word_index + 1`, a thread first acquires a specific lock from this pool. The mapping is done by hashing the word index to a lock index. Since the number of locks is a power of two, we can use a fast bitwise AND for this mapping instead of a slower modulo operation: `let lock_index = word_index & (self.locks.len() - 1)`.\n\nIn this way we are partitioning the vector into a set of independent regions. A locked write to words `(i, i+1)` will not block a simultaneous locked write to words `(j, j+1)` or a lock-free write to word `k`, provided they map to different locks in the stripe. We now need a heuristic to determine, at construction time, how many locks to create. Ideally we would like to balance contention reduction against memory overhead. This could be a valuable option:\n\n```rust\n// Heuristic to determine the number of locks for striping.\nlet num_cores = std::thread::available_parallelism().map_or(MIN_LOCKS, |n| n.get());\nlet target_locks = (num_words / WORDS_PER_LOCK).max(1);\nlet num_locks = (target_locks.max(num_cores) * 2)\n    .next_power_of_two()\n    .min(MAX_LOCKS);\n```\n\nThe logic aims to create enough locks to service the available hardware threads (`num_cores`) and to cover the data with a reasonable density (one lock per 64 words, `WORDS_PER_LOCK`). We take the maximum of these two, multiply by two as a simple overprovisioning factor, and round up to the next power of two to enable fast mapping via bitwise AND. The total number of locks is capped to prevent excessive memory consumption for the lock vector itself.\n\n> **In this the best way?** I don't know, probably not. For instance, a *seqlock* could theoretically offer higher performance for read-heavy workloads. A writer would increment a version counter, perform the non-atomic two-word write, and increment it again. Readers would check for a consistent version number to validate that their read was not interrupted. However, this pattern is fundamentally incompatible with Rust's safety guarantees. A reader in a seqlock might observe a \"torn read\" (a state where one word has been updated but the other has not). This constitutes a data race, which safe Rust's memory model is designed to prevent. A correct seqlock implementation requires a ton of `unsafe` code, volatile reads, and careful memory fencing. Given this constrains (and that I am not an expert in lock-free programming), we can stick to the simpler yet performant implementation bases on `Mutex`. At least, power of two `bit_width` values can avoid the spanning case entirely.\n\nWith the lock striping mechanism cleared, we can now complete the implementation for our `atomic_store` method. The first step is to acquire the correct lock.\n\n```rust\nlet lock_index = word_index & (self.locks.len() - 1);\nlet _guard = self.locks[lock_index].lock();\n```\n\nOnce the lock is acquired, we have exclusive access for this two-word transaction. However, it's critical that we continue to use atomic operations to modify the words themselves. This is because another thread might be concurrently executing a *lock-free* operation on an adjacent, non-spanning element that happens to reside in `word_index` or `word_index + 1`. Using non-atomic writes inside the lock would create a data race with those lock-free operations.\n\nWe therefore use `fetch_update`, another CAS-based atomic, to modify each of the two words. For the lower word, we clear the high bits starting from our `bit_offset` and OR in the low bits of our new value.\n\n```rust\nlet low_word_ref = &self.storage[word_index];\nlet high_word_ref = &self.storage[word_index + 1];\n\n// Modify the lower word.\nlow_word_ref\n    .fetch_update(order, Ordering::Relaxed, |mut w| {\n        w &= !(u64::MAX \u003C\u003C bit_offset);\n        w |= value \u003C\u003C bit_offset;\n        Some(w)\n    })\n    .unwrap(); // This unwrap is safe: with the lock held, there is no contention.\n```\n\nNext, we do the same for the higher word, calculating a `high_mask` to clear the low bits and writing the remaining high bits of our value.\n\n```rust\nlet bits_in_high = (bit_offset + self.bit_width) - u64::BITS as usize;\nlet high_mask = (1u64 \u003C\u003C bits_in_high).wrapping_sub(1);\nhigh_word_ref\n    .fetch_update(order, Ordering::Relaxed, |mut w| {\n        w &= !high_mask;\n        w |= value >> (u64::BITS as usize - bit_offset);\n        Some(w)\n    })\n    .unwrap(); // Also safe.\n```\n\nThe lock provides the mutual exclusion that makes the two-word update appear atomic as a whole. The continued use of atomics with the user-specified `Ordering` ensures that the final result is correctly propagated through the memory system and becomes visible to other threads according to the Rust memory model.\n\nPutting it all together, the final, complete `atomic_store` method handles both the lock-free and locked paths.\n\n```rust\nfn atomic_store(&self, index: usize, value: u64, order: Ordering) {\n    let bit_pos = index * self.bit_width;\n    let word_index = bit_pos / u64::BITS as usize;\n    let bit_offset = bit_pos % u64::BITS as usize;\n\n    if bit_offset + self.bit_width \u003C= u64::BITS as usize {\n        // Lock-free path for single-word values.\n        let atomic_word_ref = &self.storage[word_index];\n        let store_mask = self.mask \u003C\u003C bit_offset;\n        let store_value = value \u003C\u003C bit_offset;\n        let mut old_word = atomic_word_ref.load(Ordering::Relaxed);\n        loop {\n            let new_word = (old_word & !store_mask) | store_value;\n            match atomic_word_ref.compare_exchange_weak(\n                old_word,\n                new_word,\n                order,\n                Ordering::Relaxed,\n            ) {\n                Ok(_) => break,\n                Err(x) => old_word = x,\n            }\n        }\n    } else {\n        // Locked path for values spanning two words.\n        let lock_index = word_index & (self.locks.len() - 1);\n        let _guard = self.locks[lock_index].lock();\n        // The lock guarantees exclusive access to this multi-word operation.\n        // We still use atomic operations inside to prevent races with the\n        // lock-free path, which might be concurrently accessing one of\n        // these words.\n        let low_word_ref = &self.storage[word_index];\n        let high_word_ref = &self.storage[word_index + 1];\n\n        // Modify the lower word.\n        low_word_ref\n            .fetch_update(order, Ordering::Relaxed, |mut w| {\n                w &= !(u64::MAX \u003C\u003C bit_offset);\n                w |= value \u003C\u003C bit_offset;\n                Some(w)\n            })\n            .unwrap(); // Should not fail under lock.\n\n        // Modify the higher word.\n        let bits_in_high = (bit_offset + self.bit_width) - u64::BITS as usize;\n        let high_mask = (1u64 \u003C\u003C bits_in_high).wrapping_sub(1);\n        high_word_ref\n            .fetch_update(order, Ordering::Relaxed, |mut w| {\n                w &= !high_mask;\n                w |= value >> (u64::BITS as usize - bit_offset);\n                Some(w)\n            })\n            .unwrap(); // Should not fail under lock.\n    }\n}\n```\n\nThe branching logic `if bit_offset + self.bit_width \u003C= 64` is a simple, constant-time check that determines which path to take. The condition is highly predictable for the CPU's branch predictor, as the `bit_offset` follows a simple arithmetic progression based on the index. This minimizes pipeline stalls. More importantly, this structure enables significant compiler optimization. When we use `AtomicFixedVec` with a `bit_width` that is a power of two, the branch condition can often be resolved at compile time. With Link-Time Optimization (LTO), the compiler can prove that the `else` branch for the locked path is unreachable. This allows for dead code elimination, producing a specialized function containing *only* the lock-free CAS loop.\n\n# Benchmarking the `store` operation\n\nWe now want to measure the performance of our `atomic_store` implementation under concurred load. We want to know how the throughput of the `store` operation scales as we increase thread count and contention. We can create two benchmark scenarios, one with a bit-width that is a power of two, and one with a non-power-of-two bit-width. Both simulate \"diffuse contention\": a pool of threads performs a high volume of atomic `store` operations to random indices within a shared vector of 10k 64-bit elements. Each thread is assigned 100k operations. This randomness ensures that while direct contention on the same element is rare, there will be frequent collisions on the same `AtomicU64` words, especially as thread count increases.\n\nIn the benchmark, each thread with `thread_id` simply writes its own ID to the vector for each operation:\n\n```rust\nvec[index].store(thread_id, Ordering::SeqCst);\n```\n\nWe compare our `AtomicFixedVec` against two other implementations:\n1.  A `Vec\u003CAtomicU16>`: This serves as our \"ideal\" baseline.\n2.  [`sux::AtomicBitFieldVec`]: A similar implementation of another library. This comparison however is not perfectly equivalent for bit-widths that are not powers of two. As per their documentation, `sux` does not guarantee atomicity for values that span word boundaries, which can lead to \"torn writes.\" Our `AtomicFixedVec` is designed to prevent this class of data race through its lock striping mechanism. The performance cost of this correctness guarantee is precisely what we aim to measure.\n\nThe first benchmark measure the performance of our **lock-free path**. We configure all vectors with a `bit_width` of 16. Because 16 is a power of two and evenly divides the 64-bit word size, every element is guaranteed to be fully contained within a single `u64` word. This is the best-case scenario for bit-packed atomics. It ensures that all `store` operations can be performed with lock-free CAS loops.\n\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_lock_free_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nAs we can see, all three implementations scale well with increasing thread count. The throughput of `AtomicFixedVec` is very close to that of `sux::AtomicBitFieldVec`, which is expected since both are using similar lock-free CAS loops for this scenario. Both bit-packed vectors have a noticeable dip at two threads, likely due to initial cache coherency overhead, but then scale up effectively with the core count.\n\nThe second benchmark tries to stress the **locked path**. We configure the vectors with a `bit_width` of 15. This non-power-of-two width guarantees that a predictable fraction of writes will cross word boundaries. In our case, `(15 + 63) % 64` spanning cases out of 64 offsets, so roughly `14/64` or ~22% will require locking. This forces our `AtomicFixedVec` to use its lock striping mechanism for those spanning writes. In contrast, `sux` will proceed without locking, risking data races but avoiding locking overhead.\n\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_locked_path_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nThis benchmark shows the real cost of correctness. Our `AtomicFixedVec` now shows lower throughput and poorer scaling compared to both the baseline and `sux`. Every write operation that crosses a word boundary (approximately 22% of them in this test) must acquire a lock, execute its two atomic updates, and release the lock. While with lock striping we prevent a single point of serialization, the overhead of the locking protocol itself, especially under contention from multiple threads, is non-trivial. In contrast, `sux` maintains higher throughput by avoiding locks entirely, but at the cost of potentially observing torn writes.\n\n[`sux::AtomicBitFieldVec`]: https://docs.rs/sux/latest/sux/bits/bit_field_vec/struct.AtomicBitFieldVec.html\n\n# Read-Modify-Write Operations\n\nWith the hybrid atomicity model defined, the next step is to build a robust API. Instead of re-implementing the complex hybrid logic for every atomic operation, we can implement it once in a single, powerful primitive: `compare_exchange`. All other Read-Modify-Write (RMW) operations can then be built on top of this primitive.\n\n`compare_exchange` attempts to store a `new` value into a location if and only if the value currently at that location matches an expected `current` value. This operation is the fundamental building block for lock-free algorithms.\n\n## The Lock-Free Path: A CAS Loop on a Sub-Word\n\nFor elements that are fully contained within a single `AtomicU64`, we can implement `compare_exchange` with a CAS loop. However, the logic is more complex than a simple store. We aren't comparing the entire 64-bit word; we are comparing a specific `bit_width` slice within it.\n\nThe process is as follows. First, we load the entire 64-bit word. Then, we extract the specific bits that correspond to our logical element and compare them against the user-provided `current` value.\n\n```rust\n// Inside the lock-free path of atomic_compare_exchange\nlet mut old_word = atomic_word_ref.load(failure);\nloop {\n    let old_val_extracted = (old_word >> bit_offset) & self.mask;\n    if old_val_extracted != current {\n        return Err(old_val_extracted);\n    }\n    // ...\n```\n\nIf this check fails, it means another thread has modified the element since our initial load. We can immediately return an `Err` with the value we just read, satisfying the contract of `compare_exchange`.\n\nIf the check succeeds, we proceed to the atomic write phase. We prepare a `new_word` by masking and ORing in the `new` value, just as we did for `atomic_store`. Then we attempt the hardware-level `compare_exchange_weak`.\n\n```rust\n// ... continuing the loop ...\nlet new_word = (old_word & !store_mask) | new_value_shifted;\nmatch atomic_word_ref.compare_exchange_weak(old_word, new_word, success, failure) {\n    Ok(_) => return Ok(current),\n    Err(x) => old_word = x,\n}\n```\n\nIf the `compare_exchange_weak` succeeds, it means no other thread modified the 64-bit word between our initial `load` and this instruction. Our update is successful. If it fails, another thread (possibly operating on an *adjacent* element in the same word) has modified the word. We update our local `old_word` with the new value from memory and retry the entire loop.\n\n## The Locked Path\n\nFor elements that span two words, we need to use the lock striping mechanism to ensure the operation is transactional. First, we must acquire the appropriate lock, giving us exclusive access to the two-word region.\n\nOnce the lock is held, the logic is straightforward:\n\n1.  **Read:** We perform an atomic read of the spanning value. This is itself a locked operation to ensure we get a consistent view.\n2.  **Compare:** We compare this value against the user-provided `current`. If they don't match, we release the lock and immediately return `Err`.\n3.  **Write:** If they do match, we call our existing `atomic_store` method to write the `new` value. `atomic_store` will re-acquire the same lock to perform its two-word write.\n4.  **Return:** We release the lock and return `Ok`.\n\nBecause the entire read-compare-write sequence is protected by the same mutex, we guarantee that no other thread can interfere. Combining these two paths gives us the complete `atomic_compare_exchange` method, which can then be used to implement all other atomic operations in terms of it.\n\n```rust\nfn atomic_compare_exchange(\n    &self,\n    index: usize,\n    current: u64,\n    new: u64,\n    success: Ordering,\n    failure: Ordering,\n) -> Result\u003Cu64, u64> {\n    let bit_pos = index * self.bit_width;\n    let word_index = bit_pos / u64::BITS as usize;\n    let bit_offset = bit_pos % u64::BITS as usize;\n\n    if bit_offset + self.bit_width \u003C= u64::BITS as usize {\n        // Lock-free path\n        let atomic_word_ref = &self.storage[word_index];\n        let store_mask = self.mask \u003C\u003C bit_offset;\n        let new_value_shifted = new \u003C\u003C bit_offset;\n        let mut old_word = atomic_word_ref.load(failure);\n        loop {\n            let old_val_extracted = (old_word >> bit_offset) & self.mask;\n            if old_val_extracted != current {\n                return Err(old_val_extracted);\n            }\n            let new_word = (old_word & !store_mask) | new_value_shifted;\n            match atomic_word_ref.compare_exchange_weak(old_word, new_word, success, failure) {\n                Ok(_) => return Ok(current),\n                Err(x) => old_word = x,\n            }\n        }\n    } else {\n        // Locked path\n        let lock_index = word_index & (self.locks.len() - 1);\n        let _guard = self.locks[lock_index].lock();\n        let old_val = self.atomic_load(index, failure);\n        if old_val != current {\n            return Err(old_val);\n        }\n        self.atomic_store(index, new, success);\n        Ok(current)\n    }\n}\n```\nWith `atomic_compare_exchange` providing the core atomicity primitive, we can now construct the high-level Read-Modify-Write (RMW) API. All RMW operations, such as `fetch_add` or `fetch_max`, share an identical algorithmic structure: a loop that repeatedly reads a value, computes a new value, and attempts to commit it with `compare_exchange`. Re-implementing this loop for every operation would be redundant.\n\nInstead, we can abstract this pattern into a single generic method, `atomic_rmw`, that is parameterized not just over values, but over the *operation itself*. This is where Rust generics and closures come into play. The signature of `atomic_rmw` can be defined as follows:\n\n```rust\nfn atomic_rmw\u003CF>(&self, index: usize, val: T, order: Ordering, op: F) -> T\nwhere\n    F: Fn(T, T) -> T\n{\n    // ... implementation ...\n}\n```\n*Note: The actual implementation uses `impl Fn(...)` for a more ergonomic syntax, but the principle is the same.*\n\nThe `op` parameter is a generic type `F` constrained by the `Fn(T, T) -> T` trait. This means `op` can be any closure (or function pointer) that takes two values of our logical type `T` and returns a new `T`. This allows us to inject any binary operationâ€”addition, bitwise AND, max, etc. directly into the RMW logic.\n\nTo implement `atomic_rmw`, we begin with a relaxed load to get an initial `current` value. Inside the loop, it invokes the `op` closure with the `current` value and the user-provided `val` to compute the `new` value.\n\n```rust\nlet mut current = self.load(index, Ordering::Relaxed);\nloop {\n    let new = op(current, val);\n    // ...\n```\n\nThe core of the loop is the call to `atomic_compare_exchange`. This attempts to commit the transaction.\n\n```rust\nmatch self.compare_exchange(index, current, new, order, Ordering::Relaxed) {\n    Ok(old) => return old,\n    Err(actual) => current = actual,\n}\n```\n\nIf the operation succeeds, we return the old value, satisfying the RMW contract. If it fails due to contention, `compare_exchange` returns the `actual` value now in memory. We update our local `current` and the loop repeats, re-applying the `op` closure on the newer value. The complete `atomic_rmw` method looks like this:\n\n```rust\nfn atomic_rmw(&self, index: usize, val: T, order: Ordering, op: impl Fn(T, T) -> T) -> T {\n    let mut current = self.load(index, Ordering::Relaxed);\n    loop {\n        let new = op(current, val);\n        match self.compare_exchange(index, current, new, order, Ordering::Relaxed) {\n            Ok(old) => return old,\n            Err(actual) => current = actual,\n        }\n    }\n}\n```\n\nBy parameterizing over the operation, we have completely decoupled the complex, low-level concurrency logic from the simple arithmetic or bitwise logic of each specific RMW operation. This allows the compiler to monomorphize and inline the `op` closure for each call site, resulting in specialized and efficient machine code for each RMW variant, giving us a zero-cost abstraction.\n\nNow implementing specific RMW methods becomes a straightforward exercise in composition. Each specific operation is now a simple non-looping wrapper that calls `atomic_rmw` and provides a closure defining the desired computation. For example, `fetch_add` is implemented by passing a closure that performs a wrapping addition.\n\n```rust\npub fn fetch_add(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.wrapping_add(&b))\n}\n```\n\nThe same pattern applies to all other RMW operations. A bitwise `fetch_and` provides a closure with the `&` operator, and `fetch_max` provides one that calls the `max` method.\n\n```rust\npub fn fetch_sub(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.wrapping_sub(&b))\n}\n\npub fn fetch_and(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a & b)\n}\n\npub fn fetch_or(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a | b)\n}\n\npub fn fetch_xor(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a ^ b)\n}\n\npub fn fetch_max(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.max(b))\n}\n\npub fn fetch_min(&self, index: usize, val: T, order: Ordering) -> T {\n    self.atomic_rmw(index, val, order, |a, b| a.min(b))\n}\n```","src/data/blog/thread-safe-fixedvec.md","16afc7e2a842b93d",{"html":306,"metadata":307},"\u003Cp>This is the second post of a series on how to build a memory-efficient vector in Rust. All this work is open source and is currently being used for research projects in succinct data structures.\u003C/p>\n\u003Cul>\n\u003Cli>All the code can be found on github: \u003Ca href=\"https://github.com/lukefleed/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003Cli>This is also published as a crate on crates.io: \u003Ca href=\"https://crates.io/crates/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"table-of-contents\">Table of Contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of Contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#structure\">Structure\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#lock-free-path-for-in-word-elements\">Lock-Free path for In-Word Elements\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#lock-based-path-for-spanning-elements\">Lock-Based Path for Spanning Elements\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#benchmarking-the-store-operation\">Benchmarking the \u003Ccode>store\u003C/code> operation\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#read-modify-write-operations\">Read-Modify-Write Operations\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-lock-free-path-a-cas-loop-on-a-sub-word\">The Lock-Free Path: A CAS Loop on a Sub-Word\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-locked-path\">The Locked Path\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch1 id=\"structure\">Structure\u003C/h1>\n\u003Cp>To make \u003Ccode>FixedVec\u003C/code> support concurrency, we have to make some changes in its internal design. The first step is to change the backing storage. A \u003Ccode>Vec&#x3C;T>\u003C/code> is not thread-safe for concurrent writes. We can replace it with a \u003Ccode>Vec&#x3C;AtomicU64>\u003C/code>. This ensures that every individual read and write to a 64-bit word is, at a minimum, atomic.\u003C/p>\n\u003Cp>However, as weâ€™ve established, a logical element can span two of these atomic words. A simple \u003Ccode>Vec&#x3C;AtomicU64>\u003C/code> does not solve the problem of atomically updating a value that crosses a word boundary. To handle this, we can add a second component to our struct: a striped lock pool. This is a vector of \u003Ccode>parking_lot::Mutex\u003C/code> instances, where the number of locks is a power of two. Each lock protects a subset of the \u003Ccode>AtomicU64\u003C/code> words in our storage. When an operation needs to modify two adjacent words, it will acquire the appropriate locks to ensure exclusive access.\u003C/p>\n\u003Cp>We can then define the \u003Ccode>AtomicFixedVec\u003C/code> struct as follows:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AtomicFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The backing store is now composed of atomic words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    storage\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">AtomicU64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // A pool of fine-grained locks to protect spanning-word operations.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Mutex\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;()>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This lock pool is the mechanism we will use to enforce atomicity for operations that must modify two adjacent words simultaneously.\u003C/p>\n\u003Cp>With this structure in place, we can now design a hybrid concurrency model. Every operation must first determine if the target element is fully contained within a single \u003Ccode>AtomicU64\u003C/code> or if it spans two. Based on this, it will dispatch to one of two paths: a high-performance, lock-free path for in-word elements, or a lock-based path that uses our striped lock pool for spanning elements.\u003C/p>\n\u003Ch2 id=\"lock-free-path-for-in-word-elements\">Lock-Free path for In-Word Elements\u003C/h2>\n\u003Cp>The high-throughput path in our hybrid model is for elements that are fully contained within a single \u003Ccode>AtomicU64\u003C/code>. This condition, \u003Ccode>bit_offset + bit_width &#x3C;= 64\u003C/code>, is always met if the \u003Ccode>bit_width\u003C/code> is a power of two (e.g., 2, 4, 8, 16, 32), making \u003Ccode>BitWidth::PowerOfTwo\u003C/code> an explicit performance choice for write-heavy concurrent workloads. When this condition holds, we can perform a true lock-free atomic update using a \u003Cstrong>Compare-and-Swap (CAS) loop\u003C/strong>.\u003C/p>\n\u003Cp>A CAS operation is an atomic instruction provided by the hardware (e.g., \u003Ccode>CMPXCHG\u003C/code> on x86-64) that attempts to write a new value to a memory location only if the current value at that location matches a given expected value. This provides the primitive for building more complex atomic operations without locks.\u003C/p>\n\u003Cp>Letâ€™s try to implement an atomic \u003Ccode>store\u003C/code> on a sub-word element. We cannot simply write the new value, as that would non-atomically overwrite adjacent elements in the same word. The operation must be a read-modify-write on the entire \u003Ccode>AtomicU64\u003C/code>, where the â€œmodifyâ€ step only alters the bits corresponding to our target element.\u003C/p>\n\u003Cp>We begin by calculating the \u003Ccode>word_index\u003C/code> and \u003Ccode>bit_offset\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We then prepare a \u003Ccode>store_mask\u003C/code> to isolate the target bit range and a \u003Ccode>store_value\u003C/code> with the new value already shifted into position.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The core of the operation is the loop. We first perform a relaxed load to get the current state of the entire 64-bit word. Inside the loop, we compute \u003Ccode>new_word\u003C/code> by using the mask to clear the target bits in our local copy (\u003Ccode>old_word\u003C/code>) and then OR in the new value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The critical instruction is \u003Ccode>compare_exchange_weak\u003C/code>. It attempts to atomically replace the value at \u003Ccode>atomic_word_ref\u003C/code> with \u003Ccode>new_word\u003C/code>, but only if its current value is still equal to \u003Ccode>old_word\u003C/code>. If another thread has modified the word in the meantime, the operation fails, returns the now-current value, and our loop continues with the updated \u003Ccode>old_word\u003C/code>. We use the \u003Ccode>weak\u003C/code> variant because it can be more performant on some architectures and is perfectly suitable within a retry loop. Putting everything together, we obtain the following \u003Ccode>atomic_store\u003C/code> implementation for the lock-free path:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Lock-free path for single-word values.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This entire path is lock-free. Contention is managed at the hardware level by the CPUâ€™s cache coherency protocol, which ensures that only one core can successfully commit a CAS operation to a given cache line at a time.\u003C/p>\n\u003Cp>In the same way, we can implement other atomic operations like \u003Ccode>atomic_rmw\u003C/code> (for \u003Ccode>fetch_add\u003C/code>, \u003Ccode>fetch_sub\u003C/code>, etc.) and \u003Ccode>atomic_load\u003C/code> using similar CAS loops or direct atomic loads.\u003C/p>\n\u003Ch2 id=\"lock-based-path-for-spanning-elements\">Lock-Based Path for Spanning Elements\u003C/h2>\n\u003Cp>Now letâ€™s move to the more complex case when an element spans two \u003Ccode>AtomicU64\u003C/code> words. Here the lock-free CAS loop is no longer enough. An atomic update would require to modify two separate \u003Ccode>AtomicU64\u003C/code> words, and no single hardware instruction can do this as one indivisible transaction. To ensure atomicity, we must use a lock.\u003C/p>\n\u003Cp>A single, global \u003Ccode>Mutex\u003C/code> would serialize all concurrent writes, becoming an unacceptable performance bottleneck.  We can instead employ \u003Cstrong>lock striping\u003C/strong>, a concurrency pattern that partitions the data structure to reduce the scope of contention. The core idea is to maintain an array of locks, and map different regions of our data to different locks. We can add to our \u003Ccode>AtomicFixedVec\u003C/code> a \u003Ccode>Vec&#x3C;parking_lot::Mutex&#x3C;()>>\u003C/code>. To perform an operation on a spanning element that touches \u003Ccode>word_index\u003C/code> and \u003Ccode>word_index + 1\u003C/code>, a thread first acquires a specific lock from this pool. The mapping is done by hashing the word index to a lock index. Since the number of locks is a power of two, we can use a fast bitwise AND for this mapping instead of a slower modulo operation: \u003Ccode>let lock_index = word_index &#x26; (self.locks.len() - 1)\u003C/code>.\u003C/p>\n\u003Cp>In this way we are partitioning the vector into a set of independent regions. A locked write to words \u003Ccode>(i, i+1)\u003C/code> will not block a simultaneous locked write to words \u003Ccode>(j, j+1)\u003C/code> or a lock-free write to word \u003Ccode>k\u003C/code>, provided they map to different locks in the stripe. We now need a heuristic to determine, at construction time, how many locks to create. Ideally we would like to balance contention reduction against memory overhead. This could be a valuable option:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Heuristic to determine the number of locks for striping.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> num_cores\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">thread\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">available_parallelism\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MIN_LOCKS\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> target_locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">num_words\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> WORDS_PER_LOCK\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> num_locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">target_locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">num_cores\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">next_power_of_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">min\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MAX_LOCKS\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The logic aims to create enough locks to service the available hardware threads (\u003Ccode>num_cores\u003C/code>) and to cover the data with a reasonable density (one lock per 64 words, \u003Ccode>WORDS_PER_LOCK\u003C/code>). We take the maximum of these two, multiply by two as a simple overprovisioning factor, and round up to the next power of two to enable fast mapping via bitwise AND. The total number of locks is capped to prevent excessive memory consumption for the lock vector itself.\u003C/p>\n\u003Cblockquote>\n\u003Cp>\u003Cstrong>In this the best way?\u003C/strong> I donâ€™t know, probably not. For instance, a \u003Cem>seqlock\u003C/em> could theoretically offer higher performance for read-heavy workloads. A writer would increment a version counter, perform the non-atomic two-word write, and increment it again. Readers would check for a consistent version number to validate that their read was not interrupted. However, this pattern is fundamentally incompatible with Rustâ€™s safety guarantees. A reader in a seqlock might observe a â€œtorn readâ€ (a state where one word has been updated but the other has not). This constitutes a data race, which safe Rustâ€™s memory model is designed to prevent. A correct seqlock implementation requires a ton of \u003Ccode>unsafe\u003C/code> code, volatile reads, and careful memory fencing. Given this constrains (and that I am not an expert in lock-free programming), we can stick to the simpler yet performant implementation bases on \u003Ccode>Mutex\u003C/code>. At least, power of two \u003Ccode>bit_width\u003C/code> values can avoid the spanning case entirely.\u003C/p>\n\u003C/blockquote>\n\u003Cp>With the lock striping mechanism cleared, we can now complete the implementation for our \u003Ccode>atomic_store\u003C/code> method. The first step is to acquire the correct lock.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> _guard\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Once the lock is acquired, we have exclusive access for this two-word transaction. However, itâ€™s critical that we continue to use atomic operations to modify the words themselves. This is because another thread might be concurrently executing a \u003Cem>lock-free\u003C/em> operation on an adjacent, non-spanning element that happens to reside in \u003Ccode>word_index\u003C/code> or \u003Ccode>word_index + 1\u003C/code>. Using non-atomic writes inside the lock would create a data race with those lock-free operations.\u003C/p>\n\u003Cp>We therefore use \u003Ccode>fetch_update\u003C/code>, another CAS-based atomic, to modify each of the two words. For the lower word, we clear the high bits starting from our \u003Ccode>bit_offset\u003C/code> and OR in the low bits of our new value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Modify the lower word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MAX\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// This unwrap is safe: with the lock held, there is no contention.\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Next, we do the same for the higher word, calculating a \u003Ccode>high_mask\u003C/code> to clear the low bits and writing the remaining high bits of our value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Also safe.\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The lock provides the mutual exclusion that makes the two-word update appear atomic as a whole. The continued use of atomics with the user-specified \u003Ccode>Ordering\u003C/code> ensures that the final result is correctly propagated through the memory system and becomes visible to other threads according to the Rust memory model.\u003C/p>\n\u003Cp>Putting it all together, the final, complete \u003Ccode>atomic_store\u003C/code> method handles both the lock-free and locked paths.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Lock-free path for single-word values.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            ) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Locked path for values spanning two words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> _guard\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // The lock guarantees exclusive access to this multi-word operation.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // We still use atomic operations inside to prevent races with the\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // lock-free path, which might be concurrently accessing one of\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // these words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Modify the lower word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        low_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">MAX\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Should not fail under lock.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Modify the higher word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bits_in_high\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        high_word_ref\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Should not fail under lock.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The branching logic \u003Ccode>if bit_offset + self.bit_width &#x3C;= 64\u003C/code> is a simple, constant-time check that determines which path to take. The condition is highly predictable for the CPUâ€™s branch predictor, as the \u003Ccode>bit_offset\u003C/code> follows a simple arithmetic progression based on the index. This minimizes pipeline stalls. More importantly, this structure enables significant compiler optimization. When we use \u003Ccode>AtomicFixedVec\u003C/code> with a \u003Ccode>bit_width\u003C/code> that is a power of two, the branch condition can often be resolved at compile time. With Link-Time Optimization (LTO), the compiler can prove that the \u003Ccode>else\u003C/code> branch for the locked path is unreachable. This allows for dead code elimination, producing a specialized function containing \u003Cem>only\u003C/em> the lock-free CAS loop.\u003C/p>\n\u003Ch1 id=\"benchmarking-the-store-operation\">Benchmarking the \u003Ccode>store\u003C/code> operation\u003C/h1>\n\u003Cp>We now want to measure the performance of our \u003Ccode>atomic_store\u003C/code> implementation under concurred load. We want to know how the throughput of the \u003Ccode>store\u003C/code> operation scales as we increase thread count and contention. We can create two benchmark scenarios, one with a bit-width that is a power of two, and one with a non-power-of-two bit-width. Both simulate â€œdiffuse contentionâ€: a pool of threads performs a high volume of atomic \u003Ccode>store\u003C/code> operations to random indices within a shared vector of 10k 64-bit elements. Each thread is assigned 100k operations. This randomness ensures that while direct contention on the same element is rare, there will be frequent collisions on the same \u003Ccode>AtomicU64\u003C/code> words, especially as thread count increases.\u003C/p>\n\u003Cp>In the benchmark, each thread with \u003Ccode>thread_id\u003C/code> simply writes its own ID to the vector for each operation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">thread_id\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">SeqCst\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We compare our \u003Ccode>AtomicFixedVec\u003C/code> against two other implementations:\u003C/p>\n\u003Col>\n\u003Cli>A \u003Ccode>Vec&#x3C;AtomicU16>\u003C/code>: This serves as our â€œidealâ€ baseline.\u003C/li>\n\u003Cli>\u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/struct.AtomicBitFieldVec.html\">\u003Ccode>sux::AtomicBitFieldVec\u003C/code>\u003C/a>: A similar implementation of another library. This comparison however is not perfectly equivalent for bit-widths that are not powers of two. As per their documentation, \u003Ccode>sux\u003C/code> does not guarantee atomicity for values that span word boundaries, which can lead to â€œtorn writes.â€ Our \u003Ccode>AtomicFixedVec\u003C/code> is designed to prevent this class of data race through its lock striping mechanism. The performance cost of this correctness guarantee is precisely what we aim to measure.\u003C/li>\n\u003C/ol>\n\u003Cp>The first benchmark measure the performance of our \u003Cstrong>lock-free path\u003C/strong>. We configure all vectors with a \u003Ccode>bit_width\u003C/code> of 16. Because 16 is a power of two and evenly divides the 64-bit word size, every element is guaranteed to be fully contained within a single \u003Ccode>u64\u003C/code> word. This is the best-case scenario for bit-packed atomics. It ensures that all \u003Ccode>store\u003C/code> operations can be performed with lock-free CAS loops.\u003C/p>\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_lock_free_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>As we can see, all three implementations scale well with increasing thread count. The throughput of \u003Ccode>AtomicFixedVec\u003C/code> is very close to that of \u003Ccode>sux::AtomicBitFieldVec\u003C/code>, which is expected since both are using similar lock-free CAS loops for this scenario. Both bit-packed vectors have a noticeable dip at two threads, likely due to initial cache coherency overhead, but then scale up effectively with the core count.\u003C/p>\n\u003Cp>The second benchmark tries to stress the \u003Cstrong>locked path\u003C/strong>. We configure the vectors with a \u003Ccode>bit_width\u003C/code> of 15. This non-power-of-two width guarantees that a predictable fraction of writes will cross word boundaries. In our case, \u003Ccode>(15 + 63) % 64\u003C/code> spanning cases out of 64 offsets, so roughly \u003Ccode>14/64\u003C/code> or ~22% will require locking. This forces our \u003Ccode>AtomicFixedVec\u003C/code> to use its lock striping mechanism for those spanning writes. In contrast, \u003Ccode>sux\u003C/code> will proceed without locking, risking data races but avoiding locking overhead.\u003C/p>\n\u003Ciframe src=\"/bench-intvec/atomic_scaling_locked_path_diffuse.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>This benchmark shows the real cost of correctness. Our \u003Ccode>AtomicFixedVec\u003C/code> now shows lower throughput and poorer scaling compared to both the baseline and \u003Ccode>sux\u003C/code>. Every write operation that crosses a word boundary (approximately 22% of them in this test) must acquire a lock, execute its two atomic updates, and release the lock. While with lock striping we prevent a single point of serialization, the overhead of the locking protocol itself, especially under contention from multiple threads, is non-trivial. In contrast, \u003Ccode>sux\u003C/code> maintains higher throughput by avoiding locks entirely, but at the cost of potentially observing torn writes.\u003C/p>\n\u003Ch1 id=\"read-modify-write-operations\">Read-Modify-Write Operations\u003C/h1>\n\u003Cp>With the hybrid atomicity model defined, the next step is to build a robust API. Instead of re-implementing the complex hybrid logic for every atomic operation, we can implement it once in a single, powerful primitive: \u003Ccode>compare_exchange\u003C/code>. All other Read-Modify-Write (RMW) operations can then be built on top of this primitive.\u003C/p>\n\u003Cp>\u003Ccode>compare_exchange\u003C/code> attempts to store a \u003Ccode>new\u003C/code> value into a location if and only if the value currently at that location matches an expected \u003Ccode>current\u003C/code> value. This operation is the fundamental building block for lock-free algorithms.\u003C/p>\n\u003Ch2 id=\"the-lock-free-path-a-cas-loop-on-a-sub-word\">The Lock-Free Path: A CAS Loop on a Sub-Word\u003C/h2>\n\u003Cp>For elements that are fully contained within a single \u003Ccode>AtomicU64\u003C/code>, we can implement \u003Ccode>compare_exchange\u003C/code> with a CAS loop. However, the logic is more complex than a simple store. We arenâ€™t comparing the entire 64-bit word; we are comparing a specific \u003Ccode>bit_width\u003C/code> slice within it.\u003C/p>\n\u003Cp>The process is as follows. First, we load the entire 64-bit word. Then, we extract the specific bits that correspond to our logical element and compare them against the user-provided \u003Ccode>current\u003C/code> value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Inside the lock-free path of atomic_compare_exchange\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If this check fails, it means another thread has modified the element since our initial load. We can immediately return an \u003Ccode>Err\u003C/code> with the value we just read, satisfying the contract of \u003Ccode>compare_exchange\u003C/code>.\u003C/p>\n\u003Cp>If the check succeeds, we proceed to the atomic write phase. We prepare a \u003Ccode>new_word\u003C/code> by masking and ORing in the \u003Ccode>new\u003C/code> value, just as we did for \u003Ccode>atomic_store\u003C/code>. Then we attempt the hardware-level \u003Ccode>compare_exchange_weak\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ... continuing the loop ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_value_shifted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">success\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If the \u003Ccode>compare_exchange_weak\u003C/code> succeeds, it means no other thread modified the 64-bit word between our initial \u003Ccode>load\u003C/code> and this instruction. Our update is successful. If it fails, another thread (possibly operating on an \u003Cem>adjacent\u003C/em> element in the same word) has modified the word. We update our local \u003Ccode>old_word\u003C/code> with the new value from memory and retry the entire loop.\u003C/p>\n\u003Ch2 id=\"the-locked-path\">The Locked Path\u003C/h2>\n\u003Cp>For elements that span two words, we need to use the lock striping mechanism to ensure the operation is transactional. First, we must acquire the appropriate lock, giving us exclusive access to the two-word region.\u003C/p>\n\u003Cp>Once the lock is held, the logic is straightforward:\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Read:\u003C/strong> We perform an atomic read of the spanning value. This is itself a locked operation to ensure we get a consistent view.\u003C/li>\n\u003Cli>\u003Cstrong>Compare:\u003C/strong> We compare this value against the user-provided \u003Ccode>current\u003C/code>. If they donâ€™t match, we release the lock and immediately return \u003Ccode>Err\u003C/code>.\u003C/li>\n\u003Cli>\u003Cstrong>Write:\u003C/strong> If they do match, we call our existing \u003Ccode>atomic_store\u003C/code> method to write the \u003Ccode>new\u003C/code> value. \u003Ccode>atomic_store\u003C/code> will re-acquire the same lock to perform its two-word write.\u003C/li>\n\u003Cli>\u003Cstrong>Return:\u003C/strong> We release the lock and return \u003Ccode>Ok\u003C/code>.\u003C/li>\n\u003C/ol>\n\u003Cp>Because the entire read-compare-write sequence is protected by the same mutex, we guarantee that no other thread can interfere. Combining these two paths gives us the complete \u003Ccode>atomic_compare_exchange\u003C/code> method, which can then be used to implement all other atomic operations in terms of it.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_compare_exchange\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    success\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    failure\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Lock-free path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">storage[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_value_shifted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">                return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_val_extracted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">store_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new_value_shifted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> atomic_word_ref\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">success\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Locked path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> _guard\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">locks[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">lock_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">failure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old_val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_store\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">success\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With \u003Ccode>atomic_compare_exchange\u003C/code> providing the core atomicity primitive, we can now construct the high-level Read-Modify-Write (RMW) API. All RMW operations, such as \u003Ccode>fetch_add\u003C/code> or \u003Ccode>fetch_max\u003C/code>, share an identical algorithmic structure: a loop that repeatedly reads a value, computes a new value, and attempts to commit it with \u003Ccode>compare_exchange\u003C/code>. Re-implementing this loop for every operation would be redundant.\u003C/p>\n\u003Cp>Instead, we can abstract this pattern into a single generic method, \u003Ccode>atomic_rmw\u003C/code>, that is parameterized not just over values, but over the \u003Cem>operation itself\u003C/em>. This is where Rust generics and closures come into play. The signature of \u003Ccode>atomic_rmw\u003C/code> can be defined as follows:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">op\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... implementation ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cem>Note: The actual implementation uses \u003Ccode>impl Fn(...)\u003C/code> for a more ergonomic syntax, but the principle is the same.\u003C/em>\u003C/p>\n\u003Cp>The \u003Ccode>op\u003C/code> parameter is a generic type \u003Ccode>F\u003C/code> constrained by the \u003Ccode>Fn(T, T) -> T\u003C/code> trait. This means \u003Ccode>op\u003C/code> can be any closure (or function pointer) that takes two values of our logical type \u003Ccode>T\u003C/code> and returns a new \u003Ccode>T\u003C/code>. This allows us to inject any binary operationâ€”addition, bitwise AND, max, etc. directly into the RMW logic.\u003C/p>\n\u003Cp>To implement \u003Ccode>atomic_rmw\u003C/code>, we begin with a relaxed load to get an initial \u003Ccode>current\u003C/code> value. Inside the loop, it invokes the \u003Ccode>op\u003C/code> closure with the \u003Ccode>current\u003C/code> value and the user-provided \u003Ccode>val\u003C/code> to compute the \u003Ccode>new\u003C/code> value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> op\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The core of the loop is the call to \u003Ccode>atomic_compare_exchange\u003C/code>. This attempts to commit the transaction.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If the operation succeeds, we return the old value, satisfying the RMW contract. If it fails due to contention, \u003Ccode>compare_exchange\u003C/code> returns the \u003Ccode>actual\u003C/code> value now in memory. We update our local \u003Ccode>current\u003C/code> and the loop repeats, re-applying the \u003Ccode>op\u003C/code> closure on the newer value. The complete \u003Ccode>atomic_rmw\u003C/code> method looks like this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">op\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> op\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">current\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> old\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Err\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> current\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> actual\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>By parameterizing over the operation, we have completely decoupled the complex, low-level concurrency logic from the simple arithmetic or bitwise logic of each specific RMW operation. This allows the compiler to monomorphize and inline the \u003Ccode>op\u003C/code> closure for each call site, resulting in specialized and efficient machine code for each RMW variant, giving us a zero-cost abstraction.\u003C/p>\n\u003Cp>Now implementing specific RMW methods becomes a straightforward exercise in composition. Each specific operation is now a simple non-looping wrapper that calls \u003Ccode>atomic_rmw\u003C/code> and provides a closure defining the desired computation. For example, \u003Ccode>fetch_add\u003C/code> is implemented by passing a closure that performs a wrapping addition.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The same pattern applies to all other RMW operations. A bitwise \u003Ccode>fetch_and\u003C/code> provides a closure with the \u003Ccode>&#x26;\u003C/code> operator, and \u003Ccode>fetch_max\u003C/code> provides one that calls the \u003Ccode>max\u003C/code> method.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_and\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_xor\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch_min\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_rmw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">order\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">min\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":308,"localImagePaths":331,"remoteImagePaths":332,"frontmatter":333,"imagePaths":336},[309,310,313,316,319,322,325,328],{"depth":32,"slug":210,"text":211},{"depth":213,"slug":311,"text":312},"structure","Structure",{"depth":32,"slug":314,"text":315},"lock-free-path-for-in-word-elements","Lock-Free path for In-Word Elements",{"depth":32,"slug":317,"text":318},"lock-based-path-for-spanning-elements","Lock-Based Path for Spanning Elements",{"depth":213,"slug":320,"text":321},"benchmarking-the-store-operation","Benchmarking the store operation",{"depth":213,"slug":323,"text":324},"read-modify-write-operations","Read-Modify-Write Operations",{"depth":32,"slug":326,"text":327},"the-lock-free-path-a-cas-loop-on-a-sub-word","The Lock-Free Path: A CAS Loop on a Sub-Word",{"depth":32,"slug":329,"text":330},"the-locked-path","The Locked Path",[],[],{"author":14,"pubDatetime":334,"title":298,"slug":294,"featured":198,"draft":198,"tags":335,"description":301},["Date","2025-09-16T00:00:00.000Z"],[200,300],[],"competitive-programming-reminders",{"id":337,"data":339,"body":344,"filePath":345,"digest":346,"rendered":347},{"author":14,"pubDatetime":340,"title":341,"featured":17,"draft":198,"tags":342,"description":343},["Date","2022-12-01T00:00:00.000Z"],"Competitive Programming Friendly reminders",[19],"An incomplete summary of the most important algorithms and data structures to remember before a coding interview","## Arrays\n\nArrays are a collection of values. They are ordered and can be accessed by index. Arrays are zero-indexed, meaning the first element is at index 0. Arrays can be of any type, including other arrays.\n\n## HashTable\n\nAn HashTable is a data structure that maps keys to values for highly efficient lookup. It is a structure that can be implemented with arrays, linked lists, binary search trees (in this case we would have $O(n \\log n)$ lookup time. The advantage of this is potentially using less space, since we no longer allocate a large array. We can also iterate through the keys i order, which can be useful sometimes), or hash tables.\n\n```python\nHashTable = dict()\n```\n\nor if we want to use defaultdict\n\n```python\nfrom collections import defaultdict\n\nHashTable = defaultdict(int)\n# a default value of 0 is assigned to all keys\n```\n\n## ArrayList & ResizableArray\n\nWhen you need an array-like data structure that offers dynamic resizing, you would usually use an Arraylist. An Arraylist is an array that resizes itself as needed while still providing $O(1)$ access.\n\n```python\nArray = [None] * 1000\n# array of 1000 elements, all None\n```\n\n# Binary Search\n\nBinary search is a search algorithm that finds the position of a target value within a sorted array. Binary search compares the target value to the middle element of the array. If they are not equal, the half in which the target cannot lie is eliminated and the search continues on the remaining half, again taking the middle element to compare to the target value, and repeating this until the target value is found. If the search ends with the remaining half being empty, the target is not in the array.\n\n```python\ndef binary_search(arr, target):\n    left = 0\n    right = len(arr) - 1\n\n    while left \u003C= right:\n        mid = (left + right) // 2\n        if arr[mid] == target:\n            return mid\n        elif arr[mid] \u003C target:\n            left = mid + 1\n        else:\n            right = mid - 1\n\n    return -1\n```\n\n## Algorithms\n\n### QuickSelect\n\nQuickSelect is a selection algorithm to find the k-th smallest/largest element in an unordered list. It is related to the quick sort sorting algorithm.\n\n```python\ndef quick_select(arr, k):\n    if len(arr) == 1:\n        return arr[0]\n\n    pivot = random.choice(arr)\n    left = [x for x in arr if x \u003C pivot]\n    middle = [x for x in arr if x == pivot]\n    right = [x for x in arr if x > pivot]\n\n    if k \u003C= len(left):\n        return quick_select(left, k)\n    elif k \u003C= len(left) + len(middle):\n        return middle[0]\n    else:\n        return quick_select(right, k - len(left) - len(middle))\n```\n\n# Stack\n\nThe stack data structure is precisely what it sounds like: a stack of data. In certain types of problems, it can be favorable to store data in a stack rather than in an array.\n\nA stack uses LIFO (last-in first-out) ordering. That is, as in a stack of dinner plates, the most recent item added to the stack is the first item to be removed.\n\nIt uses the following operations:\n\n- `push(item)`: adds an item to the top of the stack\n- `pop()`: removes the top item from the stack\n- `peek()`: returns the top of the stack without removing it\n- `isEmpty()`: returns true if and only if the stack is empty\n\nUnlike an array, a stack does not offer constant-time access to the ith item. However, it does allow constant-time adds and removes, as it doesn't require shifting elements around.\n\n```python\nstack = []\n\n# add to the top of the stack\nstack.append(1)\nstack.append(2)\n\n# remove from the top of the stack\nstack.pop()\n```\n\nOne case where stacks are often useful is in certain recursive algorithms. Sometimes you need to push temporary data onto a stack as you recurse, but then remove them as you backtrack (for example, because the recursive check failed). A stack offers an intuitive way to do this.\n\nA stack can also be used to implement a recursive algorithm iteratively.\n\n## Queue\n\nA queue is an ordered collection of items where the addition of new items happens at one end, called the \"rear,\" and the removal of existing items occurs at the other end, commonly called the \"front.\" As an element enters the queue it starts at the rear and makes its way toward the front, waiting until that time when it is the next element to be removed.\n\nIt uses the following operations:\n\n- `add(item)`: adds an item to the rear of the queue\n- `remove()`: removes the front item from the queue\n- `peek()`: returns the front of the queue without removing it\n- `isEmpty()`: returns true if and only if the queue is empty\n\n```python\nfrom collections import deque\n\nqueue = deque() # double-ended queue\n```\n\nA queue can also be implemented with a linked list. In fact, they are essentially the same thing, as long as items are added and removed from opposite sides.\n\nOne place where queues are often used is in breadth-first search or in implementing a cache. In breadth-first search, for example, we used a queue to store a list of the nodes that we need to process. Each time we process a node, we add its adjacent nodes to the back of the queue. This allows us to process nodes in the order in which they are viewed.\n\n# Linked List\n\nA Linked list is a data structure that represents a sequence of nodes. In as singly linked list, each node points to the next node in the linked list. In a doubly linked list, each node points to the next node and the previous node. In a circular linked list, the tail node points to the head node.\n\nUnlike an array, a linked list does not provide costant access time to a particolar index within the list. This means, that if you'd like to find the kth element in a linked list, you'd have to traverse the list from the head node to the kth node. This is because the nodes in a linked list are not stored in contiguous memory locations.\n\n## Singly Linked List\n\n```python\n# Definition for singly-linked list.\nclass ListNode:\n    def __init__(self, x):\n        self.val = x\n        self.next = None\n```\n\nIn this implementation, the head node is the first node in the linked list. The tail node is the last node in the linked list. The tail node's next pointer points to None.\n\n## Techniques\n\n- Slow and Fast Pointer\n\n_This is a technique that is used to solve problems that involve linked list traversal. The slow pointer moves one node at a time, while the fast pointer moves two nodes at a time. This technique is used to find the middle node of a linked list, or to determine if a linked list has a cycle._\n\n- Dummy linked list\n\n```python\ndummy = ListNode()\n```\n\n- Check if has a cycle\n\n```python\ndef hasCycle(self, head: ListNode) -> bool:\n    slow = fast = head\n    while fast and fast.next:\n        slow = slow.next\n        fast = fast.next.next\n        if slow == fast:\n            return True\n    return False\n```\n\n- Reverse a linked list\n\n```python\ndef reverseList(self, head: ListNode) -> ListNode:\n    prev, curr = None, head\n\n    while curr:\n        temp = curr.next\n        curr.next = prev\n        prev = curr\n        curr = temp\n    return prev\n```\n\n- Sometimes it's useful to split a linked list into two parts\n\n# Trees\n\nA nice way to understand a tree is with a recursive explanation. A tree is a data structure composed of nodes.\n\n- Each tree has a root node. (Actually, this isn't strictly necessary in graph theory, but it's usually how we use trees in programming)\n\n- The root node has zero or more child nodes.\n\n- Each child node has zero or more child nodes, and so on.\n\nThe tree cannot contain cycles. The nodes may or may not be in a particular order, they could have any data type as values, and they may or may not have links back to their parent nodes.\n\n```python\nclass TreeNode:\n    def __init__(self, val):\n        self.val = val\n        self.children = []\n```\n\n## Binary Tree\n\nA binary tree is a tree in which each node has up to two children. Not all trees are binary trees. There are occasions when you might have a tree that is not a binary tree. For example, suppose you were using a tree to represent a bunch of phone numbers. In this case, you might use a 10-ary tree, with each node having up to 10 children (one for each digit}.\nA node is called a \"leaf\" node if it has no children.\n\n```python\nclass BinaryTreeNode:\n    def __init__(self, val):\n        self.val = val\n        self.left = None\n        self.right = None\n```\n\n## Binary Search Tree\n\nA binary search tree is a binary tree in which every node fits a specific ordering property: _all left descendents_ $\\leq n \u003C$ _all right descendents_. This must be true for each node $n$. Note that this inequality must be true for all of a node's descendents, not just its immediate children\n\n> The definition of a binary search tree can vary slightly with respect to equality. Under some definitions, the tree cannot have duplicate values. In others, the duplicate values will be on the right or can be on either side. All are valid definitions, but you should clarify this with your interviewer.\n\n### Balanced vs Unbalanced\n\nWhile many trees are balanced, not all are. Note that balancing a tree does not mean the left and right subtrees are exactly the same size (like you see under \"perfect binary trees\")\n\nOne way to think about it is that a \"balanced\" tree really means something more like \"not terribly imbalanced:' It's balanced enough to ensure $O(\\log n)$ times for insert and find, but it's not necessarily as balanced as it could be.\n\n### Complete Binary Tree\n\nA complete binary tree is a binary tree in which every level of the tree is fully filled, except for perhaps the last level. lo the extent that the last level is filled, it is filled left to right.\n\n### Full Binary Tree\n\nA full binary tree is a binary tree in which every node has either zero or two children. That is, no nodes have only one child.\n\n### Perfect Binary Tree\n\nA perfect binary tree is one that is both full and complete. All leaf nodes will be at the same level, and this level has the maximum number of nodes.\n\n## Binary Tree Traversal\n\n### In-order Traversal\n\nIn-order traversal means to \"visit\" (often, print) the left branch, then the current node, and finally, the right branch.\n\n```python\ndef inOrderTraversal(self, root):\n    if root:\n        self.inOrderTraversal(root.left)\n        print(root.val)\n        self.inOrderTraversal(root.right)\n```\n\n### Pre-order Traversal\n\nPre-order traversal visits the current node before its child nodes (hence the name \"pre-order\").\n\n```python\ndef preOrderTraversal(self, root):\n    if root:\n        print(root.val)\n        self.preOrderTraversal(root.left)\n        self.preOrderTraversal(root.right)\n```\n\n### Post-order Traversal\n\nPost-order traversal visits the current node after its child nodes (hence the name \"post-order\").\n\n```python\ndef postOrderTraversal(self, root):\n    if root:\n        self.postOrderTraversal(root.left)\n        self.postOrderTraversal(root.right)\n        print(root.val)\n```\n\n### Level-order Traversal\n\nLevel-order traversal visits the nodes level by level. You'll often see this done with a queue.\n\n```python\ndef levelOrderTraversal(self, root):\n    if not root:\n        return\n    queue = [root]\n    while queue:\n        node = queue.pop(0)\n        print(node.val)\n        if node.left:\n            queue.append(node.left)\n        if node.right:\n            queue.append(node.right)\n```\n\n## Binary Heaps (min-heap and max-heap)\n\nWe'll just discuss min-heaps here. Max-heaps are essentially equivalent, but the elements are in descending order rather than ascending order\n\nA min-heap is a complete binary tree (that is, totally filled other than the rightmost elements on the last level) where each node is smaller than its children. The root, therefore, is the minimum element in the tree.\n\nWe have two key operations on a min-heap: `insert` and `extract_min`.\n\n### Insert\n\nWhen we insert into a min-heap, we always start by inserting the element at the bottom. We insert at the rightmost spot so as to maintain the complete tree property.\n\nThen, we \"fix\" the tree by swapping the new element with its parent, until we find an appropriate spot for the element We essentially bubble up the minimum element.\n\nThis takes $O(\\log n)$ time, where $n$ is the number of elements in the heap.\n\n### Extract Min\n\nFinding the minimum element of a min-heap is easy: it's always at the top. The trickier part is how to remove it. (In fact, this isn't that tricky.)\n\nFirst, we remove the minimum element and swap it with the last element in the heap (the bottommost, rightmost element). Then, we bubble down this element, swapping it with one of its children until the min-heap property is restored.\n\nDo we swap it with the left child or the right child? That depends on their values. There's no inherent ordering between the left and right element, but you'll need to take the smaller one in order to maintain the min-heap ordering.\n\nThis takes $O(\\log n)$ time.\n\n# Tries\n\nA trie (sometimes called a prefix tree} is a funny data structure. It comes up a lot in interview questions, but algorithm textbooks don't spend much time on this data structure.\n\nA trie is a variant of an n-ary tree in which characters are stored at each node. Each path down the tree may represent a word.\n\n```python\nclass TrieNode:\n    def __init__(self):\n        self.children = {}\n        self.is_word = False\n```\n\nThe `* nodes` (sometimes called \"null nodes\") are often used to indicate complete words. For example, the fact that there is a `* node` under `MANY` indicates that `MANY` is a complete word. The existence of the `MA` path\nindicates there are words that start with `MA`.\n\nThe actual implementation of these `* nodes` might be a special type of child (such as a `TerminatingTrieNode`, which inherits from `TrieNode`. Or, we could use just a boolean flag terminates within the \"parent\" node.\n\nA node in a trie could have anywhere from 1 through `ALPHABET_SIZE + 1` children (or, `O` through `ALPHABET_SIZE` if a boolean flag is used instead of a `* node`).\n\nVery commonly, a trie is used to store the entire (English) language for quick prefix lookups. While a hash table can quickly look up whether a string is a valid word, it cannot tell us if a string is a prefix of any valid words. A trie can do this very quickly.\n\n> How quickly? A trie can check if a string is a valid prefix in $O(K)$ time, where K is the length of the string. This is actually the same runtime as a hash table will take. Although we often refer to hash table lookups as being $O(1)$ time, this isn't entirely true. A hash table must read through all the characters in the input which takes $O(K)$ time in the case of a word lookup\n\nMany problems involving lists of valid words leverage a trie as an optimization. In situations when we search through the tree on related prefixes repeatedly\n\n# Backtracking\n\nBacktracking is a general algorithm for finding all (or some) solutions to some computational problems, notably constraint satisfaction problems, that incrementally builds candidates to the solutions, and abandons each partial candidate (\"backtracks\") as soon as it determines that the candidate cannot possibly be completed to a valid solution.\n\n- Sometimes is useful to think of backtracking as an intelligent \"brute force\" approach.\n- Recursive DFS is often a good way to implement backtracking\n- It's usually a good idea to start by writing a recursive backtracking every time you see a subset, combination, permutation, or partition problem.\n\n# Graphs\n\nMany programming problems can be solved by modeling the problem as a graph\nproblem and using an appropriate graph algorithm.\n\nAtree is actually a type of graph, but not all graphs are trees. Simply put, a tree isa connected graph without cycles. A graph is simply a collection d nodes with edges between (some of) them.\n\n- Graphs can be either **directed** or **undirected**. While directed edges are like a one-way street, undirected edges are like a two-way street.\n- The graph might consist of multiple isolated subgraphs. If there is a path between every pair of vertices, it is called a \"**connected graph**\".\n- The graph can also have cycles (or not). An \"**acyclic graph**\" is one without cycles\n\n## Adjacency Lists\n\nThis is the most common way to represent a graph. Every vertex (or node) stores a list of adjacent vertices. In an undirected graph, an edge like `(a, b)` would be stored twice: once in `a`'s adjacent vertices and once in `b`'s adjacent vertices.\n\nA simple class definition for a graph node could look essentially the same as a tree node.\n\n```python\nclass Graph:\n    def __init__(self):\n        self.nodes = {}\n```\n\n```python\nclass Node:\n    def __init__(self, val = 0, neighbors = None):\n        self.val = val\n        self.neighbors = neighbors if neighbors is not None else []\n```\n\nYou don't necessarily need any additional classes to represent a graph. An array (or a hash table) of lists (arrays, arraylists, linked lists, etc.) can store the adjacency list.\n\n## Adjacency Matrix\n\nAn adjacency matrix is an `NxN` boolean matrix (where `N` is the number of nodes), where a true value at `matrix[i][j]` indicates an edge from node `i` to node `j`. (You can also use an integer matrix with Os and 1s.)\n\nNote that in an undirected graph, an adjacency matrix will be symmetric. In a directed graph, it will not (necessarily) be.\n\nThe same graph algorithms that are used on adjacency lists (breadth-first search, etc.) can be performed with adjacency matrices, but they may be somewhat less efficient. In the adjacency list representation, you can easily iterate through the neighbors of a node. In the adjacency matrix representation, you will need to iterate through all the nodes to identify a node's neighbors.\n\n## Graph Search\n\nThe two most common ways to search a graph are **depth-first search** and **breadth-first search**.\n\n- In depth-first search (DFS), we start at the root (or another arbitrarily selected node) and explore each branch completely before moving on to the next branch. That is. we go deep first (hence the name depth-first search) before we go wide.\n\n- In breadth-first search (BFS), we start at the root (or another arbitrarily selected node) and explore each neighbor before going on to any of their children. That is, we go wide (hence breadth-first search) before\n  we go deep.\n\nBreadth-first search and depth-first search tend to be used in different scenarios. DFS is often preferred if we want to visit every node in the graph. Both will work just fine, but depth-first search is a bit simpler. However, if we want to find the shortest path (or just any path) between two nodes, BFS is generally better.\n\n### DFS\n\nIn DFS, we visit a node a and then iterate through each of a's neighbors. When visiting `a` node `b` that is a neighbor of `a`, we visit all of `b`'s neighbors before going on to `a`'s other neighbors. That is, a exhaustively\nsearches `b`'s branch before any of its other neighbors.\n\nNote that pre-order and other forms of tree traversal are a form of DFS. The key difference is that when implementing this algorithm for a graph, we must check if the node has been visited. If we don't, we risk getting stuck in an infinite loop.\n\n```python\ndef dfs(node):\n    if node is None:\n        return\n    visit(node)\n    node.visited = True\n    for next in node.adjacent:\n        if next.visited == False:\n            dfs(next)\n```\n\n### BFS\n\nBFS is a bit less intuitive. The main tripping point is the (false) assumption that BFS is recursive. It's not. Instead, it uses a queue.\n\nIn BFS, node a visits each of a's neighbors before visiting any of their neighbors. You can think of this as searching level by level out from a. An iterative solution involving a queue usually works best.\n\n```python\ndef bfs(graph, start):\n    queue = []\n    queue.append(start)\n    start.visited = True\n    while queue:\n        r = queue.pop(0)\n        visit(r)\n        for n in r.adjacent:\n            if n.visited == False:\n                n.visited = True\n                queue.append(n)\n```\n\nIf you are asked to implement BFS, the key thing to remember is the use of the queue. The rest of the algorithm flows from this fact.\n\n### Bidirectional Search\n\nBidirectional search is used to find the shortest path between a source and destination node. It operates by essentially running two simultaneous breadth-first searches, one from each node. When their searches collide, we have found a path.\n\n![](https://i.imgur.com/AQTtl8H.png)\n\nTo see why this is faster, consider a graph where every node has at most k adjacent nodes and the shortest path from node s to node t has length d.\n\n- In traditional breadth-first search, we would search up to `k` nodes in the first \"level\" of the search. In the second level, we would search up to `k` nodes for each of those first `k` nodes, so $k^2$ nodes total (thus far).\n  We would do this $d$ times, so that's $O(k^d)$ nodes.\n\n- In bidirectional search, we have two searches that collide after approximately $d/2$ levels (the midpoint of the path). The search from `s` visits approximately $2k^{d/2}$, as does the search from `t`. That's approximately $O(k^{d/2})$ nodes total.\n\nSo the the bidirectional search is actually faster by a factor of $k^{d/2}$.\n\n### Topological Sort\n\n## Shortest Path\n\nFinding a shortest path between two nodes of a graph is an important problem\nthat has many practical applications. For example, a natural problem related to a road network is to calculate the shortest possible length of a route between two cities, given the lengths of the roads.\n\nIn an unweighted graph, the length of a path equals the number of its edges,\nand we can simply use breadth-first search to find a shortest path. However, we focus on weighted graphs where more sophisticated algorithms are needed for finding shortest paths\n\n### Bellman-Ford\n\nThe Bellmanâ€“Ford algorithm finds shortest paths from a starting node to all\nnodes of the graph. The algorithm can process all kinds of graphs, provided that the graph does not contain a cycle with negative length. If the graph contains a negative cycle, the algorithm can detect this.\n\nThe algorithm keeps track of distances from the starting node to all nodes\nof the graph. Initially, the distance to the starting node is 0 and the distance to all other nodes in infinite. The algorithm reduces the distances by finding edges that shorten the paths until it is not possible to reduce any distance\n\nThe algorithm is based on the following observation: if we know the shortest path from the starting node to all nodes except one, we can find the shortest path to all nodes by adding one edge to the shortest path. The algorithm iterates through all edges of the graph and relaxes each edge. The relaxation of an edge means that we try to find a shorter path to the destination node of the edge by going through the source node of the edge. The algorithm repeats this process for a number of iterations, which is equal to the number of nodes in the graph. If the algorithm finds a shorter path to a node, it means that the graph contains a negative cycle. The algorithm can detect this by keeping track of the number of iterations. If the number of iterations is equal to the number of nodes in the graph, the graph contains a negative cycle.\n\n```python\ndef bellman_ford(graph, source):\n    distance, predecessor = dict(), dict()\n    for node in graph:\n        distance[node] = float('inf')\n        predecessor[node] = None\n    distance[source] = 0\n    for _ in range(len(graph) - 1):\n        for u, v in graph.edges:\n            if distance[u] + graph.edges[u, v] \u003C distance[v]:\n                distance[v] = distance[u] + graph.edges[u, v]\n                predecessor[v] = u\n    for u, v in graph.edges:\n        assert distance[u] + graph.edges[u, v] >= distance[v]\n    return distance, predecessor\n```\n\nThe time complexity of the algorithm is $O(nm)$, because the algorithm consists of `n âˆ’ 1` rounds and iterates through all `m` edges during a round. If there are no negative cycles in the graph, all distances are final after `n âˆ’ 1` rounds, because each shortest path can contain at most `n âˆ’ 1` edges.\n\nIn practice, the final distances can usually be found faster than in `n âˆ’ 1` rounds. Thus, a possible way to make the algorithm more efficient is to stop the algorithm if no distance can be reduced during a round.\n\n> **Note:** We need to use this algorithm when the graph contains negative edges. If the graph contains only positive edges, we can use Dijkstra's algorithm, which is more efficient.\n\n### Dijkstra's Algorithm\n\nDijkstraâ€™s algorithm finds shortest paths from the starting node to all nodes of the graph, like the Bellmanâ€“Ford algorithm. The benefit of Dijkstra's algorithm is that it is more efficient and can be used for processing large graphs. However, the algorithm requires that there are no negative weight edges in the graph.\n\nLike the Bellmanâ€“Ford algorithm, Dijkstraâ€™s algorithm maintains distances\nto the nodes and reduces them during the search. Dijkstraâ€™s algorithm is efficient, because it only processes each edge in the graph once, using the fact that there are no negative edges.\n\nAn efficient implementation of Dijkstraâ€™s algorithm requires that it is possible to efficiently find the minimum distance node that has not been processed. An appropriate data structure for this is a priority queue that contains the nodes ordered by their distances. Using a priority queue, the next node to be processed can be retrieved in logarithmic time\n\n```python\ndef dijkstra(graph, source):\n    distance, predecessor = dict(), dict()\n    for node in graph:\n        distance[node] = float('inf')\n        predecessor[node] = None\n    distance[source] = 0\n    queue = PriorityQueue()\n    queue.put((0, source))\n    while not queue.empty():\n        _, u = queue.get()\n        for v in graph[u]:\n            alt = distance[u] + graph.edges[u, v]\n            if alt \u003C distance[v]:\n                distance[v] = alt\n                predecessor[v] = u\n                queue.put((alt, v))\n    return distance, predecessor\n```\n\nThe time complexity of the above implementation is $O(n + m \\log m)$, because\nthe algorithm goes through all nodes of the graph and adds for each edge at most one distance to the priority queue.\n\n### Floyd-Warshall\n\nThe Floydâ€“Warshall algorithm provides an alternative way to approach the\nproblem of finding shortest paths. Unlike the other algorithms of this chapter, it finds all shortest paths between the nodes in a single run.\n\nThe algorithm maintains a two-dimensional array that contains distances\nbetween the nodes. First, distances are calculated only using direct edges between the nodes, and after this, the algorithm reduces distances by using intermediate nodes in paths.\n\nThe advantage of the Floydâ€“Warshall algorithm that it is easy to implement. The following code constructs a distance matrix where `distance[a][b]` is the shortest distance between nodes a and b. First, the algorithm initializes distance using the adjacency matrix adj of the graph:\n\n```python\ndef floyd_warshall(graph):\n    distance = {u: {v: float('inf') for v in graph} for u in graph}\n    for u in graph:\n        distance[u][u] = 0\n    for u, v in graph.edges:\n        distance[u][v] = graph.edges[u, v]\n    for k in graph:\n        for i in graph:\n            for j in graph:\n                distance[i][j] = min(distance[i][j], distance[i][k] + distance[k][j])\n    return distance\n```\n\nThe time complexity of the algorithm is $O(n^3)$, because it contains three\nnested loops that go through the nodes of the graph. Since the implementation of the Floydâ€“Warshall algorithm is simple, the algorithm can be a good choice even if it is only needed to find a single shortest path in the graph. However, the algorithm can only be used when the graph is so\nsmall that a cubic time complexity is fast enough.\n\n# Recursion\n\nWhile there are a large number of recursive problems, many follows similar patterns. A good hint that a problem is recursive is that it can be built of sub-problems of the same type.\n\nWhen you hear a problem beginning with the following statements, it's often (though not always) a good candidate for recursion:\n\n- _Design an algorithm to compute the nth ..._\n- _Write code to list the first n ..._\n- _Implement a method to compute all ..,_\n\nRecursive solutions, by definition, are built off of solutions to subproblems. Many times, this will mean simply to compute $f(n)$ by adding something, removing something, or otherwise changing the solution\nfor $f(n-1)$. In other cases, you might solve the problem for the first half of the data set, then the second half, and then merge those results.\nThere are many ways you might divide a problem into subproblems.Three of the most common approaches to develop an algorithm are bottom-up, top-down, and half-and-half.\n\n## Bottom-Up\n\nThe bottom-up approach is often the most intuitive. We start with knowing how to solve the problem for a simple case, like a list with only one element. Then we figure out how to solve the problem for two\nelements, then for three elements, and so on. The key here is to think about how you can build the solution for one case off of the previous case (or multiple previous cases).\n\n## Top-Down\n\nThe top-down approach can be more complex since it's less concrete. But sometimes, it's the best way to think about the problem.\n\nIn these problems, we think about how we can divide the problem for case `N` into subproblems. Be careful of overlap between the cases.\n\n## Half-and-Half\n\nIn addition to top-down and bottom-up approaches, it's often effective to divide the data set in half.\n\nFor example, binary search works with a \"half-and-half\" approach. When we look for an element in a sorted array, we first figure out which half of the array contains the value. Then we recurse and search for it in that half.\n\nMerge sort is also a \"half-and-half\" approach. We sort each half of the array and then merge together the\nsorted halves.\n\n## Recursion vs. Iteration\n\nRecursive algorithms can be very space inefficient. Each recursive call adds a new layer to the stack, which means that if your algorithm recurses to a depth of `n`, it uses at least $O(n)$ memory.\n\nFor this reason, it's often better to implement a recursive algorithm iteratively. All recursive algorithms can be implemented iteratively, although sometimes the code to do so is much more complex. Before diving\ninto recursive code, ask yourself how hard it would be to implement it iteratively,\n\n# Dynamic Programming\n\nDynamic programming is a technique that combines the correctness of complete search and the efficiency of greedy algorithms. Dynamic programming can be applied if the problem can be divided into overlapping subproblems that can be solved independently.\n\nThere are two uses for dynamic programming:\n\n- **Finding an optimal solution**: We want to find a solution that is as large as possible or as small as possible.\n- **Counting the number of solutions:** We want to calculate the total number of possible solutions.\n\n\u003C!-- # Greedy\n\n# Intervals -->\n\n# Bit Manipulation\n\nAll data in computer programs is internally stored as bits, i.e., as numbers 0 and 1. In programming, an n bit integer is internally stored as a binary number that consists of `n` bits. For example, the `C++` type int is a `32-bit` type, which means that every `int` number consists of 32 bits.\n\nThe bits in the representation are indexed from right to left. To convert a bit representation $b_k Â· Â· Â· b_2 b_1 b_0 into a number, we can use the formula\n\n$$ \\sum\\_{i=0}^k b_i 2^i $$\n\nFor example, the number 13 is represented as 1101 in binary. To convert it to a decimal number, we can use the formula:\n\n$$ 1 \\cdot 2^3 + 1 \\cdot 2^2 + 0 \\cdot 2^1 + 1 \\cdot 2^0 = 8 + 4 + 0 + 1 = 13 $$\n\nThe following code converts a binary number to a decimal number:\n\n```python\ndef binary_to_decimal(binary):\n    decimal = 0\n    for digit in binary:\n        decimal = decimal * 2 + int(digit)\n    return decimal\n```\n\nThe time complexity of the above implementation is $O(n)$, where $n$ is the length of the binary number.\n\nThe bit representation of a number is either signed or unsigned. Usually a signed representation is used, which means that both negative and positive numbers can be represented. signed variable of n bits can contain any integer\nbetween $-2^{n-1}$ and $2^{n-1} - 1$. For example, the `C++` type `int` is a signed `32-bit` type, which means that it can contain any integer between $-2^{31}$ and $2^{31} - 1$.\n\nThe first bit in a signed representation is the sign of the number (`0` for nonnegative numbers and `1` for negative numbers), and the remaining `nâˆ’1` bits contain the magnitude of the number. Twoâ€™s complement is used, which means that the opposite number of a number is calculated by first inverting all the bits in the number, and then increasing the number by one.\n\nFor example, the number 13 is represented as 1101 in binary. To convert it to a twoâ€™s complement representation, we first invert all the bits:\n\n$$ \\overline{1101} = 0010 $$\n\nThen we increase the number by one:\n\n$$ 0010 + 1 = 0011 $$\n\nThe result is the twoâ€™s complement representation of the number 13, which is 0011. The number -13 is represented as 1101 in binary. To\n\nIn an unsigned representation, only nonnegative numbers can be used, but the upper bound for the values is larger. An unsigned variable of `n` bits can contain any integer between 0 and $2^n - 1$. For example, the `C++` type `unsigned int` is an unsigned `32-bit` type, which means that it can contain any integer between 0 and $2^{32} - 1$.\n\n## Bitwise Operators\n\n### Bitwise AND\n\nThe bitwise AND operator `&` compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of both numbers are `1`.\n\nFor example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise AND of 13 and 7 is 0101, which is the number 5.\n\n```python\ndef bitwise_and(a, b):\n    return a & b\n```\n\n### Bitwise OR\n\nThe bitwise OR operator `|` compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are `1`.\n\nFor example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise OR of 13 and 7 is 1111, which is the number 15.\n\n```python\ndef bitwise_or(a, b):\n    return a | b\n```\n\n### Bitwise XOR\n\nThe bitwise XOR operator `^` compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are `1`, but not both.\n\nFor example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise XOR of 13 and 7 is 1010, which is the number 10.\n\n```python\ndef bitwise_xor(a, b):\n    return a ^ b\n```\n\n### Bitwise NOT\n\nThe bitwise NOT operator `~` inverts all the bits of its operand.\n\nFor example, the number 13 is represented as 1101 in binary. The bitwise NOT of 13 is 0010, which is the number 2.\n\n```python\ndef bitwise_not(a):\n    return ~a\n```\n\n### Bitwise Shifts\n\nThe bitwise left shift operator `\u003C\u003C` shifts the bits of its first operand the specified number of positions to the left. The bits shifted off the left end are discarded. The bits on the right end are filled with zeros.\n\nFor example, the number 13 is represented as 1101 in binary. The bitwise left shift of 13 by 1 is 1010, which is the number 10.\n\n```python\ndef bitwise_left_shift(a, b):\n    return a \u003C\u003C b\n```\n\nThe bitwise right shift operator `>>` shifts the bits of its first operand the specified number of positions to the right. The bits shifted off the right end are discarded. The bits on the left end are filled with zeros.\n\nFor example, the number 13 is represented as 1101 in binary. The bitwise right shift of 13 by 1 is 0110, which is the number 6.\n\n```python\ndef bitwise_right_shift(a, b):\n    return a >> b\n```\n\n## Bitwise Tricks\n\n### Check if a number is even or odd\n\nA number is even if the last bit is `0` and odd if the last bit is `1`. We can check if a number is even or odd by checking the last bit of the number. If the last bit is `0`, the number is even, otherwise, it is odd.\n\n```python\ndef is_even(a):\n    return a & 1 == 0\n```\n\n### Check if a number is a power of two\n\nA number is a power of two if it has only one bit set to `1`. We can check if a number is a power of two by checking if the number has only one bit set to `1`.\n\n```python\ndef is_power_of_two(a):\n    return a & (a - 1) == 0\n```\n\n### Swap two numbers\n\nWe can swap two numbers by using the bitwise XOR operator `^`. The bitwise XOR of two numbers is `0` if the two numbers are the same, and it is `1` if the two numbers are different. We can use this property to swap two numbers.\n\n```python\ndef swap(a, b):\n    a ^= b\n    b ^= a\n    a ^= b\n    return a, b\n```\n\n### Get the last set bit\n\nWe can get the last set bit of a number by using the bitwise AND operator `&` with the twoâ€™s complement of the number.\n\n```python\ndef get_last_set_bit(a):\n    return a & -a\n```\n\n### Hamming distance\n\nThe Hamming distance between two integers is the number of positions at which the corresponding bits are different.\n\nGiven two integers `x` and `y`, calculate the Hamming distance.\n\n```python\ndef hamming_distance(x, y):\n    return bin(x ^ y).count('1')\n```\n\n### Count the number of set bits\n\nWe can count the number of set bits in a number by repeatedly clearing the last set bit of the number until the number becomes `0`.\n\n```python\ndef count_set_bits(a):\n    count = 0\n    while a:\n        a &= a - 1\n        count += 1\n    return count\n```\n\n### Reverse bits\n\nWe can reverse the bits of a number by repeatedly shifting the number to the right and appending the last bit to the result.\n\n```python\ndef reverse_bits(a):\n    result = 0\n    for _ in range(32):\n        result = (result \u003C\u003C 1) | (a & 1)\n        a >>= 1\n    return result\n```","src/data/blog/howtoasd.md","a314d6ee79f32d79",{"html":348,"metadata":349},"\u003Ch2 id=\"arrays\">Arrays\u003C/h2>\n\u003Cp>Arrays are a collection of values. They are ordered and can be accessed by index. Arrays are zero-indexed, meaning the first element is at index 0. Arrays can be of any type, including other arrays.\u003C/p>\n\u003Ch2 id=\"hashtable\">HashTable\u003C/h2>\n\u003Cp>An HashTable is a data structure that maps keys to values for highly efficient lookup. It is a structure that can be implemented with arrays, linked lists, binary search trees (in this case we would have \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n \\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> lookup time. The advantage of this is potentially using less space, since we no longer allocate a large array. We can also iterate through the keys i order, which can be useful sometimes), or hash tables.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">HashTable \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>or if we want to use defaultdict\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> collections \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">import\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> defaultdict\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">HashTable \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> defaultdict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">int\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># a default value of 0 is assigned to all keys\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"arraylist--resizablearray\">ArrayList &#x26; ResizableArray\u003C/h2>\n\u003Cp>When you need an array-like data structure that offers dynamic resizing, you would usually use an Arraylist. An Arraylist is an array that resizes itself as needed while still providing \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> access.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Array \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\">None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1000\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># array of 1000 elements, all None\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch1 id=\"binary-search\">Binary Search\u003C/h1>\n\u003Cp>Binary search is a search algorithm that finds the position of a target value within a sorted array. Binary search compares the target value to the middle element of the array. If they are not equal, the half in which the target cannot lie is eliminated and the search continues on the remaining half, again taking the middle element to compare to the target value, and repeating this until the target value is found. If the search ends with the remaining half being empty, the target is not in the array.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> binary_search\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> target\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        mid \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> right) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">//\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> target\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> mid\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        elif\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> target\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> mid \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        else\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> mid \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"algorithms\">Algorithms\u003C/h2>\n\u003Ch3 id=\"quickselect\">QuickSelect\u003C/h3>\n\u003Cp>QuickSelect is a selection algorithm to find the k-th smallest/largest element in an unordered list. It is related to the quick sort sorting algorithm.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> quick_select\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> k\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    pivot \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> random\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">choice\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> pivot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    middle \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> pivot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> pivot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> quick_select\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">,\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> k\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    elif\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">middle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> middle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    else\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> quick_select\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">,\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">middle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch1 id=\"stack\">Stack\u003C/h1>\n\u003Cp>The stack data structure is precisely what it sounds like: a stack of data. In certain types of problems, it can be favorable to store data in a stack rather than in an array.\u003C/p>\n\u003Cp>A stack uses LIFO (last-in first-out) ordering. That is, as in a stack of dinner plates, the most recent item added to the stack is the first item to be removed.\u003C/p>\n\u003Cp>It uses the following operations:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>push(item)\u003C/code>: adds an item to the top of the stack\u003C/li>\n\u003Cli>\u003Ccode>pop()\u003C/code>: removes the top item from the stack\u003C/li>\n\u003Cli>\u003Ccode>peek()\u003C/code>: returns the top of the stack without removing it\u003C/li>\n\u003Cli>\u003Ccode>isEmpty()\u003C/code>: returns true if and only if the stack is empty\u003C/li>\n\u003C/ul>\n\u003Cp>Unlike an array, a stack does not offer constant-time access to the ith item. However, it does allow constant-time adds and removes, as it doesnâ€™t require shifting elements around.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># add to the top of the stack\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># remove from the top of the stack\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">stack\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">pop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>One case where stacks are often useful is in certain recursive algorithms. Sometimes you need to push temporary data onto a stack as you recurse, but then remove them as you backtrack (for example, because the recursive check failed). A stack offers an intuitive way to do this.\u003C/p>\n\u003Cp>A stack can also be used to implement a recursive algorithm iteratively.\u003C/p>\n\u003Ch2 id=\"queue\">Queue\u003C/h2>\n\u003Cp>A queue is an ordered collection of items where the addition of new items happens at one end, called the â€œrear,â€ and the removal of existing items occurs at the other end, commonly called the â€œfront.â€ As an element enters the queue it starts at the rear and makes its way toward the front, waiting until that time when it is the next element to be removed.\u003C/p>\n\u003Cp>It uses the following operations:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>add(item)\u003C/code>: adds an item to the rear of the queue\u003C/li>\n\u003Cli>\u003Ccode>remove()\u003C/code>: removes the front item from the queue\u003C/li>\n\u003Cli>\u003Ccode>peek()\u003C/code>: returns the front of the queue without removing it\u003C/li>\n\u003Cli>\u003Ccode>isEmpty()\u003C/code>: returns true if and only if the queue is empty\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> collections \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">import\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> deque\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> deque\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> # double-ended queue\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A queue can also be implemented with a linked list. In fact, they are essentially the same thing, as long as items are added and removed from opposite sides.\u003C/p>\n\u003Cp>One place where queues are often used is in breadth-first search or in implementing a cache. In breadth-first search, for example, we used a queue to store a list of the nodes that we need to process. Each time we process a node, we add its adjacent nodes to the back of the queue. This allows us to process nodes in the order in which they are viewed.\u003C/p>\n\u003Ch1 id=\"linked-list\">Linked List\u003C/h1>\n\u003Cp>A Linked list is a data structure that represents a sequence of nodes. In as singly linked list, each node points to the next node in the linked list. In a doubly linked list, each node points to the next node and the previous node. In a circular linked list, the tail node points to the head node.\u003C/p>\n\u003Cp>Unlike an array, a linked list does not provide costant access time to a particolar index within the list. This means, that if youâ€™d like to find the kth element in a linked list, youâ€™d have to traverse the list from the head node to the kth node. This is because the nodes in a linked list are not stored in contiguous memory locations.\u003C/p>\n\u003Ch2 id=\"singly-linked-list\">Singly Linked List\u003C/h2>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"># Definition for singly-linked list.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In this implementation, the head node is the first node in the linked list. The tail node is the last node in the linked list. The tail nodeâ€™s next pointer points to None.\u003C/p>\n\u003Ch2 id=\"techniques\">Techniques\u003C/h2>\n\u003Cul>\n\u003Cli>Slow and Fast Pointer\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cem>This is a technique that is used to solve problems that involve linked list traversal. The slow pointer moves one node at a time, while the fast pointer moves two nodes at a time. This technique is used to find the middle node of a linked list, or to determine if a linked list has a cycle.\u003C/em>\u003C/p>\n\u003Cul>\n\u003Cli>Dummy linked list\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">dummy \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>Check if has a cycle\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> hasCycle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> head\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> ->\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    slow \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> head\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">and\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        slow \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> slow\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        fast \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> slow \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fast\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>Reverse a linked list\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> reverseList\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> head\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ListNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> ->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ListNode:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    prev\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> head\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        temp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        curr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> prev\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        prev \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> curr\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        curr \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> temp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> prev\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>Sometimes itâ€™s useful to split a linked list into two parts\u003C/li>\n\u003C/ul>\n\u003Ch1 id=\"trees\">Trees\u003C/h1>\n\u003Cp>A nice way to understand a tree is with a recursive explanation. A tree is a data structure composed of nodes.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>Each tree has a root node. (Actually, this isnâ€™t strictly necessary in graph theory, but itâ€™s usually how we use trees in programming)\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The root node has zero or more child nodes.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>Each child node has zero or more child nodes, and so on.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>The tree cannot contain cycles. The nodes may or may not be in a particular order, they could have any data type as values, and they may or may not have links back to their parent nodes.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> TreeNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">children \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"binary-tree\">Binary Tree\u003C/h2>\n\u003Cp>A binary tree is a tree in which each node has up to two children. Not all trees are binary trees. There are occasions when you might have a tree that is not a binary tree. For example, suppose you were using a tree to represent a bunch of phone numbers. In this case, you might use a 10-ary tree, with each node having up to 10 children (one for each digit}.\nA node is called a â€œleafâ€ node if it has no children.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> BinaryTreeNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">left \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">right \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"binary-search-tree\">Binary Search Tree\u003C/h2>\n\u003Cp>A binary search tree is a binary tree in which every node fits a specific ordering property: \u003Cem>all left descendents\u003C/em> \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>â‰¤\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo>&#x3C;\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\leq n &#x3C;\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\">\u003C/span>\u003Cspan class=\"mrel\">â‰¤\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">&#x3C;\u003C/span>\u003C/span>\u003C/span>\u003C/span> \u003Cem>all right descendents\u003C/em>. This must be true for each node \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>. Note that this inequality must be true for all of a nodeâ€™s descendents, not just its immediate children\u003C/p>\n\u003Cblockquote>\n\u003Cp>The definition of a binary search tree can vary slightly with respect to equality. Under some definitions, the tree cannot have duplicate values. In others, the duplicate values will be on the right or can be on either side. All are valid definitions, but you should clarify this with your interviewer.\u003C/p>\n\u003C/blockquote>\n\u003Ch3 id=\"balanced-vs-unbalanced\">Balanced vs Unbalanced\u003C/h3>\n\u003Cp>While many trees are balanced, not all are. Note that balancing a tree does not mean the left and right subtrees are exactly the same size (like you see under â€œperfect binary treesâ€)\u003C/p>\n\u003Cp>One way to think about it is that a â€œbalancedâ€ tree really means something more like â€œnot terribly imbalanced:â€™ Itâ€™s balanced enough to ensure \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(\\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> times for insert and find, but itâ€™s not necessarily as balanced as it could be.\u003C/p>\n\u003Ch3 id=\"complete-binary-tree\">Complete Binary Tree\u003C/h3>\n\u003Cp>A complete binary tree is a binary tree in which every level of the tree is fully filled, except for perhaps the last level. lo the extent that the last level is filled, it is filled left to right.\u003C/p>\n\u003Ch3 id=\"full-binary-tree\">Full Binary Tree\u003C/h3>\n\u003Cp>A full binary tree is a binary tree in which every node has either zero or two children. That is, no nodes have only one child.\u003C/p>\n\u003Ch3 id=\"perfect-binary-tree\">Perfect Binary Tree\u003C/h3>\n\u003Cp>A perfect binary tree is one that is both full and complete. All leaf nodes will be at the same level, and this level has the maximum number of nodes.\u003C/p>\n\u003Ch2 id=\"binary-tree-traversal\">Binary Tree Traversal\u003C/h2>\n\u003Ch3 id=\"in-order-traversal\">In-order Traversal\u003C/h3>\n\u003Cp>In-order traversal means to â€œvisitâ€ (often, print) the left branch, then the current node, and finally, the right branch.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> inOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">inOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">inOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"pre-order-traversal\">Pre-order Traversal\u003C/h3>\n\u003Cp>Pre-order traversal visits the current node before its child nodes (hence the name â€œpre-orderâ€).\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> preOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">preOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">preOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"post-order-traversal\">Post-order Traversal\u003C/h3>\n\u003Cp>Post-order traversal visits the current node after its child nodes (hence the name â€œpost-orderâ€).\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> postOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">postOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">postOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">root.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"level-order-traversal\">Level-order Traversal\u003C/h3>\n\u003Cp>Level-order traversal visits the nodes level by level. Youâ€™ll often see this done with a queue.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> levelOrderTraversal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> not\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> root\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">root\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">pop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">        print\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node.val\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node.left\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node.right\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"binary-heaps-min-heap-and-max-heap\">Binary Heaps (min-heap and max-heap)\u003C/h2>\n\u003Cp>Weâ€™ll just discuss min-heaps here. Max-heaps are essentially equivalent, but the elements are in descending order rather than ascending order\u003C/p>\n\u003Cp>A min-heap is a complete binary tree (that is, totally filled other than the rightmost elements on the last level) where each node is smaller than its children. The root, therefore, is the minimum element in the tree.\u003C/p>\n\u003Cp>We have two key operations on a min-heap: \u003Ccode>insert\u003C/code> and \u003Ccode>extract_min\u003C/code>.\u003C/p>\n\u003Ch3 id=\"insert\">Insert\u003C/h3>\n\u003Cp>When we insert into a min-heap, we always start by inserting the element at the bottom. We insert at the rightmost spot so as to maintain the complete tree property.\u003C/p>\n\u003Cp>Then, we â€œfixâ€ the tree by swapping the new element with its parent, until we find an appropriate spot for the element We essentially bubble up the minimum element.\u003C/p>\n\u003Cp>This takes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(\\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time, where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> is the number of elements in the heap.\u003C/p>\n\u003Ch3 id=\"extract-min\">Extract Min\u003C/h3>\n\u003Cp>Finding the minimum element of a min-heap is easy: itâ€™s always at the top. The trickier part is how to remove it. (In fact, this isnâ€™t that tricky.)\u003C/p>\n\u003Cp>First, we remove the minimum element and swap it with the last element in the heap (the bottommost, rightmost element). Then, we bubble down this element, swapping it with one of its children until the min-heap property is restored.\u003C/p>\n\u003Cp>Do we swap it with the left child or the right child? That depends on their values. Thereâ€™s no inherent ordering between the left and right element, but youâ€™ll need to take the smaller one in order to maintain the min-heap ordering.\u003C/p>\n\u003Cp>This takes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(\\log n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time.\u003C/p>\n\u003Ch1 id=\"tries\">Tries\u003C/h1>\n\u003Cp>A trie (sometimes called a prefix tree} is a funny data structure. It comes up a lot in interview questions, but algorithm textbooks donâ€™t spend much time on this data structure.\u003C/p>\n\u003Cp>A trie is a variant of an n-ary tree in which characters are stored at each node. Each path down the tree may represent a word.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> TrieNode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">children \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">is_word \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>* nodes\u003C/code> (sometimes called â€œnull nodesâ€) are often used to indicate complete words. For example, the fact that there is a \u003Ccode>* node\u003C/code> under \u003Ccode>MANY\u003C/code> indicates that \u003Ccode>MANY\u003C/code> is a complete word. The existence of the \u003Ccode>MA\u003C/code> path\nindicates there are words that start with \u003Ccode>MA\u003C/code>.\u003C/p>\n\u003Cp>The actual implementation of these \u003Ccode>* nodes\u003C/code> might be a special type of child (such as a \u003Ccode>TerminatingTrieNode\u003C/code>, which inherits from \u003Ccode>TrieNode\u003C/code>. Or, we could use just a boolean flag terminates within the â€œparentâ€ node.\u003C/p>\n\u003Cp>A node in a trie could have anywhere from 1 through \u003Ccode>ALPHABET_SIZE + 1\u003C/code> children (or, \u003Ccode>O\u003C/code> through \u003Ccode>ALPHABET_SIZE\u003C/code> if a boolean flag is used instead of a \u003Ccode>* node\u003C/code>).\u003C/p>\n\u003Cp>Very commonly, a trie is used to store the entire (English) language for quick prefix lookups. While a hash table can quickly look up whether a string is a valid word, it cannot tell us if a string is a prefix of any valid words. A trie can do this very quickly.\u003C/p>\n\u003Cblockquote>\n\u003Cp>How quickly? A trie can check if a string is a valid prefix in \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>K\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(K)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time, where K is the length of the string. This is actually the same runtime as a hash table will take. Although we often refer to hash table lookups as being \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time, this isnâ€™t entirely true. A hash table must read through all the characters in the input which takes \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>K\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(K)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> time in the case of a word lookup\u003C/p>\n\u003C/blockquote>\n\u003Cp>Many problems involving lists of valid words leverage a trie as an optimization. In situations when we search through the tree on related prefixes repeatedly\u003C/p>\n\u003Ch1 id=\"backtracking\">Backtracking\u003C/h1>\n\u003Cp>Backtracking is a general algorithm for finding all (or some) solutions to some computational problems, notably constraint satisfaction problems, that incrementally builds candidates to the solutions, and abandons each partial candidate (â€œbacktracksâ€) as soon as it determines that the candidate cannot possibly be completed to a valid solution.\u003C/p>\n\u003Cul>\n\u003Cli>Sometimes is useful to think of backtracking as an intelligent â€œbrute forceâ€ approach.\u003C/li>\n\u003Cli>Recursive DFS is often a good way to implement backtracking\u003C/li>\n\u003Cli>Itâ€™s usually a good idea to start by writing a recursive backtracking every time you see a subset, combination, permutation, or partition problem.\u003C/li>\n\u003C/ul>\n\u003Ch1 id=\"graphs\">Graphs\u003C/h1>\n\u003Cp>Many programming problems can be solved by modeling the problem as a graph\nproblem and using an appropriate graph algorithm.\u003C/p>\n\u003Cp>Atree is actually a type of graph, but not all graphs are trees. Simply put, a tree isa connected graph without cycles. A graph is simply a collection d nodes with edges between (some of) them.\u003C/p>\n\u003Cul>\n\u003Cli>Graphs can be either \u003Cstrong>directed\u003C/strong> or \u003Cstrong>undirected\u003C/strong>. While directed edges are like a one-way street, undirected edges are like a two-way street.\u003C/li>\n\u003Cli>The graph might consist of multiple isolated subgraphs. If there is a path between every pair of vertices, it is called a â€œ\u003Cstrong>connected graph\u003C/strong>â€.\u003C/li>\n\u003Cli>The graph can also have cycles (or not). An â€œ\u003Cstrong>acyclic graph\u003C/strong>â€ is one without cycles\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"adjacency-lists\">Adjacency Lists\u003C/h2>\n\u003Cp>This is the most common way to represent a graph. Every vertex (or node) stores a list of adjacent vertices. In an undirected graph, an edge like \u003Ccode>(a, b)\u003C/code> would be stored twice: once in \u003Ccode>a\u003C/code>â€™s adjacent vertices and once in \u003Ccode>b\u003C/code>â€™s adjacent vertices.\u003C/p>\n\u003Cp>A simple class definition for a graph node could look essentially the same as a tree node.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> Graph\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">nodes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#FFCB8B\"> Node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> __init__\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> neighbors\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#8EACE3\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">neighbors \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> neighbors \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> neighbors \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">is\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> not\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>You donâ€™t necessarily need any additional classes to represent a graph. An array (or a hash table) of lists (arrays, arraylists, linked lists, etc.) can store the adjacency list.\u003C/p>\n\u003Ch2 id=\"adjacency-matrix\">Adjacency Matrix\u003C/h2>\n\u003Cp>An adjacency matrix is an \u003Ccode>NxN\u003C/code> boolean matrix (where \u003Ccode>N\u003C/code> is the number of nodes), where a true value at \u003Ccode>matrix[i][j]\u003C/code> indicates an edge from node \u003Ccode>i\u003C/code> to node \u003Ccode>j\u003C/code>. (You can also use an integer matrix with Os and 1s.)\u003C/p>\n\u003Cp>Note that in an undirected graph, an adjacency matrix will be symmetric. In a directed graph, it will not (necessarily) be.\u003C/p>\n\u003Cp>The same graph algorithms that are used on adjacency lists (breadth-first search, etc.) can be performed with adjacency matrices, but they may be somewhat less efficient. In the adjacency list representation, you can easily iterate through the neighbors of a node. In the adjacency matrix representation, you will need to iterate through all the nodes to identify a nodeâ€™s neighbors.\u003C/p>\n\u003Ch2 id=\"graph-search\">Graph Search\u003C/h2>\n\u003Cp>The two most common ways to search a graph are \u003Cstrong>depth-first search\u003C/strong> and \u003Cstrong>breadth-first search\u003C/strong>.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>In depth-first search (DFS), we start at the root (or another arbitrarily selected node) and explore each branch completely before moving on to the next branch. That is. we go deep first (hence the name depth-first search) before we go wide.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>In breadth-first search (BFS), we start at the root (or another arbitrarily selected node) and explore each neighbor before going on to any of their children. That is, we go wide (hence breadth-first search) before\nwe go deep.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>Breadth-first search and depth-first search tend to be used in different scenarios. DFS is often preferred if we want to visit every node in the graph. Both will work just fine, but depth-first search is a bit simpler. However, if we want to find the shortest path (or just any path) between two nodes, BFS is generally better.\u003C/p>\n\u003Ch3 id=\"dfs\">DFS\u003C/h3>\n\u003Cp>In DFS, we visit a node a and then iterate through each of aâ€™s neighbors. When visiting \u003Ccode>a\u003C/code> node \u003Ccode>b\u003C/code> that is a neighbor of \u003Ccode>a\u003C/code>, we visit all of \u003Ccode>b\u003C/code>â€™s neighbors before going on to \u003Ccode>a\u003C/code>â€™s other neighbors. That is, a exhaustively\nsearches \u003Ccode>b\u003C/code>â€™s branch before any of its other neighbors.\u003C/p>\n\u003Cp>Note that pre-order and other forms of tree traversal are a form of DFS. The key difference is that when implementing this algorithm for a graph, we must check if the node has been visited. If we donâ€™t, we risk getting stuck in an infinite loop.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dfs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">is\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">    visit\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> next\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">adjacent\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">            dfs\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">next\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bfs\">BFS\u003C/h3>\n\u003Cp>BFS is a bit less intuitive. The main tripping point is the (false) assumption that BFS is recursive. Itâ€™s not. Instead, it uses a queue.\u003C/p>\n\u003Cp>In BFS, node a visits each of aâ€™s neighbors before visiting any of their neighbors. You can think of this as searching level by level out from a. An iterative solution involving a queue usually works best.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bfs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> start\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">start\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    start\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        r \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">pop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">        visit\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">r\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">adjacent\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> False\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">visited \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">append\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If you are asked to implement BFS, the key thing to remember is the use of the queue. The rest of the algorithm flows from this fact.\u003C/p>\n\u003Ch3 id=\"bidirectional-search\">Bidirectional Search\u003C/h3>\n\u003Cp>Bidirectional search is used to find the shortest path between a source and destination node. It operates by essentially running two simultaneous breadth-first searches, one from each node. When their searches collide, we have found a path.\u003C/p>\n\u003Cp>\u003Cimg src=\"https://i.imgur.com/AQTtl8H.png\" alt=\"\">\u003C/p>\n\u003Cp>To see why this is faster, consider a graph where every node has at most k adjacent nodes and the shortest path from node s to node t has length d.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>In traditional breadth-first search, we would search up to \u003Ccode>k\u003C/code> nodes in the first â€œlevelâ€ of the search. In the second level, we would search up to \u003Ccode>k\u003C/code> nodes for each of those first \u003Ccode>k\u003C/code> nodes, so \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k^2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> nodes total (thus far).\nWe would do this \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">d\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6944em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">d\u003C/span>\u003C/span>\u003C/span>\u003C/span> times, so thatâ€™s \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmi>d\u003C/mi>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^d)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0991em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8491em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> nodes.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>In bidirectional search, we have two searches that collide after approximately \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">d/2\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">d\u003C/span>\u003Cspan class=\"mord\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span> levels (the midpoint of the path). The search from \u003Ccode>s\u003C/code> visits approximately \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>2\u003C/mn>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2k^{d/2}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.888em;\">\u003C/span>\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003Cspan class=\"mord mtight\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>, as does the search from \u003Ccode>t\u003C/code>. Thatâ€™s approximately \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(k^{d/2})\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.138em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003Cspan class=\"mord mtight\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> nodes total.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>So the the bidirectional search is actually faster by a factor of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmi>k\u003C/mi>\u003Cmrow>\u003Cmi>d\u003C/mi>\u003Cmi mathvariant=\"normal\">/\u003C/mi>\u003Cmn>2\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">k^{d/2}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.888em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.888em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">d\u003C/span>\u003Cspan class=\"mord mtight\">/2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Ch3 id=\"topological-sort\">Topological Sort\u003C/h3>\n\u003Ch2 id=\"shortest-path\">Shortest Path\u003C/h2>\n\u003Cp>Finding a shortest path between two nodes of a graph is an important problem\nthat has many practical applications. For example, a natural problem related to a road network is to calculate the shortest possible length of a route between two cities, given the lengths of the roads.\u003C/p>\n\u003Cp>In an unweighted graph, the length of a path equals the number of its edges,\nand we can simply use breadth-first search to find a shortest path. However, we focus on weighted graphs where more sophisticated algorithms are needed for finding shortest paths\u003C/p>\n\u003Ch3 id=\"bellman-ford\">Bellman-Ford\u003C/h3>\n\u003Cp>The Bellmanâ€“Ford algorithm finds shortest paths from a starting node to all\nnodes of the graph. The algorithm can process all kinds of graphs, provided that the graph does not contain a cycle with negative length. If the graph contains a negative cycle, the algorithm can detect this.\u003C/p>\n\u003Cp>The algorithm keeps track of distances from the starting node to all nodes\nof the graph. Initially, the distance to the starting node is 0 and the distance to all other nodes in infinite. The algorithm reduces the distances by finding edges that shorten the paths until it is not possible to reduce any distance\u003C/p>\n\u003Cp>The algorithm is based on the following observation: if we know the shortest path from the starting node to all nodes except one, we can find the shortest path to all nodes by adding one edge to the shortest path. The algorithm iterates through all edges of the graph and relaxes each edge. The relaxation of an edge means that we try to find a shorter path to the destination node of the edge by going through the source node of the edge. The algorithm repeats this process for a number of iterations, which is equal to the number of nodes in the graph. If the algorithm finds a shorter path to a node, it means that the graph contains a negative cycle. The algorithm can detect this by keeping track of the number of iterations. If the number of iterations is equal to the number of nodes in the graph, the graph contains a negative cycle.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bellman_ford\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> source\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">inf\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">source\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> _ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> range\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">len\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        assert\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the algorithm is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmi>m\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(nm)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">nm\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, because the algorithm consists of \u003Ccode>n âˆ’ 1\u003C/code> rounds and iterates through all \u003Ccode>m\u003C/code> edges during a round. If there are no negative cycles in the graph, all distances are final after \u003Ccode>n âˆ’ 1\u003C/code> rounds, because each shortest path can contain at most \u003Ccode>n âˆ’ 1\u003C/code> edges.\u003C/p>\n\u003Cp>In practice, the final distances can usually be found faster than in \u003Ccode>n âˆ’ 1\u003C/code> rounds. Thus, a possible way to make the algorithm more efficient is to stop the algorithm if no distance can be reduced during a round.\u003C/p>\n\u003Cblockquote>\n\u003Cp>\u003Cstrong>Note:\u003C/strong> We need to use this algorithm when the graph contains negative edges. If the graph contains only positive edges, we can use Dijkstraâ€™s algorithm, which is more efficient.\u003C/p>\n\u003C/blockquote>\n\u003Ch3 id=\"dijkstras-algorithm\">Dijkstraâ€™s Algorithm\u003C/h3>\n\u003Cp>Dijkstraâ€™s algorithm finds shortest paths from the starting node to all nodes of the graph, like the Bellmanâ€“Ford algorithm. The benefit of Dijkstraâ€™s algorithm is that it is more efficient and can be used for processing large graphs. However, the algorithm requires that there are no negative weight edges in the graph.\u003C/p>\n\u003Cp>Like the Bellmanâ€“Ford algorithm, Dijkstraâ€™s algorithm maintains distances\nto the nodes and reduces them during the search. Dijkstraâ€™s algorithm is efficient, because it only processes each edge in the graph once, using the fact that there are no negative edges.\u003C/p>\n\u003Cp>An efficient implementation of Dijkstraâ€™s algorithm requires that it is possible to efficiently find the minimum distance node that has not been processed. An appropriate data structure for this is a priority queue that contains the nodes ordered by their distances. Using a priority queue, the next node to be processed can be retrieved in logarithmic time\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dijkstra\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> source\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> dict\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> node \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">inf\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">node\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#FF5874\"> None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">source\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\"> PriorityQueue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">put\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">, source)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> not\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">empty\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        _\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">get\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            alt \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> alt \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> alt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                predecessor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                queue\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">put\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">(alt, v)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> predecessor\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the above implementation is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo>+\u003C/mo>\u003Cmi>m\u003C/mi>\u003Cmi>log\u003C/mi>\u003Cmo>â¡\u003C/mo>\u003Cmi>m\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n + m \\log m)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">m\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mop\">lo\u003Cspan style=\"margin-right:0.01389em;\">g\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">m\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, because\nthe algorithm goes through all nodes of the graph and adds for each edge at most one distance to the priority queue.\u003C/p>\n\u003Ch3 id=\"floyd-warshall\">Floyd-Warshall\u003C/h3>\n\u003Cp>The Floydâ€“Warshall algorithm provides an alternative way to approach the\nproblem of finding shortest paths. Unlike the other algorithms of this chapter, it finds all shortest paths between the nodes in a single run.\u003C/p>\n\u003Cp>The algorithm maintains a two-dimensional array that contains distances\nbetween the nodes. First, distances are calculated only using direct edges between the nodes, and after this, the algorithm reduces distances by using intermediate nodes in paths.\u003C/p>\n\u003Cp>The advantage of the Floydâ€“Warshall algorithm that it is easy to implement. The following code constructs a distance matrix where \u003Ccode>distance[a][b]\u003C/code> is the shortest distance between nodes a and b. First, the algorithm initializes distance using the adjacency matrix adj of the graph:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> floyd_warshall\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">graph\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    distance \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">inf\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">}\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">edges\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> k \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> j \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> graph\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">i\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">j\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> min\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">i\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">j\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">],\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">i\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">k\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">k\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">[\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">j\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D9F5DD\">]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> distance\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the algorithm is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmsup>\u003Cmi>n\u003C/mi>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n^3)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, because it contains three\nnested loops that go through the nodes of the graph. Since the implementation of the Floydâ€“Warshall algorithm is simple, the algorithm can be a good choice even if it is only needed to find a single shortest path in the graph. However, the algorithm can only be used when the graph is so\nsmall that a cubic time complexity is fast enough.\u003C/p>\n\u003Ch1 id=\"recursion\">Recursion\u003C/h1>\n\u003Cp>While there are a large number of recursive problems, many follows similar patterns. A good hint that a problem is recursive is that it can be built of sub-problems of the same type.\u003C/p>\n\u003Cp>When you hear a problem beginning with the following statements, itâ€™s often (though not always) a good candidate for recursion:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cem>Design an algorithm to compute the nth â€¦\u003C/em>\u003C/li>\n\u003Cli>\u003Cem>Write code to list the first n â€¦\u003C/em>\u003C/li>\n\u003Cli>\u003Cem>Implement a method to compute all ..,\u003C/em>\u003C/li>\n\u003C/ul>\n\u003Cp>Recursive solutions, by definition, are built off of solutions to subproblems. Many times, this will mean simply to compute \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> by adding something, removing something, or otherwise changing the solution\nfor \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>f\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">f(n-1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>. In other cases, you might solve the problem for the first half of the data set, then the second half, and then merge those results.\nThere are many ways you might divide a problem into subproblems.Three of the most common approaches to develop an algorithm are bottom-up, top-down, and half-and-half.\u003C/p>\n\u003Ch2 id=\"bottom-up\">Bottom-Up\u003C/h2>\n\u003Cp>The bottom-up approach is often the most intuitive. We start with knowing how to solve the problem for a simple case, like a list with only one element. Then we figure out how to solve the problem for two\nelements, then for three elements, and so on. The key here is to think about how you can build the solution for one case off of the previous case (or multiple previous cases).\u003C/p>\n\u003Ch2 id=\"top-down\">Top-Down\u003C/h2>\n\u003Cp>The top-down approach can be more complex since itâ€™s less concrete. But sometimes, itâ€™s the best way to think about the problem.\u003C/p>\n\u003Cp>In these problems, we think about how we can divide the problem for case \u003Ccode>N\u003C/code> into subproblems. Be careful of overlap between the cases.\u003C/p>\n\u003Ch2 id=\"half-and-half\">Half-and-Half\u003C/h2>\n\u003Cp>In addition to top-down and bottom-up approaches, itâ€™s often effective to divide the data set in half.\u003C/p>\n\u003Cp>For example, binary search works with a â€œhalf-and-halfâ€ approach. When we look for an element in a sorted array, we first figure out which half of the array contains the value. Then we recurse and search for it in that half.\u003C/p>\n\u003Cp>Merge sort is also a â€œhalf-and-halfâ€ approach. We sort each half of the array and then merge together the\nsorted halves.\u003C/p>\n\u003Ch2 id=\"recursion-vs-iteration\">Recursion vs. Iteration\u003C/h2>\n\u003Cp>Recursive algorithms can be very space inefficient. Each recursive call adds a new layer to the stack, which means that if your algorithm recurses to a depth of \u003Ccode>n\u003C/code>, it uses at least \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> memory.\u003C/p>\n\u003Cp>For this reason, itâ€™s often better to implement a recursive algorithm iteratively. All recursive algorithms can be implemented iteratively, although sometimes the code to do so is much more complex. Before diving\ninto recursive code, ask yourself how hard it would be to implement it iteratively,\u003C/p>\n\u003Ch1 id=\"dynamic-programming\">Dynamic Programming\u003C/h1>\n\u003Cp>Dynamic programming is a technique that combines the correctness of complete search and the efficiency of greedy algorithms. Dynamic programming can be applied if the problem can be divided into overlapping subproblems that can be solved independently.\u003C/p>\n\u003Cp>There are two uses for dynamic programming:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>Finding an optimal solution\u003C/strong>: We want to find a solution that is as large as possible or as small as possible.\u003C/li>\n\u003Cli>\u003Cstrong>Counting the number of solutions:\u003C/strong> We want to calculate the total number of possible solutions.\u003C/li>\n\u003C/ul>\n\u003C!-- # Greedy\n\n# Intervals -->\n\u003Ch1 id=\"bit-manipulation\">Bit Manipulation\u003C/h1>\n\u003Cp>All data in computer programs is internally stored as bits, i.e., as numbers 0 and 1. In programming, an n bit integer is internally stored as a binary number that consists of \u003Ccode>n\u003C/code> bits. For example, the \u003Ccode>C++\u003C/code> type int is a \u003Ccode>32-bit\u003C/code> type, which means that every \u003Ccode>int\u003C/code> number consists of 32 bits.\u003C/p>\n\u003Cp>The bits in the representation are indexed from right to left. To convert a bit representation $b_k Â· Â· Â· b_2 b_1 b_0 into a number, we can use the formula\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>âˆ‘\u003C/mo>\u003Cmi mathvariant=\"normal\">_\u003C/mi>\u003Cmsup>\u003Cmrow>\u003Cmi>i\u003C/mi>\u003Cmo>=\u003C/mo>\u003Cmn>0\u003C/mn>\u003C/mrow>\u003Cmi>k\u003C/mi>\u003C/msup>\u003Cmsub>\u003Cmi>b\u003C/mi>\u003Cmi>i\u003C/mi>\u003C/msub>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmi>i\u003C/mi>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\sum\\_{i=0}^k b_i 2^i\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1.2085em;vertical-align:-0.31em;\">\u003C/span>\u003Cspan class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">âˆ‘\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.1667em;\">\u003C/span>\u003Cspan class=\"mord\" style=\"margin-right:0.02778em;\">_\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">i\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8985em;\">\u003Cspan style=\"top:-3.1124em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord mathnormal\">b\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t vlist-t2\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.3117em;\">\u003Cspan style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"vlist-s\">â€‹\u003C/span>\u003C/span>\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.15em;\">\u003Cspan>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8247em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">i\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. To convert it to a decimal number, we can use the formula:\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>1\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>3\u003C/mn>\u003C/msup>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>2\u003C/mn>\u003C/msup>\u003Cmo>+\u003C/mo>\u003Cmn>0\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>1\u003C/mn>\u003C/msup>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>â‹…\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>0\u003C/mn>\u003C/msup>\u003Cmo>=\u003C/mo>\u003Cmn>8\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>4\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>0\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>=\u003C/mo>\u003Cmn>13\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">1 \\cdot 2^3 + 1 \\cdot 2^2 + 0 \\cdot 2^1 + 1 \\cdot 2^0 = 8 + 4 + 0 + 1 = 13\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">3\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">2\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">â‹…\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">0\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">8\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">4\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">0\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">13\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>The following code converts a binary number to a decimal number:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> binary_to_decimal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">binary\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    decimal \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> digit \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> binary\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        decimal \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> decimal \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">digit\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> decimal\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The time complexity of the above implementation is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmi>n\u003C/mi>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(n)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>, where \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span> is the length of the binary number.\u003C/p>\n\u003Cp>The bit representation of a number is either signed or unsigned. Usually a signed representation is used, which means that both negative and positive numbers can be represented. signed variable of n bits can contain any integer\nbetween \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">-2^{n-1}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ’\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{n-1} - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003Cspan class=\"mbin mtight\">âˆ’\u003C/span>\u003Cspan class=\"mord mtight\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For example, the \u003Ccode>C++\u003C/code> type \u003Ccode>int\u003C/code> is a signed \u003Ccode>32-bit\u003C/code> type, which means that it can contain any integer between \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmo>âˆ’\u003C/mo>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>31\u003C/mn>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">-2^{31}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">âˆ’\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">31\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>31\u003C/mn>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{31} - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">31\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>The first bit in a signed representation is the sign of the number (\u003Ccode>0\u003C/code> for nonnegative numbers and \u003Ccode>1\u003C/code> for negative numbers), and the remaining \u003Ccode>nâˆ’1\u003C/code> bits contain the magnitude of the number. Twoâ€™s complement is used, which means that the opposite number of a number is calculated by first inverting all the bits in the number, and then increasing the number by one.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. To convert it to a twoâ€™s complement representation, we first invert all the bits:\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmover accent=\"true\">\u003Cmn>1101\u003C/mn>\u003Cmo stretchy=\"true\">â€¾\u003C/mo>\u003C/mover>\u003Cmo>=\u003C/mo>\u003Cmn>0010\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">\\overline{1101} = 0010\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8444em;\">\u003C/span>\u003Cspan class=\"mord overline\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8444em;\">\u003Cspan style=\"top:-3em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">1101\u003C/span>\u003C/span>\u003C/span>\u003Cspan style=\"top:-3.7644em;\">\u003Cspan class=\"pstrut\" style=\"height:3em;\">\u003C/span>\u003Cspan class=\"overline-line\" style=\"border-bottom-width:0.04em;\">\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0010\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>Then we increase the number by one:\u003C/p>\n\u003Cp>\u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmn>0010\u003C/mn>\u003Cmo>+\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo>=\u003C/mo>\u003Cmn>0011\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">0010 + 1 = 0011\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">0010\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">+\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003Cspan class=\"mrel\">=\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2778em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">0011\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/p>\n\u003Cp>The result is the twoâ€™s complement representation of the number 13, which is 0011. The number -13 is represented as 1101 in binary. To\u003C/p>\n\u003Cp>In an unsigned representation, only nonnegative numbers can be used, but the upper bound for the values is larger. An unsigned variable of \u003Ccode>n\u003C/code> bits can contain any integer between 0 and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmi>n\u003C/mi>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^n - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.7477em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.6644em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mathnormal mtight\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>. For example, the \u003Ccode>C++\u003C/code> type \u003Ccode>unsigned int\u003C/code> is an unsigned \u003Ccode>32-bit\u003C/code> type, which means that it can contain any integer between 0 and \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>32\u003C/mn>\u003C/msup>\u003Cmo>âˆ’\u003C/mo>\u003Cmn>1\u003C/mn>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{32} - 1\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">32\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003Cspan class=\"mbin\">âˆ’\u003C/span>\u003Cspan class=\"mspace\" style=\"margin-right:0.2222em;\">\u003C/span>\u003C/span>\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.6444em;\">\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Ch2 id=\"bitwise-operators\">Bitwise Operators\u003C/h2>\n\u003Ch3 id=\"bitwise-and\">Bitwise AND\u003C/h3>\n\u003Cp>The bitwise AND operator \u003Ccode>&#x26;\u003C/code> compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of both numbers are \u003Ccode>1\u003C/code>.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise AND of 13 and 7 is 0101, which is the number 5.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_and\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-or\">Bitwise OR\u003C/h3>\n\u003Cp>The bitwise OR operator \u003Ccode>|\u003C/code> compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are \u003Ccode>1\u003C/code>.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise OR of 13 and 7 is 1111, which is the number 15.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-xor\">Bitwise XOR\u003C/h3>\n\u003Cp>The bitwise XOR operator \u003Ccode>^\u003C/code> compares two numbers on a bit level and returns a number where the bits of that number are turned on if the corresponding bits of either of the two numbers are \u003Ccode>1\u003C/code>, but not both.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The number 7 is represented as 0111 in binary. The bitwise XOR of 13 and 7 is 1010, which is the number 10.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_xor\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-not\">Bitwise NOT\u003C/h3>\n\u003Cp>The bitwise NOT operator \u003Ccode>~\u003C/code> inverts all the bits of its operand.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The bitwise NOT of 13 is 0010, which is the number 2.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_not\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ~\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">a\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"bitwise-shifts\">Bitwise Shifts\u003C/h3>\n\u003Cp>The bitwise left shift operator \u003Ccode>&#x3C;&#x3C;\u003C/code> shifts the bits of its first operand the specified number of positions to the left. The bits shifted off the left end are discarded. The bits on the right end are filled with zeros.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The bitwise left shift of 13 by 1 is 1010, which is the number 10.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_left_shift\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bitwise right shift operator \u003Ccode>>>\u003C/code> shifts the bits of its first operand the specified number of positions to the right. The bits shifted off the right end are discarded. The bits on the left end are filled with zeros.\u003C/p>\n\u003Cp>For example, the number 13 is represented as 1101 in binary. The bitwise right shift of 13 by 1 is 0110, which is the number 6.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bitwise_right_shift\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"bitwise-tricks\">Bitwise Tricks\u003C/h2>\n\u003Ch3 id=\"check-if-a-number-is-even-or-odd\">Check if a number is even or odd\u003C/h3>\n\u003Cp>A number is even if the last bit is \u003Ccode>0\u003C/code> and odd if the last bit is \u003Ccode>1\u003C/code>. We can check if a number is even or odd by checking the last bit of the number. If the last bit is \u003Ccode>0\u003C/code>, the number is even, otherwise, it is odd.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> is_even\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"check-if-a-number-is-a-power-of-two\">Check if a number is a power of two\u003C/h3>\n\u003Cp>A number is a power of two if it has only one bit set to \u003Ccode>1\u003C/code>. We can check if a number is a power of two by checking if the number has only one bit set to \u003Ccode>1\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> is_power_of_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"swap-two-numbers\">Swap two numbers\u003C/h3>\n\u003Cp>We can swap two numbers by using the bitwise XOR operator \u003Ccode>^\u003C/code>. The bitwise XOR of two numbers is \u003Ccode>0\u003C/code> if the two numbers are the same, and it is \u003Ccode>1\u003C/code> if the two numbers are different. We can use this property to swap two numbers.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> swap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    b \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"get-the-last-set-bit\">Get the last set bit\u003C/h3>\n\u003Cp>We can get the last set bit of a number by using the bitwise AND operator \u003Ccode>&#x26;\u003C/code> with the twoâ€™s complement of the number.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_last_set_bit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">a\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"hamming-distance\">Hamming distance\u003C/h3>\n\u003Cp>The Hamming distance between two integers is the number of positions at which the corresponding bits are different.\u003C/p>\n\u003Cp>Given two integers \u003Ccode>x\u003C/code> and \u003Ccode>y\u003C/code>, calculate the Hamming distance.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> hamming_distance\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> bin\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">).\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#B2CCD6\">count\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">1\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"count-the-number-of-set-bits\">Count the number of set bits\u003C/h3>\n\u003Cp>We can count the number of set bits in a number by repeatedly clearing the last set bit of the number until the number becomes \u003Ccode>0\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> count_set_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    count \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        count \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> count\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"reverse-bits\">Reverse bits\u003C/h3>\n\u003Cp>We can reverse the bits of a number by repeatedly shifting the number to the right and appending the last bit to the result.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">def\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> reverse_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#FF9800;--shiki-dark:#7FDBCA\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    result \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> _ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">in\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> range\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        result \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (result \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> result\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":350,"localImagePaths":534,"remoteImagePaths":535,"frontmatter":536,"imagePaths":539},[351,354,357,360,363,366,369,372,375,378,381,384,387,390,393,396,399,402,405,408,411,414,417,420,423,426,429,432,435,438,441,444,447,450,453,456,459,462,465,468,471,474,477,480,483,486,489,492,495,498,501,504,507,510,513,516,519,522,525,528,531],{"depth":32,"slug":352,"text":353},"arrays","Arrays",{"depth":32,"slug":355,"text":356},"hashtable","HashTable",{"depth":32,"slug":358,"text":359},"arraylist--resizablearray","ArrayList & ResizableArray",{"depth":213,"slug":361,"text":362},"binary-search","Binary Search",{"depth":32,"slug":364,"text":365},"algorithms","Algorithms",{"depth":131,"slug":367,"text":368},"quickselect","QuickSelect",{"depth":213,"slug":370,"text":371},"stack","Stack",{"depth":32,"slug":373,"text":374},"queue","Queue",{"depth":213,"slug":376,"text":377},"linked-list","Linked List",{"depth":32,"slug":379,"text":380},"singly-linked-list","Singly Linked List",{"depth":32,"slug":382,"text":383},"techniques","Techniques",{"depth":213,"slug":385,"text":386},"trees","Trees",{"depth":32,"slug":388,"text":389},"binary-tree","Binary Tree",{"depth":32,"slug":391,"text":392},"binary-search-tree","Binary Search Tree",{"depth":131,"slug":394,"text":395},"balanced-vs-unbalanced","Balanced vs Unbalanced",{"depth":131,"slug":397,"text":398},"complete-binary-tree","Complete Binary Tree",{"depth":131,"slug":400,"text":401},"full-binary-tree","Full Binary Tree",{"depth":131,"slug":403,"text":404},"perfect-binary-tree","Perfect Binary Tree",{"depth":32,"slug":406,"text":407},"binary-tree-traversal","Binary Tree Traversal",{"depth":131,"slug":409,"text":410},"in-order-traversal","In-order Traversal",{"depth":131,"slug":412,"text":413},"pre-order-traversal","Pre-order Traversal",{"depth":131,"slug":415,"text":416},"post-order-traversal","Post-order Traversal",{"depth":131,"slug":418,"text":419},"level-order-traversal","Level-order Traversal",{"depth":32,"slug":421,"text":422},"binary-heaps-min-heap-and-max-heap","Binary Heaps (min-heap and max-heap)",{"depth":131,"slug":424,"text":425},"insert","Insert",{"depth":131,"slug":427,"text":428},"extract-min","Extract Min",{"depth":213,"slug":430,"text":431},"tries","Tries",{"depth":213,"slug":433,"text":434},"backtracking","Backtracking",{"depth":213,"slug":436,"text":437},"graphs","Graphs",{"depth":32,"slug":439,"text":440},"adjacency-lists","Adjacency Lists",{"depth":32,"slug":442,"text":443},"adjacency-matrix","Adjacency Matrix",{"depth":32,"slug":445,"text":446},"graph-search","Graph Search",{"depth":131,"slug":448,"text":449},"dfs","DFS",{"depth":131,"slug":451,"text":452},"bfs","BFS",{"depth":131,"slug":454,"text":455},"bidirectional-search","Bidirectional Search",{"depth":131,"slug":457,"text":458},"topological-sort","Topological Sort",{"depth":32,"slug":460,"text":461},"shortest-path","Shortest Path",{"depth":131,"slug":463,"text":464},"bellman-ford","Bellman-Ford",{"depth":131,"slug":466,"text":467},"dijkstras-algorithm","Dijkstraâ€™s Algorithm",{"depth":131,"slug":469,"text":470},"floyd-warshall","Floyd-Warshall",{"depth":213,"slug":472,"text":473},"recursion","Recursion",{"depth":32,"slug":475,"text":476},"bottom-up","Bottom-Up",{"depth":32,"slug":478,"text":479},"top-down","Top-Down",{"depth":32,"slug":481,"text":482},"half-and-half","Half-and-Half",{"depth":32,"slug":484,"text":485},"recursion-vs-iteration","Recursion vs. Iteration",{"depth":213,"slug":487,"text":488},"dynamic-programming","Dynamic Programming",{"depth":213,"slug":490,"text":491},"bit-manipulation","Bit Manipulation",{"depth":32,"slug":493,"text":494},"bitwise-operators","Bitwise Operators",{"depth":131,"slug":496,"text":497},"bitwise-and","Bitwise AND",{"depth":131,"slug":499,"text":500},"bitwise-or","Bitwise OR",{"depth":131,"slug":502,"text":503},"bitwise-xor","Bitwise XOR",{"depth":131,"slug":505,"text":506},"bitwise-not","Bitwise NOT",{"depth":131,"slug":508,"text":509},"bitwise-shifts","Bitwise Shifts",{"depth":32,"slug":511,"text":512},"bitwise-tricks","Bitwise Tricks",{"depth":131,"slug":514,"text":515},"check-if-a-number-is-even-or-odd","Check if a number is even or odd",{"depth":131,"slug":517,"text":518},"check-if-a-number-is-a-power-of-two","Check if a number is a power of two",{"depth":131,"slug":520,"text":521},"swap-two-numbers","Swap two numbers",{"depth":131,"slug":523,"text":524},"get-the-last-set-bit","Get the last set bit",{"depth":131,"slug":526,"text":527},"hamming-distance","Hamming distance",{"depth":131,"slug":529,"text":530},"count-the-number-of-set-bits","Count the number of set bits",{"depth":131,"slug":532,"text":533},"reverse-bits","Reverse bits",[],[],{"author":14,"pubDatetime":537,"title":341,"slug":337,"featured":17,"draft":198,"tags":538,"description":343},["Date","2022-12-01T00:00:00.000Z"],[19],[],"compressed-fixedvec",{"id":540,"data":542,"body":547,"filePath":548,"digest":549,"rendered":550},{"author":14,"pubDatetime":543,"title":544,"featured":198,"draft":17,"tags":545,"description":546},["Date","2025-09-24T00:00:00.000Z"],"Engineering a fixed-width bit-packed Integer Vector in Rust",[200,300],"Design and implementation of a memory-efficient, fixed-width bit-packed integer vector in Rust, with extremely fast random access.","If you've ever worked with massive datasets, you know that memory usage can quickly become a bottleneck. While developing succinct data structures, I found myself needing to store large arrays of integersâ€”values with no monotonicity or other exploitable patterns, that I knew came from a universe much smaller than their type's theoretical capacity.\n\nIn this post, we will explore the engineering challenges involved in implementing an efficient vector-like data structure in Rust that stores integers in a compressed, bit-packed format. We will focus on achieving O(1) random access performance while minimizing memory usage. We will try to mimic the ergonomics of Rust's standard `Vec\u003CT>` as closely as possible, including support for mutable access and zero-copy slicing.\n\n\n* All the code can be found on github: [compressed-intvec](https://github.com/lukefleed/compressed-intvec)\n* This is also published as a crate on crates.io: [compressed-intvec](https://crates.io/crates/compressed-intvec)\n\nYou can discuss this post on [Hacker News](https://news.ycombinator.com/item?id=45361578), [Lobsters](https://lobste.rs/s/u1rffj/engineering_fixed_width_bit_packed) or [Reddit](https://www.reddit.com/r/rust/comments/1npf41d/engineering_a_fixedwidth_bitpacked_integer_vector/).\n\n---\n\n## Table of contents\n\n# Memory Waste in Standard Vectors\n\nIn Rust, the contract of a `Vec\u003CT>` (where `T` is a primitive integer type like `u64` or `i32`) is simple: O(1) random access in exchange for a memory layout that is tied to the static size of `T`. This is a good trade-off, until it isn't. When the dynamic range of the stored values is significantly smaller than the type's capacity, this memory layout leads to substantial waste.\n\nConsider storing the value `5` within a `Vec\u003Cu64>`. Its 8-byte in-memory representation is:\n\n\u003Cdiv align=\"center\">\n\n`00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000101`\n\n\u003C/div>\n\nOnly 3 bits are necessary to represent the value, leaving 61 bits as zero-padding. The same principle applies, albeit less dramatically, when storing `5` in a `u32` or `u16`. At scale, this overhead becomes prohibitive. A vector of one billion `u64` elements consumes `10^9 * std::mem::size_of::\u003Cu64>()`, or approximately 8 GB of memory, even if every element could fit within a single byte.\n\nThe canonical solution is bit packing, which aligns data end-to-end in a contiguous bitvector. However, this optimization has historically come at the cost of random access performance. The O(1) access guarantee of `Vec\u003CT>` is predicated on simple pointer arithmetic: `address = base_address + index * std::mem::size_of::\u003CT>()`. Tightly packing the bits invalidates this direct address calculation, seemingly forcing a trade-off between memory footprint and access latency.\n\nThis raises the central question that with this post we aim to answer: is it possible to design a data structure that decouples its memory layout from the static size of `T`, adapting instead to the data's true dynamic range, without sacrificing the O(1) random access that makes `Vec\u003CT>` so effective?\n\n# Packing and Accessing Bits\n\nIf the dynamic range of our data is known, we can define a fixed `bit_width` for every integer. For instance, if the maximum value in a dataset is `1000`, we know every number can be represented in 10 bits, since `2^10 = 1024`. Instead of allocating 64 bits per element, we can store them back-to-back in a contiguous bitvector, forming the core of what from now on we'll refer as `FixedVec`. We can immagine such data strucutre as a logical array of `N` integers, each `bit_width` bits wide, stored in a backing buffer of `u64` words.\n\n```rust\nstruct FixedVec {\n    limbs: Vec\u003Cu64>, // Backing storage\n    bit_width: usize, // Number of bits per element\n    len: usize, // Number of elements\n    mask: u64, // Precomputed mask for extraction\n}\n```\n\nWhere the role of the `mask` field is to isolate the relevant bits during extraction. For a `bit_width` of 10, the mask would be `0b1111111111`.\n\nThis immediately solves the space problem, but how can we find the `i`-th element in O(1) time if it doesn't align to a byte boundary? The answer lies in simple arithmetic. The starting bit position of any element is a direct function of its index. Given a backing store of `u64` words, we can locate any value by calculating its absolute bit position and then mapping that to a specific word and an offset within that word.\n\n```rust\nlet bit_pos = index * bit_width; // Absolute bit position of the value\nlet word_index = bit_pos / 64; // Which u64 word to read\nlet bit_offset = bit_pos % 64; // Where the value starts in that word\n```\n\nWith these values, the implementation of `get_unchecked` becomes straightforward. It's a two-step process: fetch the correct word from our backing `Vec\u003Cu64>`, then use bitwise operations to isolate the specific bits we need.\n\n```rust\n// A simplified look at the core get_unchecked logic\nunsafe fn get_unchecked(&self, index: usize) -> u64 {\n    let bit_width = self.bit_width();\n    let bit_pos = index * bit_width;\n    let word_index = bit_pos / 64;\n    let bit_offset = bit_pos % 64;\n\n    // 1. Fetch the word from the backing store\n    let word = *self.limbs.get_unchecked(word_index);\n\n    // 2. Shift and mask to extract the value\n    (word >> bit_offset) & self.mask\n}\n```\n\nLet's trace an access with `bit_width = 10` for the element at `index = 7`. The starting bit position is `7 * 10 = 70`. This maps to `word_index = 1` and `bit_offset = 6`. Our 10-bit integer begins at the 6th bit of the *second* `u64` word in our storage.\n\nThe right-shift `>>` operation moves the bits of the entire `u64` word to the right by `bit_offset` positions. This aligns the start of our desired 10-bit value with the least significant bit (LSB) of the word. The final step is to isolate our value. A pre-calculated `mask` (e.g., `0b1111111111` for 10 bits) is applied with a bitwise AND `&`. This zeroes out any high-order bits from the word, leaving just our target integer.\n\n\n## Crossing Word Boundaries\n\nThe single-word access logic is fast, but it only works as long as `bit_offset + bit_width \u003C= 64`. This assumption breaks down as soon as an integer's bit representation needs to cross the boundary from one `u64` word into the next. This is guaranteed to happen for any `bit_width` that is not a power of two. For example, with a 10-bit width, the element at `index = 6` starts at bit position 60. Its 10 bits will occupy bits 60-63 of the first word and bits 0-5 of the second. The simple right-shift-and-mask trick fails here.\n\n![crossing word boundaries](/assets/fixedvec.svg)\n\nTo correctly decode the value, we must read *two* consecutive `u64` words and combine their bits. This splits our `get_unchecked` implementation into two paths. The first is the fast path we've already seen. The second is a new path for spanning values.\n\nTo get the lower bits of the value, we read the first word and shift right, just as before. This leaves the upper bits of the word as garbage.\n\n```rust\nlet low_part = *limbs.get_unchecked(word_index) >> bit_offset;\n```\n\nTo get the upper bits of the value, we read the *next* word. The bits we need are at the beginning of this word, so we shift them left to align them correctly.\n\n```rust\nlet high_part = *limbs.get_unchecked(word_index + 1) \u003C\u003C (64 - bit_offset);\n```\n\nFinally, we combine the two parts with a bitwise OR and apply the mask to discard any remaining high-order bits from the `high_part`.\n\n```rust\n(low_part | high_part) & self.mask\n```\n\nThe line `limbs.get_unchecked(word_index + 1)` introduces a safety concern: if we are reading the last element of the vector, `word_index + 1` could point past the end of our buffer, leading to undefined behavior. To prevent this, our builder must always allocate one extra padding word at the end of the storage.\n\nIntegrating these two paths gives us our final `get_unchecked` implementation:\n\n```rust\npub unsafe fn get_unchecked(&self, index: usize) -> u64 {\n    let bit_width = self.bit_width;\n    let bit_pos = index * bit_width;\n    let word_index = bit_pos / 64;\n    let bit_offset = bit_pos % 64;\n\n    let limbs = self.bits.as_ref();\n\n    if bit_offset + bit_width \u003C= 64 {\n        // Fast path: value is fully within one word\n        (*limbs.get_unchecked(word_index) >> bit_offset) & self.mask\n    } else {\n        // Slow path: value spans two words.\n        let low_part = *limbs.get_unchecked(word_index) >> bit_offset;\n        let high_part = *limbs.get_unchecked(word_index + 1) \u003C\u003C (64 - bit_offset);\n        (low_part | high_part) & self.mask\n    }\n}\n```\n\n## Faster Reads: Unaligned Access\n\nOur `get_unchecked` implementation is correct, but the slow path for spanning values requires two separate, aligned memory reads. The instruction sequence for this method involves at least two load instructions, multiple shifts, and a bitwise OR. These instructions have data dependencies: the shifts cannot execute until the loads complete, and the OR cannot execute until both shifts are done. This dependency chain can limit the CPU's instruction-level parallelism and create pipeline stalls if the memory accesses miss the L1 cache.\n\nLet's have a look at the machine code generated by this method. We can create a minimal binary with an `#[inline(never)]` function that calls `get_unchecked` on a known spanning index, then use [`cargo asm`](https://crates.io/crates/cargo-asm) to inspect the disassembly.\n\n```asm\n; asm_test::aligned::get_aligned (spanning path)\n.LBB14_2:\n        ; let low = *limbs.get_unchecked(word_index) >> bit_offset;\n        mov rsi, qword ptr [r8 + 8*rdx]      ; \u003C\u003C\u003C LOAD #1 (low_part)\n\n        ; let high = *limbs.get_unchecked(word_index + 1) \u003C\u003C (64 - bit_offset);\n        mov rdx, qword ptr [r8 + 8*rdx + 8]  ; \u003C\u003C\u003C LOAD #2 (high_part)\n\n        shr rsi, cl                          ; shift right of low_part\n        shl rdx, cl                          ; shift left of high_part\n        or rdx, rsi                          ; combine results\n```\n\nThe instruction `mov rsi, qword ptr [r8 + 8*rdx]` is our first memory access. It loads a 64-bit value (`qword`) into the `rsi` register. The address is calculated using base-plus-index addressing: `r8` holds the base address of our `limbs` buffer, and `rdx` holds the `word_index`. This corresponds directly to `limbs[word_index]`.\n\nImmediately following is `mov rdx, qword ptr [r8 + 8*rdx + 8]`. This is our second, distinct memory access. It loads the *next* 64-bit word from memory by adding an 8-byte offset to the previous address. This corresponds to `limbs[word_index + 1]`.\n\nOnly after both of these `mov` instructions complete can the CPU proceed. The `shr rsi, cl` instruction (shift right `rsi` by the count in `cl`) cannot execute until the first `mov` has placed a value in `rsi`. Similarly, `shl rdx, cl` depends on the second `mov`. Finally, `or rdx, rsi` depends on both shifts.\n\nThis sequence of operationsâ€”loading two adjacent 64-bit words, shifting each, and combining them is a software implementation of what is, conceptually, a [128-bit barrel shifter](https://en.wikipedia.org/wiki/Barrel_shifter). We are selecting a 64-bit window from a virtual 128-bit integer formed by concatenating the two words from memory.\n\n**Can we do better then this?** Potentially, yes. We can replace this multi-instruction sequence with something more direct by delegating the complexity to the hardware and performing a single unaligned memory read. Modern x86-64 CPUs handle this directly: when an unaligned load instruction is issued, the CPU's memory controller fetches the necessary cache lines and the load/store unit reassembles the bytes into the target register. This entire process is a single, optimized micro-operation.\n\nWe can try to implement a more aggressive access method. The strategy is to calculate the exact *byte* address where our data begins and perform a single, unaligned read of a full `W` word from that position.\n\nThe implementation first translates the absolute bit position into a byte address and a residual bit offset within that byte.\n\n```rust\nlet bit_pos = index * self.bit_width;\nlet byte_pos = bit_pos / 8;\nlet bit_rem = bit_pos % 8;\n```\n\nWith the byte-level address, we get a raw `*const u8` pointer to our storage and perform the unaligned read. The [read_unaligned](https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html) intrinsic in Rust compiles down to a single machine instruction that the hardware can execute efficiently.\n\n```rust\nlet limbs_ptr = self.as_limbs().as_ptr() as *const u8;\n// This read may cross hardware word boundaries, but the CPU handles it.\nlet word: W = (limbs_ptr.add(byte_pos) as *const W).read_unaligned();\n```\n\nOn a Little-Endian system, the loaded `word` now contains our target integer, but it's shifted by `bit_rem` positions. A simple right shift aligns our value to the LSB, and applying the mask isolates it.\n\n```rust\nlet extracted_word = word >> bit_rem;\nlet final_value = extracted_word & self.mask;\n```\n\nThis operation is safe only because, as said before, we are supposing that our builder guarantees a padding word at the end of the storage buffer. Combining all these steps, we get our final implementation:\n\n```rust\npub unsafe fn get_unaligned_unchecked(&self, index: usize) -> u64 {\n    let bit_pos = index * self.bit_width;\n    let byte_pos = bit_pos / 8;\n    let bit_rem = bit_pos % 8;\n\n    let limbs_ptr = self.as_limbs().as_ptr() as *const u8;\n    // SAFETY: The builder guarantees an extra padding word at the end.\n    let word = (limbs_ptr.add(byte_pos) as *const W).read_unaligned();\n    let extracted_word = word >> bit_rem;\n    extracted_word & self.mask\n}\n```\n\nLet's have a look at the generated machine code for this new method when accessing an index that spans words:\n\n```asm\n; asm_test::unaligned::get_unaligned\n.LBB15_1:\n        ; let bit_pos = index * self.bit_width;\n        imul rcx, rax\n        ; let byte_pos = bit_pos / 8;\n        mov rax, rcx\n        shr rax, 3\n        ; self.bits.as_ref()\n        mov rdx, qword ptr [rdi + 8]\n        ; unsafe { crate::intrinsics::copy_nonoverlapping(src, dst, count) }\n        mov rax, qword ptr [rdx + rax]       ; \u003C\u003C\u003C SINGLE UNALIGNED LOAD\n        ; self >> other\n        and cl, 7\n        shr rax, cl\n        ; fn bitand(self, rhs: $t) -> $t { self & rhs }\n        and rax, qword ptr [rdi + 32]\n```\n\nThe initial `imul` and `shr rax, 3` (a fast division by 8) correspond to the calculation of `byte_pos`. The instruction `mov rdx, qword ptr [rdi + 8]` loads the base address of our `limbs` buffer into the `rdx` register.\n\nThe instruction `mov rax, qword ptr [rdx + rax]` is our single unaligned load. The address `[rdx + rax]` is the sum of the buffer's base address and our calculated `byte_pos`. This `mov` instruction reads 8 bytes (a `qword`) directly from this potentially unaligned memory location into the `rax` register. We can see that as we hoped, the [read_unaligned](https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html) intrinsic has been compiled down to a single hardware instruction.\n\nThe next instructions handle the extraction. The `and cl, 7` and `shr rax, cl` sequence corresponds to our `>> bit_rem`. `cl` holds the lower bits of the original `bit_pos` (our `bit_rem`), and the shift aligns our desired value to the LSB of the `rax` register. Finally, `and rax, qword ptr [rdi + 32]` applies the pre-calculated mask, which is stored at an offset from the `self` pointer in `rdi`.\n\n## Random Access Performance\n\nWe can now benchmark the latency of 1 million random access operations on a vector containing 10 million elements. For each `bit_width`, we generate data with a uniform random distribution in the range `[0, 2^bit_width)`. The code for the benchmark is available here: [`bench-intvec`]\n\nOur baseline is the smallest standard `Vec\u003CT>` capable of holding the data (`Vec\u003Cu8>` for `bit_width \u003C= 8`, etc.). We also include results from [`sux`], [`succinct`], and [`simple-sds-sbwt`] for context. I am not aware of any other Rust crates that implement fixed-width bit-packed integer vectors, so if you know of any, please let me know!\n\n\u003Ciframe src=\"/bench-intvec/fixed_random_access_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nWe can see that for `bit_width` values below 32, the `get_unaligned_unchecked` of our `FixedVec` is almost always faster than the corresponding `Vec\u003CT>` baseline. This is a result of improved cache locality. A 64-byte L1 cache line can hold 64 elements from a `Vec\u003Cu8>`. With a `bit_width` of 4, the same cache line holds `(64 * 8) / 4 = 128` elements from our `FixedVec`. This increased density improves the cache hit rate for random access patterns, and the latency reduction from avoiding DRAM access outweighs the instruction cost of the bitwise extraction. For values of `bit_width` above 32, the performance of `FixedVec` are *very slightly* worse than the `Vec\u003CT>` baseline, as the cache locality advantage diminishes. However, the memory savings remain.\n\nThe performance delta between `get_unaligned_unchecked` and `get_unchecked` confirms the unaligned access strategy discussed before: a single `read_unaligned` instruction is more efficient than the two dependent aligned reads required by the logic for spanning words.\n\nWe can see that the implementation of [`sux`] is almost on par with ours. The other two crates, [`succinct`] and [`simple-sds-sbwt`], are significantly slower (note that the Y-axis is logarithmic). Tho, it's worth noting that neither of these last two crates provides unchecked or unaligned access methods, so their implementations are inherently more conservative.\n\n[`sux`]: https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\n[`succinct`]: https://docs.rs/succinct/latest/succinct/trait.IntVec.html\n[`simple-sds-sbwt`]: https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\n[`bench-intvec`]: https://github.com/lukefleed/compressed-intvec/blob/master/benches/fixed/bench_random_access.rs\n\n## Iterating Over Values\n\nThe most common operation on any `Vec`-like structure is, after all, a simple `for` loop. The simplest way to implement `iter()` would be to just wrap `get()` in a loop:\n\n```rust\n// A naive, inefficient iterator\nfor i in 0..vec.len() {\n    let value = vec.get(i);\n    // ... do something with value\n}\n```\n\nThis works, but it's terribly inefficient. Every single call to `get(i)` independently recalculates the `word_index` and `bit_offset` from scratch. We're throwing away valuable state, our current position in the bitstream, on every iteration, forcing the CPU to perform redundant multiplications and divisions.\n\nWe can think then about a *stateful* iterator. It should operate directly on the bitvector, maintaining its own position. Instead of thinking in terms of logical indices, it should think in terms of a \"bit window\", a local `u64` register that holds the current chunk of bits being processed.\n\nThe idea is simple: the iterator loads one `u64` word from the backing store into its window. It then satisfies `next()` calls by decoding values directly from this in-register window. Only when the window runs out of bits does it need to go back to memory for the next `u64` word. This amortizes the cost of memory access over many `next()` calls.\n\nFor forward iteration, the state is minimal:\n\n```rust\nstruct FixedVecIter\u003C'a, ...> {\n    // ...\n    front_window: u64,\n    front_bits_in_window: usize,\n    front_word_index: usize,\n    // ...\n}\n```\n\nThe `next()` method first checks if the current `front_window` has enough bits to satisfy the request. If `self.front_bits_in_window >= bit_width`, it's the fast path: a simple shift and mask on a register, which is incredibly fast.\n\n```rust\n// Inside next(), fast path:\nif self.front_bits_in_window >= bit_width {\n    let value = self.front_window & self.mask;\n    self.front_window >>= bit_width;\n    self.front_bits_in_window -= bit_width;\n    return Some(value);\n}\n```\n\nIf the window is running low on bits, we hit the slower path. The next value spans the boundary between our current window and the next `u64` word in memory. We must read the next word, combine its bits with the remaining bits in our current window, and then extract the value. This is the same logic as the spanning-word `get()`, but it's performed incrementally.\n\n### Double-Ended Iteration\n\nBut I want my iterator to be bidirectional! Well, then we need to ensure it implements [`DoubleEndedIterator`](https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html) and supports [`next_back()`](https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html#tymethod.next_back). This throws a wrench in our simple stateful model. A single window and cursor can only move in one direction.\n\nThe solution is to maintain two independent sets of state: one for the front and one for the back. The `FixedVecIter` needs to track two windows, two bit counters, and two word indices.\n\n```rust\nstruct FixedVecIter\u003C'a, ...> {\n    // ...\n    front_index: usize,\n    back_index: usize,\n\n    // State for forward iteration\n    front_window: u64,\n    front_bits_in_window: usize,\n    front_word_index: usize,\n\n    // State for backward iteration\n    back_window: u64,\n    back_bits_in_window: usize,\n    back_word_index: usize,\n    // ...\n}\n```\n\nInitializing the front is easy: we load `limbs[0]` into `front_window`. The back is more complex. We must calculate the exact word index and the number of valid bits in the *last* word that contains data. This requires a bit of arithmetic to handle cases where the data doesn't perfectly fill the final word.\n\nThe `next()` method consumes from the `front_window`, advancing the front state. The `next_back()` method consumes from the `back_window`, advancing the back state. The iterator is exhausted when `front_index` meets `back_index`.\n\n> The full implementation can be found in the iter module of the [library](https://github.com/lukefleed/compressed-intvec/blob/master/src/fixed/iter.rs)\n\n# Writing bits\n\nWe have solved the read problem, but we may also want to modify values in place. A method like `set(index, value)` seems simple, but it opens up the same can of worms as `get`, just in reverse. We can't just write the new value; we have to do so without clobbering the adjacent, unrelated data packed into the same `u64` word.\n\nJust like with reading, the logic splits into two paths. The \"fast path\" handles values that are fully contained within a single `u64`. Here, we can't just overwrite the word. We first need to clear out the bits for the element we're replacing and then merge in the new value.\n\n## In-Word Write\n\nOur goal here is to update a `bit_width`-sized slice of a `u64` word while leaving the other bits untouched. This operation must be a read-modify-write sequence to avoid corrupting adjacent elements. The most efficient way to implement this is to load the entire word into a register, perform all bitwise modifications locally, and then write the final result back to memory in a single store operation.\n\nFirst, we load the word from our backing `limbs` slice.\n\n```rust\nlet mut word = *limbs.get_unchecked(word_index);\n```\n\nNext, we need to create a \"hole\" in our local copy where the new value will go. We do this by creating a mask that has ones *only* in the bit positions we want to modify, and then inverting it to create a clearing mask.\n\n```rust\n// For a value at bit_offset, the mask must also be shifted.\nlet clear_mask = !(self.mask \u003C\u003C bit_offset);\n// Applying this mask zeroes out the target bits in our register copy.\nword &= clear_mask;\n```\n\nWith the target bits zeroed, we can merge our new value. The value is first shifted left by `bit_offset` to align it correctly within the 64-bit word. Then, a bitwise OR merges it into the \"hole\" we just created.\n\n```rust\n// Shift the new value into position and merge it.\nword |= value_w \u003C\u003C bit_offset;\n```\n\nFinally, with the modifications complete, we write the updated word from the register back to memory in a single operation.\n\n```rust\n*limbs.get_unchecked_mut(word_index) = word;\n```\nThis entire sequence of one read, two bitwise operations in-register, one write is the canonical and most efficient way to perform a sub-word update.\n\n## Spanning Write\n\nNow for the hard part: writing a value that crosses a word boundary. This operation must modify two separate `u64` words in our backing store. It's the inverse of the spanning read. We need to split our `value_w` into a low part and a high part and write each to the correct word, minimizing memory accesses.\n\nTo operate on two distinct memory locations, `limbs[word_index]` and `limbs[word_index + 1]`, we first need mutable access to both. In a safe, hot path like this, we can use `split_at_mut_unchecked` to bypass Rust's borrow checker bounds checks, as we have already guaranteed through our logic that both indices are valid.\n\n```rust\n// SAFETY: We know word_index and word_index + 1 are valid.\nlet (left, right) = limbs.split_at_mut_unchecked(word_index + 1);\n```\n\nOur strategy is to read both words into registers, perform all bitwise logic locally, and then write both modified words back to memory. This minimizes the time we hold mutable references and can improve performance.\n\nFirst, we handle the `low_word`. We need to replace its high bits (from `bit_offset` onwards) with the low bits of our new value. The most direct way is to create a mask for the bits we want to *keep*. The expression `(1 \u003C\u003C bit_offset) - 1` is a bit-twiddling trick to generate a mask with `bit_offset` ones at the least significant end.\n\n```rust\nlet mut low_word_val = *left.get_unchecked(word_index);\n\n// Create a mask to preserve the low `bit_offset` bits of the word.\nlet low_mask = (1u64 \u003C\u003C bit_offset).wrapping_sub(1);\nlow_word_val &= low_mask;\n```\n\nWith the target bits zeroed out, we merge in the low part of our new value. A left shift aligns it correctly, and the high bits of `value_w` are naturally shifted out of the register.\n\n```rust\n// Merge in the low part of our new value.\nlow_word_val |= value_w \u003C\u003C bit_offset;\n*left.get_unchecked_mut(word_index) = low_word_val;\n```\n\nNext, we handle the `high_word` in a symmetrical fashion. We need to write the remaining high bits of `value_w` into the low-order bits of this second word. First, we calculate how many bits of our value actually belong in the first word:\n\n```rust\nlet remaining_bits_in_first_word = 64 - bit_offset;\n```\n\nNow, we read the second word and create a mask to clear the low-order bits where our data will be written. With the operation `self.mask >> remaining_bits_in_first_word` we can determine how many bits of our value spill into the second word, creating a mask for them. Inverting this gives us a mask to *preserve* the existing high-order bits of the `high_word`.\n\n```rust\nlet mut high_word_val = *right.get_unchecked(0);\n\n// Clear the low bits of the second word that will be overwritten.\nhigh_word_val &= !(self.mask >> remaining_bits_in_first_word);\n```\n\nFinally, we isolate the high part of `value_w` by right-shifting it by the number of bits we already wrote, and merge it into the cleared space.\n\n```rust\n// Merge in the high part of our new value.\nhigh_word_val |= value_w >> remaining_bits_in_first_word;\n*right.get_unchecked_mut(0) = high_word_val;\n```\n\n## Random Write Performance\n\nAs with reads, we can benchmark the latency of 1 million random write operations on a vector containing 10 million elements. The code for the benchmark is available here: [`bench-intvec-writes`].\n\n\u003Ciframe src=\"/bench-intvec/random_write_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\nHere, the `Vec\u003CT>` baseline is the clear winner across almost all bit-widths. This isn't surprising. A `set` operation in a `Vec\u003CT>` compiles down to a single `MOV` instruction with a simple addressing mode (`[base + index * element_size]`). It's about as fast as the hardware allows.\n\nAs for the reads, the performance of our `FixedVec` is almost identical to that of [`sux`]. The other two crates, [`succinct`] and [`simple-sds-sbwt`], are again slower. It's worth noting that also for the writes, neither of these last two crates provides unchecked methods.\n\n> For the 64-bit width case, I honestly have no idea what is going on with [`sux`] being so much faster than everything else, even then `Vec\u003Cu64>`! Mybe some weird compiler optimization? If you have any insight, please let me know.\n\n# Architecture\n\nWith the access patterns defined, we need to think about the overall architecture of this data structure. A solution hardcoded to `u64` would lack the flexibility to adapt to different use cases. We need a structure that is generic over the its principal components: the logical type, the physical storage type, the bit-level ordering, and ownership. We can define a struct that is generic over these four parameters:\n\n```rust\npub struct FixedVec\u003CT: Storable\u003CW>, W: Word, E: Endianness, B: AsRef\u003C[W]> = Vec\u003CW>> {\n    bits: B,\n    bit_width: usize,\n    mask: W,\n    len: usize,\n}\n```\n\nWhere:\n\n* `T` is the **logical element type**, the type as seen by the user of the API (e.g., `i16`, `u32`). By abstracting `T`, we divide the user-facing type from the internal storage representation.\n\n* `W` is the **physical storage word**, which must implement our `Word` trait. It defines the primitive unsigned integer (`u32`, `u64`, `usize`) of the backing buffer and sets the granularity for all bitwise operations.\n\n* `E` requires the `dsi-bitstream::Endianness` trait, allowing us to specify either Little-Endian (`LE`) or Big-Endian (`BE`) byte order.\n\n* `B`, which must implement `AsRef\u003C[W]>`, represents the **backing storage**. This abstraction over ownership allows `FixedVec` to be either an owned container where `B = Vec\u003CW>`, or a zero-copy, borrowed view where `B = &[W]`. This makes it possible to, for example, construct a `FixedVec` directly over a memory-mapped slice without any heap allocation.\n\nIn this way, the compiler monomorphizes the struct and its methods for each concrete instantiation (e.g., `FixedVec\u003Ci16, u64, LE, Vec\u003Cu64>>`), resulting in specialized code with no runtime overhead from the generic abstractions.\n\n## `Word` Trait: The Physical Storage Layer\n\nThe first step is to abstract the physical storage layer. The `W` parameter must be a primitive unsigned integer type that supports bitwise operations. We can define a `Word` trait that captures these requirements:\n\n```rust\npub trait Word:\n    UnsignedInt + Bounded + ToPrimitive + dsi_bitstream::traits::Word\n    + NumCast + Copy + Send + Sync + Debug + IntoAtomic + 'static\n{\n    const BITS: usize = std::mem::size_of::\u003CSelf>() * 8;\n}\n```\n\nThe numeric traits (`UnsignedInt`, `Bounded`, `NumCast`, `ToPrimitive`) are necessary for the arithmetic of offset and mask calculations. The `dsi_bitstream::traits::Word` bound allows us to integrate with its `BitReader` and `BitWriter` implementations, offloading the bitstream logic. `Send` and `Sync` are non-negotiable requirements for any data structure that might be used in a concurrent context. The `IntoAtomic` bound is particularly forward-looking: it establishes a compile-time link between a storage word like `u64` and its atomic counterpart, `AtomicU64`. We will use it later to build a thread safe, atomic version of `FixedVec`. Finally, the `const BITS` associated constant lets us write architecture-agnostic code that correctly adapts to `u32`, `u64`, or `usize` words without `cfg` flags.\n\n## `Storable` Trait: The Logical Type Layer\n\nWith the physical storage layer defined, we need a formal contract to connect it to the user's logical type `T`. We can do this by creating the `Storable` trait, which defines a bidirectional, lossless conversion.\n\n```rust\npub trait Storable\u003CW: Word>: Sized + Copy {\n    fn into_word(self) -> W;\n    fn from_word(word: W) -> Self;\n}\n```\n\nFor unsigned types, the implementation is a direct cast. For signed types, however, we must map the `iN` domain to the `uN` domain required for bit-packing. A simple two's complement bitcast is unsuitable, as `i64(-1)` would become `u64::MAX`, a value requiring the maximum number of bits. We need a better mapping that preserves small absolute values.\n\nWe can use **ZigZag encoding**, which maps integers with small absolute values to small unsigned integers. This is implemented via the `ToNat` and `ToInt` traits from `dsi-bitstream`. The core encoding logic in `to_nat` is:\n\n```rust\n// From dsi_bitstream::traits::ToNat\nfn to_nat(self) -> Self::UnsignedInt {\n    (self \u003C\u003C 1).to_unsigned() ^ (self >> (Self::BITS - 1)).to_unsigned()\n}\n```\n\nThis operation works as follows: `(self \u003C\u003C 1)` creates a space at the LSB. The term `(self >> (Self::BITS - 1))` is an arithmetic right shift, which generates a sign maskâ€”all zeros for non-negative numbers, all ones for negative numbers. The final XOR uses this mask to interleave positive and negative integers: 0 becomes 0, -1 becomes 1, 1 becomes 2, -2 becomes 3, and so on.\n\nThe decoding reverses this transformation:\n\n```rust\n// From dsi_bitstream::traits::ToInt\nfn to_int(self) -> Self::SignedInt {\n    (self >> 1).to_signed() ^ (-(self & 1).to_signed())\n}\n```\n\nHere, `(self >> 1)` shifts the value back. The term `-(self & 1)` creates a mask from the LSB (the original sign bit). In two's complement, this becomes `0` for even numbers (originally positive) and `-1` (all ones) for odd numbers (originally negative). The final XOR with this mask correctly restores the original two's complement representation.\n\n\nWe might ask ourselves: why not just a direct bitcast for signed types, perhaps via a `uN -> iN` chain. Well, while a direct [transmute](https://doc.rust-lang.org/std/mem/fn.transmute.html) between same-sized integer types is a no-op, the approach fails when the logical `bit_width` is smaller than the physical type size. `FixedVec`'s core logic extracts a `bit_width`-sized unsigned integer from its storage. For example, when reading a 4-bit representation of `-1` (binary `1111`), the `from_word` function receives the value `15u64`. At this point, the context that those four bits represented a negative number is lost. A cast chain like `15u64 as u8 as i8` would simply yield `15i8`, not `-1i8`.\n\nTo correctly reconstruct the signed value, one would need to manually perform sign extension based on the known `bit_width`. This involves checking the most significant bit of the extracted value and, if set, filling the higher-order bits of the word with ones. This logic requires a conditional branch, which can introduce pipeline stalls and degrade performance in tight loops. ZigZag decoding, by contrast, is a purely arithmetic, branch-free transformation. Its reconstruction logic is a simple sequence of bitwise shifts and XORs, making it a faster and more consistent choice for the hot path of data access.\n\nWith this logic within the trait system, the main `FixedVec` implementation remains clean and agnostic to the signedness of the data it stores.\n\n## Builder Pattern\n\nOnce the structure logic is in place, we have to design an ergonomic way to construct it. A simple `new()` function isn't sufficient because the vector's memory layout depends on parameters that must be determined *before* allocation, most critically the `bit_width`. This is a classic scenario for a builder pattern.\n\n\nThe central problem is that the optimal `bit_width` often depends on the data itself. We need a mechanism to specify the *strategy* for determining this width. We can create the `BitWidth` enum:\n\n```rust\npub enum BitWidth {\n    Minimal,\n    PowerOfTwo,\n    Explicit(usize),\n}\n```\n\n\n\nWith this enum, the user can choose between three strategies:\n\n- `Minimal`: The builder scans the input data to find the maximum value, then calculates the minimum number of bits required to represent it. This is the most space-efficient option but requires a full pass over the data.\n- `PowerOfTwo`: Similar to `Minimal`, but rounds the bit width up to the next power of two. This can simplify certain bitwise operations and align better with hardware word sizes, at the cost of some additional space.\n- `Explicit(n)`: The user provides a fixed bit width. This avoids the data scan but requires the user to ensure that all values fit within the specified width.\n\n> **Note:** Yes, I could have also made three different build functions: `new_with_minimal_bit_width()`, `new_with_power_of_two_bit_width()`, and `new_with_explicit_bit_width(n)`. However, this would lead to a combinatorial explosion if we later wanted to add more configuration options. The builder pattern scales better.\n\nWith this, the `FixedVecBuilder` could be designed as a state machine. It holds the chosen `BitWidth` strategy. The final `build()` method takes the input slice and executes the appropriate logic.\n\n```rust\n// A look at the builder's logic flow\npub fn build(self, input: &[T]) -> Result\u003CFixedVec\u003C...>, Error> {\n\n    let final_bit_width = match self.bit_width_strategy {\n        BitWidth::Explicit(n) => n,\n        _ => {\n            // For Minimal or PowerOfTwo, we first find the max value.\n            let max_val = input.iter().map(|v| v.into_word()).max().unwrap_or(0);\n            let min_bits = (64 - max_val.leading_zeros()).max(1) as usize;\n\n            match self.bit_width_strategy {\n                BitWidth::Minimal => min_bits,\n                BitWidth::PowerOfTwo => min_bits.next_power_of_two(),\n                _ => unreachable!(),\n            }\n        }\n    };\n\n    // ... (rest of the logic: allocate buffer, write data) ...\n}\n```\n\nThis design cleanly separates the configuration phase from the execution phase. The user can declaratively state their requirements, and the builder handles the implementation details, whether that involves a full data scan or a direct construction. For example:\n\n```rust\nuse compressed_intvec::prelude::*;\n\nlet data: &[u32] = &[100, 200, 500]; // Max value 500 requires 9 bits\n\n// The builder will scan the data, find max=500, calculate min_bits=9,\n// and then round up to the next power of two.\nlet vec_pow2: UFixedVec\u003Cu32> = FixedVec::builder()\n    .bit_width(BitWidth::PowerOfTwo)\n    .build(data)\n    .unwrap();\n\nassert_eq!(vec_pow2.bit_width(), 16);\n```\n\n> `UFixedVec\u003CT>` is a type alias for `FixedVec\u003CT, u64, LE, Vec\u003Cu64>>`, the most common instantiation.\n\n\n# Doing more than just reading\n\nThe design of `FixedVec` allows for more than just efficient reads. We can extend it to support mutation and even thread-safe (almost atomic) concurrent access.\n\n## Mutability: Proxy Objects\n\nA core feature of `std::vec::Vec` is mutable, index-based access via `&mut T`. This is fundamentally impossible for `FixedVec`. An element, such as a 10-bit integer, is not a discrete, byte-aligned entity in memory. It is a virtual value extracted from a bitstream, potentially spanning the boundary of two different `u64` words. It has no stable memory address, so a direct mutable reference cannot be formed.\n\nTo provide an ergonomic mutable API, we must emulate the behavior of a mutable reference. We achieve this through a proxy object pattern, implemented in a struct named `MutProxy`.\n\n```rust\npub struct MutProxy\u003C'a, T, W, E, B>\nwhere\n    T: Storable\u003CW>,\n    W: Word,\n    E: Endianness,\n    B: AsRef\u003C[W]> + AsMut\u003C[W]>,\n{\n    vec: &'a mut FixedVec\u003CT, W, E, B>,\n    index: usize,\n    value: T, // A temporary, decoded copy of the element's value.\n}\n```\n\nWhen we call a method like `at_mut(index)`, it does not return a reference. Instead, it constructs and returns a `MutProxy` instance. The proxy's lifecycle manages the entire modification process:\n\n1.  **Construction:** The proxy is created. Its first action is to call the parent `FixedVec`'s internal `get` logic to read and decode the value at the specified `index`. This decoded value is stored as a temporary copy inside the proxy object itself.\n2.  **Modification:** The `MutProxy` implements `Deref` and `DerefMut`, allowing the user to interact with the temporary copy as if it were the real value. Any modifications (`*proxy = new_value`, `*proxy += 1`) are applied to this local copy, not to the underlying bitstream.\n3.  **Destruction:** When the `MutProxy` goes out of scope, its `Drop` implementation is executed. This is the critical step where the potentially modified value from the temporary copy is taken, re-encoded, and written back into the correct bit position in the parent `FixedVec`'s storage.\n\nThis is a classic copy-on-read, write-on-drop mechanism. It provides a safe and ergonomic abstraction for mutating non-addressable data, preserving the feel of direct manipulation while correctly handling the bit-level operations under the hood. The overhead is a single read at the start of the proxy's life and a single write at the end.\n\n```rust\nuse compressed_intvec::fixed::{FixedVec, UFixedVec, BitWidth};\n\nlet data: &[u32] = &[10, 20, 30];\nlet mut vec: UFixedVec\u003Cu32> = FixedVec::builder()\n    .bit_width(BitWidth::Explicit(7))\n    .build(data)\n    .unwrap();\n\n// vec.at_mut(1) returns an Option\u003CMutProxy\u003C...>>\nif let Some(mut proxy) = vec.at_mut(1) {\n    // The DerefMut trait allows us to modify the proxy's internal copy.\n    *proxy = 99;\n} // The proxy is dropped here. Its Drop impl writes 99 back to the vec.\n\nassert_eq!(vec.get(1), Some(99));\n```\n\nThe overhead of this approach is a single read on the proxy's construction and a single write on its destruction, which is an acceptable trade-off for an ergonomic and safe mutable API.\n\n### Zero-Copy Views\n\nA `Vec`-like API needs to support slicing. Creating a `FixedVec` that borrows its data (`B = &[W]`) is the first step for this, but we also need a dedicated slice type to represent a sub-region of another `FixedVec` without copying data. For this we can create `FixedVecSlice`.\n\nWe can implement this as a classic \"fat pointer\" struct. It holds a reference to the parent `FixedVec` and a `Range\u003Cusize>` that defines the logical boundaries of the view.\n\n```rust\n// A zero-copy view into a contiguous portion of a FixedVec.\n#[derive(Debug)]\npub struct FixedVecSlice\u003CV> {\n    pub(super) parent: V,\n    pub(super) range: Range\u003Cusize>,\n}\n```\n\nThe generic parameter `V` is a reference to the parent vector. This allows the same `FixedVecSlice` struct to represent both immutable (`V = &FixedVec\u003C...>`) and mutable (`V = &mut FixedVec\u003C...>`) views.\n\nWe can implement all the operations on the slice by translating the slice-relative index into an absolute index in the parent vector. For example, we can easily implement `get_unchecked` with this delegation:\n\n```rust\n// Index translation within the slice's get_unchecked\npub unsafe fn get_unchecked(&self, index: usize) -> T {\n    debug_assert!(index \u003C self.len());\n    // The index is relative to the slice, so we add the slice's start\n    // offset to get the correct index in the parent vector.\n    self.parent.get_unchecked(self.range.start + index)\n}\n```\n\nIn this way there is no code duplication; the slice re-uses the access logic of the parent `FixedVec`.\n\n## Mutable Slices\n\nFor mutable slices (`V = &mut FixedVec\u003C...>` ), we can provide mutable access to the slice's elements. We can easily implement the `at_mut` method on `FixedVecSlice` using the same principle of index translation:\n\n```rust\npub fn at_mut(&mut self, index: usize) -> Option\u003CMutProxy\u003C'_, T, W, E, B>> {\n    if index >= self.len() {\n        return None;\n    }\n    // The index is translated to the parent vector's coordinate space.\n    Some(MutProxy::new(&mut self.parent, self.range.start + index))\n}\n```\n\nA mutable slice borrows the parent `FixedVec` mutably. This means that while the slice exists, the parent vector cannot be accessed directly due to Rust's borrowing rules. Let's consider the following situation: we may need to split a mutable slice into two non-overlapping mutable slices. This is common for example in algorithms that operate on sub-regions of an array. However, implementing such a method requires to use some unsafe code. The method, let's say `split_at_mut`, must produce two `&mut` references from a single one. In order to be safe, we must prove to the compiler that the logical ranges they represent (`0..mid` and `mid..len`) are disjoint.\n\n```rust\npub fn split_at_mut(&mut self, mid: usize) -> (FixedVecSlice\u003C&mut Self>, FixedVecSlice\u003C&mut Self>) {\n    assert!(mid \u003C= self.len, \"mid > len in split_at_mut\");\n    // SAFETY: The two slices are guaranteed not to overlap.\n    unsafe {\n        let ptr = self as *mut Self;\n        let left = FixedVecSlice::new(&mut *ptr, 0..mid);\n        let right = FixedVecSlice::new(&mut *ptr, mid..self.len());\n        (left, right)\n    }\n}\n```\n\nThis combination of a generic slice struct and careful pointer manipulation allows us to build a rich, safe, and zero-copy API for both immutable and mutable views, mirroring Rust's native slice\n\n# Next Steps\n\nOur `FixedVec` works pretty well at the current state, but its strengths are tied to two key assumptions: a single thread of execution and uniformly bounded data. Real-world systems often challenge both. This opens up two distinct paths for us to extend our design: one to handle concurrency, and another to adapt to more complex data distributions.\n\n## Concurrent Access\n\nThe design of `FixedVec` is fundamentally single-threaded. Its mutable access relies on direct writes to the underlying bit buffer, a model that offers no guarantees in a concurrent setting. The core conflict lies between our data layout and the hardware's atomic primitives. CPU instructions like compare-and-swap operate on aligned machine words, typically `u64`. Our elements, however, are packed at arbitrary bit offsets and can span the boundary between two words.\n\nThis means a single logical updateâ€”modifying one elementâ€”might require writing to two separate `u64` words. Performing this as two distinct atomic writes would create a race condition, leaving the data in a corrupt state if another thread reads between them. A single atomic write to one of the underlying `u64` words would be equally disastrous, as it could simultaneously alter parts of two different elements. The problem then is how to build atomic semantics on top of a non-atomic memory layout. In the next post, we will construct a solution that provides thread-safe, atomic operations for our bit-packed vector.\n\n## Variable Length Encoding\n\nLet's consider the following scenario: we have a large collection of integers, all of which are small, say in the range `[0, 255]`, but with a few outliers that are much larger, perhaps up to `u64::MAX`. If we were to use our `FixedVec` with a `bit_width` of 64 to accommodate the outliers, we would waste a significant amount of memory on the small integers. Conversely, if we chose a smaller `bit_width`, we would be unable to represent the outliers at all.\n\nThe fixed-width model rests on that critical assumption of uniformly bounded data. Its performance comes from this predictability, but this rigid structure is also its main weakness.\n\nFor skewed data distributions, we need a different model. Instead of a fixed number of bits per element, we can use variable-length instantaneous codes, where smaller numbers are represented by shorter bit sequences. This gives us excellent compression, but it breaks our O(1) random access guarantee. We can no longer compute the location of the i-th element with a simple multiplication. The solution is to trade a small amount of space for a speedup in access time. We can build a secondary index that stores the bit-offset of every k-th element. This sampling allows us to seek to a nearby checkpoint and decode sequentially from there, restoring amortized O(1) access. In a future article, we'll explore this second vector type, its own set of performance trade-offs, and how we can choose the best encoding for our data.\n\n---\n\nWe will explore this two paths in future articles. In the meantime, if you want to try them out, they are both already implemented in the library. You can find the atomic version in the [atomic](https://docs.rs/compressed-intvec/latest/compressed_intvec/fixed/atomic/index.html) module and the variable-length version in the [variable](https://docs.rs/compressed-intvec/latest/compressed_intvec/variable/struct.IntVec.html) module.","src/data/blog/compressed-fixedvec.md","c97e5e752b9bdb2b",{"html":551,"metadata":552},"\u003Cp>If youâ€™ve ever worked with massive datasets, you know that memory usage can quickly become a bottleneck. While developing succinct data structures, I found myself needing to store large arrays of integersâ€”values with no monotonicity or other exploitable patterns, that I knew came from a universe much smaller than their typeâ€™s theoretical capacity.\u003C/p>\n\u003Cp>In this post, we will explore the engineering challenges involved in implementing an efficient vector-like data structure in Rust that stores integers in a compressed, bit-packed format. We will focus on achieving O(1) random access performance while minimizing memory usage. We will try to mimic the ergonomics of Rustâ€™s standard \u003Ccode>Vec&#x3C;T>\u003C/code> as closely as possible, including support for mutable access and zero-copy slicing.\u003C/p>\n\u003Cul>\n\u003Cli>All the code can be found on github: \u003Ca href=\"https://github.com/lukefleed/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003Cli>This is also published as a crate on crates.io: \u003Ca href=\"https://crates.io/crates/compressed-intvec\">compressed-intvec\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>You can discuss this post on \u003Ca href=\"https://news.ycombinator.com/item?id=45361578\">Hacker News\u003C/a>, \u003Ca href=\"https://lobste.rs/s/u1rffj/engineering_fixed_width_bit_packed\">Lobsters\u003C/a> or \u003Ca href=\"https://www.reddit.com/r/rust/comments/1npf41d/engineering_a_fixedwidth_bitpacked_integer_vector/\">Reddit\u003C/a>.\u003C/p>\n\u003Chr>\n\u003Ch2 id=\"table-of-contents\">Table of contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-waste-in-standard-vectors\">Memory Waste in Standard Vectors\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#packing-and-accessing-bits\">Packing and Accessing Bits\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#crossing-word-boundaries\">Crossing Word Boundaries\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#faster-reads-unaligned-access\">Faster Reads: Unaligned Access\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#random-access-performance\">Random Access Performance\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#iterating-over-values\">Iterating Over Values\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#double-ended-iteration\">Double-Ended Iteration\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#writing-bits\">Writing bits\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#in-word-write\">In-Word Write\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#spanning-write\">Spanning Write\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#random-write-performance\">Random Write Performance\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#architecture\">Architecture\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#word-trait-the-physical-storage-layer\">\u003Ccode>Word\u003C/code> Trait: The Physical Storage Layer\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#storable-trait-the-logical-type-layer\">\u003Ccode>Storable\u003C/code> Trait: The Logical Type Layer\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#builder-pattern\">Builder Pattern\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#doing-more-than-just-reading\">Doing more than just reading\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#mutability-proxy-objects\">Mutability: Proxy Objects\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#zero-copy-views\">Zero-Copy Views\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#mutable-slices\">Mutable Slices\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#next-steps\">Next Steps\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#concurrent-access\">Concurrent Access\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#variable-length-encoding\">Variable Length Encoding\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch1 id=\"memory-waste-in-standard-vectors\">Memory Waste in Standard Vectors\u003C/h1>\n\u003Cp>In Rust, the contract of a \u003Ccode>Vec&#x3C;T>\u003C/code> (where \u003Ccode>T\u003C/code> is a primitive integer type like \u003Ccode>u64\u003C/code> or \u003Ccode>i32\u003C/code>) is simple: O(1) random access in exchange for a memory layout that is tied to the static size of \u003Ccode>T\u003C/code>. This is a good trade-off, until it isnâ€™t. When the dynamic range of the stored values is significantly smaller than the typeâ€™s capacity, this memory layout leads to substantial waste.\u003C/p>\n\u003Cp>Consider storing the value \u003Ccode>5\u003C/code> within a \u003Ccode>Vec&#x3C;u64>\u003C/code>. Its 8-byte in-memory representation is:\u003C/p>\n\u003Cdiv align=\"center\">\n\u003Cp>\u003Ccode>00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000101\u003C/code>\u003C/p>\n\u003C/div>\n\u003Cp>Only 3 bits are necessary to represent the value, leaving 61 bits as zero-padding. The same principle applies, albeit less dramatically, when storing \u003Ccode>5\u003C/code> in a \u003Ccode>u32\u003C/code> or \u003Ccode>u16\u003C/code>. At scale, this overhead becomes prohibitive. A vector of one billion \u003Ccode>u64\u003C/code> elements consumes \u003Ccode>10^9 * std::mem::size_of::&#x3C;u64>()\u003C/code>, or approximately 8 GB of memory, even if every element could fit within a single byte.\u003C/p>\n\u003Cp>The canonical solution is bit packing, which aligns data end-to-end in a contiguous bitvector. However, this optimization has historically come at the cost of random access performance. The O(1) access guarantee of \u003Ccode>Vec&#x3C;T>\u003C/code> is predicated on simple pointer arithmetic: \u003Ccode>address = base_address + index * std::mem::size_of::&#x3C;T>()\u003C/code>. Tightly packing the bits invalidates this direct address calculation, seemingly forcing a trade-off between memory footprint and access latency.\u003C/p>\n\u003Cp>This raises the central question that with this post we aim to answer: is it possible to design a data structure that decouples its memory layout from the static size of \u003Ccode>T\u003C/code>, adapting instead to the dataâ€™s true dynamic range, without sacrificing the O(1) random access that makes \u003Ccode>Vec&#x3C;T>\u003C/code> so effective?\u003C/p>\n\u003Ch1 id=\"packing-and-accessing-bits\">Packing and Accessing Bits\u003C/h1>\n\u003Cp>If the dynamic range of our data is known, we can define a fixed \u003Ccode>bit_width\u003C/code> for every integer. For instance, if the maximum value in a dataset is \u003Ccode>1000\u003C/code>, we know every number can be represented in 10 bits, since \u003Ccode>2^10 = 1024\u003C/code>. Instead of allocating 64 bits per element, we can store them back-to-back in a contiguous bitvector, forming the core of what from now on weâ€™ll refer as \u003Ccode>FixedVec\u003C/code>. We can immagine such data strucutre as a logical array of \u003Ccode>N\u003C/code> integers, each \u003Ccode>bit_width\u003C/code> bits wide, stored in a backing buffer of \u003Ccode>u64\u003C/code> words.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Backing storage\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Number of bits per element\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Number of elements\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Precomputed mask for extraction\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where the role of the \u003Ccode>mask\u003C/code> field is to isolate the relevant bits during extraction. For a \u003Ccode>bit_width\u003C/code> of 10, the mask would be \u003Ccode>0b1111111111\u003C/code>.\u003C/p>\n\u003Cp>This immediately solves the space problem, but how can we find the \u003Ccode>i\u003C/code>-th element in O(1) time if it doesnâ€™t align to a byte boundary? The answer lies in simple arithmetic. The starting bit position of any element is a direct function of its index. Given a backing store of \u003Ccode>u64\u003C/code> words, we can locate any value by calculating its absolute bit position and then mapping that to a specific word and an offset within that word.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Absolute bit position of the value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Which u64 word to read\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Where the value starts in that word\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With these values, the implementation of \u003Ccode>get_unchecked\u003C/code> becomes straightforward. Itâ€™s a two-step process: fetch the correct word from our backing \u003Ccode>Vec&#x3C;u64>\u003C/code>, then use bitwise operations to isolate the specific bits we need.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A simplified look at the core get_unchecked logic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 1. Fetch the word from the backing store\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 2. Shift and mask to extract the value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Letâ€™s trace an access with \u003Ccode>bit_width = 10\u003C/code> for the element at \u003Ccode>index = 7\u003C/code>. The starting bit position is \u003Ccode>7 * 10 = 70\u003C/code>. This maps to \u003Ccode>word_index = 1\u003C/code> and \u003Ccode>bit_offset = 6\u003C/code>. Our 10-bit integer begins at the 6th bit of the \u003Cem>second\u003C/em> \u003Ccode>u64\u003C/code> word in our storage.\u003C/p>\n\u003Cp>The right-shift \u003Ccode>>>\u003C/code> operation moves the bits of the entire \u003Ccode>u64\u003C/code> word to the right by \u003Ccode>bit_offset\u003C/code> positions. This aligns the start of our desired 10-bit value with the least significant bit (LSB) of the word. The final step is to isolate our value. A pre-calculated \u003Ccode>mask\u003C/code> (e.g., \u003Ccode>0b1111111111\u003C/code> for 10 bits) is applied with a bitwise AND \u003Ccode>&#x26;\u003C/code>. This zeroes out any high-order bits from the word, leaving just our target integer.\u003C/p>\n\u003Ch2 id=\"crossing-word-boundaries\">Crossing Word Boundaries\u003C/h2>\n\u003Cp>The single-word access logic is fast, but it only works as long as \u003Ccode>bit_offset + bit_width &#x3C;= 64\u003C/code>. This assumption breaks down as soon as an integerâ€™s bit representation needs to cross the boundary from one \u003Ccode>u64\u003C/code> word into the next. This is guaranteed to happen for any \u003Ccode>bit_width\u003C/code> that is not a power of two. For example, with a 10-bit width, the element at \u003Ccode>index = 6\u003C/code> starts at bit position 60. Its 10 bits will occupy bits 60-63 of the first word and bits 0-5 of the second. The simple right-shift-and-mask trick fails here.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/fixedvec.svg\" alt=\"crossing word boundaries\">\u003C/p>\n\u003Cp>To correctly decode the value, we must read \u003Cem>two\u003C/em> consecutive \u003Ccode>u64\u003C/code> words and combine their bits. This splits our \u003Ccode>get_unchecked\u003C/code> implementation into two paths. The first is the fast path weâ€™ve already seen. The second is a new path for spanning values.\u003C/p>\n\u003Cp>To get the lower bits of the value, we read the first word and shift right, just as before. This leaves the upper bits of the word as garbage.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>To get the upper bits of the value, we read the \u003Cem>next\u003C/em> word. The bits we need are at the beginning of this word, so we shift them left to align them correctly.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Finally, we combine the two parts with a bitwise OR and apply the mask to discard any remaining high-order bits from the \u003Ccode>high_part\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The line \u003Ccode>limbs.get_unchecked(word_index + 1)\u003C/code> introduces a safety concern: if we are reading the last element of the vector, \u003Ccode>word_index + 1\u003C/code> could point past the end of our buffer, leading to undefined behavior. To prevent this, our builder must always allocate one extra padding word at the end of the storage.\u003C/p>\n\u003Cp>Integrating these two paths gives us our final \u003Ccode>get_unchecked\u003C/code> implementation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Fast path: value is fully within one word\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Slow path: value spans two words.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_part\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_part\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"faster-reads-unaligned-access\">Faster Reads: Unaligned Access\u003C/h2>\n\u003Cp>Our \u003Ccode>get_unchecked\u003C/code> implementation is correct, but the slow path for spanning values requires two separate, aligned memory reads. The instruction sequence for this method involves at least two load instructions, multiple shifts, and a bitwise OR. These instructions have data dependencies: the shifts cannot execute until the loads complete, and the OR cannot execute until both shifts are done. This dependency chain can limit the CPUâ€™s instruction-level parallelism and create pipeline stalls if the memory accesses miss the L1 cache.\u003C/p>\n\u003Cp>Letâ€™s have a look at the machine code generated by this method. We can create a minimal binary with an \u003Ccode>#[inline(never)]\u003C/code> function that calls \u003Ccode>get_unchecked\u003C/code> on a known spanning index, then use \u003Ca href=\"https://crates.io/crates/cargo-asm\">\u003Ccode>cargo asm\u003C/code>\u003C/a> to inspect the disassembly.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; asm_test::aligned::get_aligned (spanning path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">LBB14_2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let low = *limbs.get_unchecked(word_index) >> bit_offset;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">r8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; &#x3C;&#x3C;&#x3C; LOAD #1 (low_part)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let high = *limbs.get_unchecked(word_index + 1) &#x3C;&#x3C; (64 - bit_offset);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">r8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; &#x3C;&#x3C;&#x3C; LOAD #2 (high_part)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shr\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">cl\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          ; shift right of low_part\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shl\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">cl\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          ; shift left of high_part\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        or\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsi\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          ; combine results\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The instruction \u003Ccode>mov rsi, qword ptr [r8 + 8*rdx]\u003C/code> is our first memory access. It loads a 64-bit value (\u003Ccode>qword\u003C/code>) into the \u003Ccode>rsi\u003C/code> register. The address is calculated using base-plus-index addressing: \u003Ccode>r8\u003C/code> holds the base address of our \u003Ccode>limbs\u003C/code> buffer, and \u003Ccode>rdx\u003C/code> holds the \u003Ccode>word_index\u003C/code>. This corresponds directly to \u003Ccode>limbs[word_index]\u003C/code>.\u003C/p>\n\u003Cp>Immediately following is \u003Ccode>mov rdx, qword ptr [r8 + 8*rdx + 8]\u003C/code>. This is our second, distinct memory access. It loads the \u003Cem>next\u003C/em> 64-bit word from memory by adding an 8-byte offset to the previous address. This corresponds to \u003Ccode>limbs[word_index + 1]\u003C/code>.\u003C/p>\n\u003Cp>Only after both of these \u003Ccode>mov\u003C/code> instructions complete can the CPU proceed. The \u003Ccode>shr rsi, cl\u003C/code> instruction (shift right \u003Ccode>rsi\u003C/code> by the count in \u003Ccode>cl\u003C/code>) cannot execute until the first \u003Ccode>mov\u003C/code> has placed a value in \u003Ccode>rsi\u003C/code>. Similarly, \u003Ccode>shl rdx, cl\u003C/code> depends on the second \u003Ccode>mov\u003C/code>. Finally, \u003Ccode>or rdx, rsi\u003C/code> depends on both shifts.\u003C/p>\n\u003Cp>This sequence of operationsâ€”loading two adjacent 64-bit words, shifting each, and combining them is a software implementation of what is, conceptually, a \u003Ca href=\"https://en.wikipedia.org/wiki/Barrel_shifter\">128-bit barrel shifter\u003C/a>. We are selecting a 64-bit window from a virtual 128-bit integer formed by concatenating the two words from memory.\u003C/p>\n\u003Cp>\u003Cstrong>Can we do better then this?\u003C/strong> Potentially, yes. We can replace this multi-instruction sequence with something more direct by delegating the complexity to the hardware and performing a single unaligned memory read. Modern x86-64 CPUs handle this directly: when an unaligned load instruction is issued, the CPUâ€™s memory controller fetches the necessary cache lines and the load/store unit reassembles the bytes into the target register. This entire process is a single, optimized micro-operation.\u003C/p>\n\u003Cp>We can try to implement a more aggressive access method. The strategy is to calculate the exact \u003Cem>byte\u003C/em> address where our data begins and perform a single, unaligned read of a full \u003Ccode>W\u003C/code> word from that position.\u003C/p>\n\u003Cp>The implementation first translates the absolute bit position into a byte address and a residual bit offset within that byte.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With the byte-level address, we get a raw \u003Ccode>*const u8\u003C/code> pointer to our storage and perform the unaligned read. The \u003Ca href=\"https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html\">read_unaligned\u003C/a> intrinsic in Rust compiles down to a single machine instruction that the hardware can execute efficiently.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_limbs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// This read may cross hardware word boundaries, but the CPU handles it.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">read_unaligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On a Little-Endian system, the loaded \u003Ccode>word\u003C/code> now contains our target integer, but itâ€™s shifted by \u003Ccode>bit_rem\u003C/code> positions. A simple right shift aligns our value to the LSB, and applying the mask isolates it.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> final_value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This operation is safe only because, as said before, we are supposing that our builder guarantees a padding word at the end of the storage buffer. Combining all these steps, we get our final implementation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unaligned_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> /\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_pos\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> %\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_limbs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // SAFETY: The builder guarantees an extra padding word at the end.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">byte_pos\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">read_unaligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_rem\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    extracted_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Letâ€™s have a look at the generated machine code for this new method when accessing an index that spans words:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; asm_test::unaligned::get_unaligned\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">LBB15_1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let bit_pos = index * self.bit_width;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        imul\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rcx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rax\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; let byte_pos = bit_pos / 8;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rcx\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shr\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; self.bits.as_ref()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; unsafe { crate::intrinsics::copy_nonoverlapping(src, dst, count) }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; &#x3C;&#x3C;&#x3C; SINGLE UNALIGNED LOAD\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; self >> other\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        and\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> cl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">7\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        shr\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">cl\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        ; fn bitand(self, rhs: $t) -> $t { self &#x26; rhs }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        and\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The initial \u003Ccode>imul\u003C/code> and \u003Ccode>shr rax, 3\u003C/code> (a fast division by 8) correspond to the calculation of \u003Ccode>byte_pos\u003C/code>. The instruction \u003Ccode>mov rdx, qword ptr [rdi + 8]\u003C/code> loads the base address of our \u003Ccode>limbs\u003C/code> buffer into the \u003Ccode>rdx\u003C/code> register.\u003C/p>\n\u003Cp>The instruction \u003Ccode>mov rax, qword ptr [rdx + rax]\u003C/code> is our single unaligned load. The address \u003Ccode>[rdx + rax]\u003C/code> is the sum of the bufferâ€™s base address and our calculated \u003Ccode>byte_pos\u003C/code>. This \u003Ccode>mov\u003C/code> instruction reads 8 bytes (a \u003Ccode>qword\u003C/code>) directly from this potentially unaligned memory location into the \u003Ccode>rax\u003C/code> register. We can see that as we hoped, the \u003Ca href=\"https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html\">read_unaligned\u003C/a> intrinsic has been compiled down to a single hardware instruction.\u003C/p>\n\u003Cp>The next instructions handle the extraction. The \u003Ccode>and cl, 7\u003C/code> and \u003Ccode>shr rax, cl\u003C/code> sequence corresponds to our \u003Ccode>>> bit_rem\u003C/code>. \u003Ccode>cl\u003C/code> holds the lower bits of the original \u003Ccode>bit_pos\u003C/code> (our \u003Ccode>bit_rem\u003C/code>), and the shift aligns our desired value to the LSB of the \u003Ccode>rax\u003C/code> register. Finally, \u003Ccode>and rax, qword ptr [rdi + 32]\u003C/code> applies the pre-calculated mask, which is stored at an offset from the \u003Ccode>self\u003C/code> pointer in \u003Ccode>rdi\u003C/code>.\u003C/p>\n\u003Ch2 id=\"random-access-performance\">Random Access Performance\u003C/h2>\n\u003Cp>We can now benchmark the latency of 1 million random access operations on a vector containing 10 million elements. For each \u003Ccode>bit_width\u003C/code>, we generate data with a uniform random distribution in the range \u003Ccode>[0, 2^bit_width)\u003C/code>. The code for the benchmark is available here: \u003Ca href=\"https://github.com/lukefleed/compressed-intvec/blob/master/benches/fixed/bench_random_access.rs\">\u003Ccode>bench-intvec\u003C/code>\u003C/a>\u003C/p>\n\u003Cp>Our baseline is the smallest standard \u003Ccode>Vec&#x3C;T>\u003C/code> capable of holding the data (\u003Ccode>Vec&#x3C;u8>\u003C/code> for \u003Ccode>bit_width &#x3C;= 8\u003C/code>, etc.). We also include results from \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a>, \u003Ca href=\"https://docs.rs/succinct/latest/succinct/trait.IntVec.html\">\u003Ccode>succinct\u003C/code>\u003C/a>, and \u003Ca href=\"https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\">\u003Ccode>simple-sds-sbwt\u003C/code>\u003C/a> for context. I am not aware of any other Rust crates that implement fixed-width bit-packed integer vectors, so if you know of any, please let me know!\u003C/p>\n\u003Ciframe src=\"/bench-intvec/fixed_random_access_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>We can see that for \u003Ccode>bit_width\u003C/code> values below 32, the \u003Ccode>get_unaligned_unchecked\u003C/code> of our \u003Ccode>FixedVec\u003C/code> is almost always faster than the corresponding \u003Ccode>Vec&#x3C;T>\u003C/code> baseline. This is a result of improved cache locality. A 64-byte L1 cache line can hold 64 elements from a \u003Ccode>Vec&#x3C;u8>\u003C/code>. With a \u003Ccode>bit_width\u003C/code> of 4, the same cache line holds \u003Ccode>(64 * 8) / 4 = 128\u003C/code> elements from our \u003Ccode>FixedVec\u003C/code>. This increased density improves the cache hit rate for random access patterns, and the latency reduction from avoiding DRAM access outweighs the instruction cost of the bitwise extraction. For values of \u003Ccode>bit_width\u003C/code> above 32, the performance of \u003Ccode>FixedVec\u003C/code> are \u003Cem>very slightly\u003C/em> worse than the \u003Ccode>Vec&#x3C;T>\u003C/code> baseline, as the cache locality advantage diminishes. However, the memory savings remain.\u003C/p>\n\u003Cp>The performance delta between \u003Ccode>get_unaligned_unchecked\u003C/code> and \u003Ccode>get_unchecked\u003C/code> confirms the unaligned access strategy discussed before: a single \u003Ccode>read_unaligned\u003C/code> instruction is more efficient than the two dependent aligned reads required by the logic for spanning words.\u003C/p>\n\u003Cp>We can see that the implementation of \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a> is almost on par with ours. The other two crates, \u003Ca href=\"https://docs.rs/succinct/latest/succinct/trait.IntVec.html\">\u003Ccode>succinct\u003C/code>\u003C/a> and \u003Ca href=\"https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\">\u003Ccode>simple-sds-sbwt\u003C/code>\u003C/a>, are significantly slower (note that the Y-axis is logarithmic). Tho, itâ€™s worth noting that neither of these last two crates provides unchecked or unaligned access methods, so their implementations are inherently more conservative.\u003C/p>\n\u003Ch2 id=\"iterating-over-values\">Iterating Over Values\u003C/h2>\n\u003Cp>The most common operation on any \u003Ccode>Vec\u003C/code>-like structure is, after all, a simple \u003Ccode>for\u003C/code> loop. The simplest way to implement \u003Ccode>iter()\u003C/code> would be to just wrap \u003Ccode>get()\u003C/code> in a loop:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A naive, inefficient iterator\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... do something with value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This works, but itâ€™s terribly inefficient. Every single call to \u003Ccode>get(i)\u003C/code> independently recalculates the \u003Ccode>word_index\u003C/code> and \u003Ccode>bit_offset\u003C/code> from scratch. Weâ€™re throwing away valuable state, our current position in the bitstream, on every iteration, forcing the CPU to perform redundant multiplications and divisions.\u003C/p>\n\u003Cp>We can think then about a \u003Cem>stateful\u003C/em> iterator. It should operate directly on the bitvector, maintaining its own position. Instead of thinking in terms of logical indices, it should think in terms of a â€œbit windowâ€, a local \u003Ccode>u64\u003C/code> register that holds the current chunk of bits being processed.\u003C/p>\n\u003Cp>The idea is simple: the iterator loads one \u003Ccode>u64\u003C/code> word from the backing store into its window. It then satisfies \u003Ccode>next()\u003C/code> calls by decoding values directly from this in-register window. Only when the window runs out of bits does it need to go back to memory for the next \u003Ccode>u64\u003C/code> word. This amortizes the cost of memory access over many \u003Ccode>next()\u003C/code> calls.\u003C/p>\n\u003Cp>For forward iteration, the state is minimal:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecIter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">...\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_bits_in_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>next()\u003C/code> method first checks if the current \u003Ccode>front_window\u003C/code> has enough bits to satisfy the request. If \u003Ccode>self.front_bits_in_window >= bit_width\u003C/code>, itâ€™s the fast path: a simple shift and mask on a register, which is incredibly fast.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Inside next(), fast path:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_bits_in_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">front_bits_in_window \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">-=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If the window is running low on bits, we hit the slower path. The next value spans the boundary between our current window and the next \u003Ccode>u64\u003C/code> word in memory. We must read the next word, combine its bits with the remaining bits in our current window, and then extract the value. This is the same logic as the spanning-word \u003Ccode>get()\u003C/code>, but itâ€™s performed incrementally.\u003C/p>\n\u003Ch3 id=\"double-ended-iteration\">Double-Ended Iteration\u003C/h3>\n\u003Cp>But I want my iterator to be bidirectional! Well, then we need to ensure it implements \u003Ca href=\"https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html\">\u003Ccode>DoubleEndedIterator\u003C/code>\u003C/a> and supports \u003Ca href=\"https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html#tymethod.next_back\">\u003Ccode>next_back()\u003C/code>\u003C/a>. This throws a wrench in our simple stateful model. A single window and cursor can only move in one direction.\u003C/p>\n\u003Cp>The solution is to maintain two independent sets of state: one for the front and one for the back. The \u003Ccode>FixedVecIter\u003C/code> needs to track two windows, two bit counters, and two word indices.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecIter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">...\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // State for forward iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_bits_in_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    front_word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // State for backward iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_bits_in_window\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    back_word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Initializing the front is easy: we load \u003Ccode>limbs[0]\u003C/code> into \u003Ccode>front_window\u003C/code>. The back is more complex. We must calculate the exact word index and the number of valid bits in the \u003Cem>last\u003C/em> word that contains data. This requires a bit of arithmetic to handle cases where the data doesnâ€™t perfectly fill the final word.\u003C/p>\n\u003Cp>The \u003Ccode>next()\u003C/code> method consumes from the \u003Ccode>front_window\u003C/code>, advancing the front state. The \u003Ccode>next_back()\u003C/code> method consumes from the \u003Ccode>back_window\u003C/code>, advancing the back state. The iterator is exhausted when \u003Ccode>front_index\u003C/code> meets \u003Ccode>back_index\u003C/code>.\u003C/p>\n\u003Cblockquote>\n\u003Cp>The full implementation can be found in the iter module of the \u003Ca href=\"https://github.com/lukefleed/compressed-intvec/blob/master/src/fixed/iter.rs\">library\u003C/a>\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"writing-bits\">Writing bits\u003C/h1>\n\u003Cp>We have solved the read problem, but we may also want to modify values in place. A method like \u003Ccode>set(index, value)\u003C/code> seems simple, but it opens up the same can of worms as \u003Ccode>get\u003C/code>, just in reverse. We canâ€™t just write the new value; we have to do so without clobbering the adjacent, unrelated data packed into the same \u003Ccode>u64\u003C/code> word.\u003C/p>\n\u003Cp>Just like with reading, the logic splits into two paths. The â€œfast pathâ€ handles values that are fully contained within a single \u003Ccode>u64\u003C/code>. Here, we canâ€™t just overwrite the word. We first need to clear out the bits for the element weâ€™re replacing and then merge in the new value.\u003C/p>\n\u003Ch2 id=\"in-word-write\">In-Word Write\u003C/h2>\n\u003Cp>Our goal here is to update a \u003Ccode>bit_width\u003C/code>-sized slice of a \u003Ccode>u64\u003C/code> word while leaving the other bits untouched. This operation must be a read-modify-write sequence to avoid corrupting adjacent elements. The most efficient way to implement this is to load the entire word into a register, perform all bitwise modifications locally, and then write the final result back to memory in a single store operation.\u003C/p>\n\u003Cp>First, we load the word from our backing \u003Ccode>limbs\u003C/code> slice.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Next, we need to create a â€œholeâ€ in our local copy where the new value will go. We do this by creating a mask that has ones \u003Cem>only\u003C/em> in the bit positions we want to modify, and then inverting it to create a clearing mask.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// For a value at bit_offset, the mask must also be shifted.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> clear_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Applying this mask zeroes out the target bits in our register copy.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> clear_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With the target bits zeroed, we can merge our new value. The value is first shifted left by \u003Ccode>bit_offset\u003C/code> to align it correctly within the 64-bit word. Then, a bitwise OR merges it into the â€œholeâ€ we just created.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Shift the new value into position and merge it.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value_w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Finally, with the modifications complete, we write the updated word from the register back to memory in a single operation.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This entire sequence of one read, two bitwise operations in-register, one write is the canonical and most efficient way to perform a sub-word update.\u003C/p>\n\u003Ch2 id=\"spanning-write\">Spanning Write\u003C/h2>\n\u003Cp>Now for the hard part: writing a value that crosses a word boundary. This operation must modify two separate \u003Ccode>u64\u003C/code> words in our backing store. Itâ€™s the inverse of the spanning read. We need to split our \u003Ccode>value_w\u003C/code> into a low part and a high part and write each to the correct word, minimizing memory accesses.\u003C/p>\n\u003Cp>To operate on two distinct memory locations, \u003Ccode>limbs[word_index]\u003C/code> and \u003Ccode>limbs[word_index + 1]\u003C/code>, we first need mutable access to both. In a safe, hot path like this, we can use \u003Ccode>split_at_mut_unchecked\u003C/code> to bypass Rustâ€™s borrow checker bounds checks, as we have already guaranteed through our logic that both indices are valid.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// SAFETY: We know word_index and word_index + 1 are valid.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> limbs\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">split_at_mut_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Our strategy is to read both words into registers, perform all bitwise logic locally, and then write both modified words back to memory. This minimizes the time we hold mutable references and can improve performance.\u003C/p>\n\u003Cp>First, we handle the \u003Ccode>low_word\u003C/code>. We need to replace its high bits (from \u003Ccode>bit_offset\u003C/code> onwards) with the low bits of our new value. The most direct way is to create a mask for the bits we want to \u003Cem>keep\u003C/em>. The expression \u003Ccode>(1 &#x3C;&#x3C; bit_offset) - 1\u003C/code> is a bit-twiddling trick to generate a mask with \u003Ccode>bit_offset\u003C/code> ones at the least significant end.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Create a mask to preserve the low `bit_offset` bits of the word.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">wrapping_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_mask\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With the target bits zeroed out, we merge in the low part of our new value. A left shift aligns it correctly, and the high bits of \u003Ccode>value_w\u003C/code> are naturally shifted out of the register.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Merge in the low part of our new value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value_w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word_index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> low_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Next, we handle the \u003Ccode>high_word\u003C/code> in a symmetrical fashion. We need to write the remaining high bits of \u003Ccode>value_w\u003C/code> into the low-order bits of this second word. First, we calculate how many bits of our value actually belong in the first word:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> remaining_bits_in_first_word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bit_offset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now, we read the second word and create a mask to clear the low-order bits where our data will be written. With the operation \u003Ccode>self.mask >> remaining_bits_in_first_word\u003C/code> we can determine how many bits of our value spill into the second word, creating a mask for them. Inverting this gives us a mask to \u003Cem>preserve\u003C/em> the existing high-order bits of the \u003Ccode>high_word\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Clear the low bits of the second word that will be overwritten.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mask \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> remaining_bits_in_first_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Finally, we isolate the high part of \u003Ccode>value_w\u003C/code> by right-shifting it by the number of bits we already wrote, and merge it into the cleared space.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Merge in the high part of our new value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value_w\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> remaining_bits_in_first_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> high_word_val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"random-write-performance\">Random Write Performance\u003C/h2>\n\u003Cp>As with reads, we can benchmark the latency of 1 million random write operations on a vector containing 10 million elements. The code for the benchmark is available here: [\u003Ccode>bench-intvec-writes\u003C/code>].\u003C/p>\n\u003Ciframe src=\"/bench-intvec/random_write_performance.html\" width=\"100%\" height=\"550px\" style=\"border: none;\">\u003C/iframe>\n\u003Cp>Here, the \u003Ccode>Vec&#x3C;T>\u003C/code> baseline is the clear winner across almost all bit-widths. This isnâ€™t surprising. A \u003Ccode>set\u003C/code> operation in a \u003Ccode>Vec&#x3C;T>\u003C/code> compiles down to a single \u003Ccode>MOV\u003C/code> instruction with a simple addressing mode (\u003Ccode>[base + index * element_size]\u003C/code>). Itâ€™s about as fast as the hardware allows.\u003C/p>\n\u003Cp>As for the reads, the performance of our \u003Ccode>FixedVec\u003C/code> is almost identical to that of \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a>. The other two crates, \u003Ca href=\"https://docs.rs/succinct/latest/succinct/trait.IntVec.html\">\u003Ccode>succinct\u003C/code>\u003C/a> and \u003Ca href=\"https://docs.rs/simple-sds-sbwt/latest/simple_sds_sbwt/int_vector/struct.IntVector.html\">\u003Ccode>simple-sds-sbwt\u003C/code>\u003C/a>, are again slower. Itâ€™s worth noting that also for the writes, neither of these last two crates provides unchecked methods.\u003C/p>\n\u003Cblockquote>\n\u003Cp>For the 64-bit width case, I honestly have no idea what is going on with \u003Ca href=\"https://docs.rs/sux/latest/sux/bits/bit_field_vec/index.html\">\u003Ccode>sux\u003C/code>\u003C/a> being so much faster than everything else, even then \u003Ccode>Vec&#x3C;u64>\u003C/code>! Mybe some weird compiler optimization? If you have any insight, please let me know.\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"architecture\">Architecture\u003C/h1>\n\u003Cp>With the access patterns defined, we need to think about the overall architecture of this data structure. A solution hardcoded to \u003Ccode>u64\u003C/code> would lack the flexibility to adapt to different use cases. We need a structure that is generic over the its principal components: the logical type, the physical storage type, the bit-level ordering, and ownership. We can define a struct that is generic over these four parameters:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Endianness\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AsRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    mask\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Where:\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>\u003Ccode>T\u003C/code> is the \u003Cstrong>logical element type\u003C/strong>, the type as seen by the user of the API (e.g., \u003Ccode>i16\u003C/code>, \u003Ccode>u32\u003C/code>). By abstracting \u003Ccode>T\u003C/code>, we divide the user-facing type from the internal storage representation.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Ccode>W\u003C/code> is the \u003Cstrong>physical storage word\u003C/strong>, which must implement our \u003Ccode>Word\u003C/code> trait. It defines the primitive unsigned integer (\u003Ccode>u32\u003C/code>, \u003Ccode>u64\u003C/code>, \u003Ccode>usize\u003C/code>) of the backing buffer and sets the granularity for all bitwise operations.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Ccode>E\u003C/code> requires the \u003Ccode>dsi-bitstream::Endianness\u003C/code> trait, allowing us to specify either Little-Endian (\u003Ccode>LE\u003C/code>) or Big-Endian (\u003Ccode>BE\u003C/code>) byte order.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Ccode>B\u003C/code>, which must implement \u003Ccode>AsRef&#x3C;[W]>\u003C/code>, represents the \u003Cstrong>backing storage\u003C/strong>. This abstraction over ownership allows \u003Ccode>FixedVec\u003C/code> to be either an owned container where \u003Ccode>B = Vec&#x3C;W>\u003C/code>, or a zero-copy, borrowed view where \u003Ccode>B = &#x26;[W]\u003C/code>. This makes it possible to, for example, construct a \u003Ccode>FixedVec\u003C/code> directly over a memory-mapped slice without any heap allocation.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>In this way, the compiler monomorphizes the struct and its methods for each concrete instantiation (e.g., \u003Ccode>FixedVec&#x3C;i16, u64, LE, Vec&#x3C;u64>>\u003C/code>), resulting in specialized code with no runtime overhead from the generic abstractions.\u003C/p>\n\u003Ch2 id=\"word-trait-the-physical-storage-layer\">\u003Ccode>Word\u003C/code> Trait: The Physical Storage Layer\u003C/h2>\n\u003Cp>The first step is to abstract the physical storage layer. The \u003Ccode>W\u003C/code> parameter must be a primitive unsigned integer type that supports bitwise operations. We can define a \u003Ccode>Word\u003C/code> trait that captures these requirements:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    UnsignedInt\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Bounded\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ToPrimitive\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> dsi_bitstream\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">traits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Word\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> NumCast\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Copy\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Send\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Sync\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> IntoAtomic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">static\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The numeric traits (\u003Ccode>UnsignedInt\u003C/code>, \u003Ccode>Bounded\u003C/code>, \u003Ccode>NumCast\u003C/code>, \u003Ccode>ToPrimitive\u003C/code>) are necessary for the arithmetic of offset and mask calculations. The \u003Ccode>dsi_bitstream::traits::Word\u003C/code> bound allows us to integrate with its \u003Ccode>BitReader\u003C/code> and \u003Ccode>BitWriter\u003C/code> implementations, offloading the bitstream logic. \u003Ccode>Send\u003C/code> and \u003Ccode>Sync\u003C/code> are non-negotiable requirements for any data structure that might be used in a concurrent context. The \u003Ccode>IntoAtomic\u003C/code> bound is particularly forward-looking: it establishes a compile-time link between a storage word like \u003Ccode>u64\u003C/code> and its atomic counterpart, \u003Ccode>AtomicU64\u003C/code>. We will use it later to build a thread safe, atomic version of \u003Ccode>FixedVec\u003C/code>. Finally, the \u003Ccode>const BITS\u003C/code> associated constant lets us write architecture-agnostic code that correctly adapts to \u003Ccode>u32\u003C/code>, \u003Ccode>u64\u003C/code>, or \u003Ccode>usize\u003C/code> words without \u003Ccode>cfg\u003C/code> flags.\u003C/p>\n\u003Ch2 id=\"storable-trait-the-logical-type-layer\">\u003Ccode>Storable\u003C/code> Trait: The Logical Type Layer\u003C/h2>\n\u003Cp>With the physical storage layer defined, we need a formal contract to connect it to the userâ€™s logical type \u003Ccode>T\u003C/code>. We can do this by creating the \u003Ccode>Storable\u003C/code> trait, which defines a bidirectional, lossless conversion.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Sized\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Copy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> into_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> from_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">word\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For unsigned types, the implementation is a direct cast. For signed types, however, we must map the \u003Ccode>iN\u003C/code> domain to the \u003Ccode>uN\u003C/code> domain required for bit-packing. A simple twoâ€™s complement bitcast is unsuitable, as \u003Ccode>i64(-1)\u003C/code> would become \u003Ccode>u64::MAX\u003C/code>, a value requiring the maximum number of bits. We need a better mapping that preserves small absolute values.\u003C/p>\n\u003Cp>We can use \u003Cstrong>ZigZag encoding\u003C/strong>, which maps integers with small absolute values to small unsigned integers. This is implemented via the \u003Ccode>ToNat\u003C/code> and \u003Ccode>ToInt\u003C/code> traits from \u003Ccode>dsi-bitstream\u003C/code>. The core encoding logic in \u003Ccode>to_nat\u003C/code> is:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// From dsi_bitstream::traits::ToNat\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> to_nat\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">UnsignedInt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">BITS\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This operation works as follows: \u003Ccode>(self &#x3C;&#x3C; 1)\u003C/code> creates a space at the LSB. The term \u003Ccode>(self >> (Self::BITS - 1))\u003C/code> is an arithmetic right shift, which generates a sign maskâ€”all zeros for non-negative numbers, all ones for negative numbers. The final XOR uses this mask to interleave positive and negative integers: 0 becomes 0, -1 becomes 1, 1 becomes 2, -2 becomes 3, and so on.\u003C/p>\n\u003Cp>The decoding reverses this transformation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// From dsi_bitstream::traits::ToInt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> to_int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">SignedInt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >>\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_signed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">^\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">to_signed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Here, \u003Ccode>(self >> 1)\u003C/code> shifts the value back. The term \u003Ccode>-(self &#x26; 1)\u003C/code> creates a mask from the LSB (the original sign bit). In twoâ€™s complement, this becomes \u003Ccode>0\u003C/code> for even numbers (originally positive) and \u003Ccode>-1\u003C/code> (all ones) for odd numbers (originally negative). The final XOR with this mask correctly restores the original twoâ€™s complement representation.\u003C/p>\n\u003Cp>We might ask ourselves: why not just a direct bitcast for signed types, perhaps via a \u003Ccode>uN -> iN\u003C/code> chain. Well, while a direct \u003Ca href=\"https://doc.rust-lang.org/std/mem/fn.transmute.html\">transmute\u003C/a> between same-sized integer types is a no-op, the approach fails when the logical \u003Ccode>bit_width\u003C/code> is smaller than the physical type size. \u003Ccode>FixedVec\u003C/code>â€™s core logic extracts a \u003Ccode>bit_width\u003C/code>-sized unsigned integer from its storage. For example, when reading a 4-bit representation of \u003Ccode>-1\u003C/code> (binary \u003Ccode>1111\u003C/code>), the \u003Ccode>from_word\u003C/code> function receives the value \u003Ccode>15u64\u003C/code>. At this point, the context that those four bits represented a negative number is lost. A cast chain like \u003Ccode>15u64 as u8 as i8\u003C/code> would simply yield \u003Ccode>15i8\u003C/code>, not \u003Ccode>-1i8\u003C/code>.\u003C/p>\n\u003Cp>To correctly reconstruct the signed value, one would need to manually perform sign extension based on the known \u003Ccode>bit_width\u003C/code>. This involves checking the most significant bit of the extracted value and, if set, filling the higher-order bits of the word with ones. This logic requires a conditional branch, which can introduce pipeline stalls and degrade performance in tight loops. ZigZag decoding, by contrast, is a purely arithmetic, branch-free transformation. Its reconstruction logic is a simple sequence of bitwise shifts and XORs, making it a faster and more consistent choice for the hot path of data access.\u003C/p>\n\u003Cp>With this logic within the trait system, the main \u003Ccode>FixedVec\u003C/code> implementation remains clean and agnostic to the signedness of the data it stores.\u003C/p>\n\u003Ch2 id=\"builder-pattern\">Builder Pattern\u003C/h2>\n\u003Cp>Once the structure logic is in place, we have to design an ergonomic way to construct it. A simple \u003Ccode>new()\u003C/code> function isnâ€™t sufficient because the vectorâ€™s memory layout depends on parameters that must be determined \u003Cem>before\u003C/em> allocation, most critically the \u003Ccode>bit_width\u003C/code>. This is a classic scenario for a builder pattern.\u003C/p>\n\u003Cp>The central problem is that the optimal \u003Ccode>bit_width\u003C/code> often depends on the data itself. We need a mechanism to specify the \u003Cem>strategy\u003C/em> for determining this width. We can create the \u003Ccode>BitWidth\u003C/code> enum:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Minimal\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    PowerOfTwo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Explicit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With this enum, the user can choose between three strategies:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>Minimal\u003C/code>: The builder scans the input data to find the maximum value, then calculates the minimum number of bits required to represent it. This is the most space-efficient option but requires a full pass over the data.\u003C/li>\n\u003Cli>\u003Ccode>PowerOfTwo\u003C/code>: Similar to \u003Ccode>Minimal\u003C/code>, but rounds the bit width up to the next power of two. This can simplify certain bitwise operations and align better with hardware word sizes, at the cost of some additional space.\u003C/li>\n\u003Cli>\u003Ccode>Explicit(n)\u003C/code>: The user provides a fixed bit width. This avoids the data scan but requires the user to ensure that all values fit within the specified width.\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cp>\u003Cstrong>Note:\u003C/strong> Yes, I could have also made three different build functions: \u003Ccode>new_with_minimal_bit_width()\u003C/code>, \u003Ccode>new_with_power_of_two_bit_width()\u003C/code>, and \u003Ccode>new_with_explicit_bit_width(n)\u003C/code>. However, this would lead to a combinatorial explosion if we later wanted to add more configuration options. The builder pattern scales better.\u003C/p>\n\u003C/blockquote>\n\u003Cp>With this, the \u003Ccode>FixedVecBuilder\u003C/code> could be designed as a state machine. It holds the chosen \u003Ccode>BitWidth\u003C/code> strategy. The final \u003Ccode>build()\u003C/code> method takes the input slice and executes the appropriate logic.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A look at the builder's logic flow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> build\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">...\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> final_bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width_strategy {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Explicit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        _\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // For Minimal or PowerOfTwo, we first find the max value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> max_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">into_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> min_bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> max_val\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">leading_zeros\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bit_width_strategy {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Minimal\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> min_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">                BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">PowerOfTwo\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> min_bits\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">next_power_of_two\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">                _\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> =>\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> unreachable!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... (rest of the logic: allocate buffer, write data) ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This design cleanly separates the configuration phase from the execution phase. The user can declaratively state their requirements, and the builder handles the implementation details, whether that involves a full data scan or a direct construction. For example:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compressed_intvec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">prelude\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">200\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">500\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]; \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Max value 500 requires 9 bits\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The builder will scan the data, find max=500, calculate min_bits=9,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// and then round up to the next power of two.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec_pow2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> UFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">builder\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">PowerOfTwo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">build\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec_pow2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>\u003Ccode>UFixedVec&#x3C;T>\u003C/code> is a type alias for \u003Ccode>FixedVec&#x3C;T, u64, LE, Vec&#x3C;u64>>\u003C/code>, the most common instantiation.\u003C/p>\n\u003C/blockquote>\n\u003Ch1 id=\"doing-more-than-just-reading\">Doing more than just reading\u003C/h1>\n\u003Cp>The design of \u003Ccode>FixedVec\u003C/code> allows for more than just efficient reads. We can extend it to support mutation and even thread-safe (almost atomic) concurrent access.\u003C/p>\n\u003Ch2 id=\"mutability-proxy-objects\">Mutability: Proxy Objects\u003C/h2>\n\u003Cp>A core feature of \u003Ccode>std::vec::Vec\u003C/code> is mutable, index-based access via \u003Ccode>&#x26;mut T\u003C/code>. This is fundamentally impossible for \u003Ccode>FixedVec\u003C/code>. An element, such as a 10-bit integer, is not a discrete, byte-aligned entity in memory. It is a virtual value extracted from a bitstream, potentially spanning the boundary of two different \u003Ccode>u64\u003C/code> words. It has no stable memory address, so a direct mutable reference cannot be formed.\u003C/p>\n\u003Cp>To provide an ergonomic mutable API, we must emulate the behavior of a mutable reference. We achieve this through a proxy object pattern, implemented in a struct named \u003Ccode>MutProxy\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MutProxy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Storable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    E\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Endianness\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    B\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AsRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AsMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A temporary, decoded copy of the element's value.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When we call a method like \u003Ccode>at_mut(index)\u003C/code>, it does not return a reference. Instead, it constructs and returns a \u003Ccode>MutProxy\u003C/code> instance. The proxyâ€™s lifecycle manages the entire modification process:\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Construction:\u003C/strong> The proxy is created. Its first action is to call the parent \u003Ccode>FixedVec\u003C/code>â€™s internal \u003Ccode>get\u003C/code> logic to read and decode the value at the specified \u003Ccode>index\u003C/code>. This decoded value is stored as a temporary copy inside the proxy object itself.\u003C/li>\n\u003Cli>\u003Cstrong>Modification:\u003C/strong> The \u003Ccode>MutProxy\u003C/code> implements \u003Ccode>Deref\u003C/code> and \u003Ccode>DerefMut\u003C/code>, allowing the user to interact with the temporary copy as if it were the real value. Any modifications (\u003Ccode>*proxy = new_value\u003C/code>, \u003Ccode>*proxy += 1\u003C/code>) are applied to this local copy, not to the underlying bitstream.\u003C/li>\n\u003Cli>\u003Cstrong>Destruction:\u003C/strong> When the \u003Ccode>MutProxy\u003C/code> goes out of scope, its \u003Ccode>Drop\u003C/code> implementation is executed. This is the critical step where the potentially modified value from the temporary copy is taken, re-encoded, and written back into the correct bit position in the parent \u003Ccode>FixedVec\u003C/code>â€™s storage.\u003C/li>\n\u003C/ol>\n\u003Cp>This is a classic copy-on-read, write-on-drop mechanism. It provides a safe and ergonomic abstraction for mutating non-addressable data, preserving the feel of direct manipulation while correctly handling the bit-level operations under the hood. The overhead is a single read at the start of the proxyâ€™s life and a single write at the end.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compressed_intvec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fixed\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">UFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">20\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">30\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> UFixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">builder\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">bit_width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(BitWidth\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Explicit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">7\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">build\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    .\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// vec.at_mut(1) returns an Option&#x3C;MutProxy&#x3C;...>>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> let\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> proxy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The DerefMut trait allows us to modify the proxy's internal copy.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">proxy\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 99\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The proxy is dropped here. Its Drop impl writes 99 back to the vec.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">), \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">99\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The overhead of this approach is a single read on the proxyâ€™s construction and a single write on its destruction, which is an acceptable trade-off for an ergonomic and safe mutable API.\u003C/p>\n\u003Ch3 id=\"zero-copy-views\">Zero-Copy Views\u003C/h3>\n\u003Cp>A \u003Ccode>Vec\u003C/code>-like API needs to support slicing. Creating a \u003Ccode>FixedVec\u003C/code> that borrows its data (\u003Ccode>B = &#x26;[W]\u003C/code>) is the first step for this, but we also need a dedicated slice type to represent a sub-region of another \u003Ccode>FixedVec\u003C/code> without copying data. For this we can create \u003Ccode>FixedVecSlice\u003C/code>.\u003C/p>\n\u003Cp>We can implement this as a classic â€œfat pointerâ€ struct. It holds a reference to the parent \u003Ccode>FixedVec\u003C/code> and a \u003Ccode>Range&#x3C;usize>\u003C/code> that defines the logical boundaries of the view.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A zero-copy view into a contiguous portion of a FixedVec.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[derive(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">V\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    pub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">super\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">parent\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> V\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    pub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">super\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">range\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Range\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The generic parameter \u003Ccode>V\u003C/code> is a reference to the parent vector. This allows the same \u003Ccode>FixedVecSlice\u003C/code> struct to represent both immutable (\u003Ccode>V = &#x26;FixedVec&#x3C;...>\u003C/code>) and mutable (\u003Ccode>V = &#x26;mut FixedVec&#x3C;...>\u003C/code>) views.\u003C/p>\n\u003Cp>We can implement all the operations on the slice by translating the slice-relative index into an absolute index in the parent vector. For example, we can easily implement \u003Ccode>get_unchecked\u003C/code> with this delegation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Index translation within the slice's get_unchecked\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    debug_assert!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The index is relative to the slice, so we add the slice's start\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // offset to get the correct index in the parent vector.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">    self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">parent\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get_unchecked\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">range\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">start \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In this way there is no code duplication; the slice re-uses the access logic of the parent \u003Ccode>FixedVec\u003C/code>.\u003C/p>\n\u003Ch2 id=\"mutable-slices\">Mutable Slices\u003C/h2>\n\u003Cp>For mutable slices (\u003Ccode>V = &#x26;mut FixedVec&#x3C;...>\u003C/code> ), we can provide mutable access to the sliceâ€™s elements. We can easily implement the \u003Ccode>at_mut\u003C/code> method on \u003Ccode>FixedVecSlice\u003C/code> using the same principle of index translation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MutProxy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">E\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // The index is translated to the parent vector's coordinate space.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MutProxy\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">parent, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">range\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">start \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> index\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A mutable slice borrows the parent \u003Ccode>FixedVec\u003C/code> mutably. This means that while the slice exists, the parent vector cannot be accessed directly due to Rustâ€™s borrowing rules. Letâ€™s consider the following situation: we may need to split a mutable slice into two non-overlapping mutable slices. This is common for example in algorithms that operate on sub-regions of an array. However, implementing such a method requires to use some unsafe code. The method, letâ€™s say \u003Ccode>split_at_mut\u003C/code>, must produce two \u003Ccode>&#x26;mut\u003C/code> references from a single one. In order to be safe, we must prove to the compiler that the logical ranges they represent (\u003Ccode>0..mid\u003C/code> and \u003Ccode>mid..len\u003C/code>) are disjoint.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> split_at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    assert!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">len, \u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">mid > len in split_at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // SAFETY: The two slices are guaranteed not to overlap.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> left\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> right\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FixedVecSlice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This combination of a generic slice struct and careful pointer manipulation allows us to build a rich, safe, and zero-copy API for both immutable and mutable views, mirroring Rustâ€™s native slice\u003C/p>\n\u003Ch1 id=\"next-steps\">Next Steps\u003C/h1>\n\u003Cp>Our \u003Ccode>FixedVec\u003C/code> works pretty well at the current state, but its strengths are tied to two key assumptions: a single thread of execution and uniformly bounded data. Real-world systems often challenge both. This opens up two distinct paths for us to extend our design: one to handle concurrency, and another to adapt to more complex data distributions.\u003C/p>\n\u003Ch2 id=\"concurrent-access\">Concurrent Access\u003C/h2>\n\u003Cp>The design of \u003Ccode>FixedVec\u003C/code> is fundamentally single-threaded. Its mutable access relies on direct writes to the underlying bit buffer, a model that offers no guarantees in a concurrent setting. The core conflict lies between our data layout and the hardwareâ€™s atomic primitives. CPU instructions like compare-and-swap operate on aligned machine words, typically \u003Ccode>u64\u003C/code>. Our elements, however, are packed at arbitrary bit offsets and can span the boundary between two words.\u003C/p>\n\u003Cp>This means a single logical updateâ€”modifying one elementâ€”might require writing to two separate \u003Ccode>u64\u003C/code> words. Performing this as two distinct atomic writes would create a race condition, leaving the data in a corrupt state if another thread reads between them. A single atomic write to one of the underlying \u003Ccode>u64\u003C/code> words would be equally disastrous, as it could simultaneously alter parts of two different elements. The problem then is how to build atomic semantics on top of a non-atomic memory layout. In the next post, we will construct a solution that provides thread-safe, atomic operations for our bit-packed vector.\u003C/p>\n\u003Ch2 id=\"variable-length-encoding\">Variable Length Encoding\u003C/h2>\n\u003Cp>Letâ€™s consider the following scenario: we have a large collection of integers, all of which are small, say in the range \u003Ccode>[0, 255]\u003C/code>, but with a few outliers that are much larger, perhaps up to \u003Ccode>u64::MAX\u003C/code>. If we were to use our \u003Ccode>FixedVec\u003C/code> with a \u003Ccode>bit_width\u003C/code> of 64 to accommodate the outliers, we would waste a significant amount of memory on the small integers. Conversely, if we chose a smaller \u003Ccode>bit_width\u003C/code>, we would be unable to represent the outliers at all.\u003C/p>\n\u003Cp>The fixed-width model rests on that critical assumption of uniformly bounded data. Its performance comes from this predictability, but this rigid structure is also its main weakness.\u003C/p>\n\u003Cp>For skewed data distributions, we need a different model. Instead of a fixed number of bits per element, we can use variable-length instantaneous codes, where smaller numbers are represented by shorter bit sequences. This gives us excellent compression, but it breaks our O(1) random access guarantee. We can no longer compute the location of the i-th element with a simple multiplication. The solution is to trade a small amount of space for a speedup in access time. We can build a secondary index that stores the bit-offset of every k-th element. This sampling allows us to seek to a nearby checkpoint and decode sequentially from there, restoring amortized O(1) access. In a future article, weâ€™ll explore this second vector type, its own set of performance trade-offs, and how we can choose the best encoding for our data.\u003C/p>\n\u003Chr>\n\u003Cp>We will explore this two paths in future articles. In the meantime, if you want to try them out, they are both already implemented in the library. You can find the atomic version in the \u003Ca href=\"https://docs.rs/compressed-intvec/latest/compressed_intvec/fixed/atomic/index.html\">atomic\u003C/a> module and the variable-length version in the \u003Ca href=\"https://docs.rs/compressed-intvec/latest/compressed_intvec/variable/struct.IntVec.html\">variable\u003C/a> module.\u003C/p>",{"headings":553,"localImagePaths":622,"remoteImagePaths":623,"frontmatter":624,"imagePaths":627},[554,556,559,562,565,568,571,574,577,580,583,586,589,592,595,598,601,604,607,610,613,616,619],{"depth":32,"slug":210,"text":555},"Table of contents",{"depth":213,"slug":557,"text":558},"memory-waste-in-standard-vectors","Memory Waste in Standard Vectors",{"depth":213,"slug":560,"text":561},"packing-and-accessing-bits","Packing and Accessing Bits",{"depth":32,"slug":563,"text":564},"crossing-word-boundaries","Crossing Word Boundaries",{"depth":32,"slug":566,"text":567},"faster-reads-unaligned-access","Faster Reads: Unaligned Access",{"depth":32,"slug":569,"text":570},"random-access-performance","Random Access Performance",{"depth":32,"slug":572,"text":573},"iterating-over-values","Iterating Over Values",{"depth":131,"slug":575,"text":576},"double-ended-iteration","Double-Ended Iteration",{"depth":213,"slug":578,"text":579},"writing-bits","Writing bits",{"depth":32,"slug":581,"text":582},"in-word-write","In-Word Write",{"depth":32,"slug":584,"text":585},"spanning-write","Spanning Write",{"depth":32,"slug":587,"text":588},"random-write-performance","Random Write Performance",{"depth":213,"slug":590,"text":591},"architecture","Architecture",{"depth":32,"slug":593,"text":594},"word-trait-the-physical-storage-layer","Word Trait: The Physical Storage Layer",{"depth":32,"slug":596,"text":597},"storable-trait-the-logical-type-layer","Storable Trait: The Logical Type Layer",{"depth":32,"slug":599,"text":600},"builder-pattern","Builder Pattern",{"depth":213,"slug":602,"text":603},"doing-more-than-just-reading","Doing more than just reading",{"depth":32,"slug":605,"text":606},"mutability-proxy-objects","Mutability: Proxy Objects",{"depth":131,"slug":608,"text":609},"zero-copy-views","Zero-Copy Views",{"depth":32,"slug":611,"text":612},"mutable-slices","Mutable Slices",{"depth":213,"slug":614,"text":615},"next-steps","Next Steps",{"depth":32,"slug":617,"text":618},"concurrent-access","Concurrent Access",{"depth":32,"slug":620,"text":621},"variable-length-encoding","Variable Length Encoding",[],[],{"author":14,"pubDatetime":625,"title":544,"slug":540,"featured":198,"draft":17,"tags":626,"description":546},["Date","2025-09-24T00:00:00.000Z"],[200,300],[],"who-owns-the-memory-pt1",{"id":628,"data":630,"body":636,"filePath":637,"digest":638,"rendered":639},{"author":14,"pubDatetime":631,"title":632,"featured":17,"draft":17,"tags":633,"description":635},["Date","2025-12-20T00:00:00.000Z"],"Who Owns the Memory? Part 1: Objects",[200,634],"Programming","From hardware to aliasing rules: understanding how C, C++, and Rust map types to memory.","This is the first article in a $n$-part series exploring how C, C++, and Rust manage memory at a low level. We begin where the hardware does: with bytes. From there, we build up to objects, storage duration, lifetime, and aliasing, the vocabulary required to understand ownership. \n\n## Table of contents\n\n## Memory Is Just Bytes\n\n\nA 64-bit processor sees memory as a flat array of $2^{64}$ addressable bytes. It does not know what a `struct` is. It does not know what an `int` is. When we execute `mov rax, [rbx]`, the CPU fetches 8 bytes starting at the address in `rbx`, shoves them into `rax`, and moves on. The semantic meaning of those bytes, whether they represent a pointer, a floating-point number, or part of a UTF-8 string, exists only in our source code and the instructions we generate.\n\nThe machinery we build atop this substrate, effective types in C, object lifetime in C++, validity invariants in Rust, exists to help compilers reason about what the hardware cannot see. These abstractions enable optimization: if the compiler knows two pointers cannot alias, it keeps values in registers instead of reloading from memory. If it knows a reference is never null, it elides null checks. If it knows an object's lifetime has ended, it reuses the storage.\n\n### Virtual Address Space\n\nModern operating systems do not give processes direct access to physical RAM. Instead, each process operates within its own virtual address space, a fiction maintained by the MMU (Memory Management Unit) that maps virtual addresses to physical frames. The C standard captures this abstraction explicitly: pointers in C reference virtual memory, and the language makes no guarantees about physical layout.\n\nThis abstraction buys us two properties:\n\n1. **Isolation**: A pointer in process A cannot reference memory in process B. Dereferencing an unmapped address triggers a page fault, typically terminating the process. This is crucial for process-level security, a compromised or buggy process cannot read credentials from our browser or corrupt our kernel's data structures.\n2. **Portability**: Code does not need to know the physical memory topology of the machine it runs on.\n\nFrom our perspective, virtual memory means that the addresses we work with are translated by hardware before reaching DRAM. This translation has performance implications. TLB misses are expensive, but the abstraction holds: we operate on a contiguous address space that the OS manages for us.\n\n### Alignment\n\nNot all byte addresses are equal. On x86-64, loading a `uint64_t` from an address that is not divisible by 8 incurs a penalty. On stricter architectures like ARM (without unaligned access support) or older SPARC, it causes a hardware trap.\n\nThe reason is mechanical. DRAM is accessed in aligned chunks. When the CPU requests data at address `0x1003`, but the memory bus fetches 8-byte-aligned blocks, the memory controller must fetch two blocks (`0x1000-0x1007` and `0x1008-0x100F`), extract the relevant bytes, and reassemble them. This costs cycles.\n\nThe C standard formalizes this through the concept of alignment:\n```c\n#include \u003Cstdalign.h>\n#include \u003Cstdio.h>\n\nint main(void) {\n    printf(\"alignof(int) = %zu\\n\", alignof(int));           // typically 4\n    printf(\"alignof(double) = %zu\\n\", alignof(double));     // typically 8\n    printf(\"alignof(max_align_t) = %zu\\n\", alignof(max_align_t)); // typically 16\n}\n```\n\nThe `alignof` operator (C11/C23) returns the required alignment for a type. Accessing an object at an address that violates its alignment is undefined behavior, not because the standard is being pedantic, but because the hardware cannot reliably execute it.\n\nConsider this concrete failure case from [Modern C](https://gustedt.gitlabpages.inria.fr/modern-c/):\n```c\nunion {\n    unsigned char bytes[32];\n    complex double val[2];\n} overlay;\n\n// complex double typically requires 16-byte alignment (sizeof is 16)\ncomplex double *p = (complex double *)&overlay.bytes[4];  // misaligned\n*p = 1.0 + 2.0*I;  // undefined behavior\n```\n\nOn x86-64 with alignment checking enabled, or on ARM, this crashes with a bus error. The pointer arithmetic is legal C, but the resulting address violates the alignment requirement of `complex double`. The hardware refuses.\n\n### Cache Lines and Memory Bandwidth\n\nAlignment interacts with another hardware reality: cache lines. On modern x86-64 processors, the L1 cache operates on 64-byte lines. When we read a single byte, the CPU actually fetches 64 bytes. If our data structures are laid out poorly, we waste bandwidth fetching bytes we never use.\n\nWorse, if a single logical datum spans two cache lines, every access requires two cache fetches. For a `struct` that straddles a 64-byte boundary, this doubles memory traffic.\n\nThis is why compilers insert padding between struct fields. Consider:\n```c\nstruct Bad {\n    char a;     // 1 byte\n    // 7 bytes padding\n    double b;   // 8 bytes\n    char c;     // 1 byte\n    // 7 bytes padding (to align the whole struct)\n};\n\nstruct Good {\n    double b;   // 8 bytes\n    char a;     // 1 byte\n    char c;     // 1 byte\n    // 6 bytes padding\n};\n```\n\n`sizeof(struct Bad)` is 24 bytes. `sizeof(struct Good)` is 16 bytes. the compiler cannot reorder fields in C (the standard guarantees fields appear in declaration order with increasing addresses), so the programmer must consider layout.\n\n![](/memory/fig1.png)\n\u003Cp align=\"center\">\u003Cem>Yes, it's made with Gemini. I'm not good with Figma.\u003C/em>\u003C/p>\n\n### The Allocator's View\n\nWhen we call `malloc(n)`, we do not receive exactly `n` bytes of usable memory. The allocator maintains metadata like chunk headers, size fields, and free-list pointers that live adjacent to our allocation. In glibc's ptmalloc2, an allocated chunk looks roughly like this:\n```\n+------------------+\n| prev_size        |  (8 bytes, used only if previous chunk is free)\n+------------------+\n| size       |N|M|P|  (8 bytes, includes flags in low 3 bits)\n+------------------+\n| user data...     |  \u003C- pointer returned by malloc\n|                  |\n+------------------+\n```\n\nThe `size` field stores the chunk size with three flag bits: `P` (previous chunk in use), `M` (chunk obtained via `mmap`), and `A` (non-main arena). The actual usable size is `size & ~0x7`.\n\nThis means:\n\n1. Every allocation has overhead. Small allocations suffer proportionally more: a 16-byte allocation requires at least 32 bytes of actual memory (16 bytes data + 16 bytes metadata, depending on the allocator).\n2. The allocator imposes its own alignment. `malloc` guarantees alignment suitable for any primitive type (`max_align_t`), which is 16 bytes on most 64-bit platforms.\n3. Memory is not _free_. The allocator tracks allocated regions, and `free()` does not necessarily return memory to the OS, it typically returns it to a free list for reuse.\n\nWhen we discuss ownership and resource management in later sections, keep this in mind: _deallocating memory_ at the language level means returning bytes to the allocator. The allocator decides when (if ever) to return pages to the operating system.\n\n### Objects Are Bytes\n\nThe C standard makes this explicit: every object can be viewed as an array of `unsigned char`:\n```c\nint x = 42;\nunsigned char *bytes = (unsigned char *)&x;\nfor (size_t i = 0; i \u003C sizeof(int); i++) {\n    printf(\"%02x \", bytes[i]);\n}\n// Output on little-endian x86-64: 2a 00 00 00\n```\n\nThis is the object representation, the actual bytes in memory. The semantic interpretation (that these bytes represent the integer 42) is layered on top by the type system.\n\nRust and C++ inherit this model. When we say a Rust `i32` occupies 4 bytes with alignment 4, we mean exactly what C means: 4 contiguous bytes at an address divisible by 4. The type systems differ dramatically in what operations they permit on those bytes, but the physical representation is identical.\n\nThis is the starting point. We have bytes in a virtual address space, aligned for hardware access, managed by an allocator. Everything that follows, effective types, ownership, lifetimesâ€”is a layer of abstraction over this physical reality.\n\n## From Bytes to Objects\n\nA region of memory becomes an *object* when we impose a type interpretation on it. The type dictates how many bytes participate, what their alignment must be, and what operations are valid. But the three languages differ fundamentally in when and how this imposition occurs, and what invariants the type carries.\n\n### C: Effective Type Rules\n\nIn C, the relationship between memory and type is established through the concept of *effective type*. The effective type of an object determines how it may be accessed.\n\nFor declared variables, the effective type is simply the declared type:\n\n```c\nint x = 42;  // effective type of x is int\n```\n\nThe variable `x` occupies `sizeof(int)` bytes at some address, and those bytes must be accessed as `int` or as `unsigned char`. Accessing them as `float*` is undefined behavior:\n\n```c\nint x = 42;\nfloat *fp = (float *)&x;\nfloat f = *fp;  // undefined behavior: access through incompatible type\n```\n\nThis is not a runtime check. The compiler does not insert code to verify the access. Instead, the rule exists to enable optimization. When the compiler sees a write through `int*` and a read through `float*`, the strict aliasing rule permits it to assume these pointers reference different objects. The compiler can then reorder loads and stores, keep values in registers across the write, and eliminate redundant accesses.\n\nThe rule has a critical asymmetry. Any object can be viewed as an array of `unsigned char`:\n\n```c\nint x = 42;\nunsigned char *bytes = (unsigned char *)&x;\nfor (size_t i = 0; i \u003C sizeof(int); i++) {\n    printf(\"%02x \", bytes[i]);  // valid: char access is always permitted\n}\n```\n\nBut the reverse is undefined:\n\n```c\nunsigned char buffer[sizeof(int)] = {0};\nint *p = (int *)buffer;\nint val = *p;  // undefined behavior\n```\n\nThe buffer's effective type is `unsigned char[4]`. Accessing it through `int*` violates the effective type rule. The fact that the bytes happen to form a valid `int` representation is irrelevant. The compiler is entitled to assume this access cannot happen, and may generate code that produces garbage or crashes.\n\nFor dynamically allocated memory, the situation is different. Memory returned by `malloc` has no effective type until we write to it:\n\n```c\nvoid *p = malloc(sizeof(double));\ndouble *dp = p;\n*dp = 3.14;  // this write sets the effective type to double\n```\n\nAfter this write, the allocated region has effective type `double`. Subsequent reads through `double*` are valid. Reading through `int*` would again be undefined.\n\nThe effective type machinery exists purely for optimization. The compiler uses it to reason about aliasing. It provides no runtime safety.\n\n### C++: Object Lifetime\n\nC++ inherits C's effective type rules but adds a distinct concept: *object lifetime*. An object's lifetime is the interval during which accessing the object is well-defined.\n\nThe C++ standard (N4950, Â§6.7.3) specifies the boundaries precisely. For an object of type `T`:\n\n> The lifetime of an object of type T begins when:\n> (1.1) storage with the proper alignment and size for type T is obtained, and\n> (1.2) its initialization (if any) is complete\n\n> The lifetime of an object of type T ends when:\n> (1.3) if T is a non-class type, the object is destroyed, or\n> (1.4) if T is a class type, the destructor call starts, or\n> (1.5) the storage which the object occupies is released, or is reused by an object that is not nested within o.\n\nConsider placement new:\n\n```cpp\nstruct Widget {\n    int value;\n    Widget(int v) : value(v) { }\n    ~Widget() { std::cout \u003C\u003C \"destroyed\\n\"; }\n};\n\nalignas(Widget) unsigned char buffer[sizeof(Widget)];\nWidget* w = new (buffer) Widget(42);  // lifetime begins here\nw->~Widget();                          // lifetime ends here\n// buffer still contains bytes, but no Widget object exists\n```\n\nBetween placement new and the destructor call, a `Widget` object exists at that address. Before placement new and after the destructor, the bytes exist but no `Widget` does. Accessing `w->value` after `w->~Widget()` is undefined behavior, even though the bytes are still there and unchanged.\n\nThe destructor call does not free memory. It ends the object's lifetime while the storage remains intact. This is what placement new and explicit destructor calls rely on: the ability to construct an object in pre-existing storage, use it, destroy it, and potentially construct a different object in the same storage.\n\nFor trivial types (those without constructors, destructors, or virtual functions), C++ objects behave essentially like C objects. For class types with nontrivial special member functions, the lifetime boundaries become significant. A `std::string` accessed after destruction will likely read freed memory or corrupted pointers, because the destructor deallocated the internal buffer.\n\nC++20 also introduced *implicit object creation*. Certain operations, such as `std::malloc`, implicitly create objects of *implicit-lifetime types* if doing so would give the program defined behavior:\n\n```cpp\nstruct Point { int x, y; };  // implicit-lifetime type (trivial)\n\nPoint* p = (Point*)std::malloc(sizeof(Point));\np->x = 1;  // in C++20, this is well-defined\np->y = 2;  // malloc implicitly created the Point object\n```\n\nThis was added to retroactively make well-defined the code patterns that had been common but technically undefined.\n\n### Rust: Validity Invariants\n\nRust imposes a stronger requirement. Every type has *validity invariants*, and producing a value that violates its type's invariant is immediate undefined behavior. The compiler's optimizer assumes these invariants hold unconditionally.\n\nThe Rust Reference defines validity per type:\n\n```rust\n// A bool must be 0x00 (false) or 0x01 (true)\nlet b: bool = unsafe { std::mem::transmute(2u8) };  // UB: invalid bool\n\n// A reference must be non-null, aligned, and point to a valid value\nlet r: &i32 = unsafe { std::mem::transmute(0usize) };  // UB: null reference\n\n// A char must be a valid Unicode scalar value (not a surrogate)\nlet c: char = unsafe { std::mem::transmute(0xD800u32) };  // UB: surrogate\n\n// An enum must have a valid discriminant\nenum Status { Active = 0, Inactive = 1 }\nlet s: Status = unsafe { std::mem::transmute(2u8) };  // UB: invalid discriminant\n\n// The never type must never exist\nlet n: ! = unsafe { std::mem::zeroed() };  // UB\n```\n\nThe moment an invalid value is *produced*, undefined behavior has occurred. From the Rust Reference:\n\n> The Rust compiler assumes that all values produced during program execution are valid, and producing an invalid value is hence immediate UB.\n\nIn C, you can have an `int` variable containing any 32-bit pattern, and as long as you do not read it in certain ways, no UB occurs. In Rust, if a `bool` contains the bit pattern `0x02`, UB has already happened at the point of creation, regardless of whether you subsequently read it.\n\nConsider references. In C and C++, a pointer can be null, and dereferencing it is UB. But the pointer itself can exist and be passed around. In Rust:\n\n```rust\nlet ptr: *const i32 = std::ptr::null();  // valid: raw pointer can be null\nlet r: &i32 = unsafe { &*ptr };          // UB occurs HERE, at reference creation\n```\n\nThe UB does not occur when we read through the reference. It occurs when the reference is created. A `&T` carries an invariant: non-null, properly aligned, pointing to a valid `T`. Violating this invariant at any point is UB, regardless of what we do with the reference afterward.\n\nThis strictness enables more aggressive optimization. When the compiler sees a `&T`, it emits `dereferenceable` and `nonnull` annotations to LLVM. A match expression on a `bool` need not generate a default case for values 2-255. These optimizations would be unsound if invalid values could exist.\n\nThe cost is that more operations require `unsafe`. You cannot create a reference to potentially-invalid memory, even temporarily. You must use raw pointers and convert to references only when validity is guaranteed:\n\n```rust\nlet ptr: *const i32 = some_ffi_function();\n\nif !ptr.is_null() && ptr.is_aligned() {\n    let r: &i32 = unsafe { &*ptr };  // sound: we verified validity\n    println!(\"{}\", *r);\n}\n```\n\n### Object Representation vs. Value\n\nAll three languages distinguish between an object's *representation* (its bytes in memory) and its *value* (the semantic interpretation of those bytes). But they draw the line differently, and understanding where each language draws it determines what low-level manipulations are sound.\n\nEvery object occupies a contiguous sequence of bytes. The *size* of a type is how many bytes; the *alignment* constrains where those bytes can start. A type with alignment 8 must be stored at an address divisible by 8. These are not arbitrary constraintsâ€”they reflect how the memory bus fetches data, as we saw in the alignment section.\n\nIn C, we can freely inspect any object as `unsigned char[]`:\n\n```c\ndouble d = 3.14159;\nunsigned char *bytes = (unsigned char *)&d;\n// bytes[0..7] contain the IEEE 754 representation\n```\n\nThe bytes are the representation. The value is what those bytes mean according to IEEE 754. C permits examining bytes without caring about their semantic meaning. C++ inherits this but adds constraints around object lifetimeâ€”we can inspect the bytes of a live object, but accessing bytes after the destructor has run is undefined, even if the storage has not been reused.\n\nRust permits byte-level inspection through raw pointers and transmutation, but imposes validity constraints that C and C++ do not:\n\n```rust\nlet x: i32 = 42;\nlet bytes: [u8; 4] = unsafe { std::mem::transmute(x) };\n// bytes contains the little-endian representation: [42, 0, 0, 0]\n\n// Going the other direction requires care:\nlet bytes: [u8; 1] = [2];\nlet b: bool = unsafe { std::mem::transmute(bytes) };  // UB: 2 is not a valid bool\n```\n\nThe asymmetry mirrors C's effective type rule. Converting a typed value to bytes is generally safe. Converting bytes to a typed value requires that the bytes constitute a valid value of that typeâ€”and Rust's validity invariants, as we saw earlier, are stricter than C's.\n\nThis distinction matters when we consider struct layout. C guarantees fields appear in declaration order; the compiler inserts padding but cannot reorder. C++ inherits this for standard-layout types. Rust makes minimal guarantees by defaultâ€”the `repr(Rust)` layout allows the compiler to reorder fields to minimize padding. Consider:\n\n```rust\nstruct A {\n    a: u8,\n    b: u32,\n    c: u16,\n}\n```\n\nRust might lay this out as `(b, c, a, padding)` to achieve size 8 instead of the naive 12. Different generic instantiations of the same struct may have different layouts. For interoperability with C, Rust provides `#[repr(C)]`, which guarantees C-compatible layout: fields in declaration order, padding computed by the standard algorithm.\n\nThe layout algorithm for `repr(C)` is deterministic. Start with offset 0. For each field in declaration order: add padding until the offset is a multiple of the field's alignment, record the field's offset, advance by the field's size. Finally, round the struct's total size up to its alignment. This is exactly how our `struct Bad` ended up at 24 bytes while `struct Good` achieved 16â€”the algorithm is mechanical, but field ordering is the programmer's responsibility.\n\nWhen is `mem::transmute` sound? Size must matchâ€”the compiler enforces this. Alignment must be compatibleâ€”transmuting `&u8` to `&u64` is unsound even if sizes matched, because the `u8` may not be 8-byte aligned. And validity must be preserved: the bytes must constitute a valid value of the target type. This last constraint is what Rust adds beyond C. The `repr(transparent)` attribute creates a type with identical layout to its single non-zero-sized field, making transmutation between them sound and enabling zero-cost newtypes.\n\n## Storage Duration\n\nEvery object resides somewhere in memory. The *storage duration* of an object determines when that memory is allocated and when it becomes invalid. All three languages recognize the same fundamental categories, though they use different terminology and provide different guarantees about deallocation.\n\n### The Four Categories\n\nC defines four storage durations. C++ inherits the same four. Rust maps onto an equivalent model, though the language specification does not use identical terminology.\n\n**Static storage duration**: The object exists for the entire execution of the program. In C and C++, this includes global variables, variables declared with `static`, and string literals. In Rust, this includes `static` items and string literals (which have type `&'static str`). The memory for these objects is typically placed in the `.data` or `.rodata` segment of the executable and requires no runtime allocation.\n\n**Thread storage duration**: The object exists for the lifetime of a thread. C11 introduced `_Thread_local` (spelled `thread_local` since C23), C++11 introduced `thread_local`, and Rust provides `thread_local!` macro. Each thread gets its own instance of the variable, allocated when the thread starts and deallocated when it terminates.\n\n**Automatic storage duration**: The object exists within a lexical scope, typically a function body or block. When execution enters the scope, space is reserved; when execution leaves, the space is released. In C and C++, local variables without `static` or `thread_local` have automatic storage. In Rust, all local bindings have automatic storage. This is typically implemented via the stack.\n\n**Allocated (dynamic) storage duration**: The object's lifetime is controlled explicitly by the program. In C, this means `malloc`/`free`. In C++, this means `new`/`delete` or allocator-aware containers. In Rust, this means `Box`, `Vec`, `String`, and other heap-allocating types.\n\n### Stack\n\nAutomatic storage is almost universally implemented using a call stack. When a function is called, the compiler reserves space for its local variables by adjusting the stack pointer. On x86-64 following the System V ABI, this looks like:\n\n```asm\nmy_function:\n    push rbp\n    mov rbp, rsp\n    sub rsp, 48          ; reserve 48 bytes for locals\n    ; ... function body ...\n    mov rsp, rbp\n    pop rbp\n    ret\n```\n\nThe `sub rsp, 48` instruction allocates space for all local variables in a single operation. The compiler computes the required size at compile time by summing the sizes of all locals (accounting for alignment). Deallocation is equally cheap: `mov rsp, rbp` releases all that space instantly.\n\nThis has two consequences:\n\n1. Allocation and deallocation of automatic storage is $O(1)$ regardless of how many objects are involved. A function with 100 local variables pays the same cost as one with 2.\n\n2. The space is not initialized. After `sub rsp, 48`, those 48 bytes contain whatever was previously on the stack. In C, reading an uninitialized automatic variable is undefined behavior (the value is *indeterminate*). In C++, the same rule applies. In Rust, the compiler enforces definite initialization: you cannot read a variable before assigning to it.\n\n```rust\nfn example() {\n    let x: i32;\n    println!(\"{}\", x);  // error: borrow of possibly-uninitialized variable\n}\n```\n\nThe Rust compiler tracks initialization state through control flow and rejects programs that might read uninitialized memory. This is a compile-time check with no runtime cost.\n\n### Heap\n\nDynamic allocation is fundamentally different. When we call `malloc(n)`, the allocator must:\n\n1. Find a contiguous region of at least `n` bytes that is not currently in use\n2. Mark that region as allocated\n3. Return a pointer to it\n\nWhen we call `free(p)`, the allocator must:\n\n1. Determine the size of the allocation (stored in metadata adjacent to the user data)\n2. Mark that region as available for future allocations\n3. Possibly coalesce adjacent free regions to reduce fragmentation\n\nThis involves data structure manipulation, potential system calls (if the allocator needs more memory from the OS), and can have variable latency depending on heap state. The cost is not $O(1)$.\n\nIn C, heap allocation is explicit:\n\n```c\nint* p = malloc(sizeof(int) * 100);\nif (p == NULL) {\n    // allocation failed\n}\n// ... use p ...\nfree(p);\n```\n\nThe programmer is responsible for:\n1. Checking for allocation failure\n2. Calling `free` exactly once\n3. Not using the pointer after `free`\n4. Not freeing the same pointer twice\n\nViolating any of these causes undefined behavior or memory leaks. The language provides no assistance.\n\nIn C++, dynamic allocation can be explicit (`new`/`delete`) or managed through RAII:\n\n```cpp\n// Explicit (dangerous)\nint* p = new int[100];\ndelete[] p;\n\n// RAII (safer)\nauto v = std::make_unique\u003Cint[]>(100);\n// v automatically deleted when it goes out of scope\n```\n\n`std::unique_ptr` wraps a raw pointer and calls `delete` in its destructor. When `v` goes out of scope, the destructor runs, the memory is freed. The programmer does not call `delete` manually.\n\nThis is opt-in. You can still use raw `new`/`delete`. You can still have dangling pointers. The compiler does not verify correctness.\n\nIn Rust, heap allocation is handled through owning types:\n\n```rust\nlet v: Vec\u003Ci32> = Vec::with_capacity(100);\n// v automatically deallocated when it goes out of scope\n```\n\n`Vec\u003CT>` owns heap-allocated memory. When `v` goes out of scope, `Vec`'s `Drop` implementation runs, calling the allocator to free the buffer. There is no way to forget to free, no way to double-free, and no way to use after free (the compiler rejects such programs).\n\nThe difference from C++ is that Rust's ownership is not opt-in. Every heap allocation is owned by exactly one binding. Transferring ownership is a move. After a move, the original binding is unusable:\n\n```rust\nlet v1 = vec![1, 2, 3];\nlet v2 = v1;           // v1 moved to v2\nprintln!(\"{:?}\", v1);  // error: borrow of moved value\n```\n\n### Who Calls Free?\n\nThe central difference between C, C++, and Rust in their treatment of dynamic storage is responsibility for deallocation.\n\nIn C, the programmer decides when to call `free`. The language does not track ownership. If you pass a pointer to a function, the function might free it, or it might not. The only way to know is documentation or convention.\n\n```c\nvoid process(int* data) {\n    // Does this function free data? You have to read the docs.\n}\n```\n\nIn C++, RAII shifts responsibility to destructors. If you use `unique_ptr`, the destructor frees. If you use `shared_ptr`, the destructor decrements a reference count and frees when it reaches zero. But you can still use raw pointers, and the compiler cannot tell you which convention a given codebase follows.\n\n```cpp\nvoid process(int* data) {\n    // Raw pointer: who owns this? Still ambiguous.\n}\n\nvoid process(std::unique_ptr\u003Cint[]> data) {\n    // Ownership transferred: this function will free when done.\n}\n```\n\nIn Rust, the type system encodes ownership:\n\n```rust\nfn process(data: Vec\u003Ci32>) {\n    // This function owns data. It will be freed when process returns.\n}\n\nfn process_ref(data: &Vec\u003Ci32>) {\n    // This function borrows data. The caller retains ownership.\n}\n\nfn process_mut(data: &mut Vec\u003Ci32>) {\n    // Mutable borrow. Caller retains ownership. No other access allowed during this call.\n}\n```\n\nThe signature tells you everything. `Vec\u003Ci32>` means ownership transfer. `&Vec\u003Ci32>` means immutable borrow. `&mut Vec\u003Ci32>` means mutable borrow. The compiler enforces these semantics. You cannot pass a `Vec` and then continue using it; the move would be rejected.\n\n### Stack Allocation in Rust\n\nRust provides fine-grained control over whether data lives on the stack or heap. By default, local bindings are stack-allocated:\n\n```rust\nlet x: [i32; 1000] = [0; 1000];  // 4000 bytes on the stack\n```\n\nThis works until the array is too large for the stack (typically 1-8 MB depending on platform). For large allocations, use `Box`:\n\n```rust\nlet x: Box\u003C[i32; 1000000]> = Box::new([0; 1000000]);  // heap\n```\n\n`Box\u003CT>` is a pointer to a heap allocation. It has the same size as a raw pointer (8 bytes on 64-bit), implements `Deref` so you can use it like a reference, and frees the allocation in its `Drop` implementation.\n\nThe memory layout of `Box\u003CT>` is a single pointer:\n\n```rust\nuse std::mem::size_of;\nassert_eq!(size_of::\u003CBox\u003C[i32; 1000]>>(), 8);  // just a pointer\n```\n\nUnlike C++ `unique_ptr`, which may carry a deleter, `Box\u003CT>` always uses the global allocator and has no space overhead. The deallocation function is known statically.\n\n\u003C!-- ### How Does Vec Work?\n\n`Vec\u003CT>` is Rust's growable array. Its memory layout is three machine words:\n\n```rust\n// Conceptually:\nstruct Vec\u003CT> {\n    ptr: *mut T,      // pointer to heap allocation\n    cap: usize,       // allocated capacity\n    len: usize,       // number of initialized elements\n}\n```\n\nOn 64-bit, `size_of::\u003CVec\u003CT>>()` is 24 bytes regardless of `T`.\n\nWhen you create a `Vec`:\n\n```rust\nlet mut v = Vec::with_capacity(10);\n```\n\nThe allocator provides a buffer for 10 elements. `ptr` points to it, `cap` is 10, `len` is 0.\n\nWhen you push elements:\n\n```rust\nv.push(1);  // len becomes 1\nv.push(2);  // len becomes 2\n```\n\nEach `push` writes to `ptr.add(len)` and increments `len`. No reallocation occurs while `len \u003C cap`.\n\nWhen `len` reaches `cap` and you push again, `Vec` must reallocate:\n\n1. Allocate a new buffer with larger capacity\n2. Copy existing elements to the new buffer\n3. Free the old buffer\n4. Update `ptr` and `cap`\n\nWhen `Vec` is dropped:\n\n1. Call `drop` on each element (for types with destructors)\n2. Free the buffer\n\nAll of this happens automatically. The programmer writes `v.push(x)` and the ownership system ensures the buffer is freed exactly once, when `v` goes out of scope.\n\nThis is the pattern throughout Rust's standard library. `String` owns a UTF-8 buffer. `HashMap` owns its backing storage. `File` owns a file descriptor. When the owner goes out of scope, the resource is released. The type system ensures there is always exactly one owner. -->\n\n## Object Lifetime\n\nStorage duration determines when memory is allocated and deallocated. Object lifetime determines when accessing that memory is well-defined. In C, these are identical. In C++, they can differ. In Rust, lifetime becomes a compile-time property tracked through constraint propagation over the control-flow graph.\n\n### C: Lifetime Is Storage Duration\n\nC does not distinguish between *storage exists* and *object is alive*. An object with automatic storage duration is alive from when execution enters its block of definition until execution leaves. An object with static storage duration is alive for the entire program. An object with allocated storage duration is alive from `malloc` to `free`.\n\nThe consequence is that C has no notion of *storage exists but object is not yet constructed*. When the stack frame is created, all automatic variables exist. Whether they are initialized is a separate question:\n\n```c\nint* dangling(void) {\n    int x = 42;\n    return &x;\n}\n\nint main(void) {\n    int* p = dangling();\n    printf(\"%d\\n\", *p);  // undefined behavior\n}\n```\n\nThis program compiles. The function `dangling` returns a pointer to `x`, but `x` has automatic storage duration. When `dangling` returns, its stack frame is deallocated. The pointer `p` now points to memory that no longer belongs to any live object. Dereferencing it is undefined behavior.\n\nThe C standard does not require the compiler to reject this. A conforming implementation may emit a warning, but the program is syntactically valid. The burden falls entirely on the programmer.\n\n### C++: Lifetime Within Storage\n\nC++ introduces a distinction. Storage duration determines when memory is allocated and deallocated. Object lifetime determines when the object can be accessed. For class types, lifetime begins when the constructor completes and ends when the destructor starts.\n\nConsider placement new:\n\n```cpp\nstruct Widget {\n    std::string name;\n    Widget(const char* n) : name(n) { }\n    ~Widget() { std::cout \u003C\u003C \"destroyed\\n\"; }\n};\n\nalignas(Widget) unsigned char buffer[sizeof(Widget)];\n// Storage exists. No Widget object exists.\n\nWidget* w = new (buffer) Widget(\"test\");\n// Constructor has run. Widget object now exists.\n\nw->~Widget();\n// Destructor has run. Widget object no longer exists.\n// Storage still exists.\n```\n\nBetween placement new and the explicit destructor call, the `Widget` object is alive. Before placement new and after the destructor, the bytes in `buffer` exist but no `Widget` does. Accessing `w->name` after the destructor call is undefined behavior. The bytes are there. The object is not.\n\nThe C++ standard (N4950, Â§6.7.3) states:\n\n> The lifetime of an object of type T begins when: (1.1) storage with the proper alignment and size for type T is obtained, and (1.2) its initialization (if any) is complete.\n\n> The lifetime of an object of type T ends when: (1.3) if T is a non-class type, the object is destroyed, or (1.4) if T is a class type, the destructor call starts.\n\nFor trivial types (no user-defined constructor, no destructor, no virtual functions), C++ behaves like C. For class types with nontrivial constructors or destructors, the distinction matters.\n\nThe dangling reference problem persists:\n\n```cpp\nint& dangling() {\n    int x = 42;\n    return x;\n}\n```\n\nThis compiles. A good compiler warns. The standard does not require rejection.\n\n### Rust: Lifetimes as Named Regions\n\nRust prevents dangling references through compile-time analysis. The equivalent code does not compile:\n\n```rust\nfn dangling() -> &i32 {\n    let x = 42;\n    &x\n}\n```\n\nThe compiler rejects this:\n\n```\nerror[E0106]: missing lifetime specifier\n --> src/lib.rs:1:18\n  |\n1 | fn dangling() -> &i32 {\n  |                  ^ expected named lifetime parameter\n```\n\nWe cannot return a reference without specifying its lifetime. If we try to add one:\n\n```rust\nfn dangling\u003C'a>() -> &'a i32 {\n    let x = 42;\n    &x\n}\n```\n\n```\nerror[E0515]: cannot return reference to local variable `x`\n --> src/lib.rs:3:5\n  |\n3 |     &x\n  |     ^^ returns a reference to data owned by the current function\n```\n\nThe compiler determines that `x` does not live long enough to satisfy the lifetime `'a`. How does it know this? The answer lies in *region inference*.\n\n### Regions and the Control-Flow Graph\n\nA lifetime in Rust is a *region*: a set of points in the control-flow graph where a reference must be valid. The borrow checker computes these regions through constraint propagation.\n\nConsider this code:\n\n```rust\nlet x = 0;\nlet y = &x;\nlet z = &y;\n```\n\nEach `let` binding introduces an implicit scope. The borrow checker infers the minimal region for each reference. Desugared (using notation that is not valid Rust syntax, but illustrates the structure):\n\n```rust\n'a: {\n    let x: i32 = 0;\n    'b: {\n        let y: &'b i32 = &'b x;\n        'c: {\n            let z: &'c &'b i32 = &'c y;\n        }\n    }\n}\n```\n\nThe reference `y` has lifetime `'b` because that is the smallest region that covers its usage. The reference `z` has lifetime `'c`. The borrow checker minimizes lifetimes to the extent necessary.\n\nWhen a reference is passed to an outer scope, the borrow checker infers a larger lifetime:\n\n```rust\nlet x = 0;\nlet z;\nlet y = &x;\nz = y;\n```\n\nDesugared:\n\n```rust\n'a: {\n    let x: i32 = 0;\n    'b: {\n        let z: &'b i32;\n        'c: {\n            let y: &'b i32 = &'b x;  // must use 'b, not 'c\n            z = y;\n        }\n    }\n}\n```\n\nBecause `y` is assigned to `z`, and `z` lives in scope `'b`, the reference must be valid for `'b`. The borrow checker propagates this requirement.\n\n### Region Inference in rustc\n\nThe borrow checker operates on MIR (Mid-level Intermediate Representation), a simplified form of Rust code. The process has two phases:\n\n**Phase 1: `replace_regions_in_mir`**\n\nThe compiler identifies *universal regions* (those appearing in the function signature, such as `'a` in `fn foo\u003C'a>(x: &'a u32)`) and replaces all other regions with fresh inference variables. Universal regions are *free* in the function body. They represent constraints from the caller.\n\n**Phase 2: `compute_regions`**\n\nThe compiler runs a type checker on MIR to collect constraints between regions. It then performs constraint propagation to compute the value of each inference variable.\n\nA region's value is a set. The set contains:\n\n1. **Locations in the MIR control-flow graph**: Each location is a pair (basic block, statement index). This identifies the point on entry to that statement.\n\n2. **End markers for universal regions**: If region `'a` outlives region `'b`, then `end('b)` is in the set for `'a`. The element `end('b)` represents the portion of the caller's control-flow graph after the current function returns.\n\n3. **`end('static)`**: Represents program execution after the function returns, extending to program termination.\n\nThe two main constraint types are:\n\n**Outlives constraints**: If `'a: 'b` (region `'a` outlives region `'b`), all elements of `'b` plus `end('b)` must be added to `'a`.\n\n**Liveness constraints**: A region must contain all points where it can be used.\n\n### Constraint Propagation\n\nConsider this function:\n\n```rust\nfn bad\u003C'a, 'b>(x: &'a usize) -> &'b usize {\n    x\n}\n```\n\nThis should not compile. We have no guarantee that `'a` outlives `'b`. If `'a` is shorter than `'b`, the return value would be a dangling reference.\n\nThe compiler introduces inference variables. Let `'#1` correspond to `'a`, `'#3` correspond to `'b`, and `'#2` correspond to the expression `x`. Let L1 be the location of `x`.\n\nInitial state from liveness constraints:\n\n| Region | Contents |\n|--------|----------|\n| '#1    | (empty)  |\n| '#2    | L1       |\n| '#3    | L1       |\n\nThe return statement creates an outlives constraint `'#2: '#3` (the returned reference must outlive the return type's region). Propagating:\n\n| Region | Contents |\n|--------|----------|\n| '#1    | L1       |\n| '#2    | L1, end('#3) |\n| '#3    | L1       |\n\nThe parameter creates an outlives constraint `'#1: '#2` (the input flows to the expression). Propagating:\n\n| Region | Contents |\n|--------|----------|\n| '#1    | L1, end('#2), end('#3) |\n| '#2    | L1, end('#3) |\n| '#3    | L1       |\n\nNow the compiler checks: does `'#1` contain any `end('x)` that is not justified by a where clause or implied bound? Yes. `'#1` contains `end('#3)`, but we have no `where` clause stating `'a: 'b`. This is an error.\n\nThe `RegionInferenceContext` in rustc stores:\n\n- `constraints`: all outlives constraints\n- `liveness_constraints`: all liveness constraints  \n- `universal_regions`: the set of regions from the function signature\n- `universal_region_relations`: known relationships between universal regions (from where clauses)\n\nThe `solve` method performs propagation, then `check_universal_regions` verifies that no universal region grew to contain `end` markers it cannot justify.\n\n### Non-Lexical Lifetimes\n\nBefore Rust 2018, lifetimes were lexical: a reference was live until the end of its lexical scope. This rejected valid programs:\n\n```rust\nlet mut data = vec![1, 2, 3];\nlet x = &data[0];\nprintln!(\"{}\", x);\ndata.push(4);  // error in old Rust: x still in scope\n```\n\nWith lexical lifetimes, `x` would be considered live until the closing brace, conflicting with the mutable borrow for `push`.\n\nNon-lexical lifetimes (NLL) compute liveness from the control-flow graph. A reference is live from its creation to its last use, not to the end of its scope:\n\n```rust\nlet mut data = vec![1, 2, 3];\nlet x = &data[0];\nprintln!(\"{}\", x);  // last use of x\ndata.push(4);       // ok: x is no longer live\n```\n\nThe borrow of `data` for `x` extends to the `println!` call. After that, the borrow ends. The mutable borrow for `push` does not conflict.\n\nThere are subtleties. If a type has a destructor, the destructor counts as a use. The destructor runs at scope end, extending the lifetime:\n\n```rust\nstruct Wrapper\u003C'a>(&'a i32);\n\nimpl Drop for Wrapper\u003C'_> {\n    fn drop(&mut self) { }\n}\n\nlet mut data = vec![1, 2, 3];\nlet x = Wrapper(&data[0]);\nprintln!(\"{:?}\", x);\ndata.push(4);  // error: destructor of x runs at scope end\n```\n\nThe `Drop` impl means `x` is used at scope end. The borrow extends to that point, conflicting with `push`. To fix this, we can call `drop(x)` explicitly before `push`.\n\nLifetimes can have holes. A variable can be reborrowed:\n\n```rust\nlet mut data = vec![1, 2, 3];\nlet mut x = &data[0];\n\nprintln!(\"{}\", x);  // last use of first borrow\ndata.push(4);       // ok: first borrow ended\nx = &data[3];       // new borrow starts\nprintln!(\"{}\", x);\n```\n\nThe borrow checker sees two distinct borrows tied to the same variable. The first ends after the first `println!`. The second starts at the reassignment.\n\nControl flow matters. Different branches can have different last uses:\n\n```rust\nfn condition() -> bool { true }\n\nlet mut data = vec![1, 2, 3];\nlet x = &data[0];\n\nif condition() {\n    println!(\"{}\", x);  // last use in this branch\n    data.push(4);       // ok\n} else {\n    data.push(5);       // ok: x not used in this branch\n}\n```\n\nIn the `if` branch, `x` is used before `push`. In the `else` branch, `x` is never used, so the borrow effectively ends at `x`'s creation.\n\n### Lifetimes Across Function Boundaries\n\nWithin a function, the borrow checker has complete information. It knows every use of every reference. Across function boundaries, this information is lost. Function signatures must declare the relationships between input and output lifetimes.\n\n```rust\nfn first_word(s: &str) -> &str {\n    // returns a slice of the input\n}\n```\n\nThe signature says: the output lifetime equals the input lifetime. The returned slice borrows from `s`. Callers cannot use the returned slice after `s` is invalidated.\n\nWhen signatures are ambiguous, the compiler requires explicit annotation:\n\n```rust\nfn longest(x: &str, y: &str) -> &str {\n    if x.len() > y.len() { x } else { y }\n}\n```\n\nThis does not compile. The return could come from `x` or `y`. The compiler does not know which. We must tell it:\n\n```rust\nfn longest\u003C'a>(x: &'a str, y: &'a str) -> &'a str {\n    if x.len() > y.len() { x } else { y }\n}\n```\n\nThe signature now says: both inputs must be valid for at least `'a`, and the output is valid for `'a`. Callers must ensure both inputs outlive the result.\n\n### Lifetime Elision\n\nCommon patterns do not require explicit annotation. Elision rules infer lifetimes:\n\n**Rule 1**: Each input reference gets its own lifetime.\n\n```rust\nfn f(x: &i32, y: &i32)\n// becomes\nfn f\u003C'a, 'b>(x: &'a i32, y: &'b i32)\n```\n\n**Rule 2**: If there is exactly one input lifetime, it is assigned to all outputs.\n\n```rust\nfn f(x: &i32) -> &i32\n// becomes\nfn f\u003C'a>(x: &'a i32) -> &'a i32\n```\n\n**Rule 3**: If one input is `&self` or `&mut self`, its lifetime is assigned to all outputs.\n\n```rust\nimpl Foo {\n    fn method(&self, x: &i32) -> &i32\n    // becomes\n    fn method\u003C'a, 'b>(&'a self, x: &'b i32) -> &'a i32\n}\n```\n\nWhen elision rules do not determine all lifetimes, explicit annotation is required.\n\n### `'static`\n\nThe lifetime `'static` means valid for the entire program. String literals have type `&'static str` because they are stored in the binary's read-only data segment:\n\n```rust\nlet s: &'static str = \"hello\";\n```\n\nThe bound `T: 'static` means *T contains no non-static references*. This is required for spawning threads, since the spawned thread may outlive the current stack frame:\n\n```rust\nfn spawn\u003CF>(f: F) where F: FnOnce() + Send + 'static\n```\n\nA closure that captures `&x` where `x` is a local variable does not satisfy `'static`. The reference would dangle when the spawning function returns.\n\n## Uninitialized Memory\n\nAll runtime-allocated memory begins as uninitialized. The bytes exist but contain whatever values were left there by previous use. The question is: what happens when we read those bytes before writing to them?\n\nC says the value is *indeterminate*. C++ adds the concept of *vacuous initialization*. Rust says reading uninitialized memory is undefined behavior, full stop, and provides `MaybeUninit\u003CT>` as the controlled mechanism for working with such memory.\n\n### C: Indeterminate Values\n\nIn C, reading an uninitialized automatic variable produces an *indeterminate value*. The C23 standard distinguishes this from a *non-value representation* (previously called *trap representation*), which is a bit pattern that does not correspond to any valid value of the type.\n\n```c\nvoid example(void) {\n    int x;\n    printf(\"%d\\n\", x);  // indeterminate value\n}\n```\n\nWhat happens here? The standard does not say the program crashes. It does not say the program continues with some arbitrary value. It says the behavior is undefined. The compiler is permitted to assume this code never executes.\n\nThe distinction between indeterminate values and non-value representations matters for types where not all bit patterns are valid. The `bool` type has only two valid values: 0 (`false`) and 1 (`true`). A `bool` occupies at least 8 bits. Setting other bits produces a non-value representation:\n\n```c\nbool b;\nmemset(&b, 0xFF, sizeof(b));  // all bits set\nif (b) { /* ... */ }          // undefined behavior\n```\n\nThe compiler may test for zero, or it may test the least significant bit. Different optimization levels may produce different results. The behavior is not merely unspecified (implementation-defined but consistent); it is undefined (the compiler may assume it cannot happen).\n\nFor types without non-value representations (most integer types on modern hardware), reading an indeterminate value is still undefined behavior because the compiler cannot reason about what value it will see. The optimizer may propagate contradictory assumptions through the program.\n\n### C++: Vacuous Initialization and Implicit Object Creation\n\nC++ inherits C's rules for scalar types but adds complexity for class types. A variable has *vacuous initialization* if it is default-initialized and its class type has a trivial default constructor.\n\n```cpp\nstruct Trivial {\n    int x;\n    int y;\n};\n\nvoid example() {\n    Trivial t;  // vacuous initialization: x and y are indeterminate\n}\n```\n\nThe object `t` exists. Its lifetime has begun. But its members `x` and `y` contain indeterminate values. Reading them is undefined behavior, just as in C.\n\nFor class types with nontrivial constructors, default initialization runs the constructor:\n\n```cpp\nstruct Nontrivial {\n    int x;\n    Nontrivial() : x(0) { }\n};\n\nvoid example() {\n    Nontrivial n;  // constructor runs, x is 0\n}\n```\n\nC++20 introduced *implicit object creation*. Certain operations (allocation functions, `memmove`, `memcpy`, creation of `unsigned char` or `std::byte` arrays) implicitly create objects of *implicit-lifetime types* within their storage region. This retroactively makes some previously-undefined patterns well-defined:\n\n```cpp\nstruct X { int a, b; };\n\nX* make_x() {\n    X* p = (X*)std::malloc(sizeof(struct X));\n    p->a = 1;  // pre-C++20: UB (no X object exists)\n    p->b = 2;  // C++20: ok (X implicitly created)\n    return p;\n}\n```\n\nThe C++ standard (N4950, Â§6.7.2) specifies that `malloc` implicitly creates objects of implicit-lifetime types if doing so would give the program defined behavior. This was a pragmatic fix for code that had been written for decades under the assumption that `malloc` plus assignment creates an object.\n\n### Rust: Immediate Undefined Behavior\n\nRust takes the strictest position. Reading uninitialized memory is undefined behavior at the point of the read, regardless of type. The Rust Reference lists this explicitly:\n\n> An integer (`i*`/`u*`), floating point value (`f*`), or raw pointer must be initialized, i.e., must not be obtained from uninitialized memory.\n\nThis applies even to `u8`, which has no invalid bit patterns. The reasoning is that the compiler must be able to assume all values are initialized. Without this guarantee, the optimizer cannot propagate values, eliminate dead stores, or make any assumptions about the contents of memory.\n\nRust enforces this at compile time for safe code through definite initialization analysis:\n\n```rust\nfn example() {\n    let x: i32;\n    println!(\"{}\", x);  // error: use of possibly uninitialized `x`\n}\n```\n\nThe analysis tracks initialization state through control flow:\n\n```rust\nfn example(condition: bool) {\n    let x: i32;\n    if condition {\n        x = 1;\n    }\n    println!(\"{}\", x);  // error: `x` is possibly uninitialized\n}\n```\n\nEven though the `if` branch initializes `x`, the `else` branch does not. The compiler rejects the program.\n\nThe analysis understands control flow but not values:\n\n```rust\nfn example() {\n    let x: i32;\n    if true {\n        x = 1;\n    }\n    println!(\"{}\", x);  // error: compiler doesn't evaluate `true`\n}\n```\n\nThe compiler does not evaluate `true` at analysis time. It sees a conditional with only one branch that initializes `x`. The program is rejected.\n\nLoops require care:\n\n```rust\nfn example() {\n    let x: i32;\n    loop {\n        if true {\n            x = 0;\n            break;\n        }\n    }\n    println!(\"{}\", x);  // ok: compiler knows break is reached\n}\n```\n\nThe compiler understands that execution cannot reach `println!` without passing through the `break`, and the `break` is preceded by initialization. The program compiles.\n\n### Move Semantics and Uninitialization\n\nIn Rust, moving a value out of a variable leaves that variable logically uninitialized:\n\n```rust\nfn example() {\n    let x = Box::new(42);\n    let y = x;           // x is moved, now logically uninitialized\n    println!(\"{}\", x);   // error: use of moved value\n}\n```\n\nFor `Copy` types, this does not apply. The value is copied, and both variables remain initialized:\n\n```rust\nfn example() {\n    let x: i32 = 42;\n    let y = x;           // copy, not move\n    println!(\"{}\", x);   // ok: x is still initialized\n}\n```\n\nA variable can be reinitialized after being moved from:\n\n```rust\nfn example() {\n    let mut x = Box::new(42);\n    let y = x;           // x is moved\n    x = Box::new(43);    // x is reinitialized\n    println!(\"{}\", x);   // ok\n}\n```\n\nThe `mut` is required because the compiler considers reinitialization to be mutation.\n\n### `MaybeUninit\u003CT>`: The Escape Hatch\n\nWhen performance requires working with uninitialized memory, Rust provides `MaybeUninit\u003CT>`. This is a union type that can hold either an initialized `T` or uninitialized bytes:\n\n```rust\nuse std::mem::MaybeUninit;\n\nlet x: MaybeUninit\u003Ci32> = MaybeUninit::uninit();\n```\n\nThe key property: dropping a `MaybeUninit\u003CT>` does nothing. It does not run `T`'s destructor. This is essential because the value might not be initialized, and dropping an uninitialized value would be undefined behavior.\n\nTo initialize, we write to the `MaybeUninit`:\n\n```rust\nlet mut x: MaybeUninit\u003Ci32> = MaybeUninit::uninit();\nx.write(42);  // now initialized\n```\n\nTo extract the initialized value, we call `assume_init`:\n\n```rust\nlet mut x: MaybeUninit\u003Ci32> = MaybeUninit::uninit();\nx.write(42);\nlet value: i32 = unsafe { x.assume_init() };\n```\n\nThe `assume_init` call is `unsafe` because the compiler cannot verify that we actually initialized the value. We are asserting to the compiler: *trust me, it is initialized*. If we lied, behavior is undefined.\n\n### Array Initialization\n\nSafe Rust does not permit partial array initialization. We must initialize all elements at once:\n\n```rust\nlet arr: [i32; 4] = [1, 2, 3, 4];       // ok\nlet arr: [i32; 1000] = [0; 1000];       // ok, all zeros\n```\n\nFor dynamic initialization, `MaybeUninit` provides a path:\n\n```rust\nuse std::mem::{self, MaybeUninit};\n\nconst SIZE: usize = 10;\n\nlet arr: [Box\u003Cu32>; SIZE] = {\n    // Create array of uninitialized MaybeUninit\n    let mut arr: [MaybeUninit\u003CBox\u003Cu32>>; SIZE] = \n        [const { MaybeUninit::uninit() }; SIZE];\n    \n    // Initialize each element\n    for i in 0..SIZE {\n        arr[i] = MaybeUninit::new(Box::new(i as u32));\n    }\n    \n    // Transmute to initialized type\n    unsafe { mem::transmute::\u003C_, [Box\u003Cu32>; SIZE]>(arr) }\n};\n```\n\nThe transmute is sound because `MaybeUninit\u003CT>` has the same layout as `T`. We initialized every element, so the array now contains valid `Box\u003Cu32>` values.\n\nA critical detail: the assignment `arr[i] = MaybeUninit::new(...)` does not drop the old value. `MaybeUninit\u003CT>` has no `Drop` implementation. If we had written to a regular `Box\u003Cu32>` array, the assignment would drop the old value, which would be undefined behavior for uninitialized memory.\n\n### Raw Pointer Writes\n\nWhen `MaybeUninit::new` is not suitable, we use raw pointer operations. The `ptr` module provides:\n\n- `ptr::write(ptr, val)`: Writes `val` to `ptr` without reading or dropping the old value\n- `ptr::copy(src, dest, count)`: Copies `count` elements from `src` to `dest` (like `memmove`)\n- `ptr::copy_nonoverlapping(src, dest, count)`: Like `copy`, but assumes no overlap (like `memcpy`)\n\nThese functions do not drop the destination. They overwrite the bytes. This is correct for uninitialized memory but dangerous for initialized memory containing values with destructors.\n\n```rust\nuse std::ptr;\n\nlet mut x: MaybeUninit\u003CString> = MaybeUninit::uninit();\nunsafe {\n    ptr::write(x.as_mut_ptr(), String::from(\"hello\"));\n}\nlet s = unsafe { x.assume_init() };\n```\n\nWe cannot use `&mut` to get a reference to the uninitialized `String` because creating a reference to an invalid value is undefined behavior. The `as_mut_ptr` method returns a raw pointer without creating a reference.\n\nFor struct fields, we use raw reference syntax to avoid creating intermediate references:\n\n```rust\nuse std::{ptr, mem::MaybeUninit};\n\nstruct Demo {\n    field: bool,\n}\n\nlet mut uninit = MaybeUninit::\u003CDemo>::uninit();\nlet field_ptr = unsafe { &raw mut (*uninit.as_mut_ptr()).field };\nunsafe { field_ptr.write(true); }\nlet demo = unsafe { uninit.assume_init() };\n```\n\nThe `&raw mut` syntax creates a raw pointer without creating a reference. This is important because `&mut (*uninit.as_mut_ptr()).field` would create a reference to an uninitialized `bool`, which is undefined behavior.\n\n### The Vec Pattern\n\nThe most common use of uninitialized memory in Rust is building collections. `Vec\u003CT>` internally uses `MaybeUninit` (via `RawVec`) to manage its buffer. When we call `vec.reserve(n)`, the vector allocates space for `n` additional elements without initializing them.\n\nA performance pattern for filling a vector from an external source:\n\n```rust\nfn read_into_vec(src: &[u8], count: usize) -> Vec\u003Cu8> {\n    let mut v: Vec\u003Cu8> = Vec::with_capacity(count);\n    \n    unsafe {\n        // Get raw pointer to uninitialized buffer\n        let ptr = v.as_mut_ptr();\n        \n        // Copy from source (assumes src.len() >= count)\n        std::ptr::copy_nonoverlapping(src.as_ptr(), ptr, count);\n        \n        // Tell Vec the elements are now initialized\n        v.set_len(count);\n    }\n    \n    v\n}\n```\n\nThe `set_len` call is `unsafe` because we are asserting that the first `count` elements are initialized. The vector trusts us. If we lie, dropping the vector will attempt to drop uninitialized values, which is undefined behavior for types with destructors.\n\nFor `u8`, there is no destructor, so the immediate danger is reading garbage. But the compiler may still optimize based on the assumption that all values are initialized.\n\nThe safe alternative uses `resize` or `extend`:\n\n```rust\nfn read_into_vec_safe(src: &[u8], count: usize) -> Vec\u003Cu8> {\n    let mut v: Vec\u003Cu8> = Vec::with_capacity(count);\n    v.extend_from_slice(&src[..count]);\n    v\n}\n```\n\nThis initializes each element as it is added. For large buffers, the unsafe version can be measurably faster because it avoids redundant initialization. Whether the speedup matters depends on the workload.\n\n### The Deprecated `mem::uninitialized`\n\nOlder Rust code uses `mem::uninitialized::\u003CT>()` to create uninitialized values. This function is deprecated and should not be used in new code. The problem is that it returns a `T`, which means the caller receives an *initialized* value of type `T` that actually contains garbage:\n\n```rust\n// DON'T DO THIS\nlet x: bool = unsafe { std::mem::uninitialized() };\n// x is now an \"initialized\" bool with garbage bits\n// Any use of x is undefined behavior\n```\n\nThe compiler believes `x` is initialized. It may propagate this \"value\" through the program. The result is unpredictable.\n\n`MaybeUninit` solves this by wrapping the uninitialized state in a type that the compiler understands. The value inside is not accessible until we call `assume_init`. This prevents the compiler from making false assumptions about initialization state.\n\n## Aliasing\n\nTwo pointers *alias* when they refer to overlapping regions of memory. This matters because aliasing constrains what the compiler can optimize. If the compiler cannot prove that two pointers refer to different memory, it must assume that a write through one may affect a read through the other. This forces conservative code generation: values must be reloaded from memory instead of kept in registers, stores cannot be reordered, and entire classes of optimization become impossible.\n\nAliasing rules exist for optimization, not for safety. C and C++ have aliasing rules that, when violated, result in undefined behavior. The compiler is not checking these rules to protect the programmer. It is assuming the programmer follows them, and optimizing accordingly. Violate the assumption and the optimizer generates incorrect code.\n\nRust makes the aliasing rule explicit and compiler-checked. The `&T`/`&mut T` distinction encodes a simple invariant: you can have many shared references or one mutable reference, but never both simultaneously. The borrow checker enforces this at compile time.\n\n### Why the Compiler Cares\n\nConsider this function:\n\n```rust\nfn compute(input: &u32, output: &mut u32) {\n    if *input > 10 {\n        *output = 1;\n    }\n    if *input > 5 {\n        *output *= 2;\n    }\n}\n```\n\nWe would like the compiler to optimize this to:\n\n```rust\nfn compute(input: &u32, output: &mut u32) {\n    let cached_input = *input;\n    if cached_input > 10 {\n        *output = 2;\n    } else if cached_input > 5 {\n        *output *= 2;\n    }\n}\n```\n\nThe optimization caches `*input` in a register and eliminates the redundant read in the second condition. It also recognizes that if `*input > 10`, the final value will always be 2 (set to 1, then doubled), so it writes 2 directly.\n\nThis optimization is only valid if `input` and `output` do not alias. If they point to the same memory, the write `*output = 1` changes what `*input` reads:\n\n```rust\nlet mut x: u32 = 20;\ncompute(&x, &mut x);  // input and output both point to x\n```\n\nWith aliasing, the original function produces 1:\n- `*input` is 20, so `*output = 1` (now `x` is 1)\n- `*input` is 1, so the second condition is false\n- Result: 1\n\nThe optimized function produces 2:\n- `cached_input` is 20, so `*output = 2`\n- Result: 2\n\nIn Rust, the call `compute(&x, &mut x)` is rejected at compile time. The borrow checker sees an attempt to create both a shared reference and a mutable reference to `x` simultaneously. The program does not compile.\n\nIn C, the equivalent code compiles and the optimizer may generate the wrong result.\n\n### C: Type-Based Alias Analysis\n\nThe C standard specifies the *effective type* rule. An object must be accessed through its effective type or through a character type. Accessing an object through a pointer of incompatible type is undefined behavior.\n\n```c\nint x = 42;\nfloat* fp = (float*)&x;\nfloat f = *fp;  // undefined behavior: accessing int through float*\n```\n\nThis is often called *strict aliasing*. The compiler assumes that pointers of different types do not alias. An `int*` and a `float*` cannot point to the same object (with narrow exceptions for character types and unions). This assumption enables *Type-Based Alias Analysis* (TBAA): the compiler tracks pointer types and assumes incompatible types refer to disjoint memory.\n\nConsider:\n\n```c\nvoid update(int* pi, float* pf) {\n    *pi = 1;\n    *pf = 2.0f;\n    printf(\"%d\\n\", *pi);\n}\n```\n\nUnder strict aliasing, the compiler may assume `pi` and `pf` do not alias. The write to `*pf` cannot affect `*pi`, so the compiler can print 1 without reloading from memory. It may even reorder the stores or keep `*pi` in a register.\n\nIf the programmer passes pointers that actually alias:\n\n```c\nunion { int i; float f; } u;\nupdate(&u.i, &u.f);  // undefined behavior\n```\n\nThe optimizer's assumption is violated. The generated code may print 1 even though the memory now contains the bit pattern of 2.0f. Or it may print something else entirely. The behavior is undefined.\n\nThe classic strict aliasing violation involves type punning without unions:\n\n```c\nuint32_t float_bits(float f) {\n    return *(uint32_t*)&f;  // undefined behavior\n}\n```\n\nThis attempts to read the bit representation of a `float` by casting its address to `uint32_t*`. The effective type of the object is `float`. Accessing it through `uint32_t*` violates the effective type rule.\n\nThe correct approach uses a union:\n\n```c\nuint32_t float_bits(float f) {\n    union { float f; uint32_t u; } converter = { .f = f };\n    return converter.u;\n}\n```\n\nOr `memcpy`:\n\n```c\nuint32_t float_bits(float f) {\n    uint32_t result;\n    memcpy(&result, &f, sizeof(result));\n    return result;\n}\n```\n\nModern compilers optimize `memcpy` of small sizes to register moves. The resulting assembly is identical to the undefined type-punning version, but the semantics are well-defined.\n\n### The `restrict` Qualifier\n\nType-based alias analysis only helps when pointer types differ. Two `int*` pointers may alias, and the compiler must assume they do unless told otherwise.\n\nC99 introduced the `restrict` qualifier. A `restrict`-qualified pointer is a promise from the programmer: during the lifetime of this pointer, no other pointer will be used to access the same memory.\n\n```c\nvoid add_arrays(int* restrict dest, const int* restrict src, size_t n) {\n    for (size_t i = 0; i \u003C n; i++) {\n        dest[i] += src[i];\n    }\n}\n```\n\nThe `restrict` qualifier tells the compiler that `dest` and `src` do not overlap. The compiler can vectorize the loop, load multiple elements of `src` at once, and store multiple elements to `dest` without worrying that a store to `dest[i]` might affect a subsequent load from `src[j]`.\n\nWithout `restrict`:\n\n```c\nvoid add_arrays(int* dest, const int* src, size_t n) {\n    for (size_t i = 0; i \u003C n; i++) {\n        dest[i] += src[i];\n    }\n}\n```\n\nThe compiler must assume `dest` and `src` might overlap. If `dest == src + 1`, each store to `dest[i]` affects the next load from `src[i+1]`. The loop cannot be vectorized. Each iteration must complete before the next begins.\n\nThe `restrict` qualifier is a promise, not a constraint. The compiler does not check it. If the programmer lies and passes overlapping pointers, the optimized code produces wrong results.\n\nStandard library functions use `restrict` extensively:\n\n```c\nvoid* memcpy(void* restrict dest, const void* restrict src, size_t n);\nvoid* memmove(void* dest, const void* src, size_t n);\n```\n\n`memcpy` promises non-overlapping regions. `memmove` handles overlap correctly but cannot be optimized as aggressively.\n\n### Rust: Shared XOR Mutable\n\nRust's aliasing model is simpler and compiler-enforced. The rule is: at any point in time, a piece of memory can have either many shared references (`&T`) or one mutable reference (`&mut T`), but not both.\n\nThis is sometimes written as *shared XOR mutable*, or *aliasing XOR mutation*. The key insight is that aliasing is only dangerous when combined with mutation. Many readers can safely read the same memory. A single writer can safely modify memory if no one else is reading. The problem arises when reads and writes can interleave unpredictably.\n\n```rust\nlet mut x = 5;\n\nlet r1 = &x;      // shared reference\nlet r2 = &x;      // another shared reference, ok\nprintln!(\"{} {}\", r1, r2);\n\nlet r3 = &mut x;  // mutable reference\n*r3 += 1;\nprintln!(\"{}\", r3);\n```\n\nThis compiles because the shared references `r1` and `r2` are no longer used after the `println!`. Their lifetimes end before the mutable reference `r3` is created.\n\n```rust\nlet mut x = 5;\n\nlet r1 = &x;\nlet r3 = &mut x;  // error: cannot borrow `x` as mutable\nprintln!(\"{}\", r1);\n```\n\nThis does not compile. The shared reference `r1` is still live when we attempt to create the mutable reference `r3`. The borrow checker rejects the program.\n\nThe Rust compiler annotates references with LLVM attributes based on this invariant. A `&T` receives `noalias` for read operations. A `&mut T` receives `noalias` unconditionally, telling LLVM that no other pointer accesses this memory for the reference's lifetime. This enables the same optimizations that C achieves through `restrict`, but the guarantee is compiler-verified rather than programmer-promised.\n\n### What the Borrow Checker Sees\n\nThe borrow checker does not understand the semantic meaning of operations. It does not know that `&data[0]` and `&data[1]` are disjoint. It sees borrows and tracks their lifetimes.\n\nConsider this code that the borrow checker rejects:\n\n```rust\nlet mut v = vec![1, 2, 3];\nlet x = &v[0];    // immutable borrow of v\nv.push(4);         // mutable borrow of v for push\nprintln!(\"{}\", x);\n```\n\nThe borrow checker sees:\n1. `&v[0]` creates a reference with lifetime `'a`\n2. The reference `x` must live until `println!`\n3. `v.push(4)` requires `&mut v`\n4. At the point of `push`, `x` is still live\n5. Conflict: cannot have `&mut v` while `&v` exists\n\nThe borrow checker does not know that `push` might reallocate the vector, invalidating `x`. It simply enforces the aliasing rule. As a consequence, it prevents the iterator invalidation bug.\n\nThe borrow checker also does not understand that `&mut v[0]` and `&mut v[1]` are disjoint:\n\n```rust\nlet mut arr = [1, 2, 3];\nlet a = &mut arr[0];\nlet b = &mut arr[1];  // error: cannot borrow `arr[_]` as mutable more than once\n```\n\nThe indexing operation `arr[i]` desugars to a method call that borrows the entire array. The borrow checker sees two mutable borrows of `arr`, not two borrows of disjoint elements.\n\n### Splitting Borrows\n\nThe borrow checker understands struct fields as disjoint:\n\n```rust\nstruct Point { x: i32, y: i32 }\n\nlet mut p = Point { x: 0, y: 0 };\nlet px = &mut p.x;\nlet py = &mut p.y;  // ok: different fields\n*px = 1;\n*py = 2;\n```\n\nThis works because the compiler knows that `p.x` and `p.y` occupy different memory. They can be borrowed mutably at the same time.\n\nFor slices and arrays, the standard library provides `split_at_mut`:\n\n```rust\nlet mut arr = [1, 2, 3, 4];\nlet (left, right) = arr.split_at_mut(2);\n// left is &mut [1, 2], right is &mut [3, 4]\nleft[0] = 10;\nright[0] = 30;\n```\n\nThe implementation of `split_at_mut` uses unsafe code:\n\n```rust\npub fn split_at_mut(&mut self, mid: usize) -> (&mut [T], &mut [T]) {\n    let len = self.len();\n    let ptr = self.as_mut_ptr();\n    \n    assert!(mid \u003C= len);\n    \n    unsafe {\n        (std::slice::from_raw_parts_mut(ptr, mid),\n         std::slice::from_raw_parts_mut(ptr.add(mid), len - mid))\n    }\n}\n```\n\nThe unsafe block constructs two mutable slices from raw pointers. The programmer asserts that the slices do not overlap. The safe interface guarantees this by construction: the slices cover `[0, mid)` and `[mid, len)`. This is a very _Rusty_ pattern, we are building safe abstractions over unsafe primitives. Users of `split_at_mut` cannot violate the aliasing rules. The borrow checker verifies that the two returned slices are used correctly.\n\n### From Rules to Registers\n\nWe saw that aliasing information lets the compiler keep values in registers instead of reloading from memory. But the payoff extends beyond eliminating redundant loads. Consider what happens when the compiler tries to vectorize a loop.\n\n```c\nvoid scale(float* dest, const float* src, float factor, size_t n) {\n    for (size_t i = 0; i \u003C n; i++) {\n        dest[i] = src[i] * factor;\n    }\n}\n```\n\nIf `dest` and `src` might overlap, each iteration depends on the previous. A write to `dest[i]` might modify `src[i+1]`. The compiler must execute iterations sequentially:\n\n```asm\n.loop:\n    movss   xmm1, [rsi]           ; load one float from src\n    mulss   xmm1, xmm0            ; multiply by factor\n    movss   [rdi], xmm1           ; store one float to dest\n    add     rsi, 4\n    add     rdi, 4\n    dec     rcx\n    jnz     .loop\n```\n\nOne element per iteration. Almost any modern x86-64 CPU has 256-bit AVX registers that can hold eight floats. We are using 32 bits of that capacity. The other 224 bits sit idle.\n\nAdd `restrict` to promise non-overlap:\n```c\nvoid scale(float* restrict dest, const float* restrict src, float factor, size_t n) {\n    for (size_t i = 0; i \u003C n; i++) {\n        dest[i] = src[i] * factor;\n    }\n}\n```\n\nNow the compiler knows iterations are independent:\n\n```asm\n    vbroadcastss ymm0, xmm0       ; broadcast factor to all 8 lanes\n.loop:\n    vmovups ymm1, [rsi]           ; load 8 floats from src\n    vmulps  ymm1, ymm1, ymm0      ; multiply all 8\n    vmovups [rdi], ymm1           ; store 8 floats to dest\n    add     rsi, 32\n    add     rdi, 32\n    sub     rcx, 8\n    jnz     .loop\n```\n\nEight elements per iteration. For large arrays, this can approach an 8x speedup in some workloads. \n\nIn Rust, the equivalent function:\n\n```rust\nfn scale(dest: &mut [f32], src: &[f32], factor: f32) {\n    for (d, s) in dest.iter_mut().zip(src.iter()) {\n        *d = *s * factor;\n    }\n}\n```\n\nThe signature encodes the non-aliasing constraint. The borrow checker verifies at call sites that `dest` and `src` do not overlap. The compiler passes `noalias` to LLVM, and LLVM generates the same vectorized loop.\n\nIn C, `restrict` is a promise the programmer can break. In Rust, the borrow checker enforces it. The generated code is identical. The safety guarantee is not.\n\nThis is why aliasing rules exist. They are the information the optimizer needs to use the hardware effectively. C provides this through type rules and programmer annotations. Rust provides it through static analysis. The CPU does not care which language we used. It cares whether the instructions match the actual memory access patterns.\n\n---\n\nPart II will explore what happens when objects own resources that must be released: the question of *who calls free*. C leaves this to the programmer. C++ introduced RAII, binding resource lifetime to object lifetime through constructors and destructors. Rust makes RAII mandatory and tracks ownership in the type system. The aliasing rules we established here, shared XOR mutable, are the foundation that makes Rust's ownership model possible. If we allow unrestricted aliasing, we cannot reason about who may modify memory. Rust's borrow checker is, at its core, an aliasing verifier.","src/data/blog/memory-pt1.md","3622613ba0dded65",{"html":640,"metadata":641},"\u003Cp>This is the first article in a \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>n\u003C/mi>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">n\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.4306em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\">n\u003C/span>\u003C/span>\u003C/span>\u003C/span>-part series exploring how C, C++, and Rust manage memory at a low level. We begin where the hardware does: with bytes. From there, we build up to objects, storage duration, lifetime, and aliasing, the vocabulary required to understand ownership.\u003C/p>\n\u003Ch2 id=\"table-of-contents\">Table of contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#memory-is-just-bytes\">Memory Is Just Bytes\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#virtual-address-space\">Virtual Address Space\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#alignment\">Alignment\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#cache-lines-and-memory-bandwidth\">Cache Lines and Memory Bandwidth\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-allocators-view\">The Allocatorâ€™s View\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#objects-are-bytes\">Objects Are Bytes\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#from-bytes-to-objects\">From Bytes to Objects\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#c-effective-type-rules\">C: Effective Type Rules\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-object-lifetime\">C++: Object Lifetime\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-validity-invariants\">Rust: Validity Invariants\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#object-representation-vs-value\">Object Representation vs. Value\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#storage-duration\">Storage Duration\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-four-categories\">The Four Categories\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#stack\">Stack\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#heap\">Heap\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#who-calls-free\">Who Calls Free?\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#stack-allocation-in-rust\">Stack Allocation in Rust\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#object-lifetime\">Object Lifetime\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#c-lifetime-is-storage-duration\">C: Lifetime Is Storage Duration\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-lifetime-within-storage\">C++: Lifetime Within Storage\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-lifetimes-as-named-regions\">Rust: Lifetimes as Named Regions\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#regions-and-the-control-flow-graph\">Regions and the Control-Flow Graph\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#region-inference-in-rustc\">Region Inference in rustc\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#constraint-propagation\">Constraint Propagation\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#non-lexical-lifetimes\">Non-Lexical Lifetimes\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#lifetimes-across-function-boundaries\">Lifetimes Across Function Boundaries\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#lifetime-elision\">Lifetime Elision\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#static\">\u003Ccode>'static\u003C/code>\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#uninitialized-memory\">Uninitialized Memory\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#c-indeterminate-values\">C: Indeterminate Values\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-vacuous-initialization-and-implicit-object-creation\">C++: Vacuous Initialization and Implicit Object Creation\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-immediate-undefined-behavior\">Rust: Immediate Undefined Behavior\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#move-semantics-and-uninitialization\">Move Semantics and Uninitialization\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#maybeuninitt-the-escape-hatch\">\u003Ccode>MaybeUninit&#x3C;T>\u003C/code>: The Escape Hatch\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#array-initialization\">Array Initialization\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#raw-pointer-writes\">Raw Pointer Writes\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-vec-pattern\">The Vec Pattern\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-deprecated-memuninitialized\">The Deprecated \u003Ccode>mem::uninitialized\u003C/code>\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#aliasing\">Aliasing\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#why-the-compiler-cares\">Why the Compiler Cares\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-type-based-alias-analysis\">C: Type-Based Alias Analysis\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-restrict-qualifier\">The \u003Ccode>restrict\u003C/code> Qualifier\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-shared-xor-mutable\">Rust: Shared XOR Mutable\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#what-the-borrow-checker-sees\">What the Borrow Checker Sees\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#splitting-borrows\">Splitting Borrows\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#from-rules-to-registers\">From Rules to Registers\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch2 id=\"memory-is-just-bytes\">Memory Is Just Bytes\u003C/h2>\n\u003Cp>A 64-bit processor sees memory as a flat array of \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmsup>\u003Cmn>2\u003C/mn>\u003Cmn>64\u003C/mn>\u003C/msup>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">2^{64}\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:0.8141em;\">\u003C/span>\u003Cspan class=\"mord\">\u003Cspan class=\"mord\">2\u003C/span>\u003Cspan class=\"msupsub\">\u003Cspan class=\"vlist-t\">\u003Cspan class=\"vlist-r\">\u003Cspan class=\"vlist\" style=\"height:0.8141em;\">\u003Cspan style=\"top:-3.063em;margin-right:0.05em;\">\u003Cspan class=\"pstrut\" style=\"height:2.7em;\">\u003C/span>\u003Cspan class=\"sizing reset-size6 size3 mtight\">\u003Cspan class=\"mord mtight\">\u003Cspan class=\"mord mtight\">64\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span>\u003C/span> addressable bytes. It does not know what a \u003Ccode>struct\u003C/code> is. It does not know what an \u003Ccode>int\u003C/code> is. When we execute \u003Ccode>mov rax, [rbx]\u003C/code>, the CPU fetches 8 bytes starting at the address in \u003Ccode>rbx\u003C/code>, shoves them into \u003Ccode>rax\u003C/code>, and moves on. The semantic meaning of those bytes, whether they represent a pointer, a floating-point number, or part of a UTF-8 string, exists only in our source code and the instructions we generate.\u003C/p>\n\u003Cp>The machinery we build atop this substrate, effective types in C, object lifetime in C++, validity invariants in Rust, exists to help compilers reason about what the hardware cannot see. These abstractions enable optimization: if the compiler knows two pointers cannot alias, it keeps values in registers instead of reloading from memory. If it knows a reference is never null, it elides null checks. If it knows an objectâ€™s lifetime has ended, it reuses the storage.\u003C/p>\n\u003Ch3 id=\"virtual-address-space\">Virtual Address Space\u003C/h3>\n\u003Cp>Modern operating systems do not give processes direct access to physical RAM. Instead, each process operates within its own virtual address space, a fiction maintained by the MMU (Memory Management Unit) that maps virtual addresses to physical frames. The C standard captures this abstraction explicitly: pointers in C reference virtual memory, and the language makes no guarantees about physical layout.\u003C/p>\n\u003Cp>This abstraction buys us two properties:\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Isolation\u003C/strong>: A pointer in process A cannot reference memory in process B. Dereferencing an unmapped address triggers a page fault, typically terminating the process. This is crucial for process-level security, a compromised or buggy process cannot read credentials from our browser or corrupt our kernelâ€™s data structures.\u003C/li>\n\u003Cli>\u003Cstrong>Portability\u003C/strong>: Code does not need to know the physical memory topology of the machine it runs on.\u003C/li>\n\u003C/ol>\n\u003Cp>From our perspective, virtual memory means that the addresses we work with are translated by hardware before reaching DRAM. This translation has performance implications. TLB misses are expensive, but the abstraction holds: we operate on a contiguous address space that the OS manages for us.\u003C/p>\n\u003Ch3 id=\"alignment\">Alignment\u003C/h3>\n\u003Cp>Not all byte addresses are equal. On x86-64, loading a \u003Ccode>uint64_t\u003C/code> from an address that is not divisible by 8 incurs a penalty. On stricter architectures like ARM (without unaligned access support) or older SPARC, it causes a hardware trap.\u003C/p>\n\u003Cp>The reason is mechanical. DRAM is accessed in aligned chunks. When the CPU requests data at address \u003Ccode>0x1003\u003C/code>, but the memory bus fetches 8-byte-aligned blocks, the memory controller must fetch two blocks (\u003Ccode>0x1000-0x1007\u003C/code> and \u003Ccode>0x1008-0x100F\u003C/code>), extract the relevant bytes, and reassemble them. This costs cycles.\u003C/p>\n\u003Cp>The C standard formalizes this through the concept of alignment:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">include\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">stdalign.h\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">include\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">stdio.h\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">alignof(int) = \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%zu\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lignof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           // typically 4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">alignof(double) = \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%zu\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lignof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // typically 8\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">alignof(max_align_t) = \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%zu\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lignof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">max_align_t\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> // typically 16\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>alignof\u003C/code> operator (C11/C23) returns the required alignment for a type. Accessing an object at an address that violates its alignment is undefined behavior, not because the standard is being pedantic, but because the hardware cannot reliably execute it.\u003C/p>\n\u003Cp>Consider this concrete failure case from \u003Ca href=\"https://gustedt.gitlabpages.inria.fr/modern-c/\">Modern C\u003C/a>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">union\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    complex \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> val\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} overlay;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// complex double typically requires 16-byte alignment (sizeof is 16)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">complex \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (complex \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">overlay.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // misaligned\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1.0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2.0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">I;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On x86-64 with alignment checking enabled, or on ARM, this crashes with a bus error. The pointer arithmetic is legal C, but the resulting address violates the alignment requirement of \u003Ccode>complex double\u003C/code>. The hardware refuses.\u003C/p>\n\u003Ch3 id=\"cache-lines-and-memory-bandwidth\">Cache Lines and Memory Bandwidth\u003C/h3>\n\u003Cp>Alignment interacts with another hardware reality: cache lines. On modern x86-64 processors, the L1 cache operates on 64-byte lines. When we read a single byte, the CPU actually fetches 64 bytes. If our data structures are laid out poorly, we waste bandwidth fetching bytes we never use.\u003C/p>\n\u003Cp>Worse, if a single logical datum spans two cache lines, every access requires two cache fetches. For a \u003Ccode>struct\u003C/code> that straddles a 64-byte boundary, this doubles memory traffic.\u003C/p>\n\u003Cp>This is why compilers insert padding between struct fields. Consider:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Bad {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 7 bytes padding\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">   // 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> c;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 7 bytes padding (to align the whole struct)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Good {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">   // 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> c;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 1 byte\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 6 bytes padding\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>sizeof(struct Bad)\u003C/code> is 24 bytes. \u003Ccode>sizeof(struct Good)\u003C/code> is 16 bytes. the compiler cannot reorder fields in C (the standard guarantees fields appear in declaration order with increasing addresses), so the programmer must consider layout.\u003C/p>\n\u003Cp>\u003Cimg src=\"/memory/fig1.png\" alt=\"\">\u003C/p>\n\u003Cp align=\"center\">\u003Cem>Yes, it's made with Gemini. I'm not good with Figma.\u003C/em>\u003C/p>\n\u003Ch3 id=\"the-allocators-view\">The Allocatorâ€™s View\u003C/h3>\n\u003Cp>When we call \u003Ccode>malloc(n)\u003C/code>, we do not receive exactly \u003Ccode>n\u003C/code> bytes of usable memory. The allocator maintains metadata like chunk headers, size fields, and free-list pointers that live adjacent to our allocation. In glibcâ€™s ptmalloc2, an allocated chunk looks roughly like this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>| prev_size        |  (8 bytes, used only if previous chunk is free)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>| size       |N|M|P|  (8 bytes, includes flags in low 3 bits)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>| user data...     |  &#x3C;- pointer returned by malloc\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>|                  |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+------------------+\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>size\u003C/code> field stores the chunk size with three flag bits: \u003Ccode>P\u003C/code> (previous chunk in use), \u003Ccode>M\u003C/code> (chunk obtained via \u003Ccode>mmap\u003C/code>), and \u003Ccode>A\u003C/code> (non-main arena). The actual usable size is \u003Ccode>size &#x26; ~0x7\u003C/code>.\u003C/p>\n\u003Cp>This means:\u003C/p>\n\u003Col>\n\u003Cli>Every allocation has overhead. Small allocations suffer proportionally more: a 16-byte allocation requires at least 32 bytes of actual memory (16 bytes data + 16 bytes metadata, depending on the allocator).\u003C/li>\n\u003Cli>The allocator imposes its own alignment. \u003Ccode>malloc\u003C/code> guarantees alignment suitable for any primitive type (\u003Ccode>max_align_t\u003C/code>), which is 16 bytes on most 64-bit platforms.\u003C/li>\n\u003Cli>Memory is not \u003Cem>free\u003C/em>. The allocator tracks allocated regions, and \u003Ccode>free()\u003C/code> does not necessarily return memory to the OS, it typically returns it to a free list for reuse.\u003C/li>\n\u003C/ol>\n\u003Cp>When we discuss ownership and resource management in later sections, keep this in mind: \u003Cem>deallocating memory\u003C/em> at the language level means returning bytes to the allocator. The allocator decides when (if ever) to return pages to the operating system.\u003C/p>\n\u003Ch3 id=\"objects-are-bytes\">Objects Are Bytes\u003C/h3>\n\u003Cp>The C standard makes this explicit: every object can be viewed as an array of \u003Ccode>unsigned char\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bytes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">); i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%02x\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">[i])\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Output on little-endian x86-64: 2a 00 00 00\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is the object representation, the actual bytes in memory. The semantic interpretation (that these bytes represent the integer 42) is layered on top by the type system.\u003C/p>\n\u003Cp>Rust and C++ inherit this model. When we say a Rust \u003Ccode>i32\u003C/code> occupies 4 bytes with alignment 4, we mean exactly what C means: 4 contiguous bytes at an address divisible by 4. The type systems differ dramatically in what operations they permit on those bytes, but the physical representation is identical.\u003C/p>\n\u003Cp>This is the starting point. We have bytes in a virtual address space, aligned for hardware access, managed by an allocator. Everything that follows, effective types, ownership, lifetimesâ€”is a layer of abstraction over this physical reality.\u003C/p>\n\u003Ch2 id=\"from-bytes-to-objects\">From Bytes to Objects\u003C/h2>\n\u003Cp>A region of memory becomes an \u003Cem>object\u003C/em> when we impose a type interpretation on it. The type dictates how many bytes participate, what their alignment must be, and what operations are valid. But the three languages differ fundamentally in when and how this imposition occurs, and what invariants the type carries.\u003C/p>\n\u003Ch3 id=\"c-effective-type-rules\">C: Effective Type Rules\u003C/h3>\n\u003Cp>In C, the relationship between memory and type is established through the concept of \u003Cem>effective type\u003C/em>. The effective type of an object determines how it may be accessed.\u003C/p>\n\u003Cp>For declared variables, the effective type is simply the declared type:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // effective type of x is int\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The variable \u003Ccode>x\u003C/code> occupies \u003Ccode>sizeof(int)\u003C/code> bytes at some address, and those bytes must be accessed as \u003Ccode>int\u003C/code> or as \u003Ccode>unsigned char\u003C/code>. Accessing them as \u003Ccode>float*\u003C/code> is undefined behavior:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> f \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fp;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior: access through incompatible type\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is not a runtime check. The compiler does not insert code to verify the access. Instead, the rule exists to enable optimization. When the compiler sees a write through \u003Ccode>int*\u003C/code> and a read through \u003Ccode>float*\u003C/code>, the strict aliasing rule permits it to assume these pointers reference different objects. The compiler can then reorder loads and stores, keep values in registers across the write, and eliminate redundant accesses.\u003C/p>\n\u003Cp>The rule has a critical asymmetry. Any object can be viewed as an array of \u003Ccode>unsigned char\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bytes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">); i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%02x\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">[i])\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // valid: char access is always permitted\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>But the reverse is undefined:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> buffer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)buffer;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> val \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bufferâ€™s effective type is \u003Ccode>unsigned char[4]\u003C/code>. Accessing it through \u003Ccode>int*\u003C/code> violates the effective type rule. The fact that the bytes happen to form a valid \u003Ccode>int\u003C/code> representation is irrelevant. The compiler is entitled to assume this access cannot happen, and may generate code that produces garbage or crashes.\u003C/p>\n\u003Cp>For dynamically allocated memory, the situation is different. Memory returned by \u003Ccode>malloc\u003C/code> has no effective type until we write to it:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> malloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">dp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">dp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3.14\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // this write sets the effective type to double\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After this write, the allocated region has effective type \u003Ccode>double\u003C/code>. Subsequent reads through \u003Ccode>double*\u003C/code> are valid. Reading through \u003Ccode>int*\u003C/code> would again be undefined.\u003C/p>\n\u003Cp>The effective type machinery exists purely for optimization. The compiler uses it to reason about aliasing. It provides no runtime safety.\u003C/p>\n\u003Ch3 id=\"c-object-lifetime\">C++: Object Lifetime\u003C/h3>\n\u003Cp>C++ inherits Câ€™s effective type rules but adds a distinct concept: \u003Cem>object lifetime\u003C/em>. An objectâ€™s lifetime is the interval during which accessing the object is well-defined.\u003C/p>\n\u003Cp>The C++ standard (N4950, Â§6.7.3) specifies the boundaries precisely. For an object of type \u003Ccode>T\u003C/code>:\u003C/p>\n\u003Cblockquote>\n\u003Cp>The lifetime of an object of type T begins when:\n(1.1) storage with the proper alignment and size for type T is obtained, and\n(1.2) its initialization (if any) is complete\u003C/p>\n\u003C/blockquote>\n\u003Cblockquote>\n\u003Cp>The lifetime of an object of type T ends when:\n(1.3) if T is a non-class type, the object is destroyed, or\n(1.4) if T is a class type, the destructor call starts, or\n(1.5) the storage which the object occupies is released, or is reused by an object that is not nested within o.\u003C/p>\n\u003C/blockquote>\n\u003Cp>Consider placement new:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> value;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(v) { }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    ~Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() { std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">destroyed\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">alignas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> buffer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget)];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> w \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (buffer) \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // lifetime begins here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">~Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                          // lifetime ends here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// buffer still contains bytes, but no Widget object exists\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Between placement new and the destructor call, a \u003Ccode>Widget\u003C/code> object exists at that address. Before placement new and after the destructor, the bytes exist but no \u003Ccode>Widget\u003C/code> does. Accessing \u003Ccode>w->value\u003C/code> after \u003Ccode>w->~Widget()\u003C/code> is undefined behavior, even though the bytes are still there and unchanged.\u003C/p>\n\u003Cp>The destructor call does not free memory. It ends the objectâ€™s lifetime while the storage remains intact. This is what placement new and explicit destructor calls rely on: the ability to construct an object in pre-existing storage, use it, destroy it, and potentially construct a different object in the same storage.\u003C/p>\n\u003Cp>For trivial types (those without constructors, destructors, or virtual functions), C++ objects behave essentially like C objects. For class types with nontrivial special member functions, the lifetime boundaries become significant. A \u003Ccode>std::string\u003C/code> accessed after destruction will likely read freed memory or corrupted pointers, because the destructor deallocated the internal buffer.\u003C/p>\n\u003Cp>C++20 also introduced \u003Cem>implicit object creation\u003C/em>. Certain operations, such as \u003Ccode>std::malloc\u003C/code>, implicitly create objects of \u003Cem>implicit-lifetime types\u003C/em> if doing so would give the program defined behavior:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> y; };\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // implicit-lifetime type (trivial)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">malloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Point));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // in C++20, this is well-defined\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // malloc implicitly created the Point object\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This was added to retroactively make well-defined the code patterns that had been common but technically undefined.\u003C/p>\n\u003Ch3 id=\"rust-validity-invariants\">Rust: Validity Invariants\u003C/h3>\n\u003Cp>Rust imposes a stronger requirement. Every type has \u003Cem>validity invariants\u003C/em>, and producing a value that violates its typeâ€™s invariant is immediate undefined behavior. The compilerâ€™s optimizer assumes these invariants hold unconditionally.\u003C/p>\n\u003Cp>The Rust Reference defines validity per type:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A bool must be 0x00 (false) or 0x01 (true)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: invalid bool\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A reference must be non-null, aligned, and point to a valid value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: null reference\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// A char must be a valid Unicode scalar value (not a surrogate)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0xD800\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: surrogate\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// An enum must have a valid discriminant\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Status\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Active\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Inactive\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Status\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: invalid discriminant\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The never type must never exist\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zeroed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The moment an invalid value is \u003Cem>produced\u003C/em>, undefined behavior has occurred. From the Rust Reference:\u003C/p>\n\u003Cblockquote>\n\u003Cp>The Rust compiler assumes that all values produced during program execution are valid, and producing an invalid value is hence immediate UB.\u003C/p>\n\u003C/blockquote>\n\u003Cp>In C, you can have an \u003Ccode>int\u003C/code> variable containing any 32-bit pattern, and as long as you do not read it in certain ways, no UB occurs. In Rust, if a \u003Ccode>bool\u003C/code> contains the bit pattern \u003Ccode>0x02\u003C/code>, UB has already happened at the point of creation, regardless of whether you subsequently read it.\u003C/p>\n\u003Cp>Consider references. In C and C++, a pointer can be null, and dereferencing it is UB. But the pointer itself can exist and be passed around. In Rust:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">null\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// valid: raw pointer can be null\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };          \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB occurs HERE, at reference creation\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The UB does not occur when we read through the reference. It occurs when the reference is created. A \u003Ccode>&#x26;T\u003C/code> carries an invariant: non-null, properly aligned, pointing to a valid \u003Ccode>T\u003C/code>. Violating this invariant at any point is UB, regardless of what we do with the reference afterward.\u003C/p>\n\u003Cp>This strictness enables more aggressive optimization. When the compiler sees a \u003Ccode>&#x26;T\u003C/code>, it emits \u003Ccode>dereferenceable\u003C/code> and \u003Ccode>nonnull\u003C/code> annotations to LLVM. A match expression on a \u003Ccode>bool\u003C/code> need not generate a default case for values 2-255. These optimizations would be unsound if invalid values could exist.\u003C/p>\n\u003Cp>The cost is that more operations require \u003Ccode>unsafe\u003C/code>. You cannot create a reference to potentially-invalid memory, even temporarily. You must use raw pointers and convert to references only when validity is guaranteed:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> some_ffi_function\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">is_null\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">is_aligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// sound: we verified validity\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"object-representation-vs-value\">Object Representation vs. Value\u003C/h3>\n\u003Cp>All three languages distinguish between an objectâ€™s \u003Cem>representation\u003C/em> (its bytes in memory) and its \u003Cem>value\u003C/em> (the semantic interpretation of those bytes). But they draw the line differently, and understanding where each language draws it determines what low-level manipulations are sound.\u003C/p>\n\u003Cp>Every object occupies a contiguous sequence of bytes. The \u003Cem>size\u003C/em> of a type is how many bytes; the \u003Cem>alignment\u003C/em> constrains where those bytes can start. A type with alignment 8 must be stored at an address divisible by 8. These are not arbitrary constraintsâ€”they reflect how the memory bus fetches data, as we saw in the alignment section.\u003C/p>\n\u003Cp>In C, we can freely inspect any object as \u003Ccode>unsigned char[]\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> d \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3.14159\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">bytes \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">d;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// bytes[0..7] contain the IEEE 754 representation\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bytes are the representation. The value is what those bytes mean according to IEEE 754. C permits examining bytes without caring about their semantic meaning. C++ inherits this but adds constraints around object lifetimeâ€”we can inspect the bytes of a live object, but accessing bytes after the destructor has run is undefined, even if the storage has not been reused.\u003C/p>\n\u003Cp>Rust permits byte-level inspection through raw pointers and transmutation, but imposes validity constraints that C and C++ do not:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// bytes contains the little-endian representation: [42, 0, 0, 0]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Going the other direction requires care:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) };  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: 2 is not a valid bool\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The asymmetry mirrors Câ€™s effective type rule. Converting a typed value to bytes is generally safe. Converting bytes to a typed value requires that the bytes constitute a valid value of that typeâ€”and Rustâ€™s validity invariants, as we saw earlier, are stricter than Câ€™s.\u003C/p>\n\u003Cp>This distinction matters when we consider struct layout. C guarantees fields appear in declaration order; the compiler inserts padding but cannot reorder. C++ inherits this for standard-layout types. Rust makes minimal guarantees by defaultâ€”the \u003Ccode>repr(Rust)\u003C/code> layout allows the compiler to reorder fields to minimize padding. Consider:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> A\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Rust might lay this out as \u003Ccode>(b, c, a, padding)\u003C/code> to achieve size 8 instead of the naive 12. Different generic instantiations of the same struct may have different layouts. For interoperability with C, Rust provides \u003Ccode>#[repr(C)]\u003C/code>, which guarantees C-compatible layout: fields in declaration order, padding computed by the standard algorithm.\u003C/p>\n\u003Cp>The layout algorithm for \u003Ccode>repr(C)\u003C/code> is deterministic. Start with offset 0. For each field in declaration order: add padding until the offset is a multiple of the fieldâ€™s alignment, record the fieldâ€™s offset, advance by the fieldâ€™s size. Finally, round the structâ€™s total size up to its alignment. This is exactly how our \u003Ccode>struct Bad\u003C/code> ended up at 24 bytes while \u003Ccode>struct Good\u003C/code> achieved 16â€”the algorithm is mechanical, but field ordering is the programmerâ€™s responsibility.\u003C/p>\n\u003Cp>When is \u003Ccode>mem::transmute\u003C/code> sound? Size must matchâ€”the compiler enforces this. Alignment must be compatibleâ€”transmuting \u003Ccode>&#x26;u8\u003C/code> to \u003Ccode>&#x26;u64\u003C/code> is unsound even if sizes matched, because the \u003Ccode>u8\u003C/code> may not be 8-byte aligned. And validity must be preserved: the bytes must constitute a valid value of the target type. This last constraint is what Rust adds beyond C. The \u003Ccode>repr(transparent)\u003C/code> attribute creates a type with identical layout to its single non-zero-sized field, making transmutation between them sound and enabling zero-cost newtypes.\u003C/p>\n\u003Ch2 id=\"storage-duration\">Storage Duration\u003C/h2>\n\u003Cp>Every object resides somewhere in memory. The \u003Cem>storage duration\u003C/em> of an object determines when that memory is allocated and when it becomes invalid. All three languages recognize the same fundamental categories, though they use different terminology and provide different guarantees about deallocation.\u003C/p>\n\u003Ch3 id=\"the-four-categories\">The Four Categories\u003C/h3>\n\u003Cp>C defines four storage durations. C++ inherits the same four. Rust maps onto an equivalent model, though the language specification does not use identical terminology.\u003C/p>\n\u003Cp>\u003Cstrong>Static storage duration\u003C/strong>: The object exists for the entire execution of the program. In C and C++, this includes global variables, variables declared with \u003Ccode>static\u003C/code>, and string literals. In Rust, this includes \u003Ccode>static\u003C/code> items and string literals (which have type \u003Ccode>&#x26;'static str\u003C/code>). The memory for these objects is typically placed in the \u003Ccode>.data\u003C/code> or \u003Ccode>.rodata\u003C/code> segment of the executable and requires no runtime allocation.\u003C/p>\n\u003Cp>\u003Cstrong>Thread storage duration\u003C/strong>: The object exists for the lifetime of a thread. C11 introduced \u003Ccode>_Thread_local\u003C/code> (spelled \u003Ccode>thread_local\u003C/code> since C23), C++11 introduced \u003Ccode>thread_local\u003C/code>, and Rust provides \u003Ccode>thread_local!\u003C/code> macro. Each thread gets its own instance of the variable, allocated when the thread starts and deallocated when it terminates.\u003C/p>\n\u003Cp>\u003Cstrong>Automatic storage duration\u003C/strong>: The object exists within a lexical scope, typically a function body or block. When execution enters the scope, space is reserved; when execution leaves, the space is released. In C and C++, local variables without \u003Ccode>static\u003C/code> or \u003Ccode>thread_local\u003C/code> have automatic storage. In Rust, all local bindings have automatic storage. This is typically implemented via the stack.\u003C/p>\n\u003Cp>\u003Cstrong>Allocated (dynamic) storage duration\u003C/strong>: The objectâ€™s lifetime is controlled explicitly by the program. In C, this means \u003Ccode>malloc\u003C/code>/\u003Ccode>free\u003C/code>. In C++, this means \u003Ccode>new\u003C/code>/\u003Ccode>delete\u003C/code> or allocator-aware containers. In Rust, this means \u003Ccode>Box\u003C/code>, \u003Ccode>Vec\u003C/code>, \u003Ccode>String\u003C/code>, and other heap-allocating types.\u003C/p>\n\u003Ch3 id=\"stack\">Stack\u003C/h3>\n\u003Cp>Automatic storage is almost universally implemented using a call stack. When a function is called, the compiler reserves space for its local variables by adjusting the stack pointer. On x86-64 following the System V ABI, this looks like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">my_function\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    push\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rbp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rbp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    sub\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">48\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">          ; reserve 48 bytes for locals\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    ; ... function body ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rsp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rbp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    pop\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> rbp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    ret\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>sub rsp, 48\u003C/code> instruction allocates space for all local variables in a single operation. The compiler computes the required size at compile time by summing the sizes of all locals (accounting for alignment). Deallocation is equally cheap: \u003Ccode>mov rsp, rbp\u003C/code> releases all that space instantly.\u003C/p>\n\u003Cp>This has two consequences:\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>Allocation and deallocation of automatic storage is \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span> regardless of how many objects are involved. A function with 100 local variables pays the same cost as one with 2.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>The space is not initialized. After \u003Ccode>sub rsp, 48\u003C/code>, those 48 bytes contain whatever was previously on the stack. In C, reading an uninitialized automatic variable is undefined behavior (the value is \u003Cem>indeterminate\u003C/em>). In C++, the same rule applies. In Rust, the compiler enforces definite initialization: you cannot read a variable before assigning to it.\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: borrow of possibly-uninitialized variable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The Rust compiler tracks initialization state through control flow and rejects programs that might read uninitialized memory. This is a compile-time check with no runtime cost.\u003C/p>\n\u003Ch3 id=\"heap\">Heap\u003C/h3>\n\u003Cp>Dynamic allocation is fundamentally different. When we call \u003Ccode>malloc(n)\u003C/code>, the allocator must:\u003C/p>\n\u003Col>\n\u003Cli>Find a contiguous region of at least \u003Ccode>n\u003C/code> bytes that is not currently in use\u003C/li>\n\u003Cli>Mark that region as allocated\u003C/li>\n\u003Cli>Return a pointer to it\u003C/li>\n\u003C/ol>\n\u003Cp>When we call \u003Ccode>free(p)\u003C/code>, the allocator must:\u003C/p>\n\u003Col>\n\u003Cli>Determine the size of the allocation (stored in metadata adjacent to the user data)\u003C/li>\n\u003Cli>Mark that region as available for future allocations\u003C/li>\n\u003Cli>Possibly coalesce adjacent free regions to reduce fragmentation\u003C/li>\n\u003C/ol>\n\u003Cp>This involves data structure manipulation, potential system calls (if the allocator needs more memory from the OS), and can have variable latency depending on heap state. The cost is not \u003Cspan class=\"katex\">\u003Cspan class=\"katex-mathml\">\u003Cmath xmlns=\"http://www.w3.org/1998/Math/MathML\">\u003Csemantics>\u003Cmrow>\u003Cmi>O\u003C/mi>\u003Cmo stretchy=\"false\">(\u003C/mo>\u003Cmn>1\u003C/mn>\u003Cmo stretchy=\"false\">)\u003C/mo>\u003C/mrow>\u003Cannotation encoding=\"application/x-tex\">O(1)\u003C/annotation>\u003C/semantics>\u003C/math>\u003C/span>\u003Cspan class=\"katex-html\" aria-hidden=\"true\">\u003Cspan class=\"base\">\u003Cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\">\u003C/span>\u003Cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O\u003C/span>\u003Cspan class=\"mopen\">(\u003C/span>\u003Cspan class=\"mord\">1\u003C/span>\u003Cspan class=\"mclose\">)\u003C/span>\u003C/span>\u003C/span>\u003C/span>.\u003C/p>\n\u003Cp>In C, heap allocation is explicit:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> malloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> NULL\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // allocation failed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ... use p ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">free\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(p);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The programmer is responsible for:\u003C/p>\n\u003Col>\n\u003Cli>Checking for allocation failure\u003C/li>\n\u003Cli>Calling \u003Ccode>free\u003C/code> exactly once\u003C/li>\n\u003Cli>Not using the pointer after \u003Ccode>free\u003C/code>\u003C/li>\n\u003Cli>Not freeing the same pointer twice\u003C/li>\n\u003C/ol>\n\u003Cp>Violating any of these causes undefined behavior or memory leaks. The language provides no assistance.\u003C/p>\n\u003Cp>In C++, dynamic allocation can be explicit (\u003Ccode>new\u003C/code>/\u003Ccode>delete\u003C/code>) or managed through RAII:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Explicit (dangerous)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">delete[]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// RAII (safer)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_unique\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[]>(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v automatically deleted when it goes out of scope\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>std::unique_ptr\u003C/code> wraps a raw pointer and calls \u003Ccode>delete\u003C/code> in its destructor. When \u003Ccode>v\u003C/code> goes out of scope, the destructor runs, the memory is freed. The programmer does not call \u003Ccode>delete\u003C/code> manually.\u003C/p>\n\u003Cp>This is opt-in. You can still use raw \u003Ccode>new\u003C/code>/\u003Ccode>delete\u003C/code>. You can still have dangling pointers. The compiler does not verify correctness.\u003C/p>\n\u003Cp>In Rust, heap allocation is handled through owning types:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">100\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v automatically deallocated when it goes out of scope\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>Vec&#x3C;T>\u003C/code> owns heap-allocated memory. When \u003Ccode>v\u003C/code> goes out of scope, \u003Ccode>Vec\u003C/code>â€™s \u003Ccode>Drop\u003C/code> implementation runs, calling the allocator to free the buffer. There is no way to forget to free, no way to double-free, and no way to use after free (the compiler rejects such programs).\u003C/p>\n\u003Cp>The difference from C++ is that Rustâ€™s ownership is not opt-in. Every heap allocation is owned by exactly one binding. Transferring ownership is a move. After a move, the original binding is unusable:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v1 moved to v2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: borrow of moved value\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"who-calls-free\">Who Calls Free?\u003C/h3>\n\u003Cp>The central difference between C, C++, and Rust in their treatment of dynamic storage is responsibility for deallocation.\u003C/p>\n\u003Cp>In C, the programmer decides when to call \u003Ccode>free\u003C/code>. The language does not track ownership. If you pass a pointer to a function, the function might free it, or it might not. The only way to know is documentation or convention.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Does this function free data? You have to read the docs.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In C++, RAII shifts responsibility to destructors. If you use \u003Ccode>unique_ptr\u003C/code>, the destructor frees. If you use \u003Ccode>shared_ptr\u003C/code>, the destructor decrements a reference count and frees when it reaches zero. But you can still use raw pointers, and the compiler cannot tell you which convention a given codebase follows.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Raw pointer: who owns this? Still ambiguous.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">unique_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[]> \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Ownership transferred: this function will free when done.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In Rust, the type system encodes ownership:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // This function owns data. It will be freed when process returns.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // This function borrows data. The caller retains ownership.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Mutable borrow. Caller retains ownership. No other access allowed during this call.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The signature tells you everything. \u003Ccode>Vec&#x3C;i32>\u003C/code> means ownership transfer. \u003Ccode>&#x26;Vec&#x3C;i32>\u003C/code> means immutable borrow. \u003Ccode>&#x26;mut Vec&#x3C;i32>\u003C/code> means mutable borrow. The compiler enforces these semantics. You cannot pass a \u003Ccode>Vec\u003C/code> and then continue using it; the move would be rejected.\u003C/p>\n\u003Ch3 id=\"stack-allocation-in-rust\">Stack Allocation in Rust\u003C/h3>\n\u003Cp>Rust provides fine-grained control over whether data lives on the stack or heap. By default, local bindings are stack-allocated:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// 4000 bytes on the stack\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This works until the array is too large for the stack (typically 1-8 MB depending on platform). For large allocations, use \u003Ccode>Box\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">1000000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">([\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// heap\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>Box&#x3C;T>\u003C/code> is a pointer to a heap allocation. It has the same size as a raw pointer (8 bytes on 64-bit), implements \u003Ccode>Deref\u003C/code> so you can use it like a reference, and frees the allocation in its \u003Ccode>Drop\u003C/code> implementation.\u003C/p>\n\u003Cp>The memory layout of \u003Ccode>Box&#x3C;T>\u003C/code> is a single pointer:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]>>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// just a pointer\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Unlike C++ \u003Ccode>unique_ptr\u003C/code>, which may carry a deleter, \u003Ccode>Box&#x3C;T>\u003C/code> always uses the global allocator and has no space overhead. The deallocation function is known statically.\u003C/p>\n\u003C!-- ### How Does Vec Work?\n\n`Vec\u003CT>` is Rust's growable array. Its memory layout is three machine words:\n\n```rust\n// Conceptually:\nstruct Vec\u003CT> {\n    ptr: *mut T,      // pointer to heap allocation\n    cap: usize,       // allocated capacity\n    len: usize,       // number of initialized elements\n}\n```\n\nOn 64-bit, `size_of::\u003CVec\u003CT>>()` is 24 bytes regardless of `T`.\n\nWhen you create a `Vec`:\n\n```rust\nlet mut v = Vec::with_capacity(10);\n```\n\nThe allocator provides a buffer for 10 elements. `ptr` points to it, `cap` is 10, `len` is 0.\n\nWhen you push elements:\n\n```rust\nv.push(1);  // len becomes 1\nv.push(2);  // len becomes 2\n```\n\nEach `push` writes to `ptr.add(len)` and increments `len`. No reallocation occurs while `len \u003C cap`.\n\nWhen `len` reaches `cap` and you push again, `Vec` must reallocate:\n\n1. Allocate a new buffer with larger capacity\n2. Copy existing elements to the new buffer\n3. Free the old buffer\n4. Update `ptr` and `cap`\n\nWhen `Vec` is dropped:\n\n1. Call `drop` on each element (for types with destructors)\n2. Free the buffer\n\nAll of this happens automatically. The programmer writes `v.push(x)` and the ownership system ensures the buffer is freed exactly once, when `v` goes out of scope.\n\nThis is the pattern throughout Rust's standard library. `String` owns a UTF-8 buffer. `HashMap` owns its backing storage. `File` owns a file descriptor. When the owner goes out of scope, the resource is released. The type system ensures there is always exactly one owner. -->\n\u003Ch2 id=\"object-lifetime\">Object Lifetime\u003C/h2>\n\u003Cp>Storage duration determines when memory is allocated and deallocated. Object lifetime determines when accessing that memory is well-defined. In C, these are identical. In C++, they can differ. In Rust, lifetime becomes a compile-time property tracked through constraint propagation over the control-flow graph.\u003C/p>\n\u003Ch3 id=\"c-lifetime-is-storage-duration\">C: Lifetime Is Storage Duration\u003C/h3>\n\u003Cp>C does not distinguish between \u003Cem>storage exists\u003C/em> and \u003Cem>object is alive\u003C/em>. An object with automatic storage duration is alive from when execution enters its block of definition until execution leaves. An object with static storage duration is alive for the entire program. An object with allocated storage duration is alive from \u003Ccode>malloc\u003C/code> to \u003Ccode>free\u003C/code>.\u003C/p>\n\u003Cp>The consequence is that C has no notion of \u003Cem>storage exists but object is not yet constructed\u003C/em>. When the stack frame is created, all automatic variables exist. Whether they are initialized is a separate question:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dangling\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dangling\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">()\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%d\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">p)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This program compiles. The function \u003Ccode>dangling\u003C/code> returns a pointer to \u003Ccode>x\u003C/code>, but \u003Ccode>x\u003C/code> has automatic storage duration. When \u003Ccode>dangling\u003C/code> returns, its stack frame is deallocated. The pointer \u003Ccode>p\u003C/code> now points to memory that no longer belongs to any live object. Dereferencing it is undefined behavior.\u003C/p>\n\u003Cp>The C standard does not require the compiler to reject this. A conforming implementation may emit a warning, but the program is syntactically valid. The burden falls entirely on the programmer.\u003C/p>\n\u003Ch3 id=\"c-lifetime-within-storage\">C++: Lifetime Within Storage\u003C/h3>\n\u003Cp>C++ introduces a distinction. Storage duration determines when memory is allocated and deallocated. Object lifetime determines when the object can be accessed. For class types, lifetime begins when the constructor completes and ends when the destructor starts.\u003C/p>\n\u003Cp>Consider placement new:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">string name;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> name\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(n) { }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    ~Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() { std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">destroyed\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">alignas\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsigned\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> buffer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget)];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Storage exists. No Widget object exists.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> w \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (buffer) \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">test\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Constructor has run. Widget object now exists.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">~Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Destructor has run. Widget object no longer exists.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Storage still exists.\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Between placement new and the explicit destructor call, the \u003Ccode>Widget\u003C/code> object is alive. Before placement new and after the destructor, the bytes in \u003Ccode>buffer\u003C/code> exist but no \u003Ccode>Widget\u003C/code> does. Accessing \u003Ccode>w->name\u003C/code> after the destructor call is undefined behavior. The bytes are there. The object is not.\u003C/p>\n\u003Cp>The C++ standard (N4950, Â§6.7.3) states:\u003C/p>\n\u003Cblockquote>\n\u003Cp>The lifetime of an object of type T begins when: (1.1) storage with the proper alignment and size for type T is obtained, and (1.2) its initialization (if any) is complete.\u003C/p>\n\u003C/blockquote>\n\u003Cblockquote>\n\u003Cp>The lifetime of an object of type T ends when: (1.3) if T is a non-class type, the object is destroyed, or (1.4) if T is a class type, the destructor call starts.\u003C/p>\n\u003C/blockquote>\n\u003Cp>For trivial types (no user-defined constructor, no destructor, no virtual functions), C++ behaves like C. For class types with nontrivial constructors or destructors, the distinction matters.\u003C/p>\n\u003Cp>The dangling reference problem persists:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dangling\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This compiles. A good compiler warns. The standard does not require rejection.\u003C/p>\n\u003Ch3 id=\"rust-lifetimes-as-named-regions\">Rust: Lifetimes as Named Regions\u003C/h3>\n\u003Cp>Rust prevents dangling references through compile-time analysis. The equivalent code does not compile:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dangling\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler rejects this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>error[E0106]: missing lifetime specifier\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> --> src/lib.rs:1:18\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>1 | fn dangling() -> &#x26;i32 {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |                  ^ expected named lifetime parameter\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We cannot return a reference without specifying its lifetime. If we try to add one:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dangling\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>error[E0515]: cannot return reference to local variable `x`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> --> src/lib.rs:3:5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>3 |     &#x26;x\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |     ^^ returns a reference to data owned by the current function\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler determines that \u003Ccode>x\u003C/code> does not live long enough to satisfy the lifetime \u003Ccode>'a\u003C/code>. How does it know this? The answer lies in \u003Cem>region inference\u003C/em>.\u003C/p>\n\u003Ch3 id=\"regions-and-the-control-flow-graph\">Regions and the Control-Flow Graph\u003C/h3>\n\u003Cp>A lifetime in Rust is a \u003Cem>region\u003C/em>: a set of points in the control-flow graph where a reference must be valid. The borrow checker computes these regions through constraint propagation.\u003C/p>\n\u003Cp>Consider this code:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> z\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Each \u003Ccode>let\u003C/code> binding introduces an implicit scope. The borrow checker infers the minimal region for each reference. Desugared (using notation that is not valid Rust syntax, but illustrates the structure):\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> z\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">c\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The reference \u003Ccode>y\u003C/code> has lifetime \u003Ccode>'b\u003C/code> because that is the smallest region that covers its usage. The reference \u003Ccode>z\u003C/code> has lifetime \u003Ccode>'c\u003C/code>. The borrow checker minimizes lifetimes to the extent necessary.\u003C/p>\n\u003Cp>When a reference is passed to an outer scope, the borrow checker infers a larger lifetime:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> z\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">z\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Desugared:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> z\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// must use 'b, not 'c\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            z\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Because \u003Ccode>y\u003C/code> is assigned to \u003Ccode>z\u003C/code>, and \u003Ccode>z\u003C/code> lives in scope \u003Ccode>'b\u003C/code>, the reference must be valid for \u003Ccode>'b\u003C/code>. The borrow checker propagates this requirement.\u003C/p>\n\u003Ch3 id=\"region-inference-in-rustc\">Region Inference in rustc\u003C/h3>\n\u003Cp>The borrow checker operates on MIR (Mid-level Intermediate Representation), a simplified form of Rust code. The process has two phases:\u003C/p>\n\u003Cp>\u003Cstrong>Phase 1: \u003Ccode>replace_regions_in_mir\u003C/code>\u003C/strong>\u003C/p>\n\u003Cp>The compiler identifies \u003Cem>universal regions\u003C/em> (those appearing in the function signature, such as \u003Ccode>'a\u003C/code> in \u003Ccode>fn foo&#x3C;'a>(x: &#x26;'a u32)\u003C/code>) and replaces all other regions with fresh inference variables. Universal regions are \u003Cem>free\u003C/em> in the function body. They represent constraints from the caller.\u003C/p>\n\u003Cp>\u003Cstrong>Phase 2: \u003Ccode>compute_regions\u003C/code>\u003C/strong>\u003C/p>\n\u003Cp>The compiler runs a type checker on MIR to collect constraints between regions. It then performs constraint propagation to compute the value of each inference variable.\u003C/p>\n\u003Cp>A regionâ€™s value is a set. The set contains:\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>\u003Cstrong>Locations in the MIR control-flow graph\u003C/strong>: Each location is a pair (basic block, statement index). This identifies the point on entry to that statement.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>End markers for universal regions\u003C/strong>: If region \u003Ccode>'a\u003C/code> outlives region \u003Ccode>'b\u003C/code>, then \u003Ccode>end('b)\u003C/code> is in the set for \u003Ccode>'a\u003C/code>. The element \u003Ccode>end('b)\u003C/code> represents the portion of the callerâ€™s control-flow graph after the current function returns.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>\u003Ccode>end('static)\u003C/code>\u003C/strong>: Represents program execution after the function returns, extending to program termination.\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Cp>The two main constraint types are:\u003C/p>\n\u003Cp>\u003Cstrong>Outlives constraints\u003C/strong>: If \u003Ccode>'a: 'b\u003C/code> (region \u003Ccode>'a\u003C/code> outlives region \u003Ccode>'b\u003C/code>), all elements of \u003Ccode>'b\u003C/code> plus \u003Ccode>end('b)\u003C/code> must be added to \u003Ccode>'a\u003C/code>.\u003C/p>\n\u003Cp>\u003Cstrong>Liveness constraints\u003C/strong>: A region must contain all points where it can be used.\u003C/p>\n\u003Ch3 id=\"constraint-propagation\">Constraint Propagation\u003C/h3>\n\u003Cp>Consider this function:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bad\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    x\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This should not compile. We have no guarantee that \u003Ccode>'a\u003C/code> outlives \u003Ccode>'b\u003C/code>. If \u003Ccode>'a\u003C/code> is shorter than \u003Ccode>'b\u003C/code>, the return value would be a dangling reference.\u003C/p>\n\u003Cp>The compiler introduces inference variables. Let \u003Ccode>'#1\u003C/code> correspond to \u003Ccode>'a\u003C/code>, \u003Ccode>'#3\u003C/code> correspond to \u003Ccode>'b\u003C/code>, and \u003Ccode>'#2\u003C/code> correspond to the expression \u003Ccode>x\u003C/code>. Let L1 be the location of \u003Ccode>x\u003C/code>.\u003C/p>\n\u003Cp>Initial state from liveness constraints:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Region\u003C/th>\u003Cth>Contents\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>â€™#1\u003C/td>\u003Ctd>(empty)\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>â€˜#2\u003C/td>\u003Ctd>L1\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>â€™#3\u003C/td>\u003Ctd>L1\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>The return statement creates an outlives constraint \u003Ccode>'#2: '#3\u003C/code> (the returned reference must outlive the return typeâ€™s region). Propagating:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Region\u003C/th>\u003Cth>Contents\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>â€™#1\u003C/td>\u003Ctd>L1\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>â€™#2\u003C/td>\u003Ctd>L1, end(â€˜#3)\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>â€˜#3\u003C/td>\u003Ctd>L1\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>The parameter creates an outlives constraint \u003Ccode>'#1: '#2\u003C/code> (the input flows to the expression). Propagating:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Region\u003C/th>\u003Cth>Contents\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>â€™#1\u003C/td>\u003Ctd>L1, end(â€˜#2), end(â€˜#3)\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>â€˜#2\u003C/td>\u003Ctd>L1, end(â€˜#3)\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>â€˜#3\u003C/td>\u003Ctd>L1\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>Now the compiler checks: does \u003Ccode>'#1\u003C/code> contain any \u003Ccode>end('x)\u003C/code> that is not justified by a where clause or implied bound? Yes. \u003Ccode>'#1\u003C/code> contains \u003Ccode>end('#3)\u003C/code>, but we have no \u003Ccode>where\u003C/code> clause stating \u003Ccode>'a: 'b\u003C/code>. This is an error.\u003C/p>\n\u003Cp>The \u003Ccode>RegionInferenceContext\u003C/code> in rustc stores:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>constraints\u003C/code>: all outlives constraints\u003C/li>\n\u003Cli>\u003Ccode>liveness_constraints\u003C/code>: all liveness constraints\u003C/li>\n\u003Cli>\u003Ccode>universal_regions\u003C/code>: the set of regions from the function signature\u003C/li>\n\u003Cli>\u003Ccode>universal_region_relations\u003C/code>: known relationships between universal regions (from where clauses)\u003C/li>\n\u003C/ul>\n\u003Cp>The \u003Ccode>solve\u003C/code> method performs propagation, then \u003Ccode>check_universal_regions\u003C/code> verifies that no universal region grew to contain \u003Ccode>end\u003C/code> markers it cannot justify.\u003C/p>\n\u003Ch3 id=\"non-lexical-lifetimes\">Non-Lexical Lifetimes\u003C/h3>\n\u003Cp>Before Rust 2018, lifetimes were lexical: a reference was live until the end of its lexical scope. This rejected valid programs:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error in old Rust: x still in scope\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With lexical lifetimes, \u003Ccode>x\u003C/code> would be considered live until the closing brace, conflicting with the mutable borrow for \u003Ccode>push\u003C/code>.\u003C/p>\n\u003Cp>Non-lexical lifetimes (NLL) compute liveness from the control-flow graph. A reference is live from its creation to its last use, not to the end of its scope:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// last use of x\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: x is no longer live\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The borrow of \u003Ccode>data\u003C/code> for \u003Ccode>x\u003C/code> extends to the \u003Ccode>println!\u003C/code> call. After that, the borrow ends. The mutable borrow for \u003Ccode>push\u003C/code> does not conflict.\u003C/p>\n\u003Cp>There are subtleties. If a type has a destructor, the destructor counts as a use. The destructor runs at scope end, extending the lifetime:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Wrapper\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Wrapper\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Wrapper\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: destructor of x runs at scope end\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>Drop\u003C/code> impl means \u003Ccode>x\u003C/code> is used at scope end. The borrow extends to that point, conflicting with \u003Ccode>push\u003C/code>. To fix this, we can call \u003Ccode>drop(x)\u003C/code> explicitly before \u003Ccode>push\u003C/code>.\u003C/p>\n\u003Cp>Lifetimes can have holes. A variable can be reborrowed:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// last use of first borrow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: first borrow ended\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// new borrow starts\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The borrow checker sees two distinct borrows tied to the same variable. The first ends after the first \u003Ccode>println!\u003C/code>. The second starts at the reassignment.\u003C/p>\n\u003Cp>Control flow matters. Different branches can have different last uses:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> condition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">true\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> condition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// last use in this branch\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: x not used in this branch\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>In the \u003Ccode>if\u003C/code> branch, \u003Ccode>x\u003C/code> is used before \u003Ccode>push\u003C/code>. In the \u003Ccode>else\u003C/code> branch, \u003Ccode>x\u003C/code> is never used, so the borrow effectively ends at \u003Ccode>x\u003C/code>â€™s creation.\u003C/p>\n\u003Ch3 id=\"lifetimes-across-function-boundaries\">Lifetimes Across Function Boundaries\u003C/h3>\n\u003Cp>Within a function, the borrow checker has complete information. It knows every use of every reference. Across function boundaries, this information is lost. Function signatures must declare the relationships between input and output lifetimes.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> first_word\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // returns a slice of the input\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The signature says: the output lifetime equals the input lifetime. The returned slice borrows from \u003Ccode>s\u003C/code>. Callers cannot use the returned slice after \u003Ccode>s\u003C/code> is invalidated.\u003C/p>\n\u003Cp>When signatures are ambiguous, the compiler requires explicit annotation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> longest\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() > \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This does not compile. The return could come from \u003Ccode>x\u003C/code> or \u003Ccode>y\u003C/code>. The compiler does not know which. We must tell it:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> longest\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() > \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The signature now says: both inputs must be valid for at least \u003Ccode>'a\u003C/code>, and the output is valid for \u003Ccode>'a\u003C/code>. Callers must ensure both inputs outlive the result.\u003C/p>\n\u003Ch3 id=\"lifetime-elision\">Lifetime Elision\u003C/h3>\n\u003Cp>Common patterns do not require explicit annotation. Elision rules infer lifetimes:\u003C/p>\n\u003Cp>\u003Cstrong>Rule 1\u003C/strong>: Each input reference gets its own lifetime.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// becomes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Rule 2\u003C/strong>: If there is exactly one input lifetime, it is assigned to all outputs.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// becomes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Rule 3\u003C/strong>: If one input is \u003Ccode>&#x26;self\u003C/code> or \u003Ccode>&#x26;mut self\u003C/code>, its lifetime is assigned to all outputs.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Foo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> method\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // becomes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> method\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">b\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When elision rules do not determine all lifetimes, explicit annotation is required.\u003C/p>\n\u003Ch3 id=\"static\">\u003Ccode>'static\u003C/code>\u003C/h3>\n\u003Cp>The lifetime \u003Ccode>'static\u003C/code> means valid for the entire program. String literals have type \u003Ccode>&#x26;'static str\u003C/code> because they are stored in the binaryâ€™s read-only data segment:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">static\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> str\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bound \u003Ccode>T: 'static\u003C/code> means \u003Cem>T contains no non-static references\u003C/em>. This is required for spawning threads, since the spawned thread may outlive the current stack frame:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> spawn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">f\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> FnOnce\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Send\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">static\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A closure that captures \u003Ccode>&#x26;x\u003C/code> where \u003Ccode>x\u003C/code> is a local variable does not satisfy \u003Ccode>'static\u003C/code>. The reference would dangle when the spawning function returns.\u003C/p>\n\u003Ch2 id=\"uninitialized-memory\">Uninitialized Memory\u003C/h2>\n\u003Cp>All runtime-allocated memory begins as uninitialized. The bytes exist but contain whatever values were left there by previous use. The question is: what happens when we read those bytes before writing to them?\u003C/p>\n\u003Cp>C says the value is \u003Cem>indeterminate\u003C/em>. C++ adds the concept of \u003Cem>vacuous initialization\u003C/em>. Rust says reading uninitialized memory is undefined behavior, full stop, and provides \u003Ccode>MaybeUninit&#x3C;T>\u003C/code> as the controlled mechanism for working with such memory.\u003C/p>\n\u003Ch3 id=\"c-indeterminate-values\">C: Indeterminate Values\u003C/h3>\n\u003Cp>In C, reading an uninitialized automatic variable produces an \u003Cem>indeterminate value\u003C/em>. The C23 standard distinguishes this from a \u003Cem>non-value representation\u003C/em> (previously called \u003Cem>trap representation\u003C/em>), which is a bit pattern that does not correspond to any valid value of the type.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%d\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> x)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // indeterminate value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>What happens here? The standard does not say the program crashes. It does not say the program continues with some arbitrary value. It says the behavior is undefined. The compiler is permitted to assume this code never executes.\u003C/p>\n\u003Cp>The distinction between indeterminate values and non-value representations matters for types where not all bit patterns are valid. The \u003Ccode>bool\u003C/code> type has only two valid values: 0 (\u003Ccode>false\u003C/code>) and 1 (\u003Ccode>true\u003C/code>). A \u003Ccode>bool\u003C/code> occupies at least 8 bits. Setting other bits produces a non-value representation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">memset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">b\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#FFEB95\"> 0x\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">FF\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(b));\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // all bits set\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (b) {\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> /* ... */\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">          // undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler may test for zero, or it may test the least significant bit. Different optimization levels may produce different results. The behavior is not merely unspecified (implementation-defined but consistent); it is undefined (the compiler may assume it cannot happen).\u003C/p>\n\u003Cp>For types without non-value representations (most integer types on modern hardware), reading an indeterminate value is still undefined behavior because the compiler cannot reason about what value it will see. The optimizer may propagate contradictory assumptions through the program.\u003C/p>\n\u003Ch3 id=\"c-vacuous-initialization-and-implicit-object-creation\">C++: Vacuous Initialization and Implicit Object Creation\u003C/h3>\n\u003Cp>C++ inherits Câ€™s rules for scalar types but adds complexity for class types. A variable has \u003Cem>vacuous initialization\u003C/em> if it is default-initialized and its class type has a trivial default constructor.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Trivial\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> y;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    Trivial t;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // vacuous initialization: x and y are indeterminate\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The object \u003Ccode>t\u003C/code> exists. Its lifetime has begun. But its members \u003Ccode>x\u003C/code> and \u003Ccode>y\u003C/code> contain indeterminate values. Reading them is undefined behavior, just as in C.\u003C/p>\n\u003Cp>For class types with nontrivial constructors, default initialization runs the constructor:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Nontrivial\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Nontrivial\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    Nontrivial n;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // constructor runs, x is 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>C++20 introduced \u003Cem>implicit object creation\u003C/em>. Certain operations (allocation functions, \u003Ccode>memmove\u003C/code>, \u003Ccode>memcpy\u003C/code>, creation of \u003Ccode>unsigned char\u003C/code> or \u003Ccode>std::byte\u003C/code> arrays) implicitly create objects of \u003Cem>implicit-lifetime types\u003C/em> within their storage region. This retroactively makes some previously-undefined patterns well-defined:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> X\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b; };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">X\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">*\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> make_x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    X\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (X\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">malloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(struct X));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // pre-C++20: UB (no X object exists)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // C++20: ok (X implicitly created)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The C++ standard (N4950, Â§6.7.2) specifies that \u003Ccode>malloc\u003C/code> implicitly creates objects of implicit-lifetime types if doing so would give the program defined behavior. This was a pragmatic fix for code that had been written for decades under the assumption that \u003Ccode>malloc\u003C/code> plus assignment creates an object.\u003C/p>\n\u003Ch3 id=\"rust-immediate-undefined-behavior\">Rust: Immediate Undefined Behavior\u003C/h3>\n\u003Cp>Rust takes the strictest position. Reading uninitialized memory is undefined behavior at the point of the read, regardless of type. The Rust Reference lists this explicitly:\u003C/p>\n\u003Cblockquote>\n\u003Cp>An integer (\u003Ccode>i*\u003C/code>/\u003Ccode>u*\u003C/code>), floating point value (\u003Ccode>f*\u003C/code>), or raw pointer must be initialized, i.e., must not be obtained from uninitialized memory.\u003C/p>\n\u003C/blockquote>\n\u003Cp>This applies even to \u003Ccode>u8\u003C/code>, which has no invalid bit patterns. The reasoning is that the compiler must be able to assume all values are initialized. Without this guarantee, the optimizer cannot propagate values, eliminate dead stores, or make any assumptions about the contents of memory.\u003C/p>\n\u003Cp>Rust enforces this at compile time for safe code through definite initialization analysis:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: use of possibly uninitialized `x`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The analysis tracks initialization state through control flow:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">condition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> condition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: `x` is possibly uninitialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Even though the \u003Ccode>if\u003C/code> branch initializes \u003Ccode>x\u003C/code>, the \u003Ccode>else\u003C/code> branch does not. The compiler rejects the program.\u003C/p>\n\u003Cp>The analysis understands control flow but not values:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> true\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: compiler doesn't evaluate `true`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler does not evaluate \u003Ccode>true\u003C/code> at analysis time. It sees a conditional with only one branch that initializes \u003Ccode>x\u003C/code>. The program is rejected.\u003C/p>\n\u003Cp>Loops require care:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    loop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> true\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">            x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            break\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: compiler knows break is reached\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler understands that execution cannot reach \u003Ccode>println!\u003C/code> without passing through the \u003Ccode>break\u003C/code>, and the \u003Ccode>break\u003C/code> is preceded by initialization. The program compiles.\u003C/p>\n\u003Ch3 id=\"move-semantics-and-uninitialization\">Move Semantics and Uninitialization\u003C/h3>\n\u003Cp>In Rust, moving a value out of a variable leaves that variable logically uninitialized:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// x is moved, now logically uninitialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: use of moved value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For \u003Ccode>Copy\u003C/code> types, this does not apply. The value is copied, and both variables remain initialized:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// copy, not move\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: x is still initialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A variable can be reinitialized after being moved from:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// x is moved\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">43\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);    \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// x is reinitialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>mut\u003C/code> is required because the compiler considers reinitialization to be mutation.\u003C/p>\n\u003Ch3 id=\"maybeuninitt-the-escape-hatch\">\u003Ccode>MaybeUninit&#x3C;T>\u003C/code>: The Escape Hatch\u003C/h3>\n\u003Cp>When performance requires working with uninitialized memory, Rust provides \u003Ccode>MaybeUninit&#x3C;T>\u003C/code>. This is a union type that can hold either an initialized \u003Ccode>T\u003C/code> or uninitialized bytes:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The key property: dropping a \u003Ccode>MaybeUninit&#x3C;T>\u003C/code> does nothing. It does not run \u003Ccode>T\u003C/code>â€™s destructor. This is essential because the value might not be initialized, and dropping an uninitialized value would be undefined behavior.\u003C/p>\n\u003Cp>To initialize, we write to the \u003Ccode>MaybeUninit\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">write\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// now initialized\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>To extract the initialized value, we call \u003Ccode>assume_init\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">write\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assume_init\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>assume_init\u003C/code> call is \u003Ccode>unsafe\u003C/code> because the compiler cannot verify that we actually initialized the value. We are asserting to the compiler: \u003Cem>trust me, it is initialized\u003C/em>. If we lied, behavior is undefined.\u003C/p>\n\u003Ch3 id=\"array-initialization\">Array Initialization\u003C/h3>\n\u003Cp>Safe Rust does not permit partial array initialization. We must initialize all elements at once:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok, all zeros\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For dynamic initialization, \u003Ccode>MaybeUninit\u003C/code> provides a path:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> SIZE\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">SIZE\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Create array of uninitialized MaybeUninit\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">SIZE\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        [\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() }; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">SIZE\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Initialize each element\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">SIZE\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        arr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Transmute to initialized type\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>; \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">SIZE\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The transmute is sound because \u003Ccode>MaybeUninit&#x3C;T>\u003C/code> has the same layout as \u003Ccode>T\u003C/code>. We initialized every element, so the array now contains valid \u003Ccode>Box&#x3C;u32>\u003C/code> values.\u003C/p>\n\u003Cp>A critical detail: the assignment \u003Ccode>arr[i] = MaybeUninit::new(...)\u003C/code> does not drop the old value. \u003Ccode>MaybeUninit&#x3C;T>\u003C/code> has no \u003Ccode>Drop\u003C/code> implementation. If we had written to a regular \u003Ccode>Box&#x3C;u32>\u003C/code> array, the assignment would drop the old value, which would be undefined behavior for uninitialized memory.\u003C/p>\n\u003Ch3 id=\"raw-pointer-writes\">Raw Pointer Writes\u003C/h3>\n\u003Cp>When \u003Ccode>MaybeUninit::new\u003C/code> is not suitable, we use raw pointer operations. The \u003Ccode>ptr\u003C/code> module provides:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>ptr::write(ptr, val)\u003C/code>: Writes \u003Ccode>val\u003C/code> to \u003Ccode>ptr\u003C/code> without reading or dropping the old value\u003C/li>\n\u003Cli>\u003Ccode>ptr::copy(src, dest, count)\u003C/code>: Copies \u003Ccode>count\u003C/code> elements from \u003Ccode>src\u003C/code> to \u003Ccode>dest\u003C/code> (like \u003Ccode>memmove\u003C/code>)\u003C/li>\n\u003Cli>\u003Ccode>ptr::copy_nonoverlapping(src, dest, count)\u003C/code>: Like \u003Ccode>copy\u003C/code>, but assumes no overlap (like \u003Ccode>memcpy\u003C/code>)\u003C/li>\n\u003C/ul>\n\u003Cp>These functions do not drop the destination. They overwrite the bytes. This is correct for uninitialized memory but dangerous for initialized memory containing values with destructors.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">String\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">write\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assume_init\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We cannot use \u003Ccode>&#x26;mut\u003C/code> to get a reference to the uninitialized \u003Ccode>String\u003C/code> because creating a reference to an invalid value is undefined behavior. The \u003Ccode>as_mut_ptr\u003C/code> method returns a raw pointer without creating a reference.\u003C/p>\n\u003Cp>For struct fields, we use raw reference syntax to avoid creating intermediate references:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{ptr, mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Demo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    field\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> uninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MaybeUninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Demo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> field_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">raw\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">field };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">field_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">write\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">true\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">); }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> demo\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">uninit\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assume_init\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>&#x26;raw mut\u003C/code> syntax creates a raw pointer without creating a reference. This is important because \u003Ccode>&#x26;mut (*uninit.as_mut_ptr()).field\u003C/code> would create a reference to an uninitialized \u003Ccode>bool\u003C/code>, which is undefined behavior.\u003C/p>\n\u003Ch3 id=\"the-vec-pattern\">The Vec Pattern\u003C/h3>\n\u003Cp>The most common use of uninitialized memory in Rust is building collections. \u003Ccode>Vec&#x3C;T>\u003C/code> internally uses \u003Ccode>MaybeUninit\u003C/code> (via \u003Ccode>RawVec\u003C/code>) to manage its buffer. When we call \u003Ccode>vec.reserve(n)\u003C/code>, the vector allocates space for \u003Ccode>n\u003C/code> additional elements without initializing them.\u003C/p>\n\u003Cp>A performance pattern for filling a vector from an external source:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> read_into_vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">src\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">count\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">count\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Get raw pointer to uninitialized buffer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Copy from source (assumes src.len() >= count)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy_nonoverlapping\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">src\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">count\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Tell Vec the elements are now initialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">set_len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">count\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>set_len\u003C/code> call is \u003Ccode>unsafe\u003C/code> because we are asserting that the first \u003Ccode>count\u003C/code> elements are initialized. The vector trusts us. If we lie, dropping the vector will attempt to drop uninitialized values, which is undefined behavior for types with destructors.\u003C/p>\n\u003Cp>For \u003Ccode>u8\u003C/code>, there is no destructor, so the immediate danger is reading garbage. But the compiler may still optimize based on the assumption that all values are initialized.\u003C/p>\n\u003Cp>The safe alternative uses \u003Ccode>resize\u003C/code> or \u003Ccode>extend\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> read_into_vec_safe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">src\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">count\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">count\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">extend_from_slice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">src\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">count\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This initializes each element as it is added. For large buffers, the unsafe version can be measurably faster because it avoids redundant initialization. Whether the speedup matters depends on the workload.\u003C/p>\n\u003Ch3 id=\"the-deprecated-memuninitialized\">The Deprecated \u003Ccode>mem::uninitialized\u003C/code>\u003C/h3>\n\u003Cp>Older Rust code uses \u003Ccode>mem::uninitialized::&#x3C;T>()\u003C/code> to create uninitialized values. This function is deprecated and should not be used in new code. The problem is that it returns a \u003Ccode>T\u003C/code>, which means the caller receives an \u003Cem>initialized\u003C/em> value of type \u003Ccode>T\u003C/code> that actually contains garbage:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// DON'T DO THIS\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">uninitialized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// x is now an \"initialized\" bool with garbage bits\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Any use of x is undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler believes \u003Ccode>x\u003C/code> is initialized. It may propagate this â€œvalueâ€ through the program. The result is unpredictable.\u003C/p>\n\u003Cp>\u003Ccode>MaybeUninit\u003C/code> solves this by wrapping the uninitialized state in a type that the compiler understands. The value inside is not accessible until we call \u003Ccode>assume_init\u003C/code>. This prevents the compiler from making false assumptions about initialization state.\u003C/p>\n\u003Ch2 id=\"aliasing\">Aliasing\u003C/h2>\n\u003Cp>Two pointers \u003Cem>alias\u003C/em> when they refer to overlapping regions of memory. This matters because aliasing constrains what the compiler can optimize. If the compiler cannot prove that two pointers refer to different memory, it must assume that a write through one may affect a read through the other. This forces conservative code generation: values must be reloaded from memory instead of kept in registers, stores cannot be reordered, and entire classes of optimization become impossible.\u003C/p>\n\u003Cp>Aliasing rules exist for optimization, not for safety. C and C++ have aliasing rules that, when violated, result in undefined behavior. The compiler is not checking these rules to protect the programmer. It is assuming the programmer follows them, and optimizing accordingly. Violate the assumption and the optimizer generates incorrect code.\u003C/p>\n\u003Cp>Rust makes the aliasing rule explicit and compiler-checked. The \u003Ccode>&#x26;T\u003C/code>/\u003Ccode>&#x26;mut T\u003C/code> distinction encodes a simple invariant: you can have many shared references or one mutable reference, but never both simultaneously. The borrow checker enforces this at compile time.\u003C/p>\n\u003Ch3 id=\"why-the-compiler-cares\">Why the Compiler Cares\u003C/h3>\n\u003Cp>Consider this function:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> compute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">output\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">output\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">output\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We would like the compiler to optimize this to:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> compute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">output\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> cached_input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">input\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> cached_input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">output\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> cached_input\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">output\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The optimization caches \u003Ccode>*input\u003C/code> in a register and eliminates the redundant read in the second condition. It also recognizes that if \u003Ccode>*input > 10\u003C/code>, the final value will always be 2 (set to 1, then doubled), so it writes 2 directly.\u003C/p>\n\u003Cp>This optimization is only valid if \u003Ccode>input\u003C/code> and \u003Ccode>output\u003C/code> do not alias. If they point to the same memory, the write \u003Ccode>*output = 1\u003C/code> changes what \u003Ccode>*input\u003C/code> reads:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 20\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// input and output both point to x\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With aliasing, the original function produces 1:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>*input\u003C/code> is 20, so \u003Ccode>*output = 1\u003C/code> (now \u003Ccode>x\u003C/code> is 1)\u003C/li>\n\u003Cli>\u003Ccode>*input\u003C/code> is 1, so the second condition is false\u003C/li>\n\u003Cli>Result: 1\u003C/li>\n\u003C/ul>\n\u003Cp>The optimized function produces 2:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>cached_input\u003C/code> is 20, so \u003Ccode>*output = 2\u003C/code>\u003C/li>\n\u003Cli>Result: 2\u003C/li>\n\u003C/ul>\n\u003Cp>In Rust, the call \u003Ccode>compute(&#x26;x, &#x26;mut x)\u003C/code> is rejected at compile time. The borrow checker sees an attempt to create both a shared reference and a mutable reference to \u003Ccode>x\u003C/code> simultaneously. The program does not compile.\u003C/p>\n\u003Cp>In C, the equivalent code compiles and the optimizer may generate the wrong result.\u003C/p>\n\u003Ch3 id=\"c-type-based-alias-analysis\">C: Type-Based Alias Analysis\u003C/h3>\n\u003Cp>The C standard specifies the \u003Cem>effective type\u003C/em> rule. An object must be accessed through its effective type or through a character type. Accessing an object through a pointer of incompatible type is undefined behavior.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fp \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> f \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fp;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior: accessing int through float*\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is often called \u003Cem>strict aliasing\u003C/em>. The compiler assumes that pointers of different types do not alias. An \u003Ccode>int*\u003C/code> and a \u003Ccode>float*\u003C/code> cannot point to the same object (with narrow exceptions for character types and unions). This assumption enables \u003Cem>Type-Based Alias Analysis\u003C/em> (TBAA): the compiler tracks pointer types and assumes incompatible types refer to disjoint memory.\u003C/p>\n\u003Cp>Consider:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> pi\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> pf\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">pi \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">pf \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2.0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#FFEB95\">f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    printf\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">%d\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">pi)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Under strict aliasing, the compiler may assume \u003Ccode>pi\u003C/code> and \u003Ccode>pf\u003C/code> do not alias. The write to \u003Ccode>*pf\u003C/code> cannot affect \u003Ccode>*pi\u003C/code>, so the compiler can print 1 without reloading from memory. It may even reorder the stores or keep \u003Ccode>*pi\u003C/code> in a register.\u003C/p>\n\u003Cp>If the programmer passes pointers that actually alias:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">union\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i; \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> f; } u;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">update\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u.i\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">u.f);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The optimizerâ€™s assumption is violated. The generated code may print 1 even though the memory now contains the bit pattern of 2.0f. Or it may print something else entirely. The behavior is undefined.\u003C/p>\n\u003Cp>The classic strict aliasing violation involves type punning without unions:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">uint32_t\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> float_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">uint32_t\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">f;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // undefined behavior\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This attempts to read the bit representation of a \u003Ccode>float\u003C/code> by casting its address to \u003Ccode>uint32_t*\u003C/code>. The effective type of the object is \u003Ccode>float\u003C/code>. Accessing it through \u003Ccode>uint32_t*\u003C/code> violates the effective type rule.\u003C/p>\n\u003Cp>The correct approach uses a union:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">uint32_t\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> float_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    union\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> f; \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">uint32_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> u; } converter \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { .f \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> f };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> converter\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">u\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Or \u003Ccode>memcpy\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">uint32_t\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> float_bits\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    uint32_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> result;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    memcpy\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">result\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">f\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(result))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> result;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Modern compilers optimize \u003Ccode>memcpy\u003C/code> of small sizes to register moves. The resulting assembly is identical to the undefined type-punning version, but the semantics are well-defined.\u003C/p>\n\u003Ch3 id=\"the-restrict-qualifier\">The \u003Ccode>restrict\u003C/code> Qualifier\u003C/h3>\n\u003Cp>Type-based alias analysis only helps when pointer types differ. Two \u003Ccode>int*\u003C/code> pointers may alias, and the compiler must assume they do unless told otherwise.\u003C/p>\n\u003Cp>C99 introduced the \u003Ccode>restrict\u003C/code> qualifier. A \u003Ccode>restrict\u003C/code>-qualified pointer is a promise from the programmer: during the lifetime of this pointer, no other pointer will be used to access the same memory.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> add_arrays\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> restrict\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> restrict\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n; i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        dest\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>restrict\u003C/code> qualifier tells the compiler that \u003Ccode>dest\u003C/code> and \u003Ccode>src\u003C/code> do not overlap. The compiler can vectorize the loop, load multiple elements of \u003Ccode>src\u003C/code> at once, and store multiple elements to \u003Ccode>dest\u003C/code> without worrying that a store to \u003Ccode>dest[i]\u003C/code> might affect a subsequent load from \u003Ccode>src[j]\u003C/code>.\u003C/p>\n\u003Cp>Without \u003Ccode>restrict\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> add_arrays\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n; i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        dest\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler must assume \u003Ccode>dest\u003C/code> and \u003Ccode>src\u003C/code> might overlap. If \u003Ccode>dest == src + 1\u003C/code>, each store to \u003Ccode>dest[i]\u003C/code> affects the next load from \u003Ccode>src[i+1]\u003C/code>. The loop cannot be vectorized. Each iteration must complete before the next begins.\u003C/p>\n\u003Cp>The \u003Ccode>restrict\u003C/code> qualifier is a promise, not a constraint. The compiler does not check it. If the programmer lies and passes overlapping pointers, the optimized code produces wrong results.\u003C/p>\n\u003Cp>Standard library functions use \u003Ccode>restrict\u003C/code> extensively:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> memcpy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> restrict\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> restrict\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> memmove\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>memcpy\u003C/code> promises non-overlapping regions. \u003Ccode>memmove\u003C/code> handles overlap correctly but cannot be optimized as aggressively.\u003C/p>\n\u003Ch3 id=\"rust-shared-xor-mutable\">Rust: Shared XOR Mutable\u003C/h3>\n\u003Cp>Rustâ€™s aliasing model is simpler and compiler-enforced. The rule is: at any point in time, a piece of memory can have either many shared references (\u003Ccode>&#x26;T\u003C/code>) or one mutable reference (\u003Ccode>&#x26;mut T\u003C/code>), but not both.\u003C/p>\n\u003Cp>This is sometimes written as \u003Cem>shared XOR mutable\u003C/em>, or \u003Cem>aliasing XOR mutation\u003C/em>. The key insight is that aliasing is only dangerous when combined with mutation. Many readers can safely read the same memory. A single writer can safely modify memory if no one else is reading. The problem arises when reads and writes can interleave unpredictably.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// shared reference\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// another shared reference, ok\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{} {}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r3\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// mutable reference\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r3\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This compiles because the shared references \u003Ccode>r1\u003C/code> and \u003Ccode>r2\u003C/code> are no longer used after the \u003Ccode>println!\u003C/code>. Their lifetimes end before the mutable reference \u003Ccode>r3\u003C/code> is created.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r3\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: cannot borrow `x` as mutable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This does not compile. The shared reference \u003Ccode>r1\u003C/code> is still live when we attempt to create the mutable reference \u003Ccode>r3\u003C/code>. The borrow checker rejects the program.\u003C/p>\n\u003Cp>The Rust compiler annotates references with LLVM attributes based on this invariant. A \u003Ccode>&#x26;T\u003C/code> receives \u003Ccode>noalias\u003C/code> for read operations. A \u003Ccode>&#x26;mut T\u003C/code> receives \u003Ccode>noalias\u003C/code> unconditionally, telling LLVM that no other pointer accesses this memory for the referenceâ€™s lifetime. This enables the same optimizations that C achieves through \u003Ccode>restrict\u003C/code>, but the guarantee is compiler-verified rather than programmer-promised.\u003C/p>\n\u003Ch3 id=\"what-the-borrow-checker-sees\">What the Borrow Checker Sees\u003C/h3>\n\u003Cp>The borrow checker does not understand the semantic meaning of operations. It does not know that \u003Ccode>&#x26;data[0]\u003C/code> and \u003Ccode>&#x26;data[1]\u003C/code> are disjoint. It sees borrows and tracks their lifetimes.\u003C/p>\n\u003Cp>Consider this code that the borrow checker rejects:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];    \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// immutable borrow of v\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);         \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// mutable borrow of v for push\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The borrow checker sees:\u003C/p>\n\u003Col>\n\u003Cli>\u003Ccode>&#x26;v[0]\u003C/code> creates a reference with lifetime \u003Ccode>'a\u003C/code>\u003C/li>\n\u003Cli>The reference \u003Ccode>x\u003C/code> must live until \u003Ccode>println!\u003C/code>\u003C/li>\n\u003Cli>\u003Ccode>v.push(4)\u003C/code> requires \u003Ccode>&#x26;mut v\u003C/code>\u003C/li>\n\u003Cli>At the point of \u003Ccode>push\u003C/code>, \u003Ccode>x\u003C/code> is still live\u003C/li>\n\u003Cli>Conflict: cannot have \u003Ccode>&#x26;mut v\u003C/code> while \u003Ccode>&#x26;v\u003C/code> exists\u003C/li>\n\u003C/ol>\n\u003Cp>The borrow checker does not know that \u003Ccode>push\u003C/code> might reallocate the vector, invalidating \u003Ccode>x\u003C/code>. It simply enforces the aliasing rule. As a consequence, it prevents the iterator invalidation bug.\u003C/p>\n\u003Cp>The borrow checker also does not understand that \u003Ccode>&#x26;mut v[0]\u003C/code> and \u003Ccode>&#x26;mut v[1]\u003C/code> are disjoint:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: cannot borrow `arr[_]` as mutable more than once\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The indexing operation \u003Ccode>arr[i]\u003C/code> desugars to a method call that borrows the entire array. The borrow checker sees two mutable borrows of \u003Ccode>arr\u003C/code>, not two borrows of disjoint elements.\u003C/p>\n\u003Ch3 id=\"splitting-borrows\">Splitting Borrows\u003C/h3>\n\u003Cp>The borrow checker understands struct fields as disjoint:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> p\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> px\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> p\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> py\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> p\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">y;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: different fields\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">px\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">py\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This works because the compiler knows that \u003Ccode>p.x\u003C/code> and \u003Ccode>p.y\u003C/code> occupy different memory. They can be borrowed mutably at the same time.\u003C/p>\n\u003Cp>For slices and arrays, the standard library provides \u003Ccode>split_at_mut\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">split_at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// left is &#x26;mut [1, 2], right is &#x26;mut [3, 4]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">left\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">right\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 30\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The implementation of \u003Ccode>split_at_mut\u003C/code> uses unsafe code:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> split_at_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_mut_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    assert!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        (std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">slice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_raw_parts_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">         std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">slice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_raw_parts_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">mid\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">), \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> mid\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The unsafe block constructs two mutable slices from raw pointers. The programmer asserts that the slices do not overlap. The safe interface guarantees this by construction: the slices cover \u003Ccode>[0, mid)\u003C/code> and \u003Ccode>[mid, len)\u003C/code>. This is a very \u003Cem>Rusty\u003C/em> pattern, we are building safe abstractions over unsafe primitives. Users of \u003Ccode>split_at_mut\u003C/code> cannot violate the aliasing rules. The borrow checker verifies that the two returned slices are used correctly.\u003C/p>\n\u003Ch3 id=\"from-rules-to-registers\">From Rules to Registers\u003C/h3>\n\u003Cp>We saw that aliasing information lets the compiler keep values in registers instead of reloading from memory. But the payoff extends beyond eliminating redundant loads. Consider what happens when the compiler tries to vectorize a loop.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> factor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n; i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        dest\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> factor;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If \u003Ccode>dest\u003C/code> and \u003Ccode>src\u003C/code> might overlap, each iteration depends on the previous. A write to \u003Ccode>dest[i]\u003C/code> might modify \u003Ccode>src[i+1]\u003C/code>. The compiler must execute iterations sequentially:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    movss\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">   xmm1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load one float from src\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mulss\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">   xmm1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">xmm0\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            ; multiply by factor\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    movss\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">   [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">xmm1\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           ; store one float to dest\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    add\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    add\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    dec\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rcx\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    jnz\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">     .\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">loop\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>One element per iteration. Almost any modern x86-64 CPU has 256-bit AVX registers that can hold eight floats. We are using 32 bits of that capacity. The other 224 bits sit idle.\u003C/p>\n\u003Cp>Add \u003Ccode>restrict\u003C/code> to promise non-overlap:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> restrict\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> restrict\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> float\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> factor\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; i \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n; i\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        dest\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[i] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> factor;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now the compiler knows iterations are independent:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    vbroadcastss\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> ymm0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">xmm0\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">       ; broadcast factor to all 8 lanes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">loop\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    vmovups\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> ymm1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load 8 floats from src\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    vmulps\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">  ymm1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">ymm1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">ymm0\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">      ; multiply all 8\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    vmovups\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">ymm1\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           ; store 8 floats to dest\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    add\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    add\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">32\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    sub\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rcx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    jnz\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">     .\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">loop\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Eight elements per iteration. For large arrays, this can approach an 8x speedup in some workloads.\u003C/p>\n\u003Cp>In Rust, the equivalent function:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> scale\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">dest\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">src\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">factor\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">d\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">zip\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">src\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">d\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> factor\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The signature encodes the non-aliasing constraint. The borrow checker verifies at call sites that \u003Ccode>dest\u003C/code> and \u003Ccode>src\u003C/code> do not overlap. The compiler passes \u003Ccode>noalias\u003C/code> to LLVM, and LLVM generates the same vectorized loop.\u003C/p>\n\u003Cp>In C, \u003Ccode>restrict\u003C/code> is a promise the programmer can break. In Rust, the borrow checker enforces it. The generated code is identical. The safety guarantee is not.\u003C/p>\n\u003Cp>This is why aliasing rules exist. They are the information the optimizer needs to use the hardware effectively. C provides this through type rules and programmer annotations. Rust provides it through static analysis. The CPU does not care which language we used. It cares whether the instructions match the actual memory access patterns.\u003C/p>\n\u003Chr>\n\u003Cp>Part II will explore what happens when objects own resources that must be released: the question of \u003Cem>who calls free\u003C/em>. C leaves this to the programmer. C++ introduced RAII, binding resource lifetime to object lifetime through constructors and destructors. Rust makes RAII mandatory and tracks ownership in the type system. The aliasing rules we established here, shared XOR mutable, are the foundation that makes Rustâ€™s ownership model possible. If we allow unrestricted aliasing, we cannot reason about who may modify memory. Rustâ€™s borrow checker is, at its core, an aliasing verifier.\u003C/p>",{"headings":642,"localImagePaths":780,"remoteImagePaths":781,"frontmatter":782,"imagePaths":785},[643,644,647,650,653,656,659,662,665,668,671,674,677,680,683,684,687,690,693,696,699,702,705,708,711,714,717,720,723,726,729,732,735,738,741,744,747,750,753,756,759,762,765,768,771,774,777],{"depth":32,"slug":210,"text":555},{"depth":32,"slug":645,"text":646},"memory-is-just-bytes","Memory Is Just Bytes",{"depth":131,"slug":648,"text":649},"virtual-address-space","Virtual Address Space",{"depth":131,"slug":651,"text":652},"alignment","Alignment",{"depth":131,"slug":654,"text":655},"cache-lines-and-memory-bandwidth","Cache Lines and Memory Bandwidth",{"depth":131,"slug":657,"text":658},"the-allocators-view","The Allocatorâ€™s View",{"depth":131,"slug":660,"text":661},"objects-are-bytes","Objects Are Bytes",{"depth":32,"slug":663,"text":664},"from-bytes-to-objects","From Bytes to Objects",{"depth":131,"slug":666,"text":667},"c-effective-type-rules","C: Effective Type Rules",{"depth":131,"slug":669,"text":670},"c-object-lifetime","C++: Object Lifetime",{"depth":131,"slug":672,"text":673},"rust-validity-invariants","Rust: Validity Invariants",{"depth":131,"slug":675,"text":676},"object-representation-vs-value","Object Representation vs. Value",{"depth":32,"slug":678,"text":679},"storage-duration","Storage Duration",{"depth":131,"slug":681,"text":682},"the-four-categories","The Four Categories",{"depth":131,"slug":370,"text":371},{"depth":131,"slug":685,"text":686},"heap","Heap",{"depth":131,"slug":688,"text":689},"who-calls-free","Who Calls Free?",{"depth":131,"slug":691,"text":692},"stack-allocation-in-rust","Stack Allocation in Rust",{"depth":32,"slug":694,"text":695},"object-lifetime","Object Lifetime",{"depth":131,"slug":697,"text":698},"c-lifetime-is-storage-duration","C: Lifetime Is Storage Duration",{"depth":131,"slug":700,"text":701},"c-lifetime-within-storage","C++: Lifetime Within Storage",{"depth":131,"slug":703,"text":704},"rust-lifetimes-as-named-regions","Rust: Lifetimes as Named Regions",{"depth":131,"slug":706,"text":707},"regions-and-the-control-flow-graph","Regions and the Control-Flow Graph",{"depth":131,"slug":709,"text":710},"region-inference-in-rustc","Region Inference in rustc",{"depth":131,"slug":712,"text":713},"constraint-propagation","Constraint Propagation",{"depth":131,"slug":715,"text":716},"non-lexical-lifetimes","Non-Lexical Lifetimes",{"depth":131,"slug":718,"text":719},"lifetimes-across-function-boundaries","Lifetimes Across Function Boundaries",{"depth":131,"slug":721,"text":722},"lifetime-elision","Lifetime Elision",{"depth":131,"slug":724,"text":725},"static","'static",{"depth":32,"slug":727,"text":728},"uninitialized-memory","Uninitialized Memory",{"depth":131,"slug":730,"text":731},"c-indeterminate-values","C: Indeterminate Values",{"depth":131,"slug":733,"text":734},"c-vacuous-initialization-and-implicit-object-creation","C++: Vacuous Initialization and Implicit Object Creation",{"depth":131,"slug":736,"text":737},"rust-immediate-undefined-behavior","Rust: Immediate Undefined Behavior",{"depth":131,"slug":739,"text":740},"move-semantics-and-uninitialization","Move Semantics and Uninitialization",{"depth":131,"slug":742,"text":743},"maybeuninitt-the-escape-hatch","MaybeUninit\u003CT>: The Escape Hatch",{"depth":131,"slug":745,"text":746},"array-initialization","Array Initialization",{"depth":131,"slug":748,"text":749},"raw-pointer-writes","Raw Pointer Writes",{"depth":131,"slug":751,"text":752},"the-vec-pattern","The Vec Pattern",{"depth":131,"slug":754,"text":755},"the-deprecated-memuninitialized","The Deprecated mem::uninitialized",{"depth":32,"slug":757,"text":758},"aliasing","Aliasing",{"depth":131,"slug":760,"text":761},"why-the-compiler-cares","Why the Compiler Cares",{"depth":131,"slug":763,"text":764},"c-type-based-alias-analysis","C: Type-Based Alias Analysis",{"depth":131,"slug":766,"text":767},"the-restrict-qualifier","The restrict Qualifier",{"depth":131,"slug":769,"text":770},"rust-shared-xor-mutable","Rust: Shared XOR Mutable",{"depth":131,"slug":772,"text":773},"what-the-borrow-checker-sees","What the Borrow Checker Sees",{"depth":131,"slug":775,"text":776},"splitting-borrows","Splitting Borrows",{"depth":131,"slug":778,"text":779},"from-rules-to-registers","From Rules to Registers",[],[],{"author":14,"pubDatetime":783,"title":632,"slug":628,"featured":17,"draft":17,"tags":784,"description":635},["Date","2025-12-20T00:00:00.000Z"],[200,634],[],"who-owns-the-memory-pt2",{"id":786,"data":788,"body":793,"filePath":794,"digest":795,"rendered":796},{"author":14,"pubDatetime":789,"title":790,"featured":17,"draft":17,"tags":791,"description":792},["Date","2025-12-23T00:00:00.000Z"],"Who Owns the Memory? Part 2: Ownership, RAII, and move semantics",[200,634],"How C, C++, and Rust decide who calls free","In the [first part](https://lukefleed.xyz/posts/who-owns-the-memory-pt1/) of this series, we saw that objects occupy storage, that storage has duration, and that the type system imposes structure on raw bytes. But we have sidestepped a question that dominates systems programming in practice: when heap-allocated memory must be released, who bears responsibility for releasing it?\n\n## Table of Contents\n\n## Ownership: Who Calls Free?\n\nThe stack is self-managing. When a function returns, the stack pointer moves and automatic storage vanishes. There is no decision to make, no function to call, no possibility of error. The heap is different. Memory obtained through `malloc` persists until someone calls `free`. The allocator cannot know when we are finished with an allocation; only our program logic knows that. And so the burden falls on us.\n\nThis burden is not merely administrative. The consequences of mismanagement are severe and often exploitable. If we free too early, subsequent accesses read garbage or, worse, data that a new allocation has placed there (a use-after-free, the vulnerability class behind a substantial fraction of remote code execution exploits). If we free twice, we corrupt the allocator's metadata; an attacker who controls the timing can often leverage this into arbitrary write primitives. If we never free, we leak, and the process grows until the operating system intervenes.\n\nThe question is how programming languages help us manage this responsibility, or whether they help at all.\n\n### C: Manual Management\n\nC offers two primitives: `malloc` to acquire and `free` to release. Everything else is convention.\n\nConsider a function that opens a file and allocates a read buffer:\n\n```c\ntypedef struct {\n    int fd;\n    char *buffer;\n    size_t capacity;\n} FileReader;\n\nFileReader *filereader_open(const char *path, size_t buffer_size) {\n    FileReader *reader = malloc(sizeof(FileReader));\n    if (!reader) return NULL;\n\n    reader->buffer = malloc(buffer_size);\n    if (!reader->buffer) {\n        free(reader);\n        return NULL;\n    }\n\n    reader->fd = open(path, O_RDONLY);\n    if (reader->fd \u003C 0) {\n        free(reader->buffer);\n        free(reader);\n        return NULL;\n    }\n\n    reader->capacity = buffer_size;\n    return reader;\n}\n```\n\nWe acquire three resources: the struct itself, the buffer, and the file descriptor. Each acquisition can fail, and each failure path must release everything acquired before it. The code above handles this correctly. But observe the shape: the cleanup logic mirrors the acquisition logic in reverse, and we must write it by hand for every function that acquires resources.\n\nThe corresponding cleanup function:\n\n```c\nvoid filereader_close(FileReader *reader) {\n    if (!reader) return;\n    if (reader->fd >= 0) close(reader->fd);\n    free(reader->buffer);\n    free(reader);\n}\n```\n\nWhat happens if we call `filereader_close` twice on the same pointer? The first call closes the descriptor and frees the memory. The second call passes the same address to `free`, corrupting the allocator's free list. The compiler does not warn us.\n\nWhat happens if, between `filereader_open` and `filereader_close`, we reassign `reader->buffer` without freeing the old buffer? We leak. The original allocation becomes unreachable.\n\nThe fundamental problem is that C pointers carry no ownership semantics. When a function declares `void process(FileReader *reader)`, nothing in that signature tells us whether `process` will free the reader, expects us to free it afterward, or assumes it will remain valid for some longer duration. The type `FileReader *` means only \"address of a FileReader\"; it says nothing about responsibility.\n\nLarge C codebases develop conventions to manage this. The Linux kernel uses reference counting for shared structures, with `_get` and `_put` suffixes indicating acquisition and release. GLib uses `_new` for allocation, `_free` for deallocation, and `_ref`/`_unref` for reference-counted objects. These conventions work, but they are conventions, patterns enforced by code review rather than by the compiler. Every violation is a latent bug.\n\n### C++: Binding Cleanup to Scope\n\nC++ exploits a property that C has but does not leverage: local variables have a well-defined scope, and when that scope ends, the variable ceases to exist. The language allows us to attach custom cleanup logic to that moment through destructors.\n\nA destructor is a special member function, denoted `~ClassName()`, that the compiler calls automatically when an object's lifetime ends. The call is not optional. It happens regardless of how control flow exits the scope: normal return, early return, exception propagation.\n\n```cpp\nclass FileReader {\npublic:\n    explicit FileReader(const char *path, size_t buffer_size)\n        : buffer_(new char[buffer_size])\n        , capacity_(buffer_size)\n        , fd_(::open(path, O_RDONLY))\n    {\n        if (fd_ \u003C 0) {\n            delete[] buffer_;\n            throw std::system_error(errno, std::generic_category());\n        }\n    }\n\n    ~FileReader() {\n        if (fd_ >= 0) ::close(fd_);\n        delete[] buffer_;\n    }\n\n    FileReader(const FileReader &) = delete;\n    FileReader &operator=(const FileReader &) = delete;\n\nprivate:\n    char *buffer_;\n    size_t capacity_;\n    int fd_;\n};\n```\n\nWhen we write:\n\n```cpp\nvoid process_file(const char *path) {\n    FileReader reader(path, 4096);\n    do_something(reader);\n}\n```\n\nthe compiler generates an implicit call to `~FileReader()` at the closing brace, regardless of whether `do_something` returns normally or throws. We did not write this call; the language guarantees it.\n\nThe destruction sequence is precise. After executing the destructor body and destroying any automatic objects declared within it, the compiler destroys all non-static data members in reverse order of their declaration, then all direct base classes in reverse order of construction. This reverse ordering matters: later-declared members may depend on earlier ones, so we tear down in the opposite order we built up.\n\nConsider what this means for exception safety. If any operation between resource acquisition and release throws, the destructor still runs during stack unwinding. We do not need explicit cleanup code on every exit path. The resource management logic is written once, in the destructor, and the compiler inserts the call at every point where it is needed.\n\nThe standard library provides RAII wrappers for common resources: `std::unique_ptr` for exclusive ownership of heap memory, `std::shared_ptr` for reference-counted shared ownership, `std::lock_guard` for mutexes, `std::fstream` for files. Using these types, we rarely write `new` or `delete` directly.\n\nBut RAII in C++ is opt-in. Nothing prevents us from writing:\n\n```cpp\nvoid leaky() {\n    int *p = new int[1000];\n    // forgot delete[]\n}\n```\n\nNothing prevents extracting a raw pointer and misusing it:\n\n```cpp\nvoid dangling() {\n    int *raw;\n    {\n        auto owner = std::make_unique\u003Cint>(42);\n        raw = owner.get();\n    }  // owner destroyed here\n    *raw = 10;  // use-after-free\n}\n```\n\nThe compiler does not track which pointers own and which merely observe. We can bypass RAII entirely with raw `new` and `delete`. We can hold raw pointers past their owners' lifetimes. We can `delete` through a base class pointer when the destructor is not virtual, which is undefined behavior even if no resources would leak, because the derived destructor never runs.\n\nC++ gives us the machinery for safe resource management. Using that machinery is a choice the language cannot enforce. A codebase mixing raw pointers, `unique_ptr`, `shared_ptr`, and manual `new`/`delete` requires reasoning about ownership at every function boundary. The answer is not in the types; it is in the programmers' heads, in comments, in coding standards. This is better than C, where even the machinery does not exist. But it is not sufficient to eliminate memory safety bugs from large codebases.\n\n\n### Rust: Ownership in the Type System\n\nRust takes the RAII pattern and embeds it into the type system as a non-negotiable rule: every value has exactly one owner, and when that owner goes out of scope, the value is dropped. This is not a convention that programmers may follow or ignore. It is a property that the compiler verifies statically.\n\nConsider what happens when we allocate a vector:\n\n```rust\nfn example() {\n    let v = vec![1, 2, 3];\n}\n```\n\nThe binding `v` owns the heap-allocated buffer. When `v` goes out of scope at the closing brace, Rust calls `drop` on the `Vec`, which deallocates the buffer. We cannot accidentally forget to free the memory.\n\nThe critical mechanism is the move. When we assign a value to another binding, ownership transfers:\n\n```rust\nlet v1 = vec![1, 2, 3];\nlet v2 = v1;\n```\n\nAfter this assignment, `v1` is no longer valid. Any attempt to use it is a compile-time error. This is not a shallow copy followed by invalidation of the source, as in C++ move semantics where the moved-from object remains in a \"valid but unspecified state\" that we can still inspect and call methods on. In Rust, ownership transfer means the source binding ceases to exist as far as the type system is concerned. The compiler marks it as uninitialized. There is no moved-from state.\n\nWhy does this matter? Consider what would happen without this rule. If both `v1` and `v2` were valid after the assignment, both would attempt to free the same buffer when they went out of scope. The move rule makes double-free impossible: exactly one binding owns the allocation at any time, and exactly one drop occurs.\n\nThe same logic applies to function calls. When we pass a value to a function, ownership transfers to the function's parameter:\n\n```rust\nfn consume(v: Vec\u003Ci32>) {\n    // v is owned here; dropped at end of function\n}\n\nfn main() {\n    let data = vec![1, 2, 3];\n    consume(data);\n    // data is no longer valid here\n}\n```\n\nThe function signature `fn consume(v: Vec\u003Ci32>)` declares that `consume` takes ownership. The caller cannot use `data` after the call because ownership has moved. Compare this to `fn borrow(v: &Vec\u003Ci32>)`, which borrows without taking ownership, or `fn mutate(v: &mut Vec\u003Ci32>)`, which borrows mutably. The type encodes the ownership relationship. \n\n#### The Drop Trait and Recursive Destruction\n\nWhen a value goes out of scope, Rust runs its destructor. For types that implement the `Drop` trait, this means calling the `drop` method:\n\n```rust\nstruct FileHandle {\n    fd: i32,\n}\n\nimpl Drop for FileHandle {\n    fn drop(&mut self) {\n        unsafe { libc::close(self.fd); }\n    }\n}\n```\n\nThe `drop` method receives `&mut self`, not `self`. We cannot move out of `self` during drop because drop takes a mutable reference. This prevents us from returning the inner file descriptor to avoid closing it. When `drop` returns, the value is gone.\n\nAfter `drop` executes, Rust recursively drops all fields of the struct. This is automatic and unavoidable. If we have:\n\n```rust\nstruct Connection {\n    socket: TcpStream,\n    buffer: Vec\u003Cu8>,\n}\n```\n\nand `Connection` does not implement `Drop`, Rust still drops `socket` and `buffer` when a `Connection` goes out of scope. The compiler generates this \"drop glue\" for every type that needs it. We do not write boilerplate to drop children; the language handles it. If `Connection` does implement `Drop`, Rust first calls our `drop` method, then drops the fields. We cannot prevent the recursive field drops. After our `drop` returns, the fields will be dropped regardless of what we did.\n\nThe destruction order is deterministic and specified by the language. For local variables, drop order is the reverse of declaration order: later declarations are dropped first. The rationale is that later variables may hold references to earlier ones, so we must destroy the borrowers before the borrowed. For struct fields, drop order is declaration order (not reversed). For tuples, elements drop in order. For arrays, elements drop from index 0 to the end. For enums, only the active variant's fields are dropped. Closure captures by move are dropped in an unspecified order, so if destruction order among captured values matters, do not rely on closure drop order.\n\n#### ManuallyDrop and Suppressing Automatic Destruction\n\nThe recursive drop behavior creates a problem when we need fine-grained control over destruction. Consider a type that wraps a `Box` and wants to deallocate the contents in a custom way:\n\n```rust\nstruct SuperBox\u003CT> {\n    my_box: Box\u003CT>,\n}\n\nimpl\u003CT> Drop for SuperBox\u003CT> {\n    fn drop(&mut self) {\n        unsafe {\n            // Deallocate the box's contents ourselves\n            let ptr = Box::into_raw(self.my_box);  // ERROR: cannot move out of &mut self\n            std::alloc::dealloc(ptr as *mut u8, Layout::new::\u003CT>());\n        }\n    }\n}\n```\n\nThis does not compile. We cannot move `self.my_box` out of `&mut self`. And even if we could, after our `drop` returns, Rust would try to drop `my_box` again, causing a double-free.\n\nOne solution is `Option`:\n\n```rust\nstruct SuperBox\u003CT> {\n    my_box: Option\u003CBox\u003CT>>,\n}\n\nimpl\u003CT> Drop for SuperBox\u003CT> {\n    fn drop(&mut self) {\n        if let Some(b) = self.my_box.take() {\n            // Handle b ourselves; self.my_box is now None\n            // When Rust drops self.my_box, it drops None, which does nothing\n        }\n    }\n}\n```\n\nThis works, but it pollutes our type with `Option` semantics. A field that should always be `Some` must be declared as `Option` solely because of what happens in the destructor. Every access to `my_box` elsewhere in the code must handle the `None` case that should never occur outside of `drop`.\n\n`ManuallyDrop\u003CT>` provides a cleaner solution. It is a wrapper that suppresses automatic drop for its contents:\n\n```rust\nuse std::mem::ManuallyDrop;\n\nstruct SuperBox\u003CT> {\n    my_box: ManuallyDrop\u003CBox\u003CT>>,\n}\n\nimpl\u003CT> Drop for SuperBox\u003CT> {\n    fn drop(&mut self) {\n        unsafe {\n            // Take ownership of the inner Box\n            let b = ManuallyDrop::take(&mut self.my_box);\n            // Now we own b and can do whatever we want\n            // When our drop returns, Rust will \"drop\" self.my_box,\n            // but ManuallyDrop's drop is a no-op\n        }\n    }\n}\n```\n\n`ManuallyDrop\u003CT>` has the same size and alignment as `T`. It implements `Deref` and `DerefMut`, so we can use the wrapped value normally. But when Rust drops a `ManuallyDrop\u003CT>`, nothing happens. The inner `T` is not dropped. We are responsible for dropping it manually via `ManuallyDrop::drop(&mut x)` or taking ownership via `ManuallyDrop::take(&mut x)`.\n\nThis is useful beyond custom destructors. When we need to move a value out of a context where Rust would normally drop it, `ManuallyDrop` lets us suppress that drop and handle the value ourselves. The `unsafe` is required because we are taking responsibility for ensuring the value is eventually dropped (or intentionally leaked).\n\n#### Drop Flags and Conditional Initialization\n\nRust tracks initialization state at compile time when possible. But consider:\n\n```rust\nlet x;\nif condition {\n    x = Box::new(0);\n}\n```\n\nAt the end of scope, should Rust drop `x`? It depends on whether `condition` was true. When the compiler cannot determine initialization state statically, it inserts a runtime drop flag: a hidden boolean that tracks whether the value was initialized. At scope exit, Rust checks the flag before calling drop.\n\nFor straight-line code and branches that initialize consistently, the compiler can eliminate these flags through static analysis. The flags exist only when genuinely necessary, and the generated code checks them only at points where the initialization state is ambiguous.\n\n#### You Cannot Call Drop Directly\n\nRust prevents explicit calls to the `Drop::drop` method:\n\n```rust\nlet v = vec![1, 2, 3];\nv.drop();  // error: explicit use of destructor method\n```\n\nIf we could call `drop` directly, the value would still be in scope afterward. When the scope ends, Rust would call `drop` again. Instead, we use `std::mem::drop` for early cleanup:\n\n```rust\nlet v = vec![1, 2, 3];\ndrop(v);  // v is moved into drop() and dropped there\n```\n\nThe `drop` function takes ownership by value: `fn drop\u003CT>(_: T) {}`. The value moves into the function and is dropped when the function returns. Since ownership moved, the original binding is invalid and no second drop occurs.\n\n#### Drop Check: When Lifetimes and Destructors Collide\n\nWe now arrive at a subtle interaction between Rust's lifetime system and its destructor semantics. Consider this seemingly innocuous code:\n\n```rust\nstruct Inspector\u003C'a>(&'a u8);\n\nstruct World\u003C'a> {\n    inspector: Option\u003CInspector\u003C'a>>,\n    days: Box\u003Cu8>,\n}\n\nfn main() {\n    let mut world = World {\n        inspector: None,\n        days: Box::new(1),\n    };\n    world.inspector = Some(Inspector(&world.days));\n}\n```\n\nThis compiles. The `Inspector` holds a reference to `days`, both are fields of `World`, and when `world` goes out of scope, both are dropped. The fact that `days` does not strictly outlive `inspector` does not matter here because neither has a destructor that could observe the other.\n\nBut watch what happens when we add a `Drop` impl to `Inspector`:\n\n```rust\nstruct Inspector\u003C'a>(&'a u8);\n\nimpl\u003C'a> Drop for Inspector\u003C'a> {\n    fn drop(&mut self) {\n        println!(\"I was only {} days from retirement!\", self.0);\n    }\n}\n\nstruct World\u003C'a> {\n    inspector: Option\u003CInspector\u003C'a>>,\n    days: Box\u003Cu8>,\n}\n\nfn main() {\n    let mut world = World {\n        inspector: None,\n        days: Box::new(1),\n    };\n    world.inspector = Some(Inspector(&world.days));\n}\n```\n\nThis does not compile:\n\n```\nerror[E0597]: `world.days` does not live long enough\n```\n\nWhat changed? The `Drop` implementation. When `Inspector` has a destructor, that destructor might access the reference it holds. If `days` is dropped before `inspector`, the destructor would dereference freed memory. The borrow checker must now enforce that any data borrowed by `Inspector` outlives the `Inspector` itself, because the destructor could observe that data.\n\nThis is the drop checker (dropck). It enforces a stricter rule when types have destructors: for a generic type to soundly implement drop, its generic arguments must strictly outlive it. Not _live at least as long as_, but _strictly outlive_. The difference is subtle. Without a destructor, two values can go out of scope simultaneously because neither observes the other during destruction. With a destructor, the type with the destructor might observe its borrowed data, so that data must still be valid when the destructor runs.\n\nOnly generic types need to worry about this. If a type is not generic, the only lifetimes it can contain are `'static`, which truly lives forever. The problem arises when a type is generic over a lifetime or a type parameter, and it implements `Drop`, and that `Drop` could potentially access the borrowed data.\n\n#### The `#[may_dangle]` Escape Hatch\n\nThe drop checker is conservative. It assumes that any `Drop` impl for a generic type might access data of the generic parameter. But this is often not true. Consider `Vec\u003CT>`:\n\n```rust\nimpl\u003CT> Drop for Vec\u003CT> {\n    fn drop(&mut self) {\n        // Deallocate the buffer\n        // We DO drop each T element, but we don't \"use\" T in the sense\n        // of accessing references that T might contain\n    }\n}\n```\n\nWhen we drop a `Vec\u003C&'a str>`, we deallocate the buffer. We do call drop on each `&'a str` element, but `&'a str` has no destructor; its drop is a no-op. The `Vec`'s drop does not actually dereference those `&'a str` values. It does not read the strings. It just deallocates the backing memory.\n\nYet the drop checker does not know this. It sees `impl\u003C'a> Drop for Vec\u003C&'a str>` and concludes that `'a` must strictly outlive the `Vec`. This prevents code like:\n\n```rust\nfn main() {\n    let mut v: Vec\u003C&str> = Vec::new();\n    let s: String = \"Short-lived\".into();\n    v.push(&s);\n    drop(s);  // s dropped while v still holds a reference\n}\n```\n\nThis is correctly rejected. But it also rejects:\n\n```rust\nfn main() {\n    let mut v: Vec\u003C&str> = Vec::new();\n    let s: String = \"Short-lived\".into();\n    v.push(&s);\n}  // s and v dropped here, but in what order?\n```\n\nThe second example should be fine. Both `v` and `s` are dropped at the end of `main`. Variables are dropped in reverse declaration order, so `v` drops first, then `s`. By the time `s` drops, `v` is already gone. The references in `v` are never dereferenced during `v`'s destruction.\n\nTo allow this pattern, Rust provides an unstable, unsafe attribute: `#[may_dangle]`. It tells the drop checker \"I promise not to access this generic parameter in my destructor\":\n\n```rust\nunsafe impl\u003C#[may_dangle] T> Drop for Vec\u003CT> {\n    fn drop(&mut self) {\n        // ...\n    }\n}\n```\n\nThe `#[may_dangle]` on `T` is a promise that the `Drop` impl does not access `T` values in a way that requires them to be valid. The drop checker relaxes its requirements: `T` may now dangle (be a reference to freed memory) when the `Vec` is dropped.\n\nBut this is a lie, or at least an incomplete truth. `Vec\u003CT>`'s destructor does drop each `T` element. If `T` has a destructor that accesses borrowed data, that data must still be valid. The promise is more precisely: \"I do not access `T` myself, but I may trigger `T`'s destructor.\" This distinction matters for the soundness of the overall system.\n\n#### PhantomData and Drop Check Interaction\n\nWhen we use `#[may_dangle]`, we are opting out of the drop checker's conservative assumptions. But we must opt back in for cases where we do transitively drop `T`. This is where `PhantomData` enters the picture.\n\nConsider the actual implementation of `Vec`:\n\n```rust\nstruct Vec\u003CT> {\n    ptr: *const T,  // raw pointer, no ownership semantics\n    len: usize,\n    cap: usize,\n}\n```\n\nA raw pointer `*const T` does not imply ownership. The drop checker does not assume that `Vec` owns `T` values just because it contains a `*const T`. If we write:\n\n```rust\nunsafe impl\u003C#[may_dangle] T> Drop for Vec\u003CT> {\n    fn drop(&mut self) {\n        // drop elements, deallocate buffer\n    }\n}\n```\n\nwe have told the drop checker that `T` may dangle. But `Vec` does own `T` values and does drop them. If `T` is `PrintOnDrop\u003C'a>` (a type with a destructor that dereferences `'a`), then `'a` must be valid when `Vec` drops, because `Vec` will invoke `T`'s destructor.\n\nWe need to tell the drop checker: \"`T` may dangle, except if `T` itself has drop glue that would observe borrowed data.\" The mechanism for this is `PhantomData\u003CT>`:\n\n```rust\nuse std::marker::PhantomData;\n\nstruct Vec\u003CT> {\n    ptr: *const T,\n    len: usize,\n    cap: usize,\n    _marker: PhantomData\u003CT>,\n}\n```\n\n`PhantomData\u003CT>` is a zero-sized type that tells the compiler \"act as if this struct owns a `T`.\" It affects variance, auto-trait inference, and critically, drop check. When the drop checker sees `PhantomData\u003CT>` in a struct, it knows that dropping the struct may involve dropping `T` values.\n\nThe interaction is:\n\n1. `#[may_dangle] T` on the `Drop` impl says \"I promise not to access `T` directly in my destructor.\"\n2. `PhantomData\u003CT>` in the struct says \"but I do own `T` values and will drop them.\"\n3. The drop checker combines these: `T` itself may dangle (its references may be invalid), but if `T` has drop glue, that glue will run, and whatever `T`'s glue accesses must still be valid.\n\nThis is subtle. Suppose `T` is `&'a str`. The type `&'a str` has no destructor (dropping a reference is a no-op). So `PhantomData\u003C&'a str>` does not introduce additional constraints. The `#[may_dangle]` applies fully, and `'a` may dangle.\n\nNow suppose `T` is `PrintOnDrop\u003C'a>`, a type with a destructor that dereferences `'a`. The `PhantomData\u003CPrintOnDrop\u003C'a>>` tells the drop checker that `Vec` will drop `PrintOnDrop\u003C'a>` values. The `#[may_dangle]` says `Vec` itself won't access `'a`. But dropping `PrintOnDrop\u003C'a>` will access `'a`. So `'a` must still be valid when `Vec` is dropped, despite the `#[may_dangle]`.\n\nThe rules compose correctly. The `#[may_dangle]` is not a blanket permission to let everything dangle. It is permission for the specific `Drop` impl to not access the parameter, combined with the `PhantomData` indicating that transitive drops may still occur.\n\nWithout `#[may_dangle]`, implementing a collection like `Vec` would be unnecessarily restrictive. Every `Vec\u003C&'a T>` would require `'a` to strictly outlive the `Vec`, even when the `Vec` is dropped before the borrowed data goes out of scope. The combination of `#[may_dangle]` and `PhantomData` allows the standard library to express the precise ownership semantics: \"we will drop `T` values, but we do not otherwise observe them in our destructor.\"\n\n#### Leaks Are Safe\n\nHere we encounter a design decision that surprises many: leaking memory is safe in Rust. The function `std::mem::forget` takes ownership of a value and does not run its destructor:\n\n```rust\nlet v = vec![1, 2, 3];\nstd::mem::forget(v);\n// v's destructor never runs; the heap allocation is leaked\n```\n\nThis is a safe function. It does not require `unsafe`. The reasoning is that _safe_ in Rust means _cannot cause undefined behavior_. Leaking memory is wasteful, but it does not corrupt memory, create dangling pointers, or cause data races. A program that leaks is buggy but not undefined.\n\nMoreover, leaks can occur in safe code without calling `forget`. The simplest example is a reference cycle with `Rc`:\n\n```rust\nuse std::cell::RefCell;\nuse std::rc::Rc;\n\nstruct Node {\n    next: Option\u003CRc\u003CRefCell\u003CNode>>>,\n}\n\nfn create_cycle() {\n    let a = Rc::new(RefCell::new(Node { next: None }));\n    let b = Rc::new(RefCell::new(Node { next: Some(a.clone()) }));\n    a.borrow_mut().next = Some(b.clone());\n}\n```\n\nWhen `create_cycle` returns, the `Rc`s go out of scope, but each has a reference count of 2 due to the cycle. The count decrements to 1, not 0. The nodes are never freed. This is safe code with no `unsafe` blocks, and it leaks.\n\nSince leaks are possible in safe code, the language cannot assume destructors always run. This has profound implications for unsafe code. Any type whose safety invariants depend on the destructor running is unsound in the presence of `mem::forget` or cycles.\n\nThe standard library learned this lesson with `thread::scoped`, an API that allowed spawning threads referencing stack data. It relied on a guard whose destructor joined the thread:\n\n```rust\npub fn scoped\u003C'a, F>(f: F) -> JoinGuard\u003C'a>\nwhere F: FnOnce() + Send + 'a\n```\n\nThe guard's lifetime tied it to the borrowed data. When the guard dropped, it joined the thread, ensuring the thread finished before the data went out of scope. But `mem::forget(guard)` prevented the destructor from running. The thread would continue executing while the stack data it referenced was freed. Use-after-free from safe code. The API was unsound and had to be removed.\n\nThe correct design principle is that unsafe code cannot rely on destructors running to maintain safety invariants. Safe abstractions must account for the possibility that destructors are skipped. The standard library's `Vec::drain` is a good example. Draining a vector moves elements out one at a time. If the drain iterator is forgotten mid-iteration, some elements have been moved out and the vector's length is wrong. Rather than leaving the vector in an inconsistent state, `Drain` sets the vector's length to zero at the start of iteration. If `Drain` is forgotten, the remaining elements leak (their destructors do not run, their memory is not reused), but the vector is in a valid state (empty). Leaks amplify leaks, but undefined behavior does not occur.\n\n\n## Beyond RAII\n\nWe have built a comprehensive picture of ownership. Rust makes ownership tracking mandatory and statically verified. Yet even Rust's model has limits.\n\n### The Single-Destructor Problem\n\nThe RAII model, whether in C++ or Rust, shares a structural limitation: the destructor is a single, parameterless function that returns nothing. When an object goes out of scope, exactly one action occurs. We cannot choose between alternatives. We cannot pass runtime information to the cleanup logic. We cannot receive a result from it.\n\nFor many resources this constraint is invisible. A file handle has one sensible cleanup action: close the descriptor. A heap allocation has one cleanup action: free the memory. A mutex guard has one cleanup action: unlock the mutex. The destructor does the obvious thing, and the single-destructor model works well.\n\nBut consider a database transaction. A transaction must eventually either commit (make changes permanent) or rollback (discard changes). These are fundamentally different operations with different semantics, different failure modes, and often different parameters. A commit might require a priority level. A rollback might need to log the reason for abandonment. The destructor cannot accommodate this. It must pick one.\n\nThe standard workaround in C++ and Rust is to default to rollback and provide an explicit `commit` method:\n\n```cpp\nclass Transaction {\npublic:\n    explicit Transaction(Database& db) : db_(db), committed_(false) {\n        db_.begin();\n    }\n    \n    void commit() {\n        db_.commit();\n        committed_ = true;\n    }\n    \n    ~Transaction() {\n        if (!committed_) {\n            db_.rollback();\n        }\n    }\n\nprivate:\n    Database& db_;\n    bool committed_;\n};\n```\n\nWe call `commit()` when the transaction succeeds and let the destructor rollback on error paths or early returns. Exception safety falls out naturally; if an exception propagates, the destructor runs, and uncommitted transactions rollback.\n\nThe problem is that forgetting to call `commit()` is not a compile-time error. If we write a function that successfully completes its work but neglects to call `commit()`, the destructor happily rolls back. The program is wrong, but the compiler cannot tell us. We have traded one category of bug (forgetting to cleanup) for another (forgetting to finalize). The second category is arguably more insidious because the cleanup happens, silently doing the wrong thing.\n\nRust's ownership system does not help here:\n\n```rust\nstruct Transaction\u003C'a> {\n    db: &'a mut Database,\n    committed: bool,\n}\n\nimpl\u003C'a> Transaction\u003C'a> {\n    fn commit(mut self) {\n        self.db.commit();\n        self.committed = true;\n    }\n}\n\nimpl\u003C'a> Drop for Transaction\u003C'a> {\n    fn drop(&mut self) {\n        if !self.committed {\n            self.db.rollback();\n        }\n    }\n}\n```\n\nThe `commit` method takes `self` by value, consuming the transaction. After calling `commit`, the binding is gone. But if we never call `commit`, the transaction goes out of scope, `drop` runs, and we rollback. No compiler error. The type system tracked ownership but not obligation.\n\n### Defer: Explicit Scope-Bound Cleanup\n\nSome languages take a different approach. Rather than binding cleanup to object destruction, they provide explicit defer statements that execute at scope exit.\n\nZig's `defer` runs an expression unconditionally when control leaves the enclosing block:\n\n```zig\nfn processFile(path: []const u8) !void {\n    const file = try std.fs.cwd().openFile(path, .{});\n    defer file.close();\n    \n    const buffer = try allocator.alloc(u8, 4096);\n    defer allocator.free(buffer);\n    \n    // work with file and buffer\n    // both are cleaned up when we exit, regardless of how\n}\n```\n\nThe cleanup code sits immediately after the acquisition code. We see allocation and deallocation together, which aids comprehension. Zig extends this with `errdefer`, which executes only if the function returns an error, separating error-path cleanup from success-path transfer.\n\nThe defer model has a structural limitation that RAII does not: the cleanup is scope-bound. We cannot return a resource to our caller the way we return an RAII object. The defer runs when the current scope exits, period. RAII is more flexible; we can return an RAII object, store it in a data structure, transfer ownership to another thread. The cleanup travels with the object. Defer is local; RAII is transferable.\n\nBut defer has an advantage in simplicity. We do not need to define a type, implement a trait, worry about drop order among struct fields. We write the cleanup code inline, at the point of acquisition. For resources that do not leave the current function, defer is often cleaner.\n\n### Linear Types: Enforcing Explicit Consumption\n\nThe transaction example shows a gap in RAII's guarantees. RAII ensures that cleanup happens, but not that we made an explicit decision about *which* cleanup to perform. The destructor chooses for us, silently.\n\nLinear types close this gap. A linear type must be explicitly consumed; it cannot simply go out of scope. If we try to let a linear value fall out of scope without passing it to a consuming function, the compiler rejects the program.\n\nConsider a hypothetical extension to Rust:\n\n```rust\n// Hypothetical syntax\n#[linear]\nstruct Transaction { db: Database }\n\nfn commit(txn: Transaction) -> Result\u003C(), Error> {\n    txn.db.commit()?;\n    destruct txn;  // explicitly consume\n    Ok(())\n}\n\nfn rollback(txn: Transaction, reason: &str) {\n    txn.db.rollback();\n    destruct txn;  // explicitly consume\n}\n\nfn do_work(db: Database) {\n    let txn = Transaction { db };\n    // ERROR: `txn` goes out of scope without being consumed\n    // must call either commit(txn) or rollback(txn, ...)\n}\n```\n\nThe transaction cannot be ignored. Forgetting to decide is a compile-time error, not a runtime silent rollback. Languages with linear types (Vale, Austral, and to some extent Haskell with LinearTypes) can express patterns that RAII cannot.\n\n### Why Rust Does Not Have Linear Types\n\nRust's types are affine, not linear. An affine type can be used *at most* once; a linear type must be used *exactly* once. The difference matters when panics unwind the stack.\n\nRust permits silent dropping because `Drop::drop` must always be callable. When a scope exits, when a panic unwinds, when we reassign a variable, Rust calls `drop`. The entire language assumes that any value can be dropped at any time.\n\nLinear types would break this assumption. If a value must be explicitly consumed, what happens when a panic unwinds through a function holding that value? The unwinding code cannot know which consuming function to call, what parameters to pass, what to do with the return value. Every generic container, every iterator adapter, every function that might discard a value would need to be reconsidered.\n\nRust chose affine types, accepting that the compiler cannot enforce explicit consumption but gaining a simpler model where any value can be dropped. The `#[must_use]` attribute provides a weaker guarantee: a warning (not an error) if a value is unused. It catches some mistakes but does not provide the hard guarantee that linear types would.\n\n\n## Move Semantics\n\nAll this discussion about ownership assumes that ownership can be transferred efficiently. When we say a value \"moves\" from one binding to another, what actually happens to the bytes? And why is this operation preferable to copying?\n\nThe answer varies dramatically across C, C++, and Rust, and the differences expose fundamental assumptions each language makes about values, identity, and resources.\n\n### The Cost of Copies\n\nConsider what happens when we pass a value to a function. In the simplest model, the caller's value is copied into the callee's parameter. For a 32-bit integer, this means copying 4 bytes, negligible. But what about a dynamically-sized container?\n\nA `std::vector\u003Cint>` in C++ or a `Vec\u003Ci32>` in Rust has a particular structure: a pointer to heap-allocated storage, a length, and a capacity. The struct itself is small (typically 24 bytes on 64-bit systems), but it can own a large heap allocation.\n\n```cpp\nstruct Vec {\n    int* data;     // 8 bytes\n    size_t len;    // 8 bytes  \n    size_t cap;    // 8 bytes\n};\n// sizeof(Vec) == 24, but data might point to way more memory\n```\n\nIf we copy this struct byte-for-byte, we produce two `Vec` instances pointing to the same heap allocation. This is a shallow copy. It creates a problem: both instances believe they own the memory. When one destructor frees it, the other's pointer dangles. When the second destructor runs, it double-frees.\n\nThe alternative is a deep copy: allocate new heap storage, copy all data, and update the new struct's pointer. This is correct but expensive. Copying takes time. More importantly, it allocates memory, which involves a system call (or at minimum, allocator bookkeeping) and pollutes the cache with data we may never touch again.\n\nThe overhead becomes prohibitive when values pass through function boundaries repeatedly. A function that takes a `vector` by value, processes it, and returns a new `vector` might copy millions of bytes twiceÃ¢â‚¬â€once on entry, once on return. In performance-sensitive code, we want to avoid passing large objects by value entirely, preferring pointers or references. But this complicates APIs and obscures ownership.\n\n### The Shallow Copy Escape\n\nWe can observe however that when we pass a vector to a function that consumes it, the caller no longer needs its copy. The bytes in the caller's stack frame become dead immediately after the call. If we could somehow *transfer* ownership without physically duplicating the heap data, we would get the clarity of value semantics with the efficiency of pointer passing.\n\nThis is exactly what move semantics provide. Instead of copying the entire data structure, we copy only the struct (the pointer, length, and capacity), then invalidate the source somehow so it does not attempt cleanup.\n\nThe _somehow_ is where languages diverge.\n\nIn C, there is no language-level support. We must implement this manually:\n\n```c\ntypedef struct {\n    int* data;\n    size_t len;\n    size_t cap;\n} Vec;\n\nvoid transfer(Vec* dest, Vec* src) {\n    *dest = *src;           // shallow copy the struct\n    src->data = NULL;       // invalidate source\n    src->len = 0;\n    src->cap = 0;\n}\n```\n\nAfter `transfer`, the destination owns the heap memory, and the source is in a _moved-from_ state (nulled pointers, zero sizes). This works, but nothing enforces it. We can still access `src->data` after the transfer. However, we would read NULL, or worse, the invalidation was forgotten and we would read a pointer that someone else will free.\n\n### C++11: Rvalue References and Move Semantics\n\nBefore C++11, the language had one kind of reference: the lvalue reference, written `T&`. An lvalue is roughly \"something with a name and an address\", a variable, a dereferenced pointer, an array element. Lvalue references bind to lvalues and provide aliased access to existing objects.\n\nBut consider a temporary:\n\n```cpp\nstd::vector\u003Cint> make_vector() {\n    return std::vector\u003Cint>{1, 2, 3, 4, 5};\n}\n\nvoid consume(std::vector\u003Cint> v);\n\nconsume(make_vector());  // the argument is a temporary\n```\n\nThe return value of `make_vector()` is not an lvalue, it has no name, no persistent storage, no address we can take. It is an rvalue, a temporary that will be destroyed at the end of the full expression. Before C++11, passing this temporary to `consume` meant copying it, even though the original was about to disappear. We duplicated data that would be destroyed moments later.\n\nC++11 introduced rvalue references, written `T&&`. An rvalue reference binds to rvalues; temporaries, expressions, values returned by functions. The type system now distinguishes \"I want to observe this object\" (`const T&`) from \"I want to steal from this object\" (`T&&`).\n\nThis distinction enables overloading. A class can define two versions of a constructor:\n\n```cpp\nclass vector {\npublic:\n    // Copy constructor: source is const lvalue reference\n    vector(const vector& other) {\n        data_ = new int[other.cap_];\n        std::copy(other.data_, other.data_ + other.len_, data_);\n        len_ = other.len_;\n        cap_ = other.cap_;\n    }\n    \n    // Move constructor: source is rvalue reference\n    vector(vector&& other) noexcept {\n        data_ = other.data_;\n        len_ = other.len_;\n        cap_ = other.cap_;\n        // Invalidate source\n        other.data_ = nullptr;\n        other.len_ = 0;\n        other.cap_ = 0;\n    }\n};\n```\n\nWhen the argument is an rvalue (a temporary, or the result of `std::move`), overload resolution selects the move constructor. We perform the shallow copy and invalidate the source, exactly as in the C version, but now the selection happens automatically based on value category.\n\nThe key insight is that `std::move` does not move anything. It is a cast:\n\n```cpp\ntemplate\u003Ctypename T>\nconstexpr std::remove_reference_t\u003CT>&& move(T&& t) noexcept {\n    return static_cast\u003Cstd::remove_reference_t\u003CT>&&>(t);\n}\n```\n\nIt takes a reference (of any kind, due to reference collapsing) and returns an rvalue reference to the same object. The object does not move. We simply change how the type system categorizes it.\n\nThis cast enables us to move from named variables:\n\n```cpp\nstd::vector\u003Cint> v1{1, 2, 3};\nstd::vector\u003Cint> v2 = std::move(v1);  // v1 cast to rvalue, move constructor called\n```\n\nAfter this line, `v2` owns the heap allocation that `v1` previously owned. `v1` is in a moved-from state: its data pointer is null, its length and capacity are zero. The destructor will run when `v1` goes out of scope, but it will do nothing because there is nothing to free.\n\n#### The Implicitly-Declared Move Constructor\n\nThe compiler can generate move constructors automatically. If a class has no user-declared copy constructor, copy assignment operator, move assignment operator, or destructor, the compiler declares an implicit move constructor. This implicit version performs member-wise move: for each non-static data member, it moves that member using the member's own move constructor (or copies it, for types without move constructors).\n\n```cpp\nstruct Wrapper {\n    std::vector\u003Cint> data;\n    std::string name;\n    int id;\n    // implicit move constructor:\n    // Wrapper(Wrapper&& other) noexcept\n    //     : data(std::move(other.data))\n    //     , name(std::move(other.name))\n    //     , id(other.id) {}  // int is trivially movable (just copied)\n};\n```\n\nFor trivially movable types (essentially, types compatible with C), the move constructor copies the object representation as if by `std::memmove`. No per-member move occurs at runtime; the operation reduces to a memory copy of the struct's bytes.\n\nThe rule about user-declared special member functions is important. If we declare a destructor (even a defaulted one), the implicit move constructor is not generated:\n\n```cpp\nstruct C {\n    std::vector\u003Cint> data;\n    ~C() {}  // destructor declared, even though empty\n};\n\nC c1;\nC c2 = std::move(c1);  // calls copy constructor, not move!\n```\n\nThis behavior exists because a user-declared destructor suggests the class manages resources in ways the compiler cannot infer. The conservative choice is to fall back to copying. We can force generation of the move constructor with `= default`:\n\n```cpp\nstruct D {\n    std::vector\u003Cint> data;\n    ~D() {}\n    D(D&&) = default;  // explicitly request move constructor\n};\n```\n\n#### Move Assignment\n\nThe same pattern applies to assignment. The move assignment operator takes an rvalue reference and transfers ownership:\n\n```cpp\nvector& operator=(vector&& other) noexcept {\n    if (this != &other) {\n        delete[] data_;        // free our current storage\n        data_ = other.data_;\n        len_ = other.len_;\n        cap_ = other.cap_;\n        other.data_ = nullptr;\n        other.len_ = 0;\n        other.cap_ = 0;\n    }\n    return *this;\n}\n```\n\nThe self-assignment check is necessary because `std::move` can be applied to any lvalue, including the left-hand side of the assignment itself (though this would be perverse).\n\nThe destructor of the moved-from object still runs. Move semantics transfer ownership of *resources*, but the source object continues to exist until its scope ends. The moved-from state must be valid enough for the destructor to execute safely. For `vector`, that means null pointer and zero lengths,the destructor checks for null before freeing, or simply has no work to do.\n\nThe `noexcept` specification on move constructors matters for optimization. `std::vector` needs to relocate elements when it grows. If the element type's move constructor is `noexcept`, the vector can move elements to the new buffer. If it might throw, the vector must copy instead to preserve the strong exception guaranteeÃ¢â‚¬â€if an exception occurs during relocation, the original vector must remain intact. The difference can be dramatic for vectors of vectors.\n\n#### Value Categories in Depth\n\nC++11 refined the notion of value categories beyond the simple lvalue/rvalue split. We have three categories: \n\n* An **lvalue** designates an object with identity that persists beyond a single expression. Variables, function returns by reference, dereferenced pointers. The address can be taken.\n\n* A **prvalue** (pure rvalue) is a temporary with no identity. Literals, function returns by value (before binding), results of arithmetic expressions. These initialize objects or compute values, but have no persistent address.\n\n* An **xvalue** (expiring value) has identity but can be moved from. The result of `std::move()`, the result of a cast to rvalue reference, the return value of a function returning `T&&`. The object exists, has an address, but we have permission to transfer its resources.\n\nOverload resolution uses these categories:\n\n```cpp\nvoid f(Widget& w);        // lvalue reference overload\nvoid f(const Widget& w);  // const lvalue reference overload  \nvoid f(Widget&& w);       // rvalue reference overload\n\nWidget w;\nconst Widget cw;\nf(w);                // calls f(Widget&)\nf(cw);               // calls f(const Widget&)\nf(Widget{});         // calls f(Widget&&) - prvalue\nf(std::move(w));     // calls f(Widget&&) - xvalue\n```\n\nWhen both `const T&` and `T&&` overloads exist, rvalues (prvalues and xvalues) prefer the `T&&` overload. Lvalues can only bind to the lvalue reference overloads. If only `const T&` is provided, it accepts everythingÃ¢â‚¬â€rvalues bind to const lvalue references, which is why copying was the fallback before C++11.\n\nThis machinery operates entirely at compile time. By the time we reach machine code, there are no value categories, no rvalue references, just addresses and data. The type system's job was to select the right constructor or operator; having done so, the generated code performs the memory operations we specified.\n\n### The Moved-From Problem\n\nWe have seen that in C++ rvalue references enable overloading, move constructors transfer resources, `std::move` casts to rvalue. But we glossed over a critical detail. After a move, what happens to the source object?\n\nThe source object still exists. It has a name, an address, a type. The destructor will run when it goes out of scope. We can call methods on it, read its fields, pass it to functions. The move constructor transferred its *resources*, but the object itself remains.\n\nThe C++ standard describes moved-from objects as being in a _valid but unspecified state_. Here _Valid_ means the object satisfies the invariants of its type sufficiently to be destroyed and to have certain operations performed on it (typically assignment and, for some types, queries like `empty()`). _Unspecified_ means we cannot know what values its members hold without inspecting them.\n\nFor `std::unique_ptr`, the moved-from state is fully specified: the pointer becomes null. We can observe this:\n\n```cpp\nstd::unique_ptr\u003Cint> p = std::make_unique\u003Cint>(42);\nstd::unique_ptr\u003Cint> q = std::move(p);\n\n// p still exists, and we can use it\nif (p) {\n    std::cout \u003C\u003C *p;  // does not execute\n} else {\n    std::cout \u003C\u003C \"p is null\";  // this executes\n}\n\nint* raw = p.get();  // returns nullptr\np.reset(new int(7)); // we can even reuse p\n```\n\nThe moved-from `unique_ptr` is a perfectly functional object. It holds a null pointer, knows it holds a null pointer, and behaves consistently. The `get()` method returns null. The `bool` conversion returns false. We can `reset()` it with a new pointer and continue using it. This is well-defined behavior.\n\nFor `std::vector`, the situation is murkier. The standard guarantees only that the moved-from vector is in a _valid but unspecified state_. In practice, most implementations leave it empty:\n\n```cpp\nstd::vector\u003Cint> v1{1, 2, 3, 4, 5};\nstd::vector\u003Cint> v2 = std::move(v1);\n\nstd::cout \u003C\u003C v1.size();  // likely prints 0, but not guaranteed\n```\n\nThe output is _likely_ zero because implementations typically null out the source's data pointer and set its size to zero. But the standard does not require this. An implementation could leave `v1` with garbage values, a dangling pointer, or some other state that satisfies _valid_ (meaning the destructor and assignment still work) without being predictable.\n\nHere is where the design becomes problematic. The compiler does not prevent us from using moved-from objects. There is no warning, no error, nothing. If we forget that we moved from a variable and try to use it, the code compiles and runs:\n\n```cpp\nvoid process(std::vector\u003Cint> data);\n\nvoid example() {\n    std::vector\u003Cint> v{1, 2, 3, 4, 5};\n    process(std::move(v));\n    \n    // Bug: v has been moved from\n    for (int x : v) {         // compiles fine\n        std::cout \u003C\u003C x \u003C\u003C \" \"; // prints nothing, or garbage, or crashes\n    }\n}\n```\n\nThis is not undefined behavior in the strict sense. Iterating over an empty vector is well-defined, but it is almost certainly a bug. The programmer intended to iterate over the original data and forgot that `process` consumed it. The program silently does the wrong thing.\n\nThe cppreference example demonstrates this explicitly:\n\n```cpp\nA a1 = f(A());\nstd::cout \u003C\u003C \"Before move, a1.s = \" \u003C\u003C std::quoted(a1.s)\n          \u003C\u003C \" a1.k = \" \u003C\u003C a1.k \u003C\u003C '\\n';\nA a2 = std::move(a1);\nstd::cout \u003C\u003C \"After move, a1.s = \" \u003C\u003C std::quoted(a1.s)\n          \u003C\u003C \" a1.k = \" \u003C\u003C a1.k \u003C\u003C '\\n';\n```\n\nOutput:\n```\nBefore move, a1.s = \"test\" a1.k = -1\nAfter move, a1.s = \"\" a1.k = 0\n```\n\nThe moved-from object is accessible, observable, and the program continues without complaint. The `std::string` member is empty; the `int` member is zero.\n\nThe fundamental issue here is that C++ chose to preserve the moved-from object's existence for backward compatibility and flexibility. Some use cases genuinely benefit from reusing moved-from objects, reassigning to them, or swapping with another object. The cost of this flexibility is that the type system cannot enforce the discipline of \"don't use it after moving.\"\n\nStatic analyzers and compilers can sometimes detect use-after-move, but they cannot do so reliably in all cases. The analysis is flow-sensitive and context-dependent, and function boundaries obscure the dataflow. A function that takes `T&&` might move from its parameter, or it might not, the caller cannot tell from the signature alone.\n\n\n### Rust: Moves Without Ghosts\n\nRust takes a different approach entirely. When a value moves, the source binding becomes invalid. Not valid but unspecified, *invalid*. The compiler rejects any subsequent use:\n\n```rust\nfn process(data: Vec\u003Ci32>);\n\nfn example() {\n    let v = vec![1, 2, 3, 4, 5];\n    process(v);\n    \n    for x in v {         // error: use of moved value: `v`\n        println!(\"{}\", x);\n    }\n}\n```\n\nThe error message is unambiguous:\n\n```\nerror[E0382]: use of moved value: `v`\n --> src/main.rs:7:14\n  |\n4 |     let v = vec![1, 2, 3, 4, 5];\n  |         - move occurs because `v` has type `Vec\u003Ci32>`, which does not implement the `Copy` trait\n5 |     process(v);\n  |             - value moved here\n6 |     \n7 |     for x in v {\n  |              ^ value used here after move\n```\n\nThere is no moved-from state to observe because there is no way to observe it. The binding `v` is not null, not empty, not unspecifiedÃ¢â‚¬â€it simply does not exist from the compiler's perspective after the move. The name remains in scope (you can shadow it with a new binding), but the compiler's initialization tracking marks it as uninitialized.\n\nAt the assembly level, the actual data movement is nearly identical to C++. The `Vec`'s three words (pointer, length, capacity) are copied from one stack location to another, or into registers for a function call. There is no heap allocation, no deep copy, just 24 bytes shuffled around. The difference is purely a compile-time concept: Rust tracks that the source is no longer valid.\n\n```rust\nfn example() {\n    let v1 = vec![1, 2, 3];\n    let v2 = v1;           // v1 moved to v2\n    println!(\"{:?}\", v1);  // error: borrow of moved value\n}\n```\n\nThe generated assembly for `let v2 = v1` is a `memcpy` of the struct, essentially identical to what C++ would generate. But where C++ would let us access `v1` afterward (finding it in some \"valid but unspecified\" state), Rust stops compilation.\n\nThis tracking happens through dataflow analysis in the compiler. Each variable has an initialization state that the compiler updates as it processes statements. When `v1` is assigned to `v2`, the compiler marks `v1` as uninitialized. Any subsequent use of `v1` is an error, as if we had declared `let v1: Vec\u003Ci32>;` without initializing it.\n\nWhat about reinitialization? A moved-from variable can be assigned a new value:\n\n```rust\nfn example() {\n    let mut v = vec![1, 2, 3];\n    let v2 = v;            // v is now uninitialized\n    v = vec![4, 5, 6];     // v is reinitialized\n    println!(\"{:?}\", v);   // ok: prints [4, 5, 6]\n}\n```\n\nThe compiler's tracking is flow-sensitive. After the move, `v` is uninitialized. After the reassignment, `v` is initialized with a new value. The `mut` is required because reinitialization is a form of mutation in Rust's model.\n\nControl flow complicates the analysis. If a move occurs in one branch but not another, the variable's initialization state depends on which path was taken:\n\n```rust\nfn example(condition: bool) {\n    let v = vec![1, 2, 3];\n    if condition {\n        drop(v);           // v moved into drop()\n    }\n    println!(\"{:?}\", v);   // error: v might have been moved\n}\n```\n\nThe compiler cannot statically determine which branch executes, so it conservatively assumes `v` might be uninitialized. This occasionally forces us to restructure code or use `Option\u003CT>` to represent _maybe moved_ states explicitly.\n\nFor cases where the compiler cannot determine initialization statically, Rust uses *drop flags*. These are runtime boolean values, typically stored on the stack, that track whether a value has been moved. When the variable goes out of scope, the generated code checks the flag before calling the destructor:\n\n```rust\nfn example(condition: bool) {\n    let x;\n    if condition {\n        x = Box::new(0);\n        println!(\"{}\", x);\n    }\n    // x goes out of scope: compiler generates code to check if x was initialized\n}\n```\n\nThe drop flag mechanism tells us something about the design trade-off Rust accepted. In straight-line code, the compiler knows exactly which bindings are initialized at every point, and generates direct drops with no runtime overhead. But conditional moves force a choice: either reject some valid programs (overly conservative static analysis), or emit a runtime check. Rust chose the latter for flexibility, keeping the flag on the stack where it costs a byte and a conditional branch at scope exit. For hot loops, we can restructure code to ensure static initialization tracking; for cold paths, the flag is negligible.\n\nWhat we cannot do in safe Rust is observe a moved-from binding. The asymmetry with C++ is not about what happens at runtime, both languages copy the same bytes, both leave the source's memory untouched until the stack frame is reclaimed. The difference is what the compiler permits us to write. C++ allows the moved-from object to participate in subsequent expressions; Rust does not. \n\n### Copy, Move, Clone\n\nWe have been speaking of \"move\" as if it were a single concept, but Rust distinguishes three related operations: implicit copy, move, and explicit clone. Understanding when each applies requires understanding what the type system knows about the data.\n\nAn `i32` is 4 bytes. When we write `let y = x` where `x: i32`, the compiler generates a `mov` instruction that copies those 4 bytes. After the assignment, both `x` and `y` hold independent copies of the same value. We can use both. This is a *copy*.\n\nA `Vec\u003Ci32>` is 24 bytes on the stack (pointer, length, capacity), but those 24 bytes control an arbitrarily large heap allocation. When we write `let y = x` where `x: Vec\u003Ci32>`, the compiler generates the same kind of `mov` instructions to copy those 24 bytes. But now both `x` and `y` would point to the same heap allocation. If we allowed both to be used, we would have aliasing, and when both go out of scope, we would have double-free. So after the assignment, `x` is invalidated. This is a *move*.\n\nAt the machine level, copy and move are identical. Both copy the bytes that constitute the value. The difference is in what the compiler permits afterward. For `Copy` types, the source remains valid. For non-`Copy` types, the source is invalidated.\n\nRust uses the `Copy` trait to mark types where this byte-for-byte duplication is semantically complete. If copying the bytes gives us two independent, fully functional values, the type can be `Copy`. Integers, floats, `bool`, `char`, raw pointers, and tuples or arrays of `Copy` types are all `Copy`. The defining characteristic is that there is no additional resource management beyond the bytes themselves.\n\nThe `Copy` trait has a constraint: a type cannot implement both `Copy` and `Drop`. If a type has a destructor, duplicating its bytes creates two values that will both try to run cleanup. For `Vec`, this means double-free. For `File`, this means closing the same file descriptor twice. The mutual exclusion between `Copy` and `Drop` is enforced by the compiler:\n\n```rust\n#[derive(Copy, Clone)]\nstruct Point { x: i32, y: i32 }  // ok: no Drop, all fields Copy\n\n#[derive(Copy, Clone)]\nstruct Wrapper(Vec\u003Ci32>);        // error: Vec is not Copy\n```\n\nThe error message is direct:\n\n```\nerror[E0204]: the trait `Copy` cannot be implemented for this type\n --> src/main.rs:4:10\n  |\n4 | #[derive(Copy, Clone)]\n  |          ^^^^\n5 | struct Wrapper(Vec\u003Ci32>);\n  |                -------- this field does not implement `Copy`\n```\n\nC++ has a parallel concept in *trivially copyable* types. The C++ standard (Ã‚Â§11.2) defines a trivially copyable class as one where each eligible copy constructor, move constructor, copy assignment operator, and move assignment operator is trivial, and the destructor is trivial and non-deleted. \"Trivial\" here means the compiler-generated default does the right thing, which for these operations means bitwise copy. A `struct` containing only integers and other trivially copyable types is trivially copyable.\n\nThe difference is enforcement. In C++, `std::is_trivially_copyable_v\u003CT>` is a compile-time query we can use in `static_assert` or SFINAE, but the language does not prevent us from memcpy-ing a non-trivially-copyable object. We might get away with it if the object has no internal pointers or virtual functions. We might corrupt memory if it does. In Rust, attempting to derive `Copy` on a non-qualifying type is a hard error.\n\n`Clone` is the explicit deep copy operation. Where `Copy` happens implicitly on assignment, `Clone::clone()` must be called explicitly. The implementation can do anything: allocate new memory, copy all elements, increment reference counts, whatever is appropriate for the type. For `Vec\u003CT>`, `clone()` allocates a new buffer and clones each element.\n\nThe relationship between `Copy` and `Clone` is that `Copy` is a supertrait of `Clone`. Every `Copy` type must also implement `Clone`, and for `Copy` types, `clone()` is equivalent to a byte copy. This might seem redundant, but it allows generic code to work uniformly:\n\n```rust\nfn duplicate\u003CT: Clone>(x: &T) -> T {\n    x.clone()\n}\n```\n\nThis function works for both `i32` (where `clone` compiles to a simple load) and `String` (where `clone` allocates and copies). The call site is uniform; the generated code is not.\n\nWhen we see `.clone()` in Rust code, we know that something potentially expensive is happening. The Rust philosophy is that expensive operations should be visible. Making us write `.clone()` forces acknowledgment of this cost.\n\nC++ takes the opposite approach for copy constructors. Given `std::vector\u003Cint> v2 = v1;`, this invokes the copy constructor, which allocates and copies all elements. The syntax is identical to copying an `int`. We must know that `vector` has an expensive copy constructor; the code does not tell us. Move semantics (`v2 = std::move(v1)`) were added in C++11 partly to make expensive operations more visible, but copy remains implicit.\n\nOne subtlety: Rust's `clone()` is not always a deep copy in the intuitive sense. For `Rc\u003CT>`, calling `clone()` increments the reference count and returns a new `Rc` pointing to the same allocation. The data is shared, not duplicated. This is the correct semantics for `Rc`, since the entire point of reference counting is to share data. But it means we cannot assume that `clone()` produces an independent copy. The trait's contract is weaker: `clone()` produces a value that is semantically equivalent to the original for the purposes of the type's interface.\n\n### Elision: When Neither Happens\n\nWe have seen that moving a value copies its bytes from source to destination. For a 24-byte `Vec` struct, this means three 8-byte writes. But what about returning a `Vec` from a function? Naively, we might expect: the function constructs a `Vec` in its stack frame, then on return, the `Vec` is moved to the caller's stack frame, then the caller receives the returned value. This would mean writing those 24 bytes twice.\n\nThe answer to whether we can avoid this lies in how function returns work at the ABI level. The Itanium C++ ABI, which governs calling conventions on most Unix-like systems, distinguishes between *trivial* and *non-trivial* return types. A type is non-trivial for purposes of calls if it has a non-trivial destructor or a non-trivial copy or move constructor. For non-trivial return types, the ABI specifies that the caller passes an address as an implicit parameter, and the callee constructs the return value directly into this address.\n\nThe Itanium ABI goes further. The address passed need not point to temporary memory on the caller's stack. Copy elision may cause it to point anywhere: to a local variable's storage, to global memory, to heap-allocated memory. The pointer is passed as if it were the first parameter in the function prototype, preceding all other parameters including `this`. If the return type has a non-trivial destructor, the caller is responsible for destroying the object after, and only after, the callee returns normally. If an exception is thrown after construction but before the return completes, the callee must destroy the return value before propagating the exception.\n\nThis machinery enables what C++ calls *copy elision*. The returned object is constructed directly in its final location. Two forms are commonly discussed:\n\n**RVO (Return Value Optimization)** applies when we return a prvalue, a temporary with no name:\n\n```cpp\nstd::vector\u003Cint> make_vector() {\n    return std::vector\u003Cint>{1, 2, 3};\n}\n```\n\nThe `vector` is constructed directly into the caller-provided address. No temporary exists in `make_vector`'s stack frame.\n\n**NRVO (Named Return Value Optimization)** applies when we return a named local variable:\n\n```cpp\nstd::vector\u003Cint> make_vector() {\n    std::vector\u003Cint> v{1, 2, 3};\n    v.push_back(4);\n    return v;\n}\n```\n\nHere the compiler can allocate `v` directly in the caller-provided space from the start. If it does, there is no copy or move on return. If it does not (perhaps because control flow makes this impossible), the return invokes the move constructor.\n\nBefore C++17, both forms of elision were permitted but not guaranteed. A conforming compiler could choose not to elide, and the program would fall back to copy or move constructors. Code relying on elision for correctness, such as returning a non-copyable non-movable type, was non-portable.\n\nC++17 changed this for prvalues through a reformulation of value categories. The standard now specifies that prvalues are not *materialized* until needed. A prvalue does not create a temporary object; it initializes a target object directly. The C++ standard (Ã‚Â§6.7.7) states that the materialization of a temporary object is generally delayed as long as possible to avoid creating unnecessary temporary objects. The result is *guaranteed copy elision* for prvalues. The statement `std::vector\u003Cint> v = make_vector();` constructs the vector directly into `v`, guaranteed by the standard, not merely permitted as an optimization.\n\nNRVO remains optional. The standard permits but does not require it. In practice, every major compiler performs NRVO when control flow permits. Multiple return statements returning different named variables typically defeat NRVO because the compiler cannot know at the function's entry which variable will be returned.\n\nHow does this relate to Rust? Rust does not have *copy elision* as a named language concept because the problem is different. Rust moves are defined as bitwise copies that invalidate the source. There is no move constructor, no user code that might run, no observable side effects to elide. Moving a `Vec` copies 24 bytes regardless of context.\n\nRust does perform the same underlying ABI-level optimization. When a function returns a value that cannot fit in registers, the caller passes a hidden pointer in `rdi` (System V) or `rcx` (Microsoft x64), and the callee writes directly to that location. But Rust does not need language-level elision rules because there is no observable difference. Bitwise copy is bitwise copy; constructing directly into the destination versus constructing locally and then copying produces identical bit patterns.\n\n```rust\nfn make_vec() -> Vec\u003Ci32> {\n    vec![1, 2, 3, 4, 5]\n}\n\nfn caller() {\n    let v = make_vec();\n}\n```\n\nWith optimizations, `make_vec` receives the hidden pointer in `rdi` and writes the `Vec`'s three fields (pointer, capacity, length) directly to that address. There is no intermediate `Vec` on `make_vec`'s stack frame that gets copied out. The heap allocation happens once, the `Vec` header is written once, directly to where `caller` wants it.\n\nFor types that fit in registers, both languages return values in RAX and RDX. A function returning `(i32, i32)` involves no memory operations for the return itself.\n\nThe consequence is that returning large values by value in Rust is not expensive because of the return mechanism. The cost is in constructing the data structure: the allocations, the element initialization, the potential reallocations. The mechanics of getting the result back to the caller add nothing beyond what the ABI already requires for any struct return.\n\n## Smart Pointers and Reference Counting\n\nMove semantics solve the problem of transferring exclusive ownership efficiently. But some data structures cannot express their sharing patterns through exclusive ownership alone. A graph where multiple edges reference the same node, a cache that outlives any single user, a callback that must remain valid for multiple callers: these require *shared* ownership, where the resource is released only when the last owner disappears.\n\nWe have seen how C++ and Rust handle exclusive heap ownership through `unique_ptr` and `Box`. The move semantics we examined apply directly: `unique_ptr` leaves a nullptr after move, `Box` leaves no valid binding at all. Now we turn to the harder problem of shared ownership, where multiple owners must coordinate to determine when deallocation occurs.\n\n### Shared Ownership: `shared_ptr`\n\nWhen multiple parts of a program need to share ownership of heap-allocated data, we need reference counting. C++'s `shared_ptr` implements this with a *control block*: a separate heap allocation that stores metadata about the shared object.\n\nA typical `shared_ptr\u003CT>` contains two pointers: one to the managed object (`T*`), and one to the control block. The control block contains:\n\n- A strong reference count (the number of `shared_ptr`s pointing to the object)\n- A weak reference count (the number of `weak_ptr`s, plus one if the strong count is nonzero)\n- A pointer to the managed object (or the object itself, if allocated together)\n- The deleter (type-erased, since different `shared_ptr`s with different deleters can share ownership)\n- The allocator (also type-erased)\n\nWhen we copy a `shared_ptr`, the strong count is incremented atomically. When a `shared_ptr` is destroyed, the strong count is decremented. If the strong count reaches zero, the managed object is destroyed (the deleter is invoked). The control block itself is not destroyed until the weak count also reaches zero, because `weak_ptr`s need to query the control block to determine whether the object still exists.\n\n```cpp\nauto p = std::make_shared\u003CWidget>();  // one allocation: control block + Widget\nauto q = p;                           // strong count: 2\nq.reset();                            // strong count: 1\n// p destroyed, strong count: 0, Widget destroyed\n```\n\nThe `make_shared` function is preferred over `shared_ptr\u003CT>(new T)` because it performs a single allocation for both the control block and the object, improving cache locality and reducing allocation overhead. The downside is that the memory for the object cannot be released until all weak references are also gone, since the control block and object share a single allocation.\n\n### Shared Ownership: `Rc\u003CT>` and `Arc\u003CT>`\n\nRust separates the single-threaded and multi-threaded cases into distinct types. `Rc\u003CT>` (reference counted) uses non-atomic operations and is not thread-safe. `Arc\u003CT>` (atomically reference counted) uses atomic operations and can be shared across threads.\n\nThe layout of `Rc\u003CT>` is similar in spirit to `shared_ptr`, but simpler. An `Rc\u003CT>` is a single pointer to a heap allocation containing:\n\n- A strong count (`Cell\u003Cusize>`, non-atomic)\n- A weak count (`Cell\u003Cusize>`, non-atomic)\n- The data (`T`)\n\nThere is no separate deleter or allocator. `Rc\u003CT>` always uses the global allocator and always drops `T` in place. This means `Rc\u003CT>` is a single pointer, 8 bytes, not two pointers like `shared_ptr`.\n\n```rust\nuse std::rc::Rc;\n\nlet a = Rc::new(Widget::new());  // allocates RcBox containing counts + Widget\nlet b = Rc::clone(&a);           // strong count: 2\ndrop(b);                         // strong count: 1\n// a dropped, strong count: 0, Widget dropped, RcBox deallocated\n```\n\nThe convention is to write `Rc::clone(&a)` rather than `a.clone()`. Both work identically, but the explicit form makes clear that we are incrementing a reference count, not performing a deep copy. \n\n`Arc\u003CT>` has the same layout, with the counts replaced by `AtomicUsize`:\n\n```rust\nuse std::sync::atomic::AtomicUsize;\n\npub struct ArcInner\u003CT> {\n    strong: AtomicUsize,\n    weak: AtomicUsize,\n    data: T,\n}\n```\n\nThe atomic operations add overhead. Incrementing an atomic counter requires synchronization at the hardware level: a `lock` prefix on x86, load-linked/store-conditional sequences on ARM. In high-contention scenarios, cache lines bounce between cores. If shared ownership is needed but thread safety is not, `Rc` avoids this cost entirely.\n\nRust enforces this separation at compile time. `Rc\u003CT>` does not implement `Send` or `Sync`. Attempting to move an `Rc` across thread boundaries is a type error:\n\n```rust\nuse std::rc::Rc;\nuse std::thread;\n\nlet rc = Rc::new(42);\nthread::spawn(move || {\n    println!(\"{}\", rc);  // error: `Rc\u003Ci32>` cannot be sent between threads safely\n});\n```\n\nThe error is not a runtime panic. The code does not compile. We cannot accidentally introduce data races by using the wrong smart pointer type.\n\n### Reference Count Synchronization\n\nThe increment operation in `Arc::clone` uses `Ordering::Relaxed`. This might seem dangerous for a multi-threaded primitive, but the reasoning is precise that incrementing the count establishes no ordering relationship with any other memory access. We already have access to the `Arc`, which means we already have a valid reference to the data. We are simply recording that one more owner exists. The only requirement is atomicity itself, ensuring that two concurrent increments do not lose a count.\n\n```rust\nimpl\u003CT> Clone for Arc\u003CT> {\n    fn clone(&self) -> Arc\u003CT> {\n        let inner = unsafe { self.ptr.as_ref() };\n        inner.rc.fetch_add(1, Ordering::Relaxed);\n        Arc { ptr: self.ptr, phantom: PhantomData }\n    }\n}\n```\n\nThe decrement is where the complexity lies. Consider what happens when the last owner drops its `Arc`. At that moment, no other thread holds a reference, and we must deallocate. But we must first ensure that all writes performed by any previous owner are visible to us. If thread A writes to `arc.data` and then drops its `Arc`, and thread B subsequently drops the last `Arc`, thread B must see thread A's writes before running the destructor.\n\nThe standard solution uses release-acquire synchronization:\n\n```rust\nimpl\u003CT> Drop for Arc\u003CT> {\n    fn drop(&mut self) {\n        let inner = unsafe { self.ptr.as_ref() };\n        if inner.rc.fetch_sub(1, Ordering::Release) != 1 {\n            return;\n        }\n        std::sync::atomic::fence(Ordering::Acquire);\n        unsafe { drop(Box::from_raw(self.ptr.as_ptr())); }\n    }\n}\n```\n\nEvery `fetch_sub` with `Release` ordering guarantees that all prior writes in that thread are visible to any thread that subsequently performs an `Acquire` operation on the same atomic variable and observes the stored value. When thread B's `fetch_sub` returns 1, indicating it was the last owner, the subsequent `Acquire` fence synchronizes with all the `Release` decrements that preceded it. Thread B now sees every write that any previous owner performed before dropping.\n\nOn x86, the `Release` ordering on `fetch_sub` compiles to a simple `lock xadd` instruction, which already provides the necessary ordering guarantees due to x86's strong memory model. The `Acquire` fence compiles to nothing, as x86 loads already have acquire semantics. On ARM, the situation is different: `Release` requires a `dmb ish` barrier before the store, and `Acquire` requires a barrier after the load.\n\nUsing `Relaxed` for the decrement would allow the deallocating thread to see stale data, potentially reading uninitialized memory or seeing partially-written values. Using `SeqCst` everywhere would be correct but unnecessarily expensive, adding full memory barriers where weaker ordering suffices. The release-acquire pattern is the minimum synchronization required for correctness.\n\n### Raw Pointers, Variance, and the Drop Checker\n\nAn `Arc` internally holds a raw pointer to the heap allocation. A naive definition might use `*mut ArcInner\u003CT>`, but this creates two problems that `NonNull\u003CT>` and `PhantomData\u003CT>` solve.\n\nRaw pointers are *invariant* in their type parameter. If we have an `Arc\u003C&'static str>`, we should be able to use it where an `Arc\u003C&'a str>` is expected (assuming `'static: 'a`), because a longer-lived reference can substitute for a shorter-lived one. But `*mut T` does not allow this substitution. `NonNull\u003CT>` is a pointer wrapper that is *covariant* in `T`, restoring the expected subtyping relationship.\n\nThe second problem concerns the drop checker. When the compiler analyzes whether a type can be safely dropped, it needs to know what the type logically owns. A raw pointer carries no ownership information; the compiler assumes `*mut T` does not own a `T`. But `Arc\u003CT>` *does* own a `T`, at least when it is the last owner. If we do not communicate this to the compiler, code that should be rejected might compile:\n\n```rust\nfn bad\u003C'a>(arc: Arc\u003C&'a str>) {\n    let local = String::from(\"local\");\n    // Without PhantomData, the compiler might not realize\n    // that dropping arc could access the &str\n}\n```\n\nAdding `PhantomData\u003CArcInner\u003CT>>` tells the drop checker that `Arc\u003CT>` behaves as if it contains an `ArcInner\u003CT>`, which contains a `T`. The drop checker then ensures that `T` outlives the `Arc`, preventing dangling references in the destructor.\n\nThe final structure:\n\n```rust\npub struct Arc\u003CT> {\n    ptr: NonNull\u003CArcInner\u003CT>>,\n    phantom: PhantomData\u003CArcInner\u003CT>>,\n}\n```\n\nThis is still a single pointer in size, 8 bytes. `PhantomData` is a zero-sized type; it affects the type system without occupying memory. `NonNull` is a `#[repr(transparent)]` wrapper around `*const T`, also pointer-sized. The layout is identical to a raw pointer, but the semantics are correct for a reference-counted smart pointer.\n\n### Weak References and the Control Block Lifetime\n\nA `weak_ptr` or `Weak` does not keep the managed object alive. It holds a pointer to the control block (or inner allocation), not to the object itself. When we attempt to *upgrade* a weak reference to a strong one, the operation must atomically check whether the object still exists and, if so, increment the strong count before another thread can decrement it to zero.\n\nConsider the race: thread A holds the last `shared_ptr` and is about to drop it. Thread B holds a `weak_ptr` and calls `lock()`. If B reads the strong count as 1, then A decrements it to 0 and deallocates, then B increments it to 1, we have a use-after-free. The upgrade must be atomic with respect to the decrement.\n\nIn C++, `weak_ptr::lock()` performs a compare-and-swap loop. It loads the strong count, checks if it is zero (returning an empty `shared_ptr` if so), then attempts to atomically increment it from the observed value. If another thread modified the count in the meantime, the CAS fails and the loop retries. The implementation looks roughly like:\n\n```cpp\nshared_ptr\u003CT> weak_ptr\u003CT>::lock() const noexcept {\n    long count = control_block->strong_count.load(std::memory_order_relaxed);\n    while (count != 0) {\n        if (control_block->strong_count.compare_exchange_weak(\n                count, count + 1, std::memory_order_acq_rel)) {\n            return shared_ptr\u003CT>(/* from control block */);\n        }\n        // count was updated by compare_exchange_weak on failure\n    }\n    return shared_ptr\u003CT>();  // empty\n}\n```\n\nRust's `Weak::upgrade()` follows the same pattern. The `acq_rel` ordering on the successful CAS ensures that if we observe a nonzero count, our subsequent access to the data sees all writes that happened before any previous owner released their reference.\n\nThe control block has a two-phase destruction. When the strong count reaches zero, the managed object is destroyed: its destructor runs, and if allocated separately from the control block, its memory is freed. The control block itself survives. Only when the weak count also reaches zero is the control block deallocated. This separation allows weak references to safely query whether the object exists.\n\nWith `make_shared`, the object and control block occupy a single allocation. The object's destructor runs when the strong count hits zero, but the memory cannot be freed until the weak count also hits zero, because the control block metadata lives in the same allocation. Long-lived weak references to `make_shared` objects keep the entire allocation alive, even though the object has been destroyed. Separate allocation via `shared_ptr\u003CT>(new T)` avoids this: the object's memory is freed immediately when the strong count hits zero, and only the smaller control block remains for weak reference bookkeeping.\n\n### The Cost of Atomics in Reference Counting\n\n`Arc::clone` compiles to a `lock xadd` instruction on x86. The `lock` prefix asserts exclusive ownership of the cache line containing the reference count, forcing all other cores to invalidate their copies. On a system with 8 cores all cloning the same `Arc`, each clone causes 7 cache invalidations. The reference count ping-pongs between cores, and each increment waits for the cache line to arrive in the exclusive state.\n\n```asm\n; Arc::clone on x86-64\nmov     rax, qword ptr [rdi]        ; load pointer to ArcInner\nlock    xadd qword ptr [rax], 1     ; atomic increment of refcount\n```\n\nThe `lock xadd` instruction alone takes roughly 15-30 cycles on modern x86 when uncontended, rising to 100+ cycles under contention as cores compete for the cache line. On ARM, the equivalent uses load-exclusive/store-exclusive pairs:\n\n```asm\n; Arc::clone on ARM64\n.retry:\n    ldxr    x1, [x0]          ; load-exclusive refcount\n    add     x1, x1, #1\n    stxr    w2, x1, [x0]      ; store-exclusive\n    cbnz    w2, .retry        ; retry if store failed\n```\n\nThe store-exclusive fails if another core modified the cache line between the load and store, requiring a retry. Under high contention, threads spin in this loop, wasting cycles.\n\nThe decrement in `Arc::drop` has the same atomic cost, plus the `Acquire` fence when we observe the count reaching zero. On x86, the fence is free because `lock xadd` already has acquire-release semantics. On ARM, it expands to a `dmb ish` (data memory barrier, inner shareable domain), which stalls the pipeline until all prior memory operations complete.\n\nBeyond instruction costs, reference counting interacts poorly with modern cache hierarchies. The reference count and the data occupy the same allocation, often the same cache line. If threads read the data while another thread clones or drops the `Arc`, false sharing occurs: the reading threads' cache lines are invalidated by the write to the reference count, even though the data itself is unchanged. This is unavoidable without splitting the count into a separate allocation, which would add indirection and defeat the single-pointer layout.\n\n`Rc\u003CT>` avoids all of this. With no threading, the increment is a simple `add` instruction, the decrement a simple `sub`. No cache coherence traffic, no memory barriers, no retry loops. The type system's guarantee that `Rc` is not `Send` lets us omit the synchronization entirely.\n\n```asm\n; Rc::clone on x86-64\nmov     rax, qword ptr [rdi]        ; load pointer to RcBox\ninc     qword ptr [rax]             ; non-atomic increment\n```\n\n### C's Approach: Manual Reference Counting\n\nC has no built-in reference-counted smart pointers, but the pattern is pervasive. The Linux kernel's `kref`, GLib's `GObject`, and COM's `IUnknown` all implement reference counting manually, each with its own conventions and failure modes.\n\nA single-threaded implementation is pretty straightforward:\n\n```c\nstruct Widget {\n    int refcount;\n    // ... data ...\n};\n\nstruct Widget *widget_ref(struct Widget *w) {\n    w->refcount++;\n    return w;\n}\n\nvoid widget_unref(struct Widget *w) {\n    if (--w->refcount == 0) {\n        widget_destroy(w);\n        free(w);\n    }\n}\n```\n\nThreading requires atomic operations. Before C11, these were compiler or platform-specific: GCC's `__sync_fetch_and_add`, MSVC's `InterlockedIncrement`, or inline assembly. C11 standardized atomics, but the memory ordering must still be chosen correctly:\n\n```c\n#include \u003Cstdatomic.h>\n\nstruct Widget {\n    atomic_int refcount;\n    // ... data ...\n};\n\nstruct Widget *widget_ref(struct Widget *w) {\n    atomic_fetch_add_explicit(&w->refcount, 1, memory_order_relaxed);\n    return w;\n}\n\nvoid widget_unref(struct Widget *w) {\n    if (atomic_fetch_sub_explicit(&w->refcount, 1, memory_order_release) == 1) {\n        atomic_thread_fence(memory_order_acquire);\n        widget_destroy(w);\n        free(w);\n    }\n}\n```\n\nThe ordering arguments mirror what we saw in `Arc`: `relaxed` for increment (we already have a valid reference), `release` for decrement (publish our writes), `acquire` fence before destruction (synchronize with all releasers). Getting any of these wrong introduces data races that manifest as sporadic corruption, use-after-free in specific timing windows, or crashes that appear once per million operations.\n\nThe Linux kernel's `kref` wraps this pattern into a small struct with `kref_get` and `kref_put` operations. This discipline is not enforced, nothing prevents calling `kref_get` on an object whose count has already reached zero, or forgetting to call `kref_put` on an error path. Static analysis tools like Sparse and Coverity catch some bugs; the rest are found through testing, fuzzing, or production crashes.\n\nEvery usage site must remember to call `widget_ref` when acquiring a reference and `widget_unref` when releasing one. There is no automatic cleanup on scope exit, no destructor to invoke at the end of a block. If a function returns early due to an error, every acquired reference must be explicitly released. Missing a single `unref` leaks memory; an extra `unref` corrupts the count or triggers a double-free.\n\n---\n\nPart III will examine how types are represented in memory and how polymorphism is implemented. Rust reorders struct fields by default to minimize padding; `repr(C)` restores predictable layout for FFI. Fat pointers carry metadata alongside the data address: slices carry length, trait objects carry vtable pointers. We will compare monomorphization (C++ templates, Rust generics) against dynamic dispatch (C++ virtual functions, Rust trait objects), examining the generated code and the trade-offs in binary size, call overhead, and cache behavior. Closures will complete the picture: anonymous structs that capture their environment, with the `Fn`/`FnMut`/`FnOnce` traits encoding how they access captured variables.","src/data/blog/memory-pt2.md","7df0ee229e76e749",{"html":797,"metadata":798},"\u003Cp>In the \u003Ca href=\"https://lukefleed.xyz/posts/who-owns-the-memory-pt1/\">first part\u003C/a> of this series, we saw that objects occupy storage, that storage has duration, and that the type system imposes structure on raw bytes. But we have sidestepped a question that dominates systems programming in practice: when heap-allocated memory must be released, who bears responsibility for releasing it?\u003C/p>\n\u003Ch2 id=\"table-of-contents\">Table of Contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of Contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#ownership-who-calls-free\">Ownership: Who Calls Free?\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#c-manual-management\">C: Manual Management\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-binding-cleanup-to-scope\">C++: Binding Cleanup to Scope\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-ownership-in-the-type-system\">Rust: Ownership in the Type System\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-drop-trait-and-recursive-destruction\">The Drop Trait and Recursive Destruction\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#manuallydrop-and-suppressing-automatic-destruction\">ManuallyDrop and Suppressing Automatic Destruction\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#drop-flags-and-conditional-initialization\">Drop Flags and Conditional Initialization\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#you-cannot-call-drop-directly\">You Cannot Call Drop Directly\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#drop-check-when-lifetimes-and-destructors-collide\">Drop Check: When Lifetimes and Destructors Collide\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-may_dangle-escape-hatch\">The \u003Ccode>#[may_dangle]\u003C/code> Escape Hatch\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#phantomdata-and-drop-check-interaction\">PhantomData and Drop Check Interaction\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#leaks-are-safe\">Leaks Are Safe\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#beyond-raii\">Beyond RAII\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-single-destructor-problem\">The Single-Destructor Problem\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#defer-explicit-scope-bound-cleanup\">Defer: Explicit Scope-Bound Cleanup\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#linear-types-enforcing-explicit-consumption\">Linear Types: Enforcing Explicit Consumption\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#why-rust-does-not-have-linear-types\">Why Rust Does Not Have Linear Types\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#move-semantics\">Move Semantics\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-cost-of-copies\">The Cost of Copies\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-shallow-copy-escape\">The Shallow Copy Escape\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c11-rvalue-references-and-move-semantics\">C++11: Rvalue References and Move Semantics\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-implicitly-declared-move-constructor\">The Implicitly-Declared Move Constructor\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#move-assignment\">Move Assignment\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#value-categories-in-depth\">Value Categories in Depth\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#the-moved-from-problem\">The Moved-From Problem\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-moves-without-ghosts\">Rust: Moves Without Ghosts\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#copy-move-clone\">Copy, Move, Clone\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#elision-when-neither-happens\">Elision: When Neither Happens\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#smart-pointers-and-reference-counting\">Smart Pointers and Reference Counting\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#shared-ownership-shared_ptr\">Shared Ownership: \u003Ccode>shared_ptr\u003C/code>\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#shared-ownership-rct-and-arct\">Shared Ownership: \u003Ccode>Rc&#x3C;T>\u003C/code> and \u003Ccode>Arc&#x3C;T>\u003C/code>\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#reference-count-synchronization\">Reference Count Synchronization\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#raw-pointers-variance-and-the-drop-checker\">Raw Pointers, Variance, and the Drop Checker\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#weak-references-and-the-control-block-lifetime\">Weak References and the Control Block Lifetime\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-cost-of-atomics-in-reference-counting\">The Cost of Atomics in Reference Counting\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#cs-approach-manual-reference-counting\">Câ€™s Approach: Manual Reference Counting\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch2 id=\"ownership-who-calls-free\">Ownership: Who Calls Free?\u003C/h2>\n\u003Cp>The stack is self-managing. When a function returns, the stack pointer moves and automatic storage vanishes. There is no decision to make, no function to call, no possibility of error. The heap is different. Memory obtained through \u003Ccode>malloc\u003C/code> persists until someone calls \u003Ccode>free\u003C/code>. The allocator cannot know when we are finished with an allocation; only our program logic knows that. And so the burden falls on us.\u003C/p>\n\u003Cp>This burden is not merely administrative. The consequences of mismanagement are severe and often exploitable. If we free too early, subsequent accesses read garbage or, worse, data that a new allocation has placed there (a use-after-free, the vulnerability class behind a substantial fraction of remote code execution exploits). If we free twice, we corrupt the allocatorâ€™s metadata; an attacker who controls the timing can often leverage this into arbitrary write primitives. If we never free, we leak, and the process grows until the operating system intervenes.\u003C/p>\n\u003Cp>The question is how programming languages help us manage this responsibility, or whether they help at all.\u003C/p>\n\u003Ch3 id=\"c-manual-management\">C: Manual Management\u003C/h3>\n\u003Cp>C offers two primitives: \u003Ccode>malloc\u003C/code> to acquire and \u003Ccode>free\u003C/code> to release. Everything else is convention.\u003C/p>\n\u003Cp>Consider a function that opens a file and allocates a read buffer:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typedef\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fd;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">buffer;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> capacity;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} FileReader;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">FileReader \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">filereader_open\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">path\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> buffer_size\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    FileReader \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">reader \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> malloc\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(FileReader))\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">reader) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> NULL\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">buffer\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> malloc\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(buffer_size)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">!\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">buffer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        free\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(reader)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> NULL\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">fd\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> open\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(path\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> O_RDONLY)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">fd\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        free\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">buffer\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        free\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(reader)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> NULL\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">capacity\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> buffer_size;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> reader;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We acquire three resources: the struct itself, the buffer, and the file descriptor. Each acquisition can fail, and each failure path must release everything acquired before it. The code above handles this correctly. But observe the shape: the cleanup logic mirrors the acquisition logic in reverse, and we must write it by hand for every function that acquires resources.\u003C/p>\n\u003Cp>The corresponding cleanup function:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> filereader_close\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(FileReader \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">reader) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">fd\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">close\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">fd\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    free\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">buffer\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    free\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(reader)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>What happens if we call \u003Ccode>filereader_close\u003C/code> twice on the same pointer? The first call closes the descriptor and frees the memory. The second call passes the same address to \u003Ccode>free\u003C/code>, corrupting the allocatorâ€™s free list. The compiler does not warn us.\u003C/p>\n\u003Cp>What happens if, between \u003Ccode>filereader_open\u003C/code> and \u003Ccode>filereader_close\u003C/code>, we reassign \u003Ccode>reader->buffer\u003C/code> without freeing the old buffer? We leak. The original allocation becomes unreachable.\u003C/p>\n\u003Cp>The fundamental problem is that C pointers carry no ownership semantics. When a function declares \u003Ccode>void process(FileReader *reader)\u003C/code>, nothing in that signature tells us whether \u003Ccode>process\u003C/code> will free the reader, expects us to free it afterward, or assumes it will remain valid for some longer duration. The type \u003Ccode>FileReader *\u003C/code> means only â€œaddress of a FileReaderâ€; it says nothing about responsibility.\u003C/p>\n\u003Cp>Large C codebases develop conventions to manage this. The Linux kernel uses reference counting for shared structures, with \u003Ccode>_get\u003C/code> and \u003Ccode>_put\u003C/code> suffixes indicating acquisition and release. GLib uses \u003Ccode>_new\u003C/code> for allocation, \u003Ccode>_free\u003C/code> for deallocation, and \u003Ccode>_ref\u003C/code>/\u003Ccode>_unref\u003C/code> for reference-counted objects. These conventions work, but they are conventions, patterns enforced by code review rather than by the compiler. Every violation is a latent bug.\u003C/p>\n\u003Ch3 id=\"c-binding-cleanup-to-scope\">C++: Binding Cleanup to Scope\u003C/h3>\n\u003Cp>C++ exploits a property that C has but does not leverage: local variables have a well-defined scope, and when that scope ends, the variable ceases to exist. The language allows us to attach custom cleanup logic to that moment through destructors.\u003C/p>\n\u003Cp>A destructor is a special member function, denoted \u003Ccode>~ClassName()\u003C/code>, that the compiler calls automatically when an objectâ€™s lifetime ends. The call is not optional. It happens regardless of how control flow exits the scope: normal return, early return, exception propagation.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FileReader\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">public\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    explicit\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> FileReader\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">path\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> buffer_size\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">        :\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> buffer_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[buffer_size])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">        ,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> capacity_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(buffer_size)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">        ,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fd_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">open\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(path\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> O_RDONLY))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (fd_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">            delete[]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> buffer_;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            throw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">system_error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(errno\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">generic_category\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    ~FileReader\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (fd_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) ::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">close\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(fd_);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        delete[]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> buffer_;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    FileReader\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FileReader\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> delete\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    FileReader\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">=(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FileReader\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> delete\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">private\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">buffer_;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> capacity_;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> fd_;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When we write:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process_file\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> char\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">path\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    FileReader \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">reader\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(path\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 4096\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    do_something\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(reader);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>the compiler generates an implicit call to \u003Ccode>~FileReader()\u003C/code> at the closing brace, regardless of whether \u003Ccode>do_something\u003C/code> returns normally or throws. We did not write this call; the language guarantees it.\u003C/p>\n\u003Cp>The destruction sequence is precise. After executing the destructor body and destroying any automatic objects declared within it, the compiler destroys all non-static data members in reverse order of their declaration, then all direct base classes in reverse order of construction. This reverse ordering matters: later-declared members may depend on earlier ones, so we tear down in the opposite order we built up.\u003C/p>\n\u003Cp>Consider what this means for exception safety. If any operation between resource acquisition and release throws, the destructor still runs during stack unwinding. We do not need explicit cleanup code on every exit path. The resource management logic is written once, in the destructor, and the compiler inserts the call at every point where it is needed.\u003C/p>\n\u003Cp>The standard library provides RAII wrappers for common resources: \u003Ccode>std::unique_ptr\u003C/code> for exclusive ownership of heap memory, \u003Ccode>std::shared_ptr\u003C/code> for reference-counted shared ownership, \u003Ccode>std::lock_guard\u003C/code> for mutexes, \u003Ccode>std::fstream\u003C/code> for files. Using these types, we rarely write \u003Ccode>new\u003C/code> or \u003Ccode>delete\u003C/code> directly.\u003C/p>\n\u003Cp>But RAII in C++ is opt-in. Nothing prevents us from writing:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> leaky\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // forgot delete[]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Nothing prevents extracting a raw pointer and misusing it:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dangling\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">raw;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> owner \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_unique\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        raw \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> owner\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // owner destroyed here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">raw \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // use-after-free\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler does not track which pointers own and which merely observe. We can bypass RAII entirely with raw \u003Ccode>new\u003C/code> and \u003Ccode>delete\u003C/code>. We can hold raw pointers past their ownersâ€™ lifetimes. We can \u003Ccode>delete\u003C/code> through a base class pointer when the destructor is not virtual, which is undefined behavior even if no resources would leak, because the derived destructor never runs.\u003C/p>\n\u003Cp>C++ gives us the machinery for safe resource management. Using that machinery is a choice the language cannot enforce. A codebase mixing raw pointers, \u003Ccode>unique_ptr\u003C/code>, \u003Ccode>shared_ptr\u003C/code>, and manual \u003Ccode>new\u003C/code>/\u003Ccode>delete\u003C/code> requires reasoning about ownership at every function boundary. The answer is not in the types; it is in the programmersâ€™ heads, in comments, in coding standards. This is better than C, where even the machinery does not exist. But it is not sufficient to eliminate memory safety bugs from large codebases.\u003C/p>\n\u003Ch3 id=\"rust-ownership-in-the-type-system\">Rust: Ownership in the Type System\u003C/h3>\n\u003Cp>Rust takes the RAII pattern and embeds it into the type system as a non-negotiable rule: every value has exactly one owner, and when that owner goes out of scope, the value is dropped. This is not a convention that programmers may follow or ignore. It is a property that the compiler verifies statically.\u003C/p>\n\u003Cp>Consider what happens when we allocate a vector:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The binding \u003Ccode>v\u003C/code> owns the heap-allocated buffer. When \u003Ccode>v\u003C/code> goes out of scope at the closing brace, Rust calls \u003Ccode>drop\u003C/code> on the \u003Ccode>Vec\u003C/code>, which deallocates the buffer. We cannot accidentally forget to free the memory.\u003C/p>\n\u003Cp>The critical mechanism is the move. When we assign a value to another binding, ownership transfers:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After this assignment, \u003Ccode>v1\u003C/code> is no longer valid. Any attempt to use it is a compile-time error. This is not a shallow copy followed by invalidation of the source, as in C++ move semantics where the moved-from object remains in a â€œvalid but unspecified stateâ€ that we can still inspect and call methods on. In Rust, ownership transfer means the source binding ceases to exist as far as the type system is concerned. The compiler marks it as uninitialized. There is no moved-from state.\u003C/p>\n\u003Cp>Why does this matter? Consider what would happen without this rule. If both \u003Ccode>v1\u003C/code> and \u003Ccode>v2\u003C/code> were valid after the assignment, both would attempt to free the same buffer when they went out of scope. The move rule makes double-free impossible: exactly one binding owns the allocation at any time, and exactly one drop occurs.\u003C/p>\n\u003Cp>The same logic applies to function calls. When we pass a value to a function, ownership transfers to the functionâ€™s parameter:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> consume\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // v is owned here; dropped at end of function\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    consume\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // data is no longer valid here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The function signature \u003Ccode>fn consume(v: Vec&#x3C;i32>)\u003C/code> declares that \u003Ccode>consume\u003C/code> takes ownership. The caller cannot use \u003Ccode>data\u003C/code> after the call because ownership has moved. Compare this to \u003Ccode>fn borrow(v: &#x26;Vec&#x3C;i32>)\u003C/code>, which borrows without taking ownership, or \u003Ccode>fn mutate(v: &#x26;mut Vec&#x3C;i32>)\u003C/code>, which borrows mutably. The type encodes the ownership relationship.\u003C/p>\n\u003Ch4 id=\"the-drop-trait-and-recursive-destruction\">The Drop Trait and Recursive Destruction\u003C/h4>\n\u003Cp>When a value goes out of scope, Rust runs its destructor. For types that implement the \u003Ccode>Drop\u003C/code> trait, this means calling the \u003Ccode>drop\u003C/code> method:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FileHandle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    fd\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> FileHandle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { libc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">close\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fd); }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>drop\u003C/code> method receives \u003Ccode>&#x26;mut self\u003C/code>, not \u003Ccode>self\u003C/code>. We cannot move out of \u003Ccode>self\u003C/code> during drop because drop takes a mutable reference. This prevents us from returning the inner file descriptor to avoid closing it. When \u003Ccode>drop\u003C/code> returns, the value is gone.\u003C/p>\n\u003Cp>After \u003Ccode>drop\u003C/code> executes, Rust recursively drops all fields of the struct. This is automatic and unavoidable. If we have:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Connection\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    socket\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> TcpStream\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    buffer\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>and \u003Ccode>Connection\u003C/code> does not implement \u003Ccode>Drop\u003C/code>, Rust still drops \u003Ccode>socket\u003C/code> and \u003Ccode>buffer\u003C/code> when a \u003Ccode>Connection\u003C/code> goes out of scope. The compiler generates this â€œdrop glueâ€ for every type that needs it. We do not write boilerplate to drop children; the language handles it. If \u003Ccode>Connection\u003C/code> does implement \u003Ccode>Drop\u003C/code>, Rust first calls our \u003Ccode>drop\u003C/code> method, then drops the fields. We cannot prevent the recursive field drops. After our \u003Ccode>drop\u003C/code> returns, the fields will be dropped regardless of what we did.\u003C/p>\n\u003Cp>The destruction order is deterministic and specified by the language. For local variables, drop order is the reverse of declaration order: later declarations are dropped first. The rationale is that later variables may hold references to earlier ones, so we must destroy the borrowers before the borrowed. For struct fields, drop order is declaration order (not reversed). For tuples, elements drop in order. For arrays, elements drop from index 0 to the end. For enums, only the active variantâ€™s fields are dropped. Closure captures by move are dropped in an unspecified order, so if destruction order among captured values matters, do not rely on closure drop order.\u003C/p>\n\u003Ch4 id=\"manuallydrop-and-suppressing-automatic-destruction\">ManuallyDrop and Suppressing Automatic Destruction\u003C/h4>\n\u003Cp>The recursive drop behavior creates a problem when we need fine-grained control over destruction. Consider a type that wraps a \u003Ccode>Box\u003C/code> and wants to deallocate the contents in a custom way:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SuperBox\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    my_box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SuperBox\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // Deallocate the box's contents ourselves\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">into_raw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">my_box);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ERROR: cannot move out of &#x26;mut self\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">            std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">alloc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">dealloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Layout\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This does not compile. We cannot move \u003Ccode>self.my_box\u003C/code> out of \u003Ccode>&#x26;mut self\u003C/code>. And even if we could, after our \u003Ccode>drop\u003C/code> returns, Rust would try to drop \u003Ccode>my_box\u003C/code> again, causing a double-free.\u003C/p>\n\u003Cp>One solution is \u003Ccode>Option\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SuperBox\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    my_box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SuperBox\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> let\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">my_box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">take\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // Handle b ourselves; self.my_box is now None\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // When Rust drops self.my_box, it drops None, which does nothing\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This works, but it pollutes our type with \u003Ccode>Option\u003C/code> semantics. A field that should always be \u003Ccode>Some\u003C/code> must be declared as \u003Ccode>Option\u003C/code> solely because of what happens in the destructor. Every access to \u003Ccode>my_box\u003C/code> elsewhere in the code must handle the \u003Ccode>None\u003C/code> case that should never occur outside of \u003Ccode>drop\u003C/code>.\u003C/p>\n\u003Cp>\u003Ccode>ManuallyDrop&#x3C;T>\u003C/code> provides a cleaner solution. It is a wrapper that suppresses automatic drop for its contents:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">ManuallyDrop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SuperBox\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    my_box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ManuallyDrop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> SuperBox\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // Take ownership of the inner Box\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">            let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ManuallyDrop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">take\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">my_box);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // Now we own b and can do whatever we want\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // When our drop returns, Rust will \"drop\" self.my_box,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">            // but ManuallyDrop's drop is a no-op\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>ManuallyDrop&#x3C;T>\u003C/code> has the same size and alignment as \u003Ccode>T\u003C/code>. It implements \u003Ccode>Deref\u003C/code> and \u003Ccode>DerefMut\u003C/code>, so we can use the wrapped value normally. But when Rust drops a \u003Ccode>ManuallyDrop&#x3C;T>\u003C/code>, nothing happens. The inner \u003Ccode>T\u003C/code> is not dropped. We are responsible for dropping it manually via \u003Ccode>ManuallyDrop::drop(&#x26;mut x)\u003C/code> or taking ownership via \u003Ccode>ManuallyDrop::take(&#x26;mut x)\u003C/code>.\u003C/p>\n\u003Cp>This is useful beyond custom destructors. When we need to move a value out of a context where Rust would normally drop it, \u003Ccode>ManuallyDrop\u003C/code> lets us suppress that drop and handle the value ourselves. The \u003Ccode>unsafe\u003C/code> is required because we are taking responsibility for ensuring the value is eventually dropped (or intentionally leaked).\u003C/p>\n\u003Ch4 id=\"drop-flags-and-conditional-initialization\">Drop Flags and Conditional Initialization\u003C/h4>\n\u003Cp>Rust tracks initialization state at compile time when possible. But consider:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> condition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>At the end of scope, should Rust drop \u003Ccode>x\u003C/code>? It depends on whether \u003Ccode>condition\u003C/code> was true. When the compiler cannot determine initialization state statically, it inserts a runtime drop flag: a hidden boolean that tracks whether the value was initialized. At scope exit, Rust checks the flag before calling drop.\u003C/p>\n\u003Cp>For straight-line code and branches that initialize consistently, the compiler can eliminate these flags through static analysis. The flags exist only when genuinely necessary, and the generated code checks them only at points where the initialization state is ambiguous.\u003C/p>\n\u003Ch4 id=\"you-cannot-call-drop-directly\">You Cannot Call Drop Directly\u003C/h4>\n\u003Cp>Rust prevents explicit calls to the \u003Ccode>Drop::drop\u003C/code> method:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: explicit use of destructor method\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If we could call \u003Ccode>drop\u003C/code> directly, the value would still be in scope afterward. When the scope ends, Rust would call \u003Ccode>drop\u003C/code> again. Instead, we use \u003Ccode>std::mem::drop\u003C/code> for early cleanup:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v is moved into drop() and dropped there\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>drop\u003C/code> function takes ownership by value: \u003Ccode>fn drop&#x3C;T>(_: T) {}\u003C/code>. The value moves into the function and is dropped when the function returns. Since ownership moved, the original binding is invalid and no second drop occurs.\u003C/p>\n\u003Ch4 id=\"drop-check-when-lifetimes-and-destructors-collide\">Drop Check: When Lifetimes and Destructors Collide\u003C/h4>\n\u003Cp>We now arrive at a subtle interaction between Rustâ€™s lifetime system and its destructor semantics. Consider this seemingly innocuous code:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Inspector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> World\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    inspector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Inspector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    days\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> world\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> World\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        inspector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        days\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    world\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">inspector \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Inspector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">world\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">days));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This compiles. The \u003Ccode>Inspector\u003C/code> holds a reference to \u003Ccode>days\u003C/code>, both are fields of \u003Ccode>World\u003C/code>, and when \u003Ccode>world\u003C/code> goes out of scope, both are dropped. The fact that \u003Ccode>days\u003C/code> does not strictly outlive \u003Ccode>inspector\u003C/code> does not matter here because neither has a destructor that could observe the other.\u003C/p>\n\u003Cp>But watch what happens when we add a \u003Ccode>Drop\u003C/code> impl to \u003Ccode>Inspector\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Inspector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Inspector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">I was only {} days from retirement!\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> World\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    inspector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Inspector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    days\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> world\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> World\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        inspector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        days\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    world\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">inspector \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Inspector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">world\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">days));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This does not compile:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>error[E0597]: `world.days` does not live long enough\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>What changed? The \u003Ccode>Drop\u003C/code> implementation. When \u003Ccode>Inspector\u003C/code> has a destructor, that destructor might access the reference it holds. If \u003Ccode>days\u003C/code> is dropped before \u003Ccode>inspector\u003C/code>, the destructor would dereference freed memory. The borrow checker must now enforce that any data borrowed by \u003Ccode>Inspector\u003C/code> outlives the \u003Ccode>Inspector\u003C/code> itself, because the destructor could observe that data.\u003C/p>\n\u003Cp>This is the drop checker (dropck). It enforces a stricter rule when types have destructors: for a generic type to soundly implement drop, its generic arguments must strictly outlive it. Not \u003Cem>live at least as long as\u003C/em>, but \u003Cem>strictly outlive\u003C/em>. The difference is subtle. Without a destructor, two values can go out of scope simultaneously because neither observes the other during destruction. With a destructor, the type with the destructor might observe its borrowed data, so that data must still be valid when the destructor runs.\u003C/p>\n\u003Cp>Only generic types need to worry about this. If a type is not generic, the only lifetimes it can contain are \u003Ccode>'static\u003C/code>, which truly lives forever. The problem arises when a type is generic over a lifetime or a type parameter, and it implements \u003Ccode>Drop\u003C/code>, and that \u003Ccode>Drop\u003C/code> could potentially access the borrowed data.\u003C/p>\n\u003Ch4 id=\"the-may_dangle-escape-hatch\">The \u003Ccode>#[may_dangle]\u003C/code> Escape Hatch\u003C/h4>\n\u003Cp>The drop checker is conservative. It assumes that any \u003Ccode>Drop\u003C/code> impl for a generic type might access data of the generic parameter. But this is often not true. Consider \u003Ccode>Vec&#x3C;T>\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Deallocate the buffer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // We DO drop each T element, but we don't \"use\" T in the sense\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // of accessing references that T might contain\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When we drop a \u003Ccode>Vec&#x3C;&#x26;'a str>\u003C/code>, we deallocate the buffer. We do call drop on each \u003Ccode>&#x26;'a str\u003C/code> element, but \u003Ccode>&#x26;'a str\u003C/code> has no destructor; its drop is a no-op. The \u003Ccode>Vec\u003C/code>â€™s drop does not actually dereference those \u003Ccode>&#x26;'a str\u003C/code> values. It does not read the strings. It just deallocates the backing memory.\u003C/p>\n\u003Cp>Yet the drop checker does not know this. It sees \u003Ccode>impl&#x3C;'a> Drop for Vec&#x3C;&#x26;'a str>\u003C/code> and concludes that \u003Ccode>'a\u003C/code> must strictly outlive the \u003Ccode>Vec\u003C/code>. This prevents code like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">Short-lived\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">into\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// s dropped while v still holds a reference\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is correctly rejected. But it also rejects:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">Short-lived\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">into\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// s and v dropped here, but in what order?\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The second example should be fine. Both \u003Ccode>v\u003C/code> and \u003Ccode>s\u003C/code> are dropped at the end of \u003Ccode>main\u003C/code>. Variables are dropped in reverse declaration order, so \u003Ccode>v\u003C/code> drops first, then \u003Ccode>s\u003C/code>. By the time \u003Ccode>s\u003C/code> drops, \u003Ccode>v\u003C/code> is already gone. The references in \u003Ccode>v\u003C/code> are never dereferenced during \u003Ccode>v\u003C/code>â€™s destruction.\u003C/p>\n\u003Cp>To allow this pattern, Rust provides an unstable, unsafe attribute: \u003Ccode>#[may_dangle]\u003C/code>. It tells the drop checker â€œI promise not to access this generic parameter in my destructorâ€:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;#[may_dangle] \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>#[may_dangle]\u003C/code> on \u003Ccode>T\u003C/code> is a promise that the \u003Ccode>Drop\u003C/code> impl does not access \u003Ccode>T\u003C/code> values in a way that requires them to be valid. The drop checker relaxes its requirements: \u003Ccode>T\u003C/code> may now dangle (be a reference to freed memory) when the \u003Ccode>Vec\u003C/code> is dropped.\u003C/p>\n\u003Cp>But this is a lie, or at least an incomplete truth. \u003Ccode>Vec&#x3C;T>\u003C/code>â€™s destructor does drop each \u003Ccode>T\u003C/code> element. If \u003Ccode>T\u003C/code> has a destructor that accesses borrowed data, that data must still be valid. The promise is more precisely: â€œI do not access \u003Ccode>T\u003C/code> myself, but I may trigger \u003Ccode>T\u003C/code>â€™s destructor.â€ This distinction matters for the soundness of the overall system.\u003C/p>\n\u003Ch4 id=\"phantomdata-and-drop-check-interaction\">PhantomData and Drop Check Interaction\u003C/h4>\n\u003Cp>When we use \u003Ccode>#[may_dangle]\u003C/code>, we are opting out of the drop checkerâ€™s conservative assumptions. But we must opt back in for cases where we do transitively drop \u003Ccode>T\u003C/code>. This is where \u003Ccode>PhantomData\u003C/code> enters the picture.\u003C/p>\n\u003Cp>Consider the actual implementation of \u003Ccode>Vec\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// raw pointer, no ownership semantics\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    cap\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A raw pointer \u003Ccode>*const T\u003C/code> does not imply ownership. The drop checker does not assume that \u003Ccode>Vec\u003C/code> owns \u003Ccode>T\u003C/code> values just because it contains a \u003Ccode>*const T\u003C/code>. If we write:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;#[may_dangle] \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // drop elements, deallocate buffer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>we have told the drop checker that \u003Ccode>T\u003C/code> may dangle. But \u003Ccode>Vec\u003C/code> does own \u003Ccode>T\u003C/code> values and does drop them. If \u003Ccode>T\u003C/code> is \u003Ccode>PrintOnDrop&#x3C;'a>\u003C/code> (a type with a destructor that dereferences \u003Ccode>'a\u003C/code>), then \u003Ccode>'a\u003C/code> must be valid when \u003Ccode>Vec\u003C/code> drops, because \u003Ccode>Vec\u003C/code> will invoke \u003Ccode>T\u003C/code>â€™s destructor.\u003C/p>\n\u003Cp>We need to tell the drop checker: â€œ\u003Ccode>T\u003C/code> may dangle, except if \u003Ccode>T\u003C/code> itself has drop glue that would observe borrowed data.â€ The mechanism for this is \u003Ccode>PhantomData&#x3C;T>\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">marker\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">PhantomData\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    cap\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    _marker\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PhantomData\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>PhantomData&#x3C;T>\u003C/code> is a zero-sized type that tells the compiler â€œact as if this struct owns a \u003Ccode>T\u003C/code>.â€ It affects variance, auto-trait inference, and critically, drop check. When the drop checker sees \u003Ccode>PhantomData&#x3C;T>\u003C/code> in a struct, it knows that dropping the struct may involve dropping \u003Ccode>T\u003C/code> values.\u003C/p>\n\u003Cp>The interaction is:\u003C/p>\n\u003Col>\n\u003Cli>\u003Ccode>#[may_dangle] T\u003C/code> on the \u003Ccode>Drop\u003C/code> impl says â€œI promise not to access \u003Ccode>T\u003C/code> directly in my destructor.â€\u003C/li>\n\u003Cli>\u003Ccode>PhantomData&#x3C;T>\u003C/code> in the struct says â€œbut I do own \u003Ccode>T\u003C/code> values and will drop them.â€\u003C/li>\n\u003Cli>The drop checker combines these: \u003Ccode>T\u003C/code> itself may dangle (its references may be invalid), but if \u003Ccode>T\u003C/code> has drop glue, that glue will run, and whatever \u003Ccode>T\u003C/code>â€™s glue accesses must still be valid.\u003C/li>\n\u003C/ol>\n\u003Cp>This is subtle. Suppose \u003Ccode>T\u003C/code> is \u003Ccode>&#x26;'a str\u003C/code>. The type \u003Ccode>&#x26;'a str\u003C/code> has no destructor (dropping a reference is a no-op). So \u003Ccode>PhantomData&#x3C;&#x26;'a str>\u003C/code> does not introduce additional constraints. The \u003Ccode>#[may_dangle]\u003C/code> applies fully, and \u003Ccode>'a\u003C/code> may dangle.\u003C/p>\n\u003Cp>Now suppose \u003Ccode>T\u003C/code> is \u003Ccode>PrintOnDrop&#x3C;'a>\u003C/code>, a type with a destructor that dereferences \u003Ccode>'a\u003C/code>. The \u003Ccode>PhantomData&#x3C;PrintOnDrop&#x3C;'a>>\u003C/code> tells the drop checker that \u003Ccode>Vec\u003C/code> will drop \u003Ccode>PrintOnDrop&#x3C;'a>\u003C/code> values. The \u003Ccode>#[may_dangle]\u003C/code> says \u003Ccode>Vec\u003C/code> itself wonâ€™t access \u003Ccode>'a\u003C/code>. But dropping \u003Ccode>PrintOnDrop&#x3C;'a>\u003C/code> will access \u003Ccode>'a\u003C/code>. So \u003Ccode>'a\u003C/code> must still be valid when \u003Ccode>Vec\u003C/code> is dropped, despite the \u003Ccode>#[may_dangle]\u003C/code>.\u003C/p>\n\u003Cp>The rules compose correctly. The \u003Ccode>#[may_dangle]\u003C/code> is not a blanket permission to let everything dangle. It is permission for the specific \u003Ccode>Drop\u003C/code> impl to not access the parameter, combined with the \u003Ccode>PhantomData\u003C/code> indicating that transitive drops may still occur.\u003C/p>\n\u003Cp>Without \u003Ccode>#[may_dangle]\u003C/code>, implementing a collection like \u003Ccode>Vec\u003C/code> would be unnecessarily restrictive. Every \u003Ccode>Vec&#x3C;&#x26;'a T>\u003C/code> would require \u003Ccode>'a\u003C/code> to strictly outlive the \u003Ccode>Vec\u003C/code>, even when the \u003Ccode>Vec\u003C/code> is dropped before the borrowed data goes out of scope. The combination of \u003Ccode>#[may_dangle]\u003C/code> and \u003Ccode>PhantomData\u003C/code> allows the standard library to express the precise ownership semantics: â€œwe will drop \u003Ccode>T\u003C/code> values, but we do not otherwise observe them in our destructor.â€\u003C/p>\n\u003Ch4 id=\"leaks-are-safe\">Leaks Are Safe\u003C/h4>\n\u003Cp>Here we encounter a design decision that surprises many: leaking memory is safe in Rust. The function \u003Ccode>std::mem::forget\u003C/code> takes ownership of a value and does not run its destructor:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">forget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v's destructor never runs; the heap allocation is leaked\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is a safe function. It does not require \u003Ccode>unsafe\u003C/code>. The reasoning is that \u003Cem>safe\u003C/em> in Rust means \u003Cem>cannot cause undefined behavior\u003C/em>. Leaking memory is wasteful, but it does not corrupt memory, create dangling pointers, or cause data races. A program that leaks is buggy but not undefined.\u003C/p>\n\u003Cp>Moreover, leaks can occur in safe code without calling \u003Ccode>forget\u003C/code>. The simplest example is a reference cycle with \u003Ccode>Rc\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cell\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">RefCell\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    next\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">RefCell\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> create_cycle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(RefCell\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">next\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(RefCell\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Node\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">next\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()) }));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">borrow_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">next \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When \u003Ccode>create_cycle\u003C/code> returns, the \u003Ccode>Rc\u003C/code>s go out of scope, but each has a reference count of 2 due to the cycle. The count decrements to 1, not 0. The nodes are never freed. This is safe code with no \u003Ccode>unsafe\u003C/code> blocks, and it leaks.\u003C/p>\n\u003Cp>Since leaks are possible in safe code, the language cannot assume destructors always run. This has profound implications for unsafe code. Any type whose safety invariants depend on the destructor running is unsound in the presence of \u003Ccode>mem::forget\u003C/code> or cycles.\u003C/p>\n\u003Cp>The standard library learned this lesson with \u003Ccode>thread::scoped\u003C/code>, an API that allowed spawning threads referencing stack data. It relied on a guard whose destructor joined the thread:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> scoped\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">f\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> JoinGuard\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">where\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> FnOnce\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Send\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The guardâ€™s lifetime tied it to the borrowed data. When the guard dropped, it joined the thread, ensuring the thread finished before the data went out of scope. But \u003Ccode>mem::forget(guard)\u003C/code> prevented the destructor from running. The thread would continue executing while the stack data it referenced was freed. Use-after-free from safe code. The API was unsound and had to be removed.\u003C/p>\n\u003Cp>The correct design principle is that unsafe code cannot rely on destructors running to maintain safety invariants. Safe abstractions must account for the possibility that destructors are skipped. The standard libraryâ€™s \u003Ccode>Vec::drain\u003C/code> is a good example. Draining a vector moves elements out one at a time. If the drain iterator is forgotten mid-iteration, some elements have been moved out and the vectorâ€™s length is wrong. Rather than leaving the vector in an inconsistent state, \u003Ccode>Drain\u003C/code> sets the vectorâ€™s length to zero at the start of iteration. If \u003Ccode>Drain\u003C/code> is forgotten, the remaining elements leak (their destructors do not run, their memory is not reused), but the vector is in a valid state (empty). Leaks amplify leaks, but undefined behavior does not occur.\u003C/p>\n\u003Ch2 id=\"beyond-raii\">Beyond RAII\u003C/h2>\n\u003Cp>We have built a comprehensive picture of ownership. Rust makes ownership tracking mandatory and statically verified. Yet even Rustâ€™s model has limits.\u003C/p>\n\u003Ch3 id=\"the-single-destructor-problem\">The Single-Destructor Problem\u003C/h3>\n\u003Cp>The RAII model, whether in C++ or Rust, shares a structural limitation: the destructor is a single, parameterless function that returns nothing. When an object goes out of scope, exactly one action occurs. We cannot choose between alternatives. We cannot pass runtime information to the cleanup logic. We cannot receive a result from it.\u003C/p>\n\u003Cp>For many resources this constraint is invisible. A file handle has one sensible cleanup action: close the descriptor. A heap allocation has one cleanup action: free the memory. A mutex guard has one cleanup action: unlock the mutex. The destructor does the obvious thing, and the single-destructor model works well.\u003C/p>\n\u003Cp>But consider a database transaction. A transaction must eventually either commit (make changes permanent) or rollback (discard changes). These are fundamentally different operations with different semantics, different failure modes, and often different parameters. A commit might require a priority level. A rollback might need to log the reason for abandonment. The destructor cannot accommodate this. It must pick one.\u003C/p>\n\u003Cp>The standard workaround in C++ and Rust is to default to rollback and provide an explicit \u003Ccode>commit\u003C/code> method:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">public\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    explicit\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Database\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> db\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> db_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(db)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> committed_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">false\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        db_\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">begin\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> commit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        db_\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">commit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        committed_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> true\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    ~Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">committed_) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">            db_\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rollback\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">private\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    Database\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db_;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> committed_;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We call \u003Ccode>commit()\u003C/code> when the transaction succeeds and let the destructor rollback on error paths or early returns. Exception safety falls out naturally; if an exception propagates, the destructor runs, and uncommitted transactions rollback.\u003C/p>\n\u003Cp>The problem is that forgetting to call \u003Ccode>commit()\u003C/code> is not a compile-time error. If we write a function that successfully completes its work but neglects to call \u003Ccode>commit()\u003C/code>, the destructor happily rolls back. The program is wrong, but the compiler cannot tell us. We have traded one category of bug (forgetting to cleanup) for another (forgetting to finalize). The second category is arguably more insidious because the cleanup happens, silently doing the wrong thing.\u003C/p>\n\u003Cp>Rustâ€™s ownership system does not help here:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Database\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    committed\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> commit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">commit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">committed \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> true\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">committed {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">            self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rollback\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>commit\u003C/code> method takes \u003Ccode>self\u003C/code> by value, consuming the transaction. After calling \u003Ccode>commit\u003C/code>, the binding is gone. But if we never call \u003Ccode>commit\u003C/code>, the transaction goes out of scope, \u003Ccode>drop\u003C/code> runs, and we rollback. No compiler error. The type system tracked ownership but not obligation.\u003C/p>\n\u003Ch3 id=\"defer-explicit-scope-bound-cleanup\">Defer: Explicit Scope-Bound Cleanup\u003C/h3>\n\u003Cp>Some languages take a different approach. Rather than binding cleanup to object destruction, they provide explicit defer statements that execute at scope exit.\u003C/p>\n\u003Cp>Zigâ€™s \u003Ccode>defer\u003C/code> runs an expression unconditionally when control leaves the enclosing block:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"zig\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> processFile\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">path\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> []\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">!void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> file\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> try\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">fs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">cwd\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">openFile\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">path\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{});\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    defer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> file\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">close\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> buffer\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> try\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> allocator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">alloc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4096\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    defer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> allocator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">free\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">buffer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // work with file and buffer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // both are cleaned up when we exit, regardless of how\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The cleanup code sits immediately after the acquisition code. We see allocation and deallocation together, which aids comprehension. Zig extends this with \u003Ccode>errdefer\u003C/code>, which executes only if the function returns an error, separating error-path cleanup from success-path transfer.\u003C/p>\n\u003Cp>The defer model has a structural limitation that RAII does not: the cleanup is scope-bound. We cannot return a resource to our caller the way we return an RAII object. The defer runs when the current scope exits, period. RAII is more flexible; we can return an RAII object, store it in a data structure, transfer ownership to another thread. The cleanup travels with the object. Defer is local; RAII is transferable.\u003C/p>\n\u003Cp>But defer has an advantage in simplicity. We do not need to define a type, implement a trait, worry about drop order among struct fields. We write the cleanup code inline, at the point of acquisition. For resources that do not leave the current function, defer is often cleaner.\u003C/p>\n\u003Ch3 id=\"linear-types-enforcing-explicit-consumption\">Linear Types: Enforcing Explicit Consumption\u003C/h3>\n\u003Cp>The transaction example shows a gap in RAIIâ€™s guarantees. RAII ensures that cleanup happens, but not that we made an explicit decision about \u003Cem>which\u003C/em> cleanup to perform. The destructor chooses for us, silently.\u003C/p>\n\u003Cp>Linear types close this gap. A linear type must be explicitly consumed; it cannot simply go out of scope. If we try to let a linear value fall out of scope without passing it to a consuming function, the compiler rejects the program.\u003C/p>\n\u003Cp>Consider a hypothetical extension to Rust:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Hypothetical syntax\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[linear]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Database\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> commit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">txn\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;(), \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    txn\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">commit\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    destruct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> txn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// explicitly consume\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> rollback\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">txn\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">reason\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    txn\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">rollback\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    destruct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> txn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// explicitly consume\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> do_work\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Database\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> txn\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Transaction\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">db\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ERROR: `txn` goes out of scope without being consumed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // must call either commit(txn) or rollback(txn, ...)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The transaction cannot be ignored. Forgetting to decide is a compile-time error, not a runtime silent rollback. Languages with linear types (Vale, Austral, and to some extent Haskell with LinearTypes) can express patterns that RAII cannot.\u003C/p>\n\u003Ch3 id=\"why-rust-does-not-have-linear-types\">Why Rust Does Not Have Linear Types\u003C/h3>\n\u003Cp>Rustâ€™s types are affine, not linear. An affine type can be used \u003Cem>at most\u003C/em> once; a linear type must be used \u003Cem>exactly\u003C/em> once. The difference matters when panics unwind the stack.\u003C/p>\n\u003Cp>Rust permits silent dropping because \u003Ccode>Drop::drop\u003C/code> must always be callable. When a scope exits, when a panic unwinds, when we reassign a variable, Rust calls \u003Ccode>drop\u003C/code>. The entire language assumes that any value can be dropped at any time.\u003C/p>\n\u003Cp>Linear types would break this assumption. If a value must be explicitly consumed, what happens when a panic unwinds through a function holding that value? The unwinding code cannot know which consuming function to call, what parameters to pass, what to do with the return value. Every generic container, every iterator adapter, every function that might discard a value would need to be reconsidered.\u003C/p>\n\u003Cp>Rust chose affine types, accepting that the compiler cannot enforce explicit consumption but gaining a simpler model where any value can be dropped. The \u003Ccode>#[must_use]\u003C/code> attribute provides a weaker guarantee: a warning (not an error) if a value is unused. It catches some mistakes but does not provide the hard guarantee that linear types would.\u003C/p>\n\u003Ch2 id=\"move-semantics\">Move Semantics\u003C/h2>\n\u003Cp>All this discussion about ownership assumes that ownership can be transferred efficiently. When we say a value â€œmovesâ€ from one binding to another, what actually happens to the bytes? And why is this operation preferable to copying?\u003C/p>\n\u003Cp>The answer varies dramatically across C, C++, and Rust, and the differences expose fundamental assumptions each language makes about values, identity, and resources.\u003C/p>\n\u003Ch3 id=\"the-cost-of-copies\">The Cost of Copies\u003C/h3>\n\u003Cp>Consider what happens when we pass a value to a function. In the simplest model, the callerâ€™s value is copied into the calleeâ€™s parameter. For a 32-bit integer, this means copying 4 bytes, negligible. But what about a dynamically-sized container?\u003C/p>\n\u003Cp>A \u003Ccode>std::vector&#x3C;int>\u003C/code> in C++ or a \u003Ccode>Vec&#x3C;i32>\u003C/code> in Rust has a particular structure: a pointer to heap-allocated storage, a length, and a capacity. The struct itself is small (typically 24 bytes on 64-bit systems), but it can own a large heap allocation.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> data;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> len;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 8 bytes  \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> cap;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// sizeof(Vec) == 24, but data might point to way more memory\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If we copy this struct byte-for-byte, we produce two \u003Ccode>Vec\u003C/code> instances pointing to the same heap allocation. This is a shallow copy. It creates a problem: both instances believe they own the memory. When one destructor frees it, the otherâ€™s pointer dangles. When the second destructor runs, it double-frees.\u003C/p>\n\u003Cp>The alternative is a deep copy: allocate new heap storage, copy all data, and update the new structâ€™s pointer. This is correct but expensive. Copying takes time. More importantly, it allocates memory, which involves a system call (or at minimum, allocator bookkeeping) and pollutes the cache with data we may never touch again.\u003C/p>\n\u003Cp>The overhead becomes prohibitive when values pass through function boundaries repeatedly. A function that takes a \u003Ccode>vector\u003C/code> by value, processes it, and returns a new \u003Ccode>vector\u003C/code> might copy millions of bytes twiceÃ¢â‚¬â€once on entry, once on return. In performance-sensitive code, we want to avoid passing large objects by value entirely, preferring pointers or references. But this complicates APIs and obscures ownership.\u003C/p>\n\u003Ch3 id=\"the-shallow-copy-escape\">The Shallow Copy Escape\u003C/h3>\n\u003Cp>We can observe however that when we pass a vector to a function that consumes it, the caller no longer needs its copy. The bytes in the callerâ€™s stack frame become dead immediately after the call. If we could somehow \u003Cem>transfer\u003C/em> ownership without physically duplicating the heap data, we would get the clarity of value semantics with the efficiency of pointer passing.\u003C/p>\n\u003Cp>This is exactly what move semantics provide. Instead of copying the entire data structure, we copy only the struct (the pointer, length, and capacity), then invalidate the source somehow so it does not attempt cleanup.\u003C/p>\n\u003Cp>The \u003Cem>somehow\u003C/em> is where languages diverge.\u003C/p>\n\u003Cp>In C, there is no language-level support. We must implement this manually:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typedef\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> data;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> cap;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} Vec;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> transfer\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> dest\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> src\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">dest \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">src;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           // shallow copy the struct\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> NULL\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">       // invalidate source\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    src\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">cap\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After \u003Ccode>transfer\u003C/code>, the destination owns the heap memory, and the source is in a \u003Cem>moved-from\u003C/em> state (nulled pointers, zero sizes). This works, but nothing enforces it. We can still access \u003Ccode>src->data\u003C/code> after the transfer. However, we would read NULL, or worse, the invalidation was forgotten and we would read a pointer that someone else will free.\u003C/p>\n\u003Ch3 id=\"c11-rvalue-references-and-move-semantics\">C++11: Rvalue References and Move Semantics\u003C/h3>\n\u003Cp>Before C++11, the language had one kind of reference: the lvalue reference, written \u003Ccode>T&#x26;\u003C/code>. An lvalue is roughly â€œsomething with a name and an addressâ€, a variable, a dereferenced pointer, an array element. Lvalue references bind to lvalues and provide aliased access to existing objects.\u003C/p>\n\u003Cp>But consider a temporary:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 4\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> consume\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">consume\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // the argument is a temporary\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The return value of \u003Ccode>make_vector()\u003C/code> is not an lvalue, it has no name, no persistent storage, no address we can take. It is an rvalue, a temporary that will be destroyed at the end of the full expression. Before C++11, passing this temporary to \u003Ccode>consume\u003C/code> meant copying it, even though the original was about to disappear. We duplicated data that would be destroyed moments later.\u003C/p>\n\u003Cp>C++11 introduced rvalue references, written \u003Ccode>T&#x26;&#x26;\u003C/code>. An rvalue reference binds to rvalues; temporaries, expressions, values returned by functions. The type system now distinguishes â€œI want to observe this objectâ€ (\u003Ccode>const T&#x26;\u003C/code>) from â€œI want to steal from this objectâ€ (\u003Ccode>T&#x26;&#x26;\u003C/code>).\u003C/p>\n\u003Cp>This distinction enables overloading. A class can define two versions of a constructor:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">public\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Copy constructor: source is const lvalue reference\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        data_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">cap_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">copy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">data_\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">data_\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">len_\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> data_);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        len_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">len_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        cap_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">cap_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Move constructor: source is rvalue reference\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">noexcept\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        data_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">data_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        len_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">len_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        cap_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">cap_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Invalidate source\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">data_\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> nullptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">len_\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">cap_\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When the argument is an rvalue (a temporary, or the result of \u003Ccode>std::move\u003C/code>), overload resolution selects the move constructor. We perform the shallow copy and invalidate the source, exactly as in the C version, but now the selection happens automatically based on value category.\u003C/p>\n\u003Cp>The key insight is that \u003Ccode>std::move\u003C/code> does not move anything. It is a cast:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">constexpr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">remove_reference_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">noexcept\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> static_cast\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">remove_reference_t\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>&#x26;&#x26;>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(t);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>It takes a reference (of any kind, due to reference collapsing) and returns an rvalue reference to the same object. The object does not move. We simply change how the type system categorizes it.\u003C/p>\n\u003Cp>This cast enables us to move from named variables:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v1{\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v2 \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(v1);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // v1 cast to rvalue, move constructor called\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After this line, \u003Ccode>v2\u003C/code> owns the heap allocation that \u003Ccode>v1\u003C/code> previously owned. \u003Ccode>v1\u003C/code> is in a moved-from state: its data pointer is null, its length and capacity are zero. The destructor will run when \u003Ccode>v1\u003C/code> goes out of scope, but it will do nothing because there is nothing to free.\u003C/p>\n\u003Ch4 id=\"the-implicitly-declared-move-constructor\">The Implicitly-Declared Move Constructor\u003C/h4>\n\u003Cp>The compiler can generate move constructors automatically. If a class has no user-declared copy constructor, copy assignment operator, move assignment operator, or destructor, the compiler declares an implicit move constructor. This implicit version performs member-wise move: for each non-static data member, it moves that member using the memberâ€™s own move constructor (or copies it, for types without move constructors).\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Wrapper\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> data;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">string name;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> id;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // implicit move constructor:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Wrapper(Wrapper&#x26;&#x26; other) noexcept\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    //     : data(std::move(other.data))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    //     , name(std::move(other.name))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    //     , id(other.id) {}\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // int is trivially movable (just copied)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For trivially movable types (essentially, types compatible with C), the move constructor copies the object representation as if by \u003Ccode>std::memmove\u003C/code>. No per-member move occurs at runtime; the operation reduces to a memory copy of the structâ€™s bytes.\u003C/p>\n\u003Cp>The rule about user-declared special member functions is important. If we declare a destructor (even a defaulted one), the implicit move constructor is not generated:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> data;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    ~C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {}\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // destructor declared, even though empty\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">C c1;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">C c2 \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(c1);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // calls copy constructor, not move!\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This behavior exists because a user-declared destructor suggests the class manages resources in ways the compiler cannot infer. The conservative choice is to fall back to copying. We can force generation of the move constructor with \u003Ccode>= default\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> D\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> data;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    ~D\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    D\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">D\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> default\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // explicitly request move constructor\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch4 id=\"move-assignment\">Move Assignment\u003C/h4>\n\u003Cp>The same pattern applies to assignment. The move assignment operator takes an rvalue reference and transfers ownership:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">=(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">noexcept\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#7FDBCA\">this\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> !=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">other) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">        delete[]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> data_;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // free our current storage\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        data_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">data_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        len_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">len_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        cap_ \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">cap_\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">data_\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\"> nullptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">len_\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">        other\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">cap_\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#7FDBCA\">this\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The self-assignment check is necessary because \u003Ccode>std::move\u003C/code> can be applied to any lvalue, including the left-hand side of the assignment itself (though this would be perverse).\u003C/p>\n\u003Cp>The destructor of the moved-from object still runs. Move semantics transfer ownership of \u003Cem>resources\u003C/em>, but the source object continues to exist until its scope ends. The moved-from state must be valid enough for the destructor to execute safely. For \u003Ccode>vector\u003C/code>, that means null pointer and zero lengths,the destructor checks for null before freeing, or simply has no work to do.\u003C/p>\n\u003Cp>The \u003Ccode>noexcept\u003C/code> specification on move constructors matters for optimization. \u003Ccode>std::vector\u003C/code> needs to relocate elements when it grows. If the element typeâ€™s move constructor is \u003Ccode>noexcept\u003C/code>, the vector can move elements to the new buffer. If it might throw, the vector must copy instead to preserve the strong exception guaranteeÃ¢â‚¬â€if an exception occurs during relocation, the original vector must remain intact. The difference can be dramatic for vectors of vectors.\u003C/p>\n\u003Ch4 id=\"value-categories-in-depth\">Value Categories in Depth\u003C/h4>\n\u003Cp>C++11 refined the notion of value categories beyond the simple lvalue/rvalue split. We have three categories:\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>An \u003Cstrong>lvalue\u003C/strong> designates an object with identity that persists beyond a single expression. Variables, function returns by reference, dereferenced pointers. The address can be taken.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>A \u003Cstrong>prvalue\u003C/strong> (pure rvalue) is a temporary with no identity. Literals, function returns by value (before binding), results of arithmetic expressions. These initialize objects or compute values, but have no persistent address.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>An \u003Cstrong>xvalue\u003C/strong> (expiring value) has identity but can be moved from. The result of \u003Ccode>std::move()\u003C/code>, the result of a cast to rvalue reference, the return value of a function returning \u003Ccode>T&#x26;&#x26;\u003C/code>. The object exists, has an address, but we have permission to transfer its resources.\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>Overload resolution uses these categories:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // lvalue reference overload\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Widget\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // const lvalue reference overload  \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">       // rvalue reference overload\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">Widget w;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget cw;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(w);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                // calls f(Widget&#x26;)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(cw);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">               // calls f(const Widget&#x26;)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget{});\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">         // calls f(Widget&#x26;&#x26;) - prvalue\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(w));\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     // calls f(Widget&#x26;&#x26;) - xvalue\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When both \u003Ccode>const T&#x26;\u003C/code> and \u003Ccode>T&#x26;&#x26;\u003C/code> overloads exist, rvalues (prvalues and xvalues) prefer the \u003Ccode>T&#x26;&#x26;\u003C/code> overload. Lvalues can only bind to the lvalue reference overloads. If only \u003Ccode>const T&#x26;\u003C/code> is provided, it accepts everythingÃ¢â‚¬â€rvalues bind to const lvalue references, which is why copying was the fallback before C++11.\u003C/p>\n\u003Cp>This machinery operates entirely at compile time. By the time we reach machine code, there are no value categories, no rvalue references, just addresses and data. The type systemâ€™s job was to select the right constructor or operator; having done so, the generated code performs the memory operations we specified.\u003C/p>\n\u003Ch3 id=\"the-moved-from-problem\">The Moved-From Problem\u003C/h3>\n\u003Cp>We have seen that in C++ rvalue references enable overloading, move constructors transfer resources, \u003Ccode>std::move\u003C/code> casts to rvalue. But we glossed over a critical detail. After a move, what happens to the source object?\u003C/p>\n\u003Cp>The source object still exists. It has a name, an address, a type. The destructor will run when it goes out of scope. We can call methods on it, read its fields, pass it to functions. The move constructor transferred its \u003Cem>resources\u003C/em>, but the object itself remains.\u003C/p>\n\u003Cp>The C++ standard describes moved-from objects as being in a \u003Cem>valid but unspecified state\u003C/em>. Here \u003Cem>Valid\u003C/em> means the object satisfies the invariants of its type sufficiently to be destroyed and to have certain operations performed on it (typically assignment and, for some types, queries like \u003Ccode>empty()\u003C/code>). \u003Cem>Unspecified\u003C/em> means we cannot know what values its members hold without inspecting them.\u003C/p>\n\u003Cp>For \u003Ccode>std::unique_ptr\u003C/code>, the moved-from state is fully specified: the pointer becomes null. We can observe this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">unique_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_unique\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">unique_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> q \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(p);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// p still exists, and we can use it\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (p) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">p;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // does not execute\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">} \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">p is null\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // this executes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> raw \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">get\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // returns nullptr\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">p\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">reset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">new\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">7\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">));\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> // we can even reuse p\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The moved-from \u003Ccode>unique_ptr\u003C/code> is a perfectly functional object. It holds a null pointer, knows it holds a null pointer, and behaves consistently. The \u003Ccode>get()\u003C/code> method returns null. The \u003Ccode>bool\u003C/code> conversion returns false. We can \u003Ccode>reset()\u003C/code> it with a new pointer and continue using it. This is well-defined behavior.\u003C/p>\n\u003Cp>For \u003Ccode>std::vector\u003C/code>, the situation is murkier. The standard guarantees only that the moved-from vector is in a \u003Cem>valid but unspecified state\u003C/em>. In practice, most implementations leave it empty:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v1{\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 4\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v2 \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(v1);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // likely prints 0, but not guaranteed\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The output is \u003Cem>likely\u003C/em> zero because implementations typically null out the sourceâ€™s data pointer and set its size to zero. But the standard does not require this. An implementation could leave \u003Ccode>v1\u003C/code> with garbage values, a dangling pointer, or some other state that satisfies \u003Cem>valid\u003C/em> (meaning the destructor and assignment still work) without being predictable.\u003C/p>\n\u003Cp>Here is where the design becomes problematic. The compiler does not prevent us from using moved-from objects. There is no warning, no error, nothing. If we forget that we moved from a variable and try to use it, the code compiles and runs:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v{\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 4\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(v));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Bug: v has been moved from\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v) {\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">         // compiles fine\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> // prints nothing, or garbage, or crashes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is not undefined behavior in the strict sense. Iterating over an empty vector is well-defined, but it is almost certainly a bug. The programmer intended to iterate over the original data and forgot that \u003Ccode>process\u003C/code> consumed it. The program silently does the wrong thing.\u003C/p>\n\u003Cp>The cppreference example demonstrates this explicitly:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">A a1 \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">A\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">Before move, a1.s = \u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">quoted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">a1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">          &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\"> a1.k = \u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> a1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> '\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">A a2 \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">move\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(a1);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">After move, a1.s = \u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">quoted\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">a1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">          &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\"> a1.k = \u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> a1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">k\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> &#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> '\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">'\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Output:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>Before move, a1.s = \"test\" a1.k = -1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>After move, a1.s = \"\" a1.k = 0\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The moved-from object is accessible, observable, and the program continues without complaint. The \u003Ccode>std::string\u003C/code> member is empty; the \u003Ccode>int\u003C/code> member is zero.\u003C/p>\n\u003Cp>The fundamental issue here is that C++ chose to preserve the moved-from objectâ€™s existence for backward compatibility and flexibility. Some use cases genuinely benefit from reusing moved-from objects, reassigning to them, or swapping with another object. The cost of this flexibility is that the type system cannot enforce the discipline of â€œdonâ€™t use it after moving.â€\u003C/p>\n\u003Cp>Static analyzers and compilers can sometimes detect use-after-move, but they cannot do so reliably in all cases. The analysis is flow-sensitive and context-dependent, and function boundaries obscure the dataflow. A function that takes \u003Ccode>T&#x26;&#x26;\u003C/code> might move from its parameter, or it might not, the caller cannot tell from the signature alone.\u003C/p>\n\u003Ch3 id=\"rust-moves-without-ghosts\">Rust: Moves Without Ghosts\u003C/h3>\n\u003Cp>Rust takes a different approach entirely. When a value moves, the source binding becomes invalid. Not valid but unspecified, \u003Cem>invalid\u003C/em>. The compiler rejects any subsequent use:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> in\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {         \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: use of moved value: `v`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The error message is unambiguous:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>error[E0382]: use of moved value: `v`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> --> src/main.rs:7:14\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>4 |     let v = vec![1, 2, 3, 4, 5];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |         - move occurs because `v` has type `Vec&#x3C;i32>`, which does not implement the `Copy` trait\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>5 |     process(v);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |             - value moved here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>6 |     \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>7 |     for x in v {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |              ^ value used here after move\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>There is no moved-from state to observe because there is no way to observe it. The binding \u003Ccode>v\u003C/code> is not null, not empty, not unspecifiedÃ¢â‚¬â€it simply does not exist from the compilerâ€™s perspective after the move. The name remains in scope (you can shadow it with a new binding), but the compilerâ€™s initialization tracking marks it as uninitialized.\u003C/p>\n\u003Cp>At the assembly level, the actual data movement is nearly identical to C++. The \u003Ccode>Vec\u003C/code>â€™s three words (pointer, length, capacity) are copied from one stack location to another, or into registers for a function call. There is no heap allocation, no deep copy, just 24 bytes shuffled around. The difference is purely a compile-time concept: Rust tracks that the source is no longer valid.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v1 moved to v2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: borrow of moved value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The generated assembly for \u003Ccode>let v2 = v1\u003C/code> is a \u003Ccode>memcpy\u003C/code> of the struct, essentially identical to what C++ would generate. But where C++ would let us access \u003Ccode>v1\u003C/code> afterward (finding it in some â€œvalid but unspecifiedâ€ state), Rust stops compilation.\u003C/p>\n\u003Cp>This tracking happens through dataflow analysis in the compiler. Each variable has an initialization state that the compiler updates as it processes statements. When \u003Ccode>v1\u003C/code> is assigned to \u003Ccode>v2\u003C/code>, the compiler marks \u003Ccode>v1\u003C/code> as uninitialized. Any subsequent use of \u003Ccode>v1\u003C/code> is an error, as if we had declared \u003Ccode>let v1: Vec&#x3C;i32>;\u003C/code> without initializing it.\u003C/p>\n\u003Cp>What about reinitialization? A moved-from variable can be assigned a new value:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;            \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v is now uninitialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">6\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];     \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v is reinitialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: prints [4, 5, 6]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compilerâ€™s tracking is flow-sensitive. After the move, \u003Ccode>v\u003C/code> is uninitialized. After the reassignment, \u003Ccode>v\u003C/code> is initialized with a new value. The \u003Ccode>mut\u003C/code> is required because reinitialization is a form of mutation in Rustâ€™s model.\u003C/p>\n\u003Cp>Control flow complicates the analysis. If a move occurs in one branch but not another, the variableâ€™s initialization state depends on which path was taken:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">condition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> condition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// v moved into drop()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">v\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: v might have been moved\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler cannot statically determine which branch executes, so it conservatively assumes \u003Ccode>v\u003C/code> might be uninitialized. This occasionally forces us to restructure code or use \u003Ccode>Option&#x3C;T>\u003C/code> to represent \u003Cem>maybe moved\u003C/em> states explicitly.\u003C/p>\n\u003Cp>For cases where the compiler cannot determine initialization statically, Rust uses \u003Cem>drop flags\u003C/em>. These are runtime boolean values, typically stored on the stack, that track whether a value has been moved. When the variable goes out of scope, the generated code checks the flag before calling the destructor:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> example\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">condition\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> bool\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> condition\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // x goes out of scope: compiler generates code to check if x was initialized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The drop flag mechanism tells us something about the design trade-off Rust accepted. In straight-line code, the compiler knows exactly which bindings are initialized at every point, and generates direct drops with no runtime overhead. But conditional moves force a choice: either reject some valid programs (overly conservative static analysis), or emit a runtime check. Rust chose the latter for flexibility, keeping the flag on the stack where it costs a byte and a conditional branch at scope exit. For hot loops, we can restructure code to ensure static initialization tracking; for cold paths, the flag is negligible.\u003C/p>\n\u003Cp>What we cannot do in safe Rust is observe a moved-from binding. The asymmetry with C++ is not about what happens at runtime, both languages copy the same bytes, both leave the sourceâ€™s memory untouched until the stack frame is reclaimed. The difference is what the compiler permits us to write. C++ allows the moved-from object to participate in subsequent expressions; Rust does not.\u003C/p>\n\u003Ch3 id=\"copy-move-clone\">Copy, Move, Clone\u003C/h3>\n\u003Cp>We have been speaking of â€œmoveâ€ as if it were a single concept, but Rust distinguishes three related operations: implicit copy, move, and explicit clone. Understanding when each applies requires understanding what the type system knows about the data.\u003C/p>\n\u003Cp>An \u003Ccode>i32\u003C/code> is 4 bytes. When we write \u003Ccode>let y = x\u003C/code> where \u003Ccode>x: i32\u003C/code>, the compiler generates a \u003Ccode>mov\u003C/code> instruction that copies those 4 bytes. After the assignment, both \u003Ccode>x\u003C/code> and \u003Ccode>y\u003C/code> hold independent copies of the same value. We can use both. This is a \u003Cem>copy\u003C/em>.\u003C/p>\n\u003Cp>A \u003Ccode>Vec&#x3C;i32>\u003C/code> is 24 bytes on the stack (pointer, length, capacity), but those 24 bytes control an arbitrarily large heap allocation. When we write \u003Ccode>let y = x\u003C/code> where \u003Ccode>x: Vec&#x3C;i32>\u003C/code>, the compiler generates the same kind of \u003Ccode>mov\u003C/code> instructions to copy those 24 bytes. But now both \u003Ccode>x\u003C/code> and \u003Ccode>y\u003C/code> would point to the same heap allocation. If we allowed both to be used, we would have aliasing, and when both go out of scope, we would have double-free. So after the assignment, \u003Ccode>x\u003C/code> is invalidated. This is a \u003Cem>move\u003C/em>.\u003C/p>\n\u003Cp>At the machine level, copy and move are identical. Both copy the bytes that constitute the value. The difference is in what the compiler permits afterward. For \u003Ccode>Copy\u003C/code> types, the source remains valid. For non-\u003Ccode>Copy\u003C/code> types, the source is invalidated.\u003C/p>\n\u003Cp>Rust uses the \u003Ccode>Copy\u003C/code> trait to mark types where this byte-for-byte duplication is semantically complete. If copying the bytes gives us two independent, fully functional values, the type can be \u003Ccode>Copy\u003C/code>. Integers, floats, \u003Ccode>bool\u003C/code>, \u003Ccode>char\u003C/code>, raw pointers, and tuples or arrays of \u003Ccode>Copy\u003C/code> types are all \u003Ccode>Copy\u003C/code>. The defining characteristic is that there is no additional resource management beyond the bytes themselves.\u003C/p>\n\u003Cp>The \u003Ccode>Copy\u003C/code> trait has a constraint: a type cannot implement both \u003Ccode>Copy\u003C/code> and \u003Ccode>Drop\u003C/code>. If a type has a destructor, duplicating its bytes creates two values that will both try to run cleanup. For \u003Ccode>Vec\u003C/code>, this means double-free. For \u003Ccode>File\u003C/code>, this means closing the same file descriptor twice. The mutual exclusion between \u003Ccode>Copy\u003C/code> and \u003Ccode>Drop\u003C/code> is enforced by the compiler:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[derive(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Copy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ok: no Drop, all fields Copy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[derive(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Copy\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Wrapper\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>);        \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: Vec is not Copy\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The error message is direct:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>error[E0204]: the trait `Copy` cannot be implemented for this type\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> --> src/main.rs:4:10\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>4 | #[derive(Copy, Clone)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |          ^^^^\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>5 | struct Wrapper(Vec&#x3C;i32>);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>  |                -------- this field does not implement `Copy`\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>C++ has a parallel concept in \u003Cem>trivially copyable\u003C/em> types. The C++ standard (Ã‚Â§11.2) defines a trivially copyable class as one where each eligible copy constructor, move constructor, copy assignment operator, and move assignment operator is trivial, and the destructor is trivial and non-deleted. â€œTrivialâ€ here means the compiler-generated default does the right thing, which for these operations means bitwise copy. A \u003Ccode>struct\u003C/code> containing only integers and other trivially copyable types is trivially copyable.\u003C/p>\n\u003Cp>The difference is enforcement. In C++, \u003Ccode>std::is_trivially_copyable_v&#x3C;T>\u003C/code> is a compile-time query we can use in \u003Ccode>static_assert\u003C/code> or SFINAE, but the language does not prevent us from memcpy-ing a non-trivially-copyable object. We might get away with it if the object has no internal pointers or virtual functions. We might corrupt memory if it does. In Rust, attempting to derive \u003Ccode>Copy\u003C/code> on a non-qualifying type is a hard error.\u003C/p>\n\u003Cp>\u003Ccode>Clone\u003C/code> is the explicit deep copy operation. Where \u003Ccode>Copy\u003C/code> happens implicitly on assignment, \u003Ccode>Clone::clone()\u003C/code> must be called explicitly. The implementation can do anything: allocate new memory, copy all elements, increment reference counts, whatever is appropriate for the type. For \u003Ccode>Vec&#x3C;T>\u003C/code>, \u003Ccode>clone()\u003C/code> allocates a new buffer and clones each element.\u003C/p>\n\u003Cp>The relationship between \u003Ccode>Copy\u003C/code> and \u003Ccode>Clone\u003C/code> is that \u003Ccode>Copy\u003C/code> is a supertrait of \u003Ccode>Clone\u003C/code>. Every \u003Ccode>Copy\u003C/code> type must also implement \u003Ccode>Clone\u003C/code>, and for \u003Ccode>Copy\u003C/code> types, \u003Ccode>clone()\u003C/code> is equivalent to a byte copy. This might seem redundant, but it allows generic code to work uniformly:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> duplicate\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This function works for both \u003Ccode>i32\u003C/code> (where \u003Ccode>clone\u003C/code> compiles to a simple load) and \u003Ccode>String\u003C/code> (where \u003Ccode>clone\u003C/code> allocates and copies). The call site is uniform; the generated code is not.\u003C/p>\n\u003Cp>When we see \u003Ccode>.clone()\u003C/code> in Rust code, we know that something potentially expensive is happening. The Rust philosophy is that expensive operations should be visible. Making us write \u003Ccode>.clone()\u003C/code> forces acknowledgment of this cost.\u003C/p>\n\u003Cp>C++ takes the opposite approach for copy constructors. Given \u003Ccode>std::vector&#x3C;int> v2 = v1;\u003C/code>, this invokes the copy constructor, which allocates and copies all elements. The syntax is identical to copying an \u003Ccode>int\u003C/code>. We must know that \u003Ccode>vector\u003C/code> has an expensive copy constructor; the code does not tell us. Move semantics (\u003Ccode>v2 = std::move(v1)\u003C/code>) were added in C++11 partly to make expensive operations more visible, but copy remains implicit.\u003C/p>\n\u003Cp>One subtlety: Rustâ€™s \u003Ccode>clone()\u003C/code> is not always a deep copy in the intuitive sense. For \u003Ccode>Rc&#x3C;T>\u003C/code>, calling \u003Ccode>clone()\u003C/code> increments the reference count and returns a new \u003Ccode>Rc\u003C/code> pointing to the same allocation. The data is shared, not duplicated. This is the correct semantics for \u003Ccode>Rc\u003C/code>, since the entire point of reference counting is to share data. But it means we cannot assume that \u003Ccode>clone()\u003C/code> produces an independent copy. The traitâ€™s contract is weaker: \u003Ccode>clone()\u003C/code> produces a value that is semantically equivalent to the original for the purposes of the typeâ€™s interface.\u003C/p>\n\u003Ch3 id=\"elision-when-neither-happens\">Elision: When Neither Happens\u003C/h3>\n\u003Cp>We have seen that moving a value copies its bytes from source to destination. For a 24-byte \u003Ccode>Vec\u003C/code> struct, this means three 8-byte writes. But what about returning a \u003Ccode>Vec\u003C/code> from a function? Naively, we might expect: the function constructs a \u003Ccode>Vec\u003C/code> in its stack frame, then on return, the \u003Ccode>Vec\u003C/code> is moved to the callerâ€™s stack frame, then the caller receives the returned value. This would mean writing those 24 bytes twice.\u003C/p>\n\u003Cp>The answer to whether we can avoid this lies in how function returns work at the ABI level. The Itanium C++ ABI, which governs calling conventions on most Unix-like systems, distinguishes between \u003Cem>trivial\u003C/em> and \u003Cem>non-trivial\u003C/em> return types. A type is non-trivial for purposes of calls if it has a non-trivial destructor or a non-trivial copy or move constructor. For non-trivial return types, the ABI specifies that the caller passes an address as an implicit parameter, and the callee constructs the return value directly into this address.\u003C/p>\n\u003Cp>The Itanium ABI goes further. The address passed need not point to temporary memory on the callerâ€™s stack. Copy elision may cause it to point anywhere: to a local variableâ€™s storage, to global memory, to heap-allocated memory. The pointer is passed as if it were the first parameter in the function prototype, preceding all other parameters including \u003Ccode>this\u003C/code>. If the return type has a non-trivial destructor, the caller is responsible for destroying the object after, and only after, the callee returns normally. If an exception is thrown after construction but before the return completes, the callee must destroy the return value before propagating the exception.\u003C/p>\n\u003Cp>This machinery enables what C++ calls \u003Cem>copy elision\u003C/em>. The returned object is constructed directly in its final location. Two forms are commonly discussed:\u003C/p>\n\u003Cp>\u003Cstrong>RVO (Return Value Optimization)\u003C/strong> applies when we return a prvalue, a temporary with no name:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>vector\u003C/code> is constructed directly into the caller-provided address. No temporary exists in \u003Ccode>make_vector\u003C/code>â€™s stack frame.\u003C/p>\n\u003Cp>\u003Cstrong>NRVO (Named Return Value Optimization)\u003C/strong> applies when we return a named local variable:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_vector\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">vector\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;int>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v{\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    v\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push_back\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> v;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Here the compiler can allocate \u003Ccode>v\u003C/code> directly in the caller-provided space from the start. If it does, there is no copy or move on return. If it does not (perhaps because control flow makes this impossible), the return invokes the move constructor.\u003C/p>\n\u003Cp>Before C++17, both forms of elision were permitted but not guaranteed. A conforming compiler could choose not to elide, and the program would fall back to copy or move constructors. Code relying on elision for correctness, such as returning a non-copyable non-movable type, was non-portable.\u003C/p>\n\u003Cp>C++17 changed this for prvalues through a reformulation of value categories. The standard now specifies that prvalues are not \u003Cem>materialized\u003C/em> until needed. A prvalue does not create a temporary object; it initializes a target object directly. The C++ standard (Ã‚Â§6.7.7) states that the materialization of a temporary object is generally delayed as long as possible to avoid creating unnecessary temporary objects. The result is \u003Cem>guaranteed copy elision\u003C/em> for prvalues. The statement \u003Ccode>std::vector&#x3C;int> v = make_vector();\u003C/code> constructs the vector directly into \u003Ccode>v\u003C/code>, guaranteed by the standard, not merely permitted as an optimization.\u003C/p>\n\u003Cp>NRVO remains optional. The standard permits but does not require it. In practice, every major compiler performs NRVO when control flow permits. Multiple return statements returning different named variables typically defeat NRVO because the compiler cannot know at the functionâ€™s entry which variable will be returned.\u003C/p>\n\u003Cp>How does this relate to Rust? Rust does not have \u003Cem>copy elision\u003C/em> as a named language concept because the problem is different. Rust moves are defined as bitwise copies that invalidate the source. There is no move constructor, no user code that might run, no observable side effects to elide. Moving a \u003Ccode>Vec\u003C/code> copies 24 bytes regardless of context.\u003C/p>\n\u003Cp>Rust does perform the same underlying ABI-level optimization. When a function returns a value that cannot fit in registers, the caller passes a hidden pointer in \u003Ccode>rdi\u003C/code> (System V) or \u003Ccode>rcx\u003C/code> (Microsoft x64), and the callee writes directly to that location. But Rust does not need language-level elision rules because there is no observable difference. Bitwise copy is bitwise copy; constructing directly into the destination versus constructing locally and then copying produces identical bit patterns.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> make_vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> caller\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> v\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> make_vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With optimizations, \u003Ccode>make_vec\u003C/code> receives the hidden pointer in \u003Ccode>rdi\u003C/code> and writes the \u003Ccode>Vec\u003C/code>â€™s three fields (pointer, capacity, length) directly to that address. There is no intermediate \u003Ccode>Vec\u003C/code> on \u003Ccode>make_vec\u003C/code>â€™s stack frame that gets copied out. The heap allocation happens once, the \u003Ccode>Vec\u003C/code> header is written once, directly to where \u003Ccode>caller\u003C/code> wants it.\u003C/p>\n\u003Cp>For types that fit in registers, both languages return values in RAX and RDX. A function returning \u003Ccode>(i32, i32)\u003C/code> involves no memory operations for the return itself.\u003C/p>\n\u003Cp>The consequence is that returning large values by value in Rust is not expensive because of the return mechanism. The cost is in constructing the data structure: the allocations, the element initialization, the potential reallocations. The mechanics of getting the result back to the caller add nothing beyond what the ABI already requires for any struct return.\u003C/p>\n\u003Ch2 id=\"smart-pointers-and-reference-counting\">Smart Pointers and Reference Counting\u003C/h2>\n\u003Cp>Move semantics solve the problem of transferring exclusive ownership efficiently. But some data structures cannot express their sharing patterns through exclusive ownership alone. A graph where multiple edges reference the same node, a cache that outlives any single user, a callback that must remain valid for multiple callers: these require \u003Cem>shared\u003C/em> ownership, where the resource is released only when the last owner disappears.\u003C/p>\n\u003Cp>We have seen how C++ and Rust handle exclusive heap ownership through \u003Ccode>unique_ptr\u003C/code> and \u003Ccode>Box\u003C/code>. The move semantics we examined apply directly: \u003Ccode>unique_ptr\u003C/code> leaves a nullptr after move, \u003Ccode>Box\u003C/code> leaves no valid binding at all. Now we turn to the harder problem of shared ownership, where multiple owners must coordinate to determine when deallocation occurs.\u003C/p>\n\u003Ch3 id=\"shared-ownership-shared_ptr\">Shared Ownership: \u003Ccode>shared_ptr\u003C/code>\u003C/h3>\n\u003Cp>When multiple parts of a program need to share ownership of heap-allocated data, we need reference counting. C++â€˜s \u003Ccode>shared_ptr\u003C/code> implements this with a \u003Cem>control block\u003C/em>: a separate heap allocation that stores metadata about the shared object.\u003C/p>\n\u003Cp>A typical \u003Ccode>shared_ptr&#x3C;T>\u003C/code> contains two pointers: one to the managed object (\u003Ccode>T*\u003C/code>), and one to the control block. The control block contains:\u003C/p>\n\u003Cul>\n\u003Cli>A strong reference count (the number of \u003Ccode>shared_ptr\u003C/code>s pointing to the object)\u003C/li>\n\u003Cli>A weak reference count (the number of \u003Ccode>weak_ptr\u003C/code>s, plus one if the strong count is nonzero)\u003C/li>\n\u003Cli>A pointer to the managed object (or the object itself, if allocated together)\u003C/li>\n\u003Cli>The deleter (type-erased, since different \u003Ccode>shared_ptr\u003C/code>s with different deleters can share ownership)\u003C/li>\n\u003Cli>The allocator (also type-erased)\u003C/li>\n\u003C/ul>\n\u003Cp>When we copy a \u003Ccode>shared_ptr\u003C/code>, the strong count is incremented atomically. When a \u003Ccode>shared_ptr\u003C/code> is destroyed, the strong count is decremented. If the strong count reaches zero, the managed object is destroyed (the deleter is invoked). The control block itself is not destroyed until the weak count also reaches zero, because \u003Ccode>weak_ptr\u003C/code>s need to query the control block to determine whether the object still exists.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">make_shared\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Widget\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>();\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // one allocation: control block + Widget\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> q \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> p;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                           // strong count: 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">q\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">reset\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                            // strong count: 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// p destroyed, strong count: 0, Widget destroyed\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>make_shared\u003C/code> function is preferred over \u003Ccode>shared_ptr&#x3C;T>(new T)\u003C/code> because it performs a single allocation for both the control block and the object, improving cache locality and reducing allocation overhead. The downside is that the memory for the object cannot be released until all weak references are also gone, since the control block and object share a single allocation.\u003C/p>\n\u003Ch3 id=\"shared-ownership-rct-and-arct\">Shared Ownership: \u003Ccode>Rc&#x3C;T>\u003C/code> and \u003Ccode>Arc&#x3C;T>\u003C/code>\u003C/h3>\n\u003Cp>Rust separates the single-threaded and multi-threaded cases into distinct types. \u003Ccode>Rc&#x3C;T>\u003C/code> (reference counted) uses non-atomic operations and is not thread-safe. \u003Ccode>Arc&#x3C;T>\u003C/code> (atomically reference counted) uses atomic operations and can be shared across threads.\u003C/p>\n\u003Cp>The layout of \u003Ccode>Rc&#x3C;T>\u003C/code> is similar in spirit to \u003Ccode>shared_ptr\u003C/code>, but simpler. An \u003Ccode>Rc&#x3C;T>\u003C/code> is a single pointer to a heap allocation containing:\u003C/p>\n\u003Cul>\n\u003Cli>A strong count (\u003Ccode>Cell&#x3C;usize>\u003C/code>, non-atomic)\u003C/li>\n\u003Cli>A weak count (\u003Ccode>Cell&#x3C;usize>\u003C/code>, non-atomic)\u003C/li>\n\u003Cli>The data (\u003Ccode>T\u003C/code>)\u003C/li>\n\u003C/ul>\n\u003Cp>There is no separate deleter or allocator. \u003Ccode>Rc&#x3C;T>\u003C/code> always uses the global allocator and always drops \u003Ccode>T\u003C/code> in place. This means \u003Ccode>Rc&#x3C;T>\u003C/code> is a single pointer, 8 bytes, not two pointers like \u003Ccode>shared_ptr\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Widget\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// allocates RcBox containing counts + Widget\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// strong count: 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);                         \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// strong count: 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// a dropped, strong count: 0, Widget dropped, RcBox deallocated\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The convention is to write \u003Ccode>Rc::clone(&#x26;a)\u003C/code> rather than \u003Ccode>a.clone()\u003C/code>. Both work identically, but the explicit form makes clear that we are incrementing a reference count, not performing a deep copy.\u003C/p>\n\u003Cp>\u003Ccode>Arc&#x3C;T>\u003C/code> has the same layout, with the counts replaced by \u003Ccode>AtomicUsize\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">sync\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">atomic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">AtomicUsize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ArcInner\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    strong\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AtomicUsize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    weak\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AtomicUsize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The atomic operations add overhead. Incrementing an atomic counter requires synchronization at the hardware level: a \u003Ccode>lock\u003C/code> prefix on x86, load-linked/store-conditional sequences on ARM. In high-contention scenarios, cache lines bounce between cores. If shared ownership is needed but thread safety is not, \u003Ccode>Rc\u003C/code> avoids this cost entirely.\u003C/p>\n\u003Cp>Rust enforces this separation at compile time. \u003Ccode>Rc&#x3C;T>\u003C/code> does not implement \u003Ccode>Send\u003C/code> or \u003Ccode>Sync\u003C/code>. Attempting to move an \u003Ccode>Rc\u003C/code> across thread boundaries is a type error:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">thread;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">thread\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">spawn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: `Rc&#x3C;i32>` cannot be sent between threads safely\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The error is not a runtime panic. The code does not compile. We cannot accidentally introduce data races by using the wrong smart pointer type.\u003C/p>\n\u003Ch3 id=\"reference-count-synchronization\">Reference Count Synchronization\u003C/h3>\n\u003Cp>The increment operation in \u003Ccode>Arc::clone\u003C/code> uses \u003Ccode>Ordering::Relaxed\u003C/code>. This might seem dangerous for a multi-threaded primitive, but the reasoning is precise that incrementing the count establishes no ordering relationship with any other memory access. We already have access to the \u003Ccode>Arc\u003C/code>, which means we already have a valid reference to the data. We are simply recording that one more owner exists. The only requirement is atomicity itself, ensuring that two concurrent increments do not lose a count.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Clone\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> inner\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        inner\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Relaxed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">phantom\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PhantomData\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The decrement is where the complexity lies. Consider what happens when the last owner drops its \u003Ccode>Arc\u003C/code>. At that moment, no other thread holds a reference, and we must deallocate. But we must first ensure that all writes performed by any previous owner are visible to us. If thread A writes to \u003Ccode>arc.data\u003C/code> and then drops its \u003Ccode>Arc\u003C/code>, and thread B subsequently drops the last \u003Ccode>Arc\u003C/code>, thread B must see thread Aâ€™s writes before running the destructor.\u003C/p>\n\u003Cp>The standard solution uses release-acquire synchronization:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Drop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> inner\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> inner\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch_sub\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Release\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">!=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">sync\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">atomic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fence\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Acquire\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(Box\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_raw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())); }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Every \u003Ccode>fetch_sub\u003C/code> with \u003Ccode>Release\u003C/code> ordering guarantees that all prior writes in that thread are visible to any thread that subsequently performs an \u003Ccode>Acquire\u003C/code> operation on the same atomic variable and observes the stored value. When thread Bâ€™s \u003Ccode>fetch_sub\u003C/code> returns 1, indicating it was the last owner, the subsequent \u003Ccode>Acquire\u003C/code> fence synchronizes with all the \u003Ccode>Release\u003C/code> decrements that preceded it. Thread B now sees every write that any previous owner performed before dropping.\u003C/p>\n\u003Cp>On x86, the \u003Ccode>Release\u003C/code> ordering on \u003Ccode>fetch_sub\u003C/code> compiles to a simple \u003Ccode>lock xadd\u003C/code> instruction, which already provides the necessary ordering guarantees due to x86â€™s strong memory model. The \u003Ccode>Acquire\u003C/code> fence compiles to nothing, as x86 loads already have acquire semantics. On ARM, the situation is different: \u003Ccode>Release\u003C/code> requires a \u003Ccode>dmb ish\u003C/code> barrier before the store, and \u003Ccode>Acquire\u003C/code> requires a barrier after the load.\u003C/p>\n\u003Cp>Using \u003Ccode>Relaxed\u003C/code> for the decrement would allow the deallocating thread to see stale data, potentially reading uninitialized memory or seeing partially-written values. Using \u003Ccode>SeqCst\u003C/code> everywhere would be correct but unnecessarily expensive, adding full memory barriers where weaker ordering suffices. The release-acquire pattern is the minimum synchronization required for correctness.\u003C/p>\n\u003Ch3 id=\"raw-pointers-variance-and-the-drop-checker\">Raw Pointers, Variance, and the Drop Checker\u003C/h3>\n\u003Cp>An \u003Ccode>Arc\u003C/code> internally holds a raw pointer to the heap allocation. A naive definition might use \u003Ccode>*mut ArcInner&#x3C;T>\u003C/code>, but this creates two problems that \u003Ccode>NonNull&#x3C;T>\u003C/code> and \u003Ccode>PhantomData&#x3C;T>\u003C/code> solve.\u003C/p>\n\u003Cp>Raw pointers are \u003Cem>invariant\u003C/em> in their type parameter. If we have an \u003Ccode>Arc&#x3C;&#x26;'static str>\u003C/code>, we should be able to use it where an \u003Ccode>Arc&#x3C;&#x26;'a str>\u003C/code> is expected (assuming \u003Ccode>'static: 'a\u003C/code>), because a longer-lived reference can substitute for a shorter-lived one. But \u003Ccode>*mut T\u003C/code> does not allow this substitution. \u003Ccode>NonNull&#x3C;T>\u003C/code> is a pointer wrapper that is \u003Cem>covariant\u003C/em> in \u003Ccode>T\u003C/code>, restoring the expected subtyping relationship.\u003C/p>\n\u003Cp>The second problem concerns the drop checker. When the compiler analyzes whether a type can be safely dropped, it needs to know what the type logically owns. A raw pointer carries no ownership information; the compiler assumes \u003Ccode>*mut T\u003C/code> does not own a \u003Ccode>T\u003C/code>. But \u003Ccode>Arc&#x3C;T>\u003C/code> \u003Cem>does\u003C/em> own a \u003Ccode>T\u003C/code>, at least when it is the last owner. If we do not communicate this to the compiler, code that should be rejected might compile:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> bad\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">arc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> local\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">local\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // Without PhantomData, the compiler might not realize\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // that dropping arc could access the &#x26;str\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Adding \u003Ccode>PhantomData&#x3C;ArcInner&#x3C;T>>\u003C/code> tells the drop checker that \u003Ccode>Arc&#x3C;T>\u003C/code> behaves as if it contains an \u003Ccode>ArcInner&#x3C;T>\u003C/code>, which contains a \u003Ccode>T\u003C/code>. The drop checker then ensures that \u003Ccode>T\u003C/code> outlives the \u003Ccode>Arc\u003C/code>, preventing dangling references in the destructor.\u003C/p>\n\u003Cp>The final structure:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> NonNull\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">ArcInner\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    phantom\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PhantomData\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">ArcInner\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is still a single pointer in size, 8 bytes. \u003Ccode>PhantomData\u003C/code> is a zero-sized type; it affects the type system without occupying memory. \u003Ccode>NonNull\u003C/code> is a \u003Ccode>#[repr(transparent)]\u003C/code> wrapper around \u003Ccode>*const T\u003C/code>, also pointer-sized. The layout is identical to a raw pointer, but the semantics are correct for a reference-counted smart pointer.\u003C/p>\n\u003Ch3 id=\"weak-references-and-the-control-block-lifetime\">Weak References and the Control Block Lifetime\u003C/h3>\n\u003Cp>A \u003Ccode>weak_ptr\u003C/code> or \u003Ccode>Weak\u003C/code> does not keep the managed object alive. It holds a pointer to the control block (or inner allocation), not to the object itself. When we attempt to \u003Cem>upgrade\u003C/em> a weak reference to a strong one, the operation must atomically check whether the object still exists and, if so, increment the strong count before another thread can decrement it to zero.\u003C/p>\n\u003Cp>Consider the race: thread A holds the last \u003Ccode>shared_ptr\u003C/code> and is about to drop it. Thread B holds a \u003Ccode>weak_ptr\u003C/code> and calls \u003Ccode>lock()\u003C/code>. If B reads the strong count as 1, then A decrements it to 0 and deallocates, then B increments it to 1, we have a use-after-free. The upgrade must be atomic with respect to the decrement.\u003C/p>\n\u003Cp>In C++, \u003Ccode>weak_ptr::lock()\u003C/code> performs a compare-and-swap loop. It loads the strong count, checks if it is zero (returning an empty \u003Ccode>shared_ptr\u003C/code> if so), then attempts to atomically increment it from the observed value. If another thread modified the count in the meantime, the CAS fails and the loop retries. The implementation looks roughly like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">shared_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> weak_ptr&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> noexcept\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    long\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> count \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> control_block\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#FAF39F;--shiki-dark-font-style:italic\">strong_count\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">load\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">memory_order_relaxed);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    while\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (count \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">!=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">control_block\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-light-font-style:inherit;--shiki-dark:#FAF39F;--shiki-dark-font-style:italic\">strong_count\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">compare_exchange_weak\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">                count\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> count \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">memory_order_acq_rel)) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">            return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> shared_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">/* from control block */\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // count was updated by compare_exchange_weak on failure\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> shared_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>();\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // empty\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Rustâ€™s \u003Ccode>Weak::upgrade()\u003C/code> follows the same pattern. The \u003Ccode>acq_rel\u003C/code> ordering on the successful CAS ensures that if we observe a nonzero count, our subsequent access to the data sees all writes that happened before any previous owner released their reference.\u003C/p>\n\u003Cp>The control block has a two-phase destruction. When the strong count reaches zero, the managed object is destroyed: its destructor runs, and if allocated separately from the control block, its memory is freed. The control block itself survives. Only when the weak count also reaches zero is the control block deallocated. This separation allows weak references to safely query whether the object exists.\u003C/p>\n\u003Cp>With \u003Ccode>make_shared\u003C/code>, the object and control block occupy a single allocation. The objectâ€™s destructor runs when the strong count hits zero, but the memory cannot be freed until the weak count also hits zero, because the control block metadata lives in the same allocation. Long-lived weak references to \u003Ccode>make_shared\u003C/code> objects keep the entire allocation alive, even though the object has been destroyed. Separate allocation via \u003Ccode>shared_ptr&#x3C;T>(new T)\u003C/code> avoids this: the objectâ€™s memory is freed immediately when the strong count hits zero, and only the smaller control block remains for weak reference bookkeeping.\u003C/p>\n\u003Ch3 id=\"the-cost-of-atomics-in-reference-counting\">The Cost of Atomics in Reference Counting\u003C/h3>\n\u003Cp>\u003Ccode>Arc::clone\u003C/code> compiles to a \u003Ccode>lock xadd\u003C/code> instruction on x86. The \u003Ccode>lock\u003C/code> prefix asserts exclusive ownership of the cache line containing the reference count, forcing all other cores to invalidate their copies. On a system with 8 cores all cloning the same \u003Ccode>Arc\u003C/code>, each clone causes 7 cache invalidations. The reference count ping-pongs between cores, and each increment waits for the cache line to arrive in the exclusive state.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; Arc::clone on x86-64\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]        \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load pointer to ArcInner\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">lock\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    xadd\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">     ; atomic increment of refcount\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>lock xadd\u003C/code> instruction alone takes roughly 15-30 cycles on modern x86 when uncontended, rising to 100+ cycles under contention as cores compete for the cache line. On ARM, the equivalent uses load-exclusive/store-exclusive pairs:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; Arc::clone on ARM64\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">retry\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    ldxr    x1, [x0]          \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load-exclusive refcount\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    add\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">     x1, x1, #\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    stxr    w2, x1, [x0]      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; store-exclusive\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    cbnz    w2, .retry        \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; retry if store failed\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The store-exclusive fails if another core modified the cache line between the load and store, requiring a retry. Under high contention, threads spin in this loop, wasting cycles.\u003C/p>\n\u003Cp>The decrement in \u003Ccode>Arc::drop\u003C/code> has the same atomic cost, plus the \u003Ccode>Acquire\u003C/code> fence when we observe the count reaching zero. On x86, the fence is free because \u003Ccode>lock xadd\u003C/code> already has acquire-release semantics. On ARM, it expands to a \u003Ccode>dmb ish\u003C/code> (data memory barrier, inner shareable domain), which stalls the pipeline until all prior memory operations complete.\u003C/p>\n\u003Cp>Beyond instruction costs, reference counting interacts poorly with modern cache hierarchies. The reference count and the data occupy the same allocation, often the same cache line. If threads read the data while another thread clones or drops the \u003Ccode>Arc\u003C/code>, false sharing occurs: the reading threadsâ€™ cache lines are invalidated by the write to the reference count, even though the data itself is unchanged. This is unavoidable without splitting the count into a separate allocation, which would add indirection and defeat the single-pointer layout.\u003C/p>\n\u003Cp>\u003Ccode>Rc&#x3C;T>\u003C/code> avoids all of this. With no threading, the increment is a simple \u003Ccode>add\u003C/code> instruction, the decrement a simple \u003Ccode>sub\u003C/code>. No cache coherence traffic, no memory barriers, no retry loops. The type systemâ€™s guarantee that \u003Ccode>Rc\u003C/code> is not \u003Ccode>Send\u003C/code> lets us omit the synchronization entirely.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; Rc::clone on x86-64\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]        \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load pointer to RcBox\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">inc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">     qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]             \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; non-atomic increment\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"cs-approach-manual-reference-counting\">Câ€™s Approach: Manual Reference Counting\u003C/h3>\n\u003Cp>C has no built-in reference-counted smart pointers, but the pattern is pervasive. The Linux kernelâ€™s \u003Ccode>kref\u003C/code>, GLibâ€™s \u003Ccode>GObject\u003C/code>, and COMâ€™s \u003Ccode>IUnknown\u003C/code> all implement reference counting manually, each with its own conventions and failure modes.\u003C/p>\n\u003Cp>A single-threaded implementation is pretty straightforward:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> refcount;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... data ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">widget_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">    w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">refcount\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> w;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> widget_unref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">--\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">refcount\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        widget_destroy\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(w)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        free\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(w)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Threading requires atomic operations. Before C11, these were compiler or platform-specific: GCCâ€™s \u003Ccode>__sync_fetch_and_add\u003C/code>, MSVCâ€™s \u003Ccode>InterlockedIncrement\u003C/code>, or inline assembly. C11 standardized atomics, but the memory ordering must still be chosen correctly:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">include\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">stdatomic.h\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    atomic_int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> refcount;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... data ...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">widget_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    atomic_fetch_add_explicit\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">refcount\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> memory_order_relaxed)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> w;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> widget_unref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Widget \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">w\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">atomic_fetch_sub_explicit\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">refcount\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\"> memory_order_release)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ==\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        atomic_thread_fence\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(memory_order_acquire)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        widget_destroy\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(w)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        free\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(w)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The ordering arguments mirror what we saw in \u003Ccode>Arc\u003C/code>: \u003Ccode>relaxed\u003C/code> for increment (we already have a valid reference), \u003Ccode>release\u003C/code> for decrement (publish our writes), \u003Ccode>acquire\u003C/code> fence before destruction (synchronize with all releasers). Getting any of these wrong introduces data races that manifest as sporadic corruption, use-after-free in specific timing windows, or crashes that appear once per million operations.\u003C/p>\n\u003Cp>The Linux kernelâ€™s \u003Ccode>kref\u003C/code> wraps this pattern into a small struct with \u003Ccode>kref_get\u003C/code> and \u003Ccode>kref_put\u003C/code> operations. This discipline is not enforced, nothing prevents calling \u003Ccode>kref_get\u003C/code> on an object whose count has already reached zero, or forgetting to call \u003Ccode>kref_put\u003C/code> on an error path. Static analysis tools like Sparse and Coverity catch some bugs; the rest are found through testing, fuzzing, or production crashes.\u003C/p>\n\u003Cp>Every usage site must remember to call \u003Ccode>widget_ref\u003C/code> when acquiring a reference and \u003Ccode>widget_unref\u003C/code> when releasing one. There is no automatic cleanup on scope exit, no destructor to invoke at the end of a block. If a function returns early due to an error, every acquired reference must be explicitly released. Missing a single \u003Ccode>unref\u003C/code> leaks memory; an extra \u003Ccode>unref\u003C/code> corrupts the count or triggers a double-free.\u003C/p>\n\u003Chr>\n\u003Cp>Part III will examine how types are represented in memory and how polymorphism is implemented. Rust reorders struct fields by default to minimize padding; \u003Ccode>repr(C)\u003C/code> restores predictable layout for FFI. Fat pointers carry metadata alongside the data address: slices carry length, trait objects carry vtable pointers. We will compare monomorphization (C++ templates, Rust generics) against dynamic dispatch (C++ virtual functions, Rust trait objects), examining the generated code and the trade-offs in binary size, call overhead, and cache behavior. Closures will complete the picture: anonymous structs that capture their environment, with the \u003Ccode>Fn\u003C/code>/\u003Ccode>FnMut\u003C/code>/\u003Ccode>FnOnce\u003C/code> traits encoding how they access captured variables.\u003C/p>",{"headings":799,"localImagePaths":909,"remoteImagePaths":910,"frontmatter":911,"imagePaths":914},[800,801,804,807,810,813,816,819,822,825,828,831,834,837,840,843,846,849,852,855,858,861,864,867,870,873,876,879,882,885,888,891,894,897,900,903,906],{"depth":32,"slug":210,"text":211},{"depth":32,"slug":802,"text":803},"ownership-who-calls-free","Ownership: Who Calls Free?",{"depth":131,"slug":805,"text":806},"c-manual-management","C: Manual Management",{"depth":131,"slug":808,"text":809},"c-binding-cleanup-to-scope","C++: Binding Cleanup to Scope",{"depth":131,"slug":811,"text":812},"rust-ownership-in-the-type-system","Rust: Ownership in the Type System",{"depth":175,"slug":814,"text":815},"the-drop-trait-and-recursive-destruction","The Drop Trait and Recursive Destruction",{"depth":175,"slug":817,"text":818},"manuallydrop-and-suppressing-automatic-destruction","ManuallyDrop and Suppressing Automatic Destruction",{"depth":175,"slug":820,"text":821},"drop-flags-and-conditional-initialization","Drop Flags and Conditional Initialization",{"depth":175,"slug":823,"text":824},"you-cannot-call-drop-directly","You Cannot Call Drop Directly",{"depth":175,"slug":826,"text":827},"drop-check-when-lifetimes-and-destructors-collide","Drop Check: When Lifetimes and Destructors Collide",{"depth":175,"slug":829,"text":830},"the-may_dangle-escape-hatch","The #[may_dangle] Escape Hatch",{"depth":175,"slug":832,"text":833},"phantomdata-and-drop-check-interaction","PhantomData and Drop Check Interaction",{"depth":175,"slug":835,"text":836},"leaks-are-safe","Leaks Are Safe",{"depth":32,"slug":838,"text":839},"beyond-raii","Beyond RAII",{"depth":131,"slug":841,"text":842},"the-single-destructor-problem","The Single-Destructor Problem",{"depth":131,"slug":844,"text":845},"defer-explicit-scope-bound-cleanup","Defer: Explicit Scope-Bound Cleanup",{"depth":131,"slug":847,"text":848},"linear-types-enforcing-explicit-consumption","Linear Types: Enforcing Explicit Consumption",{"depth":131,"slug":850,"text":851},"why-rust-does-not-have-linear-types","Why Rust Does Not Have Linear Types",{"depth":32,"slug":853,"text":854},"move-semantics","Move Semantics",{"depth":131,"slug":856,"text":857},"the-cost-of-copies","The Cost of Copies",{"depth":131,"slug":859,"text":860},"the-shallow-copy-escape","The Shallow Copy Escape",{"depth":131,"slug":862,"text":863},"c11-rvalue-references-and-move-semantics","C++11: Rvalue References and Move Semantics",{"depth":175,"slug":865,"text":866},"the-implicitly-declared-move-constructor","The Implicitly-Declared Move Constructor",{"depth":175,"slug":868,"text":869},"move-assignment","Move Assignment",{"depth":175,"slug":871,"text":872},"value-categories-in-depth","Value Categories in Depth",{"depth":131,"slug":874,"text":875},"the-moved-from-problem","The Moved-From Problem",{"depth":131,"slug":877,"text":878},"rust-moves-without-ghosts","Rust: Moves Without Ghosts",{"depth":131,"slug":880,"text":881},"copy-move-clone","Copy, Move, Clone",{"depth":131,"slug":883,"text":884},"elision-when-neither-happens","Elision: When Neither Happens",{"depth":32,"slug":886,"text":887},"smart-pointers-and-reference-counting","Smart Pointers and Reference Counting",{"depth":131,"slug":889,"text":890},"shared-ownership-shared_ptr","Shared Ownership: shared_ptr",{"depth":131,"slug":892,"text":893},"shared-ownership-rct-and-arct","Shared Ownership: Rc\u003CT> and Arc\u003CT>",{"depth":131,"slug":895,"text":896},"reference-count-synchronization","Reference Count Synchronization",{"depth":131,"slug":898,"text":899},"raw-pointers-variance-and-the-drop-checker","Raw Pointers, Variance, and the Drop Checker",{"depth":131,"slug":901,"text":902},"weak-references-and-the-control-block-lifetime","Weak References and the Control Block Lifetime",{"depth":131,"slug":904,"text":905},"the-cost-of-atomics-in-reference-counting","The Cost of Atomics in Reference Counting",{"depth":131,"slug":907,"text":908},"cs-approach-manual-reference-counting","Câ€™s Approach: Manual Reference Counting",[],[],{"author":14,"pubDatetime":912,"title":790,"slug":786,"featured":17,"draft":17,"tags":913,"description":792},["Date","2025-12-23T00:00:00.000Z"],[200,634],[],"who-owns-the-memory-pt3",{"id":915,"data":917,"body":922,"filePath":923,"digest":924,"rendered":925},{"author":14,"pubDatetime":918,"title":919,"featured":17,"draft":17,"tags":920,"description":921},["Date","2025-12-25T00:00:00.000Z"],"Who Owns the Memory? Part 3: Representation",[200,634],"How abstract types become concrete bit patterns and how polymorphism is obtained in C, C++, and Rust.","This is the third part of a series exploring how C, C++, and Rust manage memory at a low level. In [Part I](https://lukefleed.xyz/posts/who-owns-the-memory-pt1/) we examined how memory is organized at the hardware level. [Part II](https://lukefleed.xyz/posts/who-owns-the-memory-pt2/) explored ownership and lifetime, showing how the three languages answer the question of who is responsible for freeing memory and when access to that memory is valid.\n\nPart III turns to _representation_: how abstract types become concrete bit patterns, and how polymorphism, the ability to write code that operates on many types, is implemented.\n\n## Table of Contents\n\n## Type Layout and Memory Representation\n\nIn Part I we established that every type has a size and an alignment, and that compilers insert padding to satisfy alignment constraints. We showed how a poorly ordered struct in C could waste 8 bytes of padding where a well-ordered one used only 2. But we sidestepped a question: who decides the order?\n\nIn C and C++, the answer is straightforward: we do. The compiler lays out fields in declaration order, inserting padding as the alignment algorithm dictates. This predictability is essential for binary compatibility, memory-mapped I/O, and network protocols where byte offsets must match external specifications. It is also a constraint: the programmer bears responsibility for field ordering, and a careless declaration can bloat a frequently-allocated struct.\n\nRust makes a different choice. By default, the compiler reserves the right to reorder fields.\n\n### The C Layout Algorithm\n\nC specifies a deterministic algorithm for struct layout. Start with a current offset of zero. For each field in declaration order: add padding until the offset is a multiple of the field's alignment, record the field's offset, advance by the field's size. Finally, round the struct's total size up to its alignment.\n\n```c\nstruct Example {\n    char a;      // offset 0, size 1\n    // 7 bytes padding (align to 8 for double)\n    double b;    // offset 8, size 8\n    char c;      // offset 16, size 1\n    // 7 bytes padding (struct size must be multiple of 8)\n};\n// sizeof(struct Example) == 24\n```\n\nThe algorithm is mechanical. Given field types and their order, the layout is fully determined. This property is what makes C the lingua franca of FFI: any language that implements the same algorithm can share data structures with C code.\n\nC++ inherits this layout for standard-layout types. The Itanium ABI, which governs most non-Windows C++ implementations, extends the algorithm to handle base classes, virtual functions, and virtual inheritance. For our purposes, a C++ struct without inheritance, virtual functions, or access specifiers mixing fields follows the same layout as C.\n\nThe `[[no_unique_address]]` attribute (C++20) allows the compiler to overlap a data member with another if the member has no members of its own. This enables empty base optimization for member objects:\n\n```cpp\nstruct Empty {};\n\nstruct WithoutAttribute {\n    Empty e;\n    int x;\n};\n// sizeof(WithoutAttribute) == 8 on typical platforms\n// (Empty requires 1 byte in C++, padded to 4 for int alignment)\n\nstruct WithAttribute {\n    [[no_unique_address]] Empty e;\n    int x;\n};\n// sizeof(WithAttribute) == 4\n```\n\nWithout the attribute, `Empty` occupies one byte (C++ mandates that different objects have different addresses, so even empty classes have nonzero size). With the attribute, `e` can share storage with padding or with `x` itself, reducing the struct to just `sizeof(int)`.\n\n### repr(Rust): The Compiler's Prerogative\n\nRust's default representation, `repr(Rust)`, makes minimal guarantees. The specification states only:\n\n1. Fields are properly aligned.\n2. Fields do not overlap (except for ZSTs, which may share addresses).\n3. The struct's alignment is at least the maximum alignment of its fields.\n\nThere is no guarantee about field order. The compiler may reorder fields to minimize padding, and different compilations of the same source may produce different layouts. The same generic struct instantiated with different type parameters may have different field orderings.\n\nConsider:\n\n```rust\nstruct Foo\u003CT, U> {\n    count: u16,\n    data1: T,\n    data2: U,\n}\n```\n\nFor `Foo\u003Cu32, u16>`, an efficient layout places `count` and `data2` (both 2 bytes) adjacent, followed by `data1` (4 bytes):\n\n```rust\n// Possible layout of Foo\u003Cu32, u16>: size 8, align 4\n// count:  offset 0, size 2\n// data2:  offset 2, size 2\n// data1:  offset 4, size 4\n```\n\nFor `Foo\u003Cu16, u32>`, the same reordering achieves the same efficiency:\n\n```rust\n// Possible layout of Foo\u003Cu16, u32>: size 8, align 4\n// count:  offset 0, size 2\n// data1:  offset 2, size 2\n// data2:  offset 4, size 4\n```\n\nIf Rust preserved declaration order, `Foo\u003Cu32, u16>` would require padding after `count`:\n\n```rust\n// Declaration-order layout of Foo\u003Cu32, u16>: size 12, align 4\n// count:  offset 0, size 2\n// _pad:   offset 2, size 2\n// data1:  offset 4, size 4\n// data2:  offset 8, size 2\n// _pad:   offset 10, size 2\n```\n\nThe reordering saves 4 bytes per instance without any annotation or programmer attention.\n\nThe trade-off is unpredictability. We cannot assume field offsets. We cannot cast a `*const Foo\u003CA, B>` to a byte pointer and read at a known offset to extract a field. We cannot send a `repr(Rust)` struct across a network or write it to a file and expect another compilation (or even the same compilation with different flags) to interpret it correctly.\n\n### repr(C): Predictable Layout for FFI\n\nWhen we need C-compatible layout, we annotate the type with `#[repr(C)]`:\n\n```rust\n#[repr(C)]\nstruct ThreeInts {\n    first: i16,\n    second: i8,\n    third: i32,\n}\n```\n\nWith `repr(C)`, Rust applies the C layout algorithm. Fields appear in declaration order. Padding follows the standard rules. The resulting layout is compatible with a C struct declared with the same field types and order:\n\n```c\nstruct ThreeInts {\n    int16_t first;\n    int8_t second;\n    int32_t third;\n};\n```\n\n`repr(C)` is necessary for FFI correctness. It is also useful when we need stable layout for unsafe code that relies on field offsets, or when serializing data to a known binary format. The trade-off is that we accept whatever padding the declaration order implies.\n\nFor enums, `repr(C)` produces a layout compatible with C unions plus a tag. The exact representation depends on whether the enum has fields:\n\n```rust\n#[repr(C)]\nenum MyEnum {\n    A(u32),\n    B(f32, u64),\n    C { x: u32, y: u8 },\n    D,\n}\n```\n\nThis is laid out as a `repr(C)` union of `repr(C)` structs, where each struct begins with a discriminant of the platform's C `int` size:\n\n```rust\n// Equivalent repr(C) layout:\n#[repr(C)]\nunion MyEnumRepr {\n    a: MyVariantA,\n    b: MyVariantB,\n    c: MyVariantC,\n    d: MyVariantD,\n}\n\n#[repr(C)]\nstruct MyVariantA { tag: u64, value: u64 }\n\n#[repr(C)]\nstruct MyVariantB { tag: u64, _pad: u64, value0: f64, _pad2: u64, value1: u64 }\n// ... and so on\n```\n\nThe discriminant size for a fieldless `repr(C)` enum matches the C ABI's enum size, which is implementation-defined. On most platforms, this is `int` (4 bytes), though some ABIs use smaller types for small enums.\n\n### Primitive Representations for Enums\n\nWhen we need precise control over the discriminant, we can specify an integer type:\n\n```rust\n#[repr(u8)]\nenum Opcode {\n    Nop = 0,\n    Load = 1,\n    Store = 2,\n    // ... up to 255 variants\n}\n```\n\nThis enum occupies exactly 1 byte. The discriminant is stored as a `u8`. This is essential for binary protocols where the tag must fit a specific field width.\n\nFor enums with fields, `repr(u8)` or similar sets the discriminant size but still uses C-style layout for the variant data:\n\n```rust\n#[repr(u8)]\nenum Packet {\n    Ping,\n    Data([u8; 64]),\n    Error(u32),\n}\n// size: 72 bytes (1 byte tag + 7 padding + 64 data)\n// The discriminant is guaranteed to be 1 byte\n```\n\nCombining `repr(C)` and a primitive representation, like `#[repr(C, u8)]`, specifies both C layout and a specific discriminant type.\n\nAdding an explicit `repr` to an enum with fields has a consequence that surprises many: it *suppresses niche optimization*. We have not yet explained what niche optimization is, so this statement may seem cryptic. We will return to it after discussing zero-sized types, where the concept will make more sense.\n\n### repr(packed): Eliminating Padding\n\nSometimes we need minimum size regardless of alignment. Network packet headers, binary file formats, and memory-mapped hardware registers often require tightly packed data. `repr(packed)` removes inter-field padding:\n\n```rust\n#[repr(packed)]\nstruct PackedExample {\n    a: u8,\n    b: u32,\n    c: u8,\n}\n// size: 6 bytes (1 + 4 + 1), no padding\n// alignment: 1 byte\n```\n\nCompare with the default layout, which would require 12 bytes (1 + 3 padding + 4 + 1 + 3 padding). The packed version is half the size.\n\nThe penalty is that fields may be misaligned. On x86-64, misaligned loads incur a performance penalty. On stricter architectures like ARM without unaligned access support or older SPARC, they cause hardware exceptions. Even on tolerant architectures, misaligned atomics are often incorrect.\n\nRust addresses part of this problem by making it *illegal to create a reference to a misaligned field*:\n\n```rust\n#[repr(packed)]\nstruct Packed {\n    a: u8,\n    b: u32,  // may be at offset 1, misaligned\n}\n\nlet p = Packed { a: 1, b: 2 };\nlet r: &u32 = &p.b;  // ERROR: reference to packed field\n```\n\nThe compiler rejects this because a `&u32` must point to a 4-byte-aligned address, but `p.b` may not be. The workaround is to copy the value first:\n\n```rust\nlet value = p.b;         // copies the unaligned bytes into a local\nlet r: &u32 = &value;    // value is properly aligned on the stack\n```\n\nOr use raw pointer operations with explicit unaligned reads:\n\n```rust\nlet ptr: *const u32 = std::ptr::addr_of!(p.b);\nlet value = unsafe { ptr.read_unaligned() };\n```\n\n`repr(packed(n))` generalizes this by setting the maximum field alignment to `n`. Fields with natural alignment less than `n` are laid out normally; fields with natural alignment greater than `n` are treated as if their alignment were `n`. This allows partial packing, trading some space for better access patterns.\n\nFor FFI work, combining `repr(C, packed)` gives C-compatible layout with minimal size. This matches `#pragma pack(1)` in many C compilers.\n\n### repr(align): Preventing False Sharing\n\nWhile `repr(packed)` reduces alignment, `repr(align(n))` increases it. The attribute forces the type to have alignment of at least `n` bytes, where `n` must be a power of two.\n\nWhy would we want *more* alignment than necessary? The answer lies in cache architecture. On x86-64, the L1 cache operates on 64-byte cache lines. When one core writes to an address, the entire cache line containing that address is invalidated in all other cores' caches. This is the MESI protocol (or variants like MESIF, MOESI) maintaining coherence.\n\nConsider two atomic counters that different threads increment concurrently:\n\n```rust\nuse std::sync::atomic::{AtomicU64, Ordering};\n\nstruct Counters {\n    a: AtomicU64,  // offset 0, 8 bytes\n    b: AtomicU64,  // offset 8, 8 bytes\n}\n```\n\nBoth counters fit in a single 64-byte cache line. When thread 1 increments `a`, it invalidates thread 2's cache line. When thread 2 increments `b`, it invalidates thread 1's cache line. Neither thread is accessing the other's data, yet they are constantly invalidating each other's caches. This is *false sharing*, and it can degrade performance by an order of magnitude on contended workloads.\n\nThe fix is to ensure each counter occupies its own cache line:\n\n```rust\nuse std::sync::atomic::{AtomicU64, Ordering};\n\n#[repr(align(64))]\nstruct CacheAligned(AtomicU64);\n\nstruct Counters {\n    a: CacheAligned,  // offset 0, padded to 64 bytes\n    b: CacheAligned,  // offset 64, padded to 64 bytes\n}\n```\n\nNow `sizeof::\u003CCounters>()` is 128 bytes instead of 16, but `a` and `b` cannot share a cache line. Each thread's writes affect only its own cache line, and the coherence protocol stops bouncing the line between cores.\n\nThe trade-off is memory consumption. Padding a 8-byte counter to 64 bytes is an 8x increase. For a handful of hot counters in a concurrent data structure, this is negligible. For an array of thousands of counters, it becomes prohibitive. The choice depends on access patterns: if threads access disjoint counters, alignment helps. If threads frequently access the same counter, the contention is real, not false, and alignment does nothing.\n\n`repr(align)` can combine with other representations. `#[repr(C, align(64))]` gives C-compatible field ordering with cache-line alignment. The align modifier applies to the struct as a whole, not to individual fields, so all fields remain at their natural offsets within the enlarged, aligned struct.\n\n### repr(transparent): Zero-Cost Wrappers\n\nSometimes we want a new type that has identical layout to an existing type. The newtype pattern wraps a single field:\n\n```rust\nstruct Meters(f64);\nstruct Seconds(f64);\n```\n\nWith `repr(Rust)`, these types are not guaranteed to have the same layout or ABI as `f64`. A function returning `Meters` might use different registers than a function returning `f64`, even though the underlying data is identical.\n\n`repr(transparent)` guarantees layout and ABI identity:\n\n```rust\n#[repr(transparent)]\nstruct Meters(f64);\n\n#[repr(transparent)]\nstruct Seconds(f64);\n```\n\nNow `Meters` has exactly the same size, alignment, and function-call ABI as `f64`. We can pass a `Meters` where C expects a `double`. We can transmute between `Meters` and `f64` (in either direction) without undefined behavior.\n\n`repr(transparent)` requires that the type has exactly one field with non-zero size, and may have any number of zero-sized fields with alignment 1 (like `PhantomData\u003CT>`).\n\nThis enables patterns like:\n\n```rust\nuse std::marker::PhantomData;\n\n#[repr(transparent)]\nstruct Id\u003CT>(u64, PhantomData\u003CT>);\n```\n\n`Id\u003CUser>` and `Id\u003CPost>` are distinct types at compile time but have identical layout to `u64`. The `PhantomData` participates in the type system (for variance and drop checking) but not in the layout.\n\n### Zero-Sized Types\n\nRust permits types with size zero:\n\n```rust\nstruct Nothing;           // no fields\nstruct AlsoNothing { }    // empty struct\nstruct MoreNothing(());   // contains unit type\nstruct AndNothing([u8; 0]); // zero-length array\n```\n\nAll of these have size 0 and alignment 1 (the minimum). They occupy no memory. An array `[Nothing; 1000000]` has size 0.\n\nZSTs become useful in generic contexts. A `HashMap\u003CK, V>` stores keys and values. What if we only care about keys? We could duplicate the code as `HashSet\u003CK>`, or we could define:\n\n```rust\ntype HashSet\u003CK> = HashMap\u003CK, ()>;\n```\n\nBecause `()` is a ZST, `HashMap\u003CK, ()>` stores no value data. The compiler eliminates loads, stores, and allocations for the values. We get a set implementation from a map implementation with no runtime overhead.\n\nThe standard library's `HashSet` is implemented exactly this way:\n\n```rust\npub struct HashSet\u003CT, S> {\n    map: HashMap\u003CT, (), S>,\n}\n```\n\nUnsafe code must be careful with ZSTs. Pointer arithmetic on `*const T` where `T` is zero-sized is a no-op: `ptr.add(1)` returns `ptr` unchanged. This breaks the assumption that advancing a pointer produces a different address. Additionally, most allocators do not accept zero-size requests, so `Box::new(ZST)` uses special handling rather than calling the allocator.\n\nOne subtle property: references to ZSTs must be non-null and properly aligned (alignment 1 means any address is valid), but dereferencing them is defined to read zero bytes. A reference to a ZST at address 0x1 is valid; a reference at address 0 (null) is undefined behavior even though no actual memory access occurs.\n\n### Empty Types\n\nZero-sized types can be instantiated. We can create a value of type `()` or `struct Nothing;` and pass it around. Empty types go further: they cannot be instantiated at all.\n\n```rust\nenum Void {}\n```\n\nAn enum with no variants has no valid values. We cannot construct a `Void` because there is no variant to construct. The type exists at the type level but can never exist at the value level.\n\nThis enables type-level reasoning about impossibility. Consider a trait for data sources that might fail:\n\n```rust\ntrait DataSource {\n    type Error;\n    fn fetch(&self) -> Result\u003CData, Self::Error>;\n}\n```\n\nMost implementations have a meaningful error type: network sources fail with I/O errors, parsers fail with syntax errors. But some sources are infallible. An in-memory cache cannot fail to read its own contents:\n\n```rust\nenum Infallible {}\n\nstruct MemoryCache { data: Data }\n\nimpl DataSource for MemoryCache {\n    type Error = Infallible;\n    fn fetch(&self) -> Result\u003CData, Infallible> {\n        Ok(self.data.clone())\n    }\n}\n```\n\nThe `Error = Infallible` communicates at the type level that `fetch` cannot return `Err`. Callers can use an irrefutable pattern:\n\n```rust\nfn use_cache(cache: &MemoryCache) {\n    let Ok(data) = cache.fetch();  // no Err case to handle\n    process(data);\n}\n```\n\nThe compiler optimizes based on this knowledge. `Result\u003CT, Infallible>` has the same layout as `T` because the `Err` variant cannot exist and requires no discriminant:\n\n```rust\nuse std::mem::size_of;\nuse std::convert::Infallible;\n\nassert_eq!(size_of::\u003CResult\u003Cu64, Infallible>>(), 8);  // same as u64\n```\n\nThe standard library provides `std::convert::Infallible` for this purpose. It is defined as an empty enum and used throughout the standard library to indicate operations that cannot fail.\n\nRaw pointers to empty types are valid to construct but dereferencing them is undefined behavior. There is no value to read, so the dereference cannot produce a valid result. This makes empty types unsuitable for representing C's `void*`. The recommended approach for opaque C pointers is `*const ()` or a newtype wrapper around it, which can be safely dereferenced to read zero bytes.\n\n### Niche Optimization\n\nAn enum must somehow record which variant it currently holds. The naive approach stores a *discriminant*, a small integer that identifies the variant, alongside the variant's data. For an enum with four variants, we need at least 2 bits to distinguish them; in practice, the discriminant occupies 1, 2, or 4 bytes depending on the number of variants and alignment constraints.\n\nConsider `Option\u003CT>`, which has two variants: `Some(T)` and `None`. The naive layout stores a discriminant plus the `T`:\n\n```rust\n// Naive Option\u003Cu64> layout:\n// discriminant: 1 byte (0 = None, 1 = Some)\n// padding: 7 bytes (to align u64)\n// value: 8 bytes\n// total: 16 bytes\n```\n\nThis is wasteful when `T` is something like `&u64`. A reference is 8 bytes, so `Option\u003C&u64>` would be 16 bytes: 8 for the pointer, plus padding and discriminant overhead. But here is the insight that enables optimization: *a reference can never be null*. Rust guarantees that `&T` always points to a valid `T`. The bit pattern consisting of all zeros, the null pointer, can never represent a valid reference.\n\nThe compiler exploits this. For `Option\u003C&T>`, there is no separate discriminant. The `Some` variant stores the pointer as-is. The `None` variant is represented by the null pointer. Pattern matching becomes a null check:\n\n```rust\n// Actual Option\u003C&u64> layout:\n// pointer: 8 bytes\n// total: 8 bytes\n// None is represented as null (0x0000000000000000)\n// Some(&x) is represented as the address of x\n```\n\nThis is called *niche optimization*. A *niche* is a bit pattern that a type guarantees it will never hold. The compiler uses niches to encode enum discriminants without allocating additional space.\n\nWhich types have niches? Any type that forbids certain bit patterns:\n\nReferences (`&T`, `&mut T`) forbid null. `NonNull\u003CT>` exists specifically to be a non-null pointer. The `NonZeroU32` type (and its siblings `NonZeroU8`, `NonZeroI64`, etc.) forbid zero. `Box\u003CT>` contains a non-null pointer internally. Function pointers forbid null. `bool` only permits 0 and 1, so 254 other byte values are niches.\n\nThe optimization composes. `Option\u003CBox\u003CT>>` uses null for `None`. What about `Option\u003COption\u003CBox\u003CT>>>`? The outer `Option` needs a niche to represent its `None`, and the inner `Option` already used null for *its* `None`. Can we distinguish outer-`None` from `Some(None)`?\n\nOn x86-64 with 48-bit virtual addresses, pointers have constraints beyond non-nullness. The upper 16 bits must be a sign extension of bit 47. Most user-space pointers have the top bits all zeros (canonical lower-half addresses). The compiler can use a non-canonical address like `0x0000000000000001` (misaligned for any type with alignment > 1) to represent additional `None` variants:\n\n```rust\nuse std::mem::size_of;\n\nassert_eq!(size_of::\u003CBox\u003Ci32>>(), 8);\nassert_eq!(size_of::\u003COption\u003CBox\u003Ci32>>>(), 8);\nassert_eq!(size_of::\u003COption\u003COption\u003CBox\u003Ci32>>>>(), 8);\n```\n\nAll three types fit in 8 bytes. The compiler found two niches in the pointer: null for the inner `None`, and another invalid address for the outer `None`.\n\nFor types without niches, the discriminant requires additional space:\n\n```rust\nuse std::mem::size_of;\n\nassert_eq!(size_of::\u003Cu64>(), 8);\nassert_eq!(size_of::\u003COption\u003Cu64>>(), 16);\n```\n\nEvery bit pattern is a valid `u64`, so there is no niche. The compiler must store a separate discriminant, and alignment padding expands the total to 16 bytes.\n\nNow we can return to the point we deferred earlier: why does `#[repr(u8)]` on an enum suppress niche optimization? The `repr(u8)` attribute guarantees that the discriminant is stored as an explicit `u8` at a known location. This is a layout guarantee for FFI and binary serialization. If the compiler used niche optimization, there would be no explicit discriminant byte; the variant would be encoded in the payload's bit pattern. These two requirements are incompatible. Explicit discriminant layout and niche optimization are mutually exclusive:\n\n```rust\nuse std::mem::size_of;\n\nenum WithNiche { Some(Box\u003Ci32>), None }\n\n#[repr(u8)]\nenum WithoutNiche { Some(Box\u003Ci32>), None }\n\nassert_eq!(size_of::\u003CWithNiche>(), 8);      // niche used, no discriminant\nassert_eq!(size_of::\u003CWithoutNiche>(), 16);  // explicit u8 discriminant + padding + pointer\n```\n\nThe `repr(u8)` forces a 1-byte discriminant to exist, which with 7 bytes of padding and the 8-byte pointer yields 16 bytes total.\n\n### Visualizing Layouts\n\nRust provides `std::mem::size_of::\u003CT>()` and `std::mem::align_of::\u003CT>()` for inspecting type properties at runtime (they are const functions, so compile-time evaluation is also possible). For detailed layout information, the `-Zprint-type-sizes` flag on nightly rustc shows field ordering, padding, and discriminant placement:\n\n```\nRUSTFLAGS=-Zprint-type-sizes cargo +nightly build --release\n```\n\nFor an enum like:\n\n```rust\nenum E {\n    A,\n    B(i32),\n    C(u64, u8, u64, u8),\n    D(Vec\u003Cu32>),\n}\n```\n\nThe output shows:\n\n```\nprint-type-size type: `E`: 32 bytes, alignment: 8 bytes\nprint-type-size     discriminant: 1 bytes\nprint-type-size     variant `D`: 31 bytes\nprint-type-size         padding: 7 bytes\nprint-type-size         field `.0`: 24 bytes, alignment: 8 bytes\nprint-type-size     variant `C`: 23 bytes\nprint-type-size         field `.1`: 1 bytes\nprint-type-size         field `.3`: 1 bytes\nprint-type-size         padding: 5 bytes\nprint-type-size         field `.0`: 8 bytes, alignment: 8 bytes\nprint-type-size         field `.2`: 8 bytes\n```\n\nThe compiler has reordered variant `C`'s fields to place the `u8`s before the padding, minimizing wasted space. The discriminant is only 1 byte despite four variants (2 bits suffice, but alignment constraints mean 1 byte is the minimum addressable unit).\n\n## Fat Pointers and Dynamically Sized Types\n\nWe saw how `repr(Rust)` gives the compiler freedom to reorder fields because it knows each field's size and alignment at compile time. But this assumption does not always hold. Some types have sizes that can only be determined at runtime, and the way Rust handles them differs sharply from C++.\n\n### The Problem with C Arrays\n\nIn C, when we pass an array to a function, the type system loses information.\n\n```c\nvoid process(int arr[], size_t len);\n\nint main(void) {\n    int data[10] = {0};\n    process(data, 10);  // must pass length separately\n}\n```\n\nThe parameter `int arr[]` is identical to `int *arr`. The array *decays* to a pointer, and the length vanishes from the type. Nothing in the language connects the pointer to its length. If we pass the wrong length, we get buffer overflows. If we forget to pass it entirely, the function cannot know where the array ends.\n\nThis decay happens implicitly. The expression `data` in the call site has type `int[10]`, but by the time it reaches `process`, it is just `int*`. The compiler erases information that the programmer must then track manually.\n\n### Dynamically Sized Types in Rust\n\nRust solves this with *dynamically sized types* (DSTs), types whose size is not known at compile time. The language has three built-in DST categories.\n\nThe slice type `[T]` represents a contiguous sequence of `T` values of unknown length. Unlike `[T; N]`, which has compile-time-known size `N * size_of::\u003CT>()`, the type `[T]` could represent any number of elements. A `[u8]` might be 10 bytes or 10,000 bytes.\n\nThe string slice `str` is semantically a `[u8]` with a validity invariant requiring UTF-8 encoding. It shares the same dynamically-sized nature.\n\nTrait objects `dyn Trait` represent values of unknown concrete type that implement `Trait`. A `dyn Display` might be a `String` at 24 bytes, an `i32` at 4 bytes, or a custom type of arbitrary size. The concrete type is erased; only the interface remains.\n\nHowever, all these types cannot exist directly on the stack or as struct fields (except as the last field). We cannot write `let x: [u8];` because the compiler cannot determine how much stack space to allocate. DSTs exist only behind pointers.\n\n### Wide Pointers\n\nA pointer to a sized type is a single machine word, 8 bytes on x86-64. A pointer to a DST must carry additional information, making it twice as wide.\n\nFor slices, a `&[T]` stores a pointer to the first element paired with the number of elements.\n\n```rust\nuse std::mem::size_of;\n\nassert_eq!(size_of::\u003C&u8>(), 8);        // thin pointer\nassert_eq!(size_of::\u003C&[u8]>(), 16);     // wide pointer\nassert_eq!(size_of::\u003C&str>(), 16);      // same representation as &[u8]\n```\n\nWe can examine the actual representation using `std::ptr::metadata`:\n\n```rust\nlet arr = [1i32, 2, 3, 4, 5];\nlet slice: &[i32] = &arr[1..4];\n\n// The slice is (pointer to arr[1], length 3)\nlet ptr = slice.as_ptr();\nlet len = slice.len();\n\nassert_eq!(len, 3);\nassert_eq!(unsafe { *ptr }, 2);  // first element of slice\n```\n\nThe wide pointer solves the C problem. When we pass a `&[T]`, the length travels with the pointer. There is no way to separate them, pass the wrong length or forget it.\n\nThe coercion from `&[i32; 5]` to `&[i32]` is an *unsizing coercion*. The compiler takes the thin pointer to the array, combines it with the statically-known length, and produces a wide pointer. This happens implicitly at coercion sites, including `let` bindings with explicit types, function arguments, and return values.\n\n### Trait Object Representation\n\nFor trait objects, the wide pointer contains different metadata. A `&dyn Trait` stores a pointer to the concrete value paired with a pointer to a *vtable* (virtual method table).\n\n```rust\nuse std::mem::size_of;\n\ntrait Drawable {\n    fn draw(&self);\n    fn area(&self) -> f64;\n}\n\nimpl Drawable for i32 {\n    fn draw(&self) { println!(\"{}\", self); }\n    fn area(&self) -> f64 { 0.0 }\n}\n\nassert_eq!(size_of::\u003C&i32>(), 8);\nassert_eq!(size_of::\u003C&dyn Drawable>(), 16);\n```\n\nThe vtable is a static data structure generated by the compiler for each (concrete type, trait) pair. It contains function pointers for every method in the trait, plus metadata required for memory management.\n\nFor a trait `Drawable` with methods `draw` and `area`, the vtable looks roughly like this:\n\n```\n+0:   drop_in_place::\u003CConcreteType>\n+8:   size_of::\u003CConcreteType>\n+16:  align_of::\u003CConcreteType>\n+24:  Drawable::draw for ConcreteType\n+32:  Drawable::area for ConcreteType\n```\n\nThe size and alignment entries are essential for dropping boxed trait objects. When we call `drop` on a `Box\u003Cdyn Drawable>`, the runtime must know how many bytes to deallocate and what alignment the allocator expects.\n\n### Virtual Dispatch in Assembly\n\nWhen we call a method on a trait object, the compiler generates an indirect call through the vtable. Consider this function:\n\n```rust\nfn call_draw(obj: &dyn Drawable) {\n    obj.draw();\n}\n```\n\nOn x86-64, this compiles to something like:\n\n```asm\ncall_draw:\n    ; rdi = data pointer (obj.data)\n    ; rsi = vtable pointer (obj.vtable)\n    mov     rax, [rsi + 24]    ; load draw function pointer from vtable\n    mov     rdi, rdi           ; data pointer becomes first argument (self)\n    jmp     rax                ; tail call to draw implementation\n```\n\nThe vtable lookup adds one memory indirection compared to a direct call. More significantly, the indirect call through a register prevents the CPU from predicting the branch target until the vtable load completes. Modern CPUs have indirect branch predictors, but they are less effective than direct branch prediction.\n\nCompare this to a generic function with static dispatch:\n\n```rust\nfn call_draw_static\u003CT: Drawable>(obj: &T) {\n    obj.draw();\n}\n```\n\nHere the compiler monomorphizes the function for each concrete `T`, producing a direct call:\n\n```asm\ncall_draw_static_for_i32:\n    jmp     \u003Ci32 as Drawable>::draw\n```\n\nNo vtable lookup, no indirect branch. The call target is known at compile time, enabling inlining. If `draw` is small, the compiler can inline it entirely, eliminating the call overhead and enabling further optimizations across the inlined code.\n\n### Performance Implications of Dynamic Dispatch\n\nThe overhead of virtual dispatch is not just the vtable lookup. The indirect call has cascading effects on the CPU pipeline.\n\nModern CPUs predict branch targets to keep the instruction pipeline full. For direct calls, the target is encoded in the instruction itself, and the predictor can fetch the target instructions immediately. For indirect calls through a register, the CPU must wait for the register value to be computed (the vtable load), then use an indirect branch predictor to guess the target. Indirect branch predictors maintain a table of recent indirect branch targets, but they are less accurate than direct branch prediction, especially when a call site dispatches to many different implementations.\n\nWhen the predictor guesses wrong, the pipeline must be flushed and restarted from the correct target. On modern x86-64, this costs roughly 15-20 cycles. If a tight loop calls a trait object method that alternates between two implementations, the predictor may never stabilize, incurring the misprediction penalty on every other iteration.\n\nThe vtable itself must be in cache for the lookup to be fast. A vtable is small (typically 32-64 bytes for a trait with a few methods), but if we iterate over a heterogeneous collection of trait objects, each object may point to a different vtable. With many distinct implementations, the vtables compete for cache space. The first access to each vtable is a cache miss, adding 100+ cycles of memory latency.\n\nInlining is the most significant loss. When the compiler inlines a function, it can see both caller and callee code simultaneously. This enables constant propagation, dead code elimination, loop fusion, and SIMD vectorization across the boundary. In the general case, none of this is possible through a vtable, the compiler cannot see through the indirection, so each call becomes an optimization barrier.\n\nIn C++, modern compilers can sometimes *devirtualize* virtual calls. If the concrete type is visible at the call site (immediately after construction, or when the class is marked `final`), Clang/GCC may replace the indirect call with a direct one. With LTO and `-fwhole-program-vtables`, C++ compilers can devirtualize when only one implementation exists program-wide.\n\nRust's situation is less favorable. As of 2024, rustc does not provide the metadata LLVM needs for whole-program devirtualization. Even when only a single type implements a trait in the entire binary, trait object calls remain indirect. LLVM can devirtualize in trivial cases where the concrete type is immediately visible (creating a trait object and calling a method in the same basic block), but this is rare in practice. The tracking issue rust-lang/rust#68262 has seen little progress. For now, if you need devirtualization in Rust, use generics or enums, the compiler will not rescue trait objects for you.\n\nConsider a loop summing areas. Here we must be careful: the static and dynamic versions solve *different* problems.\n\n```rust\n// Static dispatch: all elements must be the same concrete type\nfn sum_areas_static\u003CT: Drawable>(shapes: &[T]) -> f64 {\n    shapes.iter().map(|s| s.area()).sum()\n}\n\n// Dynamic dispatch: elements can be different concrete types\nfn sum_areas_dynamic(shapes: &[&dyn Drawable]) -> f64 {\n    shapes.iter().map(|s| s.area()).sum()\n}\n```\n\nThe static version requires a homogeneous slice, all `Circle`s or all `Rectangle`s, never mixed. The dynamic version accepts heterogeneous collections. These are not interchangeable; we choose based on whether we need polymorphism over a closed or open set of types.\n\nFor the homogeneous case, the compiler can inline the entire loop body, unroll the loop, and potentially vectorize with SIMD. For the heterogeneous case, each `area()` call is a function pointer load, an indirect call, and a return. The loop cannot be vectorized because the compiler cannot prove anything about what `area()` does.\n\nWhen the set of types is closed and known at compile time, Rust offers a third approach that combines the benefits of both: enum dispatch.\n\n```rust\nenum Shape {\n    Circle(Circle),\n    Rectangle(Rectangle),\n}\n\nimpl Shape {\n    fn area(&self) -> f64 {\n        match self {\n            Shape::Circle(c) => c.area(),\n            Shape::Rectangle(r) => r.area(),\n        }\n    }\n}\n\nfn sum_areas_enum(shapes: &[Shape]) -> f64 {\n    shapes.iter().map(|s| s.area()).sum()\n}\n```\n\nThe enum approach accepts a heterogeneous collection (circles and rectangles mixed), but the dispatch is a compile-time match expression rather than a vtable lookup. The compiler can inline each branch, and modern CPUs predict `match` arms more reliably than indirect calls. The slice is homogeneous at the type level (`&[Shape]`), so it is cache-friendly, no pointer chasing, no scattered vtables.\n\nThe trade-off is extensibility. Adding a new shape to an enum requires modifying the enum definition and every `match`. With trait objects, new types can implement the trait without touching existing code. Enums are closed; traits are open.\n\nThe rule of thumb is to use generics with trait bounds for performance-critical code paths where all elements share a concrete type. Use enums when the type set is closed and we need heterogeneous collections with predictable dispatch. Reserve trait objects for open extensibility where the flexibility is worth the cost, or for reducing compile times and binary size when performance is not critical.\n\n### The Vtable Location Trade-off\n\nRust and C++ made opposite design decisions about where to store the vtable pointer.\n\nIn C++, polymorphic objects embed a *vptr* directly in the object:\n\n```cpp\nclass Drawable {\npublic:\n    virtual void draw() = 0;\n    virtual double area() = 0;\n    virtual ~Drawable() = default;\n    int x;\n};\n\n// Memory layout of a Drawable subclass instance:\n// +0:  vptr (8 bytes, points to vtable)\n// +8:  x (4 bytes)\n// +12: padding (4 bytes)\n// Total: 16 bytes\n```\n\nEvery instance of a polymorphic class carries the vptr. A `Drawable*` or `Drawable&` is 8 bytes, but each object is 8 bytes larger than it would be without virtual functions.\n\nRust places the vtable pointer in the reference, not the object:\n\n```rust\nstruct Circle {\n    radius: f64,\n}\n\nimpl Drawable for Circle {\n    fn draw(&self) { /* ... */ }\n    fn area(&self) -> f64 { std::f64::consts::PI * self.radius * self.radius }\n}\n\n// Memory layout of Circle:\n// +0: radius (8 bytes)\n// Total: 8 bytes (no vptr)\n\n// Memory layout of &dyn Drawable pointing to Circle:\n// +0: data pointer (8 bytes)\n// +8: vtable pointer (8 bytes)\n// Total: 16 bytes\n```\n\nThe trade-off is memory allocation versus reference size. With a million objects and one reference each, C++ uses 8 MB for vptrs embedded in objects; Rust uses 8 MB for vtable pointers in references. With a million objects and ten references each, C++ still uses 8 MB; Rust uses 80 MB.\n\nBut Rust's design enables something C++ cannot do. The same object can be viewed through multiple trait lenses simultaneously:\n\n```rust\nuse std::fmt::Debug;\n\nlet circle = Circle { radius: 1.0 };\n\nlet drawable: &dyn Drawable = &circle;\nlet debug: &dyn Debug = &circle;\nlet any: &dyn std::any::Any = &circle;\n```\n\nEach reference carries its own vtable pointer, pointing to different vtables. The `circle` object itself is unchanged. In C++, the vptr embedded in the object determines its dynamic type at construction time. A `Drawable*` and a `Base*` pointing to the same object use the same embedded vptr (possibly adjusted for multiple inheritance).\n\n### Dyn Compatibility\n\nNot every trait can be used as a trait object. The rules for *dyn compatibility* (formerly called object safety) restrict which traits work with dynamic dispatch.\n\nA dyn-compatible trait must not require `Self: Sized`. Requiring `Sized` would contradict the purpose of trait objects, which exist to handle values of unknown size. The trait must have no associated constants, since constants require knowing the concrete type at compile time. It must have no associated types with generic parameters, which would require instantiation at compile time.\n\nAll methods must be dispatchable or explicitly non-dispatchable. A dispatchable method must have a receiver (`&self`, `&mut self`, `Box\u003CSelf>`, etc.), must not return `Self` by value, must not take `Self` by value as a parameter, and must not have type parameters.\n\n```rust\n// Dyn compatible\ntrait Compatible {\n    fn method(&self);\n    fn returns_ref(&self) -> &str;\n}\n\n// NOT dyn compatible\ntrait Incompatible {\n    fn returns_self(&self) -> Self;        // Self in return position\n    fn takes_self(&self, other: Self);     // Self as parameter\n    fn generic\u003CT>(&self, x: T);            // type parameter\n    const VALUE: i32;                       // associated constant\n}\n```\n\nDynamic dispatch requires a vtable entry for each method, and a vtable entry is a function pointer with a fixed signature. If a method returns `Self`, the return type depends on the concrete type, which is erased. If a method is generic over `T`, there would need to be infinitely many vtable entries, one for each `T`.\n\nMethods that violate these rules can still exist on dyn-compatible traits if they have a `where Self: Sized` bound, making them unavailable through trait objects but callable on concrete types:\n\n```rust\ntrait PartiallyCompatible {\n    fn dispatchable(&self);\n    \n    fn not_dispatchable(&self) -> Self where Self: Sized;\n}\n\n// This works:\nlet obj: &dyn PartiallyCompatible = &some_value;\nobj.dispatchable();\n\n// This does not compile:\n// obj.not_dispatchable();\n```\n\n### Auto Traits and Lifetime Bounds\n\nTrait objects can include auto traits and lifetime bounds. Unlike regular traits, where only one non-auto trait is allowed, auto traits can be added freely:\n\n```rust\nuse std::fmt::Debug;\n\n// All valid trait object types:\nfn takes_debug(x: &dyn Debug) {}\nfn takes_debug_send(x: &dyn Debug + Send) {}\nfn takes_debug_send_sync(x: &(dyn Debug + Send + Sync)) {}\nfn takes_debug_static(x: &(dyn Debug + 'static)) {}\n```\n\nThe auto traits (`Send`, `Sync`, `Unpin`, etc.) do not add methods to the vtable. They are marker traits checked at compile time when the trait object is created. If we try to create a `&dyn Debug + Send` from a type that is not `Send`, the compiler rejects it:\n\n```rust\nuse std::rc::Rc;\nuse std::fmt::Debug;\n\nlet rc: Rc\u003Ci32> = Rc::new(42);\n// Error: Rc\u003Ci32> is not Send\n// let obj: &(dyn Debug + Send) = &*rc;\n```\n\nLifetime bounds constrain how long references inside the trait object can live. A `dyn Trait + 'static` contains no non-`'static` references. A `dyn Trait + 'a` may contain references that live at least as long as `'a`. The default lifetime depends on context and follows elision rules.\n\n### Supertraits in the Vtable\n\nWhen a trait has supertraits, the vtable includes method entries for the supertrait methods:\n\n```rust\ntrait Shape {\n    fn area(&self) -> f64;\n}\n\ntrait Circle: Shape {\n    fn radius(&self) -> f64;\n}\n```\n\nThe vtable for `dyn Circle` contains entries for both `area` and `radius`. When we call a supertrait method on a trait object, it goes through the same vtable lookup:\n\n```rust\nfn print_area(c: &dyn Circle) {\n    // This works because Shape::area is in the Circle vtable\n    println!(\"Area: {}\", c.area());\n}\n```\n\nTrait object upcasting allows converting `&dyn Circle` to `&dyn Shape`. The compiler generates a different vtable for `dyn Shape` that contains only `area`, and the conversion substitutes the vtable pointer:\n\n```rust\nfn use_as_shape(c: &dyn Circle) {\n    let shape: &dyn Shape = c;  // upcasting coercion\n    println!(\"Area: {}\", shape.area());\n}\n```\n\n### The ?Sized Bound\n\nBy default, all type parameters have an implicit `Sized` bound:\n\n```rust\nfn foo\u003CT>(x: T) { }\n// is equivalent to:\nfn foo\u003CT: Sized>(x: T) { }\n```\n\nThis makes sense. To pass `x` by value, the compiler must know its size to copy it onto the stack. But sometimes we want to accept DSTs through references. The `?Sized` bound relaxes the `Sized` requirement:\n\n```rust\nfn process\u003CT: ?Sized>(x: &T) {\n    // T might be a DST\n    // x is a wide pointer if T is unsized\n}\n\n// Now this works:\nprocess::\u003C[u8]>(&[1, 2, 3][..]);\nprocess::\u003Cstr>(\"hello\");\nprocess::\u003Cdyn std::fmt::Debug>(&42);\n```\n\nThe standard library uses `?Sized` extensively. The signature of `std::borrow::Borrow` is:\n\n```rust\npub trait Borrow\u003CBorrowed: ?Sized> {\n    fn borrow(&self) -> &Borrowed;\n}\n```\n\nThis allows `String` to implement `Borrow\u003Cstr>`, returning `&str`, a reference to a DST.\n\nIn trait definitions, `Self` has an implicit `Self: ?Sized` bound, the opposite of type parameters. This allows traits to be implemented for DSTs:\n\n```rust\ntrait MyTrait {\n    fn method(&self);\n}\n\nimpl MyTrait for str {\n    fn method(&self) {\n        println!(\"length: {}\", self.len());\n    }\n}\n```\n\nIf traits required `Self: Sized` by default, we could not implement traits for `str`, `[T]`, or `dyn OtherTrait`.\n\n### Custom DSTs\n\nA struct can contain a DST as its last field, making the struct itself a DST:\n\n```rust\nstruct MySlice {\n    header: u32,\n    data: [u8],  // DST as last field\n}\n```\n\n`MySlice` is now a DST. We cannot create it directly on the stack. The only supported construction method is through unsizing coercion from a sized variant:\n\n```rust\nstruct MySized\u003Cconst N: usize> {\n    header: u32,\n    data: [u8; N],\n}\n\nfn main() {\n    let sized = MySized::\u003C4> { header: 42, data: [1, 2, 3, 4] };\n    let dynamic: &MySlice = unsafe {\n        // Requires ptr::from_raw_parts or careful transmutation\n        std::mem::transmute::\u003C&MySized\u003C4>, &MySlice>(&sized)\n    };\n    \n    assert_eq!(dynamic.header, 42);\n    assert_eq!(dynamic.data.len(), 4);\n}\n```\n\nThis is awkward and requires unsafe code. The `ptr::from_raw_parts` API (stabilized in Rust 1.79) provides a safer way to construct custom DST pointers, but the ergonomics remain poor. Most code uses the built-in DST types (`[T]`, `str`, `dyn Trait`) rather than defining custom ones.\n\nTo construct a DST, we must provide the metadata (length or vtable pointer) that completes the type. But the language provides no syntax for this at the value level. The standard library handles DST construction internally through careful unsafe code and compiler magic for types like `str` and `[T]`.\n\n### Invalid Metadata is Undefined Behavior\n\nThe metadata in a wide pointer is not merely informational. The compiler trusts it for safety-critical operations. Providing invalid metadata is undefined behavior.\n\nFor slices, the length must not cause the slice to extend beyond its allocation:\n\n```rust\nlet arr = [1, 2, 3];\nlet ptr = arr.as_ptr();\n// UB: length 1000 exceeds the allocation\nlet bad_slice: &[i32] = unsafe {\n    std::slice::from_raw_parts(ptr, 1000)\n};\n```\n\nFor trait objects, the vtable must be a valid vtable for the trait that matches the actual dynamic type of the pointed-to object:\n\n```rust\n// UB: null is not a valid vtable\nlet data_ptr: *const () = &42i32 as *const i32 as *const ();\nlet vtable_ptr: *const () = std::ptr::null();\nlet bad: &dyn std::fmt::Debug = unsafe {\n    std::mem::transmute((data_ptr, vtable_ptr))\n};\n```\n\nThe Rust Reference explicitly lists invalid wide pointer metadata as undefined behavior. Calling a method through a corrupted vtable pointer could jump to arbitrary code. Using an invalid slice length could read or write out of bounds.\n\n## Polymorphism: Monomorphization vs Vtables\n\nWe saw how Rust represents pointers to dynamically sized types. A `&dyn Draw` carries both a data pointer and a vtable pointer, 16 bytes that enable runtime method dispatch. But this raises a question we have not yet answered: why does Rust need two polymorphism mechanisms at all? Templates and generics already let us write code that works across types. Why introduce vtables?\n\nWhen we write a function that operates on \"any type implementing trait X,\" the compiler must decide how to generate code for it. Two strategies exist. The compiler can stamp out a separate copy of the function for each concrete type that actually gets used, a process called *monomorphization*. Alternatively, the compiler can generate a single copy of the function that dispatches method calls through a table of function pointers at runtime. Both C++ and Rust support both strategies. C, lacking native generics, provides only workarounds that approximate each approach with varying degrees of type safety.\n\nMonomorphization eliminates runtime indirection entirely; every call is direct, every function body can be inlined, the optimizer sees through abstraction boundaries. But the binary contains a separate copy of the generic code for every type instantiation, which bloats both compile time and binary size. Dynamic dispatch through vtables produces a single copy of the code regardless of how many implementing types exist, but every method call requires loading a function pointer from memory and jumping through it, which the CPU cannot predict well and which prevents inlining.\n\n### C Without Generics\n\nC has no built-in parametric polymorphism. We cannot write a function that operates on \"any comparable type\" and have the compiler generate type-safe, specialized versions. Historically, C programmers used three workarounds.\n\nPreprocessor macros perform textual substitution before the compiler ever sees the code:\n\n```c\n#define MAX(a, b) ((a) > (b) ? (a) : (b))\n\nint x = MAX(3, 5);           // expands to ((3) > (5) ? (3) : (5))\ndouble y = MAX(1.5, 2.5);    // expands to ((1.5) > (2.5) ? (1.5) : (2.5))\n```\n\nEach use site expands to type-specific code, achieving something like monomorphization. But macros operate outside the type system. The preprocessor has no concept of what `a` and `b` are; it pastes text. This leads to the classic double-evaluation trap:\n\n```c\n#define SQUARE(x) ((x) * (x))\nint a = 5;\nint b = SQUARE(a++);  // expands to ((a++) * (a++)), undefined behavior\n```\n\nThe argument is evaluated twice. If it has side effects, the program's behavior becomes undefined. The macro cannot evaluate its argument once and bind it to a local; macros do not have local variables.\n\nC11 introduced `_Generic`, which provides compile-time type dispatch:\n\n```c\n#define abs(x) _Generic((x),    \\\n    int: abs_int,               \\\n    long: abs_long,             \\\n    double: fabs,               \\\n    default: abs_int)(x)\n\nint abs_int(int x) { return x \u003C 0 ? -x : x; }\nlong abs_long(long x) { return x \u003C 0 ? -x : x; }\n```\n\nThe `_Generic` keyword examines the type of its first argument and selects the corresponding expression. This is better than macros: the selection happens within the type system, and each branch is a proper function that evaluates its argument once. But we must enumerate every supported type explicitly and write separate implementations for each. We have not reduced code duplication; we have centralized dispatch.\n\nFor dynamic polymorphism, we can use function pointers with `void*`:\n\n```c\ntypedef int (*comparator)(const void*, const void*);\n\nvoid qsort(void* base, size_t nmemb, size_t size, comparator cmp);\n\nint compare_int(const void* a, const void* b) {\n    return *(const int*)a - *(const int*)b;\n}\n\nint arr[] = {5, 2, 8, 1};\nqsort(arr, 4, sizeof(int), compare_int);\n```\n\nThe standard library's `qsort` treats the array as raw bytes and accepts a function pointer for comparison. The type information is erased: the comparator receives `void*` and must cast internally. Nothing prevents passing `compare_int` to sort an array of `double`. The compiler cannot verify correctness. If the programmer gets it wrong, the program silently produces garbage or crashes.\n\n### C++ Templates\n\nC++ templates let us define families of functions and classes parameterized over types:\n\n```cpp\ntemplate\u003Ctypename T>\nT max(T a, T b) {\n    return (a > b) ? a : b;\n}\n\nint x = max(3, 5);           // instantiates max\u003Cint>\ndouble y = max(1.5, 2.5);    // instantiates max\u003Cdouble>\n```\n\nWhen the compiler encounters `max(3, 5)`, it deduces `T = int` and generates a specialized function `max\u003Cint>`. A separate `max\u003Cdouble>` gets generated for the second call. Each instantiation is compiled independently, producing code identical to what we would write by hand. There is no runtime overhead.\n\nTemplates use what is sometimes called *duck typing*: if the operations used in the template body are valid for the concrete type, instantiation succeeds. If not, the compiler emits an error. The problem is that errors emerge from deep within the template instantiation, often producing notoriously verbose diagnostics that obscure the root cause. The template's requirements are implicit; we discover at instantiation time whether a type satisfies them.\n\nThis implicit checking enables SFINAE (Substitution Failure Is Not An Error), a mechanism where invalid template substitutions silently remove candidates from the overload set rather than causing hard errors. Before C++20, constraining templates required arcane metaprogramming with `std::enable_if` and type traits:\n\n```cpp\n#include \u003Ctype_traits>\n\ntemplate\u003Ctypename T>\ntypename std::enable_if\u003Cstd::is_integral\u003CT>::value, T>::type\nabsolute(T x) {\n    return x \u003C 0 ? -x : x;\n}\n```\n\nThe `enable_if` machinery conditionally makes the return type valid or invalid depending on the type trait. If `T` is not integral, the substitution fails, and this overload is removed from consideration. The code works but is dense with machinery that obscures intent.\n\nC++20 introduced concepts, which make constraints explicit:\n\n```cpp\n#include \u003Cconcepts>\n\ntemplate\u003Ctypename T>\nconcept Comparable = requires(T a, T b) {\n    { a \u003C b } -> std::convertible_to\u003Cbool>;\n    { a > b } -> std::convertible_to\u003Cbool>;\n};\n\ntemplate\u003CComparable T>\nT max(T a, T b) {\n    return (a > b) ? a : b;\n}\n```\n\nThe `Comparable` concept declares what operations `T` must support. The template states its constraint explicitly in the signature. If we instantiate `max` with a non-comparable type, the error message refers directly to the violated concept rather than to some failed substitution buried in the template body.\n\nRegardless of how constraints are expressed, templates monomorphize. For large templates like `std::sort` or `std::unordered_map`, binary bloat becomes pretty significant. We can mitigate this effect with explicit instantiation, where we declare in a single translation unit which instantiations to generate:\n\n```cpp\n// header\ntemplate\u003Ctypename T>\nvoid process(T x);\n\n// source\ntemplate\u003Ctypename T>\nvoid process(T x) { /* implementation */ }\n\ntemplate void process\u003Cint>(int);\ntemplate void process\u003Cdouble>(double);\n```\n\nOther translation units can use `process\u003Cint>` without triggering instantiation; they link against the pre-generated code. This reduces compile time and binary size at the cost of flexibility.\n\n### C++ Virtual Functions\n\nC++ supports runtime polymorphism through virtual functions. A class with at least one virtual function is *polymorphic*:\n\n```cpp\nclass Shape {\npublic:\n    virtual double area() const = 0;\n    virtual ~Shape() = default;\n};\n\nclass Circle : public Shape {\n    double radius;\npublic:\n    Circle(double r) : radius(r) {}\n    double area() const override { return 3.14159 * radius * radius; }\n};\n\nclass Rectangle : public Shape {\n    double width, height;\npublic:\n    Rectangle(double w, double h) : width(w), height(h) {}\n    double area() const override { return width * height; }\n};\n```\n\nWhen we call a virtual function through a base class pointer or reference, the actual function invoked depends on the dynamic type of the object:\n\n```cpp\nvoid print_area(const Shape& s) {\n    std::cout \u003C\u003C s.area() \u003C\u003C \"\\n\";  // virtual dispatch\n}\n\nCircle c(1.0);\nRectangle r(2.0, 3.0);\nprint_area(c);  // calls Circle::area\nprint_area(r);  // calls Rectangle::area\n```\n\nThe compiler cannot know at compile time which implementation to call. The decision is deferred to runtime.\n\nTo implement this, the compiler inserts a hidden pointer (the *vptr*) into every object of a polymorphic class. The vptr points to a static table (the *vtable*) shared by all objects of the same dynamic type. The Itanium C++ ABI, used by GCC, Clang, and most non-Windows compilers, specifies the vtable layout precisely.\n\nThe vtable contains several components, laid out at specific offsets from an *address point*. Components before the address point (at negative offsets) include virtual call offsets for adjusting `this` pointers in multiple inheritance scenarios, virtual base offsets for locating virtual base subobjects, and the *offset-to-top*, a `ptrdiff_t` giving the displacement from this vtable pointer location to the top of the complete object (used by `dynamic_cast\u003Cvoid*>`). At the address point sits the RTTI pointer, pointing to type information for runtime type identification. After the address point come the virtual function pointers themselves, in declaration order.\n\nFor a simple class hierarchy without multiple inheritance, the layout simplifies. A `Circle` object in memory looks like:\n\n```\nCircle object (16 bytes on x86-64):\n+0:   vptr (8 bytes, points to Circle's vtable)\n+8:   radius (8 bytes, double)\n\nCircle's vtable:\n-16:  offset-to-top (0)\n-8:   RTTI pointer\n 0:   &Circle::~Circle() (complete destructor)\n+8:   &Circle::~Circle() (deleting destructor)\n+16:  &Circle::area()\n```\n\nThe vptr in every `Circle` instance points to offset 0 of this vtable, the address point. When we call `s.area()` where `s` is a `Shape&`, the compiler generates:\n\n```asm\n; rdi = pointer to Shape object\nmov     rax, [rdi]          ; load vptr from object\nmov     rax, [rax + 16]     ; load area() pointer from vtable\ncall    rax                 ; indirect call\n```\n\nTwo memory loads occur on every virtual call: one to fetch the vptr from the object, one to fetch the function pointer from the vtable. More significantly, the `call rax` is an indirect branch. The CPU's branch predictor must guess the target without knowing it until the register value is computed. If a call site invokes many different implementations (iterating over a heterogeneous container of shapes), the predictor may thrash, causing pipeline stalls.\n\nThe optimizer cannot inline through a virtual call. It does not know which function will be invoked, so it cannot substitute the function body at the call site. This blocks constant propagation, dead code elimination, and other interprocedural optimizations.\n\nThe advantage is code size. There is exactly one `print_area` function, regardless of how many shape types exist. The vtable adds per-class overhead, not per-use overhead. For large class hierarchies, this can dramatically reduce binary size compared to templated alternatives.\n\n### Rust Generics\n\nRust generics follow the monomorphization strategy, like C++ templates, but with a critical difference: constraints are declared upfront.\n\n```rust\nfn max\u003CT: PartialOrd>(a: T, b: T) -> T {\n    if a > b { a } else { b }\n}\n\nlet x = max(3, 5);           // instantiates max::\u003Ci32>\nlet y = max(1.5, 2.5);       // instantiates max::\u003Cf64>\n```\n\nThe bound `T: PartialOrd` states that `T` must implement the `PartialOrd` trait. The compiler checks this at the call site: calling `max` with a type that does not implement `PartialOrd` produces an error that directly states the unsatisfied bound.\n\nInside the function body, we can only use operations that `PartialOrd` guarantees. Attempting to call methods not provided by the bound fails immediately, not at instantiation:\n\n```rust\nfn broken\u003CT: PartialOrd>(a: T, b: T) -> T {\n    println!(\"{}\", a);  // error: T doesn't implement Display\n    if a > b { a } else { b }\n}\n```\n\nRust checks the generic function against its declared bounds before instantiation. This differs from C++ templates, where the body is tentatively compiled against each concrete type, with errors emerging during instantiation.\n\nThe monomorphization process itself works similarly. When the Rust compiler encounters generic function calls, it records the concrete types. During code generation, the *monomorphization collector* traverses the call graph to identify all required instantiations. Each generic function paired with each set of concrete type arguments becomes a distinct *mono item* that gets compiled to machine code.\n\nThe collector partitions mono items into *Codegen Units* (CGUs). For incremental compilation, the partitioner creates separate CGUs for stable non-generic code and for monomorphized instances. When only generic instantiations change, the stable CGU can be reused.\n\nThe same binary size concerns apply. A generic function used with many types produces many copies. The `cargo llvm-lines` tool shows which functions contribute most to generated LLVM IR. In large codebases, common utility functions like `Option::map` and `Result::map_err` can get instantiated hundreds of times, dominating code size.\n\nThe standard mitigation is the *inner function pattern*: move the bulk of the logic into a non-generic inner function, leaving a thin generic wrapper:\n\n```rust\npub fn read\u003CP: AsRef\u003CPath>>(path: P) -> io::Result\u003CVec\u003Cu8>> {\n    fn inner(path: &Path) -> io::Result\u003CVec\u003Cu8>> {\n        let mut file = File::open(path)?;\n        let size = file.metadata().map(|m| m.len()).unwrap_or(0);\n        let mut bytes = Vec::with_capacity(size as usize);\n        io::default_read_to_end(&mut file, &mut bytes)?;\n        Ok(bytes)\n    }\n    inner(path.as_ref())\n}\n```\n\nThe outer generic function calls `as_ref()` to convert `P` to `&Path`, then delegates to `inner`. Now `inner` compiles once regardless of how many path types are used. The outer wrapper is tiny, its monomorphization overhead minimal.\n\n### Rust Trait Objects\n\nWhen monomorphization costs are prohibitive, Rust offers trait objects. We already covered the representation: `&dyn Trait` is a wide pointer containing a data pointer and a vtable pointer. Calling a method loads the function pointer from the vtable and invokes it indirectly.\n\nThe key difference from C++ is where the vtable pointer lives. In C++, the vptr is embedded in the object. A `Circle` contains its own vptr; the `Circle` type is inherently polymorphic. In Rust, the vtable pointer is in the reference, not the object. A plain `Circle` struct has no vptr. The vtable pointer appears only when we view the `Circle` through a trait object:\n\n```rust\nlet c = Circle { radius: 1.0 };\nlet shape: &dyn Shape = &c;  // wide pointer created here\n```\n\nThe `Circle` struct occupies only the bytes its fields require. The 8-byte vtable pointer is added when we create the `&dyn Shape`, not when we create the `Circle`. An object can be viewed through multiple different trait objects, each with its own vtable, without the object itself containing any vtable pointers.\n\nThis design means Rust structs remain trivially copyable (if their fields are) even when they implement traits with virtual methods. In C++, adding a single virtual function to a class makes it non-trivially copyable and increases its size by the vptr. In Rust, implementing a trait never changes a struct's layout.\n\n### Choosing Between Strategies\n\nStatic dispatch through monomorphization is appropriate when the hot path demands maximum performance, when the set of types is small and known, when inlining across the generic boundary matters, and when compile time and binary size are acceptable costs.\n\nDynamic dispatch through vtables is appropriate when the concrete type cannot be known until runtime (plugin systems, user-defined types loaded dynamically), when binary size is constrained, when compile time must be minimized, and when the call overhead is negligible compared to the work the method performs.\n\nThere are common patterns that combine both. For example, we can expose a generic public API and then convert to a trait object internally to avoid instantiation explosion:\n\n```rust\npub fn process\u003CW: Write>(writer: W) {\n    process_dyn(&mut writer as &mut dyn Write)\n}\n\nfn process_dyn(writer: &mut dyn Write) {\n    // large implementation, compiled once\n}\n```\n\nThe public API accepts any `Write` implementor. Internally, we immediately convert to a trait object. `process_dyn` compiles only once. The cost is one virtual dispatch per method call within `process_dyn`, but the binary contains only one copy of the implementation.\n\n### Under the Hood\n\nConsider incrementing a counter through both dispatch strategies. Let's start with static dispatch:\n\n```rust\ntrait Counter {\n    fn increment(&mut self);\n}\n\nstruct Simple(u64);\nimpl Counter for Simple {\n    fn increment(&mut self) { self.0 += 1; }\n}\n\nfn inc_static\u003CT: Counter>(c: &mut T) {\n    c.increment();\n}\n```\n\nFor `inc_static::\u003CSimple>`, monomorphization produces:\n\n```asm\ninc_static_Simple:\n    add     qword ptr [rdi], 1\n    ret\n```\n\nThe entire method call is inlined to a single `add` instruction. The trait abstraction has zero runtime cost.\n\nNow consider dynamic dispatch:\n\n```rust\nfn inc_dynamic(c: &mut dyn Counter) {\n    c.increment();\n}\n```\n\nThe compiler generates:\n\n```asm\ninc_dynamic:\n    mov     rax, [rsi + 24]    ; load increment from vtable\n    mov     rdi, rdi           ; data pointer (already in rdi)\n    jmp     rax                ; tail call through vtable\n```\n\nThe function loads the method pointer from the vtable and jumps to it. The actual increment happens in the target function, which cannot be inlined here. For a single increment, the difference is trivial. In a tight loop incrementing millions of times, the static version avoids the vtable load and indirect branch on every iteration.\n\nThe static version also enables further optimization. If the compiler can prove the counter is never observed between increments, it can batch them. If the counter value is known, it can constant-fold. None of this is possible through the vtable indirection.\n\n## Closures and Captures\n\nWe have seen two strategies for polymorphism: monomorphization produces specialized code for each concrete type, while vtables enable a single function to operate on values of unknown type through indirect dispatch. Both mechanisms deal with *code* that varies. But what happens when we need a function that carries *state*?\n\nConsider a sorting function that accepts a comparison predicate. The predicate must know *how* to compare, which is pure code. But suppose we want to sort by distance from some reference point. Now the predicate needs access to the reference point's coordinates, data that exists outside the function itself. The predicate is no longer pure code; it is code plus environment.\n\nThis is the closure problem. A closure *closes over* variables from its enclosing scope, capturing them for later use. The three languages approach this problem with characteristic differences. C lacks closures entirely and requires manual workarounds. C++ introduced lambda expressions that desugar to anonymous structs with an overloaded call operator. Rust closures work similarly but integrate with the ownership system, with the `Fn`, `FnMut`, and `FnOnce` traits encoding how the closure interacts with its captured state.\n\n### C: Function Pointers and the Context Pattern\n\nC has function pointers, not closures. A function pointer is an address of executable code; it contains no data beyond the address itself.\n\n```c\nint compare_ints(const void *a, const void *b) {\n    return *(const int*)a - *(const int*)b;\n}\n\nqsort(array, n, sizeof(int), compare_ints);\n```\n\nThis works when comparison needs no external state. When it does, C libraries adopt a convention: pass a `void*` context alongside the function pointer, and the callback receives this context as an additional argument.\n\n```c\nstruct DistanceContext {\n    double ref_x, ref_y;\n};\n\nint compare_by_distance(const void *a, const void *b, void *ctx) {\n    const struct Point *pa = a;\n    const struct Point *pb = b;\n    const struct DistanceContext *c = ctx;\n    \n    double da = hypot(pa->x - c->ref_x, pa->y - c->ref_y);\n    double db = hypot(pb->x - c->ref_x, pb->y - c->ref_y);\n    return (da > db) - (da \u003C db);\n}\n\n// Usage requires a sorting function that accepts context\nstruct DistanceContext ctx = { .ref_x = 0.0, .ref_y = 0.0 };\nqsort_r(points, n, sizeof(struct Point), compare_by_distance, &ctx);\n```\n\nThe `qsort_r` variant (POSIX, not standard C) threads the context through to the comparator. The pattern is universal in C callback APIs: a function pointer paired with a `void*` that the library passes back untouched.\n\nThe problems are evident. The `void*` erases type information; nothing prevents us from passing a `DistanceContext*` to a callback expecting something else. The compiler cannot verify that the context pointer remains valid when the callback executes. If the callback outlives the context's stack frame, we have a dangling pointer. The burden falls entirely on us.\n\n### C++ Lambdas\n\nC++11 introduced lambda expressions, syntactic sugar for anonymous function objects. A lambda like\n\n```cpp\nauto ref_x = 0.0, ref_y = 0.0;\nauto compare = [ref_x, ref_y](const Point& a, const Point& b) {\n    double da = std::hypot(a.x - ref_x, a.y - ref_y);\n    double db = std::hypot(b.x - ref_x, b.y - ref_y);\n    return da \u003C db;\n};\n```\n\ndesugars to something equivalent to\n\n```cpp\nstruct __lambda_1 {\n    double ref_x;\n    double ref_y;\n    \n    bool operator()(const Point& a, const Point& b) const {\n        double da = std::hypot(a.x - ref_x, a.y - ref_y);\n        double db = std::hypot(b.x - ref_x, b.y - ref_y);\n        return da \u003C db;\n    }\n};\n\n__lambda_1 compare{ref_x, ref_y};\n```\n\nThe capture list specifies what enters the closure and how. `[x]` captures `x` by value (copies it into the struct). `[&x]` captures by reference (the struct holds a reference). `[=]` captures everything used by value. `[&]` captures everything by reference. `[x, &y]` mixes modes.\n\nEach lambda has a unique anonymous type that the programmer cannot name. We must use `auto` for local variables or templates for function parameters:\n\n```cpp\ntemplate\u003Ctypename F>\nvoid use_callback(F&& f) {\n    f();\n}\n```\n\nAlternatively, `std::function\u003CR(Args...)>` provides type erasure, wrapping any callable with a matching signature into a uniform type at the cost of heap allocation and virtual dispatch.\n\nThe capture mode determines the closure's size. A lambda capturing two `double`s by value occupies 16 bytes (plus alignment). A lambda capturing by reference stores pointers, 8 bytes each on x86-64. A lambda capturing nothing is stateless; the standard guarantees that captureless lambdas can convert to plain function pointers:\n\n```cpp\nint (*fp)(int, int) = [](int a, int b) { return a + b; };\n```\n\nC++ lambdas are mutable by default if they capture by value with `mutable`:\n\n```cpp\nint counter = 0;\nauto increment = [counter]() mutable { return ++counter; };\n// Each call modifies the lambda's internal copy of counter\n```\n\nWithout `mutable`, the call operator is `const` and cannot modify captured values. The default reflects the common case where closures are passed to algorithms and called multiple times; mutating captured state would be surprising.\n\n### Rust Closures\n\nRust closures follow the same structural principle: a closure is an anonymous struct containing captured values, with a method implementing the call. But the details differ in ways that matter for safety.\n\n```rust\nlet ref_x = 0.0_f64;\nlet ref_y = 0.0_f64;\nlet compare = |a: &Point, b: &Point| {\n    let da = ((a.x - ref_x).powi(2) + (a.y - ref_y).powi(2)).sqrt();\n    let db = ((b.x - ref_x).powi(2) + (b.y - ref_y).powi(2)).sqrt();\n    da.partial_cmp(&db).unwrap()\n};\n```\n\nThe compiler generates a struct like\n\n```rust\nstruct __closure_1\u003C'a> {\n    ref_x: &'a f64,\n    ref_y: &'a f64,\n}\n\nimpl\u003C'a> FnOnce\u003C(&Point, &Point)> for __closure_1\u003C'a> {\n    type Output = std::cmp::Ordering;\n    extern \"rust-call\" fn call_once(self, args: (&Point, &Point)) -> Self::Output {\n        let (a, b) = args;\n        let da = ((a.x - *self.ref_x).powi(2) + (a.y - *self.ref_y).powi(2)).sqrt();\n        let db = ((b.x - *self.ref_x).powi(2) + (b.y - *self.ref_y).powi(2)).sqrt();\n        da.partial_cmp(&db).unwrap()\n    }\n}\n\nimpl\u003C'a> FnMut\u003C(&Point, &Point)> for __closure_1\u003C'a> {\n    extern \"rust-call\" fn call_mut(&mut self, args: (&Point, &Point)) -> Self::Output {\n        self.call_once(args)\n    }\n}\n\nimpl\u003C'a> Fn\u003C(&Point, &Point)> for __closure_1\u003C'a> {\n    extern \"rust-call\" fn call(&self, args: (&Point, &Point)) -> Self::Output {\n        self.call_once(args)\n    }\n}\n```\n\nUnlike C++, Rust does not require explicit capture annotations. The compiler infers the capture mode from how variables are used in the closure body. If we only read a variable, it captures by shared reference. If we mutate it, it captures by mutable reference. If we move out of it or if the variable does not implement `Copy`, it captures by value.\n\n```rust\nlet s = String::from(\"hello\");\n\n// Captures s by shared reference (only reads)\nlet c1 = || println!(\"{}\", s);\n\n// Captures s by mutable reference (mutates)\nlet mut s = String::from(\"hello\");\nlet c2 = || s.push_str(\" world\");\n\n// Captures s by value (moves out)\nlet s = String::from(\"hello\");\nlet c3 = || drop(s);\n```\n\nThe `move` keyword overrides inference, forcing all captures to be by value:\n\n```rust\nlet s = String::from(\"hello\");\nlet c = move || println!(\"{}\", s);\n// s is no longer accessible here; it was moved into the closure\n```\n\nThis is essential when the closure must outlive the scope where it was created, as when spawning a thread:\n\n```rust\nlet data = vec![1, 2, 3];\nstd::thread::spawn(move || {\n    // data is owned by this closure, transferred to the new thread\n    println!(\"{:?}\", data);\n});\n```\n\nWithout `move`, the closure would capture `data` by reference. But `data` lives on the spawning thread's stack, which may be deallocated before the spawned thread runs. The compiler rejects this:\n\n```rust\nlet data = vec![1, 2, 3];\nstd::thread::spawn(|| {\n    println!(\"{:?}\", data);  // ERROR: closure may outlive borrowed value\n});\n```\n\nThe `move` keyword forces ownership transfer, ensuring the closure owns `data` and can safely take it to another thread.\n\n### The Fn Trait Hierarchy\n\nThe three traits `Fn`, `FnMut`, and `FnOnce` form a hierarchy that describes how a closure can be called, not how it captures.\n\n`FnOnce` requires ownership of the closure to call it. The method signature is `fn call_once(self, args: Args) -> Output`. After calling a `FnOnce`, the closure is consumed. Every closure implements `FnOnce` because every closure can be called at least once.\n\n`FnMut` requires mutable access to the closure. The signature is `fn call_mut(&mut self, args: Args) -> Output`. A closure implements `FnMut` if calling it does not require consuming any captured values. It may mutate its captures, but it does not move out of them.\n\n`Fn` requires only shared access. The signature is `fn call(&self, args: Args) -> Output`. A closure implements `Fn` if calling it neither consumes nor mutates any captured values.\n\nThe hierarchy is `Fn: FnMut: FnOnce`. A closure implementing `Fn` automatically implements `FnMut` and `FnOnce`. The traits encode *what the closure does when called*, not *how it captured* its environment.\n\nThis can be tricky if we think in terms of C++ lambdas. For example, a `move` closure can still implement `Fn`:\n\n```rust\nlet x = 42;\nlet c = move || x;  // captures x by value (copies, since i32: Copy)\n// c implements Fn because calling it only reads the captured x\n```\n\nConversely, a closure that captures by reference but mutates the referent implements only `FnMut`:\n\n```rust\nlet mut counter = 0;\nlet mut increment = || { counter += 1; };\n// increment implements FnMut (mutates through captured &mut)\n// does NOT implement Fn\n```\n\nAnd a closure that moves out of a captured value implements only `FnOnce`:\n\n```rust\nlet s = String::from(\"hello\");\nlet consume = move || drop(s);\n// consume implements FnOnce only (consumes captured s)\n// does NOT implement FnMut or Fn\n```\n\nFunctions accepting closures declare which trait they require. `Iterator::for_each` takes `FnMut` because it calls the closure multiple times but does not need concurrent shared access. `Iterator::map` takes `FnMut` for the same reason. `thread::spawn` takes `FnOnce` because the closure runs exactly once in the spawned thread.\n\n```rust\nfn call_twice\u003CF: FnMut()>(mut f: F) {\n    f();\n    f();\n}\n\nfn call_once\u003CF: FnOnce()>(f: F) {\n    f();\n}\n```\n\n### Closure Traits and Send/Sync\n\nClosures inherit `Send` and `Sync` from their captures. If all captured values are `Send`, the closure is `Send`. If all values captured by shared reference are `Sync`, and all values captured by mutable reference, copy, or move are `Send`, then the closure is `Send`. These rules match normal struct composition.\n\n```rust\nuse std::rc::Rc;\n\nlet rc = Rc::new(42);\nlet closure = move || println!(\"{}\", rc);\n// closure is NOT Send because Rc is not Send\n// std::thread::spawn(closure);  // ERROR\n```\n\n```rust\nuse std::sync::Arc;\n\nlet arc = Arc::new(42);\nlet closure = move || println!(\"{}\", arc);\n// closure IS Send because Arc is Send\nstd::thread::spawn(closure);  // OK\n```\n\nA closure is `Clone` or `Copy` if it does not capture by mutable reference and all its captures are `Clone` or `Copy`:\n\n```rust\nlet x = 42;\nlet closure = move || x;\n// closure is Copy because it captures only Copy types by value\n\nlet y = closure;  // copy\nlet z = closure;  // still valid\n```\n\nThese automatic trait derivations mean closures integrate with Rust's concurrency primitives without special handling. A `move` closure capturing `Arc\u003CMutex\u003CT>>` is `Send`, can be shipped to another thread, and provides safe interior mutability through the mutex. The type system composes.","src/data/blog/memory-pt3.md","42ffd139e3518300",{"html":926,"metadata":927},"\u003Cp>This is the third part of a series exploring how C, C++, and Rust manage memory at a low level. In \u003Ca href=\"https://lukefleed.xyz/posts/who-owns-the-memory-pt1/\">Part I\u003C/a> we examined how memory is organized at the hardware level. \u003Ca href=\"https://lukefleed.xyz/posts/who-owns-the-memory-pt2/\">Part II\u003C/a> explored ownership and lifetime, showing how the three languages answer the question of who is responsible for freeing memory and when access to that memory is valid.\u003C/p>\n\u003Cp>Part III turns to \u003Cem>representation\u003C/em>: how abstract types become concrete bit patterns, and how polymorphism, the ability to write code that operates on many types, is implemented.\u003C/p>\n\u003Ch2 id=\"table-of-contents\">Table of Contents\u003C/h2>\n\u003Cp>\u003C/p>\u003Cdetails>\u003Csummary>Open Table of Contents\u003C/summary>\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#type-layout-and-memory-representation\">Type Layout and Memory Representation\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-c-layout-algorithm\">The C Layout Algorithm\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#reprrust-the-compilers-prerogative\">repr(Rust): The Compilerâ€™s Prerogative\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#reprc-predictable-layout-for-ffi\">repr(C): Predictable Layout for FFI\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#primitive-representations-for-enums\">Primitive Representations for Enums\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#reprpacked-eliminating-padding\">repr(packed): Eliminating Padding\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#repralign-preventing-false-sharing\">repr(align): Preventing False Sharing\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#reprtransparent-zero-cost-wrappers\">repr(transparent): Zero-Cost Wrappers\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#zero-sized-types\">Zero-Sized Types\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#empty-types\">Empty Types\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#niche-optimization\">Niche Optimization\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#visualizing-layouts\">Visualizing Layouts\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#fat-pointers-and-dynamically-sized-types\">Fat Pointers and Dynamically Sized Types\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#the-problem-with-c-arrays\">The Problem with C Arrays\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#dynamically-sized-types-in-rust\">Dynamically Sized Types in Rust\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#wide-pointers\">Wide Pointers\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#trait-object-representation\">Trait Object Representation\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#virtual-dispatch-in-assembly\">Virtual Dispatch in Assembly\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#performance-implications-of-dynamic-dispatch\">Performance Implications of Dynamic Dispatch\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-vtable-location-trade-off\">The Vtable Location Trade-off\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#dyn-compatibility\">Dyn Compatibility\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#auto-traits-and-lifetime-bounds\">Auto Traits and Lifetime Bounds\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#supertraits-in-the-vtable\">Supertraits in the Vtable\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-sized-bound\">The ?Sized Bound\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#custom-dsts\">Custom DSTs\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#invalid-metadata-is-undefined-behavior\">Invalid Metadata is Undefined Behavior\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#polymorphism-monomorphization-vs-vtables\">Polymorphism: Monomorphization vs Vtables\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#c-without-generics\">C Without Generics\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-templates\">C++ Templates\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-virtual-functions\">C++ Virtual Functions\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-generics\">Rust Generics\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-trait-objects\">Rust Trait Objects\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#choosing-between-strategies\">Choosing Between Strategies\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#under-the-hood\">Under the Hood\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Ca href=\"#closures-and-captures\">Closures and Captures\u003C/a>\n\u003Cul>\n\u003Cli>\u003Ca href=\"#c-function-pointers-and-the-context-pattern\">C: Function Pointers and the Context Pattern\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#c-lambdas\">C++ Lambdas\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#rust-closures\">Rust Closures\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#the-fn-trait-hierarchy\">The Fn Trait Hierarchy\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"#closure-traits-and-sendsync\">Closure Traits and Send/Sync\u003C/a>\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\u003C/details>\u003Cp>\u003C/p>\n\u003Ch2 id=\"type-layout-and-memory-representation\">Type Layout and Memory Representation\u003C/h2>\n\u003Cp>In Part I we established that every type has a size and an alignment, and that compilers insert padding to satisfy alignment constraints. We showed how a poorly ordered struct in C could waste 8 bytes of padding where a well-ordered one used only 2. But we sidestepped a question: who decides the order?\u003C/p>\n\u003Cp>In C and C++, the answer is straightforward: we do. The compiler lays out fields in declaration order, inserting padding as the alignment algorithm dictates. This predictability is essential for binary compatibility, memory-mapped I/O, and network protocols where byte offsets must match external specifications. It is also a constraint: the programmer bears responsibility for field ordering, and a careless declaration can bloat a frequently-allocated struct.\u003C/p>\n\u003Cp>Rust makes a different choice. By default, the compiler reserves the right to reorder fields.\u003C/p>\n\u003Ch3 id=\"the-c-layout-algorithm\">The C Layout Algorithm\u003C/h3>\n\u003Cp>C specifies a deterministic algorithm for struct layout. Start with a current offset of zero. For each field in declaration order: add padding until the offset is a multiple of the fieldâ€™s alignment, record the fieldâ€™s offset, advance by the fieldâ€™s size. Finally, round the structâ€™s total size up to its alignment.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Example {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">      // offset 0, size 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 7 bytes padding (align to 8 for double)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // offset 8, size 8\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    char\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> c;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">      // offset 16, size 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // 7 bytes padding (struct size must be multiple of 8)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// sizeof(struct Example) == 24\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The algorithm is mechanical. Given field types and their order, the layout is fully determined. This property is what makes C the lingua franca of FFI: any language that implements the same algorithm can share data structures with C code.\u003C/p>\n\u003Cp>C++ inherits this layout for standard-layout types. The Itanium ABI, which governs most non-Windows C++ implementations, extends the algorithm to handle base classes, virtual functions, and virtual inheritance. For our purposes, a C++ struct without inheritance, virtual functions, or access specifiers mixing fields follows the same layout as C.\u003C/p>\n\u003Cp>The \u003Ccode>[[no_unique_address]]\u003C/code> attribute (C++20) allows the compiler to overlap a data member with another if the member has no members of its own. This enables empty base optimization for member objects:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Empty\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> WithoutAttribute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    Empty e;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// sizeof(WithoutAttribute) == 8 on typical platforms\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// (Empty requires 1 byte in C++, padded to 4 for int alignment)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> WithAttribute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#D6DEEB\">    [[no_unique_address]]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Empty e;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// sizeof(WithAttribute) == 4\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Without the attribute, \u003Ccode>Empty\u003C/code> occupies one byte (C++ mandates that different objects have different addresses, so even empty classes have nonzero size). With the attribute, \u003Ccode>e\u003C/code> can share storage with padding or with \u003Ccode>x\u003C/code> itself, reducing the struct to just \u003Ccode>sizeof(int)\u003C/code>.\u003C/p>\n\u003Ch3 id=\"reprrust-the-compilers-prerogative\">repr(Rust): The Compilerâ€™s Prerogative\u003C/h3>\n\u003Cp>Rustâ€™s default representation, \u003Ccode>repr(Rust)\u003C/code>, makes minimal guarantees. The specification states only:\u003C/p>\n\u003Col>\n\u003Cli>Fields are properly aligned.\u003C/li>\n\u003Cli>Fields do not overlap (except for ZSTs, which may share addresses).\u003C/li>\n\u003Cli>The structâ€™s alignment is at least the maximum alignment of its fields.\u003C/li>\n\u003C/ol>\n\u003Cp>There is no guarantee about field order. The compiler may reorder fields to minimize padding, and different compilations of the same source may produce different layouts. The same generic struct instantiated with different type parameters may have different field orderings.\u003C/p>\n\u003Cp>Consider:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Foo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">U\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    count\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    data1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    data2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> U\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For \u003Ccode>Foo&#x3C;u32, u16>\u003C/code>, an efficient layout places \u003Ccode>count\u003C/code> and \u003Ccode>data2\u003C/code> (both 2 bytes) adjacent, followed by \u003Ccode>data1\u003C/code> (4 bytes):\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Possible layout of Foo&#x3C;u32, u16>: size 8, align 4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// count:  offset 0, size 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// data2:  offset 2, size 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// data1:  offset 4, size 4\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For \u003Ccode>Foo&#x3C;u16, u32>\u003C/code>, the same reordering achieves the same efficiency:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Possible layout of Foo&#x3C;u16, u32>: size 8, align 4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// count:  offset 0, size 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// data1:  offset 2, size 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// data2:  offset 4, size 4\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If Rust preserved declaration order, \u003Ccode>Foo&#x3C;u32, u16>\u003C/code> would require padding after \u003Ccode>count\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Declaration-order layout of Foo&#x3C;u32, u16>: size 12, align 4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// count:  offset 0, size 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// _pad:   offset 2, size 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// data1:  offset 4, size 4\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// data2:  offset 8, size 2\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// _pad:   offset 10, size 2\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The reordering saves 4 bytes per instance without any annotation or programmer attention.\u003C/p>\n\u003Cp>The trade-off is unpredictability. We cannot assume field offsets. We cannot cast a \u003Ccode>*const Foo&#x3C;A, B>\u003C/code> to a byte pointer and read at a known offset to extract a field. We cannot send a \u003Ccode>repr(Rust)\u003C/code> struct across a network or write it to a file and expect another compilation (or even the same compilation with different flags) to interpret it correctly.\u003C/p>\n\u003Ch3 id=\"reprc-predictable-layout-for-ffi\">repr(C): Predictable Layout for FFI\u003C/h3>\n\u003Cp>When we need C-compatible layout, we annotate the type with \u003Ccode>#[repr(C)]\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> ThreeInts\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    first\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    second\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    third\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With \u003Ccode>repr(C)\u003C/code>, Rust applies the C layout algorithm. Fields appear in declaration order. Padding follows the standard rules. The resulting layout is compatible with a C struct declared with the same field types and order:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ThreeInts {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int16_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> first;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int8_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> second;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int32_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> third;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>repr(C)\u003C/code> is necessary for FFI correctness. It is also useful when we need stable layout for unsafe code that relies on field offsets, or when serializing data to a known binary format. The trade-off is that we accept whatever padding the declaration order implies.\u003C/p>\n\u003Cp>For enums, \u003Ccode>repr(C)\u003C/code> produces a layout compatible with C unions plus a tag. The exact representation depends on whether the enum has fields:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyEnum\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    A\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    D\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is laid out as a \u003Ccode>repr(C)\u003C/code> union of \u003Ccode>repr(C)\u003C/code> structs, where each struct begins with a discriminant of the platformâ€™s C \u003Ccode>int\u003C/code> size:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Equivalent repr(C) layout:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">union\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyEnumRepr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyVariantA\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyVariantB\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyVariantC\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    d\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyVariantD\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyVariantA\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">tag\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyVariantB\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">tag\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_pad\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">_pad2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ... and so on\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The discriminant size for a fieldless \u003Ccode>repr(C)\u003C/code> enum matches the C ABIâ€™s enum size, which is implementation-defined. On most platforms, this is \u003Ccode>int\u003C/code> (4 bytes), though some ABIs use smaller types for small enums.\u003C/p>\n\u003Ch3 id=\"primitive-representations-for-enums\">Primitive Representations for Enums\u003C/h3>\n\u003Cp>When we need precise control over the discriminant, we can specify an integer type:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Opcode\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Nop\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Load\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Store\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // ... up to 255 variants\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This enum occupies exactly 1 byte. The discriminant is stored as a \u003Ccode>u8\u003C/code>. This is essential for binary protocols where the tag must fit a specific field width.\u003C/p>\n\u003Cp>For enums with fields, \u003Ccode>repr(u8)\u003C/code> or similar sets the discriminant size but still uses C-style layout for the variant data:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Packet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    Ping\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">([\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// size: 72 bytes (1 byte tag + 7 padding + 64 data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The discriminant is guaranteed to be 1 byte\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Combining \u003Ccode>repr(C)\u003C/code> and a primitive representation, like \u003Ccode>#[repr(C, u8)]\u003C/code>, specifies both C layout and a specific discriminant type.\u003C/p>\n\u003Cp>Adding an explicit \u003Ccode>repr\u003C/code> to an enum with fields has a consequence that surprises many: it \u003Cem>suppresses niche optimization\u003C/em>. We have not yet explained what niche optimization is, so this statement may seem cryptic. We will return to it after discussing zero-sized types, where the concept will make more sense.\u003C/p>\n\u003Ch3 id=\"reprpacked-eliminating-padding\">repr(packed): Eliminating Padding\u003C/h3>\n\u003Cp>Sometimes we need minimum size regardless of alignment. Network packet headers, binary file formats, and memory-mapped hardware registers often require tightly packed data. \u003Ccode>repr(packed)\u003C/code> removes inter-field padding:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(packed)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PackedExample\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// size: 6 bytes (1 + 4 + 1), no padding\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// alignment: 1 byte\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Compare with the default layout, which would require 12 bytes (1 + 3 padding + 4 + 1 + 3 padding). The packed version is half the size.\u003C/p>\n\u003Cp>The penalty is that fields may be misaligned. On x86-64, misaligned loads incur a performance penalty. On stricter architectures like ARM without unaligned access support or older SPARC, they cause hardware exceptions. Even on tolerant architectures, misaligned atomics are often incorrect.\u003C/p>\n\u003Cp>Rust addresses part of this problem by making it \u003Cem>illegal to create a reference to a misaligned field\u003C/em>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(packed)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Packed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// may be at offset 1, misaligned\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> p\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Packed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">p\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">b;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ERROR: reference to packed field\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler rejects this because a \u003Ccode>&#x26;u32\u003C/code> must point to a 4-byte-aligned address, but \u003Ccode>p.b\u003C/code> may not be. The workaround is to copy the value first:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> p\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">b;         \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// copies the unaligned bytes into a local\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;    \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// value is properly aligned on the stack\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Or use raw pointer operations with explicit unaligned reads:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">addr_of!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">p\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">b);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> value\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">read_unaligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() };\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>repr(packed(n))\u003C/code> generalizes this by setting the maximum field alignment to \u003Ccode>n\u003C/code>. Fields with natural alignment less than \u003Ccode>n\u003C/code> are laid out normally; fields with natural alignment greater than \u003Ccode>n\u003C/code> are treated as if their alignment were \u003Ccode>n\u003C/code>. This allows partial packing, trading some space for better access patterns.\u003C/p>\n\u003Cp>For FFI work, combining \u003Ccode>repr(C, packed)\u003C/code> gives C-compatible layout with minimal size. This matches \u003Ccode>#pragma pack(1)\u003C/code> in many C compilers.\u003C/p>\n\u003Ch3 id=\"repralign-preventing-false-sharing\">repr(align): Preventing False Sharing\u003C/h3>\n\u003Cp>While \u003Ccode>repr(packed)\u003C/code> reduces alignment, \u003Ccode>repr(align(n))\u003C/code> increases it. The attribute forces the type to have alignment of at least \u003Ccode>n\u003C/code> bytes, where \u003Ccode>n\u003C/code> must be a power of two.\u003C/p>\n\u003Cp>Why would we want \u003Cem>more\u003C/em> alignment than necessary? The answer lies in cache architecture. On x86-64, the L1 cache operates on 64-byte cache lines. When one core writes to an address, the entire cache line containing that address is invalidated in all other coresâ€™ caches. This is the MESI protocol (or variants like MESIF, MOESI) maintaining coherence.\u003C/p>\n\u003Cp>Consider two atomic counters that different threads increment concurrently:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">sync\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">atomic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">AtomicU64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Counters\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AtomicU64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// offset 0, 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AtomicU64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// offset 8, 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Both counters fit in a single 64-byte cache line. When thread 1 increments \u003Ccode>a\u003C/code>, it invalidates thread 2â€™s cache line. When thread 2 increments \u003Ccode>b\u003C/code>, it invalidates thread 1â€™s cache line. Neither thread is accessing the otherâ€™s data, yet they are constantly invalidating each otherâ€™s caches. This is \u003Cem>false sharing\u003C/em>, and it can degrade performance by an order of magnitude on contended workloads.\u003C/p>\n\u003Cp>The fix is to ensure each counter occupies its own cache line:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">sync\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">atomic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">{\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">AtomicU64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(align(64))]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> CacheAligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">AtomicU64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Counters\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> CacheAligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// offset 0, padded to 64 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> CacheAligned\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// offset 64, padded to 64 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now \u003Ccode>sizeof::&#x3C;Counters>()\u003C/code> is 128 bytes instead of 16, but \u003Ccode>a\u003C/code> and \u003Ccode>b\u003C/code> cannot share a cache line. Each threadâ€™s writes affect only its own cache line, and the coherence protocol stops bouncing the line between cores.\u003C/p>\n\u003Cp>The trade-off is memory consumption. Padding a 8-byte counter to 64 bytes is an 8x increase. For a handful of hot counters in a concurrent data structure, this is negligible. For an array of thousands of counters, it becomes prohibitive. The choice depends on access patterns: if threads access disjoint counters, alignment helps. If threads frequently access the same counter, the contention is real, not false, and alignment does nothing.\u003C/p>\n\u003Cp>\u003Ccode>repr(align)\u003C/code> can combine with other representations. \u003Ccode>#[repr(C, align(64))]\u003C/code> gives C-compatible field ordering with cache-line alignment. The align modifier applies to the struct as a whole, not to individual fields, so all fields remain at their natural offsets within the enlarged, aligned struct.\u003C/p>\n\u003Ch3 id=\"reprtransparent-zero-cost-wrappers\">repr(transparent): Zero-Cost Wrappers\u003C/h3>\n\u003Cp>Sometimes we want a new type that has identical layout to an existing type. The newtype pattern wraps a single field:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Meters\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Seconds\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With \u003Ccode>repr(Rust)\u003C/code>, these types are not guaranteed to have the same layout or ABI as \u003Ccode>f64\u003C/code>. A function returning \u003Ccode>Meters\u003C/code> might use different registers than a function returning \u003Ccode>f64\u003C/code>, even though the underlying data is identical.\u003C/p>\n\u003Cp>\u003Ccode>repr(transparent)\u003C/code> guarantees layout and ABI identity:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(transparent)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Meters\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(transparent)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Seconds\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now \u003Ccode>Meters\u003C/code> has exactly the same size, alignment, and function-call ABI as \u003Ccode>f64\u003C/code>. We can pass a \u003Ccode>Meters\u003C/code> where C expects a \u003Ccode>double\u003C/code>. We can transmute between \u003Ccode>Meters\u003C/code> and \u003Ccode>f64\u003C/code> (in either direction) without undefined behavior.\u003C/p>\n\u003Cp>\u003Ccode>repr(transparent)\u003C/code> requires that the type has exactly one field with non-zero size, and may have any number of zero-sized fields with alignment 1 (like \u003Ccode>PhantomData&#x3C;T>\u003C/code>).\u003C/p>\n\u003Cp>This enables patterns like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">marker\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">PhantomData\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(transparent)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Id\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">PhantomData\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>Id&#x3C;User>\u003C/code> and \u003Ccode>Id&#x3C;Post>\u003C/code> are distinct types at compile time but have identical layout to \u003Ccode>u64\u003C/code>. The \u003Ccode>PhantomData\u003C/code> participates in the type system (for variance and drop checking) but not in the layout.\u003C/p>\n\u003Ch3 id=\"zero-sized-types\">Zero-Sized Types\u003C/h3>\n\u003Cp>Rust permits types with size zero:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Nothing\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// no fields\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AlsoNothing\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { }    \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// empty struct\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MoreNothing\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(());   \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// contains unit type\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AndNothing\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">([\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]); \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// zero-length array\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>All of these have size 0 and alignment 1 (the minimum). They occupy no memory. An array \u003Ccode>[Nothing; 1000000]\u003C/code> has size 0.\u003C/p>\n\u003Cp>ZSTs become useful in generic contexts. A \u003Ccode>HashMap&#x3C;K, V>\u003C/code> stores keys and values. What if we only care about keys? We could duplicate the code as \u003Ccode>HashSet&#x3C;K>\u003C/code>, or we could define:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">type\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> HashSet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">K\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> HashMap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">K\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, ()>;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Because \u003Ccode>()\u003C/code> is a ZST, \u003Ccode>HashMap&#x3C;K, ()>\u003C/code> stores no value data. The compiler eliminates loads, stores, and allocations for the values. We get a set implementation from a map implementation with no runtime overhead.\u003C/p>\n\u003Cp>The standard libraryâ€™s \u003Ccode>HashSet\u003C/code> is implemented exactly this way:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> HashSet\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">S\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    map\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> HashMap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, (), \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">S\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Unsafe code must be careful with ZSTs. Pointer arithmetic on \u003Ccode>*const T\u003C/code> where \u003Ccode>T\u003C/code> is zero-sized is a no-op: \u003Ccode>ptr.add(1)\u003C/code> returns \u003Ccode>ptr\u003C/code> unchanged. This breaks the assumption that advancing a pointer produces a different address. Additionally, most allocators do not accept zero-size requests, so \u003Ccode>Box::new(ZST)\u003C/code> uses special handling rather than calling the allocator.\u003C/p>\n\u003Cp>One subtle property: references to ZSTs must be non-null and properly aligned (alignment 1 means any address is valid), but dereferencing them is defined to read zero bytes. A reference to a ZST at address 0x1 is valid; a reference at address 0 (null) is undefined behavior even though no actual memory access occurs.\u003C/p>\n\u003Ch3 id=\"empty-types\">Empty Types\u003C/h3>\n\u003Cp>Zero-sized types can be instantiated. We can create a value of type \u003Ccode>()\u003C/code> or \u003Ccode>struct Nothing;\u003C/code> and pass it around. Empty types go further: they cannot be instantiated at all.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>An enum with no variants has no valid values. We cannot construct a \u003Ccode>Void\u003C/code> because there is no variant to construct. The type exists at the type level but can never exist at the value level.\u003C/p>\n\u003Cp>This enables type-level reasoning about impossibility. Consider a trait for data sources that might fail:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> DataSource\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    type\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Error\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Most implementations have a meaningful error type: network sources fail with I/O errors, parsers fail with syntax errors. But some sources are infallible. An in-memory cache cannot fail to read its own contents:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Infallible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemoryCache\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> DataSource\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MemoryCache\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    type\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Error\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Infallible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> fetch\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Infallible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">clone\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>Error = Infallible\u003C/code> communicates at the type level that \u003Ccode>fetch\u003C/code> cannot return \u003Ccode>Err\u003C/code>. Callers can use an irrefutable pattern:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> use_cache\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">cache\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MemoryCache\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> cache\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">fetch\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// no Err case to handle\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler optimizes based on this knowledge. \u003Ccode>Result&#x3C;T, Infallible>\u003C/code> has the same layout as \u003Ccode>T\u003C/code> because the \u003Ccode>Err\u003C/code> variant cannot exist and requires no discriminant:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">convert\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Infallible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Infallible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// same as u64\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The standard library provides \u003Ccode>std::convert::Infallible\u003C/code> for this purpose. It is defined as an empty enum and used throughout the standard library to indicate operations that cannot fail.\u003C/p>\n\u003Cp>Raw pointers to empty types are valid to construct but dereferencing them is undefined behavior. There is no value to read, so the dereference cannot produce a valid result. This makes empty types unsuitable for representing Câ€™s \u003Ccode>void*\u003C/code>. The recommended approach for opaque C pointers is \u003Ccode>*const ()\u003C/code> or a newtype wrapper around it, which can be safely dereferenced to read zero bytes.\u003C/p>\n\u003Ch3 id=\"niche-optimization\">Niche Optimization\u003C/h3>\n\u003Cp>An enum must somehow record which variant it currently holds. The naive approach stores a \u003Cem>discriminant\u003C/em>, a small integer that identifies the variant, alongside the variantâ€™s data. For an enum with four variants, we need at least 2 bits to distinguish them; in practice, the discriminant occupies 1, 2, or 4 bytes depending on the number of variants and alignment constraints.\u003C/p>\n\u003Cp>Consider \u003Ccode>Option&#x3C;T>\u003C/code>, which has two variants: \u003Ccode>Some(T)\u003C/code> and \u003Ccode>None\u003C/code>. The naive layout stores a discriminant plus the \u003Ccode>T\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Naive Option&#x3C;u64> layout:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// discriminant: 1 byte (0 = None, 1 = Some)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// padding: 7 bytes (to align u64)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// value: 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// total: 16 bytes\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is wasteful when \u003Ccode>T\u003C/code> is something like \u003Ccode>&#x26;u64\u003C/code>. A reference is 8 bytes, so \u003Ccode>Option&#x3C;&#x26;u64>\u003C/code> would be 16 bytes: 8 for the pointer, plus padding and discriminant overhead. But here is the insight that enables optimization: \u003Cem>a reference can never be null\u003C/em>. Rust guarantees that \u003Ccode>&#x26;T\u003C/code> always points to a valid \u003Ccode>T\u003C/code>. The bit pattern consisting of all zeros, the null pointer, can never represent a valid reference.\u003C/p>\n\u003Cp>The compiler exploits this. For \u003Ccode>Option&#x3C;&#x26;T>\u003C/code>, there is no separate discriminant. The \u003Ccode>Some\u003C/code> variant stores the pointer as-is. The \u003Ccode>None\u003C/code> variant is represented by the null pointer. Pattern matching becomes a null check:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Actual Option&#x3C;&#x26;u64> layout:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// pointer: 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// total: 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// None is represented as null (0x0000000000000000)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Some(&#x26;x) is represented as the address of x\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is called \u003Cem>niche optimization\u003C/em>. A \u003Cem>niche\u003C/em> is a bit pattern that a type guarantees it will never hold. The compiler uses niches to encode enum discriminants without allocating additional space.\u003C/p>\n\u003Cp>Which types have niches? Any type that forbids certain bit patterns:\u003C/p>\n\u003Cp>References (\u003Ccode>&#x26;T\u003C/code>, \u003Ccode>&#x26;mut T\u003C/code>) forbid null. \u003Ccode>NonNull&#x3C;T>\u003C/code> exists specifically to be a non-null pointer. The \u003Ccode>NonZeroU32\u003C/code> type (and its siblings \u003Ccode>NonZeroU8\u003C/code>, \u003Ccode>NonZeroI64\u003C/code>, etc.) forbid zero. \u003Ccode>Box&#x3C;T>\u003C/code> contains a non-null pointer internally. Function pointers forbid null. \u003Ccode>bool\u003C/code> only permits 0 and 1, so 254 other byte values are niches.\u003C/p>\n\u003Cp>The optimization composes. \u003Ccode>Option&#x3C;Box&#x3C;T>>\u003C/code> uses null for \u003Ccode>None\u003C/code>. What about \u003Ccode>Option&#x3C;Option&#x3C;Box&#x3C;T>>>\u003C/code>? The outer \u003Ccode>Option\u003C/code> needs a niche to represent its \u003Ccode>None\u003C/code>, and the inner \u003Ccode>Option\u003C/code> already used null for \u003Cem>its\u003C/em> \u003Ccode>None\u003C/code>. Can we distinguish outer-\u003Ccode>None\u003C/code> from \u003Ccode>Some(None)\u003C/code>?\u003C/p>\n\u003Cp>On x86-64 with 48-bit virtual addresses, pointers have constraints beyond non-nullness. The upper 16 bits must be a sign extension of bit 47. Most user-space pointers have the top bits all zeros (canonical lower-half addresses). The compiler can use a non-canonical address like \u003Ccode>0x0000000000000001\u003C/code> (misaligned for any type with alignment > 1) to represent additional \u003Ccode>None\u003C/code> variants:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>>>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>All three types fit in 8 bytes. The compiler found two niches in the pointer: null for the inner \u003Ccode>None\u003C/code>, and another invalid address for the outer \u003Ccode>None\u003C/code>.\u003C/p>\n\u003Cp>For types without niches, the discriminant requires additional space:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Option\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Every bit pattern is a valid \u003Ccode>u64\u003C/code>, so there is no niche. The compiler must store a separate discriminant, and alignment padding expands the total to 16 bytes.\u003C/p>\n\u003Cp>Now we can return to the point we deferred earlier: why does \u003Ccode>#[repr(u8)]\u003C/code> on an enum suppress niche optimization? The \u003Ccode>repr(u8)\u003C/code> attribute guarantees that the discriminant is stored as an explicit \u003Ccode>u8\u003C/code> at a known location. This is a layout guarantee for FFI and binary serialization. If the compiler used niche optimization, there would be no explicit discriminant byte; the variant would be encoded in the payloadâ€™s bit pattern. These two requirements are incompatible. Explicit discriminant layout and niche optimization are mutually exclusive:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> WithNiche\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>), \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">#[repr(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> WithoutNiche\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Some\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Box\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>), \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">None\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">WithNiche\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// niche used, no discriminant\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">WithoutNiche\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// explicit u8 discriminant + padding + pointer\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>repr(u8)\u003C/code> forces a 1-byte discriminant to exist, which with 7 bytes of padding and the 8-byte pointer yields 16 bytes total.\u003C/p>\n\u003Ch3 id=\"visualizing-layouts\">Visualizing Layouts\u003C/h3>\n\u003Cp>Rust provides \u003Ccode>std::mem::size_of::&#x3C;T>()\u003C/code> and \u003Ccode>std::mem::align_of::&#x3C;T>()\u003C/code> for inspecting type properties at runtime (they are const functions, so compile-time evaluation is also possible). For detailed layout information, the \u003Ccode>-Zprint-type-sizes\u003C/code> flag on nightly rustc shows field ordering, padding, and discriminant placement:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>RUSTFLAGS=-Zprint-type-sizes cargo +nightly build --release\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For an enum like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> E\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">    A\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    B\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    C\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    D\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The output shows:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>print-type-size type: `E`: 32 bytes, alignment: 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size     discriminant: 1 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size     variant `D`: 31 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size         padding: 7 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size         field `.0`: 24 bytes, alignment: 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size     variant `C`: 23 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size         field `.1`: 1 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size         field `.3`: 1 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size         padding: 5 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size         field `.0`: 8 bytes, alignment: 8 bytes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>print-type-size         field `.2`: 8 bytes\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler has reordered variant \u003Ccode>C\u003C/code>â€™s fields to place the \u003Ccode>u8\u003C/code>s before the padding, minimizing wasted space. The discriminant is only 1 byte despite four variants (2 bits suffice, but alignment constraints mean 1 byte is the minimum addressable unit).\u003C/p>\n\u003Ch2 id=\"fat-pointers-and-dynamically-sized-types\">Fat Pointers and Dynamically Sized Types\u003C/h2>\n\u003Cp>We saw how \u003Ccode>repr(Rust)\u003C/code> gives the compiler freedom to reorder fields because it knows each fieldâ€™s size and alignment at compile time. But this assumption does not always hold. Some types have sizes that can only be determined at runtime, and the way Rust handles them differs sharply from C++.\u003C/p>\n\u003Ch3 id=\"the-problem-with-c-arrays\">The Problem with C Arrays\u003C/h3>\n\u003Cp>In C, when we pass an array to a function, the type system loses information.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">[]\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">10\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    process\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(data\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 10\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // must pass length separately\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The parameter \u003Ccode>int arr[]\u003C/code> is identical to \u003Ccode>int *arr\u003C/code>. The array \u003Cem>decays\u003C/em> to a pointer, and the length vanishes from the type. Nothing in the language connects the pointer to its length. If we pass the wrong length, we get buffer overflows. If we forget to pass it entirely, the function cannot know where the array ends.\u003C/p>\n\u003Cp>This decay happens implicitly. The expression \u003Ccode>data\u003C/code> in the call site has type \u003Ccode>int[10]\u003C/code>, but by the time it reaches \u003Ccode>process\u003C/code>, it is just \u003Ccode>int*\u003C/code>. The compiler erases information that the programmer must then track manually.\u003C/p>\n\u003Ch3 id=\"dynamically-sized-types-in-rust\">Dynamically Sized Types in Rust\u003C/h3>\n\u003Cp>Rust solves this with \u003Cem>dynamically sized types\u003C/em> (DSTs), types whose size is not known at compile time. The language has three built-in DST categories.\u003C/p>\n\u003Cp>The slice type \u003Ccode>[T]\u003C/code> represents a contiguous sequence of \u003Ccode>T\u003C/code> values of unknown length. Unlike \u003Ccode>[T; N]\u003C/code>, which has compile-time-known size \u003Ccode>N * size_of::&#x3C;T>()\u003C/code>, the type \u003Ccode>[T]\u003C/code> could represent any number of elements. A \u003Ccode>[u8]\u003C/code> might be 10 bytes or 10,000 bytes.\u003C/p>\n\u003Cp>The string slice \u003Ccode>str\u003C/code> is semantically a \u003Ccode>[u8]\u003C/code> with a validity invariant requiring UTF-8 encoding. It shares the same dynamically-sized nature.\u003C/p>\n\u003Cp>Trait objects \u003Ccode>dyn Trait\u003C/code> represent values of unknown concrete type that implement \u003Ccode>Trait\u003C/code>. A \u003Ccode>dyn Display\u003C/code> might be a \u003Ccode>String\u003C/code> at 24 bytes, an \u003Ccode>i32\u003C/code> at 4 bytes, or a custom type of arbitrary size. The concrete type is erased; only the interface remains.\u003C/p>\n\u003Cp>However, all these types cannot exist directly on the stack or as struct fields (except as the last field). We cannot write \u003Ccode>let x: [u8];\u003C/code> because the compiler cannot determine how much stack space to allocate. DSTs exist only behind pointers.\u003C/p>\n\u003Ch3 id=\"wide-pointers\">Wide Pointers\u003C/h3>\n\u003Cp>A pointer to a sized type is a single machine word, 8 bytes on x86-64. A pointer to a DST must carry additional information, making it twice as wide.\u003C/p>\n\u003Cp>For slices, a \u003Ccode>&#x26;[T]\u003C/code> stores a pointer to the first element paired with the number of elements.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);        \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// thin pointer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);     \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// wide pointer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);      \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// same representation as &#x26;[u8]\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We can examine the actual representation using \u003Ccode>std::ptr::metadata\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> slice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">arr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// The slice is (pointer to arr[1], length 3)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> slice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> len\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> slice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// first element of slice\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The wide pointer solves the C problem. When we pass a \u003Ccode>&#x26;[T]\u003C/code>, the length travels with the pointer. There is no way to separate them, pass the wrong length or forget it.\u003C/p>\n\u003Cp>The coercion from \u003Ccode>&#x26;[i32; 5]\u003C/code> to \u003Ccode>&#x26;[i32]\u003C/code> is an \u003Cem>unsizing coercion\u003C/em>. The compiler takes the thin pointer to the array, combines it with the statically-known length, and produces a wide pointer. This happens implicitly at coercion sites, including \u003Ccode>let\u003C/code> bindings with explicit types, function arguments, and return values.\u003C/p>\n\u003Ch3 id=\"trait-object-representation\">Trait Object Representation\u003C/h3>\n\u003Cp>For trait objects, the wide pointer contains different metadata. A \u003Ccode>&#x26;dyn Trait\u003C/code> stores a pointer to the concrete value paired with a pointer to a \u003Cem>vtable\u003C/em> (virtual method table).\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">size_of;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> draw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> draw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">); }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">size_of\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The vtable is a static data structure generated by the compiler for each (concrete type, trait) pair. It contains function pointers for every method in the trait, plus metadata required for memory management.\u003C/p>\n\u003Cp>For a trait \u003Ccode>Drawable\u003C/code> with methods \u003Ccode>draw\u003C/code> and \u003Ccode>area\u003C/code>, the vtable looks roughly like this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>+0:   drop_in_place::&#x3C;ConcreteType>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+8:   size_of::&#x3C;ConcreteType>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+16:  align_of::&#x3C;ConcreteType>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+24:  Drawable::draw for ConcreteType\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+32:  Drawable::area for ConcreteType\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The size and alignment entries are essential for dropping boxed trait objects. When we call \u003Ccode>drop\u003C/code> on a \u003Ccode>Box&#x3C;dyn Drawable>\u003C/code>, the runtime must know how many bytes to deallocate and what alignment the allocator expects.\u003C/p>\n\u003Ch3 id=\"virtual-dispatch-in-assembly\">Virtual Dispatch in Assembly\u003C/h3>\n\u003Cp>When we call a method on a trait object, the compiler generates an indirect call through the vtable. Consider this function:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> call_draw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">obj\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    obj\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">draw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>On x86-64, this compiles to something like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">call_draw\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    ; rdi = data pointer (obj.data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    ; rsi = vtable pointer (obj.vtable)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">24\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]    \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load draw function pointer from vtable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           ; data pointer becomes first argument (self)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    jmp\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                ; tail call to draw implementation\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The vtable lookup adds one memory indirection compared to a direct call. More significantly, the indirect call through a register prevents the CPU from predicting the branch target until the vtable load completes. Modern CPUs have indirect branch predictors, but they are less effective than direct branch prediction.\u003C/p>\n\u003Cp>Compare this to a generic function with static dispatch:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> call_draw_static\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">obj\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    obj\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">draw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Here the compiler monomorphizes the function for each concrete \u003Ccode>T\u003C/code>, producing a direct call:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">call_draw_static_for_i32\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    jmp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">     &#x3C;i32 as Drawable>::draw\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>No vtable lookup, no indirect branch. The call target is known at compile time, enabling inlining. If \u003Ccode>draw\u003C/code> is small, the compiler can inline it entirely, eliminating the call overhead and enabling further optimizations across the inlined code.\u003C/p>\n\u003Ch3 id=\"performance-implications-of-dynamic-dispatch\">Performance Implications of Dynamic Dispatch\u003C/h3>\n\u003Cp>The overhead of virtual dispatch is not just the vtable lookup. The indirect call has cascading effects on the CPU pipeline.\u003C/p>\n\u003Cp>Modern CPUs predict branch targets to keep the instruction pipeline full. For direct calls, the target is encoded in the instruction itself, and the predictor can fetch the target instructions immediately. For indirect calls through a register, the CPU must wait for the register value to be computed (the vtable load), then use an indirect branch predictor to guess the target. Indirect branch predictors maintain a table of recent indirect branch targets, but they are less accurate than direct branch prediction, especially when a call site dispatches to many different implementations.\u003C/p>\n\u003Cp>When the predictor guesses wrong, the pipeline must be flushed and restarted from the correct target. On modern x86-64, this costs roughly 15-20 cycles. If a tight loop calls a trait object method that alternates between two implementations, the predictor may never stabilize, incurring the misprediction penalty on every other iteration.\u003C/p>\n\u003Cp>The vtable itself must be in cache for the lookup to be fast. A vtable is small (typically 32-64 bytes for a trait with a few methods), but if we iterate over a heterogeneous collection of trait objects, each object may point to a different vtable. With many distinct implementations, the vtables compete for cache space. The first access to each vtable is a cache miss, adding 100+ cycles of memory latency.\u003C/p>\n\u003Cp>Inlining is the most significant loss. When the compiler inlines a function, it can see both caller and callee code simultaneously. This enables constant propagation, dead code elimination, loop fusion, and SIMD vectorization across the boundary. In the general case, none of this is possible through a vtable, the compiler cannot see through the indirection, so each call becomes an optimization barrier.\u003C/p>\n\u003Cp>In C++, modern compilers can sometimes \u003Cem>devirtualize\u003C/em> virtual calls. If the concrete type is visible at the call site (immediately after construction, or when the class is marked \u003Ccode>final\u003C/code>), Clang/GCC may replace the indirect call with a direct one. With LTO and \u003Ccode>-fwhole-program-vtables\u003C/code>, C++ compilers can devirtualize when only one implementation exists program-wide.\u003C/p>\n\u003Cp>Rustâ€™s situation is less favorable. As of 2024, rustc does not provide the metadata LLVM needs for whole-program devirtualization. Even when only a single type implements a trait in the entire binary, trait object calls remain indirect. LLVM can devirtualize in trivial cases where the concrete type is immediately visible (creating a trait object and calling a method in the same basic block), but this is rare in practice. The tracking issue rust-lang/rust#68262 has seen little progress. For now, if you need devirtualization in Rust, use generics or enums, the compiler will not rescue trait objects for you.\u003C/p>\n\u003Cp>Consider a loop summing areas. Here we must be careful: the static and dynamic versions solve \u003Cem>different\u003C/em> problems.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Static dispatch: all elements must be the same concrete type\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sum_areas_static\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">shapes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    shapes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sum\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Dynamic dispatch: elements can be different concrete types\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sum_areas_dynamic\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">shapes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    shapes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sum\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The static version requires a homogeneous slice, all \u003Ccode>Circle\u003C/code>s or all \u003Ccode>Rectangle\u003C/code>s, never mixed. The dynamic version accepts heterogeneous collections. These are not interchangeable; we choose based on whether we need polymorphism over a closed or open set of types.\u003C/p>\n\u003Cp>For the homogeneous case, the compiler can inline the entire loop body, unroll the loop, and potentially vectorize with SIMD. For the heterogeneous case, each \u003Ccode>area()\u003C/code> call is a function pointer load, an indirect call, and a return. The loop cannot be vectorized because the compiler cannot prove anything about what \u003Ccode>area()\u003C/code> does.\u003C/p>\n\u003Cp>When the set of types is closed and known at compile time, Rust offers a third approach that combines the benefits of both: enum dispatch.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">enum\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Rectangle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rectangle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        match\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">c\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">            Shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">Rectangle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">r\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">=>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> sum_areas_enum\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">shapes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    shapes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">iter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sum\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The enum approach accepts a heterogeneous collection (circles and rectangles mixed), but the dispatch is a compile-time match expression rather than a vtable lookup. The compiler can inline each branch, and modern CPUs predict \u003Ccode>match\u003C/code> arms more reliably than indirect calls. The slice is homogeneous at the type level (\u003Ccode>&#x26;[Shape]\u003C/code>), so it is cache-friendly, no pointer chasing, no scattered vtables.\u003C/p>\n\u003Cp>The trade-off is extensibility. Adding a new shape to an enum requires modifying the enum definition and every \u003Ccode>match\u003C/code>. With trait objects, new types can implement the trait without touching existing code. Enums are closed; traits are open.\u003C/p>\n\u003Cp>The rule of thumb is to use generics with trait bounds for performance-critical code paths where all elements share a concrete type. Use enums when the type set is closed and we need heterogeneous collections with predictable dispatch. Reserve trait objects for open extensibility where the flexibility is worth the cost, or for reducing compile times and binary size when performance is not critical.\u003C/p>\n\u003Ch3 id=\"the-vtable-location-trade-off\">The Vtable Location Trade-off\u003C/h3>\n\u003Cp>Rust and C++ made opposite design decisions about where to store the vtable pointer.\u003C/p>\n\u003Cp>In C++, polymorphic objects embed a \u003Cem>vptr\u003C/em> directly in the object:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">public\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    virtual\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> draw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    virtual\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> double\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    virtual\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> ~Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> default\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Memory layout of a Drawable subclass instance:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// +0:  vptr (8 bytes, points to vtable)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// +8:  x (4 bytes)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// +12: padding (4 bytes)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Total: 16 bytes\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Every instance of a polymorphic class carries the vptr. A \u003Ccode>Drawable*\u003C/code> or \u003Ccode>Drawable&#x26;\u003C/code> is 8 bytes, but each object is 8 bytes larger than it would be without virtual functions.\u003C/p>\n\u003Cp>Rust places the vtable pointer in the reference, not the object:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    radius\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> draw\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">/* ... */\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">consts\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\">PI\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">radius \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">radius }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Memory layout of Circle:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// +0: radius (8 bytes)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Total: 8 bytes (no vptr)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Memory layout of &#x26;dyn Drawable pointing to Circle:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// +0: data pointer (8 bytes)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// +8: vtable pointer (8 bytes)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Total: 16 bytes\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The trade-off is memory allocation versus reference size. With a million objects and one reference each, C++ uses 8 MB for vptrs embedded in objects; Rust uses 8 MB for vtable pointers in references. With a million objects and ten references each, C++ still uses 8 MB; Rust uses 80 MB.\u003C/p>\n\u003Cp>But Rustâ€™s design enables something C++ cannot do. The same object can be viewed through multiple trait lenses simultaneously:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fmt\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> circle\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">radius\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> drawable\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Drawable\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> any\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">any\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Any\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Each reference carries its own vtable pointer, pointing to different vtables. The \u003Ccode>circle\u003C/code> object itself is unchanged. In C++, the vptr embedded in the object determines its dynamic type at construction time. A \u003Ccode>Drawable*\u003C/code> and a \u003Ccode>Base*\u003C/code> pointing to the same object use the same embedded vptr (possibly adjusted for multiple inheritance).\u003C/p>\n\u003Ch3 id=\"dyn-compatibility\">Dyn Compatibility\u003C/h3>\n\u003Cp>Not every trait can be used as a trait object. The rules for \u003Cem>dyn compatibility\u003C/em> (formerly called object safety) restrict which traits work with dynamic dispatch.\u003C/p>\n\u003Cp>A dyn-compatible trait must not require \u003Ccode>Self: Sized\u003C/code>. Requiring \u003Ccode>Sized\u003C/code> would contradict the purpose of trait objects, which exist to handle values of unknown size. The trait must have no associated constants, since constants require knowing the concrete type at compile time. It must have no associated types with generic parameters, which would require instantiation at compile time.\u003C/p>\n\u003Cp>All methods must be dispatchable or explicitly non-dispatchable. A dispatchable method must have a receiver (\u003Ccode>&#x26;self\u003C/code>, \u003Ccode>&#x26;mut self\u003C/code>, \u003Ccode>Box&#x3C;Self>\u003C/code>, etc.), must not return \u003Ccode>Self\u003C/code> by value, must not take \u003Ccode>Self\u003C/code> by value as a parameter, and must not have type parameters.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Dyn compatible\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Compatible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> method\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> returns_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// NOT dyn compatible\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Incompatible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> returns_self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;        \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Self in return position\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> takes_self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">other\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);     \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Self as parameter\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> generic\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);            \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// type parameter\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> VALUE\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;                       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// associated constant\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Dynamic dispatch requires a vtable entry for each method, and a vtable entry is a function pointer with a fixed signature. If a method returns \u003Ccode>Self\u003C/code>, the return type depends on the concrete type, which is erased. If a method is generic over \u003Ccode>T\u003C/code>, there would need to be infinitely many vtable entries, one for each \u003Ccode>T\u003C/code>.\u003C/p>\n\u003Cp>Methods that violate these rules can still exist on dyn-compatible traits if they have a \u003Ccode>where Self: Sized\u003C/code> bound, making them unavailable through trait objects but callable on concrete types:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PartiallyCompatible\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> dispatchable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> not_dispatchable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> where\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Sized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// This works:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> obj\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PartiallyCompatible\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">some_value\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">obj\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">dispatchable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// This does not compile:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// obj.not_dispatchable();\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"auto-traits-and-lifetime-bounds\">Auto Traits and Lifetime Bounds\u003C/h3>\n\u003Cp>Trait objects can include auto traits and lifetime bounds. Unlike regular traits, where only one non-auto trait is allowed, auto traits can be added freely:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fmt\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// All valid trait object types:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> takes_debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> takes_debug_send\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Send\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> takes_debug_send_sync\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Send\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Sync\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)) {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> takes_debug_static\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> +\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> '\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">static\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)) {}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The auto traits (\u003Ccode>Send\u003C/code>, \u003Ccode>Sync\u003C/code>, \u003Ccode>Unpin\u003C/code>, etc.) do not add methods to the vtable. They are marker traits checked at compile time when the trait object is created. If we try to create a \u003Ccode>&#x26;dyn Debug + Send\u003C/code> from a type that is not \u003Ccode>Send\u003C/code>, the compiler rejects it:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fmt\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Error: Rc&#x3C;i32> is not Send\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// let obj: &#x26;(dyn Debug + Send) = &#x26;*rc;\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Lifetime bounds constrain how long references inside the trait object can live. A \u003Ccode>dyn Trait + 'static\u003C/code> contains no non-\u003Ccode>'static\u003C/code> references. A \u003Ccode>dyn Trait + 'a\u003C/code> may contain references that live at least as long as \u003Ccode>'a\u003C/code>. The default lifetime depends on context and follows elision rules.\u003C/p>\n\u003Ch3 id=\"supertraits-in-the-vtable\">Supertraits in the Vtable\u003C/h3>\n\u003Cp>When a trait has supertraits, the vtable includes method entries for the supertrait methods:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> radius\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The vtable for \u003Ccode>dyn Circle\u003C/code> contains entries for both \u003Ccode>area\u003C/code> and \u003Ccode>radius\u003C/code>. When we call a supertrait method on a trait object, it goes through the same vtable lookup:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> print_area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // This works because Shape::area is in the Circle vtable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">Area: {}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Trait object upcasting allows converting \u003Ccode>&#x26;dyn Circle\u003C/code> to \u003Ccode>&#x26;dyn Shape\u003C/code>. The compiler generates a different vtable for \u003Ccode>dyn Shape\u003C/code> that contains only \u003Ccode>area\u003C/code>, and the conversion substitutes the vtable pointer:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> use_as_shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// upcasting coercion\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">Area: {}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"the-sized-bound\">The ?Sized Bound\u003C/h3>\n\u003Cp>By default, all type parameters have an implicit \u003Ccode>Sized\u003C/code> bound:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> foo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// is equivalent to:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> foo\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Sized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This makes sense. To pass \u003Ccode>x\u003C/code> by value, the compiler must know its size to copy it onto the stack. But sometimes we want to accept DSTs through references. The \u003Ccode>?Sized\u003C/code> bound relaxes the \u003Ccode>Sized\u003C/code> requirement:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> ?\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Sized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // T might be a DST\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // x is a wide pointer if T is unsized\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Now this works:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">process\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">][\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">..\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">process\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">process\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fmt\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Debug\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The standard library uses \u003Ccode>?Sized\u003C/code> extensively. The signature of \u003Ccode>std::borrow::Borrow\u003C/code> is:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Borrow\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Borrowed\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> ?\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Sized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> borrow\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Borrowed\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This allows \u003Ccode>String\u003C/code> to implement \u003Ccode>Borrow&#x3C;str>\u003C/code>, returning \u003Ccode>&#x26;str\u003C/code>, a reference to a DST.\u003C/p>\n\u003Cp>In trait definitions, \u003Ccode>Self\u003C/code> has an implicit \u003Ccode>Self: ?Sized\u003C/code> bound, the opposite of type parameters. This allows traits to be implemented for DSTs:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyTrait\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> method\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MyTrait\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> method\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">        println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">length: {}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">());\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If traits required \u003Ccode>Self: Sized\u003C/code> by default, we could not implement traits for \u003Ccode>str\u003C/code>, \u003Ccode>[T]\u003C/code>, or \u003Ccode>dyn OtherTrait\u003C/code>.\u003C/p>\n\u003Ch3 id=\"custom-dsts\">Custom DSTs\u003C/h3>\n\u003Cp>A struct can contain a DST as its last field, making the struct itself a DST:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MySlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    header\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">],  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// DST as last field\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>MySlice\u003C/code> is now a DST. We cannot create it directly on the stack. The only supported construction method is through unsizing coercion from a sized variant:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MySized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#82AAFF\"> N\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    header\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> u32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">N\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> main\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> sized\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> MySized\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">header\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> dynamic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MySlice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">        // Requires ptr::from_raw_parts or careful transmutation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MySized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">MySlice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">sized\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">dynamic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">header, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    assert_eq!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">dynamic\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(), \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">4\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is awkward and requires unsafe code. The \u003Ccode>ptr::from_raw_parts\u003C/code> API (stabilized in Rust 1.79) provides a safer way to construct custom DST pointers, but the ergonomics remain poor. Most code uses the built-in DST types (\u003Ccode>[T]\u003C/code>, \u003Ccode>str\u003C/code>, \u003Ccode>dyn Trait\u003C/code>) rather than defining custom ones.\u003C/p>\n\u003Cp>To construct a DST, we must provide the metadata (length or vtable pointer) that completes the type. But the language provides no syntax for this at the value level. The standard library handles DST construction internally through careful unsafe code and compiler magic for types like \u003Ccode>str\u003C/code> and \u003Ccode>[T]\u003C/code>.\u003C/p>\n\u003Ch3 id=\"invalid-metadata-is-undefined-behavior\">Invalid Metadata is Undefined Behavior\u003C/h3>\n\u003Cp>The metadata in a wide pointer is not merely informational. The compiler trusts it for safety-critical operations. Providing invalid metadata is undefined behavior.\u003C/p>\n\u003Cp>For slices, the length must not cause the slice to extend beyond its allocation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: length 1000 exceeds the allocation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bad_slice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">] \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">slice\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from_raw_parts\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1000\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For trait objects, the vtable must be a valid vtable for the trait that matches the actual dynamic type of the pointed-to object:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// UB: null is not a valid vtable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> () \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> i32\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> vtable_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> () \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ptr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">null\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bad\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">fmt\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Debug\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> unsafe\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">mem\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">transmute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">((\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">vtable_ptr\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The Rust Reference explicitly lists invalid wide pointer metadata as undefined behavior. Calling a method through a corrupted vtable pointer could jump to arbitrary code. Using an invalid slice length could read or write out of bounds.\u003C/p>\n\u003Ch2 id=\"polymorphism-monomorphization-vs-vtables\">Polymorphism: Monomorphization vs Vtables\u003C/h2>\n\u003Cp>We saw how Rust represents pointers to dynamically sized types. A \u003Ccode>&#x26;dyn Draw\u003C/code> carries both a data pointer and a vtable pointer, 16 bytes that enable runtime method dispatch. But this raises a question we have not yet answered: why does Rust need two polymorphism mechanisms at all? Templates and generics already let us write code that works across types. Why introduce vtables?\u003C/p>\n\u003Cp>When we write a function that operates on â€œany type implementing trait X,â€ the compiler must decide how to generate code for it. Two strategies exist. The compiler can stamp out a separate copy of the function for each concrete type that actually gets used, a process called \u003Cem>monomorphization\u003C/em>. Alternatively, the compiler can generate a single copy of the function that dispatches method calls through a table of function pointers at runtime. Both C++ and Rust support both strategies. C, lacking native generics, provides only workarounds that approximate each approach with varying degrees of type safety.\u003C/p>\n\u003Cp>Monomorphization eliminates runtime indirection entirely; every call is direct, every function body can be inlined, the optimizer sees through abstraction boundaries. But the binary contains a separate copy of the generic code for every type instantiation, which bloats both compile time and binary size. Dynamic dispatch through vtables produces a single copy of the code regardless of how many implementing types exist, but every method call requires loading a function pointer from memory and jumping through it, which the CPU cannot predict well and which prevents inlining.\u003C/p>\n\u003Ch3 id=\"c-without-generics\">C Without Generics\u003C/h3>\n\u003Cp>C has no built-in parametric polymorphism. We cannot write a function that operates on â€œany comparable typeâ€ and have the compiler generate type-safe, specialized versions. Historically, C programmers used three workarounds.\u003C/p>\n\u003Cp>Preprocessor macros perform textual substitution before the compiler ever sees the code:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">define\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> MAX\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ((a) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (b) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (a) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (b))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> MAX\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           // expands to ((3) > (5) ? (3) : (5))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> MAX\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1.5\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2.5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // expands to ((1.5) > (2.5) ? (1.5) : (2.5))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Each use site expands to type-specific code, achieving something like monomorphization. But macros operate outside the type system. The preprocessor has no concept of what \u003Ccode>a\u003C/code> and \u003Ccode>b\u003C/code> are; it pastes text. This leads to the classic double-evaluation trap:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">define\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> SQUARE\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ((x) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (x))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> SQUARE\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // expands to ((a++) * (a++)), undefined behavior\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The argument is evaluated twice. If it has side effects, the programâ€™s behavior becomes undefined. The macro cannot evaluate its argument once and bind it to a local; macros do not have local variables.\u003C/p>\n\u003Cp>C11 introduced \u003Ccode>_Generic\u003C/code>, which provides compile-time type dispatch:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">define\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> abs\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> _Generic\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">((x)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#F78C6C\">    \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">: abs_int\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#F78C6C\">               \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    long\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">: abs_long\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#F78C6C\">             \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">: fabs\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#F78C6C\">               \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    default: abs_int)(x)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> abs_int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ?\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x; }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">long\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> abs_long\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">long\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ?\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x; }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>_Generic\u003C/code> keyword examines the type of its first argument and selects the corresponding expression. This is better than macros: the selection happens within the type system, and each branch is a proper function that evaluates its argument once. But we must enumerate every supported type explicitly and write separate implementations for each. We have not reduced code duplication; we have centralized dispatch.\u003C/p>\n\u003Cp>For dynamic polymorphism, we can use function pointers with \u003Ccode>void*\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typedef\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">comparator)(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> qsort\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> base\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> nmemb\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> size_t\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> size\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> comparator \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">cmp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> compare_int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)b;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> arr\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">[]\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 8\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">qsort\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(arr\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 4\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compare_int);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The standard libraryâ€™s \u003Ccode>qsort\u003C/code> treats the array as raw bytes and accepts a function pointer for comparison. The type information is erased: the comparator receives \u003Ccode>void*\u003C/code> and must cast internally. Nothing prevents passing \u003Ccode>compare_int\u003C/code> to sort an array of \u003Ccode>double\u003C/code>. The compiler cannot verify correctness. If the programmer gets it wrong, the program silently produces garbage or crashes.\u003C/p>\n\u003Ch3 id=\"c-templates\">C++ Templates\u003C/h3>\n\u003Cp>C++ templates let us define families of functions and classes parameterized over types:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           // instantiates max&#x3C;int>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1.5\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 2.5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // instantiates max&#x3C;double>\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When the compiler encounters \u003Ccode>max(3, 5)\u003C/code>, it deduces \u003Ccode>T = int\u003C/code> and generates a specialized function \u003Ccode>max&#x3C;int>\u003C/code>. A separate \u003Ccode>max&#x3C;double>\u003C/code> gets generated for the second call. Each instantiation is compiled independently, producing code identical to what we would write by hand. There is no runtime overhead.\u003C/p>\n\u003Cp>Templates use what is sometimes called \u003Cem>duck typing\u003C/em>: if the operations used in the template body are valid for the concrete type, instantiation succeeds. If not, the compiler emits an error. The problem is that errors emerge from deep within the template instantiation, often producing notoriously verbose diagnostics that obscure the root cause. The templateâ€™s requirements are implicit; we discover at instantiation time whether a type satisfies them.\u003C/p>\n\u003Cp>This implicit checking enables SFINAE (Substitution Failure Is Not An Error), a mechanism where invalid template substitutions silently remove candidates from the overload set rather than causing hard errors. Before C++20, constraining templates required arcane metaprogramming with \u003Ccode>std::enable_if\u003C/code> and type traits:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">include\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">type_traits\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">enable_if&#x3C;std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">is_integral&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">value\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">type\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">absolute\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(T x) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ?\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>enable_if\u003C/code> machinery conditionally makes the return type valid or invalid depending on the type trait. If \u003Ccode>T\u003C/code> is not integral, the substitution fails, and this overload is removed from consideration. The code works but is dense with machinery that obscures intent.\u003C/p>\n\u003Cp>C++20 introduced concepts, which make constraints explicit:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">#\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">include\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> &#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">concepts\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">concept\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Comparable \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> requires\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(T a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> T b) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    { a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">convertible_to\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;bool>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    { a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">convertible_to\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;bool>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">Comparable\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>Comparable\u003C/code> concept declares what operations \u003Ccode>T\u003C/code> must support. The template states its constraint explicitly in the signature. If we instantiate \u003Ccode>max\u003C/code> with a non-comparable type, the error message refers directly to the violated concept rather than to some failed substitution buried in the template body.\u003C/p>\n\u003Cp>Regardless of how constraints are expressed, templates monomorphize. For large templates like \u003Ccode>std::sort\u003C/code> or \u003Ccode>std::unordered_map\u003C/code>, binary bloat becomes pretty significant. We can mitigate this effect with explicit instantiation, where we declare in a single translation unit which instantiations to generate:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// header\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// source\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\"> /* implementation */\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Other translation units can use \u003Ccode>process&#x3C;int>\u003C/code> without triggering instantiation; they link against the pre-generated code. This reduces compile time and binary size at the cost of flexibility.\u003C/p>\n\u003Ch3 id=\"c-virtual-functions\">C++ Virtual Functions\u003C/h3>\n\u003Cp>C++ supports runtime polymorphism through virtual functions. A class with at least one virtual function is \u003Cem>polymorphic\u003C/em>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">public\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    virtual\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> double\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    virtual\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> ~Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> default\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> :\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> public\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> radius;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">public\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> radius\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(r) {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> override\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3.14159\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> radius \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> radius; }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">class\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rectangle\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\"> :\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> public\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> width\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> height;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">public\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#C792EA\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    Rectangle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> w\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> h\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> width\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(w)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> height\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(h) {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> override\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> width \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> height; }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>When we call a virtual function through a base class pointer or reference, the actual function invoked depends on the dynamic type of the object:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> print_area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cout \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">() \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#F78C6C\">\\n\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // virtual dispatch\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Circle\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1.0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rectangle\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> r\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2.0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 3.0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">print_area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(c);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // calls Circle::area\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">print_area\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(r);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // calls Rectangle::area\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler cannot know at compile time which implementation to call. The decision is deferred to runtime.\u003C/p>\n\u003Cp>To implement this, the compiler inserts a hidden pointer (the \u003Cem>vptr\u003C/em>) into every object of a polymorphic class. The vptr points to a static table (the \u003Cem>vtable\u003C/em>) shared by all objects of the same dynamic type. The Itanium C++ ABI, used by GCC, Clang, and most non-Windows compilers, specifies the vtable layout precisely.\u003C/p>\n\u003Cp>The vtable contains several components, laid out at specific offsets from an \u003Cem>address point\u003C/em>. Components before the address point (at negative offsets) include virtual call offsets for adjusting \u003Ccode>this\u003C/code> pointers in multiple inheritance scenarios, virtual base offsets for locating virtual base subobjects, and the \u003Cem>offset-to-top\u003C/em>, a \u003Ccode>ptrdiff_t\u003C/code> giving the displacement from this vtable pointer location to the top of the complete object (used by \u003Ccode>dynamic_cast&#x3C;void*>\u003C/code>). At the address point sits the RTTI pointer, pointing to type information for runtime type identification. After the address point come the virtual function pointers themselves, in declaration order.\u003C/p>\n\u003Cp>For a simple class hierarchy without multiple inheritance, the layout simplifies. A \u003Ccode>Circle\u003C/code> object in memory looks like:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>Circle object (16 bytes on x86-64):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+0:   vptr (8 bytes, points to Circle's vtable)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+8:   radius (8 bytes, double)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Circle's vtable:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>-16:  offset-to-top (0)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>-8:   RTTI pointer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> 0:   &#x26;Circle::~Circle() (complete destructor)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+8:   &#x26;Circle::~Circle() (deleting destructor)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>+16:  &#x26;Circle::area()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The vptr in every \u003Ccode>Circle\u003C/code> instance points to offset 0 of this vtable, the address point. When we call \u003Ccode>s.area()\u003C/code> where \u003Ccode>s\u003C/code> is a \u003Ccode>Shape&#x26;\u003C/code>, the compiler generates:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; rdi = pointer to Shape object\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]          \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load vptr from object\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">16\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]     \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load area() pointer from vtable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">call\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">    rax\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                 ; indirect call\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Two memory loads occur on every virtual call: one to fetch the vptr from the object, one to fetch the function pointer from the vtable. More significantly, the \u003Ccode>call rax\u003C/code> is an indirect branch. The CPUâ€™s branch predictor must guess the target without knowing it until the register value is computed. If a call site invokes many different implementations (iterating over a heterogeneous container of shapes), the predictor may thrash, causing pipeline stalls.\u003C/p>\n\u003Cp>The optimizer cannot inline through a virtual call. It does not know which function will be invoked, so it cannot substitute the function body at the call site. This blocks constant propagation, dead code elimination, and other interprocedural optimizations.\u003C/p>\n\u003Cp>The advantage is code size. There is exactly one \u003Ccode>print_area\u003C/code> function, regardless of how many shape types exist. The vtable adds per-class overhead, not per-use overhead. For large class hierarchies, this can dramatically reduce binary size compared to templated alternatives.\u003C/p>\n\u003Ch3 id=\"rust-generics\">Rust Generics\u003C/h3>\n\u003Cp>Rust generics follow the monomorphization strategy, like C++ templates, but with a critical difference: constraints are declared upfront.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PartialOrd\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);           \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// instantiates max::&#x3C;i32>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> max\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">5\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);       \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// instantiates max::&#x3C;f64>\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The bound \u003Ccode>T: PartialOrd\u003C/code> states that \u003Ccode>T\u003C/code> must implement the \u003Ccode>PartialOrd\u003C/code> trait. The compiler checks this at the call site: calling \u003Ccode>max\u003C/code> with a type that does not implement \u003Ccode>PartialOrd\u003C/code> produces an error that directly states the unsatisfied bound.\u003C/p>\n\u003Cp>Inside the function body, we can only use operations that \u003Ccode>PartialOrd\u003C/code> guarantees. Attempting to call methods not provided by the bound fails immediately, not at instantiation:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> broken\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> PartialOrd\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// error: T doesn't implement Display\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    if\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> >\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> } \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">else\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Rust checks the generic function against its declared bounds before instantiation. This differs from C++ templates, where the body is tentatively compiled against each concrete type, with errors emerging during instantiation.\u003C/p>\n\u003Cp>The monomorphization process itself works similarly. When the Rust compiler encounters generic function calls, it records the concrete types. During code generation, the \u003Cem>monomorphization collector\u003C/em> traverses the call graph to identify all required instantiations. Each generic function paired with each set of concrete type arguments becomes a distinct \u003Cem>mono item\u003C/em> that gets compiled to machine code.\u003C/p>\n\u003Cp>The collector partitions mono items into \u003Cem>Codegen Units\u003C/em> (CGUs). For incremental compilation, the partitioner creates separate CGUs for stable non-generic code and for monomorphized instances. When only generic instantiations change, the stable CGU can be reused.\u003C/p>\n\u003Cp>The same binary size concerns apply. A generic function used with many types produces many copies. The \u003Ccode>cargo llvm-lines\u003C/code> tool shows which functions contribute most to generated LLVM IR. In large codebases, common utility functions like \u003Ccode>Option::map\u003C/code> and \u003Ccode>Result::map_err\u003C/code> can get instantiated hundreds of times, dominating code size.\u003C/p>\n\u003Cp>The standard mitigation is the \u003Cem>inner function pattern\u003C/em>: move the bulk of the logic into a non-generic inner function, leaving a thin generic wrapper:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> read\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">P\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> AsRef\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Path\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">path\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> P\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> io\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> inner\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">path\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Path\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> io\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Result\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Vec\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u8\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> file\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> File\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">open\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">path\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> size\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> file\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">metadata\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">map\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">m\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> m\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">len\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap_or\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Vec\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">with_capacity\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">size\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> usize\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">        io\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">default_read_to_end\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> file\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">?\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">        Ok\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">bytes\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    inner\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">path\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">as_ref\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">())\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The outer generic function calls \u003Ccode>as_ref()\u003C/code> to convert \u003Ccode>P\u003C/code> to \u003Ccode>&#x26;Path\u003C/code>, then delegates to \u003Ccode>inner\u003C/code>. Now \u003Ccode>inner\u003C/code> compiles once regardless of how many path types are used. The outer wrapper is tiny, its monomorphization overhead minimal.\u003C/p>\n\u003Ch3 id=\"rust-trait-objects\">Rust Trait Objects\u003C/h3>\n\u003Cp>When monomorphization costs are prohibitive, Rust offers trait objects. We already covered the representation: \u003Ccode>&#x26;dyn Trait\u003C/code> is a wide pointer containing a data pointer and a vtable pointer. Calling a method loads the function pointer from the vtable and invokes it indirectly.\u003C/p>\n\u003Cp>The key difference from C++ is where the vtable pointer lives. In C++, the vptr is embedded in the object. A \u003Ccode>Circle\u003C/code> contains its own vptr; the \u003Ccode>Circle\u003C/code> type is inherently polymorphic. In Rust, the vtable pointer is in the reference, not the object. A plain \u003Ccode>Circle\u003C/code> struct has no vptr. The vtable pointer appears only when we view the \u003Ccode>Circle\u003C/code> through a trait object:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Circle\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">radius\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Shape\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">c\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// wide pointer created here\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>Circle\u003C/code> struct occupies only the bytes its fields require. The 8-byte vtable pointer is added when we create the \u003Ccode>&#x26;dyn Shape\u003C/code>, not when we create the \u003Ccode>Circle\u003C/code>. An object can be viewed through multiple different trait objects, each with its own vtable, without the object itself containing any vtable pointers.\u003C/p>\n\u003Cp>This design means Rust structs remain trivially copyable (if their fields are) even when they implement traits with virtual methods. In C++, adding a single virtual function to a class makes it non-trivially copyable and increases its size by the vptr. In Rust, implementing a trait never changes a structâ€™s layout.\u003C/p>\n\u003Ch3 id=\"choosing-between-strategies\">Choosing Between Strategies\u003C/h3>\n\u003Cp>Static dispatch through monomorphization is appropriate when the hot path demands maximum performance, when the set of types is small and known, when inlining across the generic boundary matters, and when compile time and binary size are acceptable costs.\u003C/p>\n\u003Cp>Dynamic dispatch through vtables is appropriate when the concrete type cannot be known until runtime (plugin systems, user-defined types loaded dynamically), when binary size is constrained, when compile time must be minimized, and when the call overhead is negligible compared to the work the method performs.\u003C/p>\n\u003Cp>There are common patterns that combine both. For example, we can expose a generic public API and then convert to a trait object internally to avoid instantiation explosion:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">pub\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">W\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Write\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">writer\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> W\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    process_dyn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> writer\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> as\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Write\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> process_dyn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">writer\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Write\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // large implementation, compiled once\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The public API accepts any \u003Ccode>Write\u003C/code> implementor. Internally, we immediately convert to a trait object. \u003Ccode>process_dyn\u003C/code> compiles only once. The cost is one virtual dispatch per method call within \u003Ccode>process_dyn\u003C/code>, but the binary contains only one copy of the implementation.\u003C/p>\n\u003Ch3 id=\"under-the-hood\">Under the Hood\u003C/h3>\n\u003Cp>Consider incrementing a counter through both dispatch strategies. Letâ€™s start with static dispatch:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">trait\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Counter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> increment\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Simple\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">u64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Counter\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> for\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Simple\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> increment\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> inc_static\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">T\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Counter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> T\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">increment\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For \u003Ccode>inc_static::&#x3C;Simple>\u003C/code>, monomorphization produces:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">inc_static_Simple\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    add\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">     qword\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ptr [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">], \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    ret\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The entire method call is inlined to a single \u003Ccode>add\u003C/code> instruction. The trait abstraction has zero runtime cost.\u003C/p>\n\u003Cp>Now consider dynamic dispatch:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> inc_dynamic\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> dyn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Counter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">increment\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler generates:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"asm\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">inc_dynamic\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, [\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rsi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> + \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">24\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]    \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">; load increment from vtable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    mov\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rdi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">rdi\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">           ; data pointer (already in rdi)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">    jmp\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#82AAFF\">     rax\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">                ; tail call through vtable\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The function loads the method pointer from the vtable and jumps to it. The actual increment happens in the target function, which cannot be inlined here. For a single increment, the difference is trivial. In a tight loop incrementing millions of times, the static version avoids the vtable load and indirect branch on every iteration.\u003C/p>\n\u003Cp>The static version also enables further optimization. If the compiler can prove the counter is never observed between increments, it can batch them. If the counter value is known, it can constant-fold. None of this is possible through the vtable indirection.\u003C/p>\n\u003Ch2 id=\"closures-and-captures\">Closures and Captures\u003C/h2>\n\u003Cp>We have seen two strategies for polymorphism: monomorphization produces specialized code for each concrete type, while vtables enable a single function to operate on values of unknown type through indirect dispatch. Both mechanisms deal with \u003Cem>code\u003C/em> that varies. But what happens when we need a function that carries \u003Cem>state\u003C/em>?\u003C/p>\n\u003Cp>Consider a sorting function that accepts a comparison predicate. The predicate must know \u003Cem>how\u003C/em> to compare, which is pure code. But suppose we want to sort by distance from some reference point. Now the predicate needs access to the reference pointâ€™s coordinates, data that exists outside the function itself. The predicate is no longer pure code; it is code plus environment.\u003C/p>\n\u003Cp>This is the closure problem. A closure \u003Cem>closes over\u003C/em> variables from its enclosing scope, capturing them for later use. The three languages approach this problem with characteristic differences. C lacks closures entirely and requires manual workarounds. C++ introduced lambda expressions that desugar to anonymous structs with an overloaded call operator. Rust closures work similarly but integrate with the ownership system, with the \u003Ccode>Fn\u003C/code>, \u003Ccode>FnMut\u003C/code>, and \u003Ccode>FnOnce\u003C/code> traits encoding how the closure interacts with its captured state.\u003C/p>\n\u003Ch3 id=\"c-function-pointers-and-the-context-pattern\">C: Function Pointers and the Context Pattern\u003C/h3>\n\u003Cp>C has function pointers, not closures. A function pointer is an address of executable code; it contains no data beyond the address itself.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> compare_ints\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)b;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">qsort\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(array\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compare_ints);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This works when comparison needs no external state. When it does, C libraries adopt a convention: pass a \u003Ccode>void*\u003C/code> context alongside the function pointer, and the callback receives this context as an additional argument.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> DistanceContext {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> compare_by_distance\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">b\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> void\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">ctx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Point \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">pa \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Point \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">pb \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    const\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> DistanceContext \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">c \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ctx;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> da \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> hypot\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">pa\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> pa\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">ref_y\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> hypot\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">pb\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> pb\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#82AAFF\">->\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#C5E478\">ref_y\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#82AAFF\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (da \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">>\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (da \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Usage requires a sorting function that accepts context\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> DistanceContext ctx \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { .ref_x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0.0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> .ref_y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0.0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">qsort_r\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(points\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> n\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> sizeof\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> Point)\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compare_by_distance\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">ctx\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>qsort_r\u003C/code> variant (POSIX, not standard C) threads the context through to the comparator. The pattern is universal in C callback APIs: a function pointer paired with a \u003Ccode>void*\u003C/code> that the library passes back untouched.\u003C/p>\n\u003Cp>The problems are evident. The \u003Ccode>void*\u003C/code> erases type information; nothing prevents us from passing a \u003Ccode>DistanceContext*\u003C/code> to a callback expecting something else. The compiler cannot verify that the context pointer remains valid when the callback executes. If the callback outlives the contextâ€™s stack frame, we have a dangling pointer. The burden falls entirely on us.\u003C/p>\n\u003Ch3 id=\"c-lambdas\">C++ Lambdas\u003C/h3>\n\u003Cp>C++11 introduced lambda expressions, syntactic sugar for anonymous function objects. A lambda like\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0.0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0.0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> compare \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> ref_y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> da \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">hypot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">hypot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">    return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> da \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>desugars to something equivalent to\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> __lambda_1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_x;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    bool\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> operator\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> const\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">const\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> da \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">hypot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        double\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">hypot\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#C5E478\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#BAEBE2\">y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> -\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">        return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> da \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> db;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">__lambda_1 compare{ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ref_y};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The capture list specifies what enters the closure and how. \u003Ccode>[x]\u003C/code> captures \u003Ccode>x\u003C/code> by value (copies it into the struct). \u003Ccode>[&#x26;x]\u003C/code> captures by reference (the struct holds a reference). \u003Ccode>[=]\u003C/code> captures everything used by value. \u003Ccode>[&#x26;]\u003C/code> captures everything by reference. \u003Ccode>[x, &#x26;y]\u003C/code> mixes modes.\u003C/p>\n\u003Cp>Each lambda has a unique anonymous type that the programmer cannot name. We must use \u003Ccode>auto\u003C/code> for local variables or templates for function parameters:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">template\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">typename\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">void\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> use_callback\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Alternatively, \u003Ccode>std::function&#x3C;R(Args...)>\u003C/code> provides type erasure, wrapping any callable with a matching signature into a uniform type at the cost of heap allocation and virtual dispatch.\u003C/p>\n\u003Cp>The capture mode determines the closureâ€™s size. A lambda capturing two \u003Ccode>double\u003C/code>s by value occupies 16 bytes (plus alignment). A lambda capturing by reference stores pointers, 8 bytes each on x86-64. A lambda capturing nothing is stateless; the standard guarantees that captureless lambdas can convert to plain function pointers:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (*\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">fp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> []\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> a\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#D6DEEB\">,\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\"> b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">)\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> a \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> b; };\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>C++ lambdas are mutable by default if they capture by value with \u003Ccode>mutable\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"cpp\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">int\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> counter \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">auto\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> increment \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> [\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D7DBE0\">counter\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">]\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D9F5DD\">()\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mutable\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">return\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ++\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">counter; };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Each call modifies the lambda's internal copy of counter\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Without \u003Ccode>mutable\u003C/code>, the call operator is \u003Ccode>const\u003C/code> and cannot modify captured values. The default reflects the common case where closures are passed to algorithms and called multiple times; mutating captured state would be surprising.\u003C/p>\n\u003Ch3 id=\"rust-closures\">Rust Closures\u003C/h3>\n\u003Cp>Rust closures follow the same structural principle: a closure is an anonymous struct containing captured values, with a method implementing the call. But the details differ in ways that matter for safety.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0_\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ref_y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#212121;--shiki-dark:#F78C6C\">.\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">0_\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#F78C6C\">f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> compare\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> |\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">|\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> da\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ((\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ref_y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sqrt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ((\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> ref_y\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sqrt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    da\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">partial_cmp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">db\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The compiler generates a struct like\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">struct\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> __closure_1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    ref_x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">    ref_y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> &#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> f64\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FnOnce\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> __closure_1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    type\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Output\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">cmp\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Ordering\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    extern\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">rust-call\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> call_once\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">args\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Output\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">=\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> args\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> da\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ((\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ref_x)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">a\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ref_y)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sqrt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">        let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> db\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> ((\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">x \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ref_x)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">+\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">b\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">y \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">-\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\"> *\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">ref_y)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">powi\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">))\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">sqrt\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">        da\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">partial_cmp\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">db\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">unwrap\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">FnMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> __closure_1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    extern\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">rust-call\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> call_mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">args\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Output\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">call_once\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">args\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">impl\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> \u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Fn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)> \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">for\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> __closure_1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;'\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">a\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">    extern\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\"> \"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">rust-call\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> call\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">self\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">args\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> (\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">&#x26;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Point\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)) \u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">->\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\"> Self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Output\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#7FDBCA\">        self\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">call_once\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">args\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Unlike C++, Rust does not require explicit capture annotations. The compiler infers the capture mode from how variables are used in the closure body. If we only read a variable, it captures by shared reference. If we mutate it, it captures by mutable reference. If we move out of it or if the variable does not implement \u003Ccode>Copy\u003C/code>, it captures by value.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Captures s by shared reference (only reads)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c1\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Captures s by mutable reference (mutates)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c2\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">.\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">push_str\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\"> world\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// Captures s by value (moves out)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c3\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>move\u003C/code> keyword overrides inference, forcing all captures to be by value:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// s is no longer accessible here; it was moved into the closure\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is essential when the closure must outlive the scope where it was created, as when spawning a thread:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">thread\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">spawn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">    // data is owned by this closure, transferred to the new thread\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Without \u003Ccode>move\u003C/code>, the closure would capture \u003Ccode>data\u003C/code> by reference. But \u003Ccode>data\u003C/code> lives on the spawning threadâ€™s stack, which may be deallocated before the spawned thread runs. The compiler rejects this:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> data\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> vec!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">[\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">2\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">3\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">thread\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">spawn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">||\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{:?}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">data\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// ERROR: closure may outlive borrowed value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">});\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>move\u003C/code> keyword forces ownership transfer, ensuring the closure owns \u003Ccode>data\u003C/code> and can safely take it to another thread.\u003C/p>\n\u003Ch3 id=\"the-fn-trait-hierarchy\">The Fn Trait Hierarchy\u003C/h3>\n\u003Cp>The three traits \u003Ccode>Fn\u003C/code>, \u003Ccode>FnMut\u003C/code>, and \u003Ccode>FnOnce\u003C/code> form a hierarchy that describes how a closure can be called, not how it captures.\u003C/p>\n\u003Cp>\u003Ccode>FnOnce\u003C/code> requires ownership of the closure to call it. The method signature is \u003Ccode>fn call_once(self, args: Args) -> Output\u003C/code>. After calling a \u003Ccode>FnOnce\u003C/code>, the closure is consumed. Every closure implements \u003Ccode>FnOnce\u003C/code> because every closure can be called at least once.\u003C/p>\n\u003Cp>\u003Ccode>FnMut\u003C/code> requires mutable access to the closure. The signature is \u003Ccode>fn call_mut(&#x26;mut self, args: Args) -> Output\u003C/code>. A closure implements \u003Ccode>FnMut\u003C/code> if calling it does not require consuming any captured values. It may mutate its captures, but it does not move out of them.\u003C/p>\n\u003Cp>\u003Ccode>Fn\u003C/code> requires only shared access. The signature is \u003Ccode>fn call(&#x26;self, args: Args) -> Output\u003C/code>. A closure implements \u003Ccode>Fn\u003C/code> if calling it neither consumes nor mutates any captured values.\u003C/p>\n\u003Cp>The hierarchy is \u003Ccode>Fn: FnMut: FnOnce\u003C/code>. A closure implementing \u003Ccode>Fn\u003C/code> automatically implements \u003Ccode>FnMut\u003C/code> and \u003Ccode>FnOnce\u003C/code>. The traits encode \u003Cem>what the closure does when called\u003C/em>, not \u003Cem>how it captured\u003C/em> its environment.\u003C/p>\n\u003Cp>This can be tricky if we think in terms of C++ lambdas. For example, a \u003Ccode>move\u003C/code> closure can still implement \u003Ccode>Fn\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> c\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// captures x by value (copies, since i32: Copy)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// c implements Fn because calling it only reads the captured x\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Conversely, a closure that captures by reference but mutates the referent implements only \u003Ccode>FnMut\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> counter\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 0\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\"> mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> increment\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> { \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">counter\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> +=\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 1\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">; };\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// increment implements FnMut (mutates through captured &#x26;mut)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// does NOT implement Fn\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>And a closure that moves out of a captured value implements only \u003Ccode>FnOnce\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> s\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> String\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">from\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">hello\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> consume\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> drop\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">s\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// consume implements FnOnce only (consumes captured s)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// does NOT implement FnMut or Fn\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Functions accepting closures declare which trait they require. \u003Ccode>Iterator::for_each\u003C/code> takes \u003Ccode>FnMut\u003C/code> because it calls the closure multiple times but does not need concurrent shared access. \u003Ccode>Iterator::map\u003C/code> takes \u003Ccode>FnMut\u003C/code> for the same reason. \u003Ccode>thread::spawn\u003C/code> takes \u003Ccode>FnOnce\u003C/code> because the closure runs exactly once in the spawned thread.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> call_twice\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> FnMut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()>(\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic\">mut\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> f\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">fn\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> call_once\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">&#x3C;\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">F\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> FnOnce\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">()>(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">f\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">:\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> F\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">    f\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"closure-traits-and-sendsync\">Closure Traits and Send/Sync\u003C/h3>\n\u003Cp>Closures inherit \u003Ccode>Send\u003C/code> and \u003Ccode>Sync\u003C/code> from their captures. If all captured values are \u003Ccode>Send\u003C/code>, the closure is \u003Ccode>Send\u003C/code>. If all values captured by shared reference are \u003Ccode>Sync\u003C/code>, and all values captured by mutable reference, copy, or move are \u003Ccode>Send\u003C/code>, then the closure is \u003Ccode>Send\u003C/code>. These rules match normal struct composition.\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Rc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> closure\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">rc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// closure is NOT Send because Rc is not Send\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// std::thread::spawn(closure);\u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">  // ERROR\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">use\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\"> std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">sync\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\">Arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> arc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-dark:#D6DEEB\"> Arc\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">new\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\">42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> closure\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\"> println!\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#ECC48D\">{}\u003C/span>\u003Cspan style=\"--shiki-light:#22863A;--shiki-dark:#D9F5DD\">\"\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">, \u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">arc\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// closure IS Send because Arc is Send\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">std\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">thread\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#7FDBCA\">::\u003C/span>\u003Cspan style=\"--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#82AAFF;--shiki-dark-font-style:italic\">spawn\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">(\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\">closure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">);  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// OK\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>A closure is \u003Ccode>Clone\u003C/code> or \u003Ccode>Copy\u003C/code> if it does not capture by mutable reference and all its captures are \u003Ccode>Clone\u003C/code> or \u003Ccode>Copy\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code astro-code-themes min-light night-owl\" style=\"--shiki-light:#24292eff;--shiki-dark:#d6deeb;--shiki-light-bg:#ffffff;--shiki-dark-bg:#011627; overflow-x: auto;--file-name-offset: -0.75rem;\" tabindex=\"0\" data-language=\"rust\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#1976D2;--shiki-dark:#F78C6C\"> 42\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> closure\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> move\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> ||\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> x\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// closure is Copy because it captures only Copy types by value\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> y\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> closure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// copy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\">let\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> z\u003C/span>\u003Cspan style=\"--shiki-light:#D32F2F;--shiki-dark:#C792EA\"> =\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#C5E478\"> closure\u003C/span>\u003Cspan style=\"--shiki-light:#24292EFF;--shiki-dark:#D6DEEB\">;  \u003C/span>\u003Cspan style=\"--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#637777;--shiki-dark-font-style:italic\">// still valid\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>These automatic trait derivations mean closures integrate with Rustâ€™s concurrency primitives without special handling. A \u003Ccode>move\u003C/code> closure capturing \u003Ccode>Arc&#x3C;Mutex&#x3C;T>>\u003C/code> is \u003Ccode>Send\u003C/code>, can be shipped to another thread, and provides safe interior mutability through the mutex. The type system composes.\u003C/p>",{"headings":928,"localImagePaths":1050,"remoteImagePaths":1051,"frontmatter":1052,"imagePaths":1055},[929,930,933,936,939,942,945,948,951,954,957,960,963,966,969,972,975,978,981,984,987,990,993,996,999,1002,1005,1008,1011,1014,1017,1020,1023,1026,1029,1032,1035,1038,1041,1044,1047],{"depth":32,"slug":210,"text":211},{"depth":32,"slug":931,"text":932},"type-layout-and-memory-representation","Type Layout and Memory Representation",{"depth":131,"slug":934,"text":935},"the-c-layout-algorithm","The C Layout Algorithm",{"depth":131,"slug":937,"text":938},"reprrust-the-compilers-prerogative","repr(Rust): The Compilerâ€™s Prerogative",{"depth":131,"slug":940,"text":941},"reprc-predictable-layout-for-ffi","repr(C): Predictable Layout for FFI",{"depth":131,"slug":943,"text":944},"primitive-representations-for-enums","Primitive Representations for Enums",{"depth":131,"slug":946,"text":947},"reprpacked-eliminating-padding","repr(packed): Eliminating Padding",{"depth":131,"slug":949,"text":950},"repralign-preventing-false-sharing","repr(align): Preventing False Sharing",{"depth":131,"slug":952,"text":953},"reprtransparent-zero-cost-wrappers","repr(transparent): Zero-Cost Wrappers",{"depth":131,"slug":955,"text":956},"zero-sized-types","Zero-Sized Types",{"depth":131,"slug":958,"text":959},"empty-types","Empty Types",{"depth":131,"slug":961,"text":962},"niche-optimization","Niche Optimization",{"depth":131,"slug":964,"text":965},"visualizing-layouts","Visualizing Layouts",{"depth":32,"slug":967,"text":968},"fat-pointers-and-dynamically-sized-types","Fat Pointers and Dynamically Sized Types",{"depth":131,"slug":970,"text":971},"the-problem-with-c-arrays","The Problem with C Arrays",{"depth":131,"slug":973,"text":974},"dynamically-sized-types-in-rust","Dynamically Sized Types in Rust",{"depth":131,"slug":976,"text":977},"wide-pointers","Wide Pointers",{"depth":131,"slug":979,"text":980},"trait-object-representation","Trait Object Representation",{"depth":131,"slug":982,"text":983},"virtual-dispatch-in-assembly","Virtual Dispatch in Assembly",{"depth":131,"slug":985,"text":986},"performance-implications-of-dynamic-dispatch","Performance Implications of Dynamic Dispatch",{"depth":131,"slug":988,"text":989},"the-vtable-location-trade-off","The Vtable Location Trade-off",{"depth":131,"slug":991,"text":992},"dyn-compatibility","Dyn Compatibility",{"depth":131,"slug":994,"text":995},"auto-traits-and-lifetime-bounds","Auto Traits and Lifetime Bounds",{"depth":131,"slug":997,"text":998},"supertraits-in-the-vtable","Supertraits in the Vtable",{"depth":131,"slug":1000,"text":1001},"the-sized-bound","The ?Sized Bound",{"depth":131,"slug":1003,"text":1004},"custom-dsts","Custom DSTs",{"depth":131,"slug":1006,"text":1007},"invalid-metadata-is-undefined-behavior","Invalid Metadata is Undefined Behavior",{"depth":32,"slug":1009,"text":1010},"polymorphism-monomorphization-vs-vtables","Polymorphism: Monomorphization vs Vtables",{"depth":131,"slug":1012,"text":1013},"c-without-generics","C Without Generics",{"depth":131,"slug":1015,"text":1016},"c-templates","C++ Templates",{"depth":131,"slug":1018,"text":1019},"c-virtual-functions","C++ Virtual Functions",{"depth":131,"slug":1021,"text":1022},"rust-generics","Rust Generics",{"depth":131,"slug":1024,"text":1025},"rust-trait-objects","Rust Trait Objects",{"depth":131,"slug":1027,"text":1028},"choosing-between-strategies","Choosing Between Strategies",{"depth":131,"slug":1030,"text":1031},"under-the-hood","Under the Hood",{"depth":32,"slug":1033,"text":1034},"closures-and-captures","Closures and Captures",{"depth":131,"slug":1036,"text":1037},"c-function-pointers-and-the-context-pattern","C: Function Pointers and the Context Pattern",{"depth":131,"slug":1039,"text":1040},"c-lambdas","C++ Lambdas",{"depth":131,"slug":1042,"text":1043},"rust-closures","Rust Closures",{"depth":131,"slug":1045,"text":1046},"the-fn-trait-hierarchy","The Fn Trait Hierarchy",{"depth":131,"slug":1048,"text":1049},"closure-traits-and-sendsync","Closure Traits and Send/Sync",[],[],{"author":14,"pubDatetime":1053,"title":919,"slug":915,"featured":17,"draft":17,"tags":1054,"description":921},["Date","2025-12-25T00:00:00.000Z"],[200,634],[]]